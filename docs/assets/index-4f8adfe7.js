import{e,aT as t,aU as o,f as n,m as a,af as s,_ as i,q as r,s as l,u as c,C as d,aV as u,o as p,x as m,aW as h,aX as y,aY as f,aZ as g,a_ as w,a$ as b,b0 as v,b1 as x,b2 as k,b3 as C,b4 as _,b5 as E,b6 as M,b7 as z,b8 as T,b9 as P,w as S,j as B,ba as L,bb as $,g as A,h as D,n as j,y as N,ab as O,t as I,D as R,a7 as U,F,r as H,bc as J,bd as W,be as G,aJ as K,K as X,bf as Y,bg as q,aO as Q,bh as V,bi as Z,bj as ee,bk as te,bl as oe,bm as ne,bn as ae,ac as se,bo as ie,bp as re,bq as le,br as ce,bs as de,bt as ue,bu as pe,bv as me,bw as he,bx as ye,by as fe,bz as ge,bA as we,bB as be,bC as ve,bD as xe,bE as ke,bF as Ce,bG as _e,N as Ee,bH as Me,bI as ze,bJ as Te,bK as Pe}from"./vendor-4dfda034.js";import{u as Se,d as Be,a as Le,b as $e,c as Ae,_ as De,i as je,s as Ne,e as Oe,r as Ie,f as Re,g as Ue,h as Fe,j as He}from"./common-93882878.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const Je=e({__name:"App",setup(e){const h=Se(),y={zhCN:{...t,...Be},en:{...o,...Le}},f=n((()=>h.language)),g=(e,t="href")=>{const o=e.dataset[t];return e.removeAttribute("data-"+t),""+o};(()=>{const e=document.querySelector('link[rel="icon"]');e.href=g(e);const t=document.querySelector('link[rel="manifest"]');t.href=g(t)})(),a((()=>{w(),window.addEventListener("resize",w,!1)})),s((()=>{window.removeEventListener("resize",w)}));const w=()=>{h.sidebar.opened&&document.body.clientWidth,v()},b=i({width:1920,size:14}),v=()=>{let e=(document.getElementById("app").clientWidth||b.width)*(b.size/b.width);document.documentElement.style.fontSize=e+"px"};return(e,t)=>{const o=d("router-view"),n=u;return p(),r(n,{locale:y[c(f)],namespace:"el"},{default:l((()=>[m(o)])),_:1},8,["locale"])}}}),We={colors:{normal:{color:16777215,main:16316664,text:5280767},runing:{color:1211922,main:10485239},error:{color:12717056,main:16616554}},isCruise:!1,modelSizeKB:1048576,loadPart:{},devices:[]},Ge={shakeTime:500,tsp:Date.now()},Ke={list:[]},Xe=i({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),Ye=i({show:!1,style:{left:"0px",top:"0px"},select:[],title:"",data:{},pos:{}}),qe=(e,t=.1,o=1e4)=>{const n=e.clientWidth,a=e.clientHeight,s=new y(36,n/a,t,o);return s.position.set(-350,510,700),s},Qe=(e,t,o="",n)=>{let a=(new w).load([`${t}${o}/${n}/posX.jpeg`,`${t}${o}/${n}/negX.jpeg`,`${t}${o}/${n}/posY.jpeg`,`${t}${o}/${n}/negY.jpeg`,`${t}${o}/${n}/posZ.jpeg`,`${t}${o}/${n}/negZ.jpeg`]);e.background=a},Ve=(e,t,o)=>(e.lookAt(o),new Promise((n=>{new b(e.position).to(t,1e3).easing(v.Quadratic.In).start().onUpdate((()=>{e.lookAt(o)})).onComplete((()=>{n(e)}))}))),Ze=(e,t,o=1)=>{const n=e.position,a=e.rotation,s=e.scale,i=t.position||{x:0,y:0,z:0},r=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(r.x)<2?1:180,d=Math.abs(r.y)<2?1:180,u=Math.abs(r.z)<2?1:180;return{position:[n.x+i.x,n.y+i.y,n.z+i.z],rotation:[a.x+Math.PI/c*r.x,a.y+Math.PI/d*r.y,a.z+Math.PI/u*r.z],scale:[s.x*o*l.x,s.y*o*l.y,s.z*o*l.z]}},et=e=>e.map((e=>(e.children&&e.children.length>0?e.children=et(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),tt=e=>{let t=e.clone();return t.children=et(t.children),t},ot=(e,t=16777215)=>{const o=e.type;let n=5,a=t,s={x:0,y:0,z:0},i={x:0,y:0,z:0},r=0;switch(o){case"TEXT":break;case"JSQ":n=8,s.y=10,s.z=20,r=62;break;case"SB":case"LDB":case"LQB":n=8,s.z=55,r=45;break;case"XBC":case"LXJ":case"LGJ":case"STLGJ":case"TTLGJ":case"FTLGJ":n=8,s.y=16,s.z=40,r=78;break;case"LQT":n=8,s.x=-75,r=112;break;case"GL":n=8,s.x=83,s.y=2,r=125;break;case"BSHRQ":n=12,s.y=8,s.z=33,r=105;break;case"BSHLQ":n=8,s.y=16,s.z=40,r=88;break;case"FLRB":n=8,s.x=50,s.y=2,r=123;break;case"FJY_X":case"FJZ_X":n=6,r=80,s.y=80,s.z=30;break;case"FJY":case"FJZ":n=6,r=110,s.y=103}let l=e.font||{},c=l.position||{};c&&Object.keys(c).forEach((e=>{s[e]=c[e]}));let d=l.rotation||{};return d&&(Object.keys(d).forEach((e=>{i[e]=d[e]})),i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z),l.size&&(n=l.size),l.color&&(a=l.color),{size:n,color:a,txPos:s,txRot:i,sy:r}},nt=(e,t)=>{e.data&&e.data.type?t(e):e.isScene?t(null):nt(e.parent,t)},at=(e,t,o)=>{let n=e.clientWidth/2,a=e.clientHeight/2,s=t.position.clone();const i=t.scale;s.y+=i.x/2;let r=s.project(o);return{left:r.x*n+n,top:-r.y*a+a}},st=e=>{e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())},it=e=>new Promise((t=>{const o=window.indexedDB.deleteDatabase(e);o.onsuccess=e=>{t(!0)},o.onerror=e=>{t(!1)}})),rt=async(e,t="THREE__MODEL_DB",o=1)=>{if(!window.indexedDB)return Promise.resolve(null);await((e,t,o)=>new Promise((n=>{window.indexedDB.open(e).onsuccess=a=>{const s=a.target.result,i=s.version;s.close(),i!==t?it(e).then((e=>{n(e?t:i)})):s.objectStoreNames.contains(o)?n(i):it(e).then((e=>{n(e?t:i)}))}})))(t,o,e);let n=window.indexedDB.open(t,o);return new Promise((t=>{n.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e)||o.createObjectStore(e,{keyPath:"path"})},n.onsuccess=e=>{const o=e.target.result;t(o)},n.onerror=e=>{t(null)}}))},lt={dbName:"THREE__MODEL__CTL_DB",tbName:"CTL_TB",version:1},ct=["onClick"],dt=De(e({name:"three-scene",__name:"index",props:{id:{},bgColor:{type:[String,Boolean],default:void 0},skyCode:{default:"217"},skyCodes:{default:()=>["216","217","218","219","220","221","222","223","224","225"]},skyPath:{default:"/img/sky"},hdr:{},grid:{type:Boolean},baseUrl:{},models:{},config:{},objects:{},lightHelper:{type:Boolean},axesHelper:{type:Boolean},scale:{default:1},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},initModelItemCall:{},getColorCall:{},animationModelType:{},pipeMeshName:{},pipeModelType:{},colorMeshName:{},colorModelType:{default:()=>["FM","XFM"]},textModelType:{},dotTypes:{default:()=>[]},floorModelType:{},cruisePoints:{},cruiseSegment:{},cruiseSpeed:{},cruiseTubeShow:{type:Boolean},pathBg:{},pathWidth:{},pathMap:{},pathTension:{},pathMapSpeed:{},cruisePathOffset:{}},emits:["loaded","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:t,emit:o}){const d=e,u=Se(),m=$e();S((()=>d.objects),(e=>{Xe.isEnd&&oo()})),S((()=>u.sidebar.opened),(()=>{clearTimeout(We.sideToggleTimer),We.sideToggleTimer=setTimeout(Ue,300)})),S((()=>m.dataMark),(()=>y()));const y=()=>{const e=Date.now();e-Ge.tsp<Ge.shakeTime&&clearTimeout(Ge.timer),Ge.tsp=e,Ge.timer=setTimeout(ho,Ge.shakeTime)},w=B(),Ee=new L;let Me,ze,Te,Pe,Be,Le,De;Ee.background=new $("#fff");const je=Symbol("_WARNING_MODEL_"),Ne=Symbol("_CHANGECOLORMATERIALKEY_"),Oe=Symbol("_PIPETEXTUREKEY_"),Ie=Symbol("_MAINBODYMESHKEY_"),Re=()=>{if(Be=new Y(16777215,1.5),Ee.add(Be),Le=((e=16777215,t=1,o=800,n=2048,a=1,s=2e3)=>{const i=new x(e,t);return i.position.set(500,800,800),i.castShadow=!0,i.shadow.camera.near=a,i.shadow.camera.far=s,i.shadow.camera.right=o,i.shadow.camera.left=-o,i.shadow.camera.top=o,i.shadow.camera.bottom=-o,i.shadow.mapSize.set(n,n),i})(16777215,1.5),Ee.add(Le),De=new x(16777215,1.5),De.position.set(-500,800,-800),Ee.add(De),d.lightHelper){const e=new q(Le,1);Ee.add(e);const t=new q(De,1);Ee.add(t)}},Ue=()=>{const e=w.value;if(!Me)return;const t=(null==e?void 0:e.clientWidth)??0,o=(null==e?void 0:e.clientHeight)??0,n=t/o;Me.aspect=n,Me.updateProjectionMatrix(),xt&&(xt.aspect=n,xt.updateProjectionMatrix()),ze.setSize(t,o)};let Fe;const He=()=>{Fe=requestAnimationFrame(He),it(),At(),ze.render(Ee,We.isCruise?xt:Me)},Je=n((()=>(io.value.filter((e=>"DOT"==e.type))||[]).map((e=>{const t=e.deviceCode||"";e.value=m.getKeyValue(t).value;const o=t.split("_")[0]||"";return m.getRunStatus(o)>0||["SYS","CSC"].includes(o)?e.show=!0:e.show=!1,e.value=Number(Number(e.value||0).toFixed(2)),e})))),et=(e=[],t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let n=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{n.includes(e)||n.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!n.includes(o)&&n.push(o),!!o})).length==e.length&&(o=o.concat(n))}else{const n=t.find((t=>t.deviceCode==e));n&&o.push(n)}})),o},it=()=>{J(),Te.update();let e=ht.getDelta();if(We.devices.length&&We.devices.forEach((t=>{let o=t.data,n=t.extra,a=t[je],s=t[Oe];if(n&&(null==o?void 0:o.status)>0&&n.mixer.update(e),a&&(null==o?void 0:o.error)>0&&a.mixer.update(e),s){const e=o.bind||[],t=io.value.filter((e=>"DOT"!==e.type&&!(d.pipeModelType||[]).includes(e.type)&&e.deviceCode&&((null==e?void 0:e.status)??0)>0)),n=et(e,t),a=n.length>0;let i=.01;if(o.left&&o.right){const{left:e,right:t}=o,a=et(t,n).length>0;i=et(e,n).length>0&&a?0:a?-.01:.01}a&&(s.material.map.offset.y-=i),s.material.opacity=a?.3:0}})),Ye.show&&Ye.select.length){const e=w.value,t=at(e,Ye.select[0],We.isCruise?xt:Me);Ye.pos=t,Ye.style.left=t.left+"px",Ye.style.top=t.top+"px"}dt()},dt=()=>{const e=w.value;let t=e.clientWidth/2,o=e.clientHeight/2;io.value.forEach(((e,n)=>{if("DOT"!=e.type)return;let a=e.position,s=new W(null==a?void 0:a.x,null==a?void 0:a.y,null==a?void 0:a.z).project(We.isCruise?xt:Me),i=s.x*t+t,r=-s.y*o+o;io.value[n].style.left=i+"px",io.value[n].style.top=r+"px"}))};S((()=>d.bgColor),(e=>{Ee.background=new $(e)})),S((()=>d.skyCode),(e=>{d.bgColor||(Qe(Ee,d.baseUrl,d.skyPath,e),ut.value=e)}));const ut=B(d.skyCode),pt=()=>{const e=d.skyCodes||[];let t=e.findIndex((e=>e==ut.value))+1;t>=e.length&&(t=0),ut.value=e[t],Qe(Ee,d.baseUrl,d.skyPath,ut.value)},mt=o;let ht,yt,ft,gt;const wt=lt.tbName;S((()=>d.cruisePoints),(async()=>{await se(),bt(),vt(),Bt()}));const bt=()=>{kt&&(st(kt),Ee.remove(kt),kt=void 0)},vt=()=>{We.isCruise=!1,Te.enabled=!We.isCruise,zt=We.isCruise};let xt,kt,Ct,_t,Et,Mt,zt=!1,Tt=0,Pt=1,St=0;const Bt=()=>{const e=Date.now();if(e-St<300)return;St=e,Tt=0;let t=[];const o=d.cruisePoints||[];if(0!=o.length){for(let e=0;e<o.length;e++){const n=o[e];t.push(new W(n[0],n[1],n[2]))}if(xt=qe(w.value,1,1e6),xt.lookAt(Te.target),Et=new ie(t,!0,"catmullrom",d.pathTension??0),kt=new re,Ee.add(kt),d.cruiseTubeShow){Ct=new _(new le(2),new ce({color:0,opacity:.8,transparent:!0})),kt.add(Ct),_t=(new de).setFromPoints(t);const e=new ue({color:255,opacity:1,transparent:!0}),o=new pe(_t,e);kt.add(o);const n=new me(Et,100,2,3,!0),a=new he({color:16711935,opacity:.1,transparent:!0}),s=new _(n,a),i=new ce({color:16715760,opacity:.3,wireframe:!0,transparent:!0}),r=new _(n,i);s.add(r),kt.add(s)}Lt()}else Et=void 0},Lt=async()=>{const e=d.pathBg||d.baseUrl+"/model/pipe/arrow.png",t=d.pathMap||[.1,1],o=await(new ye).loadAsync(e);if(!kt)return;o.wrapS=fe,o.repeat.x=t[0],o.repeat.y=t[1],o.anisotropy=ze.capabilities.getMaxAnisotropy(),Mt=o;const n=new C({map:o,opacity:.5,transparent:!0,depthWrite:!1}),a=new W(0,1,0),s=new we;s.set(Et.getPoints(1e3),5,1,a,!1);const i=new ge;i.update(s,{width:d.pathWidth??15,arrow:!1});const r=new _(i,n);r.name="path",kt.add(r)},$t=()=>1e3*(d.cruiseSegment??2),At=()=>{if(!Et)return;Mt&&(Mt.offset.x-=d.pathMapSpeed??.006),zt&&(Tt+=Pt*(d.cruiseSpeed??1));const e=$t(),t=Tt%e/e,o=Et.getPointAt(t),n=d.cruisePathOffset??3;if(d.cruiseTubeShow&&Ct){const e=Dt(n,o);Ct.position.copy(e)}if(!We.isCruise)return;const a=.03;let s=t-a;t<a&&(s=t+.97);const i=Dt(n,Et.getPointAt(s));xt.position.copy(i),xt.lookAt(Dt(n,o))},Dt=(e,t)=>new W(t.x,t.y+e,t.z),jt=i({click:!1,tsp:0}),Nt=e=>{Ht(e,yt),ft.setFromCamera(yt,We.isCruise?xt:Me);const t=We.devices;let o=ft.intersectObjects(t,!0);if(o.length){const e=o[0].object;nt(e,(t=>{if(!t)return;mt("dblclick",t);const o=t.data,n=Ke.list.findIndex((e=>t.uuid===e.uuid));"function"==typeof o.onDblclick&&o.onDblclick(Q(o),e,t,n),n>-1&&Ot(n)}))}},Ot=e=>{var t,o,n,a;if(0===Ke.list.length)return;const s=void 0!==e&&e>-1;if((null==(t=d.config)?void 0:t.floorExpandHiddenOther)&&We.devices.forEach((e=>{var t;e.visible=(t=e,Ke.list.findIndex((e=>t.uuid===e.uuid))>-1||!s)})),Ke.list.forEach(((t,o)=>{var n,a,i;const r=t._pos;let l=o-(s?e:o);const c=(null==(n=d.config)?void 0:n.floorExpandMargin)||200,u=(null==(a=d.config)?void 0:a.floorExpandMode)||"UD",p=l*c,m=((null==r?void 0:r.y)??0)+p,h=e==o?((null==r?void 0:r.z)??0)+c:(null==r?void 0:r.z)??0;if("UD"===u){if(t.position.y===m)return}else if("BA"===u&&t.position.z===h)return;if(null==(i=t.data)?void 0:i.mark){const n=t.data.mark,a=We.devices.filter((e=>{var t;return(null==(t=e.data)?void 0:t.followMark)===n}));It(u,a,p,e==o?c:0)}new b(t.position).to({y:"UD"===u?m:t.position.y,z:"BA"===u?h:t.position.z},500).easing(v.Quadratic.Out).start()})),!(null==(o=d.config)?void 0:o.floorExpandChangeViewAngle))return;let i,r;if(s){const t=Ke.list[e]||{};i=null==(n=t.data)?void 0:n.to,i&&(r=(null==(a=t.data)?void 0:a.target)||t._pos)}i=no(i,r),(e=>{const t=Me.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1})(i)||Ve(Me,i,Te.target)},It=(e,t,o,n)=>{0!==t.length&&t.forEach((t=>{const a=t._pos,s="UD"==e?((null==a?void 0:a.y)??0)+o:(null==a?void 0:a.y)??0,i="BA"==e?((null==a?void 0:a.z)??0)+n:(null==a?void 0:a.z)??0;new b(t.position).to({y:s,z:i},500).easing(v.Quadratic.Out).start()}))},Rt=e=>{jt.click=!0,jt.tsp=e.timeStamp},Ut=e=>{Jt(e),jt.click},Ft=e=>{var t,o;jt.click=!1;const n=e.timeStamp-jt.tsp<300;2==e.button?n&&"function"==typeof(null==(t=d.config)?void 0:t.back)&&(null==(o=d.config)||o.back(screen)):0==e.button?n&&Jt(e):e.button},Ht=(e,t)=>{if(!e||!t)return;const o=w.value;let n=(null==o?void 0:o.getBoundingClientRect())??{left:0,top:0};t.x=(e.clientX-n.left)/(1*o.clientWidth)*2-1,t.y=-(e.clientY-n.top)/(1*o.clientHeight)*2+1},Jt=e=>{const t=w.value;Ht(e,yt),ft.setFromCamera(yt,We.isCruise?xt:Me);let o="pointerdown"==e.type||"pointerup"==e.type;const n=Ee.children.filter((e=>e.visible&&!!e.data&&d.dotTypes.includes(e.data.type)));let a=ft.intersectObjects(n,o);if(t.style.cursor=a.length>0?"pointer":"auto",o)if(a.length){const e=a[0].object;nt(e,(e=>{if(!e)return;const t=e.data;if(!t.type)return void(Ye.show=!1);const o=Q(t);mt("select",o),"function"==typeof t.onClick?t.onClick(o):(Ye.select=[e],Ye.show=!0,Wt())}))}else Ye.select.length=0,Ye.show=!1},Wt=()=>{const e=w.value,t=Ye.select[0],o=t.data;Ye.data=o,Ye.title=(null==o?void 0:o.name)||"";const n=at(e,t,We.isCruise?xt:Me);Ye.pos=n,Ye.style.left=n.left+"px",Ye.style.top=n.top+"px",mt("click-dialog-dot",o,n)};let Gt;const Kt=()=>{const e=d.models,t=e.length;let o=0;if(0==t)return Xe.isEnd=!0,void(Xe.show=!1);Xe.isEnd=!1,Xe.percentage=0;const n=async()=>{const a=e[o],{key:s,name:i,map:r,url:l,size:c,range:u,font:p,warning:m}=a;if(Xe.list.push({name:`${i} Model`,pro:0}),r){let e=(new ye).load(d.baseUrl+r),t=new be({map:e}),o=new ve(t),n=c,a=c;u&&(n=u.x,a=u.y),o.scale.set(n,a,1),o.name="sprite",We.loadPart[s]=o}else p?await Yt(p,c):m?Gt=await qt(s||je,m,c):await qt(s,l,c,a);o++,Xe.loaded+=c*We.modelSizeKB,o==t?(Xe.isEnd=!0,oo()):n()};Xe.show=!0,n()};let Xt;const Yt=(e,t=0)=>{const o=new xe;return!Ae(e)&&e.indexOf(d.baseUrl)<0&&(e=d.baseUrl+e),new Promise((async n=>{const a=await Qt(e,t);if(a)return Xt=o.parse(JSON.parse(a)),void setTimeout((()=>{n(Xt)}),10);o.load(e,(t=>{Xt=t,Zt(e),n(t)}))}))},qt=(e,t,o=0,n)=>{const a=new ke;a.setDecoderPath("draco/gltf/");const s=new Ce;return s.setDRACOLoader(a),new Promise((async a=>{const i=We.colors.normal[e]||We.colors.normal.color;!Ae(t)&&t.indexOf(d.baseUrl)<0&&(t=d.baseUrl+t);const r=await Qt(t,o);if(r){const t=r.scene.children[0],o=Vt(e,i,t,r.animations,n);return void a(o)}let l=t.split(".").pop().toLowerCase();if("glb"!==l)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+l);s.load(t,(o=>{let s=o.scene.children[0];const r=Vt(e,i,s,o.animations,n);Zt(t),a(r)}),to)}))},Qt=(e,t=0)=>{const o=new Ce;return new Promise((async n=>{const a=ae.get(e);if(a)a instanceof ArrayBuffer?(to({loaded:a.byteLength}),o.parse(a,"",(t=>{ae.add(e,t),n(t)}))):(to({loaded:t*We.modelSizeKB}),setTimeout((()=>{n(a)}),10));else{const t=await((e,t,o)=>{if(!e||!t||!o)return Promise.resolve(null);const n=e.transaction([t],"readonly").objectStore(t).get(o);return new Promise(((e,t)=>{n.onsuccess=t=>{const o=t.target.result;e(o)},n.onerror=e=>{t(e)}}))})(gt,wt,e);if(t&&t.data){const e=t.data;"string"==typeof e?(to({loaded:e.length}),ae.add(t.path,e),setTimeout((()=>{n(e)}),10)):(to({loaded:e.byteLength}),o.parse(e,"",(e=>{ae.add(t.path,e),n(e)})))}else n(null)}}))},Vt=(e,t,o,n,a)=>{var s;if(!o)return;let i;if((null==(s=d.pipeModelType)?void 0:s.includes(e))&&a){const{pipeMap:e,repeat:t=[1,1]}=a;i=(new ye).load(d.baseUrl+e),i.wrapS=fe,i.wrapT=fe,i.repeat.set(t[0]??1,t[1]??1)}const r=tt(o);return r.traverse((e=>{var o;i&&(null==(o=d.pipeMeshName)?void 0:o.includes(e.name))?e.material=new he({side:_e,transparent:!0,opacity:0,map:i.clone()}):((e,t=6776165,o,n)=>{const{type:a,name:s}=e;if(a.indexOf("Light"),["地面","底座","基础","基础底座","冷却塔基础"].includes(s))e.receiveShadow=!0;else if(o.includes(s)){if(!e.material)return;e.material instanceof Array?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t)}else e.isMesh&&(n&&(e.material.envMap=n),e.castShadow=!0)})(e,t,d.colorMeshName||[])})),r.animations=n,We.loadPart[e]=r,r},Zt=e=>{const t=ae.get(e);if(t&&gt){gt.transaction(wt,"readwrite").objectStore(wt).add({path:e,data:t})}},eo=async(e,t)=>{const o="_BASE_";if(!e){const e=We.loadPart[o];if(e){const t=Ee.children.find((t=>t.uuid===e.uuid));Ee.remove(t),st(e),We.loadPart[o]=null}return}const n=await qt(o,e),{position:a,scale:s,rotation:i}=Ze(n,t);return n.scale.set(...s),n.position.set(...a),n.rotation.set(...i),Ee.add(n),Promise.resolve(n)},to=e=>{const{loaded:t}=e,o=Xe.total;let n=Number((t+Xe.loaded)/o*100);n>100&&(n=100),Xe.percentage=Number(n.toFixed(2))},oo=async()=>{var e,t,o;Xe.percentage=100,Xe.show=!1,Ye.show=!1,We.devices.forEach((e=>{const t=Ee.children.find((t=>{var o,n;return(null==(o=t.data)?void 0:o.id)==(null==(n=e.data)?void 0:n.id)}));st(e),st(t),Ee.remove(t)})),We.devices.length=0,Ke.list.length=0,await se(),eo(),ro(),await so(),"function"==typeof(null==(e=d.config)?void 0:e.load)&&(null==(t=d.config)||t.load(Ee));const n=(null==(o=d.config)?void 0:o.floorExpandIndex)||-1;if(n>-1&&Ke.list.length)Ot(n),mt("loaded");else{const e=no();Ve(Me,e,Te.target).then((()=>{mt("loaded")}))}},no=(e,t)=>{const o=d.config||{},n=e||o.to||{x:-104,y:7,z:58},a=t||o.target||{x:0,y:0,z:0};return Te.target.set(a.x,a.y,a.z),n},ao=async e=>{var t,o;if(!e)return;const n=e.type;let a=We.loadPart[n];if(!a)return void(e.url&&await eo(e.url,e));const s=d.colorMeshName||[],i=d.animationModelType||[],r=d.floorModelType||[],l=d.textModelType||[];let c=tt(a);const{position:u,scale:p,rotation:m}=Ze(c,e),[h,y,f]=u;if(c.scale.set(...p),l.includes(n)&&Xt){const t=new E;t.add(c);let o=((e,t,o)=>{if(!t)return;const n=ot(e,o);let a=new k(e.name||"",{font:t,size:n.size||5,height:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const s=n.txRot;a.rotateX(s.x),a.rotateY(s.y),a.rotateZ(s.z);const i=n.txPos;a.computeBoundingBox(),a.computeVertexNormals();let r=.5*(a.boundingBox.max.x-a.boundingBox.min.x),l=.5*(a.boundingBox.max.z-a.boundingBox.min.z),c=new C({color:n.color||16777215,flatShading:!1}),d=new _(a,c);return d.castShadow=!0,d.position.set((i.x||0)-r,i.y||0,(i.z||0)-l),d})(e,Xt,We.colors.normal.text);t.add(o),t.name=e.name,c=t}if(i.includes(n)&&Gt){if("Group"!==c.type){const e=new E;e.add(c),c=e}const{group:t,action:o,mixer:n}=((e,t,o,n=100,a=1)=>{if(!o)return;const s=ot(t);let i=new E,r=tt(o);r.scale.set(a,a,a),r.position.y=s.sy,i.add(r);let l=new M(12717056,8,n,0);l.name="灯光",l.position.y=s.sy+30,i.add(l),i.name=e;let c=new z(i),d=new T("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),u=new T("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),p=new T("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),m=new P("warning_",1,[d,u,p]),h=c.clipAction(m);return h.paused=!0,h.play(),i.visible=!1,{group:i,action:h,mixer:c}})(je,e,Gt);c.add(t),c[je]={action:o,mixer:n}}c.position.set(h,y,f),c.rotation.set(...m),c.data=e;const g=c.children.filter((e=>s.includes(e.name)));if(c[Ne]=g,null==(t=d.pipeModelType)?void 0:t.includes(n)){const t=c.children.find((e=>{var t;return null==(t=d.pipeMeshName)?void 0:t.includes(e.name)}));if(t){t.material.map=t.material.map.clone();const o=e.map;if(o){const e=t.material.map.repeat;t.material.map.repeat.set(e.x*(o[0]??1),e.y*(o[1]??1))}c[Oe]=t}}if(d.mainBodyChangeColor){const e=((null==(o=c.children[0])?void 0:o.children)||[]).filter((e=>(d.mainBodyMeshName||[]).includes(e.name)));c[Ie]=e}if(Ee.add(c),(e.followMark||e.mark)&&(c._pos={x:h,y:y,z:f}),We.devices.push(c),r.includes(n)&&(c._pos={x:h,y:y,z:f},Ke.list.push(c)),i.includes(n)){const e=((e,t)=>{let o=[];return e&&e.length?(function e(n){n.forEach((n=>{t.includes(n.name)&&o.push(n),n.children&&e(n.children)}))}(e),o):[]})(c.children,s);let t,o=new z(c);a.animations.length&&(t=o.clipAction(a.animations[0]),t.paused=!0,t.timeScale=1.5,t.play()),c.extra={action:t,mixer:o,meshs:e}}return Promise.resolve()},so=()=>{let e=0,t=io.value.length;return new Promise((o=>{if(0==t)return;const n=async()=>{const a=io.value[e];await ao(a),e++,e<t?n():o(e)};n()}))},io=B([]),ro=()=>{io.value.length=0;const e=Q(d.objects)||[],t=m.formatData(e,d.initModelItemCall);io.value=t},lo=()=>{},co=e=>{Pt=1;const t=e.keyCode;if(We.isCruise)switch(t){case 32:zt=!zt;break;case 38:case 87:zt||(Tt+=10);break;case 83:case 40:zt||(Tt-=10,Tt<0&&(Tt=$t()))}},uo=e=>{const t=e.keyCode;if(We.isCruise&&e.repeat)switch(t){case 38:case 87:zt?(Pt*=1.5,Pt>10&&(Pt=10)):Tt+=5;break;case 83:case 40:zt||(Tt-=5,Tt<0&&(Tt=$t()))}};window.addEventListener("keydown",uo,!1),window.addEventListener("keyup",co,!1);const po=()=>{(d.cruisePoints||[]).length&&(We.isCruise=!We.isCruise,Te.enabled=!We.isCruise,zt=We.isCruise)},mo=()=>{We.devices.forEach(((e,t)=>{if(!e.data)return;const{type:o}=e.data,n=e.data;if(!n.deviceCode)return;const a=Math.random()>.5?1:0,s=Math.random()>.5?1:0;n.status=a,n.error=s;const i=s>0?"error":a>0?"runing":"normal",r=We.colors[i];let l=r[o]||r.color;if("function"==typeof d.getColorCall){const e=d.getColorCall(n);e&&(l=e)}yo(o,e,r,l,0==a,s>0)}))},ho=()=>{const e=d.animationModelType||[],t=d.colorModelType||[],o=d.pipeModelType||[],n=e.concat(t);We.devices.forEach(((e,t)=>{let a=e.data;if(!a)return;let s=a.type;if(!n.includes(s)||o.includes(s)||"DOT"==s)return;const i=a.deviceCode;if(!i)return;const r=m.getRunStatus(i),l=m.getErrorStatus(i);a.status=r,a.error=l;const c=l>0?"error":r>0?"runing":"normal",u=We.colors[c];let p=u[s]||u.color;if("function"==typeof d.getColorCall){const e=d.getColorCall(a);e&&(p=e)}yo(s,e,u,p,0==r,l>0)}))},yo=(e,t,o,n,a,s)=>{if(d.colorModelType.includes(e)){return void(t[Ne]||[]).forEach((e=>{e.material.color.set(n)}))}const i=t.extra;if(i&&"DOT"!=e){i.action&&(i.action.paused=a);(i.meshs||[]).forEach((e=>{"Group"==e.type?e.children.forEach((e=>{e.material.color.set(n)})):e.material.color.set(n)}))}const r=t[je];if(r){const e=t.children.find((e=>e.name==je));e&&(e.visible=s,r.action.paused=!s)}if(d.mainBodyChangeColor&&t[Ie]){const e=o.main;e&&t[Ie].forEach((t=>{t.material.color.set(e)}))}},fo=()=>{d.models.forEach((e=>{const t=e.size*We.modelSizeKB;Xe.total+=t}));const e=w.value;if(ze=(e=>{const t=e.clientWidth,o=e.clientHeight,n=new h({antialias:!0,alpha:!0});return n.outputEncoding=void 0,n.setSize(t,o),n.setPixelRatio(window.devicePixelRatio),e.appendChild(n.domElement),n})(e),Me=qe(e,1,1e6),Re(),Te=((e,t)=>{const o=new f(e,t.domElement);return o.minDistance=1,o.maxPolarAngle=.45*Math.PI,o.target.set(0,0,0),o})(Me,ze),Te.maxPolarAngle=.46*Math.PI,Te.screenSpacePanning=!1,d.grid&&(Pe=(()=>{let e=new g(800,80,10592673,10592673);return e.material.opacity=.3,e.material.transparent=!0,e})(),Ee.add(Pe)),d.axesHelper){let e=new G(50);Ee.add(e)}We.isCruise=!1,Pt=1,d.hdr?(new V).load(d.baseUrl+d.hdr,(e=>{e.mapping=Z,Ee.background=e,Ee.environment=e})):null!=d.bgColor?Ee.background=d.bgColor?new $(d.bgColor):null:Qe(Ee,d.baseUrl,d.skyPath,d.skyCode),ze.shadowMap.enabled=!0,ze.shadowMap.type=ee,ht=new te,yt=new oe,ft=new ne,rt(wt,lt.dbName,lt.version).then((e=>{e?(ae.enabled=!0,gt=e,Kt()):Kt()})),ze.domElement.addEventListener("dblclick",Nt),ze.domElement.addEventListener("pointerdown",Rt),ze.domElement.addEventListener("pointermove",Ut),ze.domElement.addEventListener("pointerup",Ft)};return a((()=>{if(!d.models||0==d.models.length)throw new Error("模型数据不可为空");fo(),He(),window.addEventListener("resize",Ue,!1)})),s((()=>{clearTimeout(Ge.timer),m.wsClose(),clearInterval(We.timer),clearTimeout(We.sideToggleTimer),window.removeEventListener("resize",Ue),window.removeEventListener("keyup",co),window.removeEventListener("keydown",uo),cancelAnimationFrame(Fe);try{Ee.clear(),ze.dispose(),ze.forceContextLoss(),ze.content=null;let e=ze.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext()}catch(e){}})),t({floorAnimate:Ot,setControls:e=>{"object"==typeof e&&Object.keys(e).forEach((t=>{Te[t]=e[t]}))},resize:Ue}),(e,t)=>{const o=K;return p(),A("div",{class:j(e.$style["three-scene"])},[D("div",{class:j([e.$style.operation,"operation"]),onDblclick:t[0]||(t[0]=N((()=>{}),["stop"]))},[(p(),r(o,{key:0,onClick:mo,type:"success"},{default:l((()=>[X("随机更新")])),_:1})),(p(),r(o,{key:1,onClick:po,type:"warning"},{default:l((()=>[X("巡航")])),_:1})),(p(),r(o,{key:2,onClick:lo,type:"success"},{default:l((()=>[X("场景坐标")])),_:1})),(p(),r(o,{key:3,onClick:pt,type:"warning"},{default:l((()=>[X("切换背景")])),_:1}))],34),D("div",{ref_key:"containerRef",ref:w,class:j(e.$style.container),onKeyup:co},null,34),c(Xe).show?(p(),A("div",{key:0,class:j(e.$style.loading),style:O({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[1]||(t[1]=N((()=>{}),["stop"]))},[D("div",{class:j(e.$style.progress),style:O({"--percentage":c(Xe).percentage+"%"})},[D("div",{class:j(e.$style["bar-out"])},[D("div",{class:j(e.$style.bar)},null,2)],2),D("div",{class:j(e.$style.text)},I(c(Xe).percentage)+"%",3)],6)],38)):R("",!0),c(Ye).show?(p(),A("div",{key:1,class:j(e.$style.dialog),style:O(c(Ye).style)},[U(e.$slots,"dialog",{data:c(Ye).data,title:c(Ye).title,pos:c(Ye).pos})],6)):R("",!0),D("div",{class:j(e.$style["dot-wrap"])},[(p(!0),A(F,null,H(c(Je),((t,o)=>(p(),A(F,null,[t.show?(p(),A("div",{class:j(e.$style.dot),key:o,style:O(t.style),onClick:e=>(e=>{mt("click-dot",Q(e))})(t)},[D("div",{class:j(e.$style.bg)},null,2),D("span",{class:j(e.$style.inner)},I(t.value)+I(t.unit),3)],14,ct)):R("",!0)],64)))),256))],2)],2)}}}),[["__cssModules",{$style:{"three-scene":"_three-scene_16vpt_2",container:"_container_16vpt_11",operation:"_operation_16vpt_15",loading:"_loading_16vpt_22",progress:"_progress_16vpt_36","bar-out":"_bar-out_16vpt_40",bar:"_bar_16vpt_40","striped-flow":"_striped-flow_16vpt_1",text:"_text_16vpt_56",dialog:"_dialog_16vpt_72","dot-wrap":"_dot-wrap_16vpt_77",dot:"_dot_16vpt_77",bg:"_bg_16vpt_93",inner:"_inner_16vpt_101"}}]]),ut=[dt];Ee.configure({showSpinner:!1});const{t:pt}=je.global;Ne.interceptors.request.use((e=>{let t=Oe().token;return t&&(e.headers.Authorization=t),e}),(e=>Promise.reject(e))),Ne.interceptors.response.use((e=>{var t;return 20010090===(null==(t=e.data)?void 0:t.code)&&Oe().resetToken().then((()=>{window.location.reload()})),e}),(e=>Promise.reject(e))),Ie.beforeEach((async(e,t,o)=>{Ee.start();const n=document,a=e.meta.title;Se().i18n?n.title=a?pt(`route.${a}`).toUpperCase():"loading...":n.title=a;const s=Oe(),i=s.token,r=`${Re}/login`;if(i)if(e.path==r)o({path:`${Re}/`}),Ee.done();else{if(e.path==`${Re}/index`)return o({path:`${Re}/`}),void Ee.done();if(s.powers&&s.powers.length>0)o();else try{const{permissions:t}=await s.getUserInfo(),n=Ue();(await n.generateRoutes(t)).forEach((e=>{Ie.hasRoute(e.name)||Ie.addRoute(e)})),o({...e,replace:!0})}catch(l){await s.resetToken(),o(`${r}?redirect=${e.path}`),Ee.done()}}else e.path==r?o():(o(`${r}?redirect=${e.path}`),Ee.done())})),Ie.afterEach((()=>{Ee.done()}));const mt=(e,t,o)=>{let n={};return"string"==typeof e||e instanceof Array?n=e:(null!=t&&(n.msg=t),null!=o&&(n.code=o),"object"==typeof e&&Object.keys(e).forEach((t=>{n[t]=e[t]}))),n},ht=mt,yt=[{url:"/user/login",method:"post",response:()=>ht({token_type:"bearer",access_token:Me.mock("@guid")})},{url:"/user/logout",method:"get",response:()=>ht({},"退出登录")},{url:"/user/changePwd",method:"post",response:()=>ht({},"密码修改成功")},{url:"/user/getUserInfo",method:"get",response:()=>ht({sysUser:{id:Me.mock("@id"),name:Me.mock("@cname"),account:Me.mock("@first"),avatar:Me.Random.image("50x50",Me.mock("@hex"),"E")},permissions:["ALL_SN"]})}];Me.Random.extend({phone:function(){return this.pick(["132","135","188","158","178"])+Me.mock(/\d{8}/)},family:function(){return this.pick(["汉族","满族","彝族","藏族","傣族"])}});const ft=mt,gt=[...yt,...[{url:"/test/list",method:"get",response:()=>ft(Me.mock({"Total|20-100":100,"Data|10":[{Name:"@cname",Phone:"@phone",Email:"@email",Family:"@family",Id:"@id","Age|10-40":100,"Income|3000-40000":100,Birthday:"@datetime(yyyy-MM-dd)",Region:"@region",Province:"@province",City:"@city",County:"@county",Remark:"@csentence",hasChildren:"@boolean","childrens|2":[{Name:"@cname",Phone:"@phone",Email:"@email",Family:"@family",Id:"@id","Age|10-40":100,"Income|3000-40000":100,Birthday:"@datetime(yyyy-MM-dd)",Region:"@region",Province:"@province",City:"@city",County:"@county",Remark:"@csentence"}]}]}))},{url:"/test/add",method:"post",response:()=>ft({},"添加成功")},{url:"/test/update",method:"put",response:()=>ft({},"更新成功")},{url:"/test/get",method:"get",response:()=>ft(Me.mock({name:"@cname",phone:"@phone",email:"@email",family:"@family",id:"@id","age|10-40":100,"income|3000-40000":100,birthday:"@datetime(yyyy-MM-dd)",region:"@region",province:"@province",city:"@city",county:"@county",remark:"@csentence"}))},{url:"/test/del",method:"delete",response:()=>ft({},"删除成功")},{url:"/test/items",method:"get",response:()=>ft(Me.mock({"Data|3-10":[{"label|1-5":"★","value|+1":1,"disabled|1-3":!0}]}))},{url:"/test/group",method:"get",response:()=>ft(Me.mock({"Data|1-3":[{"label|1":["Vue","Vite","Typescript","Pinia"],"value|+1":1,"disabled|1-3":!0,"children|3-8":[{"label|1-5":"★","value|+1":1,"disabled|1-3":!0}]}]}))}],...[...[{url:"/monitor/get_config",method:"get",response:e=>{const{id:t}=e.query||{};if("123456"==t)return mt({id:1,name:"制冷站监测系统"})}}]]].map((e=>(e.url="/mock"+e.url,e)));const wt=Te(Je);wt.directive("focus",{mounted(e){e.focus()}}),wt.use(Pe()).use(Ie).use(je).use(Fe).use((function(e){ut.forEach((t=>{e.component(t.name,t)}))})).use(He).mount("#app"),ze([...gt]);export{dt as _};
