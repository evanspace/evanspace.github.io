var e=Object.defineProperty,t=(t,o,n)=>(((t,o,n)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n})(t,"symbol"!=typeof o?o+"":o,n),n);import{k as o,c as n,u as i,a as s,t as r,d as a,e as l}from"./model-loader-d2b6f26d.js";import{e as c,A as d,_ as h}from"./index-c2ca0eee.js";import{bH as u,bO as p,cg as m,bh as _,e as g,Y as f,i as b,l as y,aa as v,o as x,g as G,h as k,u as C,n as A,q as w}from"./vendor-8986b6ad.js";import{T as j,u as D}from"./scene-resize-6ab2e993.js";import{u as M,a as z}from"./background-954024da.js";const O="ANCHOR_POS",S="MAIN_SCENE",B=300,{raycaster:E,pointer:P,update:T,style:N}=M(),{initCSS2DRender:R,createCSS2DDom:U}=i();class $ extends j{constructor(e,o){super(e),t(this,"buildingGroup"),t(this,"anchorGroup"),t(this,"dotGroup"),t(this,"extend"),t(this,"css2DRender"),t(this,"clock"),t(this,"animateModels"),this.extend=o,this.css2DRender=R(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.clock=new u,this.animateModels=[],this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup()}addBuildingGroup(){const e=new p;e.name="建筑组",this.buildingGroup=e,this.addObject(e)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot()}addBuilding(...e){this.buildingGroup&&this.buildingGroup.add(...e)}addAnchorGroup(){const e=new p;e.name="锚点组",this.anchorGroup=e,this.addObject(e)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(e){this.anchorGroup&&this.anchorGroup.add(e);const{x:t,y:n,z:i}=e.position;o(e,[t,n,i],1,8)}addDotGroup(){const e=new p;e.name="点位组",this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const o=e.position,{size:n,color:i}=e.font||{},{x:s=0,y:r=0,z:a=0}=o||{},l=U({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=i?`color: ${i}`:""}"></span>\n      `,className:"dot-2D-label",position:[s,r,a],onClick:t});return l.name=e.name,l.data=e,l._position_={x:s,y:r,z:a},this.dotGroup.add(l),l}getAnimTargetPos(e,t,o){const n=t||e.to||{x:-104,y:7,z:58},i=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(i.x,i.y,i.z),n}addModelAnimate(e,t=[],o=!0,n=1){if(!t.length)return;const i=new m(e),s=t.reduce(((e,t)=>{const s=t.name||"";return e[s]=i.clipAction(t),o&&e[s].play(),e[s].timeScale=n,e}),{});e.__action__=s,e.__mixer__=i,this.animateModels.push(e)}cameraTransition(e){const{to:t,target:o=e.position}=e.data;if(t&&!this.isCameraMove(t)){const{x:e,y:i,z:s}=o;this.controls.target.set(e,i,s),n(this.camera,t,this.controls.target)}}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let e=this.clock.getDelta();this.animateModels.length&&this.animateModels.forEach((t=>{t.__mixer__&&t.__mixer__.update(e)})),this.anchorGroup.children.forEach((t=>{t.__mixer__&&t.__mixer__.update(e)}))}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<B;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o,n;const i=this.container,s=this.options.scale;T(e,i,s);let r="pointerdown"==e.type||"pointerup"==e.type;const a=this.buildingGroup.children.filter((e=>e.visible&&(r||e.__ground__))).concat(this.anchorGroup.children);E.setFromCamera(P,this.camera);let l=E.intersectObjects(a,r);if(i.style.cursor=!r&&l.length>0?"pointer":"auto",r)if(l.length){const e=l[0],n=e.object,i="string"==typeof n.name&&(this.extend.groundMeshName||[]).some((e=>n.name.indexOf(e)>-1)),s=this.findParentGroup(n);if(i&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickGround)&&this.extend.onClickGround(s,e),!s)return;"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft(s,e)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(l)}hoverAnchor(e){if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(e[0],N),e.length){const t=e[0].object;if(!t._isAnchor_)return;const o=t.material;void 0===t.__mat_color__&&(t.__mat_color__=o.color),o.color=new _(16715760),this.anchorGroup.children.forEach((e=>{e.__change_color__=e.uuid===t.uuid}))}else this.anchorGroup.children.forEach((e=>{e.__change_color__=!1}))}restoreAnchorMaterial(){this.anchorGroup.traverse((e=>{e.isSprite&&!e.__change_color__&&e.__mat_color__&&(e.material.color=e.__mat_color__)}))}findParentGroup(e){const t=e=>{if(e._isBuilding_)return e;let o=e.parent;return o?o&&o._isBuilding_?o:t(o):void 0};return t(e)}getAll(){return this.buildingGroup.children.concat(this.dotGroup.children)}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}}const L=(e,t)=>{const o=40*Math.random();return void 0!==o&&(e.value=o),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:"#"+(16777215+1e6*o).toString(16).substring(0,6)}}},I={class:"scene-operation"},J=h(g({__name:"index",setup(e){const t=f({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr",dotKey:"DOT",dotShowStrict:!1,config:{},anchorType:[O],animationModelType:[S],models:[{key:S,name:"场景",size:50.6,url:"/深圳北站.glb"},{key:"building",name:"楼宇",size:.3,url:"/楼宇.glb"},{key:"residential",name:"居民楼",size:.08,url:"/居民楼.glb"},{key:"small_residential",name:"小型居民楼",size:.08,url:"/小型居民楼.glb"},{key:O,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/pos.png"}].map((e=>(e.url&&(e.url="/oss/model/station"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/station"+e.mapUrl),e)))}),{changeBackground:o,backgroundLoad:i}=z(),{progress:h,loadModels:u,getModel:p}=s({baseUrl:t.baseUrl,indexDB:{cache:!0,dbName:"THREE__STATION__DB",tbName:"TB",version:4}}),m=b(),_={axes:{visible:!0},grid:{visible:!1,fork:!0,divisions:20},fog:{visible:!1,near:1e3,far:3e3,color:15716789},controls:{enableDamping:!0,dampingFactor:.48,maxPolarAngle:.45*Math.PI,screenSpacePanning:!1,maxDistance:800},directionalLight:{intensity:3}};let g;y((()=>{_.container=m.value,g=new $(_,{onClickLeft:(e,t)=>{if(e&&e.data){const t=e.data;if((null==t?void 0:t.type)===O)g.cameraTransition(e)}}}),g.run(),D(g).resize(),j()}));const j=()=>{B(),i(g,t.skyCode)},M=b([]),B=()=>{u(t.models,(()=>{c.get(d.d3.station).then((async e=>{let o={};if(e.ConfigJson instanceof Object)o=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{o=JSON.parse(e.ConfigJson)}catch(n){}M.value=e.JsonList,Object.keys(o).forEach((e=>{t.config&&(t.config[e]=o[e])})),await E()}))}))},E=async()=>{h.percentage=100,h.show=!1,g.clearBuilding(),await v(),await P();const e=g.getAnimTargetPos(t.config||{});n(g.camera,e,g.controls.target).then((()=>{g.controlSave()}))},P=()=>{let e=0,t=M.value.length;return new Promise((o=>{if(0==t)return o(null);const n=async()=>{const i=M.value[e];await T(i),e++,e<t?n():o(e)};n()}))},T=async e=>{if(!e)return;const{type:o,url:n}=e,i=p(o);if(!i)return void(n||o===t.dotKey&&R(e));const{anchorType:s=[],animationModelType:r=[]}=t;let c=a(i);const{position:d,scale:h,rotation:u}=l(c,e),[m,_,f]=d;return c.scale.set(...h),c.position.set(m,_,f),c.rotation.set(...u),c._isBuilding_=!0,c.data=e,r.includes(o)&&g.addModelAnimate(c,i.animations,!0,1),s.includes(o)?(c._isAnchor_=!0,g.addAnchor(c)):g.addBuilding(c),Promise.resolve()},N=e=>{var o;const n=e.data;{const e=L(n,g.buildingGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{n[t]=e[t]}))}e.visible=n.show||!t.dotShowStrict;const i=null==(o=e.element)?void 0:o.getElementsByClassName("inner")[0];if(i){const{size:e,color:t}=n.font||{};null!=e&&(i.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(i.style.color=t),i.textContent=`${n.value||0}${n.unit}`}},R=e=>{N(g.addDot(e,(e=>{})))};return(e,n)=>(x(),G("div",{class:A(e.$style.page)},[k("div",I,[k("div",{class:"btn",onClick:n[0]||(n[0]=()=>{g.getAll().forEach(((e,o)=>{e.data&&(e.data.type!==t.dotKey||N(e))}))})},"随机更新"),k("div",{class:"btn",onClick:n[1]||(n[1]=()=>{var e;return null==(e=C(g))?void 0:e.getPosition()})},"场景坐标"),k("div",{class:"btn",onClick:n[2]||(n[2]=()=>C(o)(C(g)))},"切换背景"),k("div",{class:"btn",onClick:n[3]||(n[3]=()=>{var e;return null==(e=C(g))?void 0:e.controlReset()})},"控制器重置")]),k("div",{class:A(e.$style.container),ref_key:"containerRef",ref:m},null,2),w(r,{modelValue:C(h).show,"onUpdate:modelValue":n[4]||(n[4]=e=>C(h).show=e),progress:C(h).percentage},null,8,["modelValue","progress"])],2))}}),[["__cssModules",{$style:{page:"_page_3jcdv_2",container:"_container_3jcdv_9"}}]]);export{J as default};
