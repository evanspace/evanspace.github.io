import{d as e,c as t,b as s,F as l,e as i,h as a,a as n,x as o,y as d,n as c,w as p,u as r,t as y,l as u,L as v,r as m,g as x,o as h,j as f,aO as g,ae as _,I as k,z as w,R as $,M as b,k as C,i as L,ak as D,bO as z,at as M,au as V,aD as T,ax as B,ay as Q,bP as X,bQ as I}from"./vendor-59c65e9f.js";import{a as j,D as O,e as H,P,u as E,f as S}from"./common-24a0b7a6.js";import{a as F}from"./data-07702360.js";import{_ as J}from"./api-4fe51afc.js";const U={title:"pipe",order:10},A={class:"plane-device__content"},N=["onClick","onMousedown"],G={class:"device-item__wrap"},K=["src"],R={class:"device-item--mark"},Y={class:"device-item--text"},W={key:2,class:"device-item--name"},q=e({name:"plane-device",__name:"index",props:{list:{},active:{},type:{},locked:{type:Boolean},display:{type:Boolean},showName:{type:Boolean},hideType:{}},emits:["click","mousedown","mouseup"],setup(e,{emit:v}){const m=j(),x=e,h=e=>{var t;return!x.display||!(null==(t=x.hideType)?void 0:t.includes(e.type))},f=v,g=e=>{const{error:t=0,status:s=0}=e;let l=t>0?"error":s>0?"run":"normal",i=e.type;return[O.LDB,O.LQB].includes(i)?i="LDB":[O.LXJ,O.BSHLQ].includes(i)?i="LXJ":[O.LDFM,O.LQFM].includes(i)&&(i="FM"),`${m.oss}/img/device/${l}/${i}.png`},_=(e="")=>"℃"==e?"T":"kPa"==e?"AP":"m³/h"==e?"F":"";return(e,v)=>(n(),t("div",{class:a(["plane-device",{"is-locked":e.locked}])},[s("div",A,[(n(!0),t(l,null,i(e.list,((i,m)=>o((n(),t("div",{key:m,class:a(["device-item",{[i.type]:!0,"is-active":e.active==m}]),style:c({left:`${i.style.x}px`,top:`${i.style.y}px`,color:i.color,marginTop:`${i.my}px`,marginLeft:`${i.mx}px`,zIndex:i.zIndex}),onClick:t=>f("click",m,i,e.type),onMousedown:p((t=>f("mousedown",t,m,i,e.type)),["stop"]),onMouseup:v[0]||(v[0]=e=>f("mouseup",e))},[s("div",G,[i.type!=r(O).DOT?(n(),t("img",{key:0,src:g(i),style:c({transform:`rotate(${i.rotate}deg)`})},null,12,K)):(n(),t(l,{key:1},[s("div",R,y(_(i.unit)),1),s("div",Y,y(i.value??0)+y(i.unit),1)],64)),e.showName?(n(),t("div",W,y(i.name)+y(i.deviceCode?`(${i.deviceCode})`:""),1)):u("",!0)])],46,N)),[[d,h(i)]]))),128))])],2))}}),Z={viewBox:"0 0 1024 1024",width:"1.2em",height:"1.2em"},ee=[s("path",{fill:"currentColor",d:"M160 256H96a32 32 0 0 1 0-64h256V95.936a32 32 0 0 1 32-32h256a32 32 0 0 1 32 32V192h256a32 32 0 1 1 0 64h-64v672a32 32 0 0 1-32 32H192a32 32 0 0 1-32-32zm448-64v-64H416v64zM224 896h576V256H224zm192-128a32 32 0 0 1-32-32V416a32 32 0 0 1 64 0v320a32 32 0 0 1-32 32m192 0a32 32 0 0 1-32-32V416a32 32 0 0 1 64 0v320a32 32 0 0 1-32 32"},null,-1)];const te={name:"ep-delete",render:function(e,s){return n(),t("svg",Z,[...ee])}},se={viewBox:"0 0 1024 1024",width:"1.2em",height:"1.2em"},le=[s("path",{fill:"currentColor",d:"M480 480V128a32 32 0 0 1 64 0v352h352a32 32 0 1 1 0 64H544v352a32 32 0 1 1-64 0V544H128a32 32 0 0 1 0-64z"},null,-1)];const ie={name:"ep-plus",render:function(e,s){return n(),t("svg",se,[...le])}},ae=J(e({__name:"line-point",props:{x:{},y:{},isEnd:{type:Boolean},isStart:{type:Boolean},isX:{type:Boolean}},emits:["mousedown","direction"],setup(e,{emit:s}){const l=s;return(e,s)=>(n(),t("div",{class:a({[e.$style.point]:!0,[e.$style["is-end"]]:e.isEnd,[e.$style["is-x"]]:!e.isEnd&&e.isX,[e.$style["is-y"]]:!e.isEnd&&!e.isX}),style:c({left:`${e.x}px`,top:`${e.y}px`}),onMousedown:s[1]||(s[1]=p((e=>l("mousedown",e)),["stop"]))},[e.isEnd?(n(),t("div",{key:0,class:a({[e.$style["point-direction"]]:!0,[e.$style["d-x"]]:e.isX,[e.$style["d-y"]]:!e.isX,[e.$style["is-start"]]:e.isStart}),onMousedown:s[0]||(s[0]=p((e=>l("direction",e)),["stop"]))},null,34)):u("",!0)],38))}}),[["__cssModules",{$style:{point:"_point_nafi7_2","is-end":"_is-end_nafi7_12","is-x":"_is-x_nafi7_16","is-y":"_is-y_nafi7_19","point-direction":"_point-direction_nafi7_22","d-x":"_d-x_nafi7_26","d-y":"_d-y_nafi7_33"}}]]),ne=[s("span",null,"你的浏览器不支持 canvas，请升级你的浏览器。",-1)],oe=["width","height"],de=["stroke","stroke-width","d"],ce={key:0,attributeName:"stroke-dashoffset",values:"0;-120",dur:"2s",repeatCount:"indefinite"},pe=J(e({__name:"pipe",props:{list:{},active:{},type:{},width:{default:6},scale:{},gap:{default:2},display:{type:Boolean},hideType:{},locked:{type:Boolean},animate:{type:Boolean}},emits:["click","mousedown","mouseup","change"],setup(e,{expose:p,emit:y}){const k=e,w=y;v((()=>k.list),(async()=>{R(),await _(),N()}),{deep:!0});const $=m([]),b=m(),C=x({isPointer:!1,isMove:!1,list:[]}),L=e=>{const t=b.value.parentNode.parentNode.parentNode.getBoundingClientRect(),s=k.scale??1,l=(e.clientX-t.x)/s,i=(e.clientY-t.y)/s,a=$.value;let n=!1,o=-1;for(let d=0;d<a.length;d++){const e=a[d],t=C.list[d];if(!t)break;const s=t.style||{},c=e.getContext("2d"),p=l-(s.x??0),r=i-(s.y??0);if(n=c.isPointInStroke(p,r),n){o=d;break}}return{isInside:n,index:o}},D=e=>{const t=L(e).isInside;C.isPointer=t},z=e=>{const{isInside:t,index:s}=L(e);t&&(e.stopPropagation(),e.preventDefault(),w("mousedown",e,s,C.list[s],k.type))},M=e=>{var t;return!k.display||!(null==(t=k.hideType)?void 0:t.includes(e.type))},V=()=>(k.width??6)+2*(k.gap??0),T=e=>{const t=H.i,s=C.list[e],l=s.paths.length;return l==s.points.length?t:t==l?l-1:0==t?0:t-1};let B=.5;const Q=e=>{if(e>C.list.length-1)return;const t=C.list[e],s=V()/2,l=t.paths,i=l.length;let a=0,n=0,o=l[0].x,d=l[0].y;for(let c=i-1;c>=0;c--){const t=l[c];if(!t)break;const{x:s,y:p}=t;s>a&&(a=s),p>n&&(n=p),o>s&&(o=s),d>p&&(d=p);const r=l[c-1];if(!r)break;const{x:y,y:u}=r;if(y!=s&&u!=p&&i<=2){const t=(s-y)/2+y,i={x:t,y:u},a={x:t,y:p};c==T(e)&&(H.i+=2),l.splice(c,0,i,a)}l.length>2&&(s==y&&p==u||Math.abs(s-y)<=B&&Math.abs(p-u)<=B&&(t.moved||Y))&&(c<=H.i&&(H.i-=1),l[c].moved=!0,l.splice(c-1,1));const v=l[c+1];v&&((v.x==t.x&&t.x==r.x&&(v.y>t.y&&t.y>r.y||v.y<t.y&&t.y<r.y)||v.y==t.y&&t.y==r.y&&(v.x>t.x&&t.x>r.x||v.x<t.x&&t.x<r.x))&&(H.i-c>2||Y)&&(H.i-=1,l.splice(c,1)))}o>s&&I(e,o-s),d>s&&j(e,d-s),(e=>{const t=C.list[e].paths;if(t.length<=2)return;const s=T(e),l=t[s],i=0==s?1:-1,a=t[s+i];if(!a)return;let{x:n,y:o}=a,{x:d,y:c}=l;d!==n&&(o=c),t[s+i].y=o})(e),t.width=a+s,t.height=n+s},X=(e,t)=>{const{x:s,y:l}=e,i=C.list[t],a=T(t),n=V()/2,o=i.paths,d=o.length;if(0==a||a==d-1){const e=0==a?a:d-1;let{x:c,y:p}=o[e];c+=s,p+=l,p<n&&(j(t,p-n),p=n),c<n&&(I(t,c-n),c=n);i.paths[e].moved&&!H.isDire?((e,t)=>{const s=C.list[e].paths,l=s.length,i=T(e),{x:a,y:n,moved:o}=s[i];if(!o)return;const d=s[i+1];if(0==i&&d)if(d.moved){const e=(t.y-n)/2+n,l={x:t.x,y:t.y},o={x:a,y:e};s.splice(i+1,0,l,o)}else s[i].x=t.x,s[i].y=t.y;if(i==l-1){const l={x:a,y:(t.y-n)/2+n},o={x:a,y:t.y};i==T(e)&&(H.i+=2),s.splice(i+1,0,l,o)}})(t,{x:c,y:p}):(i.paths[e].x=c,i.paths[e].y=p)}Q(t)},I=(e,t)=>{const s=C.list[e];s.style.x+=t;const l=s.paths;for(let i=0;i<l.length;i++)l[i].x-=t},j=(e,t)=>{const s=C.list[e];s.style.y+=t;const l=s.paths;for(let i=0;i<l.length;i++)l[i].y-=t},O=e=>{const{index:t,i:s}=H;let{x:l,y:i}=e;const a=k.scale??1;l/=a,i/=a;const n=C.list[t].points;0==s||s==n.length-1?X({x:l,y:i},t):(e=>{const{index:t,i:s}=H,l=C.list[t].paths,i=l[s],a=l[s-1];if(!i||!a)return;const n=V()/2;if(K(i,a)){let a=i.y+e.y;a<n&&(j(t,a-n),a=n),l[s].y=a,l[s-1].y=a}else{let a=i.x+e.x;a<n&&(I(t,a-n),a=n),l[s].x=a,l[s-1].x=a}l[s].moved=!0,l[s-1].moved=!0,Q(t)})({x:l,y:i})},H={x:0,y:0,index:-1,i:-1,isDire:!1,isX:!1},P=e=>{let t=!Boolean(e.changedTouches);const s=t?e:e.changedTouches[0];return{x:s[t?"clientX":"pageX"],y:s[t?"clientY":"pageY"]}},E=e=>{const t=H.isDire,s=H.isX,{x:l,y:i}=P(e),a={x:l-H.x,y:i-H.y};t&&(s?a.y=0:a.x=0),O(a),H.x=l,H.y=i},S=()=>{H.i=-1},F=(e,t,s)=>{H.isDire=!1;const{x:l,y:i}=P(e);H.x=l,H.y=i,H.i=s,H.index=t,document.body.onmousemove=e=>{E(e)},document.body.onmouseleave=J,document.body.onmouseup=J},J=e=>{H.i<0||(E(e),document.body.onmousemove=null,document.body.onmouseup=null,document.body.onmouseleave=null,w("change"))},U=(e,t)=>{const s=Number(`0x${e.substring(1)}`);return`rgba(${s>>16&255}, ${s>>8&255}, ${255&s}, ${t})`},A=(e,t)=>{const s=window.devicePixelRatio??1,{x:l,y:i}=t;e.lineTo(l*s,i*s)},N=()=>{$.value.forEach(((e,t)=>{(e=>{const t=window.devicePixelRatio??1,s=$.value[e];if(!s)return;const l=C.list[e];s.width=l.width*t,s.height=l.height*t;const i=s.getContext("2d");if(!s.getContext)return;l.paths.forEach(((e,s)=>{if(0==s){const{x:s,y:l}=e;i.moveTo(s*t,l*t)}else A(i,e)})),i.lineWidth=V()*t,i.strokeStyle=U(l.color,.4),i.stroke()})(t)}))},G=(e,t)=>{const s=C.list[e].paths,l=s.length;let i=-1;0==t?i=1:t>=l&&(t=l-1);const a=s[t],n=s[t+i];return K(a,n)},K=(e,t)=>e.y==t.y,R=()=>{C.list=k.list.map((e=>{const t=g(e);return t.points=(e=>{let t=[];for(let s=0;s<e.length;s++){const l=e[s];if((0==s||s==e.length-1)&&(t.push([l.x,l.y]),s==e.length-1))break;const{x:i,y:a}=l,n=e[s+1],{x:o,y:d}=n;K(l,n)?t.push([(o-i)/2+i,d]):t.push([o,(d-a)/2+a])}return t})(t.paths),t}))};let Y=!1;return R(),h(N),p({optimize:()=>{const e=B;B=2,Y=!0,H.i=0,$.value.forEach(((e,t)=>{Q(t)})),B=e,Y=!1}}),(e,p)=>(n(),t("div",{ref_key:"pipeRef",ref:b,class:a({[e.$style.pipes]:!0,[e.$style["is-locked"]]:e.locked,[e.$style["is-pointer"]]:r(C).isPointer}),onMousemove:D,onMousedown:z},[(n(!0),t(l,null,i(r(C).list,((p,r)=>{return o((n(),t("div",{key:r,style:c({left:`${p.style.x}px`,top:`${p.style.y}px`,marginTop:`${p.my}px`,marginLeft:`${p.mx}px`,zIndex:p.zIndex}),class:a({[e.$style.item]:!0,[e.$style["is-active"]]:e.active==r})},[s("div",{class:a(e.$style["item-wrap"]),style:c({width:`${p.width}px`,height:`${p.height}px`}),onMousedown:S,onMouseup:J},[s("canvas",{ref_for:!0,ref:e=>((e,t)=>{$.value[t]=e})(e,r)},ne,512),(n(),t("svg",{width:p.width,height:p.height},[s("path",{stroke:U(p.color,.8),"stroke-width":e.width,"stroke-dasharray":"20,20",fill:"transparent",d:(y=p.paths,y.map(((e,t)=>`${0==t?"M":"L"}${e.x} ${e.y}`)).join(" "))},[e.animate?(n(),t("animate",ce)):u("",!0)],8,de)],8,oe)),e.active==r?(n(!0),t(l,{key:0},i(p.points,((e,t)=>(n(),f(ae,{x:e[0],y:e[1],"is-start":0==t,"is-end":0==t||t==p.points.length-1,"is-x":G(r,t),onMousedown:e=>F(e,r,t),onDirection:e=>((e,t,s)=>{const l=G(t,s);H.isX=l,F(e,t,s),H.isDire=!0})(e,r,t)},null,8,["x","y","is-start","is-end","is-x","onMousedown","onDirection"])))),256)):u("",!0)],38)],6)),[[d,M(p)]]);var y})),128))],34))}}),[["__cssModules",{$style:{pipes:"_pipes_jc6ti_2","is-locked":"_is-locked_jc6ti_2","is-pointer":"_is-pointer_jc6ti_7",item:"_item_jc6ti_10","is-active":"_is-active_jc6ti_13","item-wrap":"_item-wrap_jc6ti_23",dash:"_dash_jc6ti_1"}}]]),re=[{name:"冷冻回",type:P.LDH,color:"#2263E7"},{name:"冷冻供",type:P.LDG,color:"#2A19CC"},{name:"冷却供",type:P.LQG,color:"#CA691B"},{name:"冷却回",type:P.LQH,color:"#1F6C28"}],ye=[{name:"冷冻泵",type:O.LDB,key:H.CHWP},{name:"冷却泵",type:O.LQB,key:H.CWP},{name:"阀门(冷冻)",type:O.LDFM,key:H.CHWV},{name:"阀门(冷却)",type:O.LQFM,key:H.CWV},{name:"冷却塔",type:O.LQT,key:H.COT},{name:"离心机",type:O.LXJ,key:H.CHL},{name:"分集水器",type:O.JSQ},{name:"监测点",type:O.DOT}],ue=["data-index"],ve=["data-index"],me=["src"],xe={class:"flex flex-ac"},he=s("span",null,"画布大小：",-1),fe=s("span",{class:"pl-xs pr-xs"}," X ",-1),ge={class:"pl-xs"},_e={class:"pl-xs pr-xs"},ke={key:0,class:"flex"},we=s("span",null,"名称：",-1),$e={class:"flex"},be=s("span",null,"类型：",-1),Ce={key:1,class:"flex"},Le=s("span",null,"编号：",-1),De={key:2,class:"flex"},ze=s("span",null,"编号：",-1),Me={key:3,class:"flex"},Ve=s("span",null,"单位：",-1),Te={class:"flex"},Be=s("span",null,"坐标：",-1),Qe={class:"flex"},Xe=s("span",null,"角度：",-1),Ie={key:4,class:"flex"},je=s("span",{class:"pt-xs"},"关联：",-1),Oe=s("span",{class:"pl-xs"},"并联：",-1),He={class:"pl-xs"},Pe=s("span",null,"设备：",-1),Ee=s("span",null,"阀门：",-1),Se={class:"e-drag__dot-content"},Fe=J(e({__name:"index",setup(e){const o=E(),d=j();v((()=>o.sidebar.opened),(()=>{setTimeout((()=>{var e;null==(e=g.value)||e.resize()}),300)}));const h=m(),g=m(),_=x({filters:{},forms:{template:{label:"模板",type:"select",clearable:!0,items:[]},animate:{label:"管路动画",type:"switch",value:!1,cols:.5},lockeDev:{label:"锁定设备",type:"switch",value:!1,cols:.5},lockePipe:{label:"锁定管路",type:"switch",value:!1,cols:.5},display:{label:"隐藏",type:"switch",value:!1,cols:.5},type:{label:"隐藏元素",type:"checkbox",hide:!0,custom:{label:"name",value:"type"},items:re.concat(ye)}},pipes:re,devices:ye,drag:{width:1200,height:900,key:"",index:-1,zIndex:0},edit:{scale:1,type:"",index:-1,devices:[],pipes:[],text:""}}),H="devices",J="pipes",U=x({width:2,gap:4}),A=k((()=>{let e={};return _.edit.index<0||(e=_.edit[_.edit.type][_.edit.index]),e})),N=k((()=>{const e=A.value.type;if(!e)return[];const t=_.edit.devices;let s=[];switch(e){case P.LDG:case P.LDH:s=[O.LDB,O.LXJ,O.LDFM];break;case P.LQG:s=[O.LQT,O.LXJ,O.LQFM];break;case P.LQH:s=[O.LQB,O.LXJ,O.LQT,O.LQFM]}return t.filter((e=>s.includes(e.type)))})),G=k((()=>{const e=A.value.type;if(!e)return[];const t=_.edit.devices;let s=[];switch(e){case P.LDG:case P.LDH:s=[O.LDFM];break;case P.LQG:case P.LQH:s=[O.LQFM]}return t.filter((e=>s.includes(e.type)))})),K=k((()=>{const e=A.value.type;if(!e)return[];const t=_.edit.devices;let s=[];switch(e){case P.LDG:case P.LDH:s=[O.LDB,O.LXJ];break;case P.LQG:s=[O.LQT,O.LXJ];break;case P.LQH:s=[O.LQB,O.LXJ,O.LQT]}return t.filter((e=>s.includes(e.type)))})),R=e=>{const t=_.edit[e].map((e=>{let{name:t,type:s,unit:l,deviceCode:i,style:a,rotate:n,bind:o,parallel:d,paths:c}=e;return c&&(c=c.map((({x:e,y:t})=>({x:e,y:t})))),d&&d.length&&d[0][0].length>0&&(o=d),{name:t,type:s,unit:l,deviceCode:i,style:a,rotate:n,bind:o,paths:c}})),s=JSON.stringify(t,((e,t)=>{if(!(""===t||void 0===t||t instanceof Array&&0==t.length))return t}),2);_.edit.text=s,S(s)},Y=()=>{_.edit.index=-1,_.edit.devices=[],_.edit.pipes=[],et()},W=m(),Z=()=>{var e;null==(e=W.value)||e.optimize(),et()},ee=()=>{},se=()=>{et()},le=(e,t="")=>Number(t.replace(e,"")),ae=e=>{let t=0;const s=_.edit.devices.filter((t=>t.key==e)).sort(((t,s)=>le(e,t.deviceCode)-le(e,s.deviceCode)));for(let l=0;l<s.length;l++){const i=s[l],a=le(e,i.deviceCode);if(a-t>1)break;a>0&&(t=a)}return t},ne=e=>{const t=e.key;if(e.name.indexOf("#")>-1&&(e.name=e.name.split("#")[1]),!t)return e.name;return`${ae(t)+1}#${e.name}`},oe=e=>{const t=e.key;if(!t)return"";return`${t}${ae(t)+1}`},de=(e,t,s)=>{},ce={isMove:!1,x:0,y:0,tsp:0,time:10},Fe=(e,t,s,l)=>{ce.isMove=!0,ce.tsp=Date.now(),((e,t)=>{const s=_.edit;if(s.type=e,s.index==t)return;s.index=t;const l=_.drag;s[e][t].zIndex=l.zIndex,l.zIndex++})(l,t);const i=!Boolean(e.changedTouches),a=i?e:e.changedTouches[0];ce.x=a[i?"clientX":"pageX"],ce.y=a[i?"clientY":"pageY"]},Je=e=>{var t;if(!ce.isMove||_.edit.index<0)return;if(Date.now()-ce.tsp<ce.time)return void(ce.isMove=!1);const s=!Boolean(e.changedTouches),l=s?e:e.changedTouches[0],i=l[s?"clientX":"pageX"]-ce.x,a=l[s?"clientY":"pageY"]-ce.y,n=null==(t=g.value)?void 0:t.getSize(),o=_.edit[_.edit.type][_.edit.index];o.mx=i/n.scale,o.my=a/n.scale},Ue=e=>{if(!ce.isMove)return;if(ce.isMove=!1,_.edit.index<0)return;const t=_.edit[_.edit.type][_.edit.index];let s=t.mx??0,l=t.my??0;0!=s&&(s+=t.style.x,t.style.x=s),0!=l&&(l+=t.style.y,t.style.y=l),t.mx=0,t.my=0,et()},Ae=e=>d.getDeviceSrc(e),Ne=e=>{const t=e.target.dataset;e.dataTransfer.effectAllowed=null==t?void 0:t.effect;const s=_.drag;s.key=null==t?void 0:t.key,s.index=null==t?void 0:t.index,s.zIndex++},Ge=e=>{e.preventDefault()},Ke=e=>{Ye();const t=We(e.target);t&&t.dataset.drop==e.dataTransfer.effectAllowed&&t.classList.add("drop-over")},Re=e=>{Ye();const t=We(e.target);if(t&&t.dataset.drop==e.dataTransfer.effectAllowed){const{key:t,index:s}=_.drag;if(t){const l=_[t][s];"devices"==t?((e,t)=>{var s;const{x:l,y:i}=null==(s=g.value)?void 0:s.displace(e);_.edit.devices.push({...t,zIndex:_.drag.zIndex,name:ne(t),deviceCode:oe(t),status:0,error:0,style:{x:l,y:i}})})(e,l):((e,t)=>{var s;const{x:l,y:i}=null==(s=g.value)?void 0:s.displace(e),a=U.width+2*U.gap,n=a/2;_.edit.pipes.push({...t,style:{x:l,y:i},width:100,height:a,zIndex:_.drag.zIndex,paths:[{x:n,y:n},{x:100-n,y:n}],bind:[],parallel:[[[],[]]]})})(e,l),_.edit.type=_.drag.key,_.edit.index=_.edit[t].length-1,et()}}},Ye=()=>{document.querySelectorAll(".drop-over").forEach((e=>{e.classList.remove("drop-over")}))},We=e=>{for(;e;){if(e.dataset&&e.dataset.drop)return e;e=e.parentNode}},qe=e=>{let t=e;return e instanceof Array?t=e.map((e=>qe(e))):"[object Object]"==Object.prototype.toString.call(e)&&(t={},Object.keys(e).forEach((s=>{let l=e[s];(l instanceof Array||"[object Object]"==Object.prototype.toString.call(e))&&(l=qe(l)),t[s]=l}))),t},Ze={max:50,list:[],tsp:0,time:500},et=()=>{const e=Date.now();if(e-Ze.tsp<Ze.time)return;Ze.tsp=e;const t=Ze.list;t.length>=Ze.max&&t.splice(0,1);const s=qe(_.edit);t.push(s)},tt=e=>{const t=e.keyCode;if(e.ctrlKey&&90==t)return void(()=>{const e=Ze.list,t=e.length;if(0==t)return;const s=e[t-2];if(s){const e=qe(s);Object.keys(e).forEach((e=>{_.edit[e]=qe(s[e])}))}t>1&&e.splice(t-1,1)})();const{index:s,type:l}=_.edit;return s<0||!l?void 0:46==t?(_.edit[l].splice(s,1),_.edit.index=-1,void et()):void(e.ctrlKey&&86==t&&((e,t)=>{const s=qe(_.edit[e][t]);"devices"==e&&s.type!==O.DOT&&(s.name=ne(s),s.deviceCode=oe(s)),s.style.x+=50,_.drag.zIndex++,s.zIndex=_.drag.zIndex,_.edit.index=_.edit[e].length,_.edit[e].push(s),et()})(l,s))},st=e=>{const t=e.keyCode,{index:s,type:l}=_.edit;if(s<0||!l||ce.isMove)return;const i={x:0,y:0};switch(t){case 38:case 87:i.y-=1;break;case 40:case 83:i.y+=1;break;case 37:case 65:i.x-=1;break;case 39:case 68:i.x+=1}0==i.x&&0==i.y||lt(i)},lt=e=>{const t=_.edit[_.edit.type][_.edit.index];0!=e.x&&(t.style.x+=e.x),0!=e.y&&(t.style.y+=e.y),et()},it=()=>{const e=_.edit;e[e.type][e.index].parallel.push([[],[]])},at=e=>{if(!e)return;const t=F.find((t=>t.id==e));let s=0;const l=null==t?void 0:t.pipes.map((e=>{var t;const l=qe(e);l.bind||(l.bind=[]),l.bind[0]instanceof Array?(l.parallel=l.bind,l.bind=[]):l.parallel=[[[],[]]];const{width:i,height:a}=(e=>{let t=0,s=0;for(let i=0;i<e.length;i++){const{x:l,y:a}=e[i];e[i].moved=!0,l>t&&(t=l),a>s&&(s=a)}const l=U.width/2+U.gap;return{width:t+l,height:s+l}})(l.paths);return l.width=i,l.height=a,l.zIndex=s++,l.color=(null==(t=_.pipes.find((e=>e.type==l.type)))?void 0:t.color)||"#000",l})),i=null==t?void 0:t.devices.map((e=>{var t;const l=qe(e);return l.key=null==(t=l.deviceCode)?void 0:t.replace(/[^a-zA-Z]/g,""),l.zIndex=s++,l}));_.drag.zIndex=s,_.edit.devices=i,_.edit.pipes=l,et()},nt=(e,t)=>{if(_.filters[e]=t,"display"==e){_.forms.type.hide=!t}else"template"==e&&at(t)};return(()=>{const e=_.forms;e.template.items=F.map((e=>({label:e.name,value:e.id}))),e.template.onChange=e=>nt("template",e),e.animate.onChange=e=>nt("animate",e),e.lockeDev.onChange=e=>nt("lockeDev",e),e.lockePipe.onChange=e=>nt("lockePipe",e),e.display.onChange=e=>nt("display",e),e.type.onChange=e=>nt("type",e)})(),et(),window.addEventListener("keydown",st,!1),window.addEventListener("keyup",tt,!1),w((()=>{window.removeEventListener("keydown",st),window.removeEventListener("keyup",tt)})),(e,o)=>{const d=$("e-form"),v=D,m=z,x=M,k=V,w=T,j=B,P=Q,E=ie,S=te,F=X,le=I,ae=q,ne=$("e-drag");return n(),t("div",{class:a([e.$style.page,"flex"]),ref_key:"pageRef",ref:h,style:c({"--scale":r(_).edit.scale}),onDragstart:Ne,onDragover:p(Ge,["prevent"]),onDragenter:Ke,onDrop:p(Re,["prevent"])},[s("div",{class:a([e.$style.tools,"p-sm o-a"])},[s("div",{class:a(e.$style.group)},[s("div",{class:a(e.$style.wrap)},[b(d,{forms:r(_).forms,size:"small",inline:!0,cols:1},null,8,["forms"])],2)],2),s("div",{class:a([e.$style.group,e.$style.line])},[s("div",{class:a(e.$style.title)},"管路",2),s("div",{class:a(e.$style.wrap)},[(n(!0),t(l,null,i(r(_).pipes,((l,i)=>(n(),t("div",{class:a(e.$style.item),style:c({"--color":l.color}),"data-effect":"copy","data-key":"pipes","data-index":i,draggable:!0},[s("div",{class:a(e.$style.name)},y(l.name)+"：",3),s("div",{class:a(e.$style.pipe)},null,2)],14,ue)))),256))],2)],2),s("div",{class:a([e.$style.group,e.$style.device])},[s("div",{class:a(e.$style.title)},"设备",2),s("div",{class:a(e.$style.wrap)},[(n(!0),t(l,null,i(r(_).devices,((l,i)=>(n(),t("div",{class:a({[e.$style.item]:!0,[e.$style["is-dot"]]:l.type==r(O).DOT}),"data-effect":"copy","data-key":"devices","data-index":i,draggable:!0},[l.type!=r(O).DOT?(n(),t("img",{key:0,src:Ae(l),draggable:"false"},null,8,me)):(n(),t("div",{key:1,class:a(e.$style.dot)},null,2)),s("div",{class:a(e.$style.name)},y(l.name),3)],10,ve)))),256))],2)],2),b(m,null,{default:C((()=>[b(v,{type:"primary",size:"small",onClick:o[0]||(o[0]=e=>R("devices"))},{default:C((()=>[L("设备")])),_:1}),b(v,{type:"primary",size:"small",onClick:o[1]||(o[1]=e=>R("pipes"))},{default:C((()=>[L("管路")])),_:1}),b(v,{type:"danger",size:"small",onClick:Y},{default:C((()=>[L("清空")])),_:1}),b(v,{type:"warning",size:"small",onClick:Z},{default:C((()=>[L("优化")])),_:1}),b(v,{type:"primary",size:"small",onClick:ee},{default:C((()=>[L("log")])),_:1})])),_:1}),b(x,{class:"mt-xs",type:"textarea",modelValue:r(_).edit.text,"onUpdate:modelValue":o[2]||(o[2]=e=>r(_).edit.text=e),placeholder:"JSON 数据"},null,8,["modelValue"])],2),s("div",{class:a([e.$style.wrapper,"f-x o-h"])},[s("div",{class:a(e.$style["drag-info"])},[s("div",xe,[he,b(k,{size:"small",modelValue:r(_).drag.width,"onUpdate:modelValue":o[3]||(o[3]=e=>r(_).drag.width=e),onKeyup:o[4]||(o[4]=p((()=>{}),["stop"]))},null,8,["modelValue"]),fe,b(k,{size:"small",modelValue:r(_).drag.height,"onUpdate:modelValue":o[5]||(o[5]=e=>r(_).drag.height=e),onKeyup:o[6]||(o[6]=p((()=>{}),["stop"]))},null,8,["modelValue"])])],2),b(le,{class:a(e.$style["device-info"]),accordion:""},{default:C((()=>[b(F,{name:"1"},{title:C((()=>[s("span",ge,y(r(A).name),1)])),default:C((()=>{var d,c;return[s("div",_e,[r(A).type==r(O).DOT?(n(),t("div",ke,[we,s("span",null,[b(x,{size:"small",modelValue:r(A).name,"onUpdate:modelValue":o[7]||(o[7]=e=>r(A).name=e),placeholder:"请输入",onChange:et,onKeyup:o[8]||(o[8]=p((()=>{}),["stop"]))},null,8,["modelValue"])])])):u("",!0),s("div",$e,[be,s("span",null,y(r(A).type),1)]),r(A).type==r(O).DOT?(n(),t("div",Ce,[Le,s("span",null,[b(x,{size:"small",modelValue:r(A).deviceCode,"onUpdate:modelValue":o[9]||(o[9]=e=>r(A).deviceCode=e),placeholder:"请输入",onChange:et,onKeyup:o[10]||(o[10]=p((()=>{}),["stop"]))},null,8,["modelValue"])])])):r(A).deviceCode?(n(),t("div",De,[ze,s("span",null,y(r(A).deviceCode),1)])):u("",!0),r(A).type==r(O).DOT?(n(),t("div",Me,[Ve,s("span",null,[b(x,{size:"small",modelValue:r(A).unit,"onUpdate:modelValue":o[11]||(o[11]=e=>r(A).unit=e),placeholder:"请输入",onChange:et,onKeyup:o[12]||(o[12]=p((()=>{}),["stop"]))},null,8,["modelValue"])])])):u("",!0),s("div",Te,[Be,s("span",null,"x: "+y(null==(d=r(A).style)?void 0:d.x.toFixed(2))+", y: "+y(null==(c=r(A).style)?void 0:c.y.toFixed(2)),1)]),s("div",Qe,[Xe,b(w,{class:"f-x",modelValue:r(A).rotate,"onUpdate:modelValue":o[13]||(o[13]=e=>r(A).rotate=e),min:0,max:360,"show-input":"",size:"small",onChange:et,onKeyup:o[14]||(o[14]=p((()=>{}),["stop"]))},null,8,["modelValue"])]),r(A).bind?(n(),t("div",Ie,[je,b(P,{class:"f-x",modelValue:r(A).bind,"onUpdate:modelValue":o[15]||(o[15]=e=>r(A).bind=e),onChange:et},{default:C((()=>[(n(!0),t(l,null,i(r(N),(e=>(n(),f(j,{value:e.deviceCode},{default:C((()=>[L(y(e.name),1)])),_:2},1032,["value"])))),256))])),_:1},8,["modelValue"])])):u("",!0),r(A).parallel?(n(),f(le,{key:5,accordion:"",class:a(e.$style.parallel)},{default:C((()=>[b(F,{name:"2"},{title:C((()=>[Oe,b(v,{size:"small",circle:"",plain:"",onClick:p(it,["stop"])},{default:C((()=>[b(E)])),_:1})])),default:C((()=>[s("div",He,[(n(!0),t(l,null,i(r(A).parallel,((s,o)=>(n(),t("div",{class:a(e.$style.item)},[Pe,b(v,{size:"small",circle:"",plain:"",onClick:e=>(e=>{const t=_.edit;t[t.type][t.index].parallel.splice(e,1)})(o)},{default:C((()=>[b(S)])),_:2},1032,["onClick"]),b(P,{class:"f-x",modelValue:s[0],"onUpdate:modelValue":e=>s[0]=e,onChange:et},{default:C((()=>[(n(!0),t(l,null,i(r(K),(e=>(n(),f(j,{value:e.deviceCode},{default:C((()=>[L(y(e.name),1)])),_:2},1032,["value"])))),256))])),_:2},1032,["modelValue","onUpdate:modelValue"]),Ee,b(P,{class:"f-x",modelValue:s[1],"onUpdate:modelValue":e=>s[1]=e},{default:C((()=>[(n(!0),t(l,null,i(r(G),(e=>(n(),f(j,{value:e.deviceCode},{default:C((()=>[L(y(e.name),1)])),_:2},1032,["value"])))),256))])),_:2},1032,["modelValue","onUpdate:modelValue"])],2)))),256))])])),_:1})])),_:1},8,["class"])):u("",!0),b(x,{type:"textarea",value:JSON.stringify(r(A),void 0,2)},null,8,["value"])])]})),_:1})])),_:1},8,["class"]),b(ne,{ref_key:"dragRef",ref:g,width:r(_).drag.width,height:r(_).drag.height,"data-drop":"copy",zoom:r(_).edit.scale,"onUpdate:zoom":o[16]||(o[16]=e=>r(_).edit.scale=e),onMousemove:Je,onMouseup:Ue},{default:C((()=>[s("div",Se,[b(ae,{list:r(_).edit.devices,type:H,locked:r(_).filters.lockeDev,display:r(_).filters.display,"hide-type":r(_).filters.type,"show-name":!0,active:r(_).edit.type===H?r(_).edit.index:-1,onClick:de,onMousedown:p(Fe,["stop"]),onMouseup:p(Ue,["stop"])},null,8,["list","type","locked","display","hide-type","active"]),b(pe,{ref_key:"pipeRef",ref:W,list:r(_).edit.pipes,type:J,locked:r(_).filters.lockePipe,animate:r(_).filters.animate,display:r(_).filters.display,"hide-type":r(_).filters.type,width:r(U).width,gap:r(U).gap,scale:r(_).edit.scale,active:r(_).edit.type===J?r(_).edit.index:-1,onClick:de,onMousedown:p(Fe,["stop"]),onMouseup:Ue,onChange:se},null,8,["list","type","locked","animate","display","hide-type","width","gap","scale","active"])])])),_:1},8,["width","height","zoom"])],2)],38)}}}),[["__cssModules",{$style:{page:"_page_1vxkv_2",tools:"_tools_1vxkv_10",group:"_group_1vxkv_17",title:"_title_1vxkv_20",wrap:"_wrap_1vxkv_23",item:"_item_1vxkv_26",name:"_name_1vxkv_29",line:"_line_1vxkv_33",pipe:"_pipe_1vxkv_38",device:"_device_1vxkv_45",dot:"_dot_1vxkv_53",wrapper:"_wrapper_1vxkv_67","drag-info":"_drag-info_1vxkv_70","device-info":"_device-info_1vxkv_71",parallel:"_parallel_1vxkv_88"}}]]),Je=Object.freeze(Object.defineProperty({__proto__:null,default:Fe},Symbol.toStringTag,{value:"Module"}));export{U as _,q as a,Je as i};
