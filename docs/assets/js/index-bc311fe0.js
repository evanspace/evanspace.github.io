var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{o as a,f as s,n as o,aL as i,bv as n,bw as r,bx as l,by as d,bz as c,bA as h,bB as u,bC as m,bD as p,bE as g,bF as b,bG as v,bH as _,X as y,bI as x,bJ as f,ae as w,a9 as G,c as M,h as C,k,g as S,p as O,u as j,m as E,t as T,bK as z,l as $,A as P,at as A,aJ as L,aM as N}from"./vendor-e4ee7844.js";import{_ as H}from"./index-1d839e62.js";import{i as U,S as B,a as F,u as R}from"./scene-resize-407aeb45.js";import{u as I}from"./sky-8d6b28da.js";import{u as D}from"./common-a56eaba7.js";const V=H({},[["render",function(e,t){return a(),s("div",{class:o(e.$style["drop-upload"])},null,2)}],["__cssModules",{$style:{"drop-upload":"_drop-upload_5mkg1_2"}}]]),W="https://ye6.atomgit.net/3d-demo-data",Y=e=>i(e),X=new Proxy({warning:e=>Y({message:e,type:"warning",grouping:!0}),error:e=>Y({message:e,type:"error",grouping:!0}),success:e=>Y({message:e,type:"success",grouping:!0})},{get:(e,t,a)=>e[t]}),Z=e=>{const t=e?e.geometry:new n(200,200),a=new r(t,{textureWidth:512,textureHeight:512,waterNormals:(new l).load(W+"/textures/waternormals.jpg",(e=>{e.wrapS=e.wrapT=d})),sunDirection:new c,sunColor:15732480,waterColor:92299,distortionScale:3.7});return a.material.uniforms.size.value=.5,a},K=()=>{const e=new h(1.75,10,10),t=new u({color:16777215*Math.random(),wireframe:!0}),a=new m(e,t);return a.name="点位",a.position.set(0,140,0),a},q=e=>{const t=[],a=(e,t)=>{var s;for(let o=0;o<e.length;o++){const i=e[o],n={label:i.name,uuid:i.uuid,children:[]};a(i.children,n),null==(s=t.children)||s.push(n)}};return e.children.forEach((e=>{const s={label:e.name,uuid:e.uuid,children:[]};a(e.children,s),t.push(s)})),t},J=e=>{const t=new p;return new Promise((a=>{t.load(e,(e=>{a(new g(e))}))}))},Q=(e,t="",a={},s)=>{const o={rotation:(null==s?void 0:s.rotation)||{x:0,y:0,z:0},position:(null==s?void 0:s.position)||{x:0,y:0,z:0}};let i=new b(t||"",{font:e,size:(null==a?void 0:a.size)||10,depth:null==a?void 0:a.depth,curveSegments:null==a?void 0:a.curveSegments,bevelThickness:null==a?void 0:a.bevelThickness,bevelSize:null==a?void 0:a.bevelSize,bevelEnabled:null==a?void 0:a.bevelEnabled});const n=o.rotation;i.rotateX(n.x),i.rotateY(n.y),i.rotateZ(n.z);const r=o.position;i.computeBoundingBox(),i.computeVertexNormals();let l=.5*(i.boundingBox.max.x-i.boundingBox.min.x),d=.5*(i.boundingBox.max.z-i.boundingBox.min.z),c=new v({color:(null==a?void 0:a.color)||16777215,flatShading:!1}),h=new m(i,c);return h.castShadow=!0,h.position.set((r.x||0)-l,r.y||0,(r.z||0)-d),h.name="text",h._isText_=!0,h},ee=Object.freeze(Object.defineProperty({__proto__:null,Hooks:U,Message:X,Scene:B,THREE:_,Utils:F,base:W,createPointSphere:K,createText:Q,createWater:Z,loadTTFFont:J,modelConvertTree:q},Symbol.toStringTag,{value:"Module"})),te={receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},{skys:ae}=I(),{THREE:se,Utils:oe,Hooks:ie,Scene:ne,Message:re}=ee,{materialReplace:le,changeTransparent:de,exportGlb:ce,getAnimations:he,setMetalnessMaterial:ue,setGlassMaterial:me,centerBoxHelper:pe}=ie.useMaterial(),{backgroundLoad:ge}=ie.useBackground(W+"/sky/",ae),{raycaster:be,pointer:ve,update:_e}=ie.useRaycaster(),ye=y({dotText:"",uploadList:[],uuid:""});class xe extends ne{constructor(e,a){super(e),t(this,"extend"),t(this,"clock"),t(this,"gui"),t(this,"modelGroup"),t(this,"helperGroup"),t(this,"groundMesh"),t(this,"transformControls"),t(this,"guiOpts",{scale:1,side:!1,insetAnimate:!1,transformMaterial:!1,groundReflection:!1,glisten:!1,opacitySkin:!1,opacity:.6}),t(this,"setPiece"),t(this,"water"),t(this,"text"),t(this,"metalnessMaterialUpdate",(({metalness:e,roughness:t,checkName:a})=>{var s;const o=new RegExp(`(${a})`);null==(s=this.modelGroup)||s.children.forEach((a=>{a.traverse((s=>{if(o.test(s.name)||0==a.children.length)if(Array.isArray(s.material))s.material=s.material.map((a=>ue(a,e,t)));else{const a=s.material;s.material=ue(a,e,t)}}))}))})),t(this,"glassMaterialUpdate",(e=>{var t;const a=new RegExp(`(${e.checkName})`);null==(t=this.modelGroup)||t.children.forEach((t=>{t.traverse((s=>{if(a.test(s.name)||0==t.children.length)if(Array.isArray(s.material))s.material=s.material.map((t=>me(t,e)));else{const t=s.material;s.material=me(t,e)}}))}))})),t(this,"blurringMaterialUpdate",(e=>{var t;const a=new RegExp(`(${e.blurringName})`);null==(t=this.modelGroup)||t.children.forEach((t=>{t.traverse((s=>{e.all||0==t.children.length||a.test(s.name)?s.isMesh&&(e.blurring||e.all?(s.__material__||(s.__material__=s.material),s.material=new se.MeshBasicMaterial({color:e.color,wireframe:e.wireframe,transparent:!0,opacity:e.opacity})):s.__material__&&(s.material=s.__material__)):s.isMesh&&s.__material__&&(s.material=s.__material__)}))}))})),this.extend=a,this.addControls(),this.clock=new se.Clock,this.gui=new x,this.addGround(),this.setPiece=K(),this.setPiece.visible=!1,this.addObject(this.setPiece),this.addGui(),this.addModelGroup(),this.bindEvent()}addControls(){const e=this.camera,t=new f(e,this.renderer.domElement);t.addEventListener("dragging-changed",(e=>{this.controls&&(this.controls.enabled=!e.value)})),this.transformControls=t,this.addObject(t.getHelper());const a=e=>this.onKeydown(e);window.addEventListener("keydown",a,!1),w((()=>{window.removeEventListener("keydown",a)}))}onKeydown(e){const t=this.transformControls;if(t)switch(e.key){case"w":t.setMode("translate");break;case"e":t.setMode("rotate");break;case"r":t.setMode("scale");break;case"+":case"=":t.setSize(t.size+.1);break;case"-":case"_":t.setSize(Math.max(t.size-.1,.1));break;case"x":t.showX=!t.showX;break;case"y":t.showY=!t.showY;break;case"z":t.showZ=!t.showZ;break;case" ":t.enabled=!t.enabled;break;case"Escape":t.reset();break;case"Delete":this.deleteModel({uuid:ye.uuid})}}addGui(){var e;const t=this.gui;this.addMainFunction(),this.addPointSphereOpts(),this.addMaterial(),this.addLight(),this.addNameGroupGui(),this.addText(),this.addResetGui(),this.addEvnGui(),t.domElement.className+=" gui-wrap",null==(e=this.container.parentNode)||e.appendChild(t.domElement)}addGround(){const e=new se.PlaneGeometry(5e3,5e3),t=new se.MeshStandardMaterial({color:10530223}),a=new se.Mesh(e,t);a.name="ground",a.rotation.x=1.5*Math.PI,a.receiveShadow=!0,a.visible=!1,this.groundMesh=a,this.addObject(a)}addMainFunction(){const e=this.gui;if(!this.container)return;const t=this.container.parentNode.querySelector('input[type="file"]'),a={importFile:()=>{t.click()},exportGltf:()=>{this.export(!1)},exportGlb:()=>{this.export()},exportPoints:()=>{const e=[this.setPiece].map((e=>{let t=e.position;return`{ "x": ${1*t.x.toFixed(2)}, "y": ${1*t.y.toFixed(2)}, "z": ${1*t.z.toFixed(2)} }`}));ye.dotText=e.join(","),this.copyTextarea("坐标复制成功！")},target:()=>{if(!this.controls)return;const e=this.controls.target;ye.dotText=`{ x: ${e.x}, y: ${e.y}, z: ${e.z} }`,this.copyTextarea("中心点复制成功！")},camera:()=>{const e=this.camera.position;ye.dotText=`{ x: ${e.x}, y: ${e.y}, z: ${e.z} }`,this.copyTextarea("相机坐标复制成功！")},clearScene:()=>{this.clearModelGroup()},resetTree:()=>{if(!this.modelGroup)return;const e=q(this.modelGroup);ye.uploadList=e}},s=e.addFolder("主功能");s.add(a,"importFile").name("上传文件(fbx、glb、gltf、ldr、mpd)"),s.add(a,"resetTree").name("模型树结构重置"),s.add(a,"exportGltf").name("导出 .gltf"),s.add(a,"exportGlb").name("导出 .glb"),s.add(a,"exportPoints").name("导出坐标"),s.add(a,"target").name("中心点"),s.add(a,"camera").name("相机坐标"),s.add(a,"clearScene").name("清空场景"),s.open()}addPointSphereOpts(){const e=this.gui,t=this.setPiece,a={scale:1,delete:()=>{this.deleteModel({uuid:ye.uuid})}},s=e.addFolder("取点球");s.add(t,"visible").name("可见"),s.add(a,"scale",.01,10).step(.01).name("大小").onChange((e=>{t.scale.setScalar(e)})),s.add(a,"delete").name("删除选中(或删除键)")}addMaterial(){const e=this.gui;if(!this.container)return;const t=e.addFolder("材质");t.add(this.guiOpts,"transformMaterial").name("转换标准材质"),t.add(this.guiOpts,"glisten").name("材质反光").onChange((()=>this.glistenToggle())),t.add(this.guiOpts,"groundReflection").name("地面反光").onChange((()=>this.groundGlisten())),t.add(this.guiOpts,"side").name("双面材质").onChange((()=>this.sideMaterialToggle())),t.add(this.guiOpts,"opacitySkin").name("材质透明").onChange((()=>this.opacitySkin())),t.add(this.guiOpts,"opacity",0,1).name("透明度").onChange((()=>this.opacitySkin()))}addLight(){const e=this.gui;if(!this.container)return;const t=e.addFolder("灯光"),a={intensity:1,color:16777215,castShadow:!1,distance:10,penumbra:1,decay:1};t.add(a,"intensity",1,20).name("聚光灯强度").onChange((()=>{this.spotLight(a)})),t.addColor(a,"color").name("聚光灯颜色").onChange((()=>{this.spotLight(a)})),t.add(a,"castShadow").name("聚光灯阴影").onChange((()=>{this.spotLight(a)})),t.add(a,"distance",.1,1e3).name("聚光灯光照距离").onChange((()=>{this.spotLight(a)})),t.add(a,"penumbra",0,1).name("聚光灯半影衰减").onChange((()=>{this.spotLight(a)})),t.add(a,"decay",0,1).name("聚光灯光照衰减").onChange((()=>{this.spotLight(a)}))}addNameGroupGui(){const e=this.gui,t={check:!1,checkName:"金属",metalness:.5,roughness:0,waterName:"水面",water:()=>{this.addWater(t.waterName)}},a=e.addFolder("名称包含处理");a.add(t,"waterName").name("水面网格名称"),a.add(t,"water").name("生成水面"),a.add(t,"check").name("金属材质").onChange((e=>{t.metalness=e?.5:0,t.roughness=e?0:.5,this.metalnessMaterialUpdate(t)})),a.add(t,"checkName").name("金属网格名称"),a.add(t,"metalness",0,1).name("金属权重").onChange((()=>{this.metalnessMaterialUpdate(t)})),a.add(t,"roughness",0,1).name("金属粗糙度").onChange((()=>{this.metalnessMaterialUpdate(t)}));const s={check:!1,checkName:"玻璃",roughness:0,envMapIntensity:1,transmission:1,ior:2.1};a.add(s,"check").name("玻璃材质").onChange((e=>{s.roughness=e?0:.5,s.envMapIntensity=e?1:0,s.transmission=e?1:0,s.ior=e?2.1:1.5,this.glassMaterialUpdate(s)})),a.add(s,"checkName").name("玻璃网格名称"),a.add(s,"roughness",0,1).name("玻璃光滑度").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"envMapIntensity",0,1).name("玻璃环境贴图影响权重").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"transmission",0,1).name("玻璃透射度(透光率)").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"ior",0,10).name("玻璃折射率").onChange((()=>{this.glassMaterialUpdate(s)}));const o={blurring:!1,blurringName:"线框",wireframe:!1,color:57599,opacity:.5,all:!1};a.add(o,"blurring").name("虚化材质").onChange((()=>{this.blurringMaterialUpdate(o)})),a.add(o,"blurringName").name("虚化网格名称"),a.add(o,"all").name("全部虚化").onChange((()=>{this.blurringMaterialUpdate(o)})),a.addColor(o,"color").name("虚化颜色").onChange((()=>{this.blurringMaterialUpdate(o)})),a.add(o,"opacity",0,1).name("虚化透明度").onChange((()=>{this.blurringMaterialUpdate(o)})),a.add(o,"wireframe",0,1).name("虚化线框").onChange((()=>{this.blurringMaterialUpdate(o)}))}addText(){const e=this.gui,t={size:12,color:16777215,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0},a={text:"Evan",create:()=>{this.createText(a.text,a.ttf,t)},ttf:"You_She"},s=e.addFolder("文本处理");s.add(a,"text").name("文本"),s.add(a,"ttf",["kenpixel","You_She","SiYuan","SHANGSHOUPOBINGTI-2","SourceHanSansCN-Bold"]).name("字体文件").onChange((()=>{this.createText(a.text,a.ttf,t)})),s.add(t,"size",8,200).name("字体大小"),s.addColor(t,"color").name("颜色"),s.add(t,"depth",0,20).name("深度"),s.add(t,"curveSegments",2,36).name("曲线分段"),s.add(t,"bevelThickness",.1,10).name("斜面厚度"),s.add(t,"bevelSize",.1,2).name("斜角大小"),s.add(t,"bevelEnabled").name("斜角"),s.add(a,"create").name("生成")}createText(e,t,a){this.text&&this.scene.remove(this.text);const s=this.options.baseUrl+`/fonts/${t}.ttf`;J(s).then((t=>{this.text=Q(t,e,a),this.addObject(this.text)}))}addResetGui(){const e={viewReset:()=>this.cameraViewReset(),rotation:0,grid:!0,scale:1,timeScale:1,changeAnimate:()=>{var e;null==(e=this.modelGroup)||e.children.forEach((e=>{var t;if(e.__action__){const a=e.__action_names__||[""],s=a.length;let o=a[0];for(let t in e.__action__){if(e.__action__[t].isRunning()){o=t;break}}let i=a.findIndex((e=>e===o));i++,i>s-1&&(i=0),o=a[i],o&&(null==(t=e.__mixer__)||t.stopAllAction(),re.success(`当前执行动画【${o}】，第${i+1}个，共${s}个动画`),e.__action__[o].play())}}))},stopAnimate:()=>{var e;null==(e=this.modelGroup)||e.children.forEach((e=>{var t;null==(t=e.__mixer__)||t.stopAllAction()}))},center:()=>this.modelCenter()},t=this.gui.addFolder("重置");t.add(e,"viewReset").name("视角重置"),t.add(e,"grid").name("网格显示").onChange((e=>{this.grid&&(this.grid.visible=e);const t=this.scene.getObjectByProperty("_isGridFork_",!0);t&&(t.visible=e)})),t.add(this.controls,"autoRotate").name("自动旋转"),t.add(this.guiOpts,"insetAnimate").name("入场动画"),t.add(e,"rotation",0,360).name("旋转").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{const a=Math.PI/180*e;t.rotation.set(0,a,0)}))})),t.add(e,"scale",.001,100).step(.01).name("缩放").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.scale.set(e,e,e)}))})),t.add(e,"timeScale",.1,10).name("动画速度").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.__action__&&Object.keys(t.__action__).forEach((a=>{t.__action__[a].timeScale=e}))}))})),t.add(e,"changeAnimate").name("切换动画"),t.add(e,"stopAnimate").name("停止动画"),t.add(e,"center").name("居中")}addEvnGui(){const e={bgCode:"",hdr:"",color1:16777215,color2:16777215},t=this.gui.addFolder("环境"),a=this.scene.getObjectByProperty("isAmbientLight",!0);a&&t.add(a,"intensity",0,10).name("环境光强度");const s=this.scene.getObjectsByProperty("isDirectionalLight",!0);if(s.length){const[a,o]=s,i=new se.DirectionalLightHelper(a,1,a.color);if(i.visible=!1,this.addObject(i),e.color1=a.color.getHex(),t.addColor(e,"color1").name("平行光颜色").onChange((e=>{a.color.set(e),i.traverse((t=>{t.color?t.color.set(e):t.isLine&&t.material.color.set(e)}))})),t.add(a,"intensity",0,10).name("平行光强度"),t.add(a.position,"y",500,1e5).name("平行光高度"),t.add(i,"visible").name("平行光辅助"),o){t.add(o,"visible").name("平行光2"),e.color2=o.color.getHex();const a=new se.DirectionalLightHelper(o,1,o.color);a.visible=!1,this.addObject(a),e.color1=o.color.getHex(),t.addColor(e,"color1").name("平行光颜色").onChange((e=>{o.color.set(e),a.traverse((t=>{t.color?t.color.set(e):t.isLine&&t.material.color.set(e)}))})),t.add(o,"intensity",0,10).name("平行光2强度"),t.add(o.position,"y",500,1e5).name("平行光高度2"),t.add(a,"visible").name("平行光2辅助")}}this.groundMesh&&(t.add(this.groundMesh,"visible").name("地面"),t.add(this.renderer.shadowMap,"enabled").name("开启阴影")),t.add(e,"bgCode",ae).name("背景").onChange((e=>{ge(this,e,"601"===e?"png":void 0)})),t.add(e,"hdr",["skidpan_2k"].concat(new Array(20).fill(0).map(((e,t)=>String(t+1))))).name("Hdr环境").onChange((e=>{this.loadEnvTexture(`/textures/hdr/${e}.hdr`)}))}async copyTextarea(e="复制成功！"){const t=this.container.parentNode.querySelector(".gui-text textarea");await G(),t.select(),document.execCommand("copy"),re.success(e)}uploadedModel(e,t){if(!e)return;if(e.__upload_model__=!0,this.modelGroup){const e=this.modelGroup.children.find((e=>e.name===t));this.disposeObj(e),this.modelGroup.remove(e)}const a=this.guiOpts.scale,s=new se.Group;e.traverse((e=>{(e.isSpotLight||e.isPointLight)&&e.isSpotLight&&s.add(e.target),le(s,this.guiOpts,e)})),s.children.length&&this.addHelper(s),e.isMesh||(e.name=t);let o=oe.modelDeepClone(e);oe.findObjectsByHasProperty(o.children,["true"],"isSkinnedMesh").length&&(o=e),console.log(o);const i=o.position;ye.dotText=`模型初始坐标: {\n      "x": ${i.x},\n      "y": ${i.y},\n      "z": ${i.z}\n    }`;const n=o.scale;if(o.scale.set(a*n.x,a*n.y,a*n.z),o.animations=e.animations,this.addModel(o),this.guiOpts.insetAnimate&&this.cameraViewReset(),e.animations.length){let t=new se.AnimationMixer(o);const a=[],s=e.animations.reduce(((e,s)=>{const o=s.name||"";return a.push(o),e[o]=t.clipAction(s),e[o].timeScale=1,e}),{});s[a[0]].play(),o.__action_names__=a,o.__action__=s,o.__mixer__=t}console.log(this),D()}cameraViewReset(){var e;oe.cameraInSceneAnimate(this.camera,{x:0,y:100,z:300},null==(e=this.controls)?void 0:e.target)}judgeUploadModel(){var e;return 0!=((null==(e=this.modelGroup)?void 0:e.children)||[]).length||(re.warning("未上传模型！"),!1)}export(e){var t;const a=(null==(t=this.modelGroup)?void 0:t.children)||[];if(!this.judgeUploadModel())return;const s=1==a.length,o=s?a[0]:this.modelGroup,i=he(o);ce(o,i,s?o.name:"综合场景",e)}glistenToggle(){var e;let t=this.guiOpts.glisten?0:.9;console.log(t),null==(e=this.modelGroup)||e.traverse((e=>{e.isMesh&&(e.material instanceof Array?e.material.forEach((e=>{e.roughness=t})):e.material.roughness=t)}))}groundGlisten(){var e;let t=this.guiOpts.groundReflection?0:.9;null==(e=this.modelGroup)||e.traverse((e=>{e.isMesh&&te.receiveShadowName.find((t=>e.name.indexOf(t)>-1))&&(e.material instanceof Array?e.material.forEach((e=>{e.roughness=t})):e.material.roughness=t)}))}sideMaterialToggle(){const e=this.guiOpts.side?se.DoubleSide:se.FrontSide;this.modelGroup&&this.modelGroup.traverse((t=>{t.isMesh&&(t.material instanceof Array?t.material.forEach((t=>{t.side=e})):t.material.side=e)}))}opacitySkin(){var e;const{opacitySkin:t,opacity:a}=this.guiOpts;null==(e=this.modelGroup)||e.traverse((e=>{te.transparentName.find((t=>e.name.indexOf(t)>-1))&&de(e,t?a:1)}))}spotLight(e){var t,a;null==(t=this.modelGroup)||t.traverse((t=>{t.isSpotLight&&(t.intensity=e.intensity,t.castShadow=e.castShadow,t.distance=e.distance,t.penumbra=e.penumbra,t.decay=e.decay,t.color.set(e.color))})),null==(a=this.helperGroup)||a.traverse((t=>{"SpotLightHelper"===t.type&&t.children[0].material.color.set(e.color)}))}modelCenter(){var e,t;null==(e=this.helperGroup)||e.children.forEach((e=>{var t;"BoxHelper"===e.type&&(this.disposeObj(e),null==(t=this.helperGroup)||t.remove(e))}));const a=[];null==(t=this.modelGroup)||t.children.forEach((e=>{const{helper:t,center:s}=pe(e,16711680);this.addHelper(t),s.name=e.name;const{x:o,y:i,z:n}=e.position;e.position.set(o-s.x,i,n-s.z);const r=new se.Group;let l=e.clone();r.add(l),r.animations=l.animations,a.push(e),this.addModel(l)})),a.forEach((e=>{var t;this.disposeObj(e),null==(t=this.modelGroup)||t.remove(e)})),console.log(this)}addModelGroup(){const e=new se.Group;e.name="模型组",this.addObject(e),this.modelGroup=e;const t=new se.Group;t.name="辅助组",this.helperGroup=t,this.addObject(t)}clearModelGroup(){var e;this.text&&this.scene.remove(this.text),this.water&&this.scene.remove(this.water),this.modelGroup?(this.disposeObj(this.modelGroup),this.disposeObj(this.helperGroup),this.addModelGroup(),null==(e=this.transformControls)||e.detach(),ye.uploadList=[],ye.uuid=""):this.addModelGroup()}addModel(e){if(this.modelGroup){this.modelGroup.add(e);const t=q(this.modelGroup);ye.uploadList=t,"function"==typeof this.extend.addGroupCall&&this.extend.addGroupCall(t)}}selectModel(e){var t,a;const s=null==(t=this.modelGroup)?void 0:t.getObjectByProperty("uuid",e.uuid);if(s){null==(a=this.helperGroup)||a.children.forEach((e=>{var t;"BoxHelper"===e.type&&(this.disposeObj(e),null==(t=this.helperGroup)||t.remove(e))})),this.setControlObject(s),ye.uuid=e.uuid;var o=new se.BoxHelper(s,15732480);o.update(),this.addHelper(o)}}deleteModel(e){var t,a,s,o;const i=null==(t=this.modelGroup)?void 0:t.getObjectByProperty("uuid",e.uuid);if(!i)return re.error("对象不存在，请重置树结构！");i==(null==(a=this.transformControls)?void 0:a.object)&&(null==(s=this.transformControls)||s.detach()),null==(o=i.parent)||o.remove(i),i.clear(),re.success("删除成功！")}addHelper(e){this.helperGroup&&this.helperGroup.add(e)}addWater(e){const t=this.scene.getObjectByName(e);if(!t)return void re.error("未找到网格！");const a=Z(t);a.position.copy(t.getWorldPosition(new se.Vector3));const s=t.matrixWorld,o=new se.Vector3,i=new se.Quaternion,n=new se.Vector3;s.decompose(o,i,n);const r=(new se.Euler).setFromQuaternion(i);a.rotation.copy(r),a.scale.copy(t.getWorldScale(new se.Vector3)),t.position.y-=.2,this.water&&this.scene.remove(this.water),console.log(this,t),this.water=a,this.addObject(this.water)}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const a=e.timeStamp-this.pointer.tsp<200;if(a){const a=this.container,s=this.options.scale,o=a.getBoundingClientRect()||{left:0,top:0},i=new se.Vector2((e.clientX-o.left)/(a.clientWidth*s)*2-1,-(e.clientY-o.top)/(a.clientHeight*s)*2+1);0==ve.distanceTo(i)&&(null==(t=this.transformControls)||t.detach())}2==e.button||(0==e.button?a&&this.checkIntersectObjects(e):e.button)}checkIntersectObjects(e){var t;const a=this.container,s=this.options.scale;_e(e,a,s);let o="pointerdown"==e.type||"pointerup"==e.type;const i=this.setPiece.visible,n=o?(null==(t=this.modelGroup)?void 0:t.children)||[]:i?[this.setPiece]:[];be.setFromCamera(ve,this.camera);let r=be.intersectObjects(n,o);if(r.length>0){const e=r[0];let t=e.object;if(o)if(console.log(e),this.setPiece.position.copy(e.point),i){const e=[this.setPiece].map((e=>{let t=e.position;return`{ "x": ${1*t.x.toFixed(2)}, "y": ${1*t.y.toFixed(2)}, "z": ${1*t.z.toFixed(2)} }`}));ye.dotText=e.join(","),this.copyTextarea("中心点复制成功！")}else this.selectModel({uuid:t.uuid}),ye.uuid=t.uuid,this.setControlObject(t);else this.setControlObject(t)}}setControlObject(e){var t,a;e!==(null==(t=this.transformControls)?void 0:t.object)&&(this.setPiece.visible||re.success(`当前选中对象名称[${e.name}]`),null==(a=this.transformControls)||a.attach(e))}modelAnimate(){if(!this.modelGroup)return;let e=this.clock.getDelta();for(let t=0;t<this.modelGroup.children.length;t++){const a=this.modelGroup.children[t];a.__mixer__&&a.__mixer__.update(e)}this.water&&(this.water.material.uniforms.time.value+=1/60)}}const fe=H(M({__name:"index",setup(e){const t=y({bgColor:"",skyCode:"221",env:"/textures/exr/piz_compressed.exr"}),{uploadModel:n}=U.useUpload({baseUrl:W}),r=C(),l={baseUrl:W,env:t.env,grid:{visible:!0,fork:!0},camera:{position:[-50,50,100]},axes:{visible:!0}};let d;const c=y({droping:!1}),h=e=>{e.preventDefault(),e.stopPropagation()},u=e=>{h(e),c.droping=!0},m=e=>{h(e),c.droping=!0},p=e=>{h(e),c.droping=!1},g=e=>{h(e),c.droping=!1;const t=e.dataTransfer.files;console.log(t);for(let a=0;a<t.length;a++)v(t[a])},b=e=>{null==d||d.selectModel(e)},v=e=>{let t=e.name;(e=>{const t=e.split(".").pop().toLowerCase();return!!_.accept.includes(t)||(i.error({message:`${e} 文件格式不正确,转换格式支持 ${_.accept.join("、")}！`,grouping:!0}),!1)})(t)&&(t=e.name.substring(0,e.name.lastIndexOf(".")),_.fileName=t,n([e],(a=>{console.log(e.name,a),d.uploadedModel(a,t)}),(({progress:e,size:t,filename:a})=>{console.log("Loading",a,t,e)})))},_=y({accept:["fbx","glb","gltf","ldr","mpd"],fileName:""}),x=e=>{const t=e.target.files[0];v(t),e.target.value=""};return k((()=>{l.container=r.value,d=new xe(l,{addGroupCall:e=>{console.log(e)}}),d.run(),console.log(d),R(d).resize()})),(e,t)=>{const i=A,n=L,l=N;return a(),s("div",{class:o(["three-page",e.$style.page]),onDragenter:u,onDragover:m,onDragleave:p,onDrop:g},[S("div",{class:o(e.$style["model-operate"])},[S("div",{class:o(e.$style.item)},[S("div",{class:o(e.$style.label)},"当前坐标",2),S("div",{class:o(e.$style.value)},[O(i,{class:"gui-text",type:"textarea",modelValue:j(ye).dotText,"onUpdate:modelValue":t[0]||(t[0]=e=>j(ye).dotText=e)},null,8,["modelValue"])],2)],2),S("div",{class:o(e.$style.tree)},[O(l,{data:j(ye).uploadList,"expand-on-click-node":!1,onNodeClick:b},{default:E((({node:t,data:a})=>[S("div",{class:o(e.$style["tree-node"])},[S("span",{class:o(e.$style.label)},T(t.label),3),O(n,{class:o(e.$style.btn),type:"danger",icon:j(z),onClick:e=>{return t=a,void(null==d||d.deleteModel(t));var t}},null,8,["class","icon","onClick"])],2)])),_:1},8,["data"])],2)],2),S("input",{class:o(e.$style.upload),type:"file",onChange:x},null,34),S("div",{class:o(e.$style.tip)}," 控制器键盘操作 W：位移；E：旋转；R：缩放；+、-：控制器大小；X：x 轴切换；Y：y 轴切换；Z：z 轴切换；空格：控制器锁定； ",2),j(c).droping?(a(),$(V,{key:0})):P("",!0),S("div",{class:"h-100",ref_key:"containerRef",ref:r},null,512)],34)}}}),[["__cssModules",{$style:{"model-operate":"_model-operate_3whmt_2",item:"_item_3whmt_12",tree:"_tree_3whmt_16","tree-node":"_tree-node_3whmt_19",label:"_label_3whmt_28",btn:"_btn_3whmt_34",tip:"_tip_3whmt_38",upload:"_upload_3whmt_47"}}]]);export{fe as default};
