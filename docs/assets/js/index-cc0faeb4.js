import{bO as e,e as t,i as o,w as n,l as s,aP as a,o as i,g as l,u as r,h as c,B as d,n as u,a9 as p,s as f,t as h,a5 as m,c9 as g,ca as y,aa as v,cg as b,Y as _,c as C,q as O,p as x,I as k,R as D,aK as M}from"./vendor-7f6cb255.js";import{T as E,d as w,u as j}from"./scene-resize-a9ec2e62.js";import{u as T,D as L,a as S}from"./background-abedecce.js";import{u as N,a as z,c as R,g as F,s as G,b as U,d as B,e as P,f as $}from"./model-loader-59ce6813.js";import{u as A}from"./dialog-bb6e0574.js";import{_ as I,e as V,A as K}from"./index-cf96eee7.js";const{raycaster:J,pointer:H,update:Q}=T(),{initCSS2DRender:W,createCSS2DDom:X}=N();class q extends E{constructor(e,t){super(e),this.extend=t,this.css2DRender=W(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.bindEvent(),this.addDeviceGroup(),this.addDotGroup()}addDeviceGroup(){const t=new e;t.name="设备组",this.deviceGroup=t,this.addObject(t)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const t=new e;t.name="点位组",this.dotGroup=t,this.scene.add(t)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const o=e.position,{size:n,color:s}=e.font||{},{x:a=0,y:i=0,z:l=0}=o||{},r=X({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,i,l],onClick:t});return r.name=e.name,r.data=e,r._position_={x:a,y:i,z:l},this.dotGroup.add(r),r}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall()}onDblclick(e){var t;const o=this.container,n=this.options.scale;if(Q(e,o,n),this.deviceGroup){J.setFromCamera(H,this.camera);const e=[this.deviceGroup],o=J.intersectObjects(e);if(o.length){const e=o[0].object,n=this.findParentGroupGroup(e);if(!n)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(n)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<L.rightClickBackDiffTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o;const n=this.container,s=this.options.scale;Q(e,n,s);let a="pointerdown"==e.type||"pointerup"==e.type;const i=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));J.setFromCamera(H,this.camera);let l=J.intersectObjects(i,a);if(n.style.cursor=l.length>0?"pointer":"auto",a)if(l.length){const e=l[0].object;if(!e)return;"function"==typeof(null==(t=this.extend)?void 0:t.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&o._isDevice_?o:t(o)};return t(e)}getFloor(){return this.deviceGroup.children.filter((e=>e._isFloor_))}hideOmitFloor(e){this.deviceGroup.children.forEach((t=>{t.visible=t._isFloor_||e}))}getAll(){return this.deviceGroup.children.concat(this.dotGroup.children)}getFlowMark(e){return this.getAll().filter((t=>{var o;return(null==(o=t.data)?void 0:o.followMark)===e}))}getAnimTargetPos(e,t,o){const n=t||e.to||{x:-104,y:7,z:58},s=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),n}getPosition(){}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}}const Y={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},Z={key:0,class:"scene-operation"},ee=I(t({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoPath:{},basisPath:{},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},directionalLight:{default:()=>({})},models:{},config:{},objects:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{},animationModelType:{},floorModelType:{},textModelType:{},anchorType:{default:()=>[]},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(t,{expose:_,emit:C}){const O=t,x=w(Y,O.colors),{change:k,load:D}=S(),{progress:M,loadModel:E,loadModels:j,getModel:T}=z({baseUrl:O.baseUrl,dracoPath:O.dracoPath,basisPath:O.basisPath,colors:x,colorMeshName:O.colorMeshName,indexDB:O.indexDB}),{dialog:N}=A(),I=C,V=o(),K=O.devEnv,J={baseUrl:O.baseUrl,bgUrl:O.bgUrl,env:O.env,bgColor:O.bgColor,camera:O.camera,cruise:O.cruise,fog:O.fog,render:O.render,grid:O.grid,controls:O.controls,axes:O.axes,directionalLight:O.directionalLight};let H;n((()=>O.dotShowStrict),(()=>Q())),n((()=>O.scale),(e=>{null==H||H.setScale(e||1)})),n((()=>O.cruise.points),(e=>{M.isEnd&&H.setCruisePoint(e)})),n((()=>O.objects),(()=>{M.isEnd&&ae()}));const Q=()=>{const e=H.dotGroup.children;for(let t=0;t<e.length;t++){const o=e[t];if(!o.data)continue;o.data.type===O.dotKey&&te(o)}},W=e=>{var t,o,n,s;const a=H.getFloor();if(0===a.length)return;const i=void 0!==e&&e>-1;if((null==(t=O.config)?void 0:t.floorExpandHiddenOther)&&H.hideOmitFloor(!i),a.forEach(((t,o)=>{var n,s,a;const l=t._position_;let r=o-(i?e:o);const c=(null==(n=O.config)?void 0:n.floorExpandMargin)||200,d=(null==(s=O.config)?void 0:s.floorExpandMode)||"UD",u=r*c,p=((null==l?void 0:l.y)??0)+u,f=e==o?((null==l?void 0:l.z)??0)+c:(null==l?void 0:l.z)??0;if("UD"===d){if(t.position.y===p)return}else if("BA"===d&&t.position.z===f)return;if(null==(a=t.data)?void 0:a.mark){const n=t.data.mark,s=H.getFlowMark(n);ee(d,s,u,e==o?c:0)}new g(t.position).to({y:"UD"===d?p:t.position.y,z:"BA"===d?f:t.position.z},500).easing(y.Quadratic.Out).start()})),!(null==(o=O.config)?void 0:o.floorExpandChangeViewAngle))return;let l,r;if(i){const t=a[e]||{};l=null==(n=t.data)?void 0:n.to,l&&(r=(null==(s=t.data)?void 0:s.target)||t._position_)}l=H.getAnimTargetPos(O.config||{},l,r),X(l)||R(H.camera,l,H.controls.target)},X=e=>{const t=H.camera.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1},ee=(e,t,o,n)=>{0!==t.length&&t.forEach((t=>{const s=t._position_,a="UD"==e?((null==s?void 0:s.y)??0)+o:(null==s?void 0:s.y)??0,i="BA"==e?((null==s?void 0:s.z)??0)+n:(null==s?void 0:s.z)??0;new g(t.position).to({y:a,z:i},500).easing(y.Quadratic.Out).start()}))},te=e=>{var t;const o=e.data;if("function"==typeof O.dotUpdateObjectCall){const e=O.dotUpdateObjectCall(o,H.deviceGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!O.dotShowStrict;const n=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(n){const{size:e,color:t}=o.font||{};null!=e&&(n.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(n.style.color=t),n.textContent=`${o.value||0}${o.unit}`}},oe=e=>{const t=V.value,o=F(t,e,H.camera);return N.position=o,N.style.left=o.left+"px",N.style.top=o.top+"px",o},ne=async t=>{var o;if(!t)return;const{type:n,url:s}=t,i=T(n);if(!i)return void(s?await(async e=>{const{type:t,url:o="",name:n}=e,s=await E({key:t,url:o,name:n,size:0}),{position:a,scale:i,rotation:l}=P(s,e);return s.scale.set(...i),s.position.set(...a),s.rotation.set(...l),s._isBase_=!0,H.addDevice(s),Promise.resolve(s)})(t):n===O.dotKey&&(e=>{te(H.addDot(e,(t=>{I("click-dot",a(e),t)})))})(t));const l=O.floorModelType||[],r=O.anchorType||[];let c=B(i);const{position:d,scale:u,rotation:p}=P(c,t),[f,h,m]=d;c.scale.set(...u),c.position.set(f,h,m),c.rotation.set(...p);const g=O.animationModelType||[],y=O.colorMeshName||[];if(g.includes(n)){if("Group"!==c.type){const t=new e;t.add(c),t.name=c.name,c=t}if(O.mainBodyChangeColor){const e=((null==(o=c.children[0])?void 0:o.children)||[]).filter((e=>(O.mainBodyMeshName||[]).some((t=>e.name.indexOf(t)>-1)))),t=x.normal;let n=t.main||t.color,s=U(n);s.length&&e.forEach(((e,t)=>{G(e,s[t%s.length])})),c[L.meshKey.body]=e}const t=$(c.children,y);let n,s=new b(c);i.animations.length&&(n=s.clipAction(i.animations[0]),n.paused=!0,n.timeScale=1.5,n.play()),c.extra={action:n,mixer:s,meshs:t}}else{const e=[];c.traverse((t=>{"string"==typeof t.name&&y.some((e=>t.name.indexOf(e)>-1))&&e.push(t)})),e.length&&(c[L.meshKey.color]=e)}return c._isDevice_=!0,c.data=t,l.includes(n)&&(c._position_={x:f,y:h,z:m},c._isFloor_=!0),r.includes(n)&&(c._isAnchor_=!0),H.addDevice(c),Promise.resolve()},se=o([]),ae=async()=>{var e,t,o,n;M.percentage=100,M.show=!1,H.clearDevice(),await v(),(()=>{se.value.length=0;const e=a(O.objects)||[];if("function"!=typeof O.formatObject)se.value=e;else{const t=O.formatObject(e);se.value=t}})(),await(()=>{let e=0,t=se.value.length;return new Promise((o=>{if(0==t)return o(null);const n=async()=>{const s=se.value[e];await ne(s),e++,e<t?n():o(e)};n()}))})(),H.setCruisePoint(O.cruise.points),"function"==typeof(null==(e=O.config)?void 0:e.load)&&(null==(t=O.config)||t.load(H));const s=(null==(o=O.config)?void 0:o.floorExpandIndex)||-1,i=H.getAnimTargetPos(O.config||{}),l=H.getFloor();s>-1&&l.length?(W(s),(null==(n=O.config)?void 0:n.floorExpandChangeViewAngle)||R(H.camera,i,H.controls.target).then((()=>{I("loaded"),H.controlSave()}))):R(H.camera,i,H.controls.target).then((()=>{I("loaded"),H.controlSave()}))},ie=()=>{j(O.models,(()=>{ae()})),O.skyCode&&D(H,O.skyCode)},le=e=>{const t=[];O.updateObjectCall,H.getAll().forEach(((o,n)=>{if(!o.data)return;const s=o.data;let i=s.type;if(i===O.dotKey)return void te(o);if("function"==typeof O.updateObjectCall){const t=O.updateObjectCall(s,e);if(!t)return;Object.keys(t).forEach((e=>{s[e]=t[e]}))}t.push(a(s));let{status:l=0,error:r=0,remote:c=0,local:d=0,disabled:u=0}=s;const p=x[r>0?"error":l>0?"runing":"normal"];let f=null!=p[i]?p[i]:p.color;if("function"==typeof O.getColorCall){const e=O.getColorCall(s);e&&(f=e)}re({type:i,el:o,colorObj:p,color:f,paused:0==l,error:r>0,remote:c>0,local:d>0,disabled:u>0})})),I("update",t,e)},re=e=>{let{el:t,type:o,colorObj:n,color:s,paused:a}=e,i=U(s);s=i[0];const l=L.meshKey;if((O.colorModelType||[]).includes(o)&&null!=s){return void(t[l.color]||[]).forEach((e=>{G(e,s)}))}const r=t.extra;if(r&&(r.action&&(r.action.paused=a),null!=s)){(r.meshs||[]).forEach((e=>{G(e,s)}))}if(O.mainBodyChangeColor&&t[l.body]){const e=null!=n.main?n.main:n.color;let o=U(e);o.length&&t[l.body].forEach(((e,t)=>{G(e,o[t%o.length])}))}};return s((()=>{J.container=V.value,H=new q(J,{onDblclick:e=>{const t=e.data,o=H.getFloor().findIndex((t=>e.uuid===t.uuid));"function"==typeof t.onDblclick?t.onDblclick(a(t),e,o):I("dblclick",a(t)),o>-1&&W(o)},onClickLeft(e){if(e){const t=e.data,o=a(t);I("select",o),"function"==typeof t.onClick?(N.show=!1,t.onClick(o)):(N.select=[e],(()=>{const e=N.select[0],t=e.data;N.data=t,N.title=(null==t?void 0:t.name)||"",N.show=!0;const o=oe(e);I("click-dialog-dot",t,o)})())}else N.select=[],N.show=!1},onClickRight:e=>{var t;N.show=!1,"function"==typeof(null==(t=O.config)?void 0:t.back)?O.config.back(H):W(-1)},animateCall:()=>{if(N.show&&N.select.length){const e=N.select[0];oe(e)}}}),H.run(),I("init",H),ie()})),_({floorAnimate:W,exportImage:()=>null==H?void 0:H.exportImage(),update:le}),(e,t)=>(i(),l("div",{class:u(e.$style["floor-scene"])},[r(K)?(i(),l("div",Z,[c("div",{class:"btn",onClick:t[0]||(t[0]=()=>le(!0))},"随机更新"),e.cruise.visible?(i(),l("div",{key:0,class:"btn",onClick:t[1]||(t[1]=()=>{var e;return null==(e=r(H))?void 0:e.toggleCruise()})},"定点巡航")):d("",!0),c("div",{class:"btn",onClick:t[2]||(t[2]=()=>{var e;return null==(e=r(H))?void 0:e.getPosition()})},"场景坐标"),c("div",{class:"btn",onClick:t[3]||(t[3]=()=>r(k)(r(H)))},"切换背景"),c("div",{class:"btn",onClick:t[4]||(t[4]=()=>{var e;return null==(e=r(H))?void 0:e.controlReset()})},"控制器重置"),e.cruise.visible?(i(),l("div",{key:1,class:"btn",onClick:t[5]||(t[5]=()=>{var e;return null==(e=r(H))?void 0:e.toggleCruiseDepthTest()})},"巡航深度")):d("",!0)])):d("",!0),c("div",{class:u(e.$style.container),ref_key:"containerRef",ref:V},null,2),r(M).show?(i(),l("div",{key:1,class:u(["loading",e.$style.loading]),style:p({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[6]||(t[6]=f((()=>{}),["stop"]))},[c("div",{class:u(e.$style.progress),style:p({"--percentage":r(M).percentage+"%"})},[c("div",{class:u(e.$style["bar-out"])},[c("div",{class:u(e.$style.bar)},null,2)],2),c("div",{class:u(e.$style.text)},h(r(M).percentage)+"%",3)],6)],38)):d("",!0),r(N).show?(i(),l("div",{key:2,class:u(e.$style.dialog),style:p(r(N).style)},[m(e.$slots,"dialog",{data:r(N).data,title:r(N).title,position:r(N).position})],6)):d("",!0)],2))}}),[["__cssModules",{$style:{"floor-scene":"_floor-scene_1fset_2",container:"_container_1fset_8",loading:"_loading_1fset_12",progress:"_progress_1fset_27","bar-out":"_bar-out_1fset_31",bar:"_bar_1fset_31","striped-flow":"_striped-flow_1fset_1",text:"_text_1fset_55",dialog:"_dialog_1fset_63"}}]]),te={class:"flex flex-ac"},oe=I(t({__name:"index",setup(e){const t=_({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",render:{alpha:!0,preserveDrawingBuffer:!0},env:"/oss/textures/hdr/3.hdr",camera:{far:1e6},colors:{normal:{main:65280},runing:{main:16715760,text:0}},cruise:{visible:!0,points:[[450,490,450],[450,490,-450],[-450,490,-450],[-450,490,450]],offset:10},controls:{screenSpacePanning:!1,maxDistance:5e3,maxPolarAngle:.46*Math.PI},directionalLight:{helper:!1},grid:{visible:!0},models:[{key:"FLOOR_ONE",name:"大堂",size:8.5,url:"/1楼.glb"},{key:"FLOOR_COMMON",name:"楼层",size:13.7,url:"/楼层.glb"},{key:"FLOOR_ATTIC",name:"楼顶",size:.1,url:"/楼顶.glb"},{key:"COLD_CAMERA",name:"摄像头",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/sxt.png"},{key:"COLD_ROOM_INLET",name:"房间入口",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/fjdw.png"},{key:"COLD_GPS",name:"定位",type:"sprite",size:1,range:{x:51,y:56},mapUrl:"/dw.png"}].map((e=>(e.url&&(e.url="/oss/model/floor"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/floor"+e.mapUrl),e))),objects:[],config:{},indexDB:{cache:!0,dbName:"THREE__FLOOR__DB",tbName:"TB",version:1},dotShowStrict:!1,colorMeshName:[],floorModelType:["FLOOR_COMMON","FLOOR_ONE","FLOOR_TWO_FIVE","FLOOR_SIX","FLOOR_SEVEN_ELEVEN","FLOOR_TWELVE_THIRTEEN","FLOOR_FOURTEEN_SIXTEEN","FLOOR_SEVENTEEN_EIGHTEEN"],anchorType:["COLD_CAMERA","COLD_ROOM_INLET","COLD_GPS"],mainBodyChangeColor:!0,mainBodyMeshName:["立方体062"],animationModelType:["FLOOR_COMMON"]}),n=o(),a=(e,t)=>{const o=40*Math.random();return void 0!==o&&(e.value=o),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:e.value>35?"#f00":null}}},d=(e,t)=>{const o=Math.random()>.5?1:0,n=Math.random()>.5?1:0,s=Math.random()>.8?1:0,a=Math.floor(3*Math.random());return{status:s>0?0:o,error:s>0?0:n,remote:1==a?1:0,local:2==a?1:0,disabled:s}},p=e=>{j(e).resize()},f=(e,t)=>{},m=()=>{const e=[[450,1,450],[450,1,-450],[-450,1,-450],[-450,1,450]].map((e=>e.map((e=>e*(.5-.5*Math.random()+1)))));t.cruise&&(t.cruise.points=e)},g=()=>{var e;return null==(e=n.value)?void 0:e.exportImage()};return s((()=>{V.get(K.d3.floor).then((e=>{let o=e.JsonList;const n=e.ModelUrl;o.unshift({name:e.Name,type:"",url:n?`${t.baseUrl}${n}`:""});let s={};if(e.ConfigJson instanceof Object)s=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{s=JSON.parse(e.ConfigJson)}catch(a){}Object.keys(s).forEach((e=>{t.config&&(t.config[e]=s[e])})),t.objects=o.map((e=>("COLD_ROOM_INLET"===e.type&&(e.onClick=e=>{C.success({message:e.name,grouping:!0})}),e)))}))})),(e,o)=>{const s=D,y=M;return i(),l("div",{class:u([e.$style.page,"h-100 o-h"])},[c("div",{class:u(e.$style.operate)},[c("div",te,[o[1]||(o[1]=c("span",null,"点位：",-1)),O(s,{modelValue:r(t).dotShowStrict,"onUpdate:modelValue":o[0]||(o[0]=e=>r(t).dotShowStrict=e),"active-text":"严格","inactive-text":"全显","inline-prompt":""},null,8,["modelValue"])]),O(y,{type:"success",onClick:m},{default:x((()=>o[2]||(o[2]=[k("切换巡航点位")]))),_:1}),O(y,{type:"primary",size:"small",onClick:g},{default:x((()=>o[3]||(o[3]=[k("导出")]))),_:1})],2),O(ee,{ref_key:"threeSceneRef",ref:n,"dev-env":r(t).devEnv,"base-url":r(t).baseUrl,"bg-color":r(t).bgColor,"bg-url":r(t).bgUrl,env:r(t).env,indexDB:r(t).indexDB,"sky-code":r(t).skyCode,camera:r(t).camera,colors:r(t).colors,cruise:r(t).cruise,render:r(t).render,controls:r(t).controls,grid:r(t).grid,"directional-light":r(t).directionalLight,config:r(t).config,models:r(t).models,"anchor-type":r(t).anchorType,"dot-show-strict":r(t).dotShowStrict,"floor-model-type":r(t).floorModelType,"main-body-change-color":r(t).mainBodyChangeColor,"main-body-mesh-name":r(t).mainBodyMeshName,"animation-model-type":r(t).animationModelType,objects:r(t).objects,"dot-update-object-call":a,"update-object-call":d,onInit:p,onClickDot:f},{dialog:x((({data:t,title:o})=>[c("div",{class:u(e.$style["dialog-wrap"])},[c("div",{class:u(e.$style.circle)},null,2),c("div",{class:u(e.$style.line)},null,2),c("div",{class:u(e.$style.content)},[c("div",{class:u(e.$style.title)},h(o),3),c("div",{class:u(e.$style.data)},h(t),3)],2)],2)])),_:1},8,["dev-env","base-url","bg-color","bg-url","env","indexDB","sky-code","camera","colors","cruise","render","controls","grid","directional-light","config","models","anchor-type","dot-show-strict","floor-model-type","main-body-change-color","main-body-mesh-name","animation-model-type","objects"])],2)}}}),[["__cssModules",{$style:{page:"_page_fyyv5_2",operate:"_operate_fyyv5_8","dialog-wrap":"_dialog-wrap_fyyv5_20",circle:"_circle_fyyv5_26",line:"_line_fyyv5_56",content:"_content_fyyv5_82",title:"_title_fyyv5_89",data:"_data_fyyv5_93"}}]]);export{oe as default};
