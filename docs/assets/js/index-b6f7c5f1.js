var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);import{bx as s,by as i,fv as r,dQ as a,eG as o,f7 as n,bE as d,f0 as u,ed as l,fw as c,fx as h,fy as m,bC as p,bA as x,dk as f,f6 as b,dd as g,fz as N,e$ as w,f1 as y,c as v,h as T,k as M,o as k,f as P,g as C}from"./vendor-d7caeb87.js";import{S as Y,i as j,u as D}from"./scene-resize-c2a7eabc.js";import{u as L}from"./sky-8d6b28da.js";import"./index-12944fbd.js";const E=y,{color:G,vec2:W,pass:z,linearDepth:A,normalWorld:_,objectPosition:B,screenUV:O,viewportLinearDepth:R,viewportDepthTexture:S,viewportSharedTexture:F,mx_worley_noise_float:U,positionWorld:V,time:$}=E,q=j,H="https://ye6.atomgit.net/3d-demo-data",{skys:I}=L(),{getBgGroup:Q}=q.useBackground(H+"/sky/",I),J=(new s).load(`${H}/textures/gpu/water.jpg`);J.wrapS=i,J.wrapT=i,J.colorSpace=r;const K={mix:0,procedural:0,intensity:1,hue:0,saturation:1},X={offsetCube1:0,offsetCube2:0};class Z extends Y{constructor(e){super(e),t(this,"water"),t(this,"blurNode"),t(this,"mixNode"),t(this,"proceduralNode"),t(this,"intensityNode"),t(this,"hueNode"),t(this,"saturationNode"),t(this,"rotateY1Matrix"),t(this,"rotateY2Matrix"),t(this,"cube1Texture"),t(this,"cube2Texture"),t(this,"postProcessing"),t(this,"gui"),t(this,"floor"),t(this,"getEnvironmentNode",((e,t)=>{const{rotateY1Matrix:s,rotateY2Matrix:i,mixNode:r,proceduralNode:a,intensityNode:o,hueNode:n,saturationNode:d}=this,u=e.xyz.mul(E.uniform(s)),l=e.xyz.mul(E.uniform(i)),c=this.convertPmremTexture(this.cube1Texture),h=this.convertPmremTexture(this.cube2Texture),m=E.mix(E.pmremTexture(c,u),E.pmremTexture(h,l),t.y.add(r).clamp()),p=E.mix(m,E.normalWorld,a).mul(o),x=E.hue(p,n);return E.saturation(x,d)})),this.postProcessing=null,this.blurNode=E.uniform(0),this.mixNode=E.reference("mix","float",K),this.proceduralNode=E.reference("procedural","float",K),this.intensityNode=E.reference("intensity","float",K),this.hueNode=E.reference("hue","float",K),this.saturationNode=E.reference("saturation","float",K),this.rotateY1Matrix=new a,this.rotateY2Matrix=new a;const s=new o(3355494,7654644,5),i=new o(7654644,0,1);this.pmremGenerator=new n(this.renderer),this.pmremGenerator.compileEquirectangularShader(),this.addObject(i),this.addObject(s),this.addModel(),this.addWater(),this.addProcessing(),this.gui=new d,this.addGui()}createRender(){return new u}createDirectionalLight(e,t){return new l(e,t)}async addModel(){let e=await(new c).setMaxRange(16).loadCubemap(Q("601","png"));e=await(new h).loadAsync(Q("104")),e.generateMipmaps=!0,e.minFilter=m,this.cube1Texture=e;const t=await(new h).loadAsync(Q("101"));t.generateMipmaps=!0,t.minFilter=m,this.cube2Texture=t,this.scene.environmentNode=this.getEnvironmentNode(E.reflectVector,E.positionWorld),this.scene.backgroundNode=this.getEnvironmentNode(E.positionWorldDirection,E.positionLocal).context({getTextureLevel:()=>this.blurNode});const s=new p(new x(.5,64,32),new f({metalness:1,roughness:0}));this.addObject(s)}addWater(){this.scene.backgroundNode=_.y.mix(G(296930),G(26367));const e=$.mul(.8),t=V.xzy,s=U(t.mul(4).add(e)),i=U(t.mul(2).add(e)),r=s.mul(i),a=r.mul(1.4).mix(G(296930),G(7654644)),o=A(),n=R.sub(o).remapClamp(-.002,.04),d=O.add(W(0,r.mul(.1))),u=A(S(d)).sub(o),l=u.remapClamp(0,.1),c=u.lessThan(0).select(O,d),h=F(c),m=new b;m.colorNode=a,m.backdropNode=n.mix(F(),h.mul(l.mix(1,a))),m.backdropAlphaNode=l.oneMinus(),m.transparent=!0;const x=new p(new g(50,.001,50),m);x.position.set(0,0,0),this.water=x,this.addObject(this.water)}addProcessing(){var e;null==(e=this.controls)||e.target.set(0,.2,0);const{camera:t,scene:s,renderer:i}=this,r=z(s,t),a=r.getTextureNode(),o=r.getLinearDepthNode().remapClamp(.3,.5),n=B(t).y.greaterThan(O.y.sub(.5).mul(t.near)),d=N(a);d.directionNode=n.select(o,r.getLinearDepthNode().mul(5));const u=O.distance(.5).mul(1.35).clamp().oneMinus(),l=new w(i);l.needsUpdate=!0,l.outputNode=n.select(d,d.mul(G(7654644)).mul(u)),this.postProcessing=l}addGui(){var e;const t=this.gui;t.add({blurBackground:this.blurNode.value},"blurBackground",0,1,.01).name("背景模糊").onChange((e=>{this.blurNode.value=e})),t.add(K,"mix",-1,2,.01).name("混合"),t.add(K,"intensity",0,5,.01).name("曝光"),t.add(K,"saturation",0,2,.01).name("饱和度"),t.domElement.className+=" gui-wrap",null==(e=this.container.parentNode)||e.appendChild(t.domElement)}animate(){this.postProcessing&&(this.postProcessing.renderAsync(),this.cube2Texture&&(X.offsetCube1+=.001,X.offsetCube2+=5e-4,this.rotateY1Matrix.makeRotationY(X.offsetCube1),this.rotateY2Matrix.makeRotationY(X.offsetCube2)))}dispose(){var e,t;this.postProcessing=null,this.blurNode=null,this.mixNode=null,this.proceduralNode=null,this.intensityNode=null,this.hueNode=null,this.saturationNode=null,this.rotateY1Matrix=null,this.rotateY2Matrix=null,null==(e=this.cube1Texture)||e.dispose(),null==(t=this.cube2Texture)||t.dispose(),this.gui=null,super.dispose()}}const ee={class:"three-page"},te=v({__name:"index",setup(e){const t=T(),s={directionalLight:{color:16770201,intensity:5,position:[.5,3,.5],light2:!1},ambientLight:{visible:!1},render:{logarithmicDepthBuffer:!1},camera:{near:.25,far:25,position:[3,2,4]},controls:{minDistance:1,maxDistance:10,maxPolarAngle:.9*Math.PI}};let i;return M((()=>{s.container=t.value,i=new Z(s),i.run(),D(i).resize()})),(e,s)=>(k(),P("div",ee,[C("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)]))}});export{te as default};
