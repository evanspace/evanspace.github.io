var e=Object.defineProperty,t=(t,n,a)=>(((t,n,a)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a})(t,"symbol"!=typeof n?n+"":n,a),a);import{l as n,A as a,_ as o}from"./common-89e62a7c.js";import{cv as s,cw as r,bb as i,bG as l,b4 as c,c0 as p,ca as u,bd as d,cc as h,cb as m,bs as v,b$ as g,cx as f,cy as y,bt as w,cz as x,b5 as b,cA as M,cB as P,cC as S,cj as _,cD as I,ck as z,bx as L,br as j,a$ as C,bm as O,bl as k,by as E,bk as G,aZ as R,bw as T,bp as D,b0 as F,cE as B,cF as U,cG as $,b3 as X,cH as q,cI as A,bq as N,_ as W,cJ as H,j as J,cK as V,e as Z,m as Y,o as K,g as Q,h as ee,u as te,n as ne,ab as ae,t as oe,D as se,F as re,r as ie}from"./vendor-3f768a44.js";import{d as le,r as ce,T as pe,u as ue}from"./resize-f8ad65ba.js";const de=4,he=16085360,me=500,ve=.5,ge=40,fe=7450082,ye=9633791,we=7698562,xe=9633791,be=10805495,Me=6421501,Pe=11856636,Se=7450082,{createCorrugatedPlate:_e,update:Ie}={createCorrugatedPlate:e=>{const{range:t=500,interval:n,size:a,color:o=47273,light:v=881527}=e,g=((e=500,t=5,n=3)=>{const a=[],o=Math.floor(e/t);for(let s=-o;s<=o;s++)for(let e=-o;e<=o;e++){const o=new p(n,n),r=s*t,i=e*t,l=new u,c=new d(r,-n,i),v=new m,g=new h,f=new d(1,1,1);v.setFromEuler(g),l.compose(c,v,f),o.applyMatrix4(l),a.push(o)}return a})(t,n,a),f=s(g),y=new r({uniforms:{color:{value:new i(v)},tcolor:{value:new i(o)},radius:{value:1.25},length:{value:t/10},range:{value:t}},vertexShader:"\n  varying vec3 vp;\n  void main(){\n    vp = position;\n    gl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  }\n",fragmentShader:"\n  varying vec3 vp;\n  uniform vec3 color;\n  uniform vec3 tcolor;\n  uniform float radius;\n  uniform float length;\n  uniform float range;\n  float getLeng(float x, float y){\n    return  sqrt((x-0.0)*(x-0.0)+(y-0.0)*(y-0.0));\n  }\n  void main(){\n    float uOpacity = 0.8;\n    vec3 vColor = color;\n    float uLength = getLeng(vp.x,vp.z);\n    if ( uLength <= radius && uLength > radius - length ) {\n      float op = sin( (radius - uLength) / length ) ;\n      uOpacity = op;\n      if ( vp.y < 0.0 ) {\n        vColor = color * op;\n      } else {\n        vColor = tcolor;\n      };\n      vColor = tcolor;\n    }\n    gl_FragColor = vec4(vColor,uOpacity);\n  }\n",transparent:!0,depthWrite:!0,side:l}),w=new c(f,y);return w.name="波纹板",w},update:(e,t)=>{const n=e.material,a=n.uniforms.range.value,o=n.uniforms.length.value;n.uniforms.radius.value+=t*(a/4),n.uniforms.radius.value>=a+o&&(n.uniforms.radius.value=0)}},{createOutline:ze,update:Le}={createOutline:(e,t)=>{const n=new Float32Array(e),a=new v;a.setAttribute("position",new g(n,3));const o=new Float32Array(Math.floor(n.length/3)).map(((e,t)=>t));a.setAttribute("aIndex",new g(o,1));const s=new r({vertexShader:"\n  attribute float aOpacity;\n  uniform float uSize;\n\n  attribute float aIndex;\n  varying vec3 vp;\n  varying float vertexIndex;\n\n  void main(){\n    gl_Position = projectionMatrix*modelViewMatrix*vec4(position,1.0);\n    gl_PointSize = uSize;\n\n    vp = position;\n    vertexIndex = aIndex;\n  }\n",fragmentShader:"\n  varying float vertexIndex;\n  uniform vec3 uColor;\n  uniform float uIndex;\n  uniform float uRange;\n\n  float invert(float n){\n    return 1.-n;\n  }\n\n  void main(){\n    float uOpacity = 1.0;\n    if(vertexIndex <= uIndex || vertexIndex >= (uRange + uIndex)){\n        discard;\n    }\n    uOpacity = (vertexIndex - uIndex)/uRange;\n    if ( uOpacity < 0.2) {\n      discard;\n    }\n    vec2 uv=vec2(gl_PointCoord.x,invert(gl_PointCoord.y));\n    vec2 cUv=2.*uv-1.;\n    vec4 color=vec4(1./length(cUv));\n    color*=uOpacity;\n    color.rgb*=uColor;\n    gl_FragColor=color;\n  }\n",transparent:!0,uniforms:{uSize:{value:de},uIndex:{value:0},uTotal:{value:o.length},uRange:{value:me},uColor:{value:new i(t??he)}}}),l=new f(a,s);return l.name="轮廓",l},update:e=>{const t=e.material,n=t.uniforms.uTotal.value;t.uniforms.uIndex.value+=8,t.uniforms.uIndex.value>=n&&(t.uniforms.uIndex.value=0)}},{getBoundingBox:je}={getBoundingBox:e=>{var t=new y;t.expandByObject(e);var n=new d;t.getSize(n);var a=new d;return t.getCenter(a),{box3:t,center:a,size:n}}},{createCountryFlatLine:Ce,getPoints:Oe}=(()=>{const e=(e,t,n="LineLoop")=>{let a;if("Line2"===n){const n=new M;n.setPositions(e),a=new P(n,t),a.name="countryLine2",a.computeLineDistances()}else{const o=new v;o.setFromPoints(e),a=new S[n](o,t),a.name="countryLine"}return a};return{createCountryFlatLine:(t,n={},a="LineLoop")=>{let o={color:65535};o=le(o,n);let s=new w(o);"Line2"===a&&(s=new x(o));let r=t.features,i=new b;for(let l=0;l<r.length;l++){const t=r[l].geometry.coordinates;for(let n=0;n<t.length;n++){const o=t[n],r=[];"Line2"===a?o.forEach((e=>{e.forEach((e=>{r.push(e[0],0,-e[1])}))})):o.forEach((e=>{e.forEach((e=>{r.push(new d(e[0],e[1],0))}))}));let l=e(r,s,a);i.add(l)}}return i},getPoints:(e,t=0,n)=>{let a=e.features;const o=[];for(let s=0;s<a.length;s++){const e=a[s].geometry.coordinates;for(let a=0;a<e.length;a++)e[a].forEach((e=>{e.forEach((e=>{n?o.push(new d(e[0],t,-e[1])):o.push(e[0],t,-e[1])}))}))}return o}}})(),{initCSS3DRender:ke,createCSS3DDom:Ee}={initCSS3DRender:(e,t)=>{const{width:n,height:a}=e,o=new _;return o.setSize(n,a),o.domElement.style.position="absolute",o.domElement.style.left="0px",o.domElement.style.top="0px",o.domElement.style.pointerEvents="none",t.appendChild(o.domElement),o},createCSS3DDom:e=>{const{name:t,className:n="",onClick:a,position:o,sprite:s}=e,r=document.createElement("div");r.innerHTML=t,r.className=n;const i=s?new I(r):new z(r);return r.style.pointerEvents=a?"auto":"none",r.style.position="absolute","function"==typeof a&&r.addEventListener("click",a),o&&i.position.set(...o),i}},{createMarkLight:Ge}=(e=>{const t=le({pointTextureUrl:"/oss/textures/map/point.png",circleTextureUrl:"/oss/textures/map/circle.png",lightTextureUrl:"/oss/textures/map/light.png",scaleFactor:1,color:65535},e),n=new L;return{createMarkLight:(e,a,o)=>{const s=new b,r=new p(o/6.219,o);r.rotateX(-Math.PI/2),r.translate(0,0,o/2);const i=new j({map:n.load(t.lightTextureUrl),color:t.color,transparent:!0,depthWrite:!1,side:l});let u=new c(r,i);u.rotateX(Math.PI),u.position.z=o,u.renderOrder=99,u.name="光柱 01";let d=u.clone();d.name="光柱 02",d.rotateZ(Math.PI/2);const h=(()=>{const e=new p(3,3),a=new j({map:n.load(t.pointTextureUrl),color:t.color,side:l,transparent:!0,depthWrite:!1});let o=new c(e,a);o.renderOrder=97,o.name="底部光点";const s=.3*t.scaleFactor;return o.scale.set(s,s,s),o})(),m=(()=>{const e=new p(3,3),a=new j({map:n.load(t.circleTextureUrl),color:t.color,side:l,opacity:0,transparent:!0,depthWrite:!1});let o=new c(e,a);o.renderOrder=98,o.name="createLightHalo";const s=.5*t.scaleFactor;o.scale.set(s,s,s);const r=ce(0,2e3);return o.tween1=new C({scale:s,opacity:0}).to({scale:1.5*s,opacity:1},1e3).delay(r).onUpdate((e=>{let{scale:t,opacity:n}=e;o.scale.set(t,t,t),o.material.opacity=n})),o.tween2=new C({scale:1.5*s,opacity:1}).to({scale:2*s,opacity:0},1e3).onUpdate((e=>{let{scale:t,opacity:n}=e;o.scale.set(t,t,t),o.material.opacity=n})),o.tween1.chain(o.tween2),o.tween2.chain(o.tween1),o.tween1.start(),o})();return s.add(u,d,h,m),s.position.set(e,a,0),s.rotateX(.5*Math.PI),s.name="光柱标记",s}}})({pointTextureUrl:"/oss/textures/map/point.png",circleTextureUrl:"/oss/textures/map/circle.png",lightTextureUrl:"/oss/textures/map/light.png",scaleFactor:ge,color:Se}),{raycaster:Re,pointer:Te,style:De,update:Fe}=(()=>{const e=new O,t=new k,n={left:0,top:0};return{raycaster:e,pointer:t,style:n,update:(e,a,o=1)=>{const s=a.getBoundingClientRect()||{left:0,top:0};t.x=(e.clientX-s.left)/(a.clientWidth*o)*2-1,t.y=-(e.clientY-s.top)/(a.clientHeight*o)*2+1;const r=a.clientWidth/2,i=a.clientHeight/2;n.left=t.x*r+r,n.top=-t.y*i+i}}})(),Be=new B;Be.setURLModifier((e=>"/oss/textures/map"+e));const Ue=new L(Be),$e={x:105.06,y:0,z:32.93},Xe=Ue.load("/gz-map.jpg"),qe=Ue.load("/gz-map-fx.jpg"),Ae=Ue.load("/border.png");Xe.wrapS=qe.wrapS=Ae.wrapS=E,Xe.wrapT=qe.wrapT=Ae.wrapT=E,Xe.flipY=!1;const Ne=.0128;Xe.repeat.set(Ne,Ne),qe.repeat.set(Ne,Ne);const We=e=>{const t=new U(e),n=new $(t,{depth:ve,bevelEnabled:!0,bevelSegments:1,bevelThickness:0,steps:0,bevelSize:0}),a=new X({map:Xe,color:fe,normalMap:qe,combine:q,transparent:!0,opacity:1}),o=new T({color:we,map:Ae,transparent:!0,opacity:.9}),s=new c(n,[a,o]);return s.scale.setScalar(ge),s},He=(e,t)=>{if(!e.centroid&&!e.center)return!1;const[n,a]=e.centroid||e.center,o=Ee({name:`\n      <img src="/oss/img/map/label.png" />\n      <div class="name">${e.name}</div>\n    `,className:"map-3D-label",position:[n*ge,a*ge*.995,20]});o.rotateX(.5*Math.PI),o.name=e.name,o.isLabel=!0,t.add(o)},Je=(e,t)=>{if(!e.centroid&&!e.center)return!1;const n=1+(a=5,o=10,(Math.floor(Math.random()*(o-a+1))+a)/4);var a,o;const[s,r]=e.centroid||e.center,i=Ge(s*ge,r*ge,n*ge);i.position.z=20.2,i.rotateX(-Math.PI/2),t.add(i)},Ve=(e,t)=>{const n=new b,a=new A(8,32),o=new j({color:fe,transparent:!0,opacity:1}),s=new c(a,o),r=new N(6.4,32,32,0,Math.PI),i=new j({color:Me,transparent:!0,opacity:1}),l=new c(r,i);return n.add(s,l),n.position.set(e*ge,t*ge,20*1.005),n},Ze=Ue.load("/out-circle2.png"),Ye=Ue.load("/inner-circle2.png");class Ke extends pe{constructor(e){super(e),t(this,"corrugatedPlate"),t(this,"clock"),t(this,"mapGroup"),t(this,"scatterGroup"),t(this,"css3DRender"),t(this,"outline"),t(this,"hoverBack"),t(this,"outRingMesh"),t(this,"innerRingMesh"),this.clock=new G,this.css3DRender=ke(this.options,this.container),this.addModel(),this.bindEvent()}addModel(){const e=_e({range:4e3,interval:32,size:8,color:fe,light:we});this.corrugatedPlate=e,this.addObject(e)}bindEvent(){this.renderer.domElement.addEventListener("pointermove",this.onPointerMove.bind(this))}onPointerMove(e){const t=this.container,n=this.options.scale;if(Fe(e,t,n),this.mapGroup){Re.setFromCamera(Te,this.camera);const e=Re.intersectObjects([this.mapGroup,this.scatterGroup]);if(this.container.style.cursor=e.length?"pointer":"auto",e.length>0){const t=e[0].object;let n;const a=this.findParentProvinceGroupGroupUuid(t);a&&(n=a.uuid,this.hoverProvince(a)),this.setMapBlockColor(n)}else this.hoverProvince(),this.setMapBlockColor()}}findParentProvinceGroupGroupUuid(e){const t=e=>{let n=e.parent;if(n)return n&&n.isProvinceGroup||n.isScatter?n:t(n)};return t(e)}hoverProvince(e){"function"==typeof this.hoverBack&&this.hoverBack(e,De)}setMapBlockColor(e){this.mapGroup.traverse((t=>{if(t.isProvinceBlock)t.material[0].color.set(t.parent.uuid===e?ye:fe),t.material[1].color.set(t.parent.uuid===e?xe:we);else if(t.isLabel){const n=t.parent.uuid===e;t.element.className="map-3D-label"+(n?" is-active":"")}}))}initGrid(){const e=8e3;let t=new R(e,20,we,we);this.grid=t;const n=new b;for(let a=0;a<=20;a++)for(let e=0;e<=20;e++){const t=400*a-4e3,o=400*e-4e3,s=new p(56,11.2),r=new T({color:we,transparent:!0,opacity:.9}),i=new c(s,r);i.rotateX(.5*-Math.PI),i.position.set(t,0,o);const l=i.clone();l.rotateZ(.5*Math.PI),n.add(i,l)}n.name="辅助交点",this.addObject(t,n)}initMap(e){this.mapGroup&&this.disposeObj(this.mapGroup);const t=new b;t.name="地图";const n=e.features,a=n.length;for(let c=0;c<a;c++){const e=n[c],a=new D,o=e.geometry.coordinates,s=e.properties;for(let t=0;t<o.length;t++)o[t].forEach((e=>{const t=e.map((e=>new k(e[0],e[1]))),n=We(t);n.isProvinceBlock=!0,a.add(n)}));He(s,a),Je(s,a),a.rotateX(-Math.PI/2),a.isProvinceGroup=!0,a.name=s.name,a.data=s,t.add(a)}((e,t)=>{let n=Ce(e,{color:be,linewidth:1,transparent:!0,depthTest:!1},"Line2");n.name="地图上边框",n.position.y+=20;let a=Ce(e,{color:Me,linewidth:1,depthTest:!1},"Line2");a.name="地图下边框",n.scale.setScalar(ge),a.scale.setScalar(ge),t.add(n),t.add(a)})(e,this.scene);const o=je(t);let{size:s,center:{x:r,y:i,z:l}}=o;this.mapGroup=t,$e.x=r,$e.y=i,$e.z=l,this.corrugatedPlate.position.set(r,-4,l),this.resetSceneEle();const u=s.x<s.y?s.y+1:s.x+1;this.outRingMesh=((e,t)=>{let n=new p(t,t),a=new j({map:Ze,transparent:!0,opacity:1,depthTest:!0}),o=new c(n,a);const{x:s,z:r}=$e;return o.position.set(s,-1,r),o.scale.setScalar(1.2),o.rotateX(.5*-Math.PI),e.add(o),o})(this.scene,u),this.innerRingMesh=((e,t)=>{let n=new p(t,t),a=new j({map:Ye,transparent:!0,opacity:1,depthTest:!0}),o=new c(n,a);const{x:s,z:r}=$e;return o.position.set(s,-2,r),o.scale.setScalar(1.2),o.rotateX(.5*-Math.PI),e.add(o),o})(this.scene,.9*u),this.addObject(t)}initMapOutLine(e){const t=Oe(e,ve,!1),n=ze(t,Pe);n.scale.setScalar(ge),this.outline=n,this.addObject(n)}initScatter(e,t){this.scatterGroup&&this.disposeObj(this.scatterGroup);const n=new b;n.name="散点集合";for(let a=0;a<e.length;a++){const t=e[a],[o,s]=t.value,r=Ve(o,s);r.name=t.name,r.data=t,r.isScatter=!0,n.add(r)}n.rotateX(.5*-Math.PI),this.scatterGroup=n,this.addObject(n),this.hoverBack=t}initFlywire(e){}resetSceneEle(){const{x:e,y:t,z:n}=$e;if(this.camera.lookAt(e,t,n),new C(this.camera.position).to({x:$e.x,y:1600,z:n+1600},1e3).easing(F.Quadratic.In).start().onUpdate((()=>{})),this.controls.target=new d(e,t,n),this.grid){this.grid.position.set(e,0,n);this.scene.getObjectByName("辅助交点").position.set(e,0,n)}}modelAnimate(){let e=this.clock.getDelta();this.corrugatedPlate&&Ie(this.corrugatedPlate,e),this.outline&&Le(this.outline),this.css3DRender&&this.css3DRender.render(this.scene,this.camera),Ae.offset.y+=.005,this.outRingMesh&&(this.outRingMesh.rotation.z+=5e-4),this.innerRingMesh&&(this.innerRingMesh.rotation.z-=5e-4)}resize(){if(super.resize(),this.css3DRender){const{width:e,height:t}=this.options;this.css3DRender.setSize(e,t)}}}const Qe=["src"],et=o(Z({__name:"index",setup(e){const{show:t,options:o}=(e=>{const t=W({show:!1,...e});return{options:t,show:H(t.show),filters:W({})}})({style:{left:"0px",top:"0px"},list:[],extend:{isScatter:!1,city:"",title:"",total:0}}),{load:s}=(()=>{const e=J(0);return{load:t=>{const n=new V;return new Promise(((a,o)=>{n.load(t,(e=>{let t={};try{t=JSON.parse(e)}catch(n){}a(t)}),(t=>{let{loaded:n,total:a}=t;e.value=Number((n/a*100).toFixed(0))}),o)}))},progress:e}})(),{transformGeoJSON:r}={transformGeoJSON:e=>{let t=e.features;for(let n=0;n<t.length;n++){const e=t[n];"Polygon"===e.geometry.type&&(e.geometry.coordinates=[e.geometry.coordinates])}return e}},i=J(),l={camera:{position:[0,100,200]},fog:{visible:!1,near:2e3,far:3e3},grid:{visible:!0},controls:{maxPolarAngle:.46*Math.PI,maxDistance:5e3,screenSpacePanning:!1},axes:{visible:!1}};let c;const p=()=>{n.get(a.d3.map).then((e=>{const t=[];return{citys:e.list.map((e=>{const n=e.projects.length;let a=e.province;e.projects.forEach((a=>{t.push({value:[a.lng,a.lat],name:a.name,carbon:a.carbon,use:a.use,total:n,city:e.province,id:a.id})}));const o=e.total;return{name:a,code:e.code,total:n,city:e.province,value:o}})),projects:t,lines:e.lines}})).then((e=>{const{projects:n,citys:a}=e;null==c||c.initScatter(n,((e,n)=>{let s=!!e;if(s){o.style&&(o.style.left=n.left+"px",o.style.top=n.top+"px");const t=e.isScatter,r=e.data;let i="",l="",c=0,p=[];if(t)i=r.city,l=r.name,c=r.total,p=[{name:"今日用电量",value:r.use,unit:"kWh"},{name:"今日碳排放",value:r.carbon,unit:"kgCO₂"}];else{const t=a.find((t=>t.name==e.name));t?(i=null==t?void 0:t.city,c=null==t?void 0:t.total,p=[{name:"今日用电量",value:null==t?void 0:t.value,unit:"kWh"}]):s=!1}o.list=p,o.extend.city=i,o.extend.title=l,o.extend.total=c,o.extend.isScatter=t}t.value=s})),null==c||c.initFlywire(e.lines)}))};return Y((()=>{l.container=i.value,c=new Ke(l),c.run(),s("/oss/map/china.json").then((e=>{c.initMap(r(e))})),s("/oss/map/china-outline.json").then((e=>{c.initMapOutLine(r(e))})),p(),ue(c).resize()})),(e,n)=>(K(),Q("div",{class:ne([e.$style.page,"h-100 o-h"])},[ee("div",{class:"h-100",ref_key:"containerRef",ref:i},null,512),te(t)?(K(),Q("div",{key:0,class:ne(e.$style["dialog-view"]),style:ae(te(o).style)},[te(o).extend.city?(K(),Q("div",{key:0,class:ne([e.$style.city,"flex"])},[ee("span",{class:ne(e.$style.name)},oe(te(o).extend.city),3),ee("span",{class:ne(e.$style.total)},oe(te(o).extend.total)+"个项目",3)],2)):se("",!0),te(o).extend.title?(K(),Q("div",{key:1,class:ne([e.$style.project,"flex flex-ac"])},[ee("img",{src:`${te("")}oss/img/map/pos.png`,alt:""},null,8,Qe),ee("span",{class:ne(e.$style.name)},oe(te(o).extend.title),3)],2)):se("",!0),ee("div",{class:ne(e.$style.count)},[(K(!0),Q(re,null,ie(te(o).list,(t=>(K(),Q("div",{class:ne(e.$style.item)},[ee("span",null,oe(t.name),1),ee("span",null,oe(t.value),1),ee("span",null,oe(t.unit),1)],2)))),256))],2)],6)):se("",!0)],2))}}),[["__cssModules",{$style:{page:"_page_xd45q_2","dialog-view":"_dialog-view_xd45q_6",city:"_city_xd45q_14",name:"_name_xd45q_14",total:"_total_xd45q_22",project:"_project_xd45q_26",count:"_count_xd45q_41",item:"_item_xd45q_45"}}]]);export{et as default};
