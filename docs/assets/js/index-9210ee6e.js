var e=Object.defineProperty,t=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s);import{c_ as i,cZ as s,c$ as n,cX as a,cl as r,cr as o,d0 as l,d1 as c,d2 as d,d3 as h,bp as u,bc as p,ba as m,bL as f,bk as x,bd as g,bb as b,d4 as w,e as B,i as v,l as y,o as C,g as P,h as T}from"./vendor-f77cf917.js";import{E as I,u as R}from"./scene-resize-4be6e6ab.js";import"./index-95248e06.js";const M=()=>s.uint(16777215*Math.random());class z extends I{constructor(e){super(e),t(this,"maxCount",5e4),t(this,"count",5e3),t(this,"collisionCamera"),t(this,"renderTarget"),t(this,"material"),t(this,"positionBuffer"),t(this,"velocityBuffer"),t(this,"ripplePositionBuffer"),t(this,"rippleTimeBuffer"),t(this,"computeParticles"),t(this,"rainParticles"),t(this,"rippleParticles"),t(this,"collisionBox"),t(this,"gui"),this.collisionCamera=this.createCollisionCamera(),this.renderTarget=this.createRenderTarget();const a=new i;a.colorNode=s.positionWorld,this.material=a,this.positionBuffer=this.createBuffer(),this.velocityBuffer=this.createBuffer(),this.ripplePositionBuffer=this.createBuffer(),this.rippleTimeBuffer=this.createBuffer();const r=this.initCompute(),o=this.computeUpdate();this.computeParticles=o().compute(this.maxCount),this.addModel(),this.renderer.computeAsync(r),this.gui=new n,this.addGui()}initRenderer(){const{width:e,height:t,bgColor:i,bgUrl:s,env:n}=this.options,o=new a(this.options.render);if(n&&this.setEnvironment(n),s?this.setBgTexture(s):this.setBgColor(i),this.options.fog.visible){const{color:e,near:t,far:i}=this.options.fog;this.scene.fog=new r(e??this.scene.background,t,i)}return o.setSize(e,t),o.setPixelRatio(window.devicePixelRatio),this.container.appendChild(o.domElement),o}createCollisionCamera(){const e=new o(-50,50,50,-50,.1,50);return e.position.y=50,e.lookAt(0,0,0),e.layers.disableAll(),e.layers.enable(1),e}createRenderTarget(){const e=new l(1024,1024),t=e.texture;return t.type=c,t.magFilter=d,t.minFilter=d,t.generateMipmaps=!1,e}createBuffer(e="vec3"){const t=this.maxCount;return s.storage(new h(t,3),e,t)}initCompute(){return s.Fn((()=>{const e=this.positionBuffer.element(s.instanceIndex),t=this.velocityBuffer.element(s.instanceIndex),i=this.rippleTimeBuffer.element(s.instanceIndex),n=s.hash(s.instanceIndex),a=s.hash(s.instanceIndex.add(M())),r=s.hash(s.instanceIndex.add(M()));e.x=n.mul(100).add(-50),e.y=a.mul(25),e.z=r.mul(100).add(-50),t.y=n.mul(-.04).add(-.2),i.x=1e3}))().compute(this.maxCount)}computeUpdate(){return s.Fn((()=>{const e=e=>e.add(50).div(100),t=this.positionBuffer.element(s.instanceIndex),i=this.velocityBuffer.element(s.instanceIndex),n=this.ripplePositionBuffer.element(s.instanceIndex),a=this.rippleTimeBuffer.element(s.instanceIndex);t.addAssign(i),a.x=a.x.add(s.deltaTime.mul(4));const r=s.texture(this.renderTarget.texture,e(t.xz)).y.add(.05);s.If(t.y.add(-.9).lessThan(r),(()=>{t.y=25,n.xz=t.xz,n.y=r,a.x=1,t.x=s.hash(s.instanceIndex.add(s.time)).mul(100).add(-50),t.z=s.hash(s.instanceIndex.add(s.time.add(M()))).mul(100).add(-50)}));const o=s.texture(this.renderTarget.texture,e(n.xz)).y.add(.05);s.If(n.y.greaterThan(o),(()=>{a.x=1e3}))}))}addModel(){this.createRainDrop(),this.createRainRipple(),this.createCollisionGround(),this.createCollisionModel()}createRainDrop(){const e=new i;e.colorNode=s.uv().distance(s.vec2(.5,0)).oneMinus().mul(3).exp().mul(.1),e.vertexNode=s.billboarding({position:this.positionBuffer.toAttribute()}),e.opacity=.2,e.side=u,e.forceSinglePass=!0,e.depthWrite=!1,e.depthTest=!0,e.transparent=!0;const t=new p(new m(.1,2),e);t.count=this.count,this.rainParticles=t,this.addObject(t)}createRainRipple(){const e=this.rippleTimeBuffer.element(s.instanceIndex).x,t=s.Fn((()=>{const t=s.uv().add(s.vec2(-.5)).length().mul(7),i=e.sub(t);return i.min(1).sub(i.max(1).sub(1))})),n=new i;n.colorNode=t(),n.positionNode=s.positionGeometry.add(this.ripplePositionBuffer.toAttribute()),n.opacityNode=e.mul(.3).oneMinus().max(0).mul(.5),n.side=u,n.forceSinglePass=!0,n.depthWrite=!1,n.depthTest=!0,n.transparent=!0;const a=new m(2.5,2.5);a.rotateX(-Math.PI/2);const r=new m(1,2);r.rotateY(-Math.PI/2);const o=new m(1,2),l=f([a,r,o]),c=new p(l,n);c.count=this.count,this.rippleParticles=c,this.addObject(c)}createCollisionGround(){const e=new m(1e3,1e3);e.rotateX(-Math.PI/2);const t=new p(e,new x({color:328965}));this.addObject(t)}createCollisionModel(){const e=new p(new g(30,1,15),new b({color:3355443}));e.position.y=12,e.scale.x=3.5,e.layers.enable(1),e.castShadow=!0,this.collisionBox=e,this.addObject(e);const t=new p(new w(5,1,128,100),new b({color:3355443}));t.position.set(0,12,15),t.layers.enable(1),this.addObject(t)}addGui(){var e,t,i;const s=this.gui;s.add(null==(e=this.collisionBox)?void 0:e.position,"z",-50,50),s.add(null==(t=this.collisionBox)?void 0:t.scale,"x",.1,4),s.add(this.rainParticles,"count",200,this.maxCount).name("数量").onChange((e=>{this.rippleParticles.count=e})),s.domElement.className+=" gui-wrap",null==(i=this.container.parentNode)||i.appendChild(s.domElement)}animate(){const e=this.renderer;e&&(this.scene.overrideMaterial=this.material,e.setRenderTarget(this.renderTarget),e.render(this.scene,this.collisionCamera),e.compute(this.computeParticles),this.scene.overrideMaterial=null,e.setRenderTarget(null),e.render(this.scene,this.camera))}}const j={class:"three-page"},N=B({__name:"index",setup(e){const t=v(),i={grid:{},render:{antialias:!0,logarithmicDepthBuffer:!1},axes:{visible:!0},ambientLight:{color:1118481},directionalLight:{position:[3,17,17]},camera:{position:[40,8,0]},controls:{maxDistance:50}};let s;return y((()=>{i.container=t.value,s=new z(i),s.run(),R(s).resize()})),(e,i)=>(C(),P("div",j,[T("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)]))}});export{N as default};
