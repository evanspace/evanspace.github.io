import{t as e}from"./index-23edb7fb.js";import{bs as t,e as o,i,w as s,l as n,aP as a,o as l,g as r,h as c,u as d,B as u,n as p,q as h,a9 as f,a5 as m,aa as v,bS as g}from"./vendor-d68cddd1.js";import{S as y}from"./index-01f9a577.js";import{D as b}from"./config-51e0289e.js";import{u as C}from"./raycaster-6878a949.js";import{u as k}from"./css2d-448a251a.js";import{u as x,g as G,s as D,c as j,a as _,m as O,b as w,f as P,d as M,e as E,h as B}from"./model-loader-a8713a2c.js";import{d as S}from"./object-be545f18.js";import{u as T}from"./dialog-9682c55e.js";import{u as U}from"./background-040c1ffa.js";import{_ as A}from"./index-5878c146.js";const{raycaster:L,pointer:K,update:z}=C(),{initCSS2DRender:N,createCSS2DDom:R}=k();class F extends y{constructor(e,t){super(e),this.findFilterDevice=(e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let i=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{i.includes(e)||i.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!i.includes(o)&&i.push(o),!!o})).length==e.length&&(o=o.concat(i))}else{const i=t.find((t=>t.deviceCode==e));i&&o.push(i)}})),o},this.extend=t,this.css2DRender=N(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.createClock(),this.addDeviceGroup(),this.addDotGroup(),this.addPipeGroup(),this.bindEvent()}addDeviceGroup(){const e=new t;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot(),this.clearPipe()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const e=new t;e.name="点位组",this.scene.add(e),this.dotGroup=e}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){var o;const i=e.position,{size:s,color:n}=e.font||{},{x:a=0,y:l=0,z:r=0}=i||{},c=R({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,l,r],onClick:t});return c.name=e.name,c.data=e,null==(o=this.dotGroup)||o.add(c),c}addPipeGroup(){const e=new t;e.name="管路组",this.scene.add(e),this.pipeGroup=e}addPipe(...e){this.pipeGroup&&this.pipeGroup.add(...e)}clearPipe(){this.pipeGroup&&this.disposeObj(this.pipeGroup),this.addPipeGroup()}onDblclick(e){var t;const o=this.container,i=this.options.scale;if(z(e,o,i),this.deviceGroup){L.setFromCamera(K,this.camera);const e=[this.deviceGroup,this.pipeGroup],o=L.intersectObjects(e);if(o.length){const e=o[0].object,i=this.findParentGroupGroup(e);if(!i)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(i)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<b.rightClickBackDiffTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o,i;const s=this.container,n=this.options.scale;z(e,s,n);let a="pointerdown"==e.type||"pointerup"==e.type;const l=(null==(t=this.deviceGroup)?void 0:t.children.filter((e=>e.visible&&e._isAnchor_)))||[];L.setFromCamera(K,this.camera);let r=L.intersectObjects(l,a);if(s.style.cursor=r.length>0?"pointer":"auto",a)if(r.length){const e=r[0].object;if(!e)return;"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(i=this.extend)?void 0:i.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&(o._isDevice_||o._isPipe_)?o:t(o)};return t(e)}modelAnimate(){var e;if(this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.deviceGroup&&this.deviceGroup.children.length){let t=null==(e=this.clock)?void 0:e.getDelta();this.deviceGroup.children.forEach((e=>{let o=e.data;if(!o)return;let i=e.extra;i&&((null==o?void 0:o.status)??0)>0&&i.mixer.update(t);const s=e[b.meshKey.warning];s&&((null==o?void 0:o.error)||0)>0&&s.mixer.update(t)}))}this.pipeGroup&&this.pipeGroup.children.length&&this.pipeGroup.children.forEach((e=>{var t;const o=e[b.meshKey.pipe];if(o){const i=e.data,s=i.bind||[],n=((null==(t=this.deviceGroup)?void 0:t.children)||[]).filter((e=>{var t;return e.data&&e.data.deviceCode&&((null==(t=e.data)?void 0:t.status)??0)>0})).map((e=>e.data)),a=this.findFilterDevice(s,n),l=a.length>0;let r=.01;if(i.left&&i.right){const{left:e,right:t}=i,o=this.findFilterDevice(t,a).length>0,s=this.findFilterDevice(e,a).length>0;r=s&&o?0:o?-.01:.01}o.forEach((e=>{l&&(e.material.map.offset.y-=r),e.material.opacity=l?.3:0}))}}))}getAnimTargetPos(e,t,o){if(!this.controls)return;const i=t||e.to||{x:-104,y:7,z:58},s=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),i}getAll(){var e,t;return(null==(t=this.deviceGroup)?void 0:t.children.concat((null==(e=this.dotGroup)?void 0:e.children)||[]))||[]}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}dispose(){this.disposeObj(this.deviceGroup),this.disposeObj(this.dotGroup),this.disposeObj(this.pipeGroup),this.clock=void 0,this.css2DRender=void 0,this.deviceGroup=void 0,this.dotGroup=void 0,this.pipeGroup=void 0,this.extend={},super.dispose()}}const $={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},I={class:"scene-operation"},V=A(o({name:"device-scene",__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoPath:{},basisPath:{},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},ambientLight:{},directionalLight:{default:()=>({})},models:{},config:{},objects:{},pipes:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},statusOffset:{},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{default:()=>["FM"]},animationModelType:{},textModelType:{},anchorType:{default:()=>[]},textChangeColor:{type:Boolean},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},mainBodyExcludeType:{default:()=>["FM"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(o,{expose:y,emit:C}){const k=o,A=C,L=S($,k.colors),{changeBackground:K,backgroundLoad:z,skys:N}=U(),{progress:R,MODEL_MAP:V,loadModel:q,loadModels:W,getModel:X}=x({baseUrl:k.baseUrl,dracoPath:k.dracoPath,basisPath:k.basisPath,colors:L,colorMeshName:k.colorMeshName,indexDB:k.indexDB}),{dialog:H}=T(),J=i(),Q={baseUrl:k.baseUrl,bgUrl:k.bgUrl,env:k.env,bgColor:k.bgColor,camera:k.camera,cruise:k.cruise,fog:k.fog,render:k.render,grid:k.grid,controls:k.controls,axes:k.axes,ambientLight:k.ambientLight,directionalLight:k.directionalLight};let Y;s((()=>k.dotShowStrict),(()=>Z())),s((()=>k.scale),(e=>{null==Y||Y.setScale(e||1)})),s((()=>k.cruise.points),(e=>{R.isEnd&&Y.setCruisePoint(e||[])})),s((()=>k.objects),(()=>{R.isEnd&&ie()}));const Z=()=>{var e;const t=(null==(e=Y.dotGroup)?void 0:e.children)||[];for(let o=0;o<t.length;o++){const e=t[o];if(!e.data)continue;e.data.type===k.dotKey&&ee(e)}},ee=e=>{var t;const o=e.data;if(!o||!Y.deviceGroup)return;if("function"==typeof k.dotUpdateObjectCall){const e=k.dotUpdateObjectCall(o,Y.deviceGroup.children);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!k.dotShowStrict;const i=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(i){const{size:e,color:t}=o.font||{};null!=e&&(i.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(i.style.color=t),i.textContent=`${o.value||0}${o.unit}`}},te=async e=>{var o;if(!e)return;const{type:i,url:s}=e,n=X(i);if(!n)return void(s?await(async e=>{const{type:t,url:o="",name:i}=e,s=await q({key:t,url:o,name:i,size:0}),{position:n,scale:a,rotation:l}=w(s,e);return s.scale.set(...a),s.position.set(...n),s.rotation.set(...l),s._isBase_=!0,Y.addDevice(s),Promise.resolve(s)})(e):i===k.dotKey&&(e=>{ee(Y.addDot(e,(t=>{A("click-dot",a(e),t)})))})(e));const l=k.anchorType||[];let r=O(n);const{position:c,scale:d,rotation:u}=w(r,e),[p,h,f]=c;r.scale.set(...d);const m=k.animationModelType||[],v=k.colorMeshName||[],y=k.mainBodyExcludeType||[],C=k.textModelType||[],x=X(V.font);if(C.includes(i)&&x){const i=new t;i.add(r);const s=M(e,x,L.normal.text,null==(o=k.statusOffset)?void 0:o.TEXT);i.add(s),i.name=e.name,r=i}if(m.includes(i)){if("Group"!==r.type){const e=new t;e.add(r),e.name=r.name,r=e}if(((e,t)=>{var o,i,s;const n=X(V.warning);if(n){const i=b.meshKey.warning,{group:s,action:a,mixer:l}=E(i,t,n,null==(o=k.statusOffset)?void 0:o.WARNING);e.add(s),e[i]={action:a,mixer:l}}const a=X(V.local);if(a){const o=b.meshKey.local,s=B(t,a,null==(i=k.statusOffset)?void 0:i.STATUS);e.add(s),e[o]=s}const l=X(V.disabled);if(l){const o=b.meshKey.disabled,i=B(t,l,null==(s=k.statusOffset)?void 0:s.DISABLED,!0);e.add(i),e[o]=i}})(r,e),k.mainBodyChangeColor&&!y.includes(i)){const e=P(r.children,k.mainBodyMeshName),t=L.normal;let o=null!=t.main?t.main:t.color,i=_(o);i.length&&e.forEach(((e,t)=>{D(e,i[t%i.length])})),r[b.meshKey.body]=e}const o=P(r.children,v);let s,a=new g(r);n.animations.length&&(s=a.clipAction(n.animations[0]),s.paused=!0,s.timeScale=1.5,s.play()),r.extra={action:s,mixer:a,meshs:o}}else{const e=[];r.traverse((t=>{"string"==typeof t.name&&v.some((e=>t.name.indexOf(e)>-1))&&e.push(t)})),e.length&&(r[b.meshKey.color]=e)}return r.position.set(p,h,f),r.rotation.set(...u),r._isDevice_=!0,r.data=e,l.includes(i)&&(r._isAnchor_=!0),Y.addDevice(r),Promise.resolve()},oe=i([]),ie=async()=>{var e,t,o;R.percentage=100,R.show=!1,Y.clearDevice(),await v(),(()=>{oe.value.length=0;const e=a(k.objects)||[];if("function"!=typeof k.formatObject)oe.value=e;else{const t=k.formatObject(e);oe.value=t}})(),await(()=>{let e=0,t=oe.value.length;return new Promise((o=>{if(0==t)return o(null);const i=async()=>{const s=oe.value[e];await te(s),e++,e<t?i():o(e)};i()}))})(),(()=>{if(!k.pipes||0==k.pipes.length)return;const e=k.pipes;for(let t=0;t<e.length;t++){const o=e[t],{type:i,map:s}=o,n=X(i);if(!n)continue;let a=O(n);const l=n._mapMeshName_,{position:r,scale:c,rotation:d}=w(a,o),[u,p,h]=r,f=P(a.children,[l]);f.length&&(f.forEach((e=>{if(e.material.map=e.material.map.clone(),s){const t=e.material.map.repeat;e.material.map.repeat.set(t.x*(s[0]??1),t.y*(s[1]??1))}})),a[b.meshKey.pipe]=f),a.scale.set(...c),a.position.set(u,p,h),a.rotation.set(...d),a._isPipe_=!0,a.data=o,Y.addPipe(a)}})(),Y.setCruisePoint((null==(e=k.cruise)?void 0:e.points)||[]),"function"==typeof(null==(t=k.config)?void 0:t.load)&&(null==(o=k.config)||o.load(Y));const i=Y.getAnimTargetPos(k.config||{});Y.controls&&i&&j(Y.camera,i,Y.controls.target).then((()=>{A("loaded"),Y.controlSave()}))},se=()=>{W(k.models,(()=>{ie()})),k.skyCode&&z(Y,k.skyCode)},ne=e=>{const t=J.value,o=G(t,e,Y.camera);return H.position=o,H.style.left=o.left+"px",H.style.top=o.top+"px",o},ae=e=>{const t=[];k.updateObjectCall,Y.getAll().forEach(((o,i)=>{if(!o.data)return;const s=o.data;let n=s.type;if(n===k.dotKey)return void ee(o);if("function"==typeof k.updateObjectCall){const t=k.updateObjectCall(s,e);if(!t)return;Object.keys(t).forEach((e=>{s[e]=t[e]}))}t.push(a(s));let{status:l=0,error:r=0,remote:c=0,local:d=0,disabled:u=0}=s;const p=L[r>0?"error":l>0?"runing":"normal"];let h=null!=p[n]?p[n]:p.color;if("function"==typeof k.getColorCall){const e=k.getColorCall(s);e&&(h=e)}le({type:n,el:o,colorObj:p,color:h,paused:0==l,error:r>0,remote:c>0,local:d>0,disabled:u>0})})),A("update",t,e)},le=e=>{let{el:t,type:o,colorObj:i,color:s,paused:n,error:a}=e,l=_(s);s=l[0];const r=b.meshKey;if(k.colorModelType.includes(o)&&null!=s){return void(t[r.color]||[]).forEach((e=>{D(e,s)}))}if(!(k.animationModelType||[]).includes(o))return;if(k.textChangeColor){const e=null!=i.text?i.text:i.color,o=t.getObjectByProperty("_isText_",!0);let s=_(e);D(o,s[0])}const c=t.extra;if(c&&(c.action&&(c.action.paused=n),null!=s)){(c.meshs||[]).forEach((e=>{D(e,s)}))}if(k.mainBodyChangeColor&&t[r.body]){const e=null!=i.main?i.main:i.color;let o=_(e);o.length&&t[r.body].forEach(((e,t)=>{D(e,o[t%o.length])}))}const d=t[r.warning];if(d){const e=t.children.find((e=>e.name==r.warning));e&&(e.visible=a,d.action.paused=!a)}t[r.local]&&(t[r.local].visible=e.local),t[r.disabled]&&(t[r.disabled].visible=e.disabled)};return n((()=>{Q.container=J.value,Y=new F(Q,{onDblclick(e){const t=e.data;"function"==typeof t.onDblclick?t.onDblclick(a(t),e):A("dblclick",a(t))},onClickLeft(e){if(e){const t=e.data,o=a(t);A("select",o),"function"==typeof t.onClick?(H.show=!1,t.onClick(o)):(H.select=[e],(()=>{const e=H.select[0],t=e.data;H.data=t,H.title=(null==t?void 0:t.name)||"",H.show=!0;const o=ne(e);A("click-dialog-dot",t,o)})())}else H.select=[],H.show=!1},onClickRight(e){var t;"function"==typeof(null==(t=k.config)?void 0:t.back)&&k.config.back(Y)},animateCall:()=>{if(H.show&&H.select.length){const e=H.select[0];ne(e)}}}),Y.run(),A("init",Y),se()})),y({update:ae,exportImage:()=>null==Y?void 0:Y.exportImage()}),(t,o)=>(l(),r("div",{class:p(t.$style["device-scene"])},[c("div",I,[c("div",{class:"btn",onClick:o[0]||(o[0]=()=>ae(!0))},"随机更新"),t.cruise.visible?(l(),r("div",{key:0,class:"btn",onClick:o[1]||(o[1]=()=>{var e;return null==(e=d(Y))?void 0:e.toggleCruise()})},"定点巡航")):u("",!0),c("div",{class:"btn",onClick:o[2]||(o[2]=()=>{var e;return null==(e=d(Y))?void 0:e.getPosition()})},"场景坐标"),c("div",{class:"btn",onClick:o[3]||(o[3]=()=>d(K)(d(Y)))},"切换背景"),c("div",{class:"btn",onClick:o[4]||(o[4]=()=>{var e;return null==(e=d(Y))?void 0:e.controlReset()})},"控制器重置"),t.cruise.visible?(l(),r("div",{key:1,class:"btn",onClick:o[5]||(o[5]=()=>{var e;return null==(e=d(Y))?void 0:e.toggleCruiseDepthTest()})}," 巡航深度 ")):u("",!0)]),c("div",{class:p(t.$style.container),ref_key:"containerRef",ref:J},null,2),h(e,{modelValue:d(R).show,"onUpdate:modelValue":o[6]||(o[6]=e=>d(R).show=e),progress:d(R).percentage},null,8,["modelValue","progress"]),d(H).show?(l(),r("div",{key:0,class:p(t.$style.dialog),style:f(d(H).style)},[m(t.$slots,"dialog",{data:d(H).data,title:d(H).title,position:d(H).position})],6)):u("",!0)],2))}}),[["__cssModules",{$style:{"device-scene":"_device-scene_1k662_2",container:"_container_1k662_8",dialog:"_dialog_1k662_12"}}]]);export{V as t};
