var e=Object.defineProperty,a=(a,t,s)=>(((a,t,s)=>{t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s})(a,"symbol"!=typeof t?t+"":t,s),s);import{d2 as t,bb as s,dd as i,de as n,d3 as o,cS as r,be as d,bp as l,df as c,Y as h,b7 as m,dg as p,ba as u,bc as g,bM as f,aa as y,bs as b,cw as M,bk as x,c as _,c9 as v,cx as w,cy as G,ca as C,dh as O,e as U,i as j,l as k,o as S,g as A,a7 as E,dc as $,u as T,h as R,n as z}from"./vendor-a6dc29a3.js";import{T as L,d as N,u as B}from"./scene-resize-46f23ed0.js";import{D as F}from"./config-9a637eb0.js";import{u as P}from"./background-c7faf259.js";import{c as H}from"./model-a663f9ee.js";import{_ as I}from"./index-b0c68379.js";import"./posZ-54c73ffc.js";const D={receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},{materialReplace:q,changeTransparent:V,exportGlb:K,getAnimations:J,setMetalnessMaterial:X,setGlassMaterial:Y,centerBoxHelper:Z}=(()=>{const e=(e,a=.5)=>{const t=e=>{e.material.transparent=!0,e.material.opacity=a};e.isMesh?t(e):e.traverse((e=>{e.isMesh&&t(e)}))},a=e=>({color:e.color,map:e.map,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,emissiveMap:e.emissiveMap,bumpMap:e.bumpMap,normalMap:e.normalMap,displacementMap:e.displacementMap,opacity:e.opacity,transparent:e.transparent,side:e.side}),h=(e,t,i)=>{if(e instanceof Array){let a=e.map((e=>h(e,t,i)));e=a}else t?(e.metalness=.5,e.roughness=0):(e.metalness=.5,e.roughness=1),e=new s({...a(e),metalness:e.metalness,roughness:e.roughness,side:i?l:c});return e},m=(e,a)=>{const t=document.createElement("a");t.style.display="none",document.body.appendChild(t),t.href=URL.createObjectURL(e),t.download=a,t.click(),t.remove()};return{materialReplace:(a,i,n,o=1211922)=>{const r=F.mesh,d=r.animatehName,l=r.transparentName,{type:c,name:m}=n;if(c.indexOf("Light")>-1){if(!n.shadow)return;let e=800;if(n.castShadow=!0,n.shadow.camera.right=e,n.shadow.camera.left=-e,n.shadow.camera.top=e,n.shadow.camera.bottom=-e,"SpotLight"===c){let e=new t(n,1,n.color);a.add(e)}}else if(i.transformMaterial&&n.isMesh)if(i.opacitySkin&&l.find((e=>m.indexOf(e)>-1))&&e(n,i.opacity),r.receiveShadowName.find((e=>m.indexOf(e)>-1))){n.receiveShadow=!0;const e=i.groundReflection;n.material=h(n.material,e,i.side)}else if(d.find((e=>m.indexOf(e)>-1))){let e=new s({color:o,metalness:.6,roughness:.6});n.material=e}else n.isMesh&&(n.castShadow=!0,n.material=h(n.material,i.glisten,i.side))},changeTransparent:e,exportGlb:(e,a,t,s=!0)=>{if(!e)return;const n={binary:s,animations:a};(new i).parse(e,(e=>{if(e instanceof ArrayBuffer)a=t+".glb",m(new Blob([e],{type:"application/octet-stream"}),a);else{((e,a)=>{m(new Blob([e],{type:"text/plain"}),a)})(JSON.stringify(e,null,2),t+".gltf")}var a}),(e=>{}),n)},getAnimations:e=>{const a=[];e.traverse((e=>{a.push(...e.animations)}));const t=[];for(const s of a)t.push(s.clone().optimize());return t},setMetalnessMaterial:(e={color:16777215},t,i)=>new s({...a(e),metalness:t,roughness:i}),setGlassMaterial:(e={color:16777215},{metalness:t,roughness:s,envMapIntensity:i,transmission:o,ior:r})=>new n({...a(e),metalness:t,roughness:s,envMapIntensity:i,transmission:o,ior:r}),centerBoxHelper:(e,a=16711680)=>{var t=new o(e,a);t.update();return{helper:t,center:(new r).setFromObject(e).getCenter(new d)}}}})(),{backgroundLoad:Q}=P(),W=e=>_(e),ee=new Proxy({warning:e=>W({message:e,type:"warning",grouping:!0}),success:e=>W({message:e,type:"success",grouping:!0})},{get:(e,a,t)=>e[a]}),ae=h({dotText:""});class te extends L{constructor(e){super(e),a(this,"clock"),a(this,"gui"),a(this,"modelGroup"),a(this,"helperGroup"),a(this,"groundMesh"),a(this,"guiOpts",{scale:1,side:!1,insetAnimate:!1,transformMaterial:!0,groundReflection:!1,glisten:!1,opacitySkin:!1,opacity:.6}),a(this,"metalnessMaterialUpdate",(({metalness:e,roughness:a})=>{this.modelGroup.children.forEach((t=>{t.traverse((s=>{if(/[金属]/.test(s.name)||0==t.children.length)if(Array.isArray(s.material))s.material=s.material.map((t=>X(t,e,a)));else{const t=s.material;s.material=X(t,e,a)}}))}))})),a(this,"glassMaterialUpdate",(e=>{this.modelGroup.children.forEach((a=>{a.traverse((t=>{if(/[玻璃]/.test(t.name)||0==a.children.length)if(Array.isArray(t.material))t.material=t.material.map((a=>Y(a,e)));else{const a=t.material;t.material=Y(a,e)}}))}))})),a(this,"blurringMaterialUpdate",(e=>{this.modelGroup.children.forEach((a=>{a.traverse((t=>{e.all||0==a.children.length||/[线框]/.test(t.name)?t.isMesh&&(e.blurring||e.all?(t.__material__||(t.__material__=t.material),t.material=new x({color:e.color,wireframe:e.wireframe,transparent:!0,opacity:e.opacity})):t.__material__&&(t.material=t.__material__)):t.isMesh&&t.__material__&&(t.material=t.__material__)}))}))})),this.clock=new m,this.gui=new p,this.addGround(),this.addGui(),this.addModelGroup()}addGui(){var e;const a=this.gui;this.addMainFunction(),this.addMaterial(),this.addNameGroupGui(),this.addResetGui(),this.addEvnGui(),a.domElement.className+=" gui-wrap",null==(e=this.container.parentNode)||e.appendChild(a.domElement)}addGround(){const e=new u(5e3,5e3),a=new s({color:10530223,shininess:10}),t=new g(e,a);t.name="ground",t.rotation.x=1.5*Math.PI,t.receiveShadow=!0,t.visible=!1,this.groundMesh=t,this.addObject(t)}addMainFunction(){const e=this.gui;if(!this.container)return;const a=this.container.parentNode.querySelector('input[type="file"]'),t={importFile:()=>{a.click()},exportGltf:()=>{this.export(!1)},exportGlb:()=>{this.export()},exportPoints:()=>{if(!this.judgeUploadModel())return;const e=this.modelGroup.children.map((e=>{let a=e.position;return`{ "x": ${1*a.x.toFixed(2)}, "y": ${1*a.y.toFixed(2)}, "z": ${1*a.z.toFixed(2)} }`}));ae.dotText=e,this.copyTextarea("坐标复制成功！")},target:()=>{const e=this.controls.target;ae.dotText=`{ x: ${e.x}, y: ${e.y}, z: ${e.z} }`,this.copyTextarea("中心点复制成功！")},camera:()=>{const e=this.camera.position;ae.dotText=`{ x: ${e.x}, y: ${e.y}, z: ${e.z} }`,this.copyTextarea("相机坐标复制成功！")}},s=e.addFolder("主功能");s.add(t,"importFile").name("上传文件"),s.add(t,"exportGltf").name("导出 .gltf"),s.add(t,"exportGlb").name("导出 .glb"),s.add(t,"exportPoints").name("导出坐标"),s.add(t,"target").name("中心点"),s.add(t,"camera").name("相机坐标"),s.open()}addMaterial(){const e=this.gui;if(!this.container)return;const a=e.addFolder("材质");a.add(this.guiOpts,"transformMaterial").name("转换标准材质"),a.add(this.guiOpts,"glisten").name("材质反光").onChange((()=>this.glistenToggle())),a.add(this.guiOpts,"groundReflection").name("地面反光").onChange((()=>this.groundGlisten())),a.add(this.guiOpts,"side").name("双面材质").onChange((()=>this.sideMaterialToggle())),a.add(this.guiOpts,"opacitySkin").name("材质透明").onChange((()=>this.opacitySkin())),a.add(this.guiOpts,"opacity",0,1).name("透明度").onChange((()=>this.opacitySkin())),a.open()}addNameGroupGui(){const e=this.gui,a={check:!1,metalness:.5,roughness:0},t=e.addFolder("名称包含处理");t.add(a,"check").name("金属材质(金属)").onChange((e=>{a.metalness=e?.5:0,a.roughness=e?0:.5,this.metalnessMaterialUpdate(a)})),t.add(a,"metalness",0,1).name("金属权重").onChange((()=>{this.metalnessMaterialUpdate(a)})),t.add(a,"roughness",0,1).name("金属粗糙度").onChange((()=>{this.metalnessMaterialUpdate(a)}));const s={check:!1,roughness:0,envMapIntensity:1,transmission:1,ior:2.1};t.add(s,"check").name("玻璃材质(玻璃)").onChange((e=>{s.roughness=e?0:.5,s.envMapIntensity=e?1:0,s.transmission=e?1:0,s.ior=e?2.1:1.5,this.glassMaterialUpdate(s)})),t.add(s,"roughness",0,1).name("玻璃光滑度").onChange((()=>{this.glassMaterialUpdate(s)})),t.add(s,"envMapIntensity",0,1).name("玻璃环境贴图影响权重").onChange((()=>{this.glassMaterialUpdate(s)})),t.add(s,"transmission",0,1).name("玻璃透射度(透光率)").onChange((()=>{this.glassMaterialUpdate(s)})),t.add(s,"ior",0,10).name("玻璃折射率").onChange((()=>{this.glassMaterialUpdate(s)}));const i={blurring:!1,wireframe:!1,color:57599,opacity:.5,all:!1};t.add(i,"blurring").name("虚化材质(虚化)").onChange((()=>{this.blurringMaterialUpdate(i)})),t.add(i,"all").name("全部虚化").onChange((()=>{this.blurringMaterialUpdate(i)})),t.addColor(i,"color").name("虚化颜色").onChange((()=>{this.blurringMaterialUpdate(i)})),t.add(i,"opacity",0,1).name("虚化透明度").onChange((()=>{this.blurringMaterialUpdate(i)})),t.add(i,"wireframe",0,1).name("虚化线框").onChange((()=>{this.blurringMaterialUpdate(i)})),t.open()}addResetGui(){const e={viewReset:()=>this.cameraViewReset(),clearScene:()=>{this.clearModelGroup()},rotation:0,scale:1,timeScale:1,center:()=>this.modelCenter()},a=this.gui.addFolder("重置");a.add(e,"viewReset").name("视角重置"),a.add(e,"clearScene").name("清空场景"),a.add(this.grid,"visible").name("网格显示"),a.add(this.controls,"autoRotate").name("自动旋转"),a.add(this.guiOpts,"insetAnimate").name("入场动画"),a.add(e,"rotation",0,360).name("旋转").onChange((e=>{this.modelGroup.children.forEach((a=>{const t=Math.PI/180*e;a.rotation.set(0,t,0)}))})),a.add(e,"scale",.001,100).step(.01).name("缩放").onChange((e=>{this.modelGroup.children.forEach((a=>{a.scale.set(e,e,e)}))})),a.add(e,"timeScale",.1,10).name("动画速度").onChange((e=>{this.modelGroup.children.forEach((a=>{a.__action__&&Object.keys(a.__action__).forEach((t=>{a.__action__[t].timeScale=e}))}))})),a.add(e,"center").name("居中"),a.open()}addEvnGui(){const e={bgCode:"221",hdr:"skidpan_2k",color1:16777215,color2:16777215},a=this.gui.addFolder("环境"),t=this.scene.getObjectByProperty("isAmbientLight",!0);t&&a.add(t,"intensity",0,10).name("环境光强度");const s=this.scene.getObjectsByProperty("isDirectionalLight",!0);if(s.length){const[t,i]=s,n=new f(t,1,t.color);if(n.visible=!1,this.addObject(n),e.color1=t.color.getHex(),a.addColor(e,"color1").name("平行光颜色").onChange((e=>{t.color.set(e),n.traverse((a=>{a.color?a.color.set(e):a.isLine&&a.material.color.set(e)}))})),a.add(t,"intensity",0,10).name("平行光强度"),a.add(t.position,"y",500,1e5).name("平行光高度"),a.add(n,"visible").name("平行光辅助"),i){a.add(i,"visible").name("平行光2"),e.color2=i.color.getHex();const t=new f(i,1,i.color);t.visible=!1,this.addObject(t),e.color1=i.color.getHex(),a.addColor(e,"color1").name("平行光颜色").onChange((e=>{i.color.set(e),t.traverse((a=>{a.color?a.color.set(e):a.isLine&&a.material.color.set(e)}))})),a.add(i,"intensity",0,10).name("平行光2强度"),a.add(i.position,"y",500,1e5).name("平行光高度2"),a.add(t,"visible").name("平行光2辅助")}}this.groundMesh&&(a.add(this.groundMesh,"visible").name("地面"),a.add(this.renderer.shadowMap,"enabled").name("开启阴影"));a.add(e,"bgCode",["216","217","218","219","220","221","222","223","224","225"]).name("背景").onChange((e=>{Q(this.scene,e)})),a.add(e,"hdr",["skidpan_2k"].concat(new Array(20).fill(0).map(((e,a)=>String(a+1))))).name("Hdr环境").onChange((e=>{this.setEnvironment(`/oss/textures/hdr/${e}.hdr`)})),a.open()}async copyTextarea(e="复制成功！"){const a=this.container.parentNode.querySelector("textarea.gui-text");await y(),a.select(),document.execCommand("copy"),ee.success(e)}uploadedModel(e,a){if(!e)return;if(e.__upload_model__=!0,this.modelGroup){const e=this.modelGroup.children.find((e=>e.name===a));this.disposeObj(e),this.modelGroup.remove(e)}const t=this.guiOpts.scale,s=new b;e.traverse((e=>{q(s,this.guiOpts,e)})),s.children.length&&this.addHelper(s),e.name=a;let i=e.clone();const n=i.position;ae.dotText=`模型初始坐标: {\n      "x": ${n.x},\n      "y": ${n.y},\n      "z": ${n.z}\n    }`;const o=i.scale;if(i.scale.set(t*o.x,t*o.y,t*o.z),i.animations=e.animations,this.addModel(i),this.guiOpts.insetAnimate&&this.cameraViewReset(),e.animations.length){let a=new M(i);const t=e.animations.reduce(((e,t)=>{const s=t.name||"";return e[s]=a.clipAction(t),e[s].play(),e[s].timeScale=1,e}),{});i.__action__=t,i.__mixer__=a}}cameraViewReset(){H(this.camera,{x:0,y:100,z:300},this.controls.target)}judgeUploadModel(){return 0!=this.modelGroup.children.length||(ee.warning("未上传模型！"),!1)}export(e){const a=this.modelGroup.children;if(!this.judgeUploadModel())return;const t=1==a.length,s=t?a[0]:this.modelGroup,i=J(s);K(s,i,t?s.name:"综合场景",e)}glistenToggle(){let e=this.guiOpts.glisten?0:.9;this.modelGroup.traverse((a=>{a.isMesh&&(a.material instanceof Array?a.material.forEach((a=>{a.roughness=e})):a.material.roughness=e)}))}groundGlisten(){let e=this.guiOpts.groundReflection?0:.9;this.modelGroup.traverse((a=>{a.isMesh&&D.receiveShadowName.find((e=>a.name.indexOf(e)>-1))&&(a.material instanceof Array?a.material.forEach((a=>{a.roughness=e})):a.material.roughness=e)}))}sideMaterialToggle(){const e=this.guiOpts.side?l:c;this.modelGroup.traverse((a=>{a.isMesh&&(a.material instanceof Array?a.material.forEach((a=>{a.side=e})):a.material.side=e)}))}opacitySkin(){const{opacitySkin:e,opacity:a}=this.guiOpts;this.modelGroup.traverse((t=>{D.transparentName.find((e=>t.name.indexOf(e)>-1))&&V(t,e?a:1)}))}modelCenter(){this.helperGroup.children.forEach((e=>{"BoxHelper"===e.type&&(this.disposeObj(e),this.helperGroup.remove(e))}));const e=[];this.modelGroup.children.forEach((a=>{const{helper:t,center:s}=Z(a,16711680);this.addHelper(t),s.name=a.name;const{x:i,y:n,z:o}=a.position;a.position.set(i-s.x,n,o-s.z);const r=new b;let d=a.clone();r.add(d),r.animations=d.animations,e.push(a),this.addModel(d)})),e.forEach((e=>{this.disposeObj(e),this.modelGroup.remove(e)}))}addModelGroup(){const e=new b;e.name="模型组",this.addObject(e),this.modelGroup=e;const a=new b;a.name="辅助组",this.helperGroup=a,this.addObject(a)}clearModelGroup(){this.modelGroup?(this.disposeObj(this.modelGroup),this.disposeObj(this.helperGroup),this.addModelGroup()):this.addModelGroup()}addModel(e){this.modelGroup&&this.modelGroup.add(e)}addHelper(e){this.helperGroup&&this.helperGroup.add(e)}modelAnimate(){if(!this.modelGroup)return;let e=this.clock.getDelta();for(let a=0;a<this.modelGroup.children.length;a++){const t=this.modelGroup.children[a];t.__mixer__&&t.__mixer__.update(e)}}}const se=I(U({__name:"index",setup(e){const a=h({devEnv:!1,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr"}),{uploadModel:t}=(e=>{const a=N({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/"},e);return{uploadModel:(e,t,s)=>{const{baseUrl:i,dracoPath:n,basisPath:o}=a,r=e[0],d=r.name,l=d.split(".").pop().toLowerCase(),c=new FileReader;c.addEventListener("progress",(e=>{const a="("+Math.floor(e.total/1e3)+" KB)",t=Math.floor(e.loaded/e.total*100)+"%";s&&s({progress:t,filename:d,size:a})})),c.addEventListener("load",(async e=>{const a=e.target.result;if(["glb","gltf"].includes(l)){const e=new v,s=new w;s.setDecoderPath(`${i}${n}`),e.setDRACOLoader(s);const r=new G;r.setTranscoderPath(`${i}${o}`),e.setKTX2Loader(r),e.setMeshoptDecoder(C),e.parse(a,"",(a=>{var s;const i=a.scene.children;let n=new b;i.length>1?n.add(...i):n=i[i.length-1],n.name=(null==(s=n.userData)?void 0:s.name)||d,n.animations.push(...a.animations),t(n),e.dracoLoader.dispose(),e.ktx2Loader.dispose()}))}else if("fbx"==l){const e=(new O).parse(a);t(e)}})),c.readAsArrayBuffer(r)}}})({baseUrl:a.baseUrl}),s=j(),i={baseUrl:a.baseUrl,env:a.env,grid:{visible:!0},axes:{visible:!0}};let n;const o=h({accept:["fbx","glb","gltf"],fileName:""}),r=e=>{const a=e.target.files,s=a[0];let i=s.name;const r=i.split(".").pop().toLowerCase();if(!o.accept.includes(r))return _.error({message:`文件格式不正确,转换格式支持${o.accept.join("、")}！`,grouping:!0});i=s.name.substring(0,s.name.lastIndexOf(".")),o.fileName=i,t(a,(e=>{n.uploadedModel(e,i)}),(({progress:e,size:a,filename:t})=>{})),e.target.value=""};return k((()=>{i.container=s.value,n=new te(i),n.run(),B(n).resize()})),(e,a)=>(S(),A("div",{class:z(["three-page",e.$style.page])},[E(R("textarea",{class:z(["gui-text",e.$style["gui-text"]]),rows:"4",cols:"30","onUpdate:modelValue":a[0]||(a[0]=e=>T(ae).dotText=e)},null,2),[[$,T(ae).dotText]]),R("input",{class:z(e.$style.upload),type:"file",onChange:r},null,34),R("div",{class:"h-100",ref_key:"containerRef",ref:s},null,512)],2))}}),[["__cssModules",{$style:{"gui-text":"_gui-text_1sqdp_2",upload:"_upload_1sqdp_8",page:"_page_1sqdp_14"}}]]);export{se as default};
