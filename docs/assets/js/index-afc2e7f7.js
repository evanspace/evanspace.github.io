var t=Object.defineProperty,e=(e,i,o)=>(((e,i,o)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o})(e,"symbol"!=typeof i?i+"":i,o),o);import{t as i}from"./index-0e4a7414.js";import{c as o,o as s,f as n,g as r,F as a,r as c,n as l,t as h,bz as d,dc as u,eM as p,e9 as m,aL as g,dX as v,dn as _,bv as f,bw as y,bx as b,by as C,X as k,h as A,k as S,e as x,a9 as G,u as w,p as M,a8 as R,A as D}from"./vendor-0648fc2e.js";import{_ as E,d as O,A as j}from"./index-c2112bff.js";import{S as P,i as T,a as N,u as F}from"./scene-resize-c2d24791.js";import{u as z}from"./sky-8d6b28da.js";const I=E(o({__name:"first-person",setup(t){const e=[{code:"W",desc:"前进"},{code:"S",desc:"后退"},{code:"A",desc:"向左转向"},{code:"D",desc:"向右转向"},{code:"X",desc:"加速"},{code:"Z",desc:"减速"}];return(t,i)=>(s(),n("div",{class:l([t.$style.page,"character-sight"])},[r("div",{class:l(t.$style.tip)},[(s(),n(a,null,c(e,(e=>r("div",{class:l(t.$style.item)},[r("span",null,h(e.code),1),r("span",null,h(e.desc),1)],2))),64))],2),r("div",{class:l(t.$style.center)},null,2)],2))}}),[["__cssModules",{$style:{page:"_page_13ksh_2",tip:"_tip_13ksh_15",item:"_item_13ksh_22",center:"_center_13ksh_34"}}]]),B="ANCHOR_POS",L="ANCHOR_TARGET",U="MAIN_SCENE",H="MACHINE_ROOM",$="ROBOT",W="CHARACTER",V="OPEN_DOOR",J="LIGHT_SWITCH",X="WATER_PUMP",K=["CAMERA:ROAM","CAMERA:CRUISE","CAMERA:RESET","CAMERA:FIRST","CAMERA:THREE","CAMERA:MACHINEROOM","PERSON:ADD","PERSON:SUB","PERSON:ACTION","SCENE:POS","DEV:UPDATE"];const Z=new class{constructor(){e(this,"listteners",K.reduce(((t,e)=>(t[e]=new Set,t)),{}))}on(t,e){this.listteners[t].forEach((i=>{i.toString()===e.toString()&&this.listteners[t].delete(i)})),this.listteners[t].add(e)}emit(t,...e){this.listteners[t].forEach((t=>t(...e)))}},Y="https://ye6.atomgit.net/3d-demo-data",q={baseUrl:Y,indexDB:{cache:!0,dbName:"THREE__STATION__DB",tbName:"TB",version:68},clickIntervalTime:300,characterSightHeight:8,collisionSpace:1,moveFactor:1,machineRoomName:"机房",bgSrc:Y+"/imgs/station/bg.jpg",data:[{name:"1#主机",value:64092},{name:"2#主机",value:115232},{name:"制冷站水泵",value:61275.2},{name:"冷却塔",value:8619.3},{name:"1楼末端风柜",value:4856.1},{name:"2楼末端风柜",value:27567.6},{name:"3楼末端风柜",value:3310},{name:"4楼末端风柜",value:3962.5},{name:"5楼末端风柜",value:4208.1}]},Q=T,tt=N,{raycaster:et,pointer:it,update:ot,style:st}=Q.useRaycaster(),{initCSS2DRender:nt,createCSS2DDom:rt}=Q.useCSS2D(),{createDiffusion:at,updateDiffusion:ct}=Q.useDiffusion(),{createMove:lt,moveAnimate:ht}=Q.useMoveAnimate(),{createFence:dt,fenceAnimate:ut}=Q.useFence(),{createRoam:pt,executeRoam:mt,pause:gt,play:vt,getStatus:_t}=Q.useRoam(),{floorAnimate:ft}=Q.useFloor(),{keyboardPressed:yt,destroyEvent:bt,insertEvent:Ct}=Q.useKeyboardState(),{checkCollide:kt}=Q.useCollide(),{virtualization:At,closeVirtualization:St}=Q.useModelLoader({}),xt="FULL",Gt="NPC",wt=q.baseUrl;class Mt extends P{constructor(t,i){super(t),e(this,"buildingGroup"),e(this,"deviceGroup"),e(this,"anchorGroup"),e(this,"dotGroup"),e(this,"lightGroup"),e(this,"extend"),e(this,"css2DRender"),e(this,"mouseClickDiffusion"),e(this,"character"),e(this,"characterSightHeight",q.characterSightHeight),e(this,"floorGroup"),e(this,"currentSight"),e(this,"historyTarget"),e(this,"historyCameraPosition"),e(this,"animateModels"),e(this,"moveFactor",q.moveFactor),e(this,"collisionSpace",q.collisionSpace),e(this,"fence"),e(this,"water"),this.extend=i,this.css2DRender=nt(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=at(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.createClock(),this.currentSight=xt,this.historyTarget=new d,this.historyCameraPosition=new d,this.animateModels=[],this.bindEvent(),this.addBuildingGroup(),this.addDeviceGroup(),this.addFloorGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup(),console.log(this)}addBuildingGroup(){const t=new u;t.name="建筑组",this.buildingGroup=t,this.addObject(t)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearDevice(),this.clearAnchor(),this.clearDot(),this.clearFloor()}addBuilding(...t){this.buildingGroup&&this.buildingGroup.add(...t)}addDeviceGroup(){const t=new u;t.name="设备组",this.deviceGroup=t,this.addObject(t)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup()}addDevice(...t){this.deviceGroup&&this.deviceGroup.add(...t)}addAnchorGroup(){const t=new u;t.name="锚点组",this.anchorGroup=t,this.addObject(t)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(t){this.anchorGroup&&this.anchorGroup.add(t);const{x:e,y:i,z:o}=t.position;tt.createSpriteAnimate(t,[e,i,o],1,8)}addDotGroup(){const t=new u;t.name="点位组",t.visible=!1,this.dotGroup=t,this.addObject(t)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(t,e){var i;const o=t.position,{size:s,color:n}=t.font||{},{x:r=0,y:a=0,z:c=0}=o||{},l=rt({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[r,a,c],onClick:e});return l.name=t.name,l.data=t,l._position_={x:r,y:a,z:c},null==(i=this.dotGroup)||i.add(l),l}addFloorGroup(){const t=new u;t.name="楼层组",this.floorGroup=t,this.addObject(t)}clearFloor(){this.floorGroup&&this.disposeObj(this.floorGroup),this.addFloorGroup()}addFloor(...t){this.floorGroup&&this.floorGroup.add(...t)}addLightGroup(){const t=new u;t.name="灯光组",this.lightGroup=t,this.addObject(t)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}closeLightGroup(t=!1){var e;null==(e=this.lightGroup)||e.children.forEach((e=>{e.isSpotLight&&(e.visible=t)}))}addLight(t,e,i){if(this.lightGroup){e.name=t.name;const o=t.position||{x:0,y:0,z:0},{to:s={x:o.x,y:o.y-2,z:o.z}}=t;if(e.target.position.set(s.x,s.y,s.z),e.visible=!1,this.lightGroup.add(e),this.lightGroup.add(e.target),i){const t=new p(e,e.color);this.lightGroup.add(t)}}}lightSwitch(t){var e,i;const o=null==(i=this.lightGroup)?void 0:i.getObjectsByProperty("name",null==(e=t.data)?void 0:e.bind);o&&o.forEach((t=>{t.visible=!t.visible}))}addWater(t){const e=this.scene.getObjectByName(t);if(!e)return;console.log(e);const i=(t=>{const e=t?t.geometry:new f(200,200),i=new y(e,{textureWidth:512,textureHeight:512,waterNormals:(new b).load(wt+"/textures/waternormals.jpg",(t=>{t.wrapS=t.wrapT=C})),sunDirection:new d,sunColor:15732480,waterColor:92299,distortionScale:3.7});return i.material.uniforms.size.value=.5,i})(e),o=e.getWorldPosition(new d);i.position.copy(o),e.position.y-=.2,this.water&&this.scene.remove(this.water),this.water=i,this.addBuilding(this.water)}addCharacter(t,e){const{x:i,y:o,z:s}=e;t.position.set(i,o,s),this.character=t;const n=t.animations,r=new m(t),a={};for(let d=0;d<n.length;d++){const t=n[d],e=r.clipAction(t);a[t.name]=e}const c="Idle";a[c].play();const l=a.Walking;t.extra={key:c,mixer:r,actions:a,runging:l},this.addObject(t);const h=["W","S"].map((t=>t.toUpperCase().charCodeAt(0)));Ct((e=>{t.__runing__||(h.includes(e.keyCode)&&l.play(),this.isCharacterSight()&&(yt("X")&&this.characterAccelerate(1),yt("Z")&&this.characterAccelerate(-1)))}),(e=>{t.__runing__||h.includes(e.keyCode)&&l.stop()}))}changeCharacterAction(){if(!this.character)return;let{key:t,actions:e}=this.character.extra;const i=["Idle","Running","Dance","Death","Sitting","Standing","Jump","Punch","ThumbsUp","WalkJump","Yes","No","Wave"];let o=i.findIndex((e=>e===t))||0;e[t].stop(),o++,o>=i.length&&(o=0),t=i[o],e[t].play(),g.success({message:["空闲","跑步","舞蹈","散架","坐着","站立","弹跳","出拳","点赞","行走跳跃","点头","摇头","打招呼"][o],grouping:!0}),this.character.extra.key=t}toggleSight(t){if(this.clearCoolMachineRoomFocus(),this.judgeCruise())return;const e=this.currentSight==xt?Gt:xt;this.currentSight=e;const i=e===Gt;if(!this.controls)return;if(this.controls.maxDistance=i?3==t?20:0:800,this.controls.enablePan=!i,!this.character)return;const o=i&&1==t;this.character.visible=!o;const s=this.character.position;this.toggleCharacterView();const n=new d(0,this.characterSightHeight,0);if(i){g.success({message:"鼠标点击地面移动，或键盘 W、S 前后移动，A、D调整左右方向，X 加速，Z 减速!",grouping:!0}),this.historyTarget=this.controls.target.clone(),this.historyCameraPosition=this.camera.position.clone();const t=s.clone().add(n);this.camera.lookAt(t)}else this.camera.position.copy(this.historyCameraPosition),this.camera.lookAt(s);const r=(i?s:this.historyTarget).clone().add(n);this.controls.target.copy(r)}isCharacterSight(){return this.currentSight==Gt}clearCharacterSight(){this.currentSight=xt,this.character&&(this.character.visible=!0),this.toggleCharacterView()}toggleCharacterView(){var t;const e=null==(t=this.container.parentNode)?void 0:t.querySelector(".character-sight");if(!e)return;const i=this.currentSight===Gt;e.style.display=i?"block":"none"}characterAccelerate(t=1){this.moveFactor+=t,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),g.success({message:"人物速度："+this.moveFactor,grouping:!0})}setControlTarget(t){if(!this.controls)return;const{x:e,y:i,z:o}=t;this.controls.target.set(e,i+this.characterSightHeight,o),this.camera.lookAt(this.controls.target)}mouseClickGround(t){if(this.currentSight!==Gt)return Promise.reject();const e=this.character;if(!e)return Promise.reject();const{runing:i}=this.options.cruise;if(i)return Promise.reject();const o=t.point,s=this.mouseClickDiffusion,{runging:n}=e.extra;n.play();const{x:r,y:a,z:c}=o;return s.position.set(r,a,c),s.visible=!0,e.__runing__=!0,new Promise((t=>{lt(e,o,((t,i)=>{this.setControlTarget(t),this.checkCharacterCollide(t,2)&&(i(),n.stop(),e.__runing__=!1,s.visible=!1)}),(i=>{this.setControlTarget(i),n.stop(),e.__runing__=!1,s.visible=!1,t(e)}))}))}checkCharacterCollide(t,e=.3){var i;if(!this.character)return;const o=kt(this.character,t,(null==(i=this.buildingGroup)?void 0:i.children)||[],!0,new d(0,e,0));if(o.length){if(o[0].distance<this.collisionSpace)return g.warning({message:"撞到了！",grouping:!0}),!0}}getAnimTargetPos(t,e,i){if(!this.controls)return;const o=e||t.to||{x:-104,y:7,z:58},s=i||t.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),o}addModelAnimate(t,e=[],i=!0,o=1){if(!e.length)return;const s=new m(t),n=e.reduce(((t,e)=>{const n=e.name||"";return t[n]=s.clipAction(e),i&&t[n].play(),t[n].timeScale=o,t}),{});t.__action__=n,t.__mixer__=s,this.animateModels.push(t)}cameraTransition(t){var e;if(this.clearCoolMachineRoomFocus(),this.judgeCruise())return;if(this.mouseClickDiffusion.visible)return void g.warning({message:"人物移动中，不可操作！",grouping:!0});this.clearCharacterSight();const{to:i,target:o=t.position}=t.data;if(!i)return;if(!this.isCameraMove(i)&&this.controls){const t=new d(i.x,i.y,i.z).distanceTo(new d(o.x,o.y,o.z));this.controls.maxDistance=t,tt.cameraLinkageControlsAnimate(this.controls,this.camera,i,o)}const{bind:s}=t.data;if(!s)return;const n=null==(e=this.buildingGroup)?void 0:e.getObjectByName(s);this.addFence(n)}addFence(t){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),t){const e=dt(t,5439406);this.fence=e,this.addObject(e)}}cameraLookatMoveTo(t){return new Promise(((e,i)=>this.judgeCruise(!0)||this.isCharacterSight()?i(!1):void(this.controls&&(this.controls.maxDistance=100,tt.cameraLookatAnimate(this.camera,t,this.controls.target).then((()=>{this.controls&&(this.controls.maxDistance=800),e(this.camera)}))))))}toggleCruise(t){_t()?g.warning({message:"请退出漫游！",grouping:!0}):super.toggleCruise(t)}judgeCruise(t){return this.options.cruise.runing?!t&&(g.warning({message:"请退出巡航！",grouping:!0}),!0):!!_t()&&(!t&&(g.warning({message:"请退出漫游！",grouping:!0}),!0))}controlReset(){this.judgeCruise()||(this.clearCharacterSight(),this.controls&&(this.controls.maxDistance=800,super.controlReset(),this.historyTarget=(new d).copy(this.controls.target),this.historyCameraPosition=(new d).copy(this.camera.position)))}setRoamPoint(t){this.extend.roamPoints=t}toggleRoam(){if(this.clearCoolMachineRoomFocus(),!this.controls)return;if(_t())return gt(),void(this.controls.maxDistance=800);const t=this.extend.roamPoints||[];0!=t.length&&(this.controls.maxDistance=20,pt({points:t,tension:.3}),vt())}floorExpand(t){const e=t.data,i=this.getFloorByGroup(e.group);if(!i.length)return;const o=i.findIndex((e=>t.uuid===e.uuid));ft(i,o,(t=>this.getFlowMark(t)))}getMachineRoomStatus(t){const e=this.scene.getObjectByName(t);return{isFocus:null==e?void 0:e.__isFocus__,room:e}}toCoolMachineRoom(){var t,e;if(this.judgeCruise())return;this.clearCharacterSight();const{room:i,isFocus:o}=this.getMachineRoomStatus(q.machineRoomName);if(i){if(i.__isFocus__=!o,o)return St(null==(t=this.buildingGroup)?void 0:t.children),void this.toggleCoolMachineRoomFocus(!1);this.toggleCoolMachineRoomFocus(!0),At((null==(e=this.buildingGroup)?void 0:e.children)||[],i,{wireframe:!0,hidden:!0,opacity:.1,filter:[]})}else g.warning({message:"未找到机房模块！",grouping:!0})}toggleCoolMachineRoomFocus(t){if(!this.controls)return;let e=this.historyTarget,i=this.historyCameraPosition;t&&(this.historyTarget=(new d).copy(this.controls.target),this.historyCameraPosition=(new d).copy(this.camera.position),e=new d(-78.4,-33,29.2),i={x:-3.62,y:-27.53,z:18.14});const o=e.distanceTo(i);this.controls.maxDistance=o,this.dotGroup&&(this.dotGroup.visible=t),tt.cameraLinkageControlsAnimate(this.controls,this.camera,i,e)}clearCoolMachineRoomFocus(){var t;const{room:e,isFocus:i}=this.getMachineRoomStatus(q.machineRoomName);i&&St(null==(t=this.buildingGroup)?void 0:t.children),e.__isFocus__=!1,this.dotGroup&&(this.dotGroup.visible=!1)}openTheDoor(t){const e=this.scene.getObjectByName(t.data.bind);e&&(e.__open__=!e.__open__,new v(e.rotation).to({y:e.__open__?.5*Math.PI:0},1500).delay(0).start())}modelAnimate(){var t,e;this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let i=(null==(t=this.clock)?void 0:t.getDelta())||0;if(this.animateModels.length&&this.animateModels.forEach((t=>{t.__mixer__&&t.__mixer__.update(i)})),this.anchorGroup){if(this.anchorGroup.children.forEach((t=>{t.__mixer__&&t.__mixer__.update(i)})),this.character){this.character.extra.mixer.update(i),ht(.5*this.moveFactor)}if(this.mouseClickDiffusion.visible&&ct(),ut(),mt(this.camera,this.controls),this.isCharacterSight()&&!(null==(e=this.character)?void 0:e.__runing__)){const t=10*i,e=.2*Math.PI*i,o=this.character;if(!o)return;const s=yt("S");if(yt("W")||s){const e=new d;null==o||o.getWorldDirection(e);const i=e.clone().multiplyScalar(s?-t:t),n=(null==o?void 0:o.position.clone().add(i))||new d;if(this.checkCharacterCollide(n));else{if(null==o||o.position.copy(n),s){const i=e.clone().multiplyScalar(2*-t);this.camera.position.copy(this.camera.position.clone().add(i))}this.setControlTarget(null==o?void 0:o.position)}}yt("A")?(o.rotation.y+=e,this.keyboardToTotation()):yt("D")&&(o.rotation.y-=e,this.keyboardToTotation())}this.water&&(this.water.material.uniforms.time.value+=1/60)}}keyboardToTotation(){var t;const e=this.character,i=new d;null==e||e.getWorldDirection(i);const o=(null==(t=this.controls)?void 0:t.maxDistance)||1,s=i.clone().multiplyScalar(-o),n=(null==e?void 0:e.position.clone().setY(this.camera.position.y).add(s))||new d;this.camera.position.copy(n),this.setControlTarget(null==e?void 0:e.position)}setDblclickModelName(t){this.extend.dblclickModelName=t}onDblclick(t){var e;const i=this.container,o=this.options.scale;if(ot(t,i,o),this.floorGroup&&this.buildingGroup){et.setFromCamera(it,this.camera);const t=this.floorGroup.children.concat(this.buildingGroup.children),i=et.intersectObjects(t);if(i.length){const t=i[0].object,o=this.findParentGroup(t,this.extend.dblclickModelName);if(!o)return;"function"==typeof(null==(e=this.extend)?void 0:e.onDblclick)&&this.extend.onDblclick(o)}}}onPointerMove(t){this.checkIntersectObjects(t)}onPointerUp(t){var e;super.onPointerUp(t);const i=t.timeStamp-this.pointer.tsp<q.clickIntervalTime;2==t.button?i&&"function"==typeof(null==(e=this.extend)?void 0:e.onClickRight)&&this.extend.onClickRight(t):0==t.button?i&&this.checkIntersectObjects(t):t.button}checkIntersectObjects(t){var e,i,o,s,n;const r=this.container,a=this.options.scale;ot(t,r,a);let c="pointerdown"==t.type||"pointerup"==t.type;const l=(null==(i=this.buildingGroup)?void 0:i.children.filter((t=>t.visible&&(c||t.__ground__))).concat((null==(e=this.anchorGroup)?void 0:e.children)||[]))||[];et.setFromCamera(it,this.camera);let h=et.intersectObjects(l,c);if(c)if(r.style.cursor="auto",h.length){const t=h[0],e=t.object;console.log(t);const i="string"==typeof e.name&&(this.extend.groundMeshName||[]).some((t=>e.name.indexOf(t)>-1)),n=this.findParentGroup(e);if(i&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickGround)&&this.extend.onClickGround(n,t),!n)return;"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft(n,t)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(h)}hoverAnchor(t){var e,i;if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(t[0],st),t.length){const i=t[0].object;if(this.container.style.cursor=i._isAnchor_?"pointer":"auto",!i._isAnchor_)return;const o=i.material;void 0===i.__mat_color__&&(i.__mat_color__=o.color),o.color=new _(16715760),null==(e=this.anchorGroup)||e.children.forEach((t=>{t.__change_color__=t.uuid===i.uuid}))}else this.container.style.cursor="auto",null==(i=this.anchorGroup)||i.children.forEach((t=>{t.__change_color__=!1}))}restoreAnchorMaterial(){var t;null==(t=this.anchorGroup)||t.traverse((t=>{t.isSprite&&!t.__change_color__&&t.__mat_color__&&(t.material.color=t.__mat_color__)}))}findParentGroup(t,e=[]){const i=t=>{if(t._isBuilding_||e.includes(t.name))return t;let o=t.parent;return o?i(o):void 0};return i(t)}getAll(){var t,e,i,o;return(null==(o=this.buildingGroup)?void 0:o.children.concat((null==(t=this.dotGroup)?void 0:t.children)||[]).concat((null==(e=this.floorGroup)?void 0:e.children)||[]).concat((null==(i=this.anchorGroup)?void 0:i.children)||[]))||[]}getFloorByGroup(t){var e;return null==(e=this.floorGroup)?void 0:e.children.filter((e=>e.data.group===t))}getFlowMark(t){return this.getAll().filter((e=>{var i;return(null==(i=e.data)?void 0:i.followMark)===t}))}resize(){super.resize();const{width:t,height:e}=this.options;this.css2DRender.setSize(t,e)}dispose(){bt(),this.animateModels=[],this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.fence),this.disposeObj(this.mouseClickDiffusion),this.disposeObj(this.floorGroup),this.disposeObj(this.lightGroup),this.clock=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.character=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.fence=void 0,this.mouseClickDiffusion=void 0,this.floorGroup=void 0,this.lightGroup=void 0,this.extend={},super.dispose()}}const Rt=(t,e)=>{let i=40*Math.random();const o="Hz"===t.unit;if(o)i=Number((35+4*Math.random()).toFixed(2));else{const e=q.data.find((e=>e.name===t.name));e&&(i=e.value+Number((5*Math.random()-10).toFixed(2)))}return t.value=i,t.show=!o||Math.random()>.5,t.value=Number(Number(t.value||0).toFixed(2)),{value:t.value,show:t.show,font:{...t.font||{}}}},Dt={class:"scene-operation"},Et=["onClick"],Ot=["innerHTML"],jt=E(o({__name:"index",setup(t){const e=k((o=(t,e,i,o)=>{if(lt){(o+=.02)>1&&(o-=1),t=((t,e=0)=>new d(t.x,t.y+e,t.z))(i.getPointAt(o));let s=o+.001;s>1&&(s-=1),e=i.getPointAt(s),lt.position.set(t.x,27.5,t.z);const n=Math.atan2(-e.z+t.z,e.x-t.x);lt.rotation.z=.5*Math.PI+n}},{devEnv:!1,bgColor:"",skyCode:"104",env:"/textures/hdr/6.hdr",dotKey:"DOT",dotShowStrict:!0,config:{},anchorType:[B,L,V,J],animationModelType:[U,H,X],floorModelType:["floor_common"],models:[{key:U,name:"场景",size:78.8,url:"/深圳北站.glb"},{key:H,name:"机房",size:3.8,url:"/机房.glb"},{key:X,name:"水泵",size:.1,url:"/水泵.glb"},{key:B,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/dw.png"},{key:L,name:"锚点",type:"sprite",range:{x:4,y:4},mapUrl:"/dw.png"},{key:V,name:"开门",type:"sprite",range:{x:2,y:2},mapUrl:"/pos.png"},{key:$,name:"机器人",size:.3,url:"/models/common/机器人.glb"},{key:W,name:"人物",size:.3,url:"/models/common/RootNode.glb"},{key:"waiting_room_spot_light",type:"spotlight",name:"聚光灯",intensity:2,color:16775378,penumbra:.5,castShadow:!1,angle:.4*Math.PI,distance:40},{key:J,name:"开关灯",type:"sprite",mapUrl:"/light.png",range:{x:2,y:2}}].map((t=>(t.url&&t.url.indexOf("models")<0&&(t.url="/models/station"+t.url),t.mapUrl&&(t.mapUrl="/textures/station"+t.mapUrl),t))),cruise:{visible:!0,auto:!0,mapUrl:"https://ye6.atomgit.net/3d-demo-data/textures/cruise/line5.png",repeat:[.1,1],width:2,segment:100,tension:0,speed:20,mapSpeed:.01,points:[],offset:1.8,animateBack:o},roamPoints:[]}));var o;const u=k({show:!1,style:{left:0,top:0},msg:""}),{skys:p}=z(),{backgroundLoad:m}=T.useBackground(q.baseUrl+"/sky/",p),{progress:g,loadModels:v,getModel:_,initModels:f}=T.useModelLoader({baseUrl:q.baseUrl,indexDB:q.indexDB}),{options:y}=T.useDialog(),b=A(),C={baseUrl:q.baseUrl,env:e.env,cruise:e.cruise,controls:{enableDamping:!0,dampingFactor:.48,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:800},render:{alpha:!0,preserveDrawingBuffer:!0},camera:{near:.1,fov:52,position:[222.54,150.82,589.31]},directionalLight:{intensity:2.2}};let E;S((()=>{C.container=b.value,E=new Mt(C,{groundMeshName:["行走地面","平面125","平面126","平面127","平面128","平面129","平面130","楼梯","机房地面","地面005","地面006","立方体128","立方体780_1","11111","22222"],roamPoints:e.roamPoints,onDblclick:t=>{if(t&&t._isFloor_)E.floorExpand(t);else{const e=E.extend.dblclickModelName||[],i=t.name;if(e.includes(i)){const t=Q.value.find((t=>t.bind===i));t&&ut(t)}}},onClickLeft:(t,e)=>{y.select=[],y.show=!1,t&&t.data&&P(t)},onClickGround:(t,e)=>{E.mouseClickGround(e)},onHoverAnchor:(t,e)=>{const i=!!t&&t.object._isAnchor_;if(u.show=i,i){u.style.top=e.top,u.style.left=e.left;const i=t.object.data;u.msg=`\n          <p>${i.name}</p>\n          <p>类型：${i.type}</p>\n          <p>绑定：${i.bind||"无"}</p>\n        `}},animateCall:()=>{if(y.show&&y.select&&y.select.length){const t=y.select[0];nt(t)}}}),E.run(),F(E).resize(),K()}));const P=t=>{const e=t.data;switch(null==e?void 0:e.type){case B:E.cameraTransition(t);break;case L:y.select=[t],rt();break;case V:E.openTheDoor(t);break;case J:E.lightSwitch(t)}},K=()=>{tt(),m(E,e.skyCode),(t=>{Z.on("CAMERA:ROAM",(()=>null==t?void 0:t.toggleRoam())),Z.on("CAMERA:CRUISE",(()=>null==t?void 0:t.toggleCruise())),Z.on("CAMERA:RESET",(()=>null==t?void 0:t.controlReset())),Z.on("CAMERA:FIRST",(()=>null==t?void 0:t.toggleSight(1))),Z.on("CAMERA:THREE",(()=>null==t?void 0:t.toggleSight(3))),Z.on("CAMERA:MACHINEROOM",(()=>null==t?void 0:t.toCoolMachineRoom())),Z.on("PERSON:ADD",(()=>null==t?void 0:t.characterAccelerate())),Z.on("PERSON:SUB",(()=>null==t?void 0:t.characterAccelerate(-1))),Z.on("PERSON:ACTION",(()=>null==t?void 0:t.changeCharacterAction())),Z.on("SCENE:POS",(()=>null==t?void 0:t.getPosition()))})(E)},Y=A([]),Q=x((()=>Y.value.filter((t=>t.type===B)))),tt=()=>{v(e.models,(()=>{O.get(j.d3.station).then((async t=>{let i={};if(t.ConfigJson instanceof Object)i=t.ConfigJson;else if("string"==typeof t.ConfigJson)try{i=JSON.parse(t.ConfigJson)}catch(s){}Y.value=t.JsonList;const o=Q.value.filter((t=>t.bind)).map((t=>t.bind||""));null==E||E.setDblclickModelName(o),e.cruise.points=i.cruise||[],e.roamPoints=i.roamPoints||[],Object.keys(i).forEach((t=>{e.config&&(e.config[t]=i[t])})),await et(),null==E||E.addWater("水流"),ht(),dt(),at()}))}))},et=async()=>{E.clearBuilding(),await G(),await f(Y.value,it),E.setRoamPoint(e.roamPoints),E.setCruisePoint(e.cruise.points);const t=E.getValidTargetPosition(e.config||{});E.camera.position.set(t.x,t.y,t.z),g.percentage=100,g.show=!1,E.controlSave()},it=async t=>{if(!t)return;const{type:i}=t;if(i===B)return;const o=_(i);if(!o)return void(i===e.dotKey&&st(t));const{anchorType:s=[],animationModelType:n=[],floorModelType:r=[]}=e;let a=N.modelDeepClone(o);const{position:c,scale:l,rotation:h}=N.get_P_S_R_param(a,t),[d,u,p]=c;return a.scale.set(...l),a.position.set(d,u,p),a.rotation.set(...h),a._isBuilding_=!0,a.data=t,n.includes(i)&&E.addModelAnimate(a,o.animations,i!==X,1),(t.followMark||t.mark)&&(a._position_={x:d,y:u,z:p}),s.includes(i)?(a._isAnchor_=!0,E.addAnchor(a)):a.isSpotLight?E.addLight(t,a,!0):r.includes(i)?(a._position_={x:d,y:u,z:p},a._isFloor_=!0,E.addFloor(a)):i===X?(a._isDevice_=!0,a.name=t.name,E.addDevice(a)):E.addBuilding(a),Promise.resolve()},ot=t=>{var i;const o=t.data;{const t=Rt(o,E.buildingGroup);"object"==typeof t&&Object.keys(t).forEach((e=>{o[e]=t[e]}))}t.visible=o.show||!e.dotShowStrict;const s=null==(i=t.element)?void 0:i.getElementsByClassName("inner")[0];if(s){const{size:t,color:e}=o.font||{};null!=t&&(s.style.fontSize="string"==typeof t?t:t+"px"),null!=e&&(s.style.color=e),s.textContent=`${o.value||0}${o.unit}`}},st=t=>{ot(E.addDot(t,((e,i)=>{y.select=[i],rt(),E.cameraLookatMoveTo(t.position).then((()=>{}))})))},nt=t=>{const e=b.value,i=N.getPlanePosition(e,t,E.camera);return y.position=i,y.style&&(y.style.left=i.left+"px",y.style.top=i.top+"px"),i},rt=()=>{if(!y.select)return;const t=y.select[0].data;y.data=t,y.title=(null==t?void 0:t.name)||"";const{x:e,y:i,z:o}=(null==t?void 0:t.position)||{};y.list=[{name:"坐标",value:`${e},${i},${o}`},{name:"Hz"===(null==t?void 0:t.unit)?"频率":"用电",value:null==t?void 0:t.value,unit:null==t?void 0:t.unit}],y.show=!0},at=()=>{E.getAll().forEach(((t,i)=>{if(!t.data)return;return t.data.type===e.dotKey?(ot(t),void ct(t.data)):void 0}))},ct=t=>{var e;const{show:i,name:o}=t,s=null==(e=E.deviceGroup)?void 0:e.getObjectByName(o);s&&s.__action__&&Object.keys(s.__action__).forEach((t=>{const e=s.__action__[t];i?(e.isRunning()||e.play(),e.paused=!1):e.paused=!0}))};let lt;const ht=()=>{lt=_($),lt.position.z=27.5,lt.rotation.z=.5*Math.PI,E.addObject(lt)},dt=()=>{const t=_(W);t.traverse((t=>{t.isMesh&&(t.castShadow=!0)}));t.scale.setScalar(2),E.addCharacter(t,{x:-65.8,y:-34.8,z:22.3})},ut=t=>{E.cameraTransition({position:t.position,data:t})};return(t,e)=>(s(),n("div",{class:l(t.$style.page)},[r("div",Dt,[r("div",{class:"btn",onClick:e[0]||(e[0]=()=>at())},"随机更新"),r("div",{class:"btn",onClick:e[1]||(e[1]=()=>w(Z).emit("SCENE:POS"))},"场景坐标"),r("div",{class:"btn",onClick:e[2]||(e[2]=()=>w(E).exportImage())},"截图"),r("div",{class:"item",onClick:e[3]||(e[3]=()=>w(Z).emit("CAMERA:ROAM"))},"全景漫游"),r("div",{class:"item",onClick:e[4]||(e[4]=()=>w(Z).emit("CAMERA:MACHINEROOM"))},"制冷机房"),(s(!0),n(a,null,c(w(Q),(t=>(s(),n("div",{class:"item",onClick:e=>ut(t)},h(t.name),9,Et)))),256)),r("div",{class:"item",onClick:e[5]||(e[5]=()=>w(Z).emit("CAMERA:CRUISE"))},"定点巡航"),r("div",{class:"item",onClick:e[6]||(e[6]=()=>w(Z).emit("CAMERA:RESET"))},"视角重置"),r("div",{class:"item",onClick:e[7]||(e[7]=()=>w(Z).emit("CAMERA:FIRST"))},"第一人称"),r("div",{class:"item",onClick:e[8]||(e[8]=()=>w(Z).emit("CAMERA:THREE"))},"第三人称"),r("div",{class:"item",onClick:e[9]||(e[9]=()=>w(Z).emit("PERSON:ACTION"))},"人物动作"),r("div",{class:"item",onClick:e[10]||(e[10]=()=>w(Z).emit("PERSON:ADD"))},"人物加速"),r("div",{class:"item",onClick:e[11]||(e[11]=()=>w(Z).emit("PERSON:SUB"))},"人物减速")]),r("div",{class:l(t.$style.container),ref_key:"containerRef",ref:b},null,2),M(I),M(i,{modelValue:w(g).show,"onUpdate:modelValue":e[12]||(e[12]=t=>w(g).show=t),progress:w(g).percentage,"bg-src":w(q).bgSrc},null,8,["modelValue","progress","bg-src"]),w(u).show?(s(),n("div",{key:0,class:l(t.$style.tip),style:R({left:w(u).style.left+"px",top:w(u).style.top+"px"})},[r("div",{class:l(t.$style.msg),innerHTML:w(u).msg},null,10,Ot)],6)):D("",!0),w(y).show?(s(),n("div",{key:1,class:l(t.$style.dialog),style:R(w(y).style)},[r("div",{class:l(t.$style.wrap)},[r("div",null,h(w(y).title),1),r("div",{class:l(t.$style.content)},[(s(!0),n(a,null,c(w(y).list,(e=>(s(),n("div",{class:l(t.$style.item)},[r("span",null,h(e.name)+"：",1),r("span",null,h(e.value)+h(e.unit||""),1)],2)))),256))],2)],2)],6)):D("",!0)],2))}}),[["__cssModules",{$style:{page:"_page_1dbjl_2",container:"_container_1dbjl_10",tip:"_tip_1dbjl_16",dialog:"_dialog_1dbjl_17",msg:"_msg_1dbjl_27",wrap:"_wrap_1dbjl_42",title:"_title_1dbjl_53",content:"_content_1dbjl_56",item:"_item_1dbjl_59"}}]]);export{jt as default};
