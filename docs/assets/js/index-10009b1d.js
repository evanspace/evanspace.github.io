var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{E as a,p as s,u as i}from"./scene-resize-8dc6e04b.js";import{bx as r,fA as o,dO as n,fB as l,dg as d,da as c,bA as p,ec as h,eb as u,ed as m,eA as y,di as g,fC as b,fD as v,bz as w,fE as f,e as x,i as S,l as P,o as C,g as M,h as A,n as D}from"./vendor-9734da72.js";import{_ as z}from"./index-dbb4b4ea.js";const O=s,{insertEvent:I,destroyEvent:V,keyboardPressed:k}=O.useKeyboardState(),{loadModel:j,openDB:B}=O.useModelLoader({baseUrl:"https://raw.githubusercontent.com/zlevan/3d-demo-data/main"}),{raycaster:E,pointer:G,update:W}=O.useRaycaster();let _=new r,T=new r(0,1,0),F=new r,L=new r,N=new o,R=new n,U=new l;class $ extends a{constructor(e,a){super(e,a),t(this,"params",{firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-60,playerSpeed:20,physicsSteps:5}),t(this,"gui",new d),t(this,"group",new c),t(this,"player",new p),t(this,"playerIsOnGround",!1),t(this,"collider"),t(this,"visualizer"),this.createPerson(),this.createClock(),this.addGui(),this.loadModel(),I((e=>{"Space"===e.code&&this.playerIsOnGround&&(_.y=30,this.playerIsOnGround=!1)})),this.bindEvent()}createScene(){return new h}createDirectionalLight(e,t){return new u(e,t)}createAmbientLight(e,t){return new m(e,t)}createPerson(){const e=new p(new y(1,2,1,10,.5),new g);e.geometry.translate(0,.5,0);e.geometry.computeBoundingBox(),e.userData.capsuleInfo={radius:2.5,segment:new l(new r,new r(0,2,0).multiplyScalar(5))},e.castShadow=!0,e.receiveShadow=!0,e.material.shadowSide=2,e.scale.setScalar(5),this.player=e,this.addObject(e),this.reset()}async loadModel(){return await B(),this.loadCompany()}loadCompany(){j({key:"company",name:"场景",size:13.6,url:"/models/office/公司总部.glb"}).then((e=>{const t=e.getObjectByName("透明_边界");t&&(t.material.opacity=1,t.parent.remove(t),t.clear()),e.position.y-=25,e.updateMatrixWorld(!0),this.addObject(e),this.createCollider(e)}))}createCollider(e){this.group=e;const t=this.params,a=this.gui,s=a.addFolder("模型");s.add(e.position,"y").name("上下位置").listen(),s.add(t,"physicsSteps",0,30,1).name("步骤"),s.add(t,"gravity",-200,100,.01).name("重力").onChange((e=>{t.gravity=Number(e)})),s.add(t,"playerSpeed",1,100).name("人物速度");const i=new b(e);i.attributes=["position"];const r=i.generate();r.boundsTree=new v(r);const o=new p(r,new w({wireframe:!0,transparent:!0,opacity:.5}));o.visible=!1,this.collider=o,this.addObject(o);const n=new f(o,t.visualizeDepth);n.visible=!1,this.visualizer=n,this.addObject(n);const l=a.addFolder("碰撞因素");l.add(o,"visible").name("碰撞器"),l.add(n,"visible").name("可视化"),l.add(t,"visualizeDepth",1,20,1).name("可视化深度").onChange((e=>{n.depth=e,n.update()}))}addGui(){var e;const t=this.params,a=this.gui;a.add(t,"firstPerson").name("第一人称").onChange((e=>{const t=this.controls;t&&(e?(t.maxPolarAngle=Math.PI,t.maxDistance=1e-4):(this.camera.position.sub(null==t?void 0:t.target).normalize().multiplyScalar(10).add(t.target),t.maxPolarAngle=Math.PI/2,t.maxDistance=200))})),a.add({log:()=>console.log(this)},"log").name("场景数据"),a.add({reset:()=>this.reset()},"reset").name("重置"),a.domElement.className+=" gui-wrap",null==(e=this.container.parentElement)||e.appendChild(a.domElement)}onPointerUp(e){W(e,this.container,1),E.setFromCamera(G,this.camera);let t=E.intersectObjects(this.group.children,!0);console.log(t[0])}reset(){const e=this.player,t=this.camera,a=this.controls;if(!a)return;_.set(0,0,0);const s=new r(155,-20,304).multiplyScalar(1);e.position.copy(s),t.position.sub(a.target),a.target.copy(e.position),t.position.add(e.position),a.update()}keyboardPressedControl(e){const t=this.params,a=this.player,s=this.controls;if(!s)return;const i=s.getAzimuthalAngle();k("W")&&(F.set(0,0,-1).applyAxisAngle(T,i),a.position.addScaledVector(F,t.playerSpeed*e)),k("S")&&(F.set(0,0,1).applyAxisAngle(T,i),a.position.addScaledVector(F,t.playerSpeed*e)),k("A")&&(F.set(-1,0,0).applyAxisAngle(T,i),a.position.addScaledVector(F,t.playerSpeed*e)),k("D")&&(F.set(1,0,0).applyAxisAngle(T,i),a.position.addScaledVector(F,t.playerSpeed*e))}updateCalcVar(){const e=this.player,t=this.collider;if(!t)return;const a=e.userData.capsuleInfo;N.makeEmpty(),R.copy(t.matrixWorld).invert(),U.copy(a.segment),U.start.applyMatrix4(e.matrixWorld).applyMatrix4(R),U.end.applyMatrix4(e.matrixWorld).applyMatrix4(R),N.expandByPoint(U.start),N.expandByPoint(U.end),N.min.addScalar(-a.radius),N.max.addScalar(a.radius)}bvhCollionCheck(){const e=this.player,t=this.collider;if(t&&t.geometry.boundsTree){const a=e.userData.capsuleInfo;t.geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(N),intersectsTriangle:e=>{const t=F,s=L,i=e.closestPointToSegment(U,t,s);if(i<a.radius){const e=a.radius-i,r=s.sub(t).normalize();U.start.addScaledVector(r,e),U.end.addScaledVector(r,e)}}})}}playerMove(e){const t=this.player,a=this.collider;if(!a)return;const s=F;s.copy(U.start).applyMatrix4(a.matrixWorld);const i=L;i.subVectors(s,t.position);const r=Math.max(0,i.length()-1e-5);i.normalize().multiplyScalar(r),t.position.add(i),this.playerIsOnGround=i.y>Math.abs(e*_.y*.25),this.playerIsOnGround?_.set(0,0,0):(i.normalize(),_.addScaledVector(i,-i.dot(_)))}updatePlayer(e){const t=this.params,a=this.player,s=this.collider,i=this.camera,o=this.controls;if(!o||!s)return;this.playerIsOnGround?_.y=e*t.gravity:_.y+=e*t.gravity,a.position.addScaledVector(_,e),this.keyboardPressedControl(e),a.updateMatrixWorld(),this.updateCalcVar(),this.bvhCollionCheck(),this.playerMove(e),i.position.sub(o.target);const n=a.position.clone().add(new r(0,10,0));o.target.copy(n),i.position.add(n),a.position.y<-25&&this.reset()}modelAnimate(){var e;const t=Math.min((null==(e=this.clock)?void 0:e.getDelta())||.1,.1),a=this.params.physicsSteps;if(this.collider)for(let s=0;s<a;s++)this.updatePlayer(t/a)}dispose(){V(),super.dispose()}}const H={b:1,c:"1"}["b"];console.log(H);const K=z(x({__name:"index",setup(e){const t=S(),a={axes:{visible:!0},grid:{visible:!0,fork:!0},camera:{near:1e-10,position:[100,100,-100]},controls:{enablePan:!1,maxPolarAngle:Math.PI/2,minDistance:1e-4,maxDistance:200}};let s;return P((()=>{s=new $(a,t.value).run(),i(s).resize()})),(e,a)=>(C(),M("div",{class:D(["three-page",e.$style.page])},[A("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)],2))}}),[["__cssModules",{$style:{}}]]);export{K as default};
