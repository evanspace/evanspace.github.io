var t=Object.defineProperty,e=(e,i,o)=>(((e,i,o)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o})(e,"symbol"!=typeof i?i+"":i,o),o);import{e as i,ed as o,ee as s,o as n,g as a,h as r,t as l,q as c,B as d,c as h,au as u,F as p,r as m,n as g,bq as _,dQ as v,dO as y,bn as f,bi as C,ej as b,el as A,bj as S,dy as R,eo as E,d6 as k,ep as x,eq as O,bk as T,br as G,d0 as L,Y as M,c6 as w,i as I,f as D,l as N,u as P,a7 as H,a8 as j,m as z,p as U,I as B,a9 as F,ak as V,aa as W}from"./vendor-d1041bbb.js";import{t as $,_ as Y,d as K,A as J,k as q,s as Z}from"./index-a1e24267.js";import{t as X}from"./index-5eff9c5e.js";import{m as Q,s as tt,$ as et,u as it}from"./scene-resize-f7f57085.js";const ot={key:0,class:"screen-welcom-dialog"},st={class:"wrap"},nt={class:"body"},at={class:"title"},rt={class:"bg"},lt={class:"text"},ct={class:"content"},dt=i({__name:"edit-dialog",props:o({title:{},errMessage:{}},{modelValue:{type:Boolean},modelModifiers:{},content:{},contentModifiers:{}}),emits:o(["confirm"],["update:modelValue","update:content"]),setup(t,{emit:e}){const i=t,o=s(t,"modelValue"),p=s(t,"content"),m=e,g=()=>{$(p.value||"")?(o.value=!1,m("confirm",p.value)):h.warning({message:i.errMessage,grouping:!0})};return(t,e)=>{const i=u;return o.value?(n(),a("div",ot,[r("div",{class:"mask",onClick:e[0]||(e[0]=t=>o.value=!o.value)}),r("div",st,[r("div",nt,[r("div",at,[r("div",rt,l(t.title),1),r("div",lt,l(t.title),1)]),r("div",ct,[c(i,{type:"textarea",modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=t=>p.value=t),placeholder:"请输入",maxlength:"24","show-word-limit":""},null,8,["modelValue"])]),r("div",{class:"footer"},[r("div",{class:"btn",onClick:g})])])])])):d("",!0)}}}),ht=Y(i({__name:"first-person",setup(t){const e=[{code:"W",desc:"前进"},{code:"S",desc:"后退"},{code:"A",desc:"向左转向"},{code:"D",desc:"向右转向"},{code:"X",desc:"加速"},{code:"Z",desc:"减速"}];return(t,i)=>(n(),a("div",{class:g([t.$style.page,"character-sight"])},[r("div",{class:g(t.$style.tip)},[(n(),a(p,null,m(e,(e=>r("div",{class:g(t.$style.item)},[r("span",null,l(e.code),1),r("span",null,l(e.desc),1)],2))),64))],2),r("div",{class:g(t.$style.center)},null,2)],2))}}),[["__cssModules",{$style:{page:"_page_13ksh_2",tip:"_tip_13ksh_15",item:"_item_13ksh_22",center:"_center_13ksh_34"}}]]),ut="ANCHOR_POS",pt="ANCHOR_TARGET",mt="MAIN_SCENE",gt="campany_floor",_t="curtain",vt="ROBOT",yt="CHARACTER",ft="WAIT_LIFT",Ct="LIGHT_SWITCH",bt="LIGHT_MAIN_SWITCH",At="AIR_SWITCH",St="GATE_SWITCH",Rt="DOUBLE_HORIZONTAL_SWITCH",Et="DOUBLE_ROTATE_SWITCH",kt="ODD_ROTATE_SWITCH",xt="VIDEO_SWITCH",Ot="SCREEN_EDIT",Tt="CURTAIN_SWITCH",Gt=["CAMERA:ROAM","CAMERA:CRUISE","CAMERA:RESET","CAMERA:FIRST","CAMERA:THREE","CAMERA:GATE","CAMERA:RECCEPTION","CAMERA:OFFICE","CAMERA:LCR","CAMERA:BOSS","PERSON:ADD","PERSON:SUB","LIGHT:RECCEPTION","LIGHT:AILSE","LIGHT:PM","LIGHT:HOST","LIGHT:LCR","LIGHT:CLG","LIGHT:CLOSE","LIGHT:AUTO","CURTAIN:TOGGLE","DOOR:COMPANY","DOOR:LCR","DOOR:BOSS","SCREEN:COMPANY","SCREEN:WELCOM","SCREEN:SCR","SCREEN:LCR","AIR:MAIN","AIR:ODD","SCENE:POS","SKY:DAY","SKY:EVENING","SKY:NIGHT"];const Lt=new class{constructor(){e(this,"listteners",Gt.reduce(((t,e)=>(t[e]=new Set,t)),{}))}on(t,e){this.listteners[t].forEach((i=>{i.toString()===e.toString()&&this.listteners[t].delete(i)})),this.listteners[t].add(e)}emit(t,...e){this.listteners[t].forEach((t=>t(...e)))}},Mt=300,wt=3.5,It=1,Dt=1,Nt=tt,Pt=et,{raycaster:Ht,pointer:jt,update:zt,style:Ut}=Nt.useRaycaster(),{initCSS2DRender:Bt,createCSS2DDom:Ft}=Nt.useCSS2D(),{createDiffusion:Vt,updateDiffusion:Wt}=Nt.useDiffusion(),{createMove:$t,moveAnimate:Yt}=Nt.useMoveAnimate(),{createFence:Kt,fenceAnimate:Jt}=Nt.useFence(),{keyboardPressed:qt,destroyEvent:Zt,insertEvent:Xt}=Nt.useKeyboardState(),{checkCollide:Qt}=Nt.useCollide(),{dubleHorizontal:te,dubleRotate:ee,oddRotate:ie}=Nt.useOpenTheDoor(),{createRoam:oe,executeRoam:se,pause:ne,play:ae,getStatus:re}=Nt.useRoam(),le={}.VITE_BEFORE_STATIC_PAT||"",ce="FULL",de="NPC",he=t=>{const e=document.createElement("video");return e.src=le+(t||"/oss/textures/park/sintel.mp4"),e.loop=!0,e},ue=(new _).load(le+"/oss/textures/office/cover.jpg"),pe=(new _).load(le+"/oss/textures/office/wind.png");class me extends Q{constructor(t,i){super(t),e(this,"buildingGroup"),e(this,"anchorGroup"),e(this,"dotGroup"),e(this,"lightGroup"),e(this,"extend"),e(this,"css2DRender"),e(this,"mouseClickDiffusion"),e(this,"character"),e(this,"characterSightHeight",wt),e(this,"currentSight"),e(this,"historyTarget"),e(this,"historyCameraPosition"),e(this,"animateModels",[]),e(this,"videoModels",[]),e(this,"canvasTextures",[]),e(this,"moveFactor",Dt),e(this,"collisionSpace",It),e(this,"fence"),e(this,"ambientLight",new v),e(this,"directionalLight",new y),this.extend=i,this.css2DRender=Bt(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=Vt(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.createClock(),this.currentSight=ce,this.historyTarget=new f,this.historyCameraPosition=new f,this.findLight(),this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup()}setEnv(t){this.scene.environment=t,this.scene.background=t}findLight(){const t=this.scene.getObjectByProperty("isAmbientLight",!0);this.ambientLight=t;const e=this.scene.getObjectByProperty("isDirectionalLight",!0);this.directionalLight=e}toByday(){var t;this.ambientLight.intensity=this.options.ambientLight.intensity,this.directionalLight.intensity=this.options.directionalLight.intensity;const e=null==(t=this.extend.sky)?void 0:t.day;this.loadEnvTexture(e)}toEvening(){var t;this.ambientLight.intensity=.01,this.directionalLight.intensity=.5;const e=null==(t=this.extend.sky)?void 0:t.evening;this.loadEnvTexture(e)}toNight(){var t;this.ambientLight.intensity=.01,this.directionalLight.intensity=0;const e=null==(t=this.extend.sky)?void 0:t.night;this.loadEnvTexture(e)}addBuildingGroup(){const t=new C;t.name="建筑组",this.buildingGroup=t,this.addObject(t)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot()}addBuilding(...t){this.buildingGroup&&this.buildingGroup.add(...t)}addAnchorGroup(){const t=new C;t.name="锚点组",this.anchorGroup=t,this.addObject(t)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(t){this.anchorGroup&&this.anchorGroup.add(t);const{x:e,y:i,z:o}=t.position;Pt.createSpriteAnimate(t,[e,i,o],.2,8)}addDotGroup(){const t=new C;t.name="点位组",this.dotGroup=t,this.scene.add(t)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(t,e){var i;const o=t.position,{size:s,color:n}=t.font||{},{x:a=0,y:r=0,z:l=0}=o||{},c=Ft({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,r,l],onClick:e});return c.name=t.name,c.data=t,c._position_={x:a,y:r,z:l},null==(i=this.dotGroup)||i.add(c),c}addLightGroup(){const t=new C;t.name="灯光组",this.lightGroup=t,this.addObject(t)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}closeLightGroup(t=!1){var e;null==(e=this.lightGroup)||e.children.forEach((e=>{(e.isSpotLight||e.isRectAreaLight)&&(e.visible=t)}))}addLight(t,e,i){if(this.lightGroup){e.name=t.name;const o=t.position||{x:0,y:0,z:0},{to:s={x:o.x,y:o.y-2,z:o.z}}=t;if(e.isRectAreaLight||(e.target.position.set(s.x,s.y,s.z),this.lightGroup.add(e.target)),e.visible=!0,this.lightGroup.add(e),i)if(e.isRectAreaLight){const t=new b(e);this.lightGroup.add(t)}else{const t=new A(e,e.color);this.lightGroup.add(t)}}}drawCanvas(t=""){if(!this.extend.canvas)return;const e=this.extend.canvas,i=e.offsetWidth,o=e.offsetHeight;e.width=i,e.height=o;const s=e.getContext("2d");if(!s)return;s.clearRect(0,0,i,o),s.fillStyle="#f00";const n=t.length,a=n>12?Math.ceil(n/2):12;let r=[],l=0;for(;l<n;){const e=l+a;r.push(t.substring(l,e)),l=e}s.font="100 40px 微软雅黑",s.textAlign="center",s.textBaseline="middle";const c=r.length;r.forEach(((t,e)=>{const n=e*c+1;s.fillText(t,i/2,o/c/2*n)})),this.canvasTextures.length&&this.canvasTextures.forEach((t=>{t.needsUpdate=!0}))}addCharacter(t,e){const{x:i,y:o,z:s}=e;t.position.set(i,o,s),this.character=t;const n=t.animations,a=new S(t),r={};for(let d=0;d<n.length;d++){const t=n[d],e=a.clipAction(t);r[t.name]=e}r.Dance.play();const l=r.Walking;t.extra={mixer:a,actions:r,runging:l},this.addObject(t);const c=["W","S"].map((t=>t.toUpperCase().charCodeAt(0)));Xt((e=>{t.__runing__||(c.includes(e.keyCode)&&l.play(),this.isCharacterSight()&&(qt("X")&&this.characterAccelerate(1),qt("Z")&&this.characterAccelerate(-1)))}),(e=>{t.__runing__||c.includes(e.keyCode)&&l.stop()}))}toggleSight(t){if(this.judgeCruise())return;this.judgeAndStopRoam();const e=this.currentSight==ce?de:ce;this.currentSight=e;const i=e===de;if(!this.controls)return;if(this.controls.maxDistance=i?3==t?10:0:800,this.controls.screenSpacePanning=!i,this.controls.enablePan=!i,!this.character)return;const o=this.character.position;this.toggleCharacterView();const s=new f(0,this.characterSightHeight,0);if(i){h.success({message:"鼠标点击地面移动，或键盘 W、S 前后移动，A、D调整左右方向，X 加速，Z 减速!",duration:15e3}),this.historyTarget=this.controls.target.clone(),this.historyCameraPosition=this.camera.position.clone();const t=o.clone().add(s);this.camera.lookAt(t),Math.abs(this.camera.position.y-t.y)>8&&(this.camera.position.y=t.y)}else this.camera.position.copy(this.historyCameraPosition),this.camera.lookAt(o);const n=(i?o:this.historyTarget).clone().add(s);this.controls.target.copy(n)}isCharacterSight(){return this.currentSight==de}clearCharacterSight(){this.currentSight=ce,this.toggleCharacterView()}toggleCharacterView(){var t;const e=null==(t=this.container.parentNode)?void 0:t.querySelector(".character-sight");if(!e)return;const i=this.currentSight===de;e.style.display=i?"block":"none"}characterAccelerate(t=1){this.moveFactor+=t,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),h.success({message:"人物速度："+this.moveFactor,grouping:!0})}setControlTarget(t){this.controls&&(this.controls.target.copy(t.clone().add(new f(0,this.characterSightHeight,0))),this.camera.lookAt(this.controls.target))}waitLift(t,e){var i;const o=t.data.target,s=this.scene.getObjectByName(o),n=null==(i=t.data)?void 0:i.to;if(!s||!n)return;const a=s.position;if(Math.abs(n.y-a.y)>.2){const i=s.__bind_lift__;void 0!==i&&this.dubleHorizontalDoor({data:{bind:i}},2.3,!1),this.dubleHorizontalDoor({data:{bind:o}},2.3,!1).then((()=>{const i=5e3;h.success({message:`${o}移动中，请稍候，5秒后到达!`,duration:i}),new R(a).to({y:n.y},i).delay(0).start().onUpdate((t=>{if(e){if(!this.character)return;this.character.position.y=t.y,this.camera.position.y=t.y,this.setControlTarget(this.character.position)}})).onComplete((()=>{s.__bind_lift__=t.data.bind,this.openLift(t,o)}))}))}else this.openLift(t,o)}openLift(t,e){this.dubleHorizontalDoor(t,2.3),this.dubleHorizontalDoor({data:{bind:e}},2.3)}lightSwitch(t,e,i){var o,s;const n=null==(s=this.lightGroup)?void 0:s.getObjectsByProperty("name",null==(o=t.data)?void 0:o.bind);n&&n.forEach(((t,o)=>{let s=!(null!=i&&i>=0)&&(null!=e?e:!t.visible);null!=i&&i>=0&&o<i&&(s=null==e||e),t.visible=s}))}dubleHorizontalDoor(t,e=400,i){const{bind:o,axle:s="z"}=t.data;return te(this.scene,{value:o,axle:s,scale:e,isOpen:i})}oddRotateDoor(t){const{bind:e,axle:i="y",internal:o,autoClose:s=!1}=t.data;return ie(this.scene,{value:e,axle:i,angle:Math.PI*(o?-.5:.5),autoClose:s})}dubleRotateDoor(t){const{bind:e,axle:i="y",left:o="右",right:s="左",internal:n,autoClose:a=!0}=t.data;return ee(this.scene,{value:e,axle:i,autoClose:a,angle:Math.PI*(n?-.5:.5),leftMatch:o,rightMatch:s})}openGate(t){return this.dubleRotateDoor(t)}toggleCurtain(t,e){const i=this.animateModels.find((e=>{var i;return e.name===(null==(i=t.data)?void 0:i.bind)}));if(!i)return;i.__open__=e??!i.__open__;const{__action__:o,__mixer__:s}=i;Object.keys(o).forEach((t=>{i.__open__&&(o[t].loop=E,o[t].clampWhenFinished=!0,o[t].play())})),i.__open__||s.stopAllAction()}addVideoMaterial(t){var e,i;const o=new k({map:ue});this.videoModels=[];for(let s=0;s<t.length;s++){const n=t[s],a=null==(e=this.buildingGroup)?void 0:e.getObjectByName(n);if(!a)continue;const r=null==(i=this.lightGroup)?void 0:i.getObjectByName(n+"-照明灯");r&&(r.visible=!0);const l=he(),c=new x(l);a.__video_texture__=c,a.__cover_texture__=ue.clone(),a.material=o.clone(),a.__video__=l,this.videoModels.push(a)}}addCanvasMaterial(t){var e;if(!this.extend.canvas)return;const i=new k({map:new O(this.extend.canvas),side:T});this.canvasTextures=[];for(let o=0;o<t.length;o++){const s=this.scene.getObjectByName(t[o]);s&&(s.material=i.clone(),s.__cover_texture__=null==(e=i.map)?void 0:e.clone(),this.canvasTextures.push(s.material.map))}}clearVideo(){const t=this.videoModels;for(let e=0;e<t.length;e++){const i=t[e],{__video__:o,__cover_texture__:s,__video_texture__:n}=i;o&&(o.pause(),o.remove(),null==s||s.dispose(),null==n||n.dispose())}}videoPlay(t){const e=this.scene.getObjectByName(t.data.bind);if(e&&e.__video__){const t=e.__video__;t.paused?(e.material.map=e.__video_texture__,null==t||t.play()):(null==t||t.pause(),e.material.map=e.__cover_texture__)}}addAirWindMaterial(t){pe.wrapS=G,pe.repeat.x=1;const e=new k({color:13033215,map:pe,transparent:!0,side:T});for(let i=0;i<t.length;i++){const o=this.scene.getObjectByName(t[i]);if(!o)return;o.traverse((t=>{t.isMesh&&(t.material=e)})),o.visible=!1}}toggleAir(t,e){const i=this.scene.getObjectByName(t.data.bind);i&&(i.__open__=e??!i.__open__,i.visible=i.__open__)}mouseClickGround(t,e){if(this.currentSight!==de)return Promise.reject();const i=this.character;if(!i)return Promise.reject();const{runing:o}=this.options.cruise;if(o)return Promise.reject();const s=t.point,n=this.mouseClickDiffusion,{runging:a}=i.extra;return a.play(),n.position.copy(s),n.visible=!0,i.__runing__=!0,new Promise((o=>{$t(i,s,((o,s)=>{this.setControlTarget(o),this.checkCharacterCollide(o,e.includes(t.object.name)?2:.3)&&(s(),a.stop(),i.__runing__=!1,n.visible=!1)}),(t=>{this.setControlTarget(t),a.stop(),i.__runing__=!1,n.visible=!1,o(i)}))}))}checkCharacterCollide(t,e=.3){var i;if(!this.character)return;const o=Qt(this.character,t,(null==(i=this.buildingGroup)?void 0:i.children)||[],!0,new f(0,e,0));if(o.length){if(o[0].distance<this.collisionSpace)return h.warning({message:"撞到了！",grouping:!0}),!0}}cameraLookatMoveTo(t){this.controls&&Pt.cameraLookatAnimate(this.camera,t,this.controls.target)}judgeCruise(){return!!this.options.cruise.runing&&(h.warning({message:"请退出巡航！",grouping:!0}),!0)}addModelAnimate(t,e=[],i=!0,o=1){if(!e.length)return;const s=new S(t),n=e.reduce(((t,e)=>{const n=e.name||"";return t[n]=s.clipAction(e),i&&t[n].play(),t[n].timeScale=o,t}),{});t.__action__=n,t.__mixer__=s,this.animateModels.push(t)}cameraTransition(t){var e;if(this.judgeCruise())return;if(this.mouseClickDiffusion.visible)return void h.warning({message:"人物移动中，不可操作！",grouping:!0});this.clearCharacterSight();const{to:i,target:o=t.position}=t.data;if(!i)return;!this.isCameraMove(i)&&this.controls&&(this.judgeAndStopRoam(),this.controls.enablePan=!0,this.controls.maxDistance=5,Pt.cameraLinkageControlsAnimate(this.controls,this.camera,i,o));const{bind:s}=t.data;if(!s)return;const n=null==(e=this.buildingGroup)?void 0:e.getObjectByName(s);this.addFence(n)}addFence(t){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),t){const e=Kt(t,5439406);this.fence=e,this.addObject(e)}}controlReset(){this.judgeAndStopRoam(),this.clearCharacterSight(),this.controls&&(this.controls.enablePan=!0,this.controls.maxDistance=1500,this.controls.maxPolarAngle=.48*Math.PI,super.controlReset())}judgeAndStopRoam(){return!!re()&&(this.controls&&(this.controls.maxDistance=1500),ne(),!0)}setRoamPoint(t){this.extend.roamPoints=t}toggleRoam(){if(this.clearCharacterSight(),this.judgeAndStopRoam())return;const t=this.extend.roamPoints||[];0!=t.length&&this.controls&&(this.controls.maxDistance=5,oe({points:t,segment:6,tension:0,speed:2,close:!1,factor:1}),ae())}modelAnimate(){var t,e,i;this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let o=null==(t=this.clock)?void 0:t.getDelta();if(this.animateModels.length&&this.animateModels.forEach((t=>{t.__mixer__&&t.__mixer__.update(o)})),null==(e=this.anchorGroup)||e.children.forEach((t=>{t.__mixer__&&t.__mixer__.update(o)})),this.character){this.character.extra.mixer.update(o),Yt(.2*this.moveFactor)}if(this.mouseClickDiffusion.visible&&Wt(),Jt(),this.isCharacterSight()&&!(null==(i=this.character)?void 0:i.__runing__)){const t=1+this.moveFactor/5,e=5*o*t,i=.2*Math.PI*o*t,s=this.character;if(!s)return;const n=qt("S");if(qt("W")||n){const t=new f;null==s||s.getWorldDirection(t);const i=t.clone().multiplyScalar(n?-e:e),o=(null==s?void 0:s.position.clone().add(i))||new f;this.checkCharacterCollide(o)||(null==s||s.position.copy(o),this.setControlTarget(null==s?void 0:s.position))}qt("A")?(s.rotation.y+=i,this.keyboardToTotation()):qt("D")&&(s.rotation.y-=i,this.keyboardToTotation())}se(this.camera,this.controls),pe&&(pe.offset.x+=.02)}keyboardToTotation(){var t;const e=this.character,i=new f;null==e||e.getWorldDirection(i);const o=(null==(t=this.controls)?void 0:t.maxDistance)||1,s=i.clone().multiplyScalar(-o),n=(null==e?void 0:e.position.clone().setY(this.camera.position.y).add(s))||new f;this.camera.position.copy(n),this.setControlTarget(null==e?void 0:e.position)}onPointerMove(t){this.checkIntersectObjects(t)}onPointerUp(t){var e;super.onPointerUp(t);const i=t.timeStamp-this.pointer.tsp<Mt;2==t.button?i&&"function"==typeof(null==(e=this.extend)?void 0:e.onClickRight)&&this.extend.onClickRight(t):0==t.button?i&&this.checkIntersectObjects(t):t.button}checkIntersectObjects(t){var e,i,o,s,n;const a=this.container,r=this.options.scale;zt(t,a,r);let l="pointerdown"==t.type||"pointerup"==t.type;const c=(null==(i=this.buildingGroup)?void 0:i.children.filter((t=>t.visible&&(l||t.__ground__))).concat((null==(e=this.anchorGroup)?void 0:e.children)||[]))||[];Ht.setFromCamera(jt,this.camera);let d=Ht.intersectObjects(c,l);if(l)if(a.style.cursor="auto",d.length){const t=d[0],e=t.object,i="string"==typeof e.name&&(this.extend.groundMeshName||[]).some((t=>e.name.indexOf(t)>-1)),n=this.findParentGroup(e);if(i&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickGround)&&this.extend.onClickGround(n,t),!n)return;"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft(n,t)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(d)}hoverAnchor(t){var e,i;if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(t[0],Ut),t.length){const i=t[0].object;if(this.container.style.cursor=i._isAnchor_?"pointer":"auto",!i._isAnchor_)return;const o=i.material;void 0===i.__mat_color__&&(i.__mat_color__=o.color),o.color=new L(16715760),null==(e=this.anchorGroup)||e.children.forEach((t=>{t.__change_color__=t.uuid===i.uuid}))}else this.container.style.cursor="auto",null==(i=this.anchorGroup)||i.children.forEach((t=>{t.__change_color__=!1}))}restoreAnchorMaterial(){var t;null==(t=this.anchorGroup)||t.traverse((t=>{t.isSprite&&!t.__change_color__&&t.__mat_color__&&(t.material.color=t.__mat_color__)}))}findParentGroup(t){const e=t=>{if(t._isBuilding_)return t;let i=t.parent;return i?i&&i._isBuilding_?i:e(i):void 0};return e(t)}getAll(){var t,e;return(null==(e=this.buildingGroup)?void 0:e.children.concat((null==(t=this.dotGroup)?void 0:t.children)||[]))||[]}resize(){super.resize();const{width:t,height:e}=this.options;this.css2DRender.setSize(t,e)}dispose(){Zt(),this.animateModels=[],this.clearVideo(),this.videoModels=[],this.canvasTextures=[],this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.fence),this.disposeObj(this.lightGroup),this.disposeObj(this.mouseClickDiffusion),this.clock=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.character=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.lightGroup=void 0,this.fence=void 0,this.mouseClickDiffusion=void 0,this.extend={},super.dispose()}}const ge=(t,e)=>{const i=40*Math.random();return void 0!==i&&(t.value=i),t.show=Math.random()>.5,t.value=Number(Number(t.value||0).toFixed(2)),{value:t.value,show:t.show,font:{...t.font||{},color:"#"+(16777215+1e6*i).toString(16).substring(0,6)}}},_e={class:"scene-operation"},ve=["onClick"],ye=["innerHTML"],fe="welcom.key",Ce=Y(i({__name:"index",setup(t){const e=et,i=tt,o=M((s=(t,e,i,o)=>{if(!$)return;(o+=.02)>1&&(o-=1),t=((t,e=0)=>new f(t.x,t.y+e,t.z))(i.getPointAt(o));let s=o+.001;s>1&&(s-=1),e=i.getPointAt(s),$.position.set(t.x,.1,t.z);const n=Math.atan2(-e.z+t.z,e.x-t.x);$.rotation.z=.5*Math.PI+n},{devEnv:!0,baseUrl:"",env:"/oss/textures/hdr/101.hdr",sky:{day:"/oss/textures/hdr/101.hdr",evening:"/oss/textures/hdr/201.hdr",night:"/oss/textures/hdr/301.hdr"},config:{},dotKey:"DOT",dotShowStrict:!1,anchorType:[ut,pt,ft,Ct,bt,At,St,xt,Ot,Rt,kt,Et,Tt],animationModelType:[mt,gt,_t],models:[{key:mt,name:"场景",size:14,url:"/公司总部.glb"},{key:"floor_low",name:"低层",size:6.1,url:"/低层.glb"},{key:_t,name:"窗帘",size:.2,url:"/窗帘.glb"},{key:"floor_heigh",name:"高层",size:2.7,url:"/高层.glb"},{key:gt,name:"公司",size:16.6,url:"/二十五楼.glb"},{key:ut,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/pos.png"},{key:pt,name:"锚点",type:"sprite",mapUrl:"/dw.png"},{key:ft,name:"电梯门",type:"sprite",mapUrl:"/lift.png"},{key:Rt,name:"双横推开关门",type:"sprite",mapUrl:"/lift.png"},{key:Et,name:"双旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:kt,name:"单旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:St,name:"闸机",type:"sprite",mapUrl:"/gate.png"},{key:xt,name:"视频",type:"sprite",mapUrl:"/video.png"},{key:Ot,name:"编辑",type:"sprite",mapUrl:"/edit.png"},{key:Tt,name:"窗帘",type:"sprite",mapUrl:"/curtain.png"},{key:vt,name:"机器人",size:.3,url:"/oss/model/park/机器人.glb"},{key:yt,name:"人物",size:2.2,url:"/oss/model/park/RobotExpressive.glb"},{key:"spot_light_floor_1",type:"spotlight",name:"聚光灯",intensity:8,color:16777197,distance:20},{key:"spot_light_floor_2",type:"spotlight",name:"聚光灯",intensity:2,color:16777197,distance:10},{key:"spot_light_floor_3",type:"spotlight",name:"屏幕聚光灯",intensity:2,color:16777197,distance:15,penumbra:.5,castShadow:!1,angle:.36*Math.PI},{key:"rect_area_light_1",type:"planelight",name:"面光灯",intensity:1.5,color:16777215,width:134,height:134},{key:Ct,name:"开关灯",type:"sprite",mapUrl:"/light.png"},{key:bt,name:"开关灯",type:"sprite",mapUrl:"/light.png"},{key:At,name:"空调",type:"sprite",mapUrl:"/air.png"}].map((t=>(t.url&&t.url.indexOf("oss")<0&&(t.url="/oss/model/office"+t.url),t.mapUrl&&(t.mapUrl="/oss/textures/office"+t.mapUrl),t.range||(t.range={x:.8,y:.8}),t))),cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line18.png",repeat:[1,1],width:2,segment:100,tension:.01,speed:10,mapSpeed:.1,points:[],close:!0,offset:5.2,animateBack:s},roamPoints:[]}));var s;const h=M({active:2,show:!1,targetName:"",list:[{target:"电梯-2",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-2_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_2_grp"}]},{target:"电梯-1",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-1_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_1_grp"}]}]}),u=M({show:!1,style:{left:0,top:0},msg:""}),{progress:_,loadModels:v,getModel:y}=i.useModelLoader({baseUrl:o.baseUrl,indexDB:{cache:!0,dbName:"THREE__OFFICE__DB",tbName:"TB",version:72}}),C=I(),b=I(),A={env:o.env,cruise:o.cruise,controls:{visible:!0,enableDamping:!0,dampingFactor:.25,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:1500},camera:{near:3,fov:45},directionalLight:{intensity:4,light2:!1},ambientLight:{intensity:.01},axes:{visible:!0,size:1e3}};let S;const R=D((()=>{var t;return(null==(t=h.list.find((t=>t.target===h.targetName)))?void 0:t.items)||[]})),{options:E}=(t=>{const e=M({show:!1,...t});return{options:e,show:w(e.show),filters:M({})}})({title:"编辑欢迎词",content:q(fe)||"中碳能源",errMessage:"请输入欢迎词！"}),k=t=>{var e;const i=t.data;{const t=ge(i,S.buildingGroup);"object"==typeof t&&Object.keys(t).forEach((e=>{i[e]=t[e]}))}t.visible=i.show||!o.dotShowStrict;const s=null==(e=t.element)?void 0:e.getElementsByClassName("inner")[0];if(s){const{size:t,color:e}=i.font||{};null!=t&&(s.style.fontSize="string"==typeof t?t:t+"px"),null!=e&&(s.style.color=e),s.textContent=`${i.value||0}${i.unit}`}},x=async t=>{if(!t)return;const{type:i}=t;if(i===ut)return;const s=y(i);if(!s)return void(i===o.dotKey&&(t=>{k(S.addDot(t,(e=>{S.cameraLookatMoveTo(t.position)})))})(t));const{anchorType:n=[],animationModelType:a=[]}=o;let r=e.modelDeepClone(s);const{position:l,scale:c,rotation:d}=e.get_P_S_R_param(r,t),[h,u,p]=l;return r.scale.set(...c),r.position.set(h,u,p),r.rotation.set(...d),r._isBuilding_=!0,r.data=t,a.includes(i)&&S.addModelAnimate(r,s.animations,i!==_t,1),n.includes(i)?(r._isAnchor_=!0,S.addAnchor(r)):r.isSpotLight||r.isRectAreaLight?S.addLight(t,r,!1):S.addBuilding(r),Promise.resolve()},O=()=>new Promise((async t=>{_.percentage=100,_.show=!1,S.clearBuilding(),await W(),await(()=>{let t=0,e=T.value.length;return new Promise((i=>{if(0==e)return i(null);const o=async()=>{const s=T.value[t];await x(s),t++,t<e?o():i(t)};o()}))})(),S.setRoamPoint(o.roamPoints),S.setCruisePoint(o.cruise.points);const i=S.getValidTargetPosition(o.config||{});e.cameraInSceneAnimate(S.camera,i,S.controls.target).then((()=>{S.controlSave(),setTimeout((()=>{Lt.emit("LIGHT:CLOSE"),t(1)}),3e3)}))})),T=I([]),G=D((()=>T.value.filter((t=>t.type===ut)))),L=()=>{v(o.models,(()=>{K.get(J.d3.office).then((async t=>{let e={};if(t.ConfigJson instanceof Object)e=t.ConfigJson;else if("string"==typeof t.ConfigJson)try{e=JSON.parse(t.ConfigJson)}catch(i){}T.value=t.JsonList,Object.keys(e).forEach((t=>{o.config&&(o.config[t]=e[t])})),o.cruise.points=e.cruise||[],o.roamPoints=e.roamPoints||[],await O(),Y(),Q(),Lt.emit("SCREEN:WELCOM",E.content),S.addVideoMaterial(t.JsonList.filter((t=>t.type===xt)).map((t=>t.bind))),S.addCanvasMaterial(t.JsonList.filter((t=>t.type===Ot)).map((t=>t.bind))),S.addAirWindMaterial(t.JsonList.filter((t=>t.type===At)).map((t=>t.bind)))}))}))};let $;const Y=()=>{$=y(vt),$.position.z=.1,$.rotation.z=.5*Math.PI,S.addObject($)},Q=()=>{const t=y(yt);t.traverse((t=>{t.isMesh&&(t.castShadow=!0)}));t.scale.setScalar(.75);const e=t.getObjectByName("HandL"),i=t.getObjectByName("HandR");e.visible=!1,i.visible=!1,S.addCharacter(t,{x:14.4,y:184.6,z:37.6})},ot=()=>{L(),(t=>{Lt.on("CAMERA:ROAM",(()=>null==t?void 0:t.toggleRoam())),Lt.on("CAMERA:CRUISE",(()=>null==t?void 0:t.toggleCruise())),Lt.on("CAMERA:RESET",(()=>null==t?void 0:t.controlReset())),Lt.on("CAMERA:FIRST",(()=>null==t?void 0:t.toggleSight(1))),Lt.on("CAMERA:THREE",(()=>null==t?void 0:t.toggleSight(3))),Lt.on("CAMERA:GATE",(()=>{null==t||t.cameraTransition({data:{name:"一楼大门",type:"ANCHOR_POS",to:{x:-1.3,y:6.2,z:102.3},target:{x:-1.4,y:5.8,z:97.4}}})})),Lt.on("CAMERA:RECCEPTION",(()=>{null==t||t.cameraTransition({data:{name:"公司前台",type:"ANCHOR_POS",to:{x:15.3,y:188,z:33.2},target:{x:15.3,y:188,z:36.3}}})})),Lt.on("CAMERA:OFFICE",(()=>{null==t||t.cameraTransition({data:{name:"办公区域",type:"ANCHOR_POS",to:{x:-38,y:188,z:35.3},target:{x:-35.4,y:188,z:36.4}}})})),Lt.on("CAMERA:LCR",(()=>{null==t||t.cameraTransition({data:{name:"大会议室",type:"ANCHOR_POS",to:{x:-28.8,y:188,z:52.7},target:{x:-33.7,y:188,z:53.4}}})})),Lt.on("CAMERA:BOSS",(()=>{null==t||t.cameraTransition({data:{name:"领导办公",type:"ANCHOR_POS",to:{x:69.4,y:188,z:-.4},target:{x:65,y:188,z:-2.7}}})})),Lt.on("PERSON:ADD",(()=>null==t?void 0:t.characterAccelerate())),Lt.on("PERSON:SUB",(()=>null==t?void 0:t.characterAccelerate(-1))),Lt.on("LIGHT:RECCEPTION",((e,i)=>{null==t||t.lightSwitch({data:{bind:"前台聚光灯"}},e,i)})),Lt.on("LIGHT:AILSE",((e,i)=>{null==t||t.lightSwitch({data:{bind:"区域A"}},e,i)})),Lt.on("LIGHT:PM",((e,i)=>{null==t||t.lightSwitch({data:{bind:"区域B"}},e,i)})),Lt.on("LIGHT:HOST",((e,i)=>{null==t||t.lightSwitch({data:{bind:"主机照明灯"}},e,i)})),Lt.on("LIGHT:LCR",((e,i)=>{null==t||t.lightSwitch({data:{bind:"大会议室照明灯"}},e,i)})),Lt.on("LIGHT:CLG",(e=>{null==t||t.lightSwitch({data:{bind:"公司主灯光组"}},e)})),Lt.on("LIGHT:CLOSE",(e=>null==t?void 0:t.closeLightGroup(e))),Lt.on("LIGHT:AUTO",((e,i,o)=>null==t?void 0:t.lightSwitch(e,i,o))),Lt.on("CURTAIN:TOGGLE",(e=>{null==t||t.toggleCurtain({data:{bind:"_GROUP_013_grp"}},e)})),Lt.on("DOOR:COMPANY",(()=>{null==t||t.dubleHorizontalDoor({data:{bind:"_公司大门_grp",axle:"x"}},5.4)})),Lt.on("DOOR:LCR",(()=>{null==t||t.dubleRotateDoor({data:{bind:"_大会议室-门_grp",axle:"y"}})})),Lt.on("DOOR:BOSS",(()=>{null==t||t.dubleRotateDoor({data:{bind:"_老板办公室-门_grp",autoClose:0}})})),Lt.on("SCREEN:COMPANY",(()=>{null==t||t.videoPlay({data:{bind:"公司大屏"}})})),Lt.on("SCREEN:WELCOM",(e=>null==t?void 0:t.drawCanvas(e))),Lt.on("SCREEN:SCR",(()=>{null==t||t.videoPlay({data:{bind:"小会议室大屏"}})})),Lt.on("SCREEN:LCR",(()=>{null==t||t.videoPlay({data:{bind:"大会议电视屏幕"}})})),Lt.on("AIR:MAIN",(e=>{null==t||t.toggleAir({data:{bind:"_空调风_grp"}},e)})),Lt.on("AIR:ODD",((e,i)=>{null==t||t.toggleAir(e,i)})),Lt.on("SCENE:POS",(()=>null==t?void 0:t.getPosition())),Lt.on("SKY:DAY",(()=>null==t?void 0:t.toByday())),Lt.on("SKY:EVENING",(()=>null==t?void 0:t.toEvening())),Lt.on("SKY:NIGHT",(()=>null==t?void 0:t.toNight()))})(S)},st=t=>{E.content=t,Z(fe,E.content||""),Lt.emit("SCREEN:WELCOM",E.content)},nt=t=>{const e=t.data;switch(null==e?void 0:e.type){case ut:S.cameraTransition(t);break;case ft:h.targetName=t.data.target,S.waitLift(t);break;case Ct:Lt.emit("LIGHT:AUTO",t);break;case bt:t.__close__=!t.__close__,Lt.emit("LIGHT:CLOSE",!t.__close__);break;case St:S.openGate(t);break;case Rt:S.dubleHorizontalDoor(t,5.4);break;case kt:S.oddRotateDoor(t);break;case Et:S.dubleRotateDoor(t);break;case Tt:Lt.emit("CURTAIN:TOGGLE");break;case xt:S.videoPlay(t);break;case Ot:E.show=!0;break;case At:Lt.emit("AIR:ODD",t)}};return N((()=>{A.container=C.value;const t=["电梯地板002","电梯地板"];S=new me(A,{canvas:b.value,groundMeshName:["地面002","立方体306","平面118","立方体475","立方体514","立方体552","地面020","地面","平面391","立方体474","立方体1617","ground",...t],roamPoints:o.roamPoints,sky:o.sky,onClickLeft:(t,e)=>{t&&t.data&&nt(t)},onClickGround:(e,i)=>{S.mouseClickGround(i,t).then((e=>{h.show=t.includes(i.object.name)})).catch((()=>{}))},onHoverAnchor:(t,e)=>{const i=!!t&&t.object._isAnchor_;if(u.show=i,i){u.style.top=e.top,u.style.left=e.left;const i=t.object.data;u.msg=`\n          <p>${i.name}</p>\n          <p>类型：${i.type}</p>\n          <p>绑定：${i.bind||"无"}</p>\n        `}}}),S.run(),it(S).resize(),ot()})),(t,e)=>{const i=V;return n(),a("div",{class:g(t.$style.page)},[r("div",_e,[r("div",{class:"btn",onClick:e[0]||(e[0]=()=>{S.getAll().forEach(((t,e)=>{t.data&&(t.data.type!==o.dotKey||k(t))}))})},"随机更新"),r("div",{class:"btn",onClick:e[1]||(e[1]=()=>P(Lt).emit("SCENE:POS"))},"场景坐标"),r("div",{class:"item",onClick:e[2]||(e[2]=()=>P(Lt).emit("CAMERA:ROAM"))},"全景漫游"),(n(!0),a(p,null,m(P(G),(t=>(n(),a("div",{class:"item",onClick:e=>(t=>{S.cameraTransition({position:t.position,data:t})})(t)},l(t.name),9,ve)))),256)),r("div",{class:"item",onClick:e[3]||(e[3]=()=>P(Lt).emit("CAMERA:CRUISE"))},"定点巡航"),r("div",{class:"item",onClick:e[4]||(e[4]=()=>P(Lt).emit("CAMERA:RESET"))},"视角重置"),r("div",{class:"item",onClick:e[5]||(e[5]=()=>P(Lt).emit("AIR:MAIN",!0))},"空调开"),r("div",{class:"item",onClick:e[6]||(e[6]=()=>P(Lt).emit("AIR:MAIN",!1))},"空调关"),r("div",{class:"item",onClick:e[7]||(e[7]=()=>P(Lt).emit("AIR:MAIN"))},"空调开关"),r("div",{class:"item",onClick:e[8]||(e[8]=()=>P(Lt).emit("LIGHT:CLG",!0))},"灯组开"),r("div",{class:"item",onClick:e[9]||(e[9]=()=>P(Lt).emit("LIGHT:CLG",!1))},"灯组关"),r("div",{class:"item",onClick:e[10]||(e[10]=()=>P(Lt).emit("CURTAIN:TOGGLE",!0))},"窗帘开"),r("div",{class:"item",onClick:e[11]||(e[11]=()=>P(Lt).emit("CURTAIN:TOGGLE",!1))},"窗帘关"),r("div",{class:"item",onClick:e[12]||(e[12]=()=>P(Lt).emit("SKY:DAY"))},"白天"),r("div",{class:"item",onClick:e[13]||(e[13]=()=>P(Lt).emit("SKY:EVENING"))},"傍晚"),r("div",{class:"item",onClick:e[14]||(e[14]=()=>P(Lt).emit("SKY:NIGHT"))},"夜间"),r("div",{class:"item",onClick:e[15]||(e[15]=()=>P(Lt).emit("LIGHT:LCR",null,Math.floor(5*Math.random())))}," 大会议室灯 "),r("div",{class:"item",onClick:e[16]||(e[16]=()=>P(Lt).emit("CAMERA:FIRST"))},"第一人称"),r("div",{class:"item",onClick:e[17]||(e[17]=()=>P(Lt).emit("CAMERA:THREE"))},"第三人称"),r("div",{class:"item",onClick:e[18]||(e[18]=()=>P(Lt).emit("PERSON:ADD"))},"人物加速"),r("div",{class:"item",onClick:e[19]||(e[19]=()=>P(Lt).emit("PERSON:SUB"))},"人物减速")]),r("div",{class:g(t.$style.container),ref_key:"containerRef",ref:C},null,2),r("canvas",{class:g(t.$style["canvas-texture"]),ref_key:"canvasTextureRef",ref:b},null,2),c(ht),c(X,{modelValue:P(_).show,"onUpdate:modelValue":e[20]||(e[20]=t=>P(_).show=t),progress:P(_).percentage},null,8,["modelValue","progress"]),H(r("div",{class:g(t.$style["floor-select"])},[(n(!0),a(p,null,m(P(R),(t=>(n(),z(i,{type:"primary",disabled:P(h).active===t.key,onClick:e=>(t=>{h.active=t.key;const e=t.bind;S.waitLift({data:{bind:e,to:{y:t.y},target:h.targetName}},!0)})(t)},{default:U((()=>[B(l(t.name),1)])),_:2},1032,["disabled","onClick"])))),256))],2),[[j,P(h).show]]),P(u).show?(n(),a("div",{key:0,class:g(t.$style.tip),style:F({left:P(u).style.left+"px",top:P(u).style.top+"px"})},[r("div",{class:g(t.$style.msg),innerHTML:P(u).msg},null,10,ye)],6)):d("",!0),c(dt,{modelValue:P(E).show,"onUpdate:modelValue":e[21]||(e[21]=t=>P(E).show=t),title:P(E).title,content:P(E).content,"onUpdate:content":e[22]||(e[22]=t=>P(E).content=t),"err-message":P(E).errMessage,onConfirm:st},null,8,["modelValue","title","content","err-message"])],2)}}}),[["__cssModules",{$style:{page:"_page_1m1de_2",container:"_container_1m1de_10","floor-select":"_floor-select_1m1de_14",tip:"_tip_1m1de_20",msg:"_msg_1m1de_30","canvas-texture":"_canvas-texture_1m1de_38"}}]]);export{Ce as default};
