var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{bF as a,fz as s,dQ as i,fA as r,dk as o,bA as n,by as l,eZ as d,eb as c,ea as p,ec as h,ez as m,bx as y,fB as u,fC as g,bE as b,fD as v,e as w,i as x,l as f,o as S,g as C,h as M,n as P}from"./vendor-46b9e856.js";import{E as A,p as D,u as z}from"./scene-resize-af96d43c.js";import{_ as O}from"./index-efec42cd.js";const k=D,{insertEvent:I,destroyEvent:V,keyboardPressed:j}=k.useKeyboardState(),{loadModel:B,openDB:E}=k.useModelLoader({baseUrl:"https://raw.githubusercontent.com/zlevan/3d-demo-data/main"}),{raycaster:G,pointer:W,update:_}=k.useRaycaster();let T=new a,F=new a(0,1,0),L=new a,N=new a,R=new s,U=new i,$=new r;class H extends A{constructor(e,a){super(e,a),t(this,"params",{firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-60,playerSpeed:20,physicsSteps:5}),t(this,"gui",new o),t(this,"group",new n),t(this,"player",new l),t(this,"playerIsOnGround",!1),t(this,"collider"),t(this,"visualizer"),this.createPerson(),this.createClock(),this.addGui(),this.loadModel(),I((e=>{"Space"===e.code&&this.playerIsOnGround&&(T.y=20,this.playerIsOnGround=!1)})),this.bindEvent()}createRender(){return new d(this.options.render)}createScene(){return new c}createDirectionalLight(e,t){return new p(e,t)}createAmbientLight(e,t){return new h(e,t)}render(){this.renderer.renderAsync(this.scene,this.camera)}createPerson(){const e=new l(new m(1,2,1,10,.5),new y);e.geometry.translate(0,.5,0);e.geometry.computeBoundingBox(),console.log(e.geometry),e.userData.capsuleInfo={radius:2.5,segment:new r(new a,new a(0,.5,0).multiplyScalar(5))},e.castShadow=!0,e.receiveShadow=!0,e.material.shadowSide=2,e.scale.setScalar(5),this.player=e,this.addObject(e),this.reset()}async loadModel(){return await E(),this.loadCompany()}loadCompany(){B({key:"company",name:"场景",size:13.6,url:"/models/office/公司总部.glb"}).then((e=>{const t=e.getObjectByName("透明_边界");t&&(t.material.opacity=1,t.parent.remove(t),t.clear(),console.log(t)),e.position.y-=25,e.updateMatrixWorld(!0),this.addObject(e),this.createCollider(e)}))}createCollider(e){this.group=e;const t=this.params,a=this.gui,s=a.addFolder("模型");s.add(e.position,"y").name("上下位置").listen(),s.add(t,"physicsSteps",0,30,1).name("步骤"),s.add(t,"gravity",-200,100,.01).name("重力").onChange((e=>{t.gravity=Number(e)})),s.add(t,"playerSpeed",1,100).name("人物速度");const i=new u(e);i.attributes=["position"];const r=i.generate();r.boundsTree=new g(r);const o=new l(r,new b({wireframe:!0,transparent:!0,opacity:.5}));o.visible=!1,this.collider=o,this.addObject(o);const n=new v(o,t.visualizeDepth);n.visible=!1,this.visualizer=n,this.addObject(n);const d=a.addFolder("碰撞因素");d.add(o,"visible").name("碰撞器"),d.add(n,"visible").name("可视化"),d.add(t,"visualizeDepth",1,20,1).name("可视化深度").onChange((e=>{n.depth=e,n.update()}))}addGui(){var e;const t=this.params,a=this.gui;a.add(t,"firstPerson").name("第一人称").onChange((e=>{const t=this.controls;t&&(e?(t.maxPolarAngle=Math.PI,t.minDistance=1e-4,t.maxDistance=1e-4):(this.camera.position.sub(null==t?void 0:t.target).normalize().multiplyScalar(10).add(t.target),t.maxPolarAngle=Math.PI/2,t.minDistance=1,t.maxDistance=200))})),a.add({log:()=>console.log(this)},"log").name("场景数据"),a.add({reset:()=>this.reset()},"reset").name("重置"),a.domElement.className+=" gui-wrap",null==(e=this.container.parentElement)||e.appendChild(a.domElement)}onPointerUp(e){_(e,this.container,1),G.setFromCamera(W,this.camera);let t=G.intersectObjects(this.group.children,!0);console.log(t[0])}reset(){const e=this.player,t=this.camera,s=this.controls;if(!s)return;T.set(0,0,0);const i=new a(155,-20,304).multiplyScalar(1);e.position.copy(i),t.position.sub(s.target),s.target.copy(e.position),t.position.add(e.position),s.update()}keyboardPressedControl(e){const t=this.params,a=this.player,s=this.controls;if(!s)return;const i=s.getAzimuthalAngle();j("W")&&(L.set(0,0,-1).applyAxisAngle(F,i),a.position.addScaledVector(L,t.playerSpeed*e)),j("S")&&(L.set(0,0,1).applyAxisAngle(F,i),a.position.addScaledVector(L,t.playerSpeed*e)),j("A")&&(L.set(-1,0,0).applyAxisAngle(F,i),a.position.addScaledVector(L,t.playerSpeed*e)),j("D")&&(L.set(1,0,0).applyAxisAngle(F,i),a.position.addScaledVector(L,t.playerSpeed*e))}updateCalcVar(){const e=this.player,t=this.collider;if(!t)return;const a=e.userData.capsuleInfo;R.makeEmpty(),U.copy(t.matrixWorld).invert(),$.copy(a.segment),$.start.applyMatrix4(e.matrixWorld).applyMatrix4(U),$.end.applyMatrix4(e.matrixWorld).applyMatrix4(U),R.expandByPoint($.start),R.expandByPoint($.end),R.min.addScalar(-a.radius),R.max.addScalar(a.radius)}bvhCollionCheck(){const e=this.player,t=this.collider;if(t&&t.geometry.boundsTree){const a=e.userData.capsuleInfo;t.geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(R),intersectsTriangle:e=>{const t=L,s=N,i=e.closestPointToSegment($,t,s);if(i<a.radius){const e=a.radius-i,r=s.sub(t).normalize();$.start.addScaledVector(r,e),$.end.addScaledVector(r,e)}}})}}playerMove(e){const t=this.player,a=this.collider;if(!a)return;const s=L;s.copy($.start).applyMatrix4(a.matrixWorld);const i=N;i.subVectors(s,t.position);const r=Math.max(0,i.length()-1e-5);i.normalize().multiplyScalar(r),t.position.add(i),this.playerIsOnGround=i.y>Math.abs(e*T.y*.25),this.playerIsOnGround?T.set(0,0,0):(i.normalize(),T.addScaledVector(i,-i.dot(T)))}updatePlayer(e){const t=this.params,a=this.player,s=this.collider,i=this.camera,r=this.controls;r&&s&&(this.playerIsOnGround?T.y=e*t.gravity:T.y+=e*t.gravity,a.position.addScaledVector(T,e),this.keyboardPressedControl(e),a.updateMatrixWorld(),this.updateCalcVar(),this.bvhCollionCheck(),this.playerMove(e),i.position.sub(r.target),r.target.copy(a.position),i.position.add(a.position),a.position.y<-25&&this.reset())}modelAnimate(){var e;const t=Math.min((null==(e=this.clock)?void 0:e.getDelta())||.1,.1),a=this.params.physicsSteps;if(this.collider)for(let s=0;s<a;s++)this.updatePlayer(t/a)}dispose(){V(),super.dispose()}}const K={b:1,c:"1"}["b"];console.log(K);const Q=O(w({__name:"index",setup(e){const t=x(),a={axes:{visible:!0},grid:{visible:!0,fork:!0},camera:{near:1e-10,position:[10,10,-10]},controls:{maxPolarAngle:Math.PI/2,minDistance:10,maxDistance:200}};let s;return f((()=>{s=new H(a,t.value).run(),z(s).resize()})),(e,a)=>(S(),C("div",{class:P(["three-page",e.$style.page])},[M("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)],2))}}),[["__cssModules",{$style:{}}]]);export{Q as default};
