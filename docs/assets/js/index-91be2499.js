import{t as e}from"./index-dd982610.js";import{p as o,E as t,u as r}from"./scene-resize-af96d43c.js";import{dT as a,dh as s,eL as n,eM as l,bF as d,eN as c,dk as i,by as m,eO as u,e as p,i as h,l as y,af as v,o as w,g as S,h as b,q as g,u as f,n as M}from"./vendor-46b9e856.js";import{_ as V}from"./index-efec42cd.js";const{keyboardPressed:E,insertEvent:D,destroyEvent:C}=o.useKeyboardState(),L=new a(.2,5),x=new s({color:14605965});let k=[],_=0;const z=new n,j=new l(new d(0,.35,0),new d(0,1,0),.35),q=new d,O=new d;let P=!1,W=0;const F=new d,B=new d,I=new d;class N extends t{constructor(e){super(e),k=[],_=0,this.createClock(),this.camera.rotation.order="YXZ",this.addModel(),D()}onContainerMouseDown(){document.body.requestPointerLock()}onDocumentMouseUp(){document.pointerLockElement&&this.throwBall()}onDocumentMouseDown(){W=performance.now()}onBodyMouseMove(e){document.pointerLockElement===document.body&&(this.camera.rotation.x-=.002*e.movementY,this.camera.rotation.y-=.002*e.movementX)}addWordModel(e){var o;this.addObject(e),z.fromGraphNode(e);const t=new c(z);t.visible=!1,this.addObject(t);const r=new i({width:200});r.add({debug:!1},"debug").onChange((function(e){t.visible=e})),r.domElement.className+=" gui-wrap",null==(o=this.container.parentNode)||o.appendChild(r.domElement)}addModel(){for(let e=0;e<100;e++){const e=new m(L,x);e.castShadow=!0,e.receiveShadow=!0,this.addObject(e),k.push({mesh:e,collider:new u(new d(0,-100,0),.2),velocity:new d})}}throwBall(){const e=k[_];this.camera.getWorldDirection(O),e.collider.center.copy(j.end).addScaledVector(O,1.5*j.radius);const o=15+30*(1-Math.exp(.01*(W-performance.now())));console.log("投球力度",o),e.velocity.copy(O).multiplyScalar(o),e.velocity.addScaledVector(q,2),_=(_+1)%100}getForwardVector(){return this.camera.getWorldDirection(O),O.y=0,O.normalize(),O}getSideVector(){return this.camera.getWorldDirection(O),O.y=0,O.normalize(),O.cross(this.camera.up),O}updateControl(e){const o=e*(P?25:0);E("W")&&q.add(this.getForwardVector().multiplyScalar(o)),E("S")&&q.add(this.getForwardVector().multiplyScalar(-o)),E("A")&&q.add(this.getSideVector().multiplyScalar(-o)),E("D")&&q.add(this.getSideVector().multiplyScalar(o)),P&&E("space")&&(q.y=15)}updatePlayer(e){let o=Math.exp(-4*e)-1;P||(q.y-=30*e,o*=.1),q.addScaledVector(q,o);const t=q.clone().multiplyScalar(e);j.translate(t),this.playerCollisions(),this.camera.position.copy(j.end)}playerCollisions(){const e=z.capsuleIntersect(j);P=!1,e&&(P=e.normal.y>0,P||q.addScaledVector(e.normal,-e.normal.dot(q)),e.depth>=1e-10&&j.translate(e.normal.multiplyScalar(e.depth)))}updateSpheres(e){k.forEach((o=>{o.collider.center.addScaledVector(o.velocity,e);const t=z.sphereIntersect(o.collider);t?(o.velocity.addScaledVector(t.normal,1.5*-t.normal.dot(o.velocity)),o.collider.center.add(t.normal.multiplyScalar(t.depth))):o.velocity.y-=30*e;const r=Math.exp(-1.5*e)-1;o.velocity.addScaledVector(o.velocity,r),this.playerSphereCollision(o)})),this.spheresCollisions();for(const o of k)o.mesh.position.copy(o.collider.center)}playerSphereCollision(e){const o=F.addVectors(j.start,j.end).multiplyScalar(.5),t=e.collider.center,r=j.radius=e.collider.radius,a=r*r;for(const s of[j.start,j.end,o]){const o=s.distanceToSquared(t);if(o<a){const a=F.subVectors(s,t).normalize(),n=B.copy(a).multiplyScalar(a.dot(q)),l=I.copy(a).multiplyScalar(a.dot(e.velocity));q.add(l).sub(n),e.velocity.add(n).sub(l);const d=(r-Math.sqrt(o))/2;t.addScaledVector(a,-d)}}}spheresCollisions(){for(let e=0,o=k.length;e<o;e++){const t=k[e];for(let r=e+1;r<o;r++){const e=k[r],o=t.collider.center.distanceToSquared(e.collider.center),a=t.collider.radius+e.collider.radius;if(o<a*a){const r=F.subVectors(t.collider.center,e.collider.center).normalize(),s=B.copy(r).multiplyScalar(r.dot(t.velocity)),n=I.copy(r).multiplyScalar(r.dot(e.velocity));t.velocity.add(n).sub(s),e.velocity.add(s).sub(n);const l=(a-Math.sqrt(o))/2;t.collider.center.addScaledVector(r,l),e.collider.center.addScaledVector(r,-l)}}}}teleportPlayerIfOob(){this.camera.position.y<=-25&&(j.start.set(0,.35,0),j.end.set(0,1,0),j.radius=.35,this.camera.position.copy(j.end),this.camera.rotation.set(0,0,0))}modelAnimate(){var e;const o=Math.min(.05,(null==(e=this.clock)?void 0:e.getDelta())??0)/5;for(let t=0;t<5;t++)this.updateControl(o),this.updatePlayer(o),this.updateSpheres(o),this.teleportPlayerIfOob()}dispose(){C(),super.dispose()}}const U=V(p({__name:"index",setup(t){const{progress:a,loadModel:s}=o.useModelLoader({baseUrl:"https://raw.githubusercontent.com/zlevan/3d-demo-data/main"}),n=h(),l={axes:{visible:!0},grid:{visible:!0},camera:{near:1e-10,position:[0,0,0]},controls:{visible:!1}};let d;const c=()=>{d.onContainerMouseDown()},i=()=>{d.onDocumentMouseUp()},m=()=>{d.onDocumentMouseDown()},u=e=>{d.onBodyMouseMove(e)};return y((()=>{l.container=n.value,d=new N(l).run(),r(d).resize(),a.show=!0,s({name:"碰撞世界",key:"collision-world",size:.09,url:"/models/glb/碰撞世界.glb"}).then((e=>{d.addWordModel(e),a.show=!1})),d.container.addEventListener("mousedown",c,!1),document.addEventListener("mouseup",i,!1),document.addEventListener("mousedown",m,!1),document.body.addEventListener("mousemove",u,!1)})),v((()=>{d.container.removeEventListener("mousedown",c,!1),document.removeEventListener("mouseup",i,!1),document.removeEventListener("mousedown",m,!1),document.body.removeEventListener("mousemove",u,!1)})),(o,t)=>(w(),S("div",{class:M(["three-page",o.$style.page])},[b("div",{class:"h-100",ref_key:"containerRef",ref:n},null,512),g(e,{modelValue:f(a).show,"onUpdate:modelValue":t[0]||(t[0]=e=>f(a).show=e),progress:f(a).percentage},null,8,["modelValue","progress"]),b("div",{class:M(o.$style.center)},null,2)],2))}}),[["__cssModules",{$style:{center:"_center_orbbn_2"}}]]);export{U as default};
