import{Y as e,cx as a,c9 as t,cy as s,ca as r,bs as o,b6 as n,bw as i,bE as l,bp as c,bW as d,bk as m,cz as p,cA as w,cB as h,cC as b}from"./vendor-a6dc29a3.js";import{d as u,g as f}from"./scene-resize-5065e15d.js";import{g,d as y,r as v}from"./model-43e989d4.js";import{D as _}from"./config-9a637eb0.js";const x=e=>new Promise((a=>{const t=window.indexedDB.deleteDatabase(e);t.onsuccess=e=>{a(!0)},t.onerror=e=>{a(!1)}})),B=async(e,a="THREE__MODEL_DB",t=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await((e,a,t)=>new Promise((s=>{window.indexedDB.open(e).onsuccess=r=>{const o=r.target.result,n=o.version;o.close(),n!==a?x(e).then((e=>{s(e?a:n)})):o.objectStoreNames.contains(t)?s(n):x(e).then((e=>{s(e?a:n)}))}})))(a,t,e);let s=window.indexedDB.open(a,t);return new Promise((a=>{s.onupgradeneeded=a=>{const t=a.target.result;t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"path"})},s.onsuccess=e=>{const t=e.target.result;a(t)},s.onerror=e=>{a(void 0)}}))},D=(x={})=>{let D;const M=u({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},x),P=e({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),N={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},k=new Map,z=new a;z.setDecoderPath(M.baseUrl+M.dracoPath);const S=new t;S.setDRACOLoader(z);const E=new s;E.setTranscoderPath(M.baseUrl+M.basisPath),S.setKTX2Loader(E),S.setMeshoptDecoder(r);const j=e=>{const a=e.loaded,t=P.total;let s=Number((a+P.loaded)/t*100);s>100&&(s=100),P.percentage=Number(s.toFixed(2))},U=(e,a,t,s)=>{if(!t)return;const{baseUrl:r,colorMeshName:o}=M,{mapUrl:d,key:m,mapMeshName:p,repeat:w=[1,1]}=e;let h;d&&p&&(h=(new n).load(f(d,r)),h.wrapS=i,h.wrapT=i,h.repeat.set(w[0],w[1]));const b=y(t);return b.traverse((e=>{e.isMesh&&h&&e.name.indexOf(p)>-1?e.material=new l({side:c,transparent:!0,opacity:0,map:h.clone()}):v(e,a,o||[])})),d&&p&&(b._mapMeshName_=p),b.animations=s,m&&k.set(m,b),b},L=(e,a=0)=>new Promise((async t=>{var s;M.indexDB.cache||t(null);const r=d.get(e);if(r)r instanceof ArrayBuffer?(j({loaded:r.byteLength}),S.parse(r,"",(a=>{d.add(e,a),t(a)}))):(j({loaded:a*M.modelSizeKB}),setTimeout((()=>{t(r)}),10));else{const a=await((e,a,t)=>{if(!e||!a||!t)return Promise.resolve(null);const s=e.transaction([a],"readonly").objectStore(a).get(t);return new Promise(((e,a)=>{s.onsuccess=a=>{const t=a.target.result;e(t)},s.onerror=e=>{a(e)}}))})(D,(null==(s=M.indexDB)?void 0:s.tbName)||_.indexdb.tbName,e);if(a&&a.data){const e=a.data;"string"==typeof e?(j({loaded:e.length}),d.add(a.path,e),setTimeout((()=>{t(e)}),10)):(j({loaded:e.byteLength}),S.parse(e,"",(e=>{d.add(a.path,e),t(e)})))}else t(null)}})),O=e=>{var a;if(!M.indexDB.cache)return;const t=d.get(e);if(t&&D){const s=(null==(a=M.indexDB)?void 0:a.tbName)||_.indexdb.tbName;D.transaction(s,"readwrite").objectStore(s).add({path:e,data:t})}},T=(e,a)=>{const{key:t,url:s="",size:r=0}=e,{baseUrl:n,colors:i}=M;return new Promise((async(l,c)=>{let d=i.normal[t]||i.normal.color;d=g(d)[0];const m=f(s,n),p=await L(m,r);if(p){const a=p.scene.children[0],t=U(e,d,a,p.animations);return void l(t)}let w=m.split(".").pop().toLowerCase();if("glb"!==w)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+w);S.load(m,(a=>{const t=a.scene.children;let s=new o;t.length>1?s.add(...t):s=t[t.length-1];const r=U(e,d,s,a.animations);O(m),l(r)}),(e=>{j(e),"function"==typeof a&&a(e)}),c)}))},A=(e,a={})=>{a=u({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},a),e.traverse((e=>{var t;(null==(t=a.filter)?void 0:t.includes(e.name))||K(e.name,a.filterMatch)||e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new m({color:a.color,wireframe:a.wireframe,transparent:!0,opacity:a.opacity}))}))},K=(e="",a=[])=>a.filter((a=>e.indexOf(a)>-1)).length>0;return{progress:P,MODEL_MAP:N,loadModel:T,loadModels:async(e,a,t)=>{var s,r,o;await B((null==(s=M.indexDB)?void 0:s.tbName)||_.indexdb.tbName,(null==(r=M.indexDB)?void 0:r.dbName)||_.indexdb.dbName,(null==(o=M.indexDB)?void 0:o.version)||_.indexdb.version).then((e=>(e&&(d.enabled=!0,D=e),e)));const i=e.length;if(!(0==i?(P.isEnd=!0,P.show=!1,0):(P.isEnd=!1,P.percentage=0,P.show=!0,1)))return;(e=>{for(let a=0;a<e.length;a++)P.total+=(e[a].size||0)*M.modelSizeKB})(e);let l=0;const c=async()=>{const s=e[l],{type:r=N.device,size:o=0}=s;switch(r){case N.device:case N.pipe:await T(s,t);break;case N.sprite:(e=>{const{key:a,range:t={x:1,y:1},mapUrl:s=""}=e;let r=(new n).load(M.baseUrl+s),o=new p({map:r}),i=new w(o),l=t.x,c=t.y;i.scale.set(l,c,1),i.name="sprite",k.set(a,i)})(s);break;case N.font:await((e,a)=>{const{url:t="",size:s=0}=e,{baseUrl:r}=M,o=f(t,r),n=new h;return new Promise((async(e,t)=>{const r=await L(o,s);if(r){const a=n.parse(JSON.parse(r));return k.set(N.font,a),void setTimeout((()=>{e(a)}),10)}n.load(o,(a=>{k.set(N.font,a),O(o),e(a)}),(e=>{j(e),"function"==typeof a&&a(e)}),t)}))})(s,t);break;case N.warning:s.key=N.warning,await T(s,t);break;case N.local:s.key=N.local,await T(s,t);break;case N.disabled:s.key=N.disabled,await T(s,t);break;case N.spotlight:(e=>{const{key:a,color:t=16777215,intensity:s=8,distance:r=10,angle:o=.2*Math.PI,penumbra:n=.2,decay:i=0}=e;let l=new b(t,s,r,o,n,i);l.castShadow=!0,l.visible=!1;let c=800;l.shadow.camera.right=c,l.shadow.camera.left=-c,l.shadow.camera.top=c,l.shadow.camera.bottom=-c,k.set(a,l)})(s)}l++,P.loaded+=o*M.modelSizeKB,l>=i?(P.percentage=100,P.isEnd=!0,a()):c()};c()},getModel:e=>k.get(e),virtualization:(e=[],a,t={})=>{const s=t.filter||[],r=t.filterMatch||[];if(e.length)for(let o=0;o<e.length;o++){const n=e[o];a.uuid===n.uuid||s.includes(n.name)||K(n.name,r)||A(n,t)}else A(a,t)},closeVirtualization:e=>{if(Array.isArray(e))for(let a=0;a<e.length;a++)e[a].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}};export{D as u};
