import{Y as e,cx as a,c9 as t,cy as s,ca as o,bs as r,b6 as n,bw as i,bE as l,bp as c,bW as d,bk as m,cz as p,cA as w,cB as b,cC as h}from"./vendor-a6dc29a3.js";import{d as u,g}from"./scene-resize-24d4948c.js";import{g as f,d as y,r as _}from"./model-c877a686.js";import{D as v}from"./config-9a637eb0.js";const x=e=>new Promise((a=>{const t=window.indexedDB.deleteDatabase(e);t.onsuccess=e=>{a(!0)},t.onerror=e=>{a(!1)}})),B=async(e,a="THREE__MODEL_DB",t=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await((e,a,t)=>new Promise((s=>{window.indexedDB.open(e).onsuccess=o=>{const r=o.target.result,n=r.version;r.close(),n!==a?x(e).then((e=>{s(e?a:n)})):r.objectStoreNames.contains(t)?s(n):x(e).then((e=>{s(e?a:n)}))}})))(a,t,e);let s=window.indexedDB.open(a,t);return new Promise((a=>{s.onupgradeneeded=a=>{const t=a.target.result;t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"path"})},s.onsuccess=e=>{const t=e.target.result;a(t)},s.onerror=e=>{a(void 0)}}))},D=(x={})=>{let D;const P=u({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},x),M=e({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),N={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},k=new Map,z=new a;z.setDecoderPath(P.baseUrl+P.dracoPath);const S=new t;S.setDRACOLoader(z);const E=new s;E.setTranscoderPath(P.baseUrl+P.basisPath),S.setKTX2Loader(E),S.setMeshoptDecoder(o);const j=e=>{const a=e.loaded,t=M.total;let s=Number((a+M.loaded)/t*100);s>100&&(s=100),M.percentage=Number(s.toFixed(2))},U=(e,a,t,s)=>{if(!t)return;const{baseUrl:o,colorMeshName:r}=P,{mapUrl:d,key:m,mapMeshName:p,repeat:w=[1,1]}=e;let b;d&&p&&(b=(new n).load(g(d,o)),b.wrapS=i,b.wrapT=i,b.repeat.set(w[0],w[1]));const h=y(t);return h.traverse((e=>{e.isMesh&&b&&e.name.indexOf(p)>-1?e.material=new l({side:c,transparent:!0,opacity:0,map:b.clone()}):_(e,a,r||[])})),d&&p&&(h._mapMeshName_=p),h.animations=s,m&&k.set(m,h),h},L=(e,a=0)=>new Promise((async t=>{var s;P.indexDB.cache||t(null);const o=d.get(e);if(o)o instanceof ArrayBuffer?(j({loaded:o.byteLength}),S.parse(o,"",(a=>{d.add(e,a),t(a)}))):(j({loaded:a*P.modelSizeKB}),setTimeout((()=>{t(o)}),10));else{const a=await((e,a,t)=>{if(!e||!a||!t)return Promise.resolve(null);const s=e.transaction([a],"readonly").objectStore(a).get(t);return new Promise(((e,a)=>{s.onsuccess=a=>{const t=a.target.result;e(t)},s.onerror=e=>{a(e)}}))})(D,(null==(s=P.indexDB)?void 0:s.tbName)||v.indexdb.tbName,e);if(a&&a.data){const e=a.data;"string"==typeof e?(j({loaded:e.length}),d.add(a.path,e),setTimeout((()=>{t(e)}),10)):(j({loaded:e.byteLength}),S.parse(e,"",(e=>{d.add(a.path,e),t(e)})))}else t(null)}})),T=e=>{var a;if(!P.indexDB.cache)return;const t=d.get(e);if(t&&D){const s=(null==(a=P.indexDB)?void 0:a.tbName)||v.indexdb.tbName;D.transaction(s,"readwrite").objectStore(s).add({path:e,data:t})}},A=(e,a)=>{const{key:t,url:s="",size:o=0}=e,{baseUrl:n,colors:i}=P;return new Promise((async(l,c)=>{let d=i.normal[t]||i.normal.color;d=f(d)[0];const m=g(s,n),p=await L(m,o);if(p){const a=p.scene.children[0],t=U(e,d,a,p.animations);return void l(t)}let w=m.split(".").pop().toLowerCase();if("glb"!==w)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+w);S.load(m,(a=>{const t=a.scene.children;let s=new r;t.length>1?s.add(...t):s=t[t.length-1];const o=U(e,d,s,a.animations);T(m),l(o)}),(e=>{j(e),"function"==typeof a&&a(e)}),c)}))},O=(e,a={})=>{a=u({color:57599,wireframe:!0,opacity:.5},a),e.traverse((e=>{e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new m({color:a.color,wireframe:a.wireframe,transparent:!0,opacity:a.opacity}))}))};return{progress:M,MODEL_MAP:N,loadModel:A,loadModels:async(e,a,t)=>{var s,o,r;await B((null==(s=P.indexDB)?void 0:s.tbName)||v.indexdb.tbName,(null==(o=P.indexDB)?void 0:o.dbName)||v.indexdb.dbName,(null==(r=P.indexDB)?void 0:r.version)||v.indexdb.version).then((e=>(e&&(d.enabled=!0,D=e),e)));const i=e.length;if(!(0==i?(M.isEnd=!0,M.show=!1,0):(M.isEnd=!1,M.percentage=0,M.show=!0,1)))return;(e=>{for(let a=0;a<e.length;a++)M.total+=(e[a].size||0)*P.modelSizeKB})(e);let l=0;const c=async()=>{const s=e[l],{type:o=N.device,size:r=0}=s;switch(o){case N.device:case N.pipe:await A(s,t);break;case N.sprite:(e=>{const{key:a,range:t={x:1,y:1},mapUrl:s=""}=e;let o=(new n).load(P.baseUrl+s),r=new p({map:o}),i=new w(r),l=t.x,c=t.y;i.scale.set(l,c,1),i.name="sprite",k.set(a,i)})(s);break;case N.font:await((e,a)=>{const{url:t="",size:s=0}=e,{baseUrl:o}=P,r=g(t,o),n=new b;return new Promise((async(e,t)=>{const o=await L(r,s);if(o){const a=n.parse(JSON.parse(o));return k.set(N.font,a),void setTimeout((()=>{e(a)}),10)}n.load(r,(a=>{k.set(N.font,a),T(r),e(a)}),(e=>{j(e),"function"==typeof a&&a(e)}),t)}))})(s,t);break;case N.warning:s.key=N.warning,await A(s,t);break;case N.local:s.key=N.local,await A(s,t);break;case N.disabled:s.key=N.disabled,await A(s,t);break;case N.spotlight:(e=>{const{key:a,color:t=16777215,intensity:s=8,distance:o=10,angle:r=.2*Math.PI,penumbra:n=.2,decay:i=0}=e;let l=new h(t,s,o,r,n,i);l.castShadow=!0,l.visible=!1;let c=800;l.shadow.camera.right=c,l.shadow.camera.left=-c,l.shadow.camera.top=c,l.shadow.camera.bottom=-c,k.set(a,l)})(s)}l++,M.loaded+=r*P.modelSizeKB,l>=i?(M.percentage=100,M.isEnd=!0,a()):c()};c()},getModel:e=>k.get(e),virtualization:(e,a=[],t={})=>{if(a.length)for(let s=0;s<a.length;s++){const o=a[s];e.uuid!==o.uuid&&O(o,t)}else O(e,t)},closeVirtualization:e=>{if(Array.isArray(e))for(let a=0;a<e.length;a++)e[a].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}};export{D as u};
