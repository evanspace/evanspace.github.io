var e=Object.defineProperty,t=(t,s,o)=>(((t,s,o)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o})(t,"symbol"!=typeof s?s+"":s,o),o);import{S as s,i as o,u as a}from"./scene-resize-03d1dd3d.js";import{e7 as n,bx as i,fA as r,dO as l,fB as d,dg as c,da as p,ec as h,eb as u,ed as m,fo as g,bA as y,di as b,dt as v,fC as f,fD as w,bz as x,fE as S,dP as P,dG as k,c as D,h as M,k as C,o as _,f as A,g as O,n as z}from"./vendor-d07051c1.js";import{_ as j}from"./index-ca31967b.js";const W="https://ye6.atomgit.net/3d-demo-data",I=W,G={size:5,radius:.5,height:1,viewHeight:8},V={go:["W","up"],back:["S","down"],left:["A","left"],right:["D","right"],jump:["space"]},R=o,{insertEvent:E,destroyEvent:T,keyboardPressed:B}=R.useKeyboardState(),{loadModel:H,openDB:L}=R.useModelLoader({baseUrl:I}),{raycaster:F,pointer:N,update:U}=R.useRaycaster();let Y=new i,K=new i(0,1,0),X=new i,$=new i,q=new r,Q=new l,Z=new d;class J extends s{constructor(e,s){super(e,s),t(this,"params",{firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-150,personSpeed:20,physicsSteps:5}),t(this,"gui",new c),t(this,"group",new p),t(this,"person"),t(this,"personIsOnGround",!1),t(this,"collider"),t(this,"visualizer"),t(this,"personHeight",new i(0,G.viewHeight,0)),this.createPerson(),this.createClock(),this.addGui(),this.loadModel();const o=V,a=Object.keys(o).reduce(((e,t)=>e.concat(o[t])),[]),n={};E((e=>{var t;(null==(t=this.person)?void 0:t.userData.isRuning)||(B(o.jump)&&this.personIsOnGround&&(Y.y=50,this.personIsOnGround=!1),B(a)&&(n[e.code]=!0,this.personWalk()))}),(e=>{var t;(null==(t=this.person)?void 0:t.userData.isRuning)||(delete n[e.code],0!=Object.keys(n).length||this.isMouseRightLongPress()||this.personWalk(!1))})),this.bindEvent()}createScene(){return new h}createDirectionalLight(e,t){return new u(e,t)}createAmbientLight(e,t){return new m(e,t)}modelAnimate(){var e;const t=Math.min((null==(e=this.clock)?void 0:e.getDelta())||.1,.1),s=this.params.physicsSteps;if(this.collider)for(let o=0;o<s;o++)this.updatePlayer(t/s);this.person&&this.person.userData.__mixer__&&this.person.userData.__mixer__.update(t)}createPerson(){const{size:e,radius:t,height:s}=G;H({key:"person",name:"人物",size:1.73,url:"/models/common/人物.glb"}).then((o=>{console.log(o),o.position.setY(-.5*s),o.rotateY(1*Math.PI);const a=new p;a.add(o),a.scale.setScalar(e),this.person=a,this.addObject(a);const{action:r}=((e,t=[],s=!0,o=1)=>{if(!t.length)return{};const a=new n(e),i=t.reduce(((e,t)=>{const n=t.name||"";return e[n]=a.clipAction(t),s&&e[n].play(),e[n].timeScale=o,e}),{});return e.userData.__action__=i,e.userData.__mixer__=a,{action:i,mixer:a}})(a,o.animations,!1);if(r){const e=r["PlayOne-Headnod"],t=r["PlayOne-Walk"];a.userData.defaultAction=e,a.userData.runging=t,this.personWalk(!1)}a.userData.capsuleInfo={radius:t*e,segment:new d(new i(0,0,0),new i(0,s,0).multiplyScalar(e))},this.reset()}))}personWalk(e=!0){const t=this.person;if(!t)return;const{defaultAction:s,runging:o}=t.userData;e?(o.play(),s.stop()):(s.play(),o.stop())}async loadModel(){return await L(),this.loadCompany()}loadGameWorld(){H({key:"OSG_Scene",name:"",size:9.8,url:I+"/models/common/OSG_Scene.glb"}).then((e=>{const t=new p;e.position.y+=19,t.add(e);const s=new r;s.setFromObject(t),s.getCenter(t.position).negate();const o={};t.traverse((e=>{if(!(/Gate/.test(e.name)||e.material&&1===e.material.color.r)&&e.isMesh){const t=e.material.color.getHex();o[t]=o[t]||[],o[t].push(e)}}));const a=new p;for(const n in o){const e=o[n],t=[];if(e.forEach((e=>{if(0!==e.material.emissive.r)a.attach(e);else{const s=e.geometry.clone();s.applyMatrix4(e.matrixWorld),t.push(s)}})),t.length){const e=g(t),s=new y(e,new b({color:parseInt(n),shadowSide:v}));s.castShadow=!0,s.receiveShadow=!0,s.material.shadowSide=2,a.add(s)}}a.name="重组场景",this.addObject(a),this.createCollider(a)}))}loadCompany(){H({key:"company",name:"场景",size:13.6,url:"/models/office/公司总部.glb"}).then((e=>{const t=e.getObjectByName("透明_边界");t&&(t.material.opacity=1,t.parent.remove(t),t.clear()),e.position.y-=25,e.updateMatrixWorld(!0),this.addObject(e),this.createCollider(e)}))}createCollider(e){this.group=e;const t=this.params,s=this.gui,o=s.addFolder("模型");o.add(e.position,"y").name("上下位置").listen(),o.add(t,"physicsSteps",0,30,1).name("步骤"),o.add(t,"gravity",-200,100,.01).name("重力").onChange((e=>{t.gravity=Number(e)})),o.add(t,"personSpeed",1,100).name("人物速度");const a=new f(e);a.attributes=["position"];const n=a.generate();n.boundsTree=new w(n);const i=new y(n,new x({wireframe:!0,transparent:!0,opacity:.5}));i.name="碰撞静态几何体",i.visible=!1,this.collider=i,this.addObject(i);const r=new S(i,t.visualizeDepth);r.visible=!1,this.visualizer=r,r.name="bvh辅助器",this.addObject(r);const l=s.addFolder("碰撞因素");l.add(i,"visible").name("碰撞器"),l.add(r,"visible").name("可视化"),l.add(t,"visualizeDepth",1,20,1).name("可视化深度").onChange((e=>{r.depth=e,r.update()}))}addGui(){var e;const t=this.params,s=this.gui;s.add(t,"firstPerson").name("第一人称").onChange((e=>{const t=this.controls;t&&(e?(t.maxPolarAngle=Math.PI,t.maxDistance=1e-4):(this.camera.position.sub(null==t?void 0:t.target).normalize().multiplyScalar(10).add(t.target),t.maxPolarAngle=Math.PI/2,t.maxDistance=200))})),s.add({log:()=>console.log(this)},"log").name("场景数据"),s.add({reset:()=>this.reset()},"reset").name("重置"),s.domElement.className+=" gui-wrap",null==(e=this.container.parentElement)||e.appendChild(s.domElement)}reset(){const e=this.person,t=this.camera,s=this.controls;if(!s||!e)return;Y.set(0,0,0);const o=new i(155,-20,304).multiplyScalar(1);e.position.copy(o),t.position.sub(s.target),s.target.copy(e.position),t.position.add(e.position),s.update();const a=e.position.clone(),n=(new i).copy(t.position).setY(-20);a.clone().sub(n).normalize(),e.position.copy(n),e.lookAt(a),e.position.copy(a);{e.updateMatrixWorld();const t=e.quaternion.clone();t.normalize();const s=(new P).setFromQuaternion(t,"YXZ");console.log(s),console.log("度数",k.radToDeg(s.y))}}keyboardPressedControl(e){const t=this.params,s=this.person,o=this.controls;if(!o||!s)return;const a=V,n=o.getAzimuthalAngle();(B(a.go)||this.isMouseRightLongPress())&&(X.set(0,0,-1).applyAxisAngle(K,n),s.position.addScaledVector(X,t.personSpeed*e)),B(a.back)&&(X.set(0,0,1).applyAxisAngle(K,n),s.position.addScaledVector(X,t.personSpeed*e)),B(a.left)&&(X.set(-1,0,0).applyAxisAngle(K,n),s.position.addScaledVector(X,t.personSpeed*e)),B(a.right)&&(X.set(1,0,0).applyAxisAngle(K,n),s.position.addScaledVector(X,t.personSpeed*e))}updateCalcVar(){const e=this.person,t=this.collider;if(!t||!e)return;const s=e.userData.capsuleInfo;q.makeEmpty(),Q.copy(t.matrixWorld).invert(),Z.copy(s.segment),Z.start.applyMatrix4(e.matrixWorld).applyMatrix4(Q),Z.end.applyMatrix4(e.matrixWorld).applyMatrix4(Q),q.expandByPoint(Z.start),q.expandByPoint(Z.end),q.min.addScalar(-s.radius),q.max.addScalar(s.radius)}bvhCollionCheck(){const e=this.person,t=this.collider;if(t&&e&&t.geometry.boundsTree){const s=e.userData.capsuleInfo;t.geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(q),intersectsTriangle:e=>{const t=X,o=$,a=e.closestPointToSegment(Z,t,o);if(a<s.radius){const e=s.radius-a,n=o.sub(t).normalize();Z.start.addScaledVector(n,e),Z.end.addScaledVector(n,e)}}})}}personPositionUpdate(e){const t=this.person,s=this.collider;if(!s||!t)return;const o=X;o.copy(Z.start).applyMatrix4(s.matrixWorld);const a=$;a.subVectors(o,t.position);const n=Math.max(0,a.length()-1e-5);a.normalize().multiplyScalar(n),t.position.add(a),this.personIsOnGround=a.y>Math.abs(e*Y.y*.25),this.personIsOnGround?Y.set(0,0,0):(a.normalize(),Y.addScaledVector(a,-a.dot(Y)))}updatePlayer(e){const t=this.params,s=this.person,o=this.collider;this.controls&&o&&s&&(s.userData.isRuning||(this.personIsOnGround?Y.y=e*t.gravity:Y.y+=e*t.gravity,s.position.addScaledVector(Y,e),this.keyboardPressedControl(e),s.updateMatrixWorld(),this.updateCalcVar(),this.bvhCollionCheck(),this.personPositionUpdate(e),this.setControlTarget(s.position),s.position.y<-25&&this.reset()))}setControlTarget(e){if(!this.controls)return;const t=this.camera,s=this.controls,o=e.clone().add(this.personHeight);t.position.sub(s.target),s.target.copy(o),t.position.add(o)}onPointerDown(e){super.onPointerDown(e),2==e.button&&this.personWalk()}isMouseRightLongPress(){var e,t;return 2==(null==(t=null==(e=this.pointer)?void 0:e.event)?void 0:t.button)&&this.pointer.isClick}isMouseRightNoKeypress(){var e,t;const s=V,o=Object.keys(s).reduce(((e,t)=>e.concat(s[t])),[]);return 2==(null==(t=null==(e=this.pointer)?void 0:e.event)?void 0:t.button)&&!B(o)}onPointerUp(e){super.onPointerUp(e),U(e,this.container,1),F.setFromCamera(N,this.camera);let t=F.intersectObjects(this.group.children,!0);console.log(t[0]),this.isMouseRightNoKeypress()&&this.personWalk(!1)}onPointerMove(e){var t,s;0==(null==(s=null==(t=this.pointer)?void 0:t.event)?void 0:s.button)&&this.pointer.isClick&&this.person&&(this.person.rotation.y-=this.movementXToAngle(e.movementX))}dispose(){T(),super.dispose()}}const ee=j(D({__name:"index",setup(e){const t=M(),s={axes:{visible:!0},grid:{visible:!0,fork:!0},render:{alpha:!0},camera:{near:1e-10,position:[-100,100,-100]},controls:{enablePan:!1,maxPolarAngle:Math.PI/2,minDistance:1e-4,maxDistance:200}};let o;return C((()=>{o=new J(s,t.value).run(),a(o).resize()})),(e,s)=>(_(),A("div",{class:z(["three-page",e.$style.page])},[O("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)],2))}}),[["__cssModules",{$style:{}}]]);export{ee as default};
