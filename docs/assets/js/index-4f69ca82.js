var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{c7 as a,c6 as s,c8 as n,c9 as i,bs as o,cp as r,ct as l,bb as d,cu as c,cv as h,cj as m,cq as p,be as u,bp as g,bY as f,Y as b,b7 as y,cW as v,bu as w,af as M,ba as x,bc as _,bD as G,aa as C,bS as k,bk as O,bW as j,c as E,b$ as S,e as U,i as A,l as z,o as P,g as $,a7 as L,dj as T,u as R,h as N,n as F}from"./vendor-16889df9.js";import{S as B}from"./three-scene.module-24b3c661.js";import{c as I}from"./model-3a962665.js";import{u as H}from"./raycaster-7977e527.js";import{d as D,D as Y}from"./object-fb68a4c2.js";import{u as K}from"./background-b37af10e.js";import{u as V}from"./scene-resize-81793ab7.js";import{_ as X}from"./index-c95106e6.js";const q={receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},{materialReplace:W,changeTransparent:Z,exportGlb:J,getAnimations:Q,setMetalnessMaterial:ee,setGlassMaterial:te,centerBoxHelper:ae}=(()=>{const e=(e,t=.5)=>{const a=e=>{e.material.transparent=!0,e.material.opacity=t};e.isMesh?a(e):e.traverse((e=>{e.isMesh&&a(e)}))},t=e=>({color:e.color,map:e.map,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,emissiveMap:e.emissiveMap,bumpMap:e.bumpMap,normalMap:e.normalMap,displacementMap:e.displacementMap,opacity:e.opacity,transparent:e.transparent,side:e.side}),a=(e,s,n)=>{if(e instanceof Array){let t=e.map((e=>a(e,s,n)));e=t}else s?(e.metalness=.5,e.roughness=0):(e.metalness=.5,e.roughness=1),e=new d({...t(e),metalness:e.metalness,roughness:e.roughness,side:n?g:f});return e},s=(e,t)=>{const a=document.createElement("a");a.style.display="none",document.body.appendChild(a),a.href=URL.createObjectURL(e),a.download=t,a.click(),a.remove()};return{materialReplace:(t,s,n,i=1211922)=>{const o=Y.mesh,r=o.animatehName,c=o.transparentName,{type:h,name:m}=n;if(h.indexOf("Light")>-1){if(!n.shadow)return;let e=800;if(n.castShadow=!0,n.shadow.camera.right=e,n.shadow.camera.left=-e,n.shadow.camera.top=e,n.shadow.camera.bottom=-e,"SpotLight"===h){let e=new l(n,n.color);t.add(e)}}else if(s.transformMaterial&&n.isMesh)if(s.opacitySkin&&c.find((e=>m.indexOf(e)>-1))&&e(n,s.opacity),o.receiveShadowName.find((e=>m.indexOf(e)>-1))){n.receiveShadow=!0;const e=s.groundReflection;n.material=a(n.material,e,s.side)}else if(r.find((e=>m.indexOf(e)>-1))){let e=new d({color:i,metalness:.6,roughness:.6});n.material=e}else n.isMesh&&(n.castShadow=!0,n.material=a(n.material,s.glisten,s.side))},changeTransparent:e,exportGlb:(e,t,a,n=!0)=>{if(!e)return;const i={binary:n,animations:t};(new c).parse(e,(e=>{if(e instanceof ArrayBuffer)t=a+".glb",s(new Blob([e],{type:"application/octet-stream"}),t);else{((e,t)=>{s(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),a+".gltf")}var t}),(e=>{}),i)},getAnimations:e=>{const t=[];e.traverse((e=>{t.push(...e.animations)}));const a=[];for(const s of t)a.push(s.clone().optimize());return a},setMetalnessMaterial:(e={color:16777215},a,s)=>new d({...t(e),metalness:a,roughness:s}),setGlassMaterial:(e={color:16777215},{metalness:a=0,roughness:s=0,envMapIntensity:n=0,transmission:i=0,ior:o=0})=>new h({...t(e),metalness:a,roughness:s,envMapIntensity:n,transmission:i,ior:o}),centerBoxHelper:(e,t=16711680)=>{var a=new m(e,t);a.update();return{helper:a,center:(new p).setFromObject(e).getCenter(new u)}}}})(),{backgroundLoad:se,skys:ne}=K(),{raycaster:ie,pointer:oe,update:re}=H(),le=e=>E(e),de=new Proxy({warning:e=>le({message:e,type:"warning",grouping:!0}),success:e=>le({message:e,type:"success",grouping:!0})},{get:(e,t,a)=>e[t]}),ce=b({dotText:""});class he extends B{constructor(e){super(e),t(this,"clock"),t(this,"gui"),t(this,"modelGroup"),t(this,"helperGroup"),t(this,"groundMesh"),t(this,"transformControls"),t(this,"guiOpts",{scale:1,side:!1,insetAnimate:!1,transformMaterial:!0,groundReflection:!1,glisten:!1,opacitySkin:!1,opacity:.6}),t(this,"setPiece"),t(this,"metalnessMaterialUpdate",(({metalness:e,roughness:t})=>{var a;null==(a=this.modelGroup)||a.children.forEach((a=>{a.traverse((s=>{if(/[金属]/.test(s.name)||0==a.children.length)if(Array.isArray(s.material))s.material=s.material.map((a=>ee(a,e,t)));else{const a=s.material;s.material=ee(a,e,t)}}))}))})),t(this,"glassMaterialUpdate",(e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.traverse((a=>{if(/[玻璃]/.test(a.name)||0==t.children.length)if(Array.isArray(a.material))a.material=a.material.map((t=>te(t,e)));else{const t=a.material;a.material=te(t,e)}}))}))})),t(this,"blurringMaterialUpdate",(e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.traverse((a=>{e.all||0==t.children.length||/[线框]/.test(a.name)?a.isMesh&&(e.blurring||e.all?(a.__material__||(a.__material__=a.material),a.material=new O({color:e.color,wireframe:e.wireframe,transparent:!0,opacity:e.opacity})):a.__material__&&(a.material=a.__material__)):a.isMesh&&a.__material__&&(a.material=a.__material__)}))}))})),this.addControls(),this.clock=new y,this.gui=new v,this.addGround(),this.addGui(),this.addModelGroup(),this.setPiece=(()=>{const e=new S(1.75,10,10),t=new O({color:16777215*Math.random(),wireframe:!0}),a=new _(e,t);return a.name="点位",a.position.set(0,140,0),a})(),this.addObject(this.setPiece),this.bindEvent()}addControls(){const e=this.camera,t=new w(e,this.renderer.domElement);t.addEventListener("dragging-changed",(e=>{this.controls&&(this.controls.enabled=!e.value)})),this.transformControls=t,this.addObject(t);const a=e=>this.onKeydown(e),s=e=>{};window.addEventListener("keydown",a,!1),window.addEventListener("keyup",s,!1),M((()=>{window.removeEventListener("keydown",a),window.removeEventListener("keyup",s)}))}onKeydown(e){const t=this.transformControls;if(t)switch(e.key){case"w":t.setMode("translate");break;case"e":t.setMode("rotate");break;case"r":t.setMode("scale");break;case"+":case"=":t.setSize(t.size+.1);break;case"-":case"_":t.setSize(Math.max(t.size-.1,.1));break;case"x":t.showX=!t.showX;break;case"y":t.showY=!t.showY;break;case"z":t.showZ=!t.showZ;break;case" ":t.enabled=!t.enabled;break;case"Escape":t.reset()}}addGui(){var e;const t=this.gui;this.addMainFunction(),this.addMaterial(),this.addNameGroupGui(),this.addResetGui(),this.addEvnGui(),t.domElement.className+=" gui-wrap",null==(e=this.container.parentNode)||e.appendChild(t.domElement)}addGround(){const e=new x(5e3,5e3),t=new d({color:10530223}),a=new _(e,t);a.name="ground",a.rotation.x=1.5*Math.PI,a.receiveShadow=!0,a.visible=!1,this.groundMesh=a,this.addObject(a)}addMainFunction(){const e=this.gui;if(!this.container)return;const t=this.container.parentNode.querySelector('input[type="file"]'),a={importFile:()=>{t.click()},exportGltf:()=>{this.export(!1)},exportGlb:()=>{this.export()},exportPoints:()=>{const e=[this.setPiece].map((e=>{let t=e.position;return`{ "x": ${1*t.x.toFixed(2)}, "y": ${1*t.y.toFixed(2)}, "z": ${1*t.z.toFixed(2)} }`}));ce.dotText=e.join(","),this.copyTextarea("坐标复制成功！")},target:()=>{var e;const t=null==(e=this.controls)?void 0:e.target;ce.dotText=`{ x: ${t.x}, y: ${t.y}, z: ${t.z} }`,this.copyTextarea("中心点复制成功！")},camera:()=>{const e=this.camera.position;ce.dotText=`{ x: ${e.x}, y: ${e.y}, z: ${e.z} }`,this.copyTextarea("相机坐标复制成功！")}},s=e.addFolder("主功能");s.add(a,"importFile").name("上传文件"),s.add(a,"exportGltf").name("导出 .gltf"),s.add(a,"exportGlb").name("导出 .glb"),s.add(a,"exportPoints").name("导出坐标"),s.add(a,"target").name("中心点"),s.add(a,"camera").name("相机坐标"),s.open()}addMaterial(){const e=this.gui;if(!this.container)return;const t=e.addFolder("材质");t.add(this.guiOpts,"transformMaterial").name("转换标准材质"),t.add(this.guiOpts,"glisten").name("材质反光").onChange((()=>this.glistenToggle())),t.add(this.guiOpts,"groundReflection").name("地面反光").onChange((()=>this.groundGlisten())),t.add(this.guiOpts,"side").name("双面材质").onChange((()=>this.sideMaterialToggle())),t.add(this.guiOpts,"opacitySkin").name("材质透明").onChange((()=>this.opacitySkin())),t.add(this.guiOpts,"opacity",0,1).name("透明度").onChange((()=>this.opacitySkin())),t.open()}addNameGroupGui(){const e=this.gui,t={check:!1,metalness:.5,roughness:0},a=e.addFolder("名称包含处理");a.add(t,"check").name("金属材质(金属)").onChange((e=>{t.metalness=e?.5:0,t.roughness=e?0:.5,this.metalnessMaterialUpdate(t)})),a.add(t,"metalness",0,1).name("金属权重").onChange((()=>{this.metalnessMaterialUpdate(t)})),a.add(t,"roughness",0,1).name("金属粗糙度").onChange((()=>{this.metalnessMaterialUpdate(t)}));const s={check:!1,roughness:0,envMapIntensity:1,transmission:1,ior:2.1};a.add(s,"check").name("玻璃材质(玻璃)").onChange((e=>{s.roughness=e?0:.5,s.envMapIntensity=e?1:0,s.transmission=e?1:0,s.ior=e?2.1:1.5,this.glassMaterialUpdate(s)})),a.add(s,"roughness",0,1).name("玻璃光滑度").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"envMapIntensity",0,1).name("玻璃环境贴图影响权重").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"transmission",0,1).name("玻璃透射度(透光率)").onChange((()=>{this.glassMaterialUpdate(s)})),a.add(s,"ior",0,10).name("玻璃折射率").onChange((()=>{this.glassMaterialUpdate(s)}));const n={blurring:!1,wireframe:!1,color:57599,opacity:.5,all:!1};a.add(n,"blurring").name("虚化材质(虚化)").onChange((()=>{this.blurringMaterialUpdate(n)})),a.add(n,"all").name("全部虚化").onChange((()=>{this.blurringMaterialUpdate(n)})),a.addColor(n,"color").name("虚化颜色").onChange((()=>{this.blurringMaterialUpdate(n)})),a.add(n,"opacity",0,1).name("虚化透明度").onChange((()=>{this.blurringMaterialUpdate(n)})),a.add(n,"wireframe",0,1).name("虚化线框").onChange((()=>{this.blurringMaterialUpdate(n)})),a.open()}addResetGui(){const e={viewReset:()=>this.cameraViewReset(),clearScene:()=>{this.clearModelGroup()},rotation:0,scale:1,timeScale:1,center:()=>this.modelCenter()},t=this.gui.addFolder("重置");t.add(e,"viewReset").name("视角重置"),t.add(e,"clearScene").name("清空场景"),t.add(this.grid,"visible").name("网格显示"),t.add(this.controls,"autoRotate").name("自动旋转"),t.add(this.guiOpts,"insetAnimate").name("入场动画"),t.add(e,"rotation",0,360).name("旋转").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{const a=Math.PI/180*e;t.rotation.set(0,a,0)}))})),t.add(e,"scale",.001,100).step(.01).name("缩放").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.scale.set(e,e,e)}))})),t.add(e,"timeScale",.1,10).name("动画速度").onChange((e=>{var t;null==(t=this.modelGroup)||t.children.forEach((t=>{t.__action__&&Object.keys(t.__action__).forEach((a=>{t.__action__[a].timeScale=e}))}))})),t.add(e,"center").name("居中"),t.open()}addEvnGui(){const e={bgCode:"221",hdr:"skidpan_2k",color1:16777215,color2:16777215},t=this.gui.addFolder("环境"),a=this.scene.getObjectByProperty("isAmbientLight",!0);a&&t.add(a,"intensity",0,10).name("环境光强度");const s=this.scene.getObjectsByProperty("isDirectionalLight",!0);if(s.length){const[a,n]=s,i=new G(a,1,a.color);if(i.visible=!1,this.addObject(i),e.color1=a.color.getHex(),t.addColor(e,"color1").name("平行光颜色").onChange((e=>{a.color.set(e),i.traverse((t=>{t.color?t.color.set(e):t.isLine&&t.material.color.set(e)}))})),t.add(a,"intensity",0,10).name("平行光强度"),t.add(a.position,"y",500,1e5).name("平行光高度"),t.add(i,"visible").name("平行光辅助"),n){t.add(n,"visible").name("平行光2"),e.color2=n.color.getHex();const a=new G(n,1,n.color);a.visible=!1,this.addObject(a),e.color1=n.color.getHex(),t.addColor(e,"color1").name("平行光颜色").onChange((e=>{n.color.set(e),a.traverse((t=>{t.color?t.color.set(e):t.isLine&&t.material.color.set(e)}))})),t.add(n,"intensity",0,10).name("平行光2强度"),t.add(n.position,"y",500,1e5).name("平行光高度2"),t.add(a,"visible").name("平行光2辅助")}}this.groundMesh&&(t.add(this.groundMesh,"visible").name("地面"),t.add(this.renderer.shadowMap,"enabled").name("开启阴影")),t.add(e,"bgCode",ne).name("背景").onChange((e=>{se(this.scene,e)})),t.add(e,"hdr",["skidpan_2k"].concat(new Array(20).fill(0).map(((e,t)=>String(t+1))))).name("Hdr环境").onChange((e=>{this.setEnvironment(`/oss/textures/hdr/${e}.hdr`)})),t.open()}async copyTextarea(e="复制成功！"){const t=this.container.parentNode.querySelector("textarea.gui-text");await C(),t.select(),document.execCommand("copy"),de.success(e)}uploadedModel(e,t){if(!e)return;if(e.__upload_model__=!0,this.modelGroup){const e=this.modelGroup.children.find((e=>e.name===t));this.disposeObj(e),this.modelGroup.remove(e)}const a=this.guiOpts.scale,s=new o;e.traverse((e=>{W(s,this.guiOpts,e)})),s.children.length&&this.addHelper(s),e.name=t;let n=e.clone();const i=n.position;ce.dotText=`模型初始坐标: {\n      "x": ${i.x},\n      "y": ${i.y},\n      "z": ${i.z}\n    }`;const r=n.scale;if(n.scale.set(a*r.x,a*r.y,a*r.z),n.animations=e.animations,this.addModel(n),this.guiOpts.insetAnimate&&this.cameraViewReset(),e.animations.length){let t=new k(n);const a=e.animations.reduce(((e,a)=>{const s=a.name||"";return e[s]=t.clipAction(a),e[s].play(),e[s].timeScale=1,e}),{});n.__action__=a,n.__mixer__=t}}cameraViewReset(){var e;I(this.camera,{x:0,y:100,z:300},null==(e=this.controls)?void 0:e.target)}judgeUploadModel(){var e;return 0!=((null==(e=this.modelGroup)?void 0:e.children)||[]).length||(de.warning("未上传模型！"),!1)}export(e){var t;const a=(null==(t=this.modelGroup)?void 0:t.children)||[];if(!this.judgeUploadModel())return;const s=1==a.length,n=s?a[0]:this.modelGroup,i=Q(n);J(n,i,s?n.name:"综合场景",e)}glistenToggle(){var e;let t=this.guiOpts.glisten?0:.9;null==(e=this.modelGroup)||e.traverse((e=>{e.isMesh&&(e.material instanceof Array?e.material.forEach((e=>{e.roughness=t})):e.material.roughness=t)}))}groundGlisten(){var e;let t=this.guiOpts.groundReflection?0:.9;null==(e=this.modelGroup)||e.traverse((e=>{e.isMesh&&q.receiveShadowName.find((t=>e.name.indexOf(t)>-1))&&(e.material instanceof Array?e.material.forEach((e=>{e.roughness=t})):e.material.roughness=t)}))}sideMaterialToggle(){const e=this.guiOpts.side?g:f;this.modelGroup&&this.modelGroup.traverse((t=>{t.isMesh&&(t.material instanceof Array?t.material.forEach((t=>{t.side=e})):t.material.side=e)}))}opacitySkin(){var e;const{opacitySkin:t,opacity:a}=this.guiOpts;null==(e=this.modelGroup)||e.traverse((e=>{q.transparentName.find((t=>e.name.indexOf(t)>-1))&&Z(e,t?a:1)}))}modelCenter(){var e,t;null==(e=this.helperGroup)||e.children.forEach((e=>{var t;"BoxHelper"===e.type&&(this.disposeObj(e),null==(t=this.helperGroup)||t.remove(e))}));const a=[];null==(t=this.modelGroup)||t.children.forEach((e=>{const{helper:t,center:s}=ae(e,16711680);this.addHelper(t),s.name=e.name;const{x:n,y:i,z:r}=e.position;e.position.set(n-s.x,i,r-s.z);const l=new o;let d=e.clone();l.add(d),l.animations=d.animations,a.push(e),this.addModel(d)})),a.forEach((e=>{var t;this.disposeObj(e),null==(t=this.modelGroup)||t.remove(e)}))}addModelGroup(){const e=new o;e.name="模型组",this.addObject(e),this.modelGroup=e;const t=new o;t.name="辅助组",this.helperGroup=t,this.addObject(t)}clearModelGroup(){this.modelGroup?(this.disposeObj(this.modelGroup),this.disposeObj(this.helperGroup),this.addModelGroup()):this.addModelGroup()}addModel(e){this.modelGroup&&this.modelGroup.add(e)}addHelper(e){this.helperGroup&&this.helperGroup.add(e)}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const a=new j(e.clientX,e.clientY);0==oe.distanceTo(a)&&(null==(t=this.transformControls)||t.detach());const s=e.timeStamp-this.pointer.tsp<200;2==e.button||(0==e.button?s&&this.checkIntersectObjects(e):e.button)}checkIntersectObjects(e){var t,a,s;const n=this.container,i=this.options.scale;re(e,n,i);let o="pointerdown"==e.type||"pointerup"==e.type;const r=o?(null==(t=this.modelGroup)?void 0:t.children)||[]:[this.setPiece];ie.setFromCamera(oe,this.camera);let l=ie.intersectObjects(r,o);if(l.length>0){const e=l[0];let t=e.object;o?this.setPiece.position.copy(e.point):t!==(null==(a=this.transformControls)?void 0:a.object)&&(null==(s=this.transformControls)||s.attach(t))}}modelAnimate(){if(!this.modelGroup)return;let e=this.clock.getDelta();for(let t=0;t<this.modelGroup.children.length;t++){const a=this.modelGroup.children[t];a.__mixer__&&a.__mixer__.update(e)}}}const me=X(U({__name:"index",setup(e){const t=b({devEnv:!1,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr"}),{uploadModel:l}=(e=>{const t=D({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/"},e);return{uploadModel:(e,l,d)=>{const{baseUrl:c,dracoPath:h,basisPath:m}=t,p=e[0],u=p.name,g=u.split(".").pop().toLowerCase(),f=new FileReader;f.addEventListener("progress",(e=>{const t="("+Math.floor(e.total/1e3)+" KB)",a=Math.floor(e.loaded/e.total*100)+"%";d&&d({progress:a,filename:u,size:t})})),f.addEventListener("load",(async e=>{const t=e.target.result;if(["glb","gltf"].includes(g)){const e=new a,r=new s;r.setDecoderPath(`${c}${h}`),e.setDRACOLoader(r);const d=new n;d.setTranscoderPath(`${c}${m}`),e.setKTX2Loader(d),e.setMeshoptDecoder(i),e.parse(t,"",(t=>{var a,s,n;const i=t.scene.children;let r=new o;i.length>1?r.add(...i):r=i[i.length-1],r.name=(null==(a=r.userData)?void 0:a.name)||u,r.animations.push(...t.animations),l(r),null==(s=e.dracoLoader)||s.dispose(),null==(n=e.ktx2Loader)||n.dispose()}))}else if("fbx"==g){const e=(new r).parse(t,"");l(e)}})),f.readAsArrayBuffer(p)}}})({baseUrl:t.baseUrl}),d=A(),c={baseUrl:t.baseUrl,env:t.env,grid:{visible:!0},axes:{visible:!0}};let h;const m=b({accept:["fbx","glb","gltf"],fileName:""}),p=e=>{const t=e.target.files,a=t[0];let s=a.name;const n=s.split(".").pop().toLowerCase();if(!m.accept.includes(n))return E.error({message:`文件格式不正确,转换格式支持${m.accept.join("、")}！`,grouping:!0});s=a.name.substring(0,a.name.lastIndexOf(".")),m.fileName=s,l(t,(e=>{h.uploadedModel(e,s)}),(({progress:e,size:t,filename:a})=>{})),e.target.value=""};return z((()=>{c.container=d.value,h=new he(c),h.run(),V(h).resize()})),(e,t)=>(P(),$("div",{class:F(["three-page",e.$style.page])},[L(N("textarea",{class:F(["gui-text",e.$style["gui-text"]]),rows:"4",cols:"30","onUpdate:modelValue":t[0]||(t[0]=e=>R(ce).dotText=e)},null,2),[[T,R(ce).dotText]]),N("input",{class:F(e.$style.upload),type:"file",onChange:p},null,34),N("div",{class:"h-100",ref_key:"containerRef",ref:d},null,512)],2))}}),[["__cssModules",{$style:{"gui-text":"_gui-text_1dkpz_2",upload:"_upload_1dkpz_8"}}]]);export{me as default};
