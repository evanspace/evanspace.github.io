var e=Object.defineProperty,o=(o,t,r)=>(((o,t,r)=>{t in o?e(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r})(o,"symbol"!=typeof t?t+"":t,r),r);import{b4 as t,a_ as r,a$ as n,i as s,Y as a,bE as l,bF as i,bw as c,bx as d,bv as p,bG as u,bB as f,bC as g,e as h,l as m,aM as v,o as y,g as b,u as _,q as O,p as k,I as x,B as M,h as E,n as w,a9 as L,s as C,t as z,aH as F,aa as T}from"./vendor-20ed11f5.js";import{T as j,d as D,g as U,u as G}from"./resize-635642ee.js";import{u as N}from"./raycaster-a673224a.js";import{_ as P,j as B,A as R,k as A}from"./common-0e45d6c3.js";const J={indexdb:{dbName:"THREE__MODEL__DB",tbName:"TB",version:1},mesh:{receiveShadowName:["地面","底座","底板","基础","基础底座","冷却塔基础"]},keys:{TEXT:"TEXT",JSQ:"JSQ",LDB:"LDB",LQB:"LQB",XBC:"XBC",LXJ:"LXJ",LGJ:"LGJ",LGJ_2:"LGJ_2",LGJ_3:"LGJ_3",LGJ_4:"LGJ_4",LQT:"LQT",GL:"GL",BSHRQ:"BSHRQ",BSHLQ:"BSHLQ",FLRB:"FLRB",FJY_X:"FJY_X",FJZ_X:"FJZ_X",FJY:"FJY",FJZ:"FJZ",FM:"FM",XFM:"XFM"},rightClickBackDiffTime:100},{raycaster:S,pointer:I,update:X}=N();class $ extends j{constructor(e,r){super(e),o(this,"deviceGroup"),o(this,"extend"),this.extend=r,this.deviceGroup=new t,this.bindEvent()}onDblclick(e){var o;const t=this.container,r=this.options.scale;if(X(e,t,r),this.deviceGroup){S.setFromCamera(I,this.camera);const e=[this.deviceGroup],t=S.intersectObjects(e);if(t.length){const e=t[0].object,r=this.findParentGroupGroup(e);if(!r)return;"function"==typeof(null==(o=this.extend)?void 0:o.onDblclick)&&this.extend.onDblclick(r)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var o;super.onPointerUp(e);const t=e.timeStamp-this.pointer.tsp<J.rightClickBackDiffTime;2==e.button?t&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickRight)&&this.extend.onClickRight(e):0==e.button?t&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var o;const t=this.container,r=this.options.scale;X(e,t,r);let n="pointerdown"==e.type||"pointerup"==e.type;const s=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));S.setFromCamera(I,this.camera);let a=S.intersectObjects(s,n);if(t.style.cursor=a.length>0?"pointer":"auto",n&&a.length){const e=a[0].object;if(!e)return;"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft(e)}}findParentGroupGroup(e){const o=e=>{let t=e.parent;if(t)return t&&t._isDevice_?t:o(t)};return o(e)}clearDevice(){this.deviceGroup&&(this.disposeObj(this.deviceGroup),this.deviceGroup=new t,this.addObject(this.deviceGroup))}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}getFloor(){return this.deviceGroup.children.filter((e=>e._isFloor_))}hideOmitFloor(e){this.deviceGroup.children.forEach((o=>{o.visible=o._isFloor_||e}))}getFlowMark(e){return this.deviceGroup.children.filter((o=>{var t;return(null==(t=o.data)?void 0:t.followMark)===e}))}getAnimTargetPos(e,o,t){const r=o||e.to||{x:-104,y:7,z:58},n=t||e.target||{x:0,y:0,z:0};return this.controls.target.set(n.x,n.y,n.z),r}getPosition(){}}const Q={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},H=(e,o,t=1)=>{const r=e.position,n=e.rotation,s=e.scale,a=o.position||{x:0,y:0,z:0},l=o.rotation||{x:0,y:0,z:0},i=o.scale||{x:1,y:1,z:1},c=Math.abs(l.x)<2?1:180,d=Math.abs(l.y)<2?1:180,p=Math.abs(l.z)<2?1:180;return{position:[r.x+a.x,r.y+a.y,r.z+a.z],rotation:[n.x+Math.PI/c*l.x,n.y+Math.PI/d*l.y,n.z+Math.PI/p*l.z],scale:[s.x*t*i.x,s.y*t*i.y,s.z*t*i.z]}},Y=e=>e.map((e=>(e.children&&e.children.length>0?e.children=Y(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),V=e=>{let o=e.clone();return o.children=Y(o.children),o},Z=(e,o)=>{e.traverse((e=>{e.isMesh&&(Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(o)})):e.material.color.set(o))}))},K=(e,o,t)=>(e.lookAt(t),new Promise((s=>{new r(e.position).to(o,1e3).easing(n.Quadratic.In).start().onUpdate((()=>{e.lookAt(t)})).onComplete((()=>{s(e)}))}))),W=(e={})=>{const o=D({baseUrl:"",dracoPath:"/draco/gltf/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[]},e),t=a({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),r={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled"},n=new Map,s=new l;s.setDecoderPath(o.baseUrl+o.dracoPath);const h=new i;h.setDRACOLoader(s);const m=(e,t,r,s)=>{if(!r)return;const{baseUrl:a,colorMeshName:l}=o,{mapUrl:i,key:f,mapMeshName:g,repeat:h=[1,1]}=e;let m;i&&g&&(m=(new c).load(U(i,a)),m.wrapS=d,m.wrapT=d,m.repeat.set(h[0],h[1]));const v=V(r);return v.traverse((e=>{e.isMesh&&m&&e.name.indexOf(g)?e.material=new p({side:u,transparent:!0,opacity:0,map:m.clone()}):((e,o=6776165,t,r)=>{const{type:n,name:s}=e;n.indexOf("Light"),J.mesh.receiveShadowName.some((e=>s.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):t.some((e=>s.indexOf(e)>-1))?Z(e,o):e.isMesh&&(r&&(e.material.envMap=r),e.castShadow=!0)})(e,t,l||[])})),v.animations=s,n.set(f,v),v},v=(e,r)=>{const{key:n,url:s=""}=e,{baseUrl:a,colors:l}=o;return new Promise(((o,i)=>{let c=l.normal[n]||l.normal.color;c=(e=>{let o=[];return Array.isArray(e)?o=e:null!=e&&(o=[e]),o})(c)[0];const d=U(s,a);let p=d.split(".").pop().toLowerCase();if("glb"!==p)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+p);h.load(d,(t=>{let r=t.scene.children[0];const n=m(e,c,r,t.animations);o(n)}),(e=>{(e=>{const o=e.loaded,r=t.total;let n=Number((o+t.loaded)/r*100);n>100&&(n=100),t.percentage=Number(n.toFixed(2))})(e),"function"==typeof r&&r(e)}),i)}))};return{progress:t,MODEL_MAP:r,loadModel:v,loadModels:(e,s,a)=>{const l=e.length;if(!(0==l?(t.isEnd=!0,t.show=!1,0):(t.isEnd=!1,t.percentage=0,t.show=!0,1)))return;(e=>{for(let r=0;r<e.length;r++)t.total+=e[r].size*o.modelSizeKB})(e);let i=0;const d=async()=>{const p=e[i],{type:u=r.device,size:h=0}=p;switch(u){case r.device:await v(p,a);break;case r.sprite:(e=>{const{key:t,range:r={x:1,y:1},mapUrl:s=""}=e;let a=(new c).load(o.baseUrl+s),l=new f({map:a}),i=new g(l),d=r.x,p=r.y;i.scale.set(d,p,1),i.name="sprite",n.set(t,i)})(p)}i++,t.loaded+=h*o.modelSizeKB,i>=l?s():d()};d()},getModel:e=>n.get(e)}},q={key:0,class:"scene-operation"},ee=P(h({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoUrl:{default:""},bgColor:{},skyCode:{},bgUrl:{},env:{},camera:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},models:{},config:{},objects:{},dotKey:{default:"DOT"},colorMeshName:{default:()=>[]},formatObject:{},animationModelType:{},floorModelType:{},textModelType:{},anchorType:{default:()=>[]}},emits:["loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:o,emit:t}){const a=e,{change:l,load:i}=((e="")=>{const o=["216","217","218","219","220","221","222","223","224","225"],t=s("/oss/img/sky"),r=o.findIndex((o=>o==e)),n=s(r<0?0:r),a=(e,o)=>{null==e||e.setBgTexture(["/posX.jpeg","/negX.jpeg","/posY.jpeg","/negY.jpeg","/posZ.jpeg","/negZ.jpeg"].map((e=>`${t.value}/${o}${e}`)))};return{skys:o,index:n,skyPath:t,change:e=>{const t=o[n.value];t&&(a(e,t),n.value++,n.value>=o.length&&(n.value=0))},load:a}})(),{progress:c,loadModel:d,loadModels:p,getModel:u}=W({baseUrl:a.dracoUrl,colors:Q,colorMeshName:a.colorMeshName}),f=t,g=s(),h=a.devEnv,j={baseUrl:a.baseUrl,bgUrl:a.bgUrl,env:a.env,bgColor:a.bgColor,camera:a.camera,fog:a.fog,render:a.render,grid:{visible:h},controls:a.controls,axes:{visible:h}};let D;const U=e=>{var o,t,s,l;const i=D.getFloor();if(0===i.length)return;const c=void 0!==e&&e>-1;if((null==(o=a.config)?void 0:o.floorExpandHiddenOther)&&D.hideOmitFloor(!c),i.forEach(((o,t)=>{var s,l,i;const d=o._pos;let p=t-(c?e:t);const u=(null==(s=a.config)?void 0:s.floorExpandMargin)||200,f=(null==(l=a.config)?void 0:l.floorExpandMode)||"UD",g=p*u,h=((null==d?void 0:d.y)??0)+g,m=e==t?((null==d?void 0:d.z)??0)+u:(null==d?void 0:d.z)??0;if("UD"===f){if(o.position.y===h)return}else if("BA"===f&&o.position.z===m)return;if(null==(i=o.data)?void 0:i.mark){const r=o.data.mark,n=D.getFlowMark(r);P(f,n,g,e==t?u:0)}new r(o.position).to({y:"UD"===f?h:o.position.y,z:"BA"===f?m:o.position.z},500).easing(n.Quadratic.Out).start()})),!(null==(t=a.config)?void 0:t.floorExpandChangeViewAngle))return;let d,p;if(c){const o=i[e]||{};d=null==(s=o.data)?void 0:s.to,d&&(p=(null==(l=o.data)?void 0:l.target)||o._pos)}d=D.getAnimTargetPos(a.config||{},d,p),N(d)||K(D.camera,d,D.controls.target)},N=e=>{const o=D.camera.position;return Math.abs(o.x-e.x)<1&&Math.abs(o.y-e.y)<1&&Math.abs(o.z-e.z)<1},P=(e,o,t,s)=>{0!==o.length&&o.forEach((o=>{const a=o._pos,l="UD"==e?((null==a?void 0:a.y)??0)+t:(null==a?void 0:a.y)??0,i="BA"==e?((null==a?void 0:a.z)??0)+s:(null==a?void 0:a.z)??0;new r(o.position).to({y:l,z:i},500).easing(n.Quadratic.Out).start()}))},B=async e=>{if(!e)return;const{type:o,url:t}=e,r=u(o);if(!r)return void(t?await(async e=>{const{type:o,url:t="",name:r}=e,n=await d({key:o,url:t,name:r,size:0}),{position:s,scale:a,rotation:l}=H(n,e);return n.scale.set(...a),n.position.set(...s),n.rotation.set(...l),n._isBase_=!0,D.addDevice(n),Promise.resolve(n)})(e):a.dotKey);const n=a.floorModelType||[],s=a.anchorType||[];let l=V(r);const{position:i,scale:c,rotation:p}=H(l,e),[f,g,h]=i;return l.scale.set(...c),l.position.set(f,g,h),l.rotation.set(...p),l._isDevice_=!0,l.data=e,n.includes(o)&&(l._position_={x:f,y:g,z:h},l._isFloor_=!0),s.includes(o)&&(l._isAnchor_=!0),D.addDevice(l),Promise.resolve()},R=s([]),A=async()=>{var e,o,t,r;c.percentage=100,c.show=!1,D.clearDevice(),await T(),(()=>{R.value.length=0;const e=v(a.objects)||[];if("function"!=typeof a.formatObject)throw R.value=e,Error("未传入格式化函数 formatObject");{const o=a.formatObject(e);R.value=o}})(),await(()=>{let e=0,o=R.value.length;return new Promise((t=>{if(0==o)return t(null);const r=async()=>{const n=R.value[e];await B(n),e++,e<o?r():t(e)};r()}))})(),"function"==typeof(null==(e=a.config)?void 0:e.load)&&(null==(o=a.config)||o.load(D));const n=(null==(t=a.config)?void 0:t.floorExpandIndex)||-1,s=D.getAnimTargetPos(a.config||{}),l=D.getFloor();n>-1&&l.length?(U(n),(null==(r=a.config)?void 0:r.floorExpandChangeViewAngle)||K(D.camera,s,D.controls.target).then((()=>{f("loaded")}))):K(D.camera,s,D.controls.target).then((()=>{f("loaded")}))},J=()=>{p(a.models,(()=>{A()})),a.skyCode&&i(D,a.skyCode)};return m((()=>{j.container=g.value,D=new $(j,{onDblclick:e=>{const o=e.data,t=D.getFloor().findIndex((o=>e.uuid===o.uuid));"function"==typeof o.onDblclick&&o.onDblclick(v(o),e,t),t>-1&&U(t)},onClickLeft(e){f("select",e)},onClickRight:e=>{var o;"function"==typeof(null==(o=a.config)?void 0:o.back)?a.config.back(D):U(-1)}}),D.run(),G(D).resize(),J()})),o({floorAnimate:U}),(e,o)=>{const t=F;return y(),b("div",{class:w(e.$style["floor-scene"])},[_(h)?(y(),b("div",q,[O(t,{type:"success"},{default:k((()=>o[3]||(o[3]=[x("随机更新")]))),_:1}),O(t,{onClick:o[0]||(o[0]=()=>{var e;return null==(e=_(D))?void 0:e.getPosition()}),type:"success"},{default:k((()=>o[4]||(o[4]=[x("场景坐标")]))),_:1}),O(t,{type:"warning",onClick:o[1]||(o[1]=()=>_(l)(_(D)))},{default:k((()=>o[5]||(o[5]=[x("切换背景")]))),_:1})])):M("",!0),E("div",{class:w(e.$style.container),ref_key:"containerRef",ref:g},null,2),_(c).show?(y(),b("div",{key:1,class:w(["loading",e.$style.loading]),style:L({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:o[2]||(o[2]=C((()=>{}),["stop"]))},[E("div",{class:w(e.$style.progress),style:L({"--percentage":_(c).percentage+"%"})},[E("div",{class:w(e.$style["bar-out"])},[E("div",{class:w(e.$style.bar)},null,2)],2),E("div",{class:w(e.$style.text)},z(_(c).percentage)+"%",3)],6)],38)):M("",!0)],2)}}}),[["__cssModules",{$style:{"floor-scene":"_floor-scene_uzv0s_2",container:"_container_uzv0s_8",loading:"_loading_uzv0s_12",progress:"_progress_uzv0s_27","bar-out":"_bar-out_uzv0s_31",bar:"_bar_uzv0s_31","striped-flow":"_striped-flow_uzv0s_1",text:"_text_uzv0s_47"}}]]),oe=P(h({__name:"index",setup(e){const o=A(),t=a({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",render:{alpha:!0},env:"/oss/textures/hdr/skidpan_2k.hdr",camera:{far:1e6},controls:{screenSpacePanning:!1,maxDistance:5e4,maxPolarAngle:.46*Math.PI},models:[{key:"FLOOR_ONE",name:"大堂",size:8.5,url:"/1楼.glb"},{key:"FLOOR_COMMON",name:"楼层",size:13.7,url:"/楼层.glb"},{key:"FLOOR_ATTIC",name:"楼顶",size:.1,url:"/楼顶.glb"},{key:"COLD_CAMERA",name:"摄像头",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/sxt.png"},{key:"COLD_ROOM_INLET",name:"房间入口",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/fjdw.png"},{key:"COLD_GPS",name:"定位",type:"sprite",size:1,range:{x:51,y:56},mapUrl:"/dw.png"}].map((e=>(e.url&&(e.url="/oss/model/floor"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/floor"+e.mapUrl),e))),objects:[],config:{},colorMeshName:[],floorModelType:["FLOOR_COMMON","FLOOR_ONE","FLOOR_TWO_FIVE","FLOOR_SIX","FLOOR_SEVEN_ELEVEN","FLOOR_TWELVE_THIRTEEN","FLOOR_FOURTEEN_SIXTEEN","FLOOR_SEVENTEEN_EIGHTEEN"],anchorType:["COLD_CAMERA","COLD_ROOM_INLET","COLD_GPS"]}),r=s(),n=e=>o.formatData(e);return m((()=>{B.get(R.d3.floor).then((e=>{let o=e.JsonList;const r=e.ModelUrl;o.unshift({name:e.Name,type:"",url:r?`${t.baseUrl}${r}`:""});let n={};if(e.ConfigJson instanceof Object)n=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{n=JSON.parse(e.ConfigJson)}catch(s){}Object.keys(n).forEach((e=>{t.config&&(t.config[e]=n[e])})),t.objects=o}))})),(e,o)=>(y(),b("div",{class:w([e.$style.page,"h-100 o-h"])},[O(ee,{ref_key:"threeSceneRef",ref:r,"dev-env":_(t).devEnv,"base-url":_(t).baseUrl,"bg-color":_(t).bgColor,"bg-url":_(t).bgUrl,env:_(t).env,"sky-code":_(t).skyCode,camera:_(t).camera,render:_(t).render,controls:_(t).controls,config:_(t).config,models:_(t).models,"anchor-type":_(t).anchorType,"floor-model-type":_(t).floorModelType,objects:_(t).objects,"format-object":n},null,8,["dev-env","base-url","bg-color","bg-url","env","sky-code","camera","render","controls","config","models","anchor-type","floor-model-type","objects"])],2))}}),[["__cssModules",{$style:{}}]]);export{oe as default};
