var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{E as a,p as s,u as i}from"./scene-resize-6de17060.js";import{bF as n,fz as r,dQ as o,fA as l,dk as d,bA as c,by as p,eb as h,ea as m,ec as u,ez as y,bx as g,fn as b,bC as w,fB as S,fC as f,bE as v,fD as x,e as M,i as P,l as A,o as z,g as D,h as O,n as C}from"./vendor-46b9e856.js";import{_ as I}from"./index-cc965771.js";const j=s,G="https://raw.githubusercontent.com/zlevan/3d-demo-data/main",{insertEvent:E,destroyEvent:V,keyboardPressed:k}=j.useKeyboardState(),{loadModel:W,openDB:_}=j.useModelLoader({baseUrl:G}),{raycaster:B,pointer:F,update:T}=j.useRaycaster();let L=new n,H=new n(0,1,0),N=new n,R=new n,U=new r,$=new o,K=new l;class Q extends a{constructor(e,a){super(e,a),t(this,"params",{firstPerson:!1,displayCollider:!1,displayBVH:!1,visualizeDepth:10,gravity:-30,playerSpeed:10,physicsSteps:5}),t(this,"gui",new d),t(this,"group",new c),t(this,"player",new p),t(this,"playerIsOnGround",!1),t(this,"collider"),t(this,"visualizer"),this.createPerson(),this.createClock(),this.addGui(),this.loadModel(),E((e=>{"Space"===e.code&&this.playerIsOnGround&&(L.y=10,this.playerIsOnGround=!1)})),this.bindEvent()}createScene(){return new h}createDirectionalLight(e,t){return new m(e,t)}createAmbientLight(e,t){return new u(e,t)}createPerson(){const e=new p(new y(1,2,1,10,.5),new g);e.geometry.translate(0,-.5,0),e.userData.capsuleInfo={radius:.5,segment:new l(new n,new n(0,-1,0))},e.castShadow=!0,e.receiveShadow=!0,e.material.shadowSide=2,this.player=e,this.addObject(e),this.reset()}async loadModel(){await _(),W({key:"OSG_Scene",name:"",size:9.8,url:G+"/models/common/OSG_Scene.glb"}).then((e=>{const t=new c;e.position.y+=19,t.add(e),t.scale.setScalar(.1);const a=new r;a.setFromObject(t),a.getCenter(t.position).negate(),t.updateMatrixWorld(!0);const s={};t.traverse((e=>{if(!(/Gate/.test(e.name)||e.material&&1===e.material.color.r)&&e.isMesh){const t=e.material.color.getHex();s[t]=s[t]||[],s[t].push(e)}}));const i=new c;for(const n in s){const e=s[n],t=[];if(e.forEach((e=>{if(0!==e.material.emissive.r)i.attach(e);else{const a=e.geometry.clone();a.applyMatrix4(e.matrixWorld),t.push(a)}})),t.length){const e=b(t),a=new p(e,new g({color:parseInt(n),shadowSide:w}));a.castShadow=!0,a.receiveShadow=!0,a.material.shadowSide=2,i.add(a)}}this.addObject(i),this.createCollider(i)}))}loadCompany(){W({key:"company",name:"场景",size:13.6,url:"/models/office/公司总部.glb"}).then((e=>{this.addObject(e),this.createCollider(e)}))}createCollider(e){this.group=e;const t=this.params,a=this.gui,s=a.addFolder("模型");s.add(e.position,"y").name("上下位置").listen(),s.add(t,"physicsSteps",0,30,1).name("步骤"),s.add(t,"gravity",-100,100,.01).name("重力").onChange((e=>{t.gravity=Number(e)})),s.add(t,"playerSpeed",1,20).name("人物速度"),console.log(this);const i=new S(e);i.attributes=["position"];const n=i.generate();n.boundsTree=new f(n);const r=new p(n,new v({wireframe:!0,transparent:!0,opacity:.5}));r.visible=!1,this.collider=r,this.addObject(r);const o=new x(r,t.visualizeDepth);o.visible=!1,this.visualizer=o,this.addObject(o);const l=a.addFolder("碰撞因素");l.add(r,"visible").name("碰撞器"),l.add(o,"visible").name("可视化"),l.add(t,"visualizeDepth",1,20,1).name("可视化深度").onChange((e=>{o.depth=e,o.update()}))}addGui(){var e;const t=this.params,a=this.gui;a.add(t,"firstPerson").name("第一人称").onChange((e=>{const t=this.controls;t&&(e?(t.maxPolarAngle=Math.PI,t.minDistance=1e-4,t.maxDistance=1e-4):(this.camera.position.sub(null==t?void 0:t.target).normalize().multiplyScalar(10).add(t.target),t.maxPolarAngle=Math.PI/2,t.minDistance=1,t.maxDistance=20))})),a.add({reset:()=>this.reset()},"reset").name("重置"),a.domElement.className+=" gui-wrap",null==(e=this.container.parentElement)||e.appendChild(a.domElement)}onPointerUp(e){T(e,this.container,1),B.setFromCamera(F,this.camera);let t=B.intersectObjects(this.group.children,!0);console.log(t[0])}reset(){const e=this.player,t=this.camera,a=this.controls;if(!a)return;L.set(0,0,0);const s=new n(15.75,-3,30).multiplyScalar(1);e.position.copy(s),t.position.sub(a.target),a.target.copy(e.position),t.position.add(e.position),a.update()}updatePlayer(e){const t=this.params,a=this.player,s=this.collider,i=this.camera,n=this.controls;if(!n||!s)return;if(this.playerIsOnGround?L.y=e*t.gravity:L.y+=e*t.gravity,a.position.addScaledVector(L,e),!this.controls)return;const r=this.controls.getAzimuthalAngle();k("W")&&(N.set(0,0,-1).applyAxisAngle(H,r),a.position.addScaledVector(N,t.playerSpeed*e)),k("S")&&(N.set(0,0,1).applyAxisAngle(H,r),a.position.addScaledVector(N,t.playerSpeed*e)),k("A")&&(N.set(-1,0,0).applyAxisAngle(H,r),a.position.addScaledVector(N,t.playerSpeed*e)),k("D")&&(N.set(1,0,0).applyAxisAngle(H,r),a.position.addScaledVector(N,t.playerSpeed*e)),a.updateMatrixWorld();const o=a.userData.capsuleInfo;U.makeEmpty(),$.copy(s.matrixWorld).invert(),K.copy(o.segment),K.start.applyMatrix4(a.matrixWorld).applyMatrix4($),K.end.applyMatrix4(a.matrixWorld).applyMatrix4($),U.expandByPoint(K.start),U.expandByPoint(K.end),U.min.addScalar(-o.radius),U.max.addScalar(o.radius),s.geometry.boundsTree&&s.geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(U),intersectsTriangle:e=>{const t=N,a=R,s=e.closestPointToSegment(K,t,a);if(s<o.radius){const e=o.radius-s,i=a.sub(t).normalize();K.start.addScaledVector(i,e),K.end.addScaledVector(i,e)}}});const l=N;l.copy(K.start).applyMatrix4(s.matrixWorld);const d=R;d.subVectors(l,a.position),this.playerIsOnGround=d.y>Math.abs(e*L.y*.25);const c=Math.max(0,d.length()-1e-5);d.normalize().multiplyScalar(c),a.position.add(d),this.playerIsOnGround?L.set(0,0,0):(d.normalize(),L.addScaledVector(d,-d.dot(L))),i.position.sub(n.target),n.target.copy(a.position),i.position.add(a.position),a.position.y<-25&&this.reset()}modelAnimate(){var e;const t=Math.min((null==(e=this.clock)?void 0:e.getDelta())||.1,.1),a=this.params.physicsSteps;if(this.collider)for(let s=0;s<a;s++)this.updatePlayer(t/a)}dispose(){V(),super.dispose()}}const q={b:1,c:"1"}["b"];console.log(q);const J=I(M({__name:"index",setup(e){const t=P(),a={axes:{visible:!0},grid:{visible:!0,fork:!0},camera:{near:1e-10,position:[10,10,-10]},controls:{enablePan:!1,maxPolarAngle:Math.PI/2,minDistance:10,maxDistance:200}};let s;return A((()=>{s=new Q(a,t.value).run(),i(s).resize()})),(e,a)=>(z(),D("div",{class:C(["three-page",e.$style.page])},[O("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512)],2))}}),[["__cssModules",{$style:{}}]]);export{J as default};
