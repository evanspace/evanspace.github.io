import{bz as e,bH as t,a_ as n,a$ as o,b1 as a,b2 as s,b3 as r,b4 as i,b5 as l,b6 as c,b7 as d,b8 as m,Y as p,bE as u,bF as b,bw as h,bx as w,bv as x,bG as y,bj as f,bB as g,bC as v,bD as z}from"./vendor-eaf8386d.js";import{d as B,g as S}from"./scene-resize-a0557c92.js";import{D as M}from"./dialog-36830399.js";const D=()=>({initCSS2DRender:(t,n)=>{const{width:o,height:a}=t,s=new e;return s.setSize(o,a),s.domElement.style.position="absolute",s.domElement.style.left="0px",s.domElement.style.top="0px",s.domElement.style.pointerEvents="none",n.appendChild(s.domElement),s},createCSS2DDom:e=>{const{name:n,className:o="",onClick:a,position:s}=e,r=document.createElement("div");r.innerHTML=n,r.className=o;const i=new t(r);return r.style.pointerEvents=a?"auto":"none",r.style.position="absolute","function"==typeof a&&r.addEventListener("click",a),s&&i.position.set(...s),i}}),E=(e,t,n=1)=>{const o=e.position,a=e.rotation,s=e.scale,r=t.position||{x:0,y:0,z:0},i=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(i.x)<2?1:180,d=Math.abs(i.y)<2?1:180,m=Math.abs(i.z)<2?1:180;return{position:[o.x+r.x,o.y+r.y,o.z+r.z],rotation:[a.x+Math.PI/c*i.x,a.y+Math.PI/d*i.y,a.z+Math.PI/m*i.z],scale:[s.x*n*l.x,s.y*n*l.y,s.z*n*l.z]}},N=e=>e.map((e=>(e.children&&e.children.length>0?e.children=N(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),P=e=>{let t=e.clone();return t.children=N(t.children),t},k=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},_=(e,t)=>{e.traverse((e=>{e.isMesh&&(Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},A=(e,t,a)=>(e.lookAt(a),new Promise((s=>{new n(e.position).to(t,1e3).easing(o.Quadratic.In).start().onUpdate((()=>{e.lookAt(a)})).onComplete((()=>{s(e)}))}))),T=(e,t,n)=>{let o=e.clientWidth/2,a=e.clientHeight/2,s=t.position.clone();const r=t.scale;s.y+=r.x/2;let i=s.project(n);return{left:i.x*o+o,top:-i.y*a+a}},j=(e,t,n="name")=>{let o=[];if(!e||!e.length)return[];return function e(a){a.forEach((a=>{const s=a[n];"string"==typeof s&&t.some((e=>s.indexOf(e)>-1))&&o.push(a),a.children&&e(a.children)}))}(e),o},L=M.statusOffset,O=(e,t,n={})=>{const o=t.type,a=L[e]||{},s=n[o]||a[o]||{};let r=B({x:0,y:0,z:0},s.position||{}),i=B({x:0,y:0,z:0},s.rotation||{});return i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z,{position:r,rotation:i}},U=(e,t,n=16777215,o)=>{const i=O("TEXT",e,o);let l=e.font||{},c=new a(e.name||"",{font:t,size:l.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const d=i.rotation;c.rotateX(d.x),c.rotateY(d.y),c.rotateZ(d.z);const m=i.position;c.computeBoundingBox(),c.computeVertexNormals();let p=.5*(c.boundingBox.max.x-c.boundingBox.min.x),u=.5*(c.boundingBox.max.z-c.boundingBox.min.z),b=new s({color:null!=l.color?l.color:n,flatShading:!1}),h=new r(c,b);return h.castShadow=!0,h.position.set((m.x||0)-p,m.y||0,(m.z||0)-u),h.name="text",h._isText_=!0,h},C=(e,t,n,o,a=100,s=1)=>{if(!n)return;const r=O("WARNING",t,o);let p=new i,u=P(n);u.scale.set(s,s,s);const b=r.position;u.position.set(b.x,b.y,b.z);const h=r.rotation;u.rotation.set(h.x,h.y,h.z),p.add(u);let w=new l(12717056,8,a,0);w.name="灯光",w.position.y=b.y+30,p.add(w),p.name=e;let x=new c(p),y=new d("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),f=new d("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),g=new d("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),v=new m("warning_",1,[y,f,g]),z=x.clipAction(v);return z.paused=!0,z.play(),p.visible=!1,p._isWarning_=!0,{group:p,action:z,mixer:x}},I=(e,t,n,o)=>{if(!t)return;const a=O(o?"DISABLED":"STATUS",e,n);let s=P(t);const r=a.position;s.position.set(r.x,r.y,r.z);const i=a.rotation;return s.rotation.set(i.x,i.y,i.z),s.visible=!1,s._isStatus_=!0,s},H=e=>new Promise((t=>{const n=window.indexedDB.deleteDatabase(e);n.onsuccess=e=>{t(!0)},n.onerror=e=>{t(!1)}})),K=async(e,t="THREE__MODEL_DB",n=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await((e,t,n)=>new Promise((o=>{window.indexedDB.open(e).onsuccess=a=>{const s=a.target.result,r=s.version;s.close(),r!==t?H(e).then((e=>{o(e?t:r)})):s.objectStoreNames.contains(n)?o(r):H(e).then((e=>{o(e?t:r)}))}})))(t,n,e);let o=window.indexedDB.open(t,n);return new Promise((t=>{o.onupgradeneeded=t=>{const n=t.target.result;n.objectStoreNames.contains(e)||n.createObjectStore(e,{keyPath:"path"})},o.onsuccess=e=>{const n=e.target.result;t(n)},o.onerror=e=>{t(void 0)}}))},R=(e={})=>{let t;const n=B({baseUrl:"",dracoPath:"/draco/gltf/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},e),o=p({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),a={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled"},s=new Map,r=new u;r.setDecoderPath(n.baseUrl+n.dracoPath);const i=new b;i.setDRACOLoader(r);const l=e=>{const t=e.loaded,n=o.total;let a=Number((t+o.loaded)/n*100);a>100&&(a=100),o.percentage=Number(a.toFixed(2))},c=(e,t,o,a)=>{if(!o)return;const{baseUrl:r,colorMeshName:i}=n,{mapUrl:l,key:c,mapMeshName:d,repeat:m=[1,1]}=e;let p;l&&d&&(p=(new h).load(S(l,r)),p.wrapS=w,p.wrapT=w,p.repeat.set(m[0],m[1]));const u=P(o);return u.traverse((e=>{e.isMesh&&p&&e.name.indexOf(d)>-1?e.material=new x({side:y,transparent:!0,opacity:0,map:p.clone()}):((e,t=6776165,n,o)=>{const{type:a,name:s}=e;a.indexOf("Light"),M.mesh.receiveShadowName.some((e=>s.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):n.some((e=>s.indexOf(e)>-1))?_(e,t):e.isMesh&&(o&&(e.material.envMap=o),e.castShadow=!0)})(e,t,i||[])})),l&&d&&(u._mapMeshName_=d),u.animations=a,s.set(c,u),u},d=(e,o=0)=>{const a=new b;return new Promise((async s=>{var r;n.indexDB.cache||s(null);const i=f.get(e);if(i)i instanceof ArrayBuffer?(l({loaded:i.byteLength}),a.parse(i,"",(t=>{f.add(e,t),s(t)}))):(l({loaded:o*n.modelSizeKB}),setTimeout((()=>{s(i)}),10));else{const o=await((e,t,n)=>{if(!e||!t||!n)return Promise.resolve(null);const o=e.transaction([t],"readonly").objectStore(t).get(n);return new Promise(((e,t)=>{o.onsuccess=t=>{const n=t.target.result;e(n)},o.onerror=e=>{t(e)}}))})(t,(null==(r=n.indexDB)?void 0:r.tbName)||M.indexdb.tbName,e);if(o&&o.data){const e=o.data;"string"==typeof e?(l({loaded:e.length}),f.add(o.path,e),setTimeout((()=>{s(e)}),10)):(l({loaded:e.byteLength}),a.parse(e,"",(e=>{f.add(o.path,e),s(e)})))}else s(null)}}))},m=e=>{var o;if(!n.indexDB.cache)return;const a=f.get(e);if(a&&t){const s=(null==(o=n.indexDB)?void 0:o.tbName)||M.indexdb.tbName;t.transaction(s,"readwrite").objectStore(s).add({path:e,data:a})}},D=(e,t)=>{const{key:o,url:a="",size:s=0}=e,{baseUrl:r,colors:p}=n;return new Promise((async(n,u)=>{let b=p.normal[o]||p.normal.color;b=k(b)[0];const h=S(a,r),w=await d(a,s);if(w){const t=w.scene.children[0],o=c(e,b,t,w.animations);return void n(o)}let x=h.split(".").pop().toLowerCase();if("glb"!==x)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+x);i.load(h,(t=>{let o=t.scene.children[0];const a=c(e,b,o,t.animations);m(h),n(a)}),(e=>{l(e),"function"==typeof t&&t(e)}),u)}))};return{progress:o,MODEL_MAP:a,loadModel:D,loadModels:async(e,r,i)=>{var c,p,u;await K((null==(c=n.indexDB)?void 0:c.tbName)||M.indexdb.tbName,(null==(p=n.indexDB)?void 0:p.dbName)||M.indexdb.dbName,(null==(u=n.indexDB)?void 0:u.version)||M.indexdb.version).then((e=>(e&&(f.enabled=!0,t=e),e)));const b=e.length;if(!(0==b?(o.isEnd=!0,o.show=!1,0):(o.isEnd=!1,o.percentage=0,o.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)o.total+=e[t].size*n.modelSizeKB})(e);let w=0;const x=async()=>{const t=e[w],{type:c=a.device,size:p=0}=t;switch(c){case a.device:case a.pipe:await D(t,i);break;case a.sprite:(e=>{const{key:t,range:o={x:1,y:1},mapUrl:a=""}=e;let r=(new h).load(n.baseUrl+a),i=new g({map:r}),l=new v(i),c=o.x,d=o.y;l.scale.set(c,d,1),l.name="sprite",s.set(t,l)})(t);break;case a.font:await((e,t)=>{const{url:o="",size:r=0}=e,{baseUrl:i}=n,c=S(o,i),p=new z;return new Promise((async(e,n)=>{const i=await d(c,r);if(i){const t=p.parse(JSON.parse(i));return s.set(a.font,t),void setTimeout((()=>{e(t)}),10)}p.load(c,(t=>{s.set(a.font,t),m(o),e(t)}),(e=>{l(e),"function"==typeof t&&t(e)}),n)}))})(t,i);break;case a.warning:t.key=a.warning,await D(t,i);break;case a.local:t.key=a.local,await D(t,i);break;case a.disabled:t.key=a.disabled,await D(t,i)}w++,o.loaded+=p*n.modelSizeKB,w>=b?(o.isEnd=!0,r()):x()};x()},getModel:e=>s.get(e)}};export{R as a,k as b,A as c,P as d,E as e,j as f,T as g,U as h,C as i,I as j,_ as s,D as u};
