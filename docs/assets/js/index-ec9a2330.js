import{bs as e,e as o,i as t,w as n,l as i,aP as s,o as a,g as l,u as r,h as c,B as d,n as u,q as p,a9 as h,a5 as f,cm as m,cn as g,aa as y,cw as v,Y as b,c as _,p as C,I as O,t as x,R as k,aK as M}from"./vendor-e7f34225.js";import{u as D,t as E}from"./css2d-eaec311f.js";import{T as w,d as j,u as T}from"./scene-resize-5d485f13.js";import{u as G,a as L}from"./background-835b6336.js";import{D as z}from"./config-b6242c11.js";import{u as N,c as R,g as S,s as F,a as U,d as B,b as P,f as A}from"./model-loader-9c45be38.js";import{u as $}from"./dialog-fb736aeb.js";import{_ as I,e as V,A as K}from"./index-60228787.js";import"./posZ-54c73ffc.js";const{raycaster:J,pointer:H,update:Q}=G(),{initCSS2DRender:W,createCSS2DDom:X}=D();class q extends w{constructor(e,o){super(e),this.extend=o,this.css2DRender=W(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.bindEvent(),this.addDeviceGroup(),this.addDotGroup()}addDeviceGroup(){const o=new e;o.name="设备组",this.deviceGroup=o,this.addObject(o)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const o=new e;o.name="点位组",this.dotGroup=o,this.scene.add(o)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,o){const t=e.position,{size:n,color:i}=e.font||{},{x:s=0,y:a=0,z:l=0}=t||{},r=X({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=i?`color: ${i}`:""}"></span>\n      `,className:"dot-2D-label",position:[s,a,l],onClick:o});return r.name=e.name,r.data=e,r._position_={x:s,y:a,z:l},this.dotGroup.add(r),r}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall()}onDblclick(e){var o;const t=this.container,n=this.options.scale;if(Q(e,t,n),this.deviceGroup){J.setFromCamera(H,this.camera);const e=[this.deviceGroup],t=J.intersectObjects(e);if(t.length){const e=t[0].object,n=this.findParentGroupGroup(e);if(!n)return;"function"==typeof(null==(o=this.extend)?void 0:o.onDblclick)&&this.extend.onDblclick(n)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var o;super.onPointerUp(e);const t=e.timeStamp-this.pointer.tsp<z.rightClickBackDiffTime;2==e.button?t&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickRight)&&this.extend.onClickRight(e):0==e.button?t&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var o,t;const n=this.container,i=this.options.scale;Q(e,n,i);let s="pointerdown"==e.type||"pointerup"==e.type;const a=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));J.setFromCamera(H,this.camera);let l=J.intersectObjects(a,s);if(n.style.cursor=l.length>0?"pointer":"auto",s)if(l.length){const e=l[0].object;if(!e)return;"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(t=this.extend)?void 0:t.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const o=e=>{let t=e.parent;if(t)return t&&t._isDevice_?t:o(t)};return o(e)}getFloor(){return this.deviceGroup.children.filter((e=>e._isFloor_))}hideOmitFloor(e){this.deviceGroup.children.forEach((o=>{o.visible=o._isFloor_||e}))}getAll(){return this.deviceGroup.children.concat(this.dotGroup.children)}getFlowMark(e){return this.getAll().filter((o=>{var t;return(null==(t=o.data)?void 0:t.followMark)===e}))}getAnimTargetPos(e,o,t){const n=o||e.to||{x:-104,y:7,z:58},i=t||e.target||{x:0,y:0,z:0};return this.controls.target.set(i.x,i.y,i.z),n}resize(){super.resize();const{width:e,height:o}=this.options;this.css2DRender.setSize(e,o)}dispose(){this.disposeObj(this.deviceGroup),this.disposeObj(this.dotGroup),this.css2DRender=null,this.deviceGroup=null,this.dotGroup=null,this.extend={},super.dispose()}}const Y={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},Z={key:0,class:"scene-operation"},ee=I(o({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoPath:{},basisPath:{},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},directionalLight:{default:()=>({})},models:{},config:{},objects:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{},animationModelType:{},floorModelType:{},textModelType:{},anchorType:{default:()=>[]},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(o,{expose:b,emit:_}){const C=o,O=j(Y,C.colors),{change:x,load:k}=L(),{progress:M,loadModel:D,loadModels:w,getModel:T}=N({baseUrl:C.baseUrl,dracoPath:C.dracoPath,basisPath:C.basisPath,colors:O,colorMeshName:C.colorMeshName,indexDB:C.indexDB}),{dialog:G}=$(),I=_,V=t(),K=C.devEnv,J={baseUrl:C.baseUrl,bgUrl:C.bgUrl,env:C.env,bgColor:C.bgColor,camera:C.camera,cruise:C.cruise,fog:C.fog,render:C.render,grid:C.grid,controls:C.controls,axes:C.axes,directionalLight:C.directionalLight};let H;n((()=>C.dotShowStrict),(()=>Q())),n((()=>C.scale),(e=>{null==H||H.setScale(e||1)})),n((()=>C.cruise.points),(e=>{M.isEnd&&H.setCruisePoint(e)})),n((()=>C.objects),(()=>{M.isEnd&&se()}));const Q=()=>{const e=H.dotGroup.children;for(let o=0;o<e.length;o++){const t=e[o];if(!t.data)continue;t.data.type===C.dotKey&&oe(t)}},W=e=>{var o,t,n,i;const s=H.getFloor();if(0===s.length)return;const a=void 0!==e&&e>-1;if((null==(o=C.config)?void 0:o.floorExpandHiddenOther)&&H.hideOmitFloor(!a),s.forEach(((o,t)=>{var n,i,s;const l=o._position_;let r=t-(a?e:t);const c=(null==(n=C.config)?void 0:n.floorExpandMargin)||200,d=(null==(i=C.config)?void 0:i.floorExpandMode)||"UD",u=r*c,p=((null==l?void 0:l.y)??0)+u,h=e==t?((null==l?void 0:l.z)??0)+c:(null==l?void 0:l.z)??0;if("UD"===d){if(o.position.y===p)return}else if("BA"===d&&o.position.z===h)return;if(null==(s=o.data)?void 0:s.mark){const n=o.data.mark,i=H.getFlowMark(n);ee(d,i,u,e==t?c:0)}new m(o.position).to({y:"UD"===d?p:o.position.y,z:"BA"===d?h:o.position.z},500).easing(g.Quadratic.Out).start()})),!(null==(t=C.config)?void 0:t.floorExpandChangeViewAngle))return;let l,r;if(a){const o=s[e]||{};l=null==(n=o.data)?void 0:n.to,l&&(r=(null==(i=o.data)?void 0:i.target)||o._position_)}l=H.getAnimTargetPos(C.config||{},l,r),X(l)||R(H.camera,l,H.controls.target)},X=e=>{const o=H.camera.position;return Math.abs(o.x-e.x)<1&&Math.abs(o.y-e.y)<1&&Math.abs(o.z-e.z)<1},ee=(e,o,t,n)=>{0!==o.length&&o.forEach((o=>{const i=o._position_,s="UD"==e?((null==i?void 0:i.y)??0)+t:(null==i?void 0:i.y)??0,a="BA"==e?((null==i?void 0:i.z)??0)+n:(null==i?void 0:i.z)??0;new m(o.position).to({y:s,z:a},500).easing(g.Quadratic.Out).start()}))},oe=e=>{var o;const t=e.data;if("function"==typeof C.dotUpdateObjectCall){const e=C.dotUpdateObjectCall(t,H.deviceGroup);"object"==typeof e&&Object.keys(e).forEach((o=>{t[o]=e[o]}))}e.visible=t.show||!C.dotShowStrict;const n=null==(o=e.element)?void 0:o.getElementsByClassName("inner")[0];if(n){const{size:e,color:o}=t.font||{};null!=e&&(n.style.fontSize="string"==typeof e?e:e+"px"),null!=o&&(n.style.color=o),n.textContent=`${t.value||0}${t.unit}`}},te=e=>{const o=V.value,t=S(o,e,H.camera);return G.position=t,G.style.left=t.left+"px",G.style.top=t.top+"px",t},ne=async o=>{var t;if(!o)return;const{type:n,url:i}=o,a=T(n);if(!a)return void(i?await(async e=>{const{type:o,url:t="",name:n}=e,i=await D({key:o,url:t,name:n,size:0}),{position:s,scale:a,rotation:l}=P(i,e);return i.scale.set(...a),i.position.set(...s),i.rotation.set(...l),i._isBase_=!0,H.addDevice(i),Promise.resolve(i)})(o):n===C.dotKey&&(e=>{oe(H.addDot(e,(o=>{I("click-dot",s(e),o)})))})(o));const l=C.floorModelType||[],r=C.anchorType||[];let c=B(a);const{position:d,scale:u,rotation:p}=P(c,o),[h,f,m]=d;c.scale.set(...u),c.position.set(h,f,m),c.rotation.set(...p);const g=C.animationModelType||[],y=C.colorMeshName||[];if(g.includes(n)){if("Group"!==c.type){const o=new e;o.add(c),o.name=c.name,c=o}if(C.mainBodyChangeColor){const e=((null==(t=c.children[0])?void 0:t.children)||[]).filter((e=>(C.mainBodyMeshName||[]).some((o=>e.name.indexOf(o)>-1)))),o=O.normal;let n=o.main||o.color,i=U(n);i.length&&e.forEach(((e,o)=>{F(e,i[o%i.length])})),c[z.meshKey.body]=e}const o=A(c.children,y);let n,i=new v(c);a.animations.length&&(n=i.clipAction(a.animations[0]),n.paused=!0,n.timeScale=1.5,n.play()),c.extra={action:n,mixer:i,meshs:o}}else{const e=[];c.traverse((o=>{"string"==typeof o.name&&y.some((e=>o.name.indexOf(e)>-1))&&e.push(o)})),e.length&&(c[z.meshKey.color]=e)}return c._isDevice_=!0,c.data=o,l.includes(n)&&(c._position_={x:h,y:f,z:m},c._isFloor_=!0),(o.followMark||o.mark)&&(c._position_={x:h,y:f,z:m}),r.includes(n)&&(c._isAnchor_=!0),H.addDevice(c),Promise.resolve()},ie=t([]),se=async()=>{var e,o,t,n;M.percentage=100,M.show=!1,H.clearDevice(),await y(),(()=>{ie.value.length=0;const e=s(C.objects)||[];if("function"!=typeof C.formatObject)ie.value=e;else{const o=C.formatObject(e);ie.value=o}})(),await(()=>{let e=0,o=ie.value.length;return new Promise((t=>{if(0==o)return t(null);const n=async()=>{const i=ie.value[e];await ne(i),e++,e<o?n():t(e)};n()}))})(),H.setCruisePoint(C.cruise.points),"function"==typeof(null==(e=C.config)?void 0:e.load)&&(null==(o=C.config)||o.load(H));const i=(null==(t=C.config)?void 0:t.floorExpandIndex)||-1,a=H.getAnimTargetPos(C.config||{}),l=H.getFloor();i>-1&&l.length?(W(i),(null==(n=C.config)?void 0:n.floorExpandChangeViewAngle)||R(H.camera,a,H.controls.target).then((()=>{I("loaded"),H.controlSave()}))):R(H.camera,a,H.controls.target).then((()=>{I("loaded"),H.controlSave()}))},ae=()=>{w(C.models,(()=>{se()})),C.skyCode&&k(H,C.skyCode)},le=e=>{const o=[];C.updateObjectCall,H.getAll().forEach(((t,n)=>{if(!t.data)return;const i=t.data;let a=i.type;if(a===C.dotKey)return void oe(t);if("function"==typeof C.updateObjectCall){const o=C.updateObjectCall(i,e);if(!o)return;Object.keys(o).forEach((e=>{i[e]=o[e]}))}o.push(s(i));let{status:l=0,error:r=0,remote:c=0,local:d=0,disabled:u=0}=i;const p=O[r>0?"error":l>0?"runing":"normal"];let h=null!=p[a]?p[a]:p.color;if("function"==typeof C.getColorCall){const e=C.getColorCall(i);e&&(h=e)}re({type:a,el:t,colorObj:p,color:h,paused:0==l,error:r>0,remote:c>0,local:d>0,disabled:u>0})})),I("update",o,e)},re=e=>{let{el:o,type:t,colorObj:n,color:i,paused:s}=e,a=U(i);i=a[0];const l=z.meshKey;if((C.colorModelType||[]).includes(t)&&null!=i){return void(o[l.color]||[]).forEach((e=>{F(e,i)}))}const r=o.extra;if(r&&(r.action&&(r.action.paused=s),null!=i)){(r.meshs||[]).forEach((e=>{F(e,i)}))}if(C.mainBodyChangeColor&&o[l.body]){const e=null!=n.main?n.main:n.color;let t=U(e);t.length&&o[l.body].forEach(((e,o)=>{F(e,t[o%t.length])}))}};return i((()=>{J.container=V.value,H=new q(J,{onDblclick:e=>{const o=e.data,t=H.getFloor().findIndex((o=>e.uuid===o.uuid));"function"==typeof o.onDblclick?o.onDblclick(s(o),e,t):I("dblclick",s(o)),t>-1&&W(t)},onClickLeft(e){if(e){const o=e.data,t=s(o);I("select",t),"function"==typeof o.onClick?(G.show=!1,o.onClick(t)):(G.select=[e],(()=>{const e=G.select[0],o=e.data;G.data=o,G.title=(null==o?void 0:o.name)||"",G.show=!0;const t=te(e);I("click-dialog-dot",o,t)})())}else G.select=[],G.show=!1},onClickRight:e=>{var o;G.show=!1,"function"==typeof(null==(o=C.config)?void 0:o.back)?C.config.back(H):W(-1)},animateCall:()=>{if(G.show&&G.select.length){const e=G.select[0];te(e)}}}),H.run(),I("init",H),ae()})),b({floorAnimate:W,exportImage:()=>null==H?void 0:H.exportImage(),update:le}),(e,o)=>(a(),l("div",{class:u(e.$style["floor-scene"])},[r(K)?(a(),l("div",Z,[c("div",{class:"btn",onClick:o[0]||(o[0]=()=>le(!0))},"随机更新"),e.cruise.visible?(a(),l("div",{key:0,class:"btn",onClick:o[1]||(o[1]=()=>{var e;return null==(e=r(H))?void 0:e.toggleCruise()})},"定点巡航")):d("",!0),c("div",{class:"btn",onClick:o[2]||(o[2]=()=>{var e;return null==(e=r(H))?void 0:e.getPosition()})},"场景坐标"),c("div",{class:"btn",onClick:o[3]||(o[3]=()=>r(x)(r(H)))},"切换背景"),c("div",{class:"btn",onClick:o[4]||(o[4]=()=>{var e;return null==(e=r(H))?void 0:e.controlReset()})},"控制器重置"),e.cruise.visible?(a(),l("div",{key:1,class:"btn",onClick:o[5]||(o[5]=()=>{var e;return null==(e=r(H))?void 0:e.toggleCruiseDepthTest()})}," 巡航深度 ")):d("",!0)])):d("",!0),c("div",{class:u(e.$style.container),ref_key:"containerRef",ref:V},null,2),p(E,{modelValue:r(M).show,"onUpdate:modelValue":o[6]||(o[6]=e=>r(M).show=e),progress:r(M).percentage},null,8,["modelValue","progress"]),r(G).show?(a(),l("div",{key:1,class:u(e.$style.dialog),style:h(r(G).style)},[f(e.$slots,"dialog",{data:r(G).data,title:r(G).title,position:r(G).position})],6)):d("",!0)],2))}}),[["__cssModules",{$style:{"floor-scene":"_floor-scene_13t9b_2",container:"_container_13t9b_8",dialog:"_dialog_13t9b_12"}}]]),oe={class:"flex flex-ac"},te=I(o({__name:"index",setup(e){const o=b({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",render:{alpha:!0,preserveDrawingBuffer:!0},env:"/oss/textures/hdr/3.hdr",camera:{far:1e6},colors:{normal:{main:65280},runing:{main:16715760,text:0}},cruise:{visible:!0,points:[[450,490,450],[450,490,-450],[-450,490,-450],[-450,490,450]],offset:10},controls:{screenSpacePanning:!1,maxDistance:5e3,maxPolarAngle:.46*Math.PI},directionalLight:{helper:!1},grid:{visible:!0},models:[{key:"FLOOR_ONE",name:"大堂",size:8.5,url:"/1楼.glb"},{key:"FLOOR_COMMON",name:"楼层",size:13.7,url:"/楼层.glb"},{key:"FLOOR_ATTIC",name:"楼顶",size:.1,url:"/楼顶.glb"},{key:"COLD_CAMERA",name:"摄像头",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/sxt.png"},{key:"COLD_ROOM_INLET",name:"房间入口",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/fjdw.png"},{key:"COLD_GPS",name:"定位",type:"sprite",size:1,range:{x:51,y:56},mapUrl:"/dw.png"}].map((e=>(e.url&&(e.url="/oss/model/floor"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/floor"+e.mapUrl),e))),objects:[],config:{},indexDB:{cache:!0,dbName:"THREE__FLOOR__DB",tbName:"TB",version:1},dotShowStrict:!1,colorMeshName:[],floorModelType:["FLOOR_COMMON","FLOOR_ONE","FLOOR_TWO_FIVE","FLOOR_SIX","FLOOR_SEVEN_ELEVEN","FLOOR_TWELVE_THIRTEEN","FLOOR_FOURTEEN_SIXTEEN","FLOOR_SEVENTEEN_EIGHTEEN"],anchorType:["COLD_CAMERA","COLD_ROOM_INLET","COLD_GPS"],mainBodyChangeColor:!0,mainBodyMeshName:["立方体062"],animationModelType:["FLOOR_COMMON"]}),n=t(),s=(e,o)=>{const t=40*Math.random();return void 0!==t&&(e.value=t),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:e.value>35?"#f00":null}}},d=(e,o)=>{const t=Math.random()>.5?1:0,n=Math.random()>.5?1:0,i=Math.random()>.8?1:0,s=Math.floor(3*Math.random());return{status:i>0?0:t,error:i>0?0:n,remote:1==s?1:0,local:2==s?1:0,disabled:i}},h=e=>{T(e).resize()},f=(e,o)=>{},m=()=>{const e=[[450,1,450],[450,1,-450],[-450,1,-450],[-450,1,450]].map((e=>e.map((e=>e*(.5-.5*Math.random()+1)))));o.cruise&&(o.cruise.points=e)},g=()=>{var e;return null==(e=n.value)?void 0:e.exportImage()};return i((()=>{V.get(K.d3.floor).then((e=>{let t=e.JsonList;const n=e.ModelUrl;t.unshift({name:e.Name,type:"",url:n?`${o.baseUrl}${n}`:""});let i={};if(e.ConfigJson instanceof Object)i=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{i=JSON.parse(e.ConfigJson)}catch(s){}Object.keys(i).forEach((e=>{o.config&&(o.config[e]=i[e])})),o.objects=t.map((e=>("COLD_ROOM_INLET"===e.type&&(e.onClick=e=>{_.success({message:e.name,grouping:!0})}),e)))}))})),(e,t)=>{const i=k,y=M;return a(),l("div",{class:u([e.$style.page,"h-100 o-h"])},[c("div",{class:u(e.$style.operate)},[c("div",oe,[t[1]||(t[1]=c("span",null,"点位：",-1)),p(i,{modelValue:r(o).dotShowStrict,"onUpdate:modelValue":t[0]||(t[0]=e=>r(o).dotShowStrict=e),"active-text":"严格","inactive-text":"全显","inline-prompt":""},null,8,["modelValue"])]),p(y,{type:"success",onClick:m},{default:C((()=>t[2]||(t[2]=[O("切换巡航点位")]))),_:1}),p(y,{type:"primary",size:"small",onClick:g},{default:C((()=>t[3]||(t[3]=[O("导出")]))),_:1})],2),p(ee,{ref_key:"threeSceneRef",ref:n,"dev-env":r(o).devEnv,"base-url":r(o).baseUrl,"bg-color":r(o).bgColor,"bg-url":r(o).bgUrl,env:r(o).env,indexDB:r(o).indexDB,"sky-code":r(o).skyCode,camera:r(o).camera,colors:r(o).colors,cruise:r(o).cruise,render:r(o).render,controls:r(o).controls,grid:r(o).grid,"directional-light":r(o).directionalLight,config:r(o).config,models:r(o).models,"anchor-type":r(o).anchorType,"dot-show-strict":r(o).dotShowStrict,"floor-model-type":r(o).floorModelType,"main-body-change-color":r(o).mainBodyChangeColor,"main-body-mesh-name":r(o).mainBodyMeshName,"animation-model-type":r(o).animationModelType,objects:r(o).objects,"dot-update-object-call":s,"update-object-call":d,onInit:h,onClickDot:f},{dialog:C((({data:o,title:t})=>[c("div",{class:u(e.$style["dialog-wrap"])},[c("div",{class:u(e.$style.circle)},null,2),c("div",{class:u(e.$style.line)},null,2),c("div",{class:u(e.$style.content)},[c("div",{class:u(e.$style.title)},x(t),3),c("div",{class:u(e.$style.data)},x(o),3)],2)],2)])),_:1},8,["dev-env","base-url","bg-color","bg-url","env","indexDB","sky-code","camera","colors","cruise","render","controls","grid","directional-light","config","models","anchor-type","dot-show-strict","floor-model-type","main-body-change-color","main-body-mesh-name","animation-model-type","objects"])],2)}}}),[["__cssModules",{$style:{page:"_page_fyyv5_2",operate:"_operate_fyyv5_8","dialog-wrap":"_dialog-wrap_fyyv5_20",circle:"_circle_fyyv5_26",line:"_line_fyyv5_56",content:"_content_fyyv5_82",title:"_title_fyyv5_89",data:"_data_fyyv5_93"}}]]);export{te as default};
