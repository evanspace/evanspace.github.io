var e=Object.defineProperty,t=(t,o,n)=>(((t,o,n)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n})(t,"symbol"!=typeof o?o+"":o,n),n);import{b4 as o,e as n,i as s,w as a,l as i,aM as l,o as r,g as c,u as d,q as u,p,I as f,m as h,B as m,h as g,n as y,a9 as v,s as _,t as b,a5 as C,a_ as O,a$ as k,aH as x,aa as D,Y as M,c as E,R as w}from"./vendor-eaf8386d.js";import{T as j,d as z,u as L}from"./scene-resize-5f43ff70.js";import{u as T}from"./raycaster-d24ff307.js";import{u as G,a as R,c as N,g as F,s as S,b as U,d as B,e as $}from"./model-loader-f25c4637.js";import{D as A,u as P,a as I}from"./dialog-2831005f.js";import{_ as V,j as K,A as J}from"./common-164461ea.js";const{raycaster:H,pointer:Q,update:W}=T(),{initCSS2DRender:X,createCSS2DDom:q}=G();class Y extends j{constructor(e,o){super(e),t(this,"deviceGroup"),t(this,"dotGroup"),t(this,"extend"),t(this,"css2DRender"),this.extend=o,this.css2DRender=X(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.bindEvent(),this.addDeviceGroup(),this.addDotGroup()}addDeviceGroup(){const e=new o;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const e=new o;e.name="点位组",this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const o=e.position,{size:n,color:s}=e.font||{},{x:a=0,y:i=0,z:l=0}=o||{},r=q({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,i,l],onClick:t});return r.name=e.name,r.data=e,r._position_={x:a,y:i,z:l},this.dotGroup.add(r),r}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall()}onDblclick(e){var t;const o=this.container,n=this.options.scale;if(W(e,o,n),this.deviceGroup){H.setFromCamera(Q,this.camera);const e=[this.deviceGroup],o=H.intersectObjects(e);if(o.length){const e=o[0].object,n=this.findParentGroupGroup(e);if(!n)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(n)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<A.rightClickBackDiffTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o;const n=this.container,s=this.options.scale;W(e,n,s);let a="pointerdown"==e.type||"pointerup"==e.type;const i=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));H.setFromCamera(Q,this.camera);let l=H.intersectObjects(i,a);if(n.style.cursor=l.length>0?"pointer":"auto",a)if(l.length){const e=l[0].object;if(!e)return;"function"==typeof(null==(t=this.extend)?void 0:t.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&o._isDevice_?o:t(o)};return t(e)}getFloor(){return this.deviceGroup.children.filter((e=>e._isFloor_))}hideOmitFloor(e){this.deviceGroup.children.forEach((t=>{t.visible=t._isFloor_||e}))}getAll(){return this.deviceGroup.children.concat(this.dotGroup.children)}getFlowMark(e){return this.getAll().filter((t=>{var o;return(null==(o=t.data)?void 0:o.followMark)===e}))}getAnimTargetPos(e,t,o){const n=t||e.to||{x:-104,y:7,z:58},s=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),n}getPosition(){}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}}const Z={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},ee={key:0,class:"scene-operation"},te=V(n({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoUrl:{default:""},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},directionalLight:{default:()=>({})},models:{},config:{},objects:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},animationModelType:{},floorModelType:{},textModelType:{},anchorType:{default:()=>[]},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:t,emit:n}){const M=e,E=z(Z,M.colors),{change:w,load:j}=P(),{progress:L,loadModel:T,loadModels:G,getModel:V}=R({baseUrl:M.dracoUrl,colors:E,colorMeshName:M.colorMeshName,indexDB:M.indexDB}),{dialog:K}=I(),J=n,H=s(),Q=M.devEnv,W={baseUrl:M.baseUrl,bgUrl:M.bgUrl,env:M.env,bgColor:M.bgColor,camera:M.camera,cruise:M.cruise,fog:M.fog,render:M.render,grid:M.grid,controls:M.controls,axes:M.axes,directionalLight:M.directionalLight};let X;a((()=>M.dotShowStrict),(()=>q())),a((()=>M.scale),(e=>{null==X||X.setScale(e||1)})),a((()=>M.cruise.points),(e=>{L.isEnd&&X.setCruisePoint(e)})),a((()=>M.objects),(()=>{L.isEnd&&re()}));const q=()=>{const e=X.dotGroup.children;for(let t=0;t<e.length;t++){const o=e[t];if(!o.data)continue;o.data.type===M.dotKey&&se(o)}},te=e=>{var t,o,n,s;const a=X.getFloor();if(0===a.length)return;const i=void 0!==e&&e>-1;if((null==(t=M.config)?void 0:t.floorExpandHiddenOther)&&X.hideOmitFloor(!i),a.forEach(((t,o)=>{var n,s,a;const l=t._position_;let r=o-(i?e:o);const c=(null==(n=M.config)?void 0:n.floorExpandMargin)||200,d=(null==(s=M.config)?void 0:s.floorExpandMode)||"UD",u=r*c,p=((null==l?void 0:l.y)??0)+u,f=e==o?((null==l?void 0:l.z)??0)+c:(null==l?void 0:l.z)??0;if("UD"===d){if(t.position.y===p)return}else if("BA"===d&&t.position.z===f)return;if(null==(a=t.data)?void 0:a.mark){const n=t.data.mark,s=X.getFlowMark(n);ne(d,s,u,e==o?c:0)}new O(t.position).to({y:"UD"===d?p:t.position.y,z:"BA"===d?f:t.position.z},500).easing(k.Quadratic.Out).start()})),!(null==(o=M.config)?void 0:o.floorExpandChangeViewAngle))return;let l,r;if(i){const t=a[e]||{};l=null==(n=t.data)?void 0:n.to,l&&(r=(null==(s=t.data)?void 0:s.target)||t._position_)}l=X.getAnimTargetPos(M.config||{},l,r),oe(l)||N(X.camera,l,X.controls.target)},oe=e=>{const t=X.camera.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1},ne=(e,t,o,n)=>{0!==t.length&&t.forEach((t=>{const s=t._position_,a="UD"==e?((null==s?void 0:s.y)??0)+o:(null==s?void 0:s.y)??0,i="BA"==e?((null==s?void 0:s.z)??0)+n:(null==s?void 0:s.z)??0;new O(t.position).to({y:a,z:i},500).easing(k.Quadratic.Out).start()}))},se=e=>{var t;const o=e.data;if("function"==typeof M.dotUpdateObjectCall){const e=M.dotUpdateObjectCall(o,X.deviceGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!M.dotShowStrict;const n=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(n){const{size:e,color:t}=o.font||{};null!=e&&(n.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(n.style.color=t),n.textContent=`${o.value||0}${o.unit}`}},ae=e=>{const t=H.value,o=F(t,e,X.camera);return K.position=o,K.style.left=o.left+"px",K.style.top=o.top+"px",o},ie=async e=>{var t;if(!e)return;const{type:n,url:s}=e,a=V(n);if(!a)return void(s?await(async e=>{const{type:t,url:o="",name:n}=e,s=await T({key:t,url:o,name:n,size:0}),{position:a,scale:i,rotation:l}=$(s,e);return s.scale.set(...i),s.position.set(...a),s.rotation.set(...l),s._isBase_=!0,X.addDevice(s),Promise.resolve(s)})(e):n===M.dotKey&&(e=>{se(X.addDot(e,(t=>{J("click-dot",l(e),t)})))})(e));const i=M.floorModelType||[],r=M.anchorType||[];let c=B(a);const{position:d,scale:u,rotation:p}=$(c,e),[f,h,m]=d;c.scale.set(...u),c.position.set(f,h,m),c.rotation.set(...p);if((M.animationModelType||[]).includes(n)){if("Group"!==c.type){const e=new o;e.add(c),e.name=c.name,c=e}if(M.mainBodyChangeColor){const e=((null==(t=c.children[0])?void 0:t.children)||[]).filter((e=>(M.mainBodyMeshName||[]).some((t=>e.name.indexOf(t)>-1)))),o=E.normal;let n=o.main||o.color,s=U(n);s.length&&e.forEach(((e,t)=>{S(e,s[t%s.length])})),c[A.meshKey.body]=e}}return c._isDevice_=!0,c.data=e,i.includes(n)&&(c._position_={x:f,y:h,z:m},c._isFloor_=!0),r.includes(n)&&(c._isAnchor_=!0),X.addDevice(c),Promise.resolve()},le=s([]),re=async()=>{var e,t,o,n;L.percentage=100,L.show=!1,X.clearDevice(),await D(),(()=>{le.value.length=0;const e=l(M.objects)||[];if("function"!=typeof M.formatObject)le.value=e;else{const t=M.formatObject(e);le.value=t}})(),await(()=>{let e=0,t=le.value.length;return new Promise((o=>{if(0==t)return o(null);const n=async()=>{const s=le.value[e];await ie(s),e++,e<t?n():o(e)};n()}))})(),X.setCruisePoint(M.cruise.points),"function"==typeof(null==(e=M.config)?void 0:e.load)&&(null==(t=M.config)||t.load(X));const s=(null==(o=M.config)?void 0:o.floorExpandIndex)||-1,a=X.getAnimTargetPos(M.config||{}),i=X.getFloor();s>-1&&i.length?(te(s),(null==(n=M.config)?void 0:n.floorExpandChangeViewAngle)||N(X.camera,a,X.controls.target).then((()=>{J("loaded")}))):N(X.camera,a,X.controls.target).then((()=>{J("loaded")}))},ce=()=>{G(M.models,(()=>{re()})),M.skyCode&&j(X,M.skyCode)},de=e=>{const t=[];M.updateObjectCall,X.getAll().forEach(((o,n)=>{if(!o.data)return;const s=o.data;let a=s.type;if(a===M.dotKey)return void se(o);if("function"==typeof M.updateObjectCall){const t=M.updateObjectCall(s,e);if(!t)return;Object.keys(t).forEach((e=>{s[e]=t[e]}))}t.push(l(s));let{status:i=0,error:r=0,remote:c=0,local:d=0,disabled:u=0}=s;const p=E[r>0?"error":i>0?"runing":"normal"];let f=null!=p[a]?p[a]:p.color;if("function"==typeof M.getColorCall){const e=M.getColorCall(s);e&&(f=e)}ue({type:a,el:o,colorObj:p,color:f,paused:0==i,error:r>0,remote:c>0,local:d>0,disabled:u>0})})),J("update",t,e)},ue=e=>{let{el:t,colorObj:o,color:n,paused:s}=e,a=U(n);n=a[0];const i=t.extra;if(i&&(i.action&&(i.action.paused=s),null!=n)){(i.meshs||[]).forEach((e=>{S(e,n)}))}if(M.mainBodyChangeColor&&t[A.meshKey.body]){const e=null!=o.main?o.main:o.color;let n=U(e);n.length&&t[A.meshKey.body].forEach(((e,t)=>{S(e,n[t%n.length])}))}};return i((()=>{W.container=H.value,X=new Y(W,{onDblclick:e=>{const t=e.data,o=X.getFloor().findIndex((t=>e.uuid===t.uuid));"function"==typeof t.onDblclick?t.onDblclick(l(t),e,o):J("dblclick",l(t)),o>-1&&te(o)},onClickLeft(e){if(e){const t=e.data,o=l(t);J("select",o),"function"==typeof t.onClick?(K.show=!1,t.onClick(o)):(K.select=[e],(()=>{const e=K.select[0],t=e.data;K.data=t,K.title=(null==t?void 0:t.name)||"",K.show=!0;const o=ae(e);J("click-dialog-dot",t,o)})())}else K.select=[],K.show=!1},onClickRight:e=>{var t;"function"==typeof(null==(t=M.config)?void 0:t.back)?M.config.back(X):te(-1)},animateCall:()=>{if(K.show&&K.select.length){const e=K.select[0];ae(e)}}}),X.run(),J("init",X),ce()})),t({floorAnimate:te,exportImage:()=>null==X?void 0:X.exportImage(),update:de}),(e,t)=>{const o=x;return r(),c("div",{class:y(e.$style["floor-scene"])},[d(Q)?(r(),c("div",ee,[u(o,{type:"success",onClick:t[0]||(t[0]=()=>de(!0))},{default:p((()=>t[7]||(t[7]=[f("随机更新")]))),_:1}),e.cruise.visible?(r(),h(o,{key:0,onClick:t[1]||(t[1]=()=>{var e;return null==(e=d(X))?void 0:e.toggleCruise()}),type:"danger"},{default:p((()=>t[8]||(t[8]=[f("定点巡航")]))),_:1})):m("",!0),u(o,{onClick:t[2]||(t[2]=()=>{var e;return null==(e=d(X))?void 0:e.getPosition()}),type:"success"},{default:p((()=>t[9]||(t[9]=[f("场景坐标")]))),_:1}),u(o,{type:"warning",onClick:t[3]||(t[3]=()=>d(w)(d(X)))},{default:p((()=>t[10]||(t[10]=[f("切换背景")]))),_:1}),u(o,{type:"danger",onClick:t[4]||(t[4]=()=>{var e;return null==(e=d(X))?void 0:e.controlReset()})},{default:p((()=>t[11]||(t[11]=[f("控制器重置")]))),_:1}),e.cruise.visible?(r(),h(o,{key:1,type:"danger",onClick:t[5]||(t[5]=()=>{var e;return null==(e=d(X))?void 0:e.toggleCruiseDepthTest()})},{default:p((()=>t[12]||(t[12]=[f("巡航深度")]))),_:1})):m("",!0)])):m("",!0),g("div",{class:y(e.$style.container),ref_key:"containerRef",ref:H},null,2),d(L).show?(r(),c("div",{key:1,class:y(["loading",e.$style.loading]),style:v({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[6]||(t[6]=_((()=>{}),["stop"]))},[g("div",{class:y(e.$style.progress),style:v({"--percentage":d(L).percentage+"%"})},[g("div",{class:y(e.$style["bar-out"])},[g("div",{class:y(e.$style.bar)},null,2)],2),g("div",{class:y(e.$style.text)},b(d(L).percentage)+"%",3)],6)],38)):m("",!0),d(K).show?(r(),c("div",{key:2,class:y(e.$style.dialog),style:v(d(K).style)},[C(e.$slots,"dialog",{data:d(K).data,title:d(K).title,position:d(K).position})],6)):m("",!0)],2)}}}),[["__cssModules",{$style:{"floor-scene":"_floor-scene_n6fsz_2",container:"_container_n6fsz_8",loading:"_loading_n6fsz_12",progress:"_progress_n6fsz_27","bar-out":"_bar-out_n6fsz_31",bar:"_bar_n6fsz_31","striped-flow":"_striped-flow_n6fsz_1",text:"_text_n6fsz_55",dialog:"_dialog_n6fsz_63"}}]]),oe={class:"flex flex-ac"},ne=V(n({__name:"index",setup(e){const t=M({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",render:{alpha:!0,preserveDrawingBuffer:!0},env:"/oss/textures/hdr/skidpan_2k.hdr",camera:{far:1e6},colors:{normal:{main:65280},runing:{main:16715760,text:0}},cruise:{visible:!0,points:[[450,490,450],[450,490,-450],[-450,490,-450],[-450,490,450]],offset:10},controls:{screenSpacePanning:!1,maxDistance:5e3,maxPolarAngle:.46*Math.PI},directionalLight:{helper:!1},grid:{visible:!0},models:[{key:"FLOOR_ONE",name:"大堂",size:8.5,url:"/1楼.glb"},{key:"FLOOR_COMMON",name:"楼层",size:13.7,url:"/楼层.glb"},{key:"FLOOR_ATTIC",name:"楼顶",size:.1,url:"/楼顶.glb"},{key:"COLD_CAMERA",name:"摄像头",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/sxt.png"},{key:"COLD_ROOM_INLET",name:"房间入口",type:"sprite",size:1,range:{x:37,y:77},mapUrl:"/fjdw.png"},{key:"COLD_GPS",name:"定位",type:"sprite",size:1,range:{x:51,y:56},mapUrl:"/dw.png"}].map((e=>(e.url&&(e.url="/oss/model/floor"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/floor"+e.mapUrl),e))),objects:[],config:{},indexDB:{cache:!0,dbName:"THREE__FLOOR__DB",tbName:"TB",version:1},dotShowStrict:!1,colorMeshName:[],floorModelType:["FLOOR_COMMON","FLOOR_ONE","FLOOR_TWO_FIVE","FLOOR_SIX","FLOOR_SEVEN_ELEVEN","FLOOR_TWELVE_THIRTEEN","FLOOR_FOURTEEN_SIXTEEN","FLOOR_SEVENTEEN_EIGHTEEN"],anchorType:["COLD_CAMERA","COLD_ROOM_INLET","COLD_GPS"],mainBodyChangeColor:!0,mainBodyMeshName:["立方体062"],animationModelType:["FLOOR_COMMON"]}),o=s(),n=(e,t)=>{const o=40*Math.random();return void 0!==o&&(e.value=o),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:e.value>35?"#f00":null}}},a=(e,t)=>{const o=Math.random()>.5?1:0,n=Math.random()>.5?1:0,s=Math.random()>.8?1:0,a=Math.floor(3*Math.random());return{status:s>0?0:o,error:s>0?0:n,remote:1==a?1:0,local:2==a?1:0,disabled:s}},l=e=>{L(e).resize()},h=(e,t)=>{},m=()=>{const e=[[450,1,450],[450,1,-450],[-450,1,-450],[-450,1,450]].map((e=>e.map((e=>e*(.5-.5*Math.random()+1)))));t.cruise&&(t.cruise.points=e)},v=()=>{var e;return null==(e=o.value)?void 0:e.exportImage()};return i((()=>{K.get(J.d3.floor).then((e=>{let o=e.JsonList;const n=e.ModelUrl;o.unshift({name:e.Name,type:"",url:n?`${t.baseUrl}${n}`:""});let s={};if(e.ConfigJson instanceof Object)s=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{s=JSON.parse(e.ConfigJson)}catch(a){}Object.keys(s).forEach((e=>{t.config&&(t.config[e]=s[e])})),t.objects=o.map((e=>("COLD_ROOM_INLET"===e.type&&(e.onClick=e=>{E.success({message:e.name,grouping:!0})}),e)))}))})),(e,s)=>{const i=w,_=x;return r(),c("div",{class:y([e.$style.page,"h-100 o-h"])},[g("div",{class:y(e.$style.operate)},[g("div",oe,[s[1]||(s[1]=g("span",null,"点位：",-1)),u(i,{modelValue:d(t).dotShowStrict,"onUpdate:modelValue":s[0]||(s[0]=e=>d(t).dotShowStrict=e),"active-text":"严格","inactive-text":"全显","inline-prompt":""},null,8,["modelValue"])]),u(_,{type:"success",onClick:m},{default:p((()=>s[2]||(s[2]=[f("切换巡航点位")]))),_:1}),u(_,{type:"primary",size:"small",onClick:v},{default:p((()=>s[3]||(s[3]=[f("导出")]))),_:1})],2),u(te,{ref_key:"threeSceneRef",ref:o,"dev-env":d(t).devEnv,"base-url":d(t).baseUrl,"bg-color":d(t).bgColor,"bg-url":d(t).bgUrl,env:d(t).env,indexDB:d(t).indexDB,"sky-code":d(t).skyCode,camera:d(t).camera,colors:d(t).colors,cruise:d(t).cruise,render:d(t).render,controls:d(t).controls,grid:d(t).grid,"directional-light":d(t).directionalLight,config:d(t).config,models:d(t).models,"anchor-type":d(t).anchorType,"dot-show-strict":d(t).dotShowStrict,"floor-model-type":d(t).floorModelType,"main-body-change-color":d(t).mainBodyChangeColor,"main-body-mesh-name":d(t).mainBodyMeshName,"animation-model-type":d(t).animationModelType,objects:d(t).objects,"dot-update-object-call":n,"update-object-call":a,onInit:l,onClickDot:h},{dialog:p((({data:t,title:o})=>[g("div",{class:y(e.$style["dialog-wrap"])},[g("div",{class:y(e.$style.circle)},null,2),g("div",{class:y(e.$style.line)},null,2),g("div",{class:y(e.$style.content)},[g("div",{class:y(e.$style.title)},b(o),3),g("div",{class:y(e.$style.data)},b(t),3)],2)],2)])),_:1},8,["dev-env","base-url","bg-color","bg-url","env","indexDB","sky-code","camera","colors","cruise","render","controls","grid","directional-light","config","models","anchor-type","dot-show-strict","floor-model-type","main-body-change-color","main-body-mesh-name","animation-model-type","objects"])],2)}}}),[["__cssModules",{$style:{page:"_page_fyyv5_2",operate:"_operate_fyyv5_8","dialog-wrap":"_dialog-wrap_fyyv5_20",circle:"_circle_fyyv5_26",line:"_line_fyyv5_56",content:"_content_fyyv5_82",title:"_title_fyyv5_89",data:"_data_fyyv5_93"}}]]);export{ne as default};
