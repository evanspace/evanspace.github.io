import{bO as e,bP as t,be as a,bQ as o,bR as n,bS as s,bT as r,bo as i,bc as l,bs as c,bU as d,Y as m,c6 as p,c7 as h,c8 as u,c9 as w,b6 as b,bV as y,c4 as f,bp as x,bN as g,bk as _,cA as v,cB as z,cC as M,cD as S}from"./vendor-d68cddd1.js";import{D as P,g as B}from"./config-51e0289e.js";import{d as k}from"./object-be545f18.js";const A=e=>new Promise((t=>{const a=window.indexedDB.deleteDatabase(e);a.onsuccess=e=>{t(!0)},a.onerror=e=>{t(!1)}})),D=async(e,t="THREE__MODEL_DB",a=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await((e,t,a)=>new Promise((o=>{window.indexedDB.open(e).onsuccess=n=>{const s=n.target.result,r=s.version;s.close(),r!==t?A(e).then((e=>{o(e?t:r)})):s.objectStoreNames.contains(a)?o(r):A(e).then((e=>{o(e?t:r)}))}})))(t,a,e);let o=window.indexedDB.open(t,a);return new Promise((t=>{o.onupgradeneeded=t=>{const a=t.target.result;a.objectStoreNames.contains(e)||a.createObjectStore(e,{keyPath:"path"})},o.onsuccess=e=>{const a=e.target.result;t(a)},o.onerror=e=>{t(void 0)}}))},N=(e,t,a=1)=>{const o=e.position,n=e.rotation,s=e.scale,r=t.position||{x:0,y:0,z:0},i=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(i.x)<2?1:180,d=Math.abs(i.y)<2?1:180,m=Math.abs(i.z)<2?1:180;return{position:[o.x+r.x,o.y+r.y,o.z+r.z],rotation:[n.x+Math.PI/c*i.x,n.y+Math.PI/d*i.y,n.z+Math.PI/m*i.z],scale:[s.x*a*l.x,s.y*a*l.y,s.z*a*l.z]}},E=e=>{e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()},T=e=>{let t=e.clone();return(e.isMesh||e.isSprite)&&E(e),t.traverse((e=>{e.isMesh&&E(e)})),t},U=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},I=(e,t)=>{e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},O=(o,n,s=new a)=>(o.lookAt(s),o._lookAt_=s,new Promise((a=>{new e(o.position).to(n,1e3).easing(t.Quadratic.In).start().onUpdate((()=>{o.lookAt(s),o._lookAt_=s})).onComplete((()=>{a(o)}))}))),j=(a,o,n)=>new Promise((s=>{new e(n).to(o,1e3).easing(t.Quadratic.In).start().onUpdate((e=>{a.lookAt(e),a._lookAt_=e})).onComplete((()=>{s(a)}))})),L=(a,o,n,s)=>new Promise((r=>{new e(o.position).to(n,1e3).easing(t.Quadratic.In).start().onUpdate((()=>{const e=a.target;o.lookAt(e),o._lookAt_=e})),new e(a.target).to(s,1e3).easing(t.Quadratic.In).start().onComplete((()=>{r(o)}))})),C=(e,t,a=1,r=10)=>{let i=[0,r/2,r],l=[...t,t[0],t[1]+a,t[2],...t],c=new o("sprite.position",i,l),d=new n("sprite_up_down",r,[c]);const m=new s(e),p=m.clipAction(d);return p.timeScale=5,p.play(),e.__action__=p,e.__mixer__=m,e},K=(e,t,a)=>{let o=e.clientWidth/2,n=e.clientHeight/2,s=t.position.clone();const r=t.scale;s.y+=r.x/2;let i=s.project(a);return{left:i.x*o+o,top:-i.y*n+n}},Q=(e,t,a="name")=>{let o=[];if(!e||!e.length)return[];return function e(n){n.forEach((n=>{const s=n[a];"string"==typeof s&&t.some((e=>s.indexOf(e)>-1))&&o.push(n),n.children&&e(n.children)}))}(e),o},R=P.statusOffset,V=(e,t,a={})=>{const o=t.type,n=R[e]||{},s=a[o]||n[o]||{};let r=k({x:0,y:0,z:0},s.position||{}),i=k({x:0,y:0,z:0},s.rotation||{});return i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z,{position:r,rotation:i}},W=(e,t,a=16777215,o)=>{const n=V("TEXT",e,o);let s=e.font||{},c=new r(e.name||"",{font:t,size:s.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const d=n.rotation;c.rotateX(d.x),c.rotateY(d.y),c.rotateZ(d.z);const m=n.position;c.computeBoundingBox(),c.computeVertexNormals();let p=.5*(c.boundingBox.max.x-c.boundingBox.min.x),h=.5*(c.boundingBox.max.z-c.boundingBox.min.z),u=new i({color:null!=s.color?s.color:a,flatShading:!1}),w=new l(c,u);return w.castShadow=!0,w.position.set((m.x||0)-p,m.y||0,(m.z||0)-h),w.name="text",w._isText_=!0,w},X=(e,t,a,r,i=100,l=1)=>{if(!a)return;const m=V("WARNING",t,r);let p=new c,h=T(a);h.scale.set(l,l,l);const u=m.position;h.position.set(u.x,u.y,u.z);const w=m.rotation;h.rotation.set(w.x,w.y,w.z),p.add(h);let b=new d(12717056,8,i,0);b.name="灯光",b.position.y=u.y+30,p.add(b),p.name=e;let y=new s(p),f=new o("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),x=new o("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),g=new o("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),_=new n("warning_",1,[f,x,g]),v=y.clipAction(_);return v.paused=!0,v.play(),p.visible=!1,p._isWarning_=!0,{group:p,action:v,mixer:y}},G=(e,t,a,o)=>{if(!t)return;const n=V(o?"DISABLED":"STATUS",e,a);let s=T(t);const r=n.position;s.position.set(r.x,r.y,r.z);const i=n.rotation;return s.rotation.set(i.x,i.y,i.z),s.visible=!1,s._isStatus_=!0,s},H=(e={})=>{let t;const a=k({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},e),o=m({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),n={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},s=new Map,r=new p;r.setDecoderPath(a.baseUrl+a.dracoPath);const i=new h;i.setDRACOLoader(r);const l=new u;l.setTranscoderPath(a.baseUrl+a.basisPath),i.setKTX2Loader(l),i.setMeshoptDecoder(w);const d=e=>{const t=e.loaded,a=o.total;let n=Number((t+o.loaded)/a*100);n>100&&(n=100),o.percentage=Number(n.toFixed(2))},A=(e,t,o,n)=>{if(!o)return;const{baseUrl:r,colorMeshName:i}=a,{mapUrl:l,key:c,mapMeshName:d,repeat:m=[1,1]}=e;let p;l&&d&&(p=(new b).load(B(l,r)),p.wrapS=y,p.wrapT=y,p.repeat.set(m[0],m[1]));const h=T(o);return h.traverse((e=>{e.isMesh&&p&&e.name.indexOf(d)>-1?e.material=new f({side:x,transparent:!0,opacity:0,map:p.clone()}):((e,t=6776165,a,o)=>{const{type:n,name:s}=e;n.indexOf("Light"),P.mesh.receiveShadowName.some((e=>s.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):a.some((e=>s.indexOf(e)>-1))?I(e,t):e.isMesh&&(o&&(e.material.envMap=o),e.castShadow=!0,e.receiveShadow=!0)})(e,t,i||[])})),l&&d&&(h._mapMeshName_=d),h.animations=n,c&&s.set(c,h),h},N=(e,o=0)=>new Promise((async n=>{var s;a.indexDB.cache||n(null);const r=g.get(e);if(r)r instanceof ArrayBuffer?(d({loaded:r.byteLength}),i.parse(r,"",(t=>{g.add(e,t),n(t)}))):(d({loaded:o*a.modelSizeKB}),setTimeout((()=>{n(r)}),10));else{const o=await((e,t,a)=>{if(!e||!t||!a)return Promise.resolve(null);const o=e.transaction([t],"readonly").objectStore(t).get(a);return new Promise(((e,t)=>{o.onsuccess=t=>{const a=t.target.result;e(a)},o.onerror=e=>{t(e)}}))})(t,(null==(s=a.indexDB)?void 0:s.tbName)||P.indexdb.tbName,e);if(o&&o.data){const e=o.data;"string"==typeof e?(d({loaded:e.length}),g.add(o.path,e),setTimeout((()=>{n(e)}),10)):(d({loaded:e.byteLength}),i.parse(e,"",(e=>{g.add(o.path,e),n(e)})))}else n(null)}})),E=e=>{var o;if(!a.indexDB.cache)return;const n=g.get(e);if(n&&t){const s=(null==(o=a.indexDB)?void 0:o.tbName)||P.indexdb.tbName;t.transaction(s,"readwrite").objectStore(s).add({path:e,data:n})}},O=(e,t)=>{const{key:o,url:n="",size:s=0}=e,{baseUrl:r,colors:l}=a;return new Promise((async(a,m)=>{let p=l.normal[o]||l.normal.color;p=U(p)[0];const h=B(n,r),u=await N(h,s);if(u){const t=u.scene.children[0],o=A(e,p,t,u.animations);return void a(o)}let w=(h.split(".").pop()||"").toLowerCase();if("glb"!==w)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+w);i.load(h,(t=>{const o=t.scene.children;let n=new c;o.length>1?n.add(...o):n=o[o.length-1];const s=A(e,p,n,t.animations);E(h),a(s)}),(e=>{d(e),"function"==typeof t&&t(e)}),m)}))},j=(e,t={})=>{t=k({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},t),e.traverse((e=>{var a;(null==(a=t.filter)?void 0:a.includes(e.name))||L(e.name,t.filterMatch)||e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new _({color:t.color,wireframe:t.wireframe,transparent:!0,opacity:t.opacity}))}))},L=(e="",t=[])=>t.filter((t=>e.indexOf(t)>-1)).length>0;return{progress:o,MODEL_MAP:n,loadModel:O,loadModels:async(e,r,i)=>{var l,c,m;await D((null==(l=a.indexDB)?void 0:l.tbName)||P.indexdb.tbName,(null==(c=a.indexDB)?void 0:c.dbName)||P.indexdb.dbName,(null==(m=a.indexDB)?void 0:m.version)||P.indexdb.version).then((e=>(e&&(g.enabled=!0,t=e),e)));const p=e.length;if(!(0==p?(o.isEnd=!0,o.show=!1,0):(o.isEnd=!1,o.percentage=0,o.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)o.total+=(e[t].size||0)*a.modelSizeKB})(e);let h=0;const u=async()=>{const t=e[h],{type:l=n.device,size:c=0}=t;switch(l){case n.device:case n.pipe:await O(t,i);break;case n.sprite:(e=>{const{key:t,range:o={x:1,y:1},mapUrl:n=""}=e;let r=(new b).load(a.baseUrl+n),i=new v({map:r}),l=new z(i),c=o.x,d=o.y;l.scale.set(c,d,1),l.name="sprite",s.set(t,l)})(t);break;case n.font:await((e,t)=>{const{url:o="",size:r=0}=e,{baseUrl:i}=a,l=B(o,i),c=new M;return new Promise((async(e,a)=>{const o=await N(l,r);if(o){const t=c.parse(JSON.parse(o));return s.set(n.font,t),void setTimeout((()=>{e(t)}),10)}c.load(l,(t=>{s.set(n.font,t),E(l),e(t)}),(e=>{d(e),"function"==typeof t&&t(e)}),a)}))})(t,i);break;case n.warning:t.key=n.warning,await O(t,i);break;case n.local:t.key=n.local,await O(t,i);break;case n.disabled:t.key=n.disabled,await O(t,i);break;case n.spotlight:(e=>{const{key:t,color:a=16777215,intensity:o=8,distance:n=10,angle:r=.2*Math.PI,penumbra:i=.2,decay:l=0}=e;let c=new S(a,o,n,r,i,l);c.castShadow=!0,c.visible=!1,s.set(t,c)})(t)}h++,o.loaded+=c*a.modelSizeKB,h>=p?(o.percentage=100,o.isEnd=!0,r()):u()};u()},getModel:e=>s.get(e),virtualization:(e=[],t,a={})=>{const o=a.filter||[],n=a.filterMatch||[];if(e.length)for(let s=0;s<e.length;s++){const r=e[s];t.uuid===r.uuid||o.includes(r.name)||L(r.name,n)||j(r,a)}else j(t,a)},closeVirtualization:e=>{if(Array.isArray(e))for(let t=0;t<e.length;t++)e[t].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}};export{U as a,N as b,O as c,W as d,X as e,Q as f,K as g,G as h,C as i,L as j,j as k,T as m,I as s,H as u};
