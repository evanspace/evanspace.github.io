import{Y as e,c6 as a,c7 as t,c8 as s,c9 as r,bs as o,b6 as n,bV as i,c4 as l,bp as c,bN as d,bk as m,cA as p,cB as b,cC as w,cD as h}from"./vendor-16889df9.js";import{g as u}from"./convert-17a5875b.js";import{g as f,m as g,r as y}from"./model-3a962665.js";import{d as v,D as _}from"./object-fb68a4c2.js";const x=e=>new Promise((a=>{const t=window.indexedDB.deleteDatabase(e);t.onsuccess=e=>{a(!0)},t.onerror=e=>{a(!1)}})),D=(e,a,t)=>new Promise((s=>{window.indexedDB.open(e).onsuccess=r=>{const o=r.target.result,n=o.version;o.close(),n!==a?x(e).then((e=>{s(e?a:n)})):o.objectStoreNames.contains(t)?s(n):x(e).then((e=>{s(e?a:n)}))}})),B=async(e,a="THREE__MODEL_DB",t=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await D(a,t,e);let s=window.indexedDB.open(a,t);return new Promise((a=>{s.onupgradeneeded=a=>{const t=a.target.result;t.objectStoreNames.contains(e)||t.createObjectStore(e,{keyPath:"path"})},s.onsuccess=e=>{const t=e.target.result;a(t)},s.onerror=e=>{a(void 0)}}))},M=(e,a,t)=>{if(!e||!a||!t)return Promise.resolve(null);const s=e.transaction([a],"readonly").objectStore(a).get(t);return new Promise(((e,a)=>{s.onsuccess=a=>{const t=a.target.result;e(t)},s.onerror=e=>{a(e)}}))},P=(e,a)=>{const t=e.transaction(a,"readonly").objectStore(a).getAll();return new Promise(((e,a)=>{t.onsuccess=a=>{const t=a.target.result;e(t)},t.onerror=e=>{a(e)}}))},N=(x={})=>{let D;const P=v({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},x),N=e({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),k={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},S=new Map,j=new a;j.setDecoderPath(P.baseUrl+P.dracoPath);const z=new t;z.setDRACOLoader(j);const E=new s;E.setTranscoderPath(P.baseUrl+P.basisPath),z.setKTX2Loader(E),z.setMeshoptDecoder(r);const U=e=>{const a=e.loaded,t=N.total;let s=Number((a+N.loaded)/t*100);s>100&&(s=100),N.percentage=Number(s.toFixed(2))},L=(e,a,t,s)=>{if(!t)return;const{baseUrl:r,colorMeshName:o}=P,{mapUrl:d,key:m,mapMeshName:p,repeat:b=[1,1]}=e;let w;d&&p&&(w=(new n).load(u(d,r)),w.wrapS=i,w.wrapT=i,w.repeat.set(b[0],b[1]));const h=g(t);return h.traverse((e=>{e.isMesh&&w&&e.name.indexOf(p)>-1?e.material=new l({side:c,transparent:!0,opacity:0,map:w.clone()}):y(e,a,o||[])})),d&&p&&(h._mapMeshName_=p),h.animations=s,m&&S.set(m,h),h},A=(e,a=0)=>new Promise((async t=>{var s;P.indexDB.cache||t(null);const r=d.get(e);if(r)r instanceof ArrayBuffer?(U({loaded:r.byteLength}),z.parse(r,"",(a=>{d.add(e,a),t(a)}))):(U({loaded:a*P.modelSizeKB}),setTimeout((()=>{t(r)}),10));else{const a=await M(D,(null==(s=P.indexDB)?void 0:s.tbName)||_.indexdb.tbName,e);if(a&&a.data){const e=a.data;"string"==typeof e?(U({loaded:e.length}),d.add(a.path,e),setTimeout((()=>{t(e)}),10)):(U({loaded:e.byteLength}),z.parse(e,"",(e=>{d.add(a.path,e),t(e)})))}else t(null)}})),O=e=>{var a;if(!P.indexDB.cache)return;const t=d.get(e);if(t&&D){const s=(null==(a=P.indexDB)?void 0:a.tbName)||_.indexdb.tbName;D.transaction(s,"readwrite").objectStore(s).add({path:e,data:t})}},T=(e,a)=>{const{key:t,url:s="",size:r=0}=e,{baseUrl:n,colors:i}=P;return new Promise((async(l,c)=>{let d=i.normal[t]||i.normal.color;d=f(d)[0];const m=u(s,n),p=await A(m,r);if(p){const a=p.scene.children[0],t=L(e,d,a,p.animations);return void l(t)}let b=(m.split(".").pop()||"").toLowerCase();if("glb"!==b)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+b);z.load(m,(a=>{const t=a.scene.children;let s=new o;t.length>1?s.add(...t):s=t[t.length-1];const r=L(e,d,s,a.animations);O(m),l(r)}),(e=>{U(e),"function"==typeof a&&a(e)}),c)}))},K=(e,a={})=>{a=v({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},a),e.traverse((e=>{var t;(null==(t=a.filter)?void 0:t.includes(e.name))||C(e.name,a.filterMatch)||e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new m({color:a.color,wireframe:a.wireframe,transparent:!0,opacity:a.opacity}))}))},C=(e="",a=[])=>a.filter((a=>e.indexOf(a)>-1)).length>0;return{progress:N,MODEL_MAP:k,loadModel:T,loadModels:async(e,a,t)=>{var s,r,o;await B((null==(s=P.indexDB)?void 0:s.tbName)||_.indexdb.tbName,(null==(r=P.indexDB)?void 0:r.dbName)||_.indexdb.dbName,(null==(o=P.indexDB)?void 0:o.version)||_.indexdb.version).then((e=>(e&&(d.enabled=!0,D=e),e)));const i=e.length;if(!(0==i?(N.isEnd=!0,N.show=!1,0):(N.isEnd=!1,N.percentage=0,N.show=!0,1)))return;(e=>{for(let a=0;a<e.length;a++)N.total+=(e[a].size||0)*P.modelSizeKB})(e);let l=0;const c=async()=>{const s=e[l],{type:r=k.device,size:o=0}=s;switch(r){case k.device:case k.pipe:await T(s,t);break;case k.sprite:(e=>{const{key:a,range:t={x:1,y:1},mapUrl:s=""}=e;let r=(new n).load(P.baseUrl+s),o=new p({map:r}),i=new b(o),l=t.x,c=t.y;i.scale.set(l,c,1),i.name="sprite",S.set(a,i)})(s);break;case k.font:await((e,a)=>{const{url:t="",size:s=0}=e,{baseUrl:r}=P,o=u(t,r),n=new w;return new Promise((async(e,t)=>{const r=await A(o,s);if(r){const a=n.parse(JSON.parse(r));return S.set(k.font,a),void setTimeout((()=>{e(a)}),10)}n.load(o,(a=>{S.set(k.font,a),O(o),e(a)}),(e=>{U(e),"function"==typeof a&&a(e)}),t)}))})(s,t);break;case k.warning:s.key=k.warning,await T(s,t);break;case k.local:s.key=k.local,await T(s,t);break;case k.disabled:s.key=k.disabled,await T(s,t);break;case k.spotlight:(e=>{const{key:a,color:t=16777215,intensity:s=8,distance:r=10,angle:o=.2*Math.PI,penumbra:n=.2,decay:i=0}=e;let l=new h(t,s,r,o,n,i);l.castShadow=!0,l.visible=!1,S.set(a,l)})(s)}l++,N.loaded+=o*P.modelSizeKB,l>=i?(N.percentage=100,N.isEnd=!0,a()):c()};c()},getModel:e=>S.get(e),virtualization:(e=[],a,t={})=>{const s=t.filter||[],r=t.filterMatch||[];if(e.length)for(let o=0;o<e.length;o++){const n=e[o];a.uuid===n.uuid||s.includes(n.name)||C(n.name,r)||K(n,t)}else K(a,t)},closeVirtualization:e=>{if(Array.isArray(e))for(let a=0;a<e.length;a++)e[a].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}};export{D as a,M as b,B as c,x as d,P as g,N as u};
