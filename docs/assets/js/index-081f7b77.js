var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{u as s,t as i}from"./css2d-e7bfc4ea.js";import{e as n,A as o,_ as a}from"./index-702310d9.js";import{bC as r,bP as c,bO as l,cW as h,bg as u,bj as d,bK as p,bQ as g,b7 as m,bc as f,bH as y,bi as _,cg as b,c as v,bh as x,e as C,Y as k,i as w,l as A,f as j,aa as z,o as G,g as M,h as P,u as D,n as S,q as T,F as O,r as $,t as F,a9 as B,B as R}from"./vendor-e97c0668.js";import{_ as E,a as N,b as L,c as U,e as H,f as I,h as J,i as K,j as V,k as q,l as W,m as Y,n as Q,o as X,p as Z,q as tt,r as et,T as st,u as it}from"./scene-resize-5e6368b3.js";import{u as nt,a as ot}from"./background-e5043105.js";import{u as at,a as rt}from"./move-animate-8a7d9c48.js";import{j as ct,k as lt,l as ht,u as ut,c as dt,d as pt,b as gt}from"./model-loader-377ddfd5.js";import"./config-b6242c11.js";const mt="ANCHOR_POS",ft="MAIN_SCENE",yt="ROBOT",_t="CHARACTER",bt=27.5,vt=t=>new URL(Object.assign({"../assets/imgs/texttures/arrow.png":E,"../assets/imgs/texttures/border.png":N,"../assets/imgs/texttures/circle.png":L,"../assets/imgs/texttures/fenceMap0.png":U,"../assets/imgs/texttures/fenceMap1.png":H,"../assets/imgs/texttures/fenceMap2.png":I,"../assets/imgs/texttures/gz-map-fx.jpg":J,"../assets/imgs/texttures/gz-map.jpg":K,"../assets/imgs/texttures/inner-circle.png":V,"../assets/imgs/texttures/lensflare/lensflare0.png":q,"../assets/imgs/texttures/lensflare/lensflare0_alpha.png":W,"../assets/imgs/texttures/lensflare/lensflare1.png":Y,"../assets/imgs/texttures/lensflare/lensflare2.png":Q,"../assets/imgs/texttures/lensflare/lensflare3.png":X,"../assets/imgs/texttures/light.png":Z,"../assets/imgs/texttures/out-circle.png":tt,"../assets/imgs/texttures/point.png":et})[`../assets/imgs/texttures/${t}`],self.location).href,xt=300,{raycaster:Ct,pointer:kt,update:wt,style:At}=nt(),{initCSS2DRender:jt,createCSS2DDom:zt}=s(),{createDiffusion:Gt,updateDiffusion:Mt}=at(),{createMove:Pt,moveAnimate:Dt}=rt(),{createFence:St,fenceAnimate:Tt}=(()=>{const t=[1,.8],e=.2,s=(new r).load(vt("fenceMap0.png"),(s=>{s.wrapT=c,s.repeat.x=t[0],s.repeat.y=t[1],s.offset.y=e})),i=(new r).load(vt("fenceMap1.png"),(s=>{s.wrapT=c,s.repeat.x=t[0],s.repeat.y=t[1],s.offset.x=e})),n=(new r).load(vt("fenceMap2.png"),(t=>{t.wrapS=c,t.wrapT=c})),o=(t,e,o)=>{const a=[];for(let s=0;s<e.length;s++){const i=e[s];a.push(...t[i])}const r=new u,c=new Float32Array(a);r.setAttribute("position",new d(c,3));const h=e.length,y=new d(new Float32Array(3*h),3);r.setAttribute("normal",y);for(let s=0;s<h;s++)y.setXYZ(s,0,0,0);const _=new d(new Float32Array([1,1,0,1,0,0,0,0,1,0,1,1]),2);r.setAttribute("uv",_);const b=new p({color:o,map:s,transparent:!0,blending:g,side:m}),v=new p({color:o,map:i,transparent:!0,blending:g,side:m});var x=new p({color:o,map:n,opacity:.5,transparent:!0,side:m});const C=new f(r,b),k=new l,w=new f(r,v),A=new f(r,x);return k.add(C,w,A),k};return{createFence:(t,e=11009923)=>{const s=new l;var i=new h(t,e);i.update();const n=i.geometry.getAttribute("position").array,a=[];for(let o=0;o<n.length;o+=3){const t=n[o],e=n[o+1],s=n[o+2];a.push([t,e,s])}const r=o(a,[0,1,2,2,3,0],e),c=o(a,[4,5,6,6,7,4],e),u=o(a,[4,0,3,3,7,4],e),d=o(a,[1,5,6,6,2,1],e);return s.add(r,c,u,d),s},fenceAnimate:(t=1)=>{const n=.008*t;if(s){let t=s.offset.y-n;t<0&&(t=e),s.offset.y=t}if(i){let t=i.offset.y-n;t<0&&(t=e),i.offset.y=t}}}})(),Ot="FULL",$t="NPC";class Ft extends st{constructor(t,s){super(t),e(this,"buildingGroup"),e(this,"anchorGroup"),e(this,"dotGroup"),e(this,"extend"),e(this,"css2DRender"),e(this,"mouseClickDiffusion"),e(this,"character"),e(this,"clock"),e(this,"currentSight"),e(this,"historyTarget"),e(this,"historyCameraPosition"),e(this,"animateModels"),e(this,"moveFactor",1),e(this,"fence"),this.extend=s,this.css2DRender=jt(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=Gt(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.clock=new y,this.currentSight=Ot,this.historyTarget=new _,this.historyCameraPosition=new _,this.animateModels=[],this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup()}addBuildingGroup(){const t=new l;t.name="建筑组",this.buildingGroup=t,this.addObject(t)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot()}addBuilding(...t){this.buildingGroup&&this.buildingGroup.add(...t)}addAnchorGroup(){const t=new l;t.name="锚点组",this.anchorGroup=t,this.addObject(t)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(t){this.anchorGroup&&this.anchorGroup.add(t);const{x:e,y:s,z:i}=t.position;ct(t,[e,s,i],1,8)}addDotGroup(){const t=new l;t.name="点位组",this.dotGroup=t,this.scene.add(t)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(t,e){const s=t.position,{size:i,color:n}=t.font||{},{x:o=0,y:a=0,z:r=0}=s||{},c=zt({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=i?`font-size: ${"string"==typeof i?i:i+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[o,a,r],onClick:e});return c.name=t.name,c.data=t,c._position_={x:o,y:a,z:r},this.dotGroup.add(c),c}addCharacter(t,e){const{x:s,y:i,z:n}=e;t.position.set(s,i,n),this.character=t;const o=t.animations,a=new b(t),r={};for(let l=0;l<o.length;l++){const t=o[l],e=a.clipAction(t);r[t.name]=e}r.Dance.play();const c=r.Walking;t.extra={mixer:a,actions:r,runging:c},this.addObject(t)}toggleSight(){if(this.judgeCruise())return;const t=this.currentSight==Ot?$t:Ot;this.currentSight=t;const e=t===$t;this.controls.maxDistance=e?20:800,this.controls.screenSpacePanning=!e,this.controls.enablePan=!e;const s=this.controls.target,i=this.character.position;if(e){const{x:t,y:e,z:n}=s;this.historyTarget=new _(t,e,n);const{x:o,y:a,z:r}=i;this.historyCameraPosition=new _(o,a,r),this.camera.lookAt(new _(o,a+3,r))}else{const{x:t,y:e,z:s}=this.historyCameraPosition;this.camera.position.set(t,e,s),this.camera.lookAt(i)}const{x:n,y:o,z:a}=e?i:this.historyTarget;s.set(n,o,a)}isPerspectives(){return this.currentSight==$t}characterAccelerate(t=1){this.moveFactor+=t,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),v.success({message:"人物速度："+this.moveFactor,grouping:!0})}setControlTarget(t){const{x:e,y:s,z:i}=t;this.controls.target.set(e,s+3,i),this.camera.lookAt(this.controls.target)}mouseClickGround(t){if(this.currentSight!==$t)return Promise.reject();const e=this.character;if(!e)return Promise.reject();const{runing:s}=this.options.cruise;if(s)return Promise.reject();const i=t.point,n=this.mouseClickDiffusion,{runging:o}=e.extra;o.play();const{x:a,y:r,z:c}=i;return n.position.set(a,r,c),n.visible=!0,new Promise((t=>{Pt(e,i,(t=>{this.setControlTarget(t)}),(s=>{this.setControlTarget(s),o.stop(),n.visible=!1,t(e)}))}))}getAnimTargetPos(t,e,s){const i=e||t.to||{x:-104,y:7,z:58},n=s||t.target||{x:0,y:0,z:0};return this.controls.target.set(n.x,n.y,n.z),i}addModelAnimate(t,e=[],s=!0,i=1){if(!e.length)return;const n=new b(t),o=e.reduce(((t,e)=>{const o=e.name||"";return t[o]=n.clipAction(e),s&&t[o].play(),t[o].timeScale=i,t}),{});t.__action__=o,t.__mixer__=n,this.animateModels.push(t)}cameraTransition(t){var e;if(this.judgeCruise())return;if(this.mouseClickDiffusion.visible)return void v.warning({message:"人物移动中，不可操作！",grouping:!0});this.isPerspectives()&&this.toggleSight();const{to:s,target:i=t.position}=t.data;if(!s)return;this.isCameraMove(s)||lt(this.controls,this.camera,s,i);const{bind:n}=t.data;if(!n)return;const o=null==(e=this.buildingGroup)?void 0:e.getObjectByName(n);this.addFence(o)}addFence(t){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),t){const e=St(t,639358);this.fence=e,this.addObject(e)}}cameraLookatMoveTo(t){ht(this.camera,t,this.controls.target)}judgeCruise(){return!!this.options.cruise.runing&&(v.warning({message:"请退出巡航！",grouping:!0}),!0)}controlReset(){this.judgeCruise()||(this.isPerspectives()&&this.toggleSight(),super.controlReset())}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let t=this.clock.getDelta();if(this.animateModels.length&&this.animateModels.forEach((e=>{e.__mixer__&&e.__mixer__.update(t)})),this.anchorGroup.children.forEach((e=>{e.__mixer__&&e.__mixer__.update(t)})),this.character){this.character.extra.mixer.update(t),Dt(.5*this.moveFactor)}this.mouseClickDiffusion.visible&&Mt(),Tt()}onPointerMove(t){this.checkIntersectObjects(t)}onPointerUp(t){var e;super.onPointerUp(t);const s=t.timeStamp-this.pointer.tsp<xt;2==t.button?s&&"function"==typeof(null==(e=this.extend)?void 0:e.onClickRight)&&this.extend.onClickRight(t):0==t.button?s&&this.checkIntersectObjects(t):t.button}checkIntersectObjects(t){var e,s,i;const n=this.container,o=this.options.scale;wt(t,n,o);let a="pointerdown"==t.type||"pointerup"==t.type;const r=this.buildingGroup.children.filter((t=>t.visible&&(a||t.__ground__))).concat(this.anchorGroup.children);Ct.setFromCamera(kt,this.camera);let c=Ct.intersectObjects(r,a);if(a)if(n.style.cursor="auto",c.length){const t=c[0],i=t.object,n="string"==typeof i.name&&(this.extend.groundMeshName||[]).some((t=>i.name.indexOf(t)>-1)),o=this.findParentGroup(i);if(n&&"function"==typeof(null==(e=this.extend)?void 0:e.onClickGround)&&this.extend.onClickGround(o,t),!o)return;"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft(o,t)}else"function"==typeof(null==(i=this.extend)?void 0:i.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(c)}hoverAnchor(t){if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(t[0],At),t.length){const e=t[0].object;if(this.container.style.cursor=e._isAnchor_?"pointer":"auto",!e._isAnchor_)return;const s=e.material;void 0===e.__mat_color__&&(e.__mat_color__=s.color),s.color=new x(16715760),this.anchorGroup.children.forEach((t=>{t.__change_color__=t.uuid===e.uuid}))}else this.container.style.cursor="auto",this.anchorGroup.children.forEach((t=>{t.__change_color__=!1}))}restoreAnchorMaterial(){this.anchorGroup.traverse((t=>{t.isSprite&&!t.__change_color__&&t.__mat_color__&&(t.material.color=t.__mat_color__)}))}findParentGroup(t){const e=t=>{if(t._isBuilding_)return t;let s=t.parent;return s?s&&s._isBuilding_?s:e(s):void 0};return e(t)}getAll(){return this.buildingGroup.children.concat(this.dotGroup.children)}resize(){super.resize();const{width:t,height:e}=this.options;this.css2DRender.setSize(t,e)}}const Bt=(t,e)=>{const s=40*Math.random();return void 0!==s&&(t.value=s),t.show=Math.random()>.5,t.value=Number(Number(t.value||0).toFixed(2)),{value:t.value,show:t.show,font:{...t.font||{},color:"#"+(16777215+1e6*s).toString(16).substring(0,6)}}},Rt={class:"scene-operation"},Et=["onClick"],Nt=["innerHTML"],Lt=a(C({__name:"index",setup(t){const e=k((s=(t,e,s,i)=>{if(L){(i+=.02)>1&&(i-=1),t=((t,e=0)=>new _(t.x,t.y+e,t.z))(s.getPointAt(i));let n=i+.001;n>1&&(n-=1),e=s.getPointAt(n),L.position.set(t.x,bt,t.z);const o=Math.atan2(-e.z+t.z,e.x-t.x);L.rotation.z=.5*Math.PI+o}},{devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr",dotKey:"DOT",dotShowStrict:!1,config:{},anchorType:[mt],animationModelType:[ft],models:[{key:ft,name:"场景",size:54.8,url:"/深圳北站.glb"},{key:"building",name:"楼宇",size:.3,url:"/楼宇.glb"},{key:"residential",name:"居民楼",size:.08,url:"/居民楼.glb"},{key:"small_residential",name:"小型居民楼",size:.08,url:"/小型居民楼.glb"},{key:mt,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/pos.png"},{key:yt,name:"机器人",size:.3,url:"/oss/model/park/机器人.glb"},{key:_t,name:"人物",size:2.2,url:"/oss/model/park/RobotExpressive.glb"}].map((t=>(t.url&&t.url.indexOf("oss")<0&&(t.url="/oss/model/station"+t.url),t.mapUrl&&(t.mapUrl="/oss/textures/station"+t.mapUrl),t))),cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line5.png",repeat:[.1,1],width:2,segment:100,tension:0,speed:20,mapSpeed:.01,points:[[102.5,bt,9.9],[102.5,bt,291.9],[64.1,bt,291.9],[64.1,bt,129],[-75.2,bt,129],[-75.2,bt,291.9],[-107.7,bt,291.9],[-107.7,bt,9.9]],offset:1.8,animateBack:s}}));var s;const a=k({show:!1,style:{left:0,top:0},msg:""}),{changeBackground:r,backgroundLoad:c}=ot(),{progress:l,loadModels:h,getModel:u}=ut({baseUrl:e.baseUrl,indexDB:{cache:!0,dbName:"THREE__STATION__DB",tbName:"TB",version:12}}),d=w(),p={cruise:e.cruise,controls:{enableDamping:!0,dampingFactor:.48,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:800},directionalLight:{intensity:3}};let g;A((()=>{p.container=d.value,g=new Ft(p,{groundMeshName:["行走地面","平面125","平面126","平面127","平面128","平面129","平面130"],onClickLeft:(t,e)=>{if(t&&t.data){const e=t.data;if((null==e?void 0:e.type)===mt)g.cameraTransition(t)}},onClickGround:(t,e)=>{g.mouseClickGround(e).then((t=>{})).catch((()=>{}))},onHoverAnchor:(t,e)=>{const s=!!t&&t.object._isAnchor_;if(a.show=s,s){a.style.top=e.top,a.style.left=e.left;const s=t.object.data;a.msg=`\n          <p>${s.name}</p>\n          <p>类型：${s.type}</p>\n          <p>绑定：${s.bind||"无"}</p>\n        `}}}),g.run(),it(g).resize(),m()}));const m=()=>{b(),c(g,e.skyCode)},f=w([]),y=j((()=>f.value.filter((t=>t.type===mt)))),b=()=>{h(e.models,(()=>{n.get(o.d3.station).then((async t=>{let s={};if(t.ConfigJson instanceof Object)s=t.ConfigJson;else if("string"==typeof t.ConfigJson)try{s=JSON.parse(t.ConfigJson)}catch(i){}f.value=t.JsonList,Object.keys(s).forEach((t=>{e.config&&(e.config[t]=s[t])})),await v(),U(),H()}))}))},v=async()=>{l.percentage=100,l.show=!1,g.clearBuilding(),await z(),await x(),g.setCruisePoint(e.cruise.points);const t=g.getAnimTargetPos(e.config||{});dt(g.camera,t,g.controls.target).then((()=>{g.controlSave()}))},x=()=>{let t=0,e=f.value.length;return new Promise((s=>{if(0==e)return s(null);const i=async()=>{const n=f.value[t];await C(n),t++,t<e?i():s(t)};i()}))},C=async t=>{if(!t)return;const{type:s}=t,i=u(s);if(!i)return void(s===e.dotKey&&N(t));const{anchorType:n=[],animationModelType:o=[]}=e;let a=pt(i);const{position:r,scale:c,rotation:l}=gt(a,t),[h,d,p]=r;return a.scale.set(...c),a.position.set(h,d,p),a.rotation.set(...l),a._isBuilding_=!0,a.data=t,o.includes(s)&&g.addModelAnimate(a,i.animations,!0,1),n.includes(s)?(a._isAnchor_=!0,g.addAnchor(a)):g.addBuilding(a),Promise.resolve()},E=t=>{var s;const i=t.data;{const t=Bt(i,g.buildingGroup);"object"==typeof t&&Object.keys(t).forEach((e=>{i[e]=t[e]}))}t.visible=i.show||!e.dotShowStrict;const n=null==(s=t.element)?void 0:s.getElementsByClassName("inner")[0];if(n){const{size:t,color:e}=i.font||{};null!=t&&(n.style.fontSize="string"==typeof t?t:t+"px"),null!=e&&(n.style.color=e),n.textContent=`${i.value||0}${i.unit}`}},N=t=>{E(g.addDot(t,(e=>{g.cameraLookatMoveTo(t.position)})))};let L;const U=()=>{L=u(yt),L.position.z=bt,L.rotation.z=.5*Math.PI,g.addObject(L)},H=()=>{const t=u(_t);t.traverse((t=>{t.isMesh&&(t.castShadow=!0)}));g.addCharacter(t,{x:0,y:27.5,z:122})};return(t,s)=>(G(),M("div",{class:S(t.$style.page)},[P("div",Rt,[P("div",{class:"btn",onClick:s[0]||(s[0]=()=>{g.getAll().forEach(((t,s)=>{t.data&&(t.data.type!==e.dotKey||E(t))}))})},"随机更新"),P("div",{class:"btn",onClick:s[1]||(s[1]=()=>{var t;return null==(t=D(g))?void 0:t.getPosition()})},"场景坐标"),P("div",{class:"btn",onClick:s[2]||(s[2]=()=>D(r)(D(g)))},"切换背景")]),P("div",{class:S(t.$style.container),ref_key:"containerRef",ref:d},null,2),T(i,{modelValue:D(l).show,"onUpdate:modelValue":s[3]||(s[3]=t=>D(l).show=t),progress:D(l).percentage},null,8,["modelValue","progress"]),P("div",{class:S(t.$style.camera)},[(G(!0),M(O,null,$(D(y),(e=>(G(),M("div",{class:S(t.$style.item),onClick:t=>(t=>{g.cameraTransition({position:t.position,data:t})})(e)},F(e.name),11,Et)))),256)),P("div",{class:S(t.$style.item),onClick:s[4]||(s[4]=()=>{var t;return null==(t=D(g))?void 0:t.toggleCruise()})},"定点巡航",2),P("div",{class:S(t.$style.item),onClick:s[5]||(s[5]=()=>{var t;return null==(t=D(g))?void 0:t.controlReset()})},"视角重置",2),P("div",{class:S(t.$style.item),onClick:s[6]||(s[6]=()=>D(g).toggleSight())},"人物视角",2),P("div",{class:S(t.$style.item),onClick:s[7]||(s[7]=()=>D(g).characterAccelerate())},"人物加速",2),P("div",{class:S(t.$style.item),onClick:s[8]||(s[8]=()=>D(g).characterAccelerate(-1))},"人物减速",2)],2),D(a).show?(G(),M("div",{key:0,class:S(t.$style.tip),style:B({left:D(a).style.left+"px",top:D(a).style.top+"px"})},[P("div",{class:S(t.$style.msg),innerHTML:D(a).msg},null,10,Nt)],6)):R("",!0)],2))}}),[["__cssModules",{$style:{page:"_page_zc80g_2",container:"_container_zc80g_10",tip:"_tip_zc80g_14",msg:"_msg_zc80g_23",camera:"_camera_zc80g_28",item:"_item_zc80g_35"}}]]);export{Lt as default};
