var e=Object.defineProperty,t=(t,o,i)=>(((t,o,i)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i})(t,"symbol"!=typeof o?o+"":o,i),i);import{bg as o,b4 as i,e as s,i as n,w as a,l,aM as r,o as c,g as d,h as u,q as p,p as h,I as f,m,u as g,B as y,n as v,a9 as b,s as C,t as _,a5 as x,aH as k,aa as D,b6 as w}from"./vendor-eaf8386d.js";import{T as G,d as j}from"./scene-resize-a0557c92.js";import{u as O}from"./raycaster-d24ff307.js";import{u as M,a as P,g as E,s as T,c as B,b as S,d as $,e as U,f as A,h as L,i as z,j as K}from"./model-loader-14a8b85c.js";import{D as N,u as R,a as F}from"./dialog-36830399.js";import{_ as I}from"./common-1ec71d92.js";const{raycaster:q,pointer:H,update:W}=O(),{initCSS2DRender:X,createCSS2DDom:Y}=M();class J extends G{constructor(e,i){super(e),t(this,"deviceGroup"),t(this,"dotGroup"),t(this,"pipeGroup"),t(this,"css2DRender"),t(this,"extend"),t(this,"clock"),t(this,"findFilterDevice",((e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let i=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{i.includes(e)||i.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!i.includes(o)&&i.push(o),!!o})).length==e.length&&(o=o.concat(i))}else{const i=t.find((t=>t.deviceCode==e));i&&o.push(i)}})),o})),this.extend=i,this.css2DRender=X(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.clock=new o,this.addDeviceGroup(),this.addDotGroup(),this.addPipeGroup(),this.bindEvent()}addDeviceGroup(){const e=new i;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot(),this.clearPipe()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const e=new i;e.name="点位组",this.scene.add(e),this.dotGroup=e}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const o=e.position,{size:i,color:s}=e.font||{},{x:n=0,y:a=0,z:l=0}=o||{},r=Y({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=i?`font-size: ${"string"==typeof i?i:i+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[n,a,l],onClick:t});return r.name=e.name,r.data=e,this.dotGroup.add(r),r}addPipeGroup(){const e=new i;e.name="管路组",this.scene.add(e),this.pipeGroup=e}addPipe(...e){this.pipeGroup&&this.pipeGroup.add(...e)}clearPipe(){this.pipeGroup&&this.disposeObj(this.pipeGroup),this.addPipeGroup()}onDblclick(e){var t;const o=this.container,i=this.options.scale;if(W(e,o,i),this.deviceGroup){q.setFromCamera(H,this.camera);const e=[this.deviceGroup,this.pipeGroup],o=q.intersectObjects(e);if(o.length){const e=o[0].object,i=this.findParentGroupGroup(e);if(!i)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(i)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<N.rightClickBackDiffTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o;const i=this.container,s=this.options.scale;W(e,i,s);let n="pointerdown"==e.type||"pointerup"==e.type;const a=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));q.setFromCamera(H,this.camera);let l=q.intersectObjects(a,n);if(i.style.cursor=l.length>0?"pointer":"auto",n)if(l.length){const e=l[0].object;if(!e)return;"function"==typeof(null==(t=this.extend)?void 0:t.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&(o._isDevice_||o._isPipe_)?o:t(o)};return t(e)}modelAnimate(){if(this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.deviceGroup.children.length){let e=this.clock.getDelta();this.deviceGroup.children.forEach((t=>{let o=t.data;if(!o)return;let i=t.extra;i&&((null==o?void 0:o.status)??0)>0&&i.mixer.update(e);const s=t[N.meshKey.warning];s&&((null==o?void 0:o.error)||0)>0&&s.mixer.update(e)}))}this.pipeGroup.children.length&&this.pipeGroup.children.forEach((e=>{const t=e[N.meshKey.pipe];if(t){const o=e.data,i=o.bind||[],s=this.deviceGroup.children.filter((e=>{var t;return e.data&&e.data.deviceCode&&((null==(t=e.data)?void 0:t.status)??0)>0})).map((e=>e.data)),n=this.findFilterDevice(i,s),a=n.length>0;let l=.01;if(o.left&&o.right){const{left:e,right:t}=o,i=this.findFilterDevice(t,n).length>0,s=this.findFilterDevice(e,n).length>0;l=s&&i?0:i?-.01:.01}t.forEach((e=>{a&&(e.material.map.offset.y-=l),e.material.opacity=a?.3:0}))}}))}getPosition(){}getAnimTargetPos(e,t,o){const i=t||e.to||{x:-104,y:7,z:58},s=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),i}getAll(){return this.deviceGroup.children.concat(this.dotGroup.children)}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}}const Q={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},V={class:"scene-operation"},Z=I(s({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoUrl:{default:""},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},ambientLight:{},directionalLight:{default:()=>({})},models:{},config:{},objects:{},pipes:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},statusOffset:{},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{default:()=>["FM"]},animationModelType:{},textModelType:{},anchorType:{default:()=>[]},textChangeColor:{type:Boolean},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},mainBodyExcludeType:{default:()=>["FM"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:t,emit:o}){const s=e,G=o,O=j(Q,s.colors),{changeBackground:M,backgroundLoad:I}=R(),{progress:q,MODEL_MAP:H,loadModel:W,loadModels:X,getModel:Y}=P({baseUrl:s.dracoUrl,colors:O,colorMeshName:s.colorMeshName,indexDB:s.indexDB}),{dialog:Z}=F(),ee=n(),te={baseUrl:s.baseUrl,bgUrl:s.bgUrl,env:s.env,bgColor:s.bgColor,camera:s.camera,cruise:s.cruise,fog:s.fog,render:s.render,grid:s.grid,controls:s.controls,axes:s.axes,ambientLight:s.ambientLight,directionalLight:s.directionalLight};let oe;a((()=>s.dotShowStrict),(()=>ie())),a((()=>s.scale),(e=>{null==oe||oe.setScale(e||1)})),a((()=>s.cruise.points),(e=>{q.isEnd&&oe.setCruisePoint(e)})),a((()=>s.objects),(()=>{q.isEnd&&le()}));const ie=()=>{const e=oe.dotGroup.children;for(let t=0;t<e.length;t++){const o=e[t];if(!o.data)continue;o.data.type===s.dotKey&&se(o)}},se=e=>{var t;const o=e.data;if("function"==typeof s.dotUpdateObjectCall){const e=s.dotUpdateObjectCall(o,oe.deviceGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!s.dotShowStrict;const i=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(i){const{size:e,color:t}=o.font||{};null!=e&&(i.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(i.style.color=t),i.textContent=`${o.value||0}${o.unit}`}},ne=async e=>{var t;if(!e)return;const{type:o,url:n}=e,a=Y(o);if(!a)return void(n?await(async e=>{const{type:t,url:o="",name:i}=e,s=await W({key:t,url:o,name:i,size:0}),{position:n,scale:a,rotation:l}=U(s,e);return s.scale.set(...a),s.position.set(...n),s.rotation.set(...l),s._isBase_=!0,oe.addDevice(s),Promise.resolve(s)})(e):o===s.dotKey&&(e=>{se(oe.addDot(e,(t=>{G("click-dot",r(e),t)})))})(e));const l=s.anchorType||[];let c=$(a);const{position:d,scale:u,rotation:p}=U(c,e),[h,f,m]=d;c.scale.set(...u);const g=s.animationModelType||[],y=s.colorMeshName||[],v=s.mainBodyExcludeType||[],b=s.textModelType||[],C=Y(H.font);if(b.includes(o)&&C){const o=new i;o.add(c);const n=L(e,C,O.normal.text,null==(t=s.statusOffset)?void 0:t.TEXT);o.add(n),o.name=e.name,c=o}if(g.includes(o)){if("Group"!==c.type){const e=new i;e.add(c),e.name=c.name,c=e}if(((e,t)=>{var o,i,n;const a=Y(H.warning);if(a){const i=N.meshKey.warning,{group:n,action:l,mixer:r}=z(i,t,a,null==(o=s.statusOffset)?void 0:o.WARNING);e.add(n),e[i]={action:l,mixer:r}}const l=Y(H.local);if(l){const o=N.meshKey.local,n=K(t,l,null==(i=s.statusOffset)?void 0:i.STATUS);e.add(n),e[o]=n}const r=Y(H.disabled);if(r){const o=N.meshKey.disabled,i=K(t,r,null==(n=s.statusOffset)?void 0:n.DISABLED,!0);e.add(i),e[o]=i}})(c,e),s.mainBodyChangeColor&&!v.includes(o)){const e=A(c.children,s.mainBodyMeshName),t=O.normal;let o=null!=t.main?t.main:t.color,i=S(o);i.length&&e.forEach(((e,t)=>{T(e,i[t%i.length])})),c[N.meshKey.body]=e}const t=A(c.children,y);let n,l=new w(c);a.animations.length&&(n=l.clipAction(a.animations[0]),n.paused=!0,n.timeScale=1.5,n.play()),c.extra={action:n,mixer:l,meshs:t}}else{const e=[];c.traverse((t=>{"string"==typeof t.name&&y.some((e=>t.name.indexOf(e)>-1))&&e.push(t)})),e.length&&(c[N.meshKey.color]=e)}return c.position.set(h,f,m),c.rotation.set(...p),c._isDevice_=!0,c.data=e,l.includes(o)&&(c._isAnchor_=!0),oe.addDevice(c),Promise.resolve()},ae=n([]),le=async()=>{var e,t;q.percentage=100,q.show=!1,oe.clearDevice(),await D(),(()=>{ae.value.length=0;const e=r(s.objects)||[];if("function"!=typeof s.formatObject)ae.value=e;else{const t=s.formatObject(e);ae.value=t}})(),await(()=>{let e=0,t=ae.value.length;return new Promise((o=>{if(0==t)return o(null);const i=async()=>{const s=ae.value[e];await ne(s),e++,e<t?i():o(e)};i()}))})(),(()=>{if(!s.pipes||0==s.pipes.length)return;const e=s.pipes;for(let t=0;t<e.length;t++){const o=e[t],{type:i,map:s}=o,n=Y(i);if(!n)continue;let a=$(n);const l=n._mapMeshName_,{position:r,scale:c,rotation:d}=U(a,o),[u,p,h]=r,f=A(a.children,[l]);f.length&&(f.forEach((e=>{if(e.material.map=e.material.map.clone(),s){const t=e.material.map.repeat;e.material.map.repeat.set(t.x*(s[0]??1),t.y*(s[1]??1))}})),a[N.meshKey.pipe]=f),a.scale.set(...c),a.position.set(u,p,h),a.rotation.set(...d),a._isPipe_=!0,a.data=o,oe.addPipe(a)}})(),oe.setCruisePoint(s.cruise.points),"function"==typeof(null==(e=s.config)?void 0:e.load)&&(null==(t=s.config)||t.load(oe));const o=oe.getAnimTargetPos(s.config||{});B(oe.camera,o,oe.controls.target).then((()=>{G("loaded"),oe.controlSave()}))},re=()=>{X(s.models,(()=>{le()})),s.skyCode&&I(oe,s.skyCode)},ce=e=>{const t=ee.value,o=E(t,e,oe.camera);return Z.position=o,Z.style.left=o.left+"px",Z.style.top=o.top+"px",o},de=e=>{const t=[];s.updateObjectCall,oe.getAll().forEach(((o,i)=>{if(!o.data)return;const n=o.data;let a=n.type;if(a===s.dotKey)return void se(o);if("function"==typeof s.updateObjectCall){const t=s.updateObjectCall(n,e);if(!t)return;Object.keys(t).forEach((e=>{n[e]=t[e]}))}t.push(r(n));let{status:l=0,error:c=0,remote:d=0,local:u=0,disabled:p=0}=n;const h=O[c>0?"error":l>0?"runing":"normal"];let f=null!=h[a]?h[a]:h.color;if("function"==typeof s.getColorCall){const e=s.getColorCall(n);e&&(f=e)}ue({type:a,el:o,colorObj:h,color:f,paused:0==l,error:c>0,remote:d>0,local:u>0,disabled:p>0})})),G("update",t,e)},ue=e=>{let{el:t,type:o,colorObj:i,color:n,paused:a,error:l}=e,r=S(n);n=r[0];const c=N.meshKey;if(s.colorModelType.includes(o)&&null!=n){return void(t[c.color]||[]).forEach((e=>{T(e,n)}))}if(!(s.animationModelType||[]).includes(o))return;if(s.textChangeColor){const e=null!=i.text?i.text:i.color,o=t.getObjectByProperty("_isText_",!0);let s=S(e);T(o,s[0])}const d=t.extra;if(d&&(d.action&&(d.action.paused=a),null!=n)){(d.meshs||[]).forEach((e=>{T(e,n)}))}if(s.mainBodyChangeColor&&t[c.body]){const e=null!=i.main?i.main:i.color;let o=S(e);o.length&&t[c.body].forEach(((e,t)=>{T(e,o[t%o.length])}))}const u=t[c.warning];if(u){const e=t.children.find((e=>e.name==c.warning));e&&(e.visible=l,u.action.paused=!l)}t[c.local]&&(t[c.local].visible=e.local),t[c.disabled]&&(t[c.disabled].visible=e.disabled)};return l((()=>{te.container=ee.value,oe=new J(te,{onDblclick(e){const t=e.data;"function"==typeof t.onDblclick?t.onDblclick(r(t),e):G("dblclick",r(t))},onClickLeft(e){if(e){const t=e.data,o=r(t);G("select",o),"function"==typeof t.onClick?(Z.show=!1,t.onClick(o)):(Z.select=[e],(()=>{const e=Z.select[0],t=e.data;Z.data=t,Z.title=(null==t?void 0:t.name)||"",Z.show=!0;const o=ce(e);G("click-dialog-dot",t,o)})())}else Z.select=[],Z.show=!1},onClickRight(e){var t;"function"==typeof(null==(t=s.config)?void 0:t.back)&&s.config.back(oe)},animateCall:()=>{if(Z.show&&Z.select.length){const e=Z.select[0];ce(e)}}}),oe.run(),G("init",oe),re()})),t({update:de,exportImage:()=>null==oe?void 0:oe.exportImage()}),(e,t)=>{const o=k;return c(),d("div",{class:v(e.$style["device-scene"])},[u("div",V,[p(o,{type:"success",onClick:t[0]||(t[0]=()=>de(!0))},{default:h((()=>t[7]||(t[7]=[f("随机更新")]))),_:1}),e.cruise.visible?(c(),m(o,{key:0,onClick:t[1]||(t[1]=()=>{var e;return null==(e=g(oe))?void 0:e.toggleCruise()}),type:"danger"},{default:h((()=>t[8]||(t[8]=[f("定点巡航")]))),_:1})):y("",!0),p(o,{onClick:t[2]||(t[2]=()=>{var e;return null==(e=g(oe))?void 0:e.getPosition()}),type:"success"},{default:h((()=>t[9]||(t[9]=[f("场景坐标")]))),_:1}),p(o,{type:"warning",onClick:t[3]||(t[3]=()=>g(M)(g(oe)))},{default:h((()=>t[10]||(t[10]=[f("切换背景")]))),_:1}),p(o,{type:"danger",onClick:t[4]||(t[4]=()=>{var e;return null==(e=g(oe))?void 0:e.controlReset()})},{default:h((()=>t[11]||(t[11]=[f("控制器重置")]))),_:1}),e.cruise.visible?(c(),m(o,{key:1,type:"danger",onClick:t[5]||(t[5]=()=>{var e;return null==(e=g(oe))?void 0:e.toggleCruiseDepthTest()})},{default:h((()=>t[12]||(t[12]=[f("巡航深度")]))),_:1})):y("",!0)]),u("div",{class:v(e.$style.container),ref_key:"containerRef",ref:ee},null,2),g(q).show?(c(),d("div",{key:0,class:v(["loading",e.$style.loading]),style:b({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[6]||(t[6]=C((()=>{}),["stop"]))},[u("div",{class:v(e.$style.progress),style:b({"--percentage":g(q).percentage+"%"})},[u("div",{class:v(e.$style["bar-out"])},[u("div",{class:v(e.$style.bar)},null,2)],2),u("div",{class:v(e.$style.text)},_(g(q).percentage)+"%",3)],6)],38)):y("",!0),g(Z).show?(c(),d("div",{key:1,class:v(e.$style.dialog),style:b(g(Z).style)},[x(e.$slots,"dialog",{data:g(Z).data,title:g(Z).title,position:g(Z).position})],6)):y("",!0)],2)}}}),[["__cssModules",{$style:{"device-scene":"_device-scene_ovehw_2",container:"_container_ovehw_8",loading:"_loading_ovehw_12",progress:"_progress_ovehw_27","bar-out":"_bar-out_ovehw_31",bar:"_bar_ovehw_31","striped-flow":"_striped-flow_ovehw_1",text:"_text_ovehw_55",dialog:"_dialog_ovehw_63"}}]]);export{Z as t};
