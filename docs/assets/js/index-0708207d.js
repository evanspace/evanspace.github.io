var t,e,s,a=Object.defineProperty,n=(t,e,s)=>(((t,e,s)=>{e in t?a(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s})(t,"symbol"!=typeof e?e+"":e,s),s),i=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)},o=(t,e,s)=>(i(t,e,"read from private field"),s?s.call(t):e.get(t)),r=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},c=(t,e,s)=>(i(t,e,"access private method"),s);import{bw as l,bx as p,bg as h,c as d,aY as u,b4 as m,c1 as f,bv as g,b3 as y,bo as b,bh as w,a_ as v,a$ as x,bm as j,cv as M,cw as _,cx as G,b2 as S,cy as P,cz as k,bq as O,bp as z,Y as C,cA as B,e as D,i as R,l as $,o as I,g as T,h as E,q as L,p as U,I as X,n as F,u as N,a9 as W,t as A,B as Y,F as q,r as Z,ah as J}from"./vendor-eaf8386d.js";import{j as Q,A as H,n as K,_ as V}from"./common-6b6d0500.js";import{T as tt,u as et}from"./scene-resize-e467973e.js";import{u as st,a as at,b as nt,c as it,d as ot,e as rt,f as ct,g as lt,h as pt,i as ht}from"./convert-data-0a48e7de.js";import{u as dt}from"./raycaster-d24ff307.js";const ut=1,mt=40,ft=100,gt=3377879,yt=9633791,bt=9633791,wt=1066618,vt=3377879,xt=1066618,jt=9559027,Mt=6421501,_t=663606,Gt=927811,St=11856636,Pt=13303807,kt=6945023,Ot=9559027,zt=6421501,Ct=9559027,Bt=6421501,{createCorrugatedPlate:Dt,update:Rt}=st({factor:mt,color:vt,light:xt}),{createOutline:$t,update:It}=at({factor:mt,color:St}),{getBoundingBox:Tt}=rt(),{createCountryFlatLine:Et,getPoints:Lt}=ct(),{initCSS3DRender:Ut,createCSS3DDom:Xt}=lt(),{createMarkLight:Ft}=nt({pointTextureUrl:"/oss/textures/map/point.png",circleTextureUrl:"/oss/textures/map/circle.png",lightTextureUrl:"/oss/textures/map/light.png",factor:mt,color:Pt}),{raycaster:Nt,pointer:Wt,style:At,update:Yt}=dt(),{createFlywire:qt,update:Zt}=it({depth:ut,color:jt,flyColor:zt,pointColor:Ot,factor:mt}),{createBar:Jt}=ot({height:5,size:.2,factor:mt,color1:Pt,color2:kt}),Qt=new M;Qt.setURLModifier((t=>"/oss/textures/map"+t));const Ht=new l(Qt),Kt={x:105.06,y:0,z:32.93},Vt=Ht.load("/gz-map.jpg"),te=Ht.load("/gz-map-fx.jpg"),ee=Ht.load("/border.png");Vt.wrapS=te.wrapS=ee.wrapS=p,Vt.wrapT=te.wrapT=ee.wrapT=p,Vt.flipY=!1;const se=.0128;Vt.repeat.set(se,se),te.repeat.set(se,se);const ae=t=>{const e=new _(t),s=new G(e,{depth:ut,bevelEnabled:!0,bevelSegments:1,bevelThickness:0,steps:0,bevelSize:0}),a=new S({color:gt,map:Vt,normalMap:te,combine:P,transparent:!0,opacity:.8}),n=new g({color:bt,map:ee,transparent:!0,opacity:.9}),i=new y(s,[a,n]);return i.scale.setScalar(mt),i.name="地图拼块",i},ne=(t,e)=>{if(!t.centroid&&!t.center)return!1;const[s,a]=t.centroid||t.center,n=Xt({name:`\n      <img src="/oss/img/map/label.png" />\n      <div class="name">${t.name}</div>\n    `,className:"map-3D-label",position:[s*mt,a*mt*.995,ut*mt]});n.rotateX(.5*Math.PI),n.name=t.name+"_CSS3D_label",n.isLabel=!0,e.add(n)},ie=(t,e)=>{if(!t.centroid&&!t.center)return!1;const s=1+(a=5,n=10,(Math.floor(Math.random()*(n-a+1))+a)/4);var a,n;const[i,o]=t.centroid||t.center,r=Ft([i,o,1.01*ut].map((t=>t*mt)),s*mt);r.rotateX(-Math.PI/2),e.add(r)},oe=(t,e)=>{const s=new m,a=.2*mt,n=new k(a,32),i=new O({color:Ct,transparent:!0,opacity:1}),o=new y(n,i),r=new z(.8*a,32,32,0,Math.PI),c=new O({color:Bt,transparent:!0,opacity:1}),l=new y(r,c);return s.add(o,l),s.position.set(t*mt,e*mt,ut*mt*1.005),s},re=Ht.load("/out-circle2.png"),ce=Ht.load("/inner-circle2.png");class le extends tt{constructor(s){super(s),r(this,e),n(this,"corrugatedPlate"),n(this,"clock"),n(this,"mapGroup"),n(this,"scatterGroup"),n(this,"flywireGroup"),n(this,"css3DRender"),n(this,"outline"),r(this,t,void 0),n(this,"outRingMesh"),n(this,"innerRingMesh"),this.clock=new h,this.css3DRender=Ut(this.options,this.container),this.addModel(),this.bindEvent()}addModel(){const t=Dt();t.renderOrder=0,this.corrugatedPlate=t,this.addObject(t)}onDblclick(t){}onPointerDown(t){this.pointer.isClick=!0,this.pointer.tsp=t.timeStamp}onPointerMove(t){const a=this.container,n=this.options.scale;if(Yt(t,a,n),this.mapGroup){Nt.setFromCamera(Wt,this.camera);const t=[this.mapGroup];this.scatterGroup&&t.push(this.scatterGroup);const a=Nt.intersectObjects(t);if(this.container.style.cursor=a.length?"pointer":"auto",a.length>0){const t=a[0].object;let n;const i=this.findParentGroupGroupUuid(t);i&&(n=i.uuid,c(this,e,s).call(this,i)),this.setMapBlockColor(n)}else c(this,e,s).call(this),this.setMapBlockColor()}}onPointerUp(t){this.pointer.isClick=!1;const e=t.timeStamp-this.pointer.tsp<ft;2==t.button||(0==t.button?e&&this.clickObject(t):t.button)}clickObject(t){const e=this.container,s=this.options.scale;if(Yt(t,e,s),this.scatterGroup){Nt.setFromCamera(Wt,this.camera);const t=[this.scatterGroup],e=Nt.intersectObjects(t);if(this.container.style.cursor=e.length?"pointer":"auto",e.length){const t=e[0].object,s=this.findParentGroupGroupUuid(t).data||{};d.info({message:s.name,grouping:!0})}}}findParentGroupGroupUuid(t){const e=t=>{let s=t.parent;if(s)return s&&s.isProvinceGroup||s.isScatter?s:e(s)};return e(t)}setMapBlockColor(t){this.mapGroup.traverse((e=>{if(e.isProvinceBlock)e.material[0].color.set(e.parent.uuid===t?yt:gt),e.material[1].color.set(e.parent.uuid===t?wt:bt);else if(e.isLabel){const s=e.parent.uuid===t;e.element.className="map-3D-label"+(s?" is-active":"")}}))}initGrid(){const t=200*mt,e=1.4*mt,s=t/20,a=-t/2;let n=new u(t,20,_t,_t);this.grid=n;const i=new m;for(let o=0;o<=20;o++)for(let t=0;t<=20;t++){const n=a+o*s,r=a+t*s,c=new f(e,e/5),l=new g({color:Gt,transparent:!0,opacity:.9}),p=new y(c,l);p.rotateX(.5*-Math.PI),p.position.set(n,.1,r);const h=p.clone();h.rotateZ(.5*Math.PI),i.add(p,h)}i.name="辅助交点",this.addObject(n,i)}initMap(t){this.mapGroup&&(this.disposeObj(this.mapGroup),this.mapGroup=null);const e=new m;e.name="地图";const s=t.features,a=s.length;for(let p=0;p<a;p++){const t=s[p],a=new b,n=t.geometry.coordinates,i=t.properties;for(let e=0;e<n.length;e++)n[e].forEach((t=>{const e=t.map((t=>new w(t[0],t[1]))),s=ae(e);s.isProvinceBlock=!0,a.add(s)}));ne(i,a),ie(i,a),a.rotateX(-Math.PI/2),a.isProvinceGroup=!0,a.name=i.name,a.data=i,e.add(a)}((t,e)=>{let s=Et(t,{color:jt,transparent:!0},"Line2");s.name="地图上边框",s.position.y+=ut*mt;let a=Et(t,{color:Mt},"Line2");a.name="地图下边框",s.scale.setScalar(mt),a.scale.setScalar(mt),e.add(s),e.add(a)})(t,this.scene);const n=Tt(e);let{size:i,center:{x:o,y:r,z:c}}=n;this.mapGroup=e,Kt.x=o,Kt.y=r,Kt.z=c,this.corrugatedPlate.position.set(o,0-.1*mt,c),this.resetSceneEle();const l=i.x<i.y?i.y+1:i.x+1;this.outRingMesh=((t,e)=>{let s=new f(e,e),a=new O({map:re,transparent:!0,opacity:1,depthTest:!0}),n=new y(s,a);const{x:i,z:o}=Kt;return n.position.set(i,-1,o),n.scale.setScalar(1.2),n.rotateX(.5*-Math.PI),t.add(n),n})(this.scene,l),this.innerRingMesh=((t,e)=>{let s=new f(e,e),a=new O({map:ce,transparent:!0,opacity:1,depthTest:!0}),n=new y(s,a);const{x:i,z:o}=Kt;return n.position.set(i,-2,o),n.scale.setScalar(1.2),n.rotateX(.5*-Math.PI),t.add(n),n})(this.scene,.9*l),this.addObject(e)}initMapBar(t){if(!this.mapGroup)return;this.clearMapBar();const e=Math.max(...t.map((t=>t.use)));for(let s=0;s<t.length;s++){const{name:a,use:n}=t[s],i=this.mapGroup.getObjectByName(a);if(i){const t=n/e,{centroid:s,center:a,name:o}=i.data,r=s||a,c=Jt({position:[r[0]*mt,r[1]*mt,ut*mt],heightRatio:t,label:{name:`\n              <div class="label-wrap">\n                <div class="name">${o}</div>\n                <div class="text">\n                  <span class="value">${K(n)}</span>\n                  <span class="unit">kWh</span>\n                </div>\n              </div>\n            `,className:"map-bar-label"}});c.isBar=!0,i.add(c)}else;}}clearMapBar(){this.mapGroup.traverse((t=>{t.isBar&&this.disposeObj(t)}))}initMapOutLine(t){this.outline&&(this.disposeObj(this.outline),this.outline=null);const e=Lt(t,ut,!1),s=$t(e);s.renderOrder=10,this.outline=s,this.addObject(s)}initScatter(e,s){this.scatterGroup&&(this.disposeObj(this.scatterGroup),this.scatterGroup=null);const a=new m;a.name="散点集合";for(let t=0;t<e.length;t++){const s=e[t],[n=0,i=0]=s.coord||[],o=oe(n,i);o.name=s.name,o.data=s,o.isScatter=!0,a.add(o)}var n,o,r,c;a.rotateX(.5*-Math.PI),this.scatterGroup=a,this.addObject(a),r=s,i(n=this,o=t,"write to private field"),c?c.call(n,r):o.set(n,r)}initFlywire(t){this.flywireGroup&&(this.disposeObj(this.flywireGroup),this.flywireGroup=null);const e=new m;for(let s=0;s<t.length;s++){const{coords:a,path:n}=t[s],i=qt(a.map((t=>t.map((t=>t*mt)))));i.name=n,e.add(i)}e.name="飞线集合",e.renderOrder=20,this.flywireGroup=e,this.addObject(e)}resetSceneEle(){const{x:t,y:e,z:s}=Kt;if(this.camera.lookAt(t,e,s),new v(this.camera.position).to({x:t,y:40*mt,z:s+40*mt},1e3).easing(x.Quadratic.In).start().onUpdate((()=>{})),this.controls.target=new j(t,e,s),this.grid){this.grid.position.set(t,0,s);this.scene.getObjectByName("辅助交点").position.set(t,0,s)}}modelAnimate(){let t=this.clock.getDelta();this.corrugatedPlate&&Rt(this.corrugatedPlate,t),this.outline&&It(this.outline),this.css3DRender&&this.css3DRender.render(this.scene,this.camera),ee.offset.y+=.005,this.outRingMesh&&(this.outRingMesh.rotation.z+=5e-4),this.innerRingMesh&&(this.innerRingMesh.rotation.z-=5e-4),this.flywireGroup&&Zt()}resize(){if(super.resize(),this.css3DRender){const{width:t,height:e}=this.options;this.css3DRender.setSize(t,e)}}}t=new WeakMap,e=new WeakSet,s=function(e){"function"==typeof o(this,t)&&o(this,t).call(this,e,At)};const pe=["src"],he=V(D({__name:"index",setup(t){const{show:e,options:s}=(t=>{const e=C({show:!1,...t});return{options:e,show:B(e.show),filters:C({})}})({style:{left:"0px",top:"0px"},list:[],extend:{isScatter:!1,city:"",title:"",total:0}}),{load:a}=pt(),{transformGeoJSON:n}=ht(),i=R(),o={bgColor:464681,camera:{position:[0,100,200]},fog:{visible:!1,near:2e3,far:3e3},render:{preserveDrawingBuffer:!0},grid:{visible:!0},controls:{maxPolarAngle:.46*Math.PI,maxDistance:5e3,enableDamping:!0,screenSpacePanning:!1},axes:{visible:!1}};let r;const c=()=>null==r?void 0:r.exportImage(),l=()=>{Q.get(H.d3.map).then((t=>{const e=[],s=[];return t.list.forEach((t=>{const a=t.projects.length;let n=t.province;["重庆","北京","天津","上海"].includes(n)&&(n+="市"),["台湾"].includes(n)&&(n+="省"),t.projects.forEach((s=>{e.push({coord:[s.lng,s.lat],name:s.name,carbon:s.carbon,use:s.use,total:a,city:t.province,id:s.id})}));const i=t.total;-1===s.findIndex((t=>t.name===n))&&s.push({id:t.code,name:n,code:t.code,total:a,city:t.province,use:i})})),{citys:s,projects:e,lines:t.lines}})).then((t=>{const{projects:a,citys:n}=t;null==r||r.initScatter(a,((t,a)=>{let i=!!t;if(i){s.style&&(s.style.left=a.left+"px",s.style.top=a.top+"px");const e=t.isScatter,o=t.data;let r="",c="",l=0,p=[];if(e)r=o.city,c=o.name,l=o.total,p=[{name:"今日用电量",value:o.use,unit:"kWh"},{name:"今日碳排放",value:o.carbon,unit:"kgCO₂"}];else{const e=n.find((e=>e.name==t.name));e?(r=null==e?void 0:e.city,l=(null==e?void 0:e.total)??0,p=[{name:"今日用电量",value:null==e?void 0:e.use,unit:"kWh"}]):i=!1}s.list=p,s.extend.city=r,s.extend.title=c,s.extend.total=l,s.extend.isScatter=e}e.value=i})),null==r||r.initMapBar(n),null==r||r.initFlywire(t.lines)}))};return $((()=>{o.container=i.value,r=new le(o),r.run(),a("/oss/map/china.json").then((t=>{r.initMap(n(t)),l()})),a("/oss/map/china-outline.json").then((t=>{r.initMapOutLine(n(t))})),et(r).resize()})),(t,a)=>{const n=J;return I(),T("div",{class:F([t.$style.page,"h-100 o-h"])},[E("div",{class:"h-100",ref_key:"containerRef",ref:i},null,512),E("div",{class:F(t.$style.operate)},[L(n,{type:"primary",size:"small",onClick:c},{default:U((()=>a[0]||(a[0]=[X("导出")]))),_:1})],2),N(e)?(I(),T("div",{key:0,class:F(t.$style["dialog-view"]),style:W(N(s).style)},[N(s).extend.city?(I(),T("div",{key:0,class:F([t.$style.city,"flex"])},[E("span",{class:F(t.$style.name)},A(N(s).extend.city),3),E("span",{class:F(t.$style.total)},A(N(s).extend.total)+"个项目",3)],2)):Y("",!0),N(s).extend.title?(I(),T("div",{key:1,class:F([t.$style.project,"flex flex-ac"])},[E("img",{src:`${N("")}oss/img/map/pos.png`,alt:""},null,8,pe),E("span",{class:F(t.$style.name)},A(N(s).extend.title),3)],2)):Y("",!0),E("div",{class:F(t.$style.count)},[(I(!0),T(q,null,Z(N(s).list,(e=>(I(),T("div",{class:F(t.$style.item)},[E("span",null,A(e.name),1),E("span",null,A(e.value),1),E("span",null,A(e.unit),1)],2)))),256))],2)],6)):Y("",!0)],2)}}}),[["__cssModules",{$style:{page:"_page_foajx_2",operate:"_operate_foajx_6","dialog-view":"_dialog-view_foajx_12",city:"_city_foajx_21",name:"_name_foajx_21",total:"_total_foajx_29",project:"_project_foajx_34",count:"_count_foajx_49",item:"_item_foajx_53"}}]]);export{he as default};
