var e=Object.defineProperty,t=(t,i,o)=>(((t,i,o)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o})(t,"symbol"!=typeof i?i+"":i,o),o);import{bC as i,cp as o,cW as s,cX as n,bH as r,bi as a,bO as l,cU as c,cx as d,cl as h,cY as u,bk as p,bK as _,bc as m,cZ as g,cb as y,bh as f,cy as b,bP as v,bn as x,e as k,Y as w,i as C,l as G,o as O,g as z,h as D,u as j,a7 as A,a8 as P,F as M,r as T,m as S,p as E,I as R,t as L,n as N,q as U,a9 as B,B as I,aP as F,ak as H,aa as $}from"./vendor-c8aa99b3.js";import{u as K,t as V}from"./css2d-bae94273.js";import{d as W,k as J,l as X,m as Y,n as q,o as Z,T as Q,u as ee}from"./scene-resize-479b00ff.js";import{u as te,a as ie}from"./background-06f00198.js";import{u as oe,a as se}from"./move-animate-4bb108f0.js";import{s as ne,a as re,u as ae,c as le,d as ce,b as de}from"./model-loader-99e01c60.js";import{e as he,A as ue,_ as pe}from"./index-2da77948.js";import"./config-b6242c11.js";const _e="ROBOT",me="CHARACTER",ge="GROUND",ye="PARK_VIDEO",fe="OPEN_THE_DOOR",be="HALF_OPEN_THE_DOOR",ve="DOUBLE_OPEN_THE_DOOR",xe="WAIT_LIFT",ke="SLIDING_DOOR",we="LIGHT_SWITCH",Ce=.2,Ge=e=>new URL(Object.assign({"../assets/imgs/texttures/lensflare/lensflare0.png":J,"../assets/imgs/texttures/lensflare/lensflare0_alpha.png":X,"../assets/imgs/texttures/lensflare/lensflare1.png":Y,"../assets/imgs/texttures/lensflare/lensflare2.png":q,"../assets/imgs/texttures/lensflare/lensflare3.png":Z})[`../assets/imgs/texttures/lensflare/${e}`],self.location).href,Oe=300,{raycaster:ze,pointer:De,update:je,style:Ae}=te(),{initCSS2DRender:Pe,createCSS2DDom:Me}=K(),{createDiffusion:Te,updateDiffusion:Se}=oe(),{createMove:Ee,moveAnimate:Re}=se(),{addLensflare:Le}=((e={})=>{let t=W({mainTextureUrl:Ge("lensflare0.png"),minorTextureUrl:Ge("lensflare3.png")},e);const r=new i,a=r.load(t.mainTextureUrl),l=r.load(t.minorTextureUrl);return{addLensflare:(e,t,i,r)=>{const c=new o(16777215,1,2e3,0);c.color.set(e),c.position.set(t,i,r);const d=new s;return d.addElement(new n(a,700,0,c.color)),d.addElement(new n(l,60,.6)),d.addElement(new n(l,70,.7)),d.addElement(new n(l,120,.9)),d.addElement(new n(l,70,1)),c.add(d),c}}})(),Ne={}.VITE_BEFORE_STATIC_PAT||"",Ue=e=>{const t=document.createElement("video");return t.src=Ne+(e||"/oss/textures/park/sintel.mp4"),t.loop=!0,t},Be=(new i).load(Ne+"/oss/textures/park/cover.jpeg"),Ie="FULL",Fe="NPC";class He extends Q{constructor(e,i){super(e),t(this,"water"),t(this,"sky"),t(this,"sun"),t(this,"buildingGroup"),t(this,"anchorGroup"),t(this,"dotGroup"),t(this,"lightGroup"),t(this,"extend"),t(this,"css2DRender"),t(this,"mouseClickDiffusion"),t(this,"character"),t(this,"clock"),t(this,"currentSight"),t(this,"historyTarget"),t(this,"historyCameraPosition"),t(this,"animateModels"),t(this,"moveFactor",1),this.extend=i,this.css2DRender=Pe(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=Te(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.clock=new r,this.currentSight=Ie,this.historyTarget=new a,this.historyCameraPosition=new a,this.animateModels=[],this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup(),this.addLensflare()}addBuildingGroup(){const e=new l;e.name="建筑组",this.buildingGroup=e,this.addObject(e)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot(),this.clearLightGroup()}addBuilding(...e){this.buildingGroup&&this.buildingGroup.add(...e)}addAnchorGroup(){const e=new l;e.name="锚点组",this.anchorGroup=e,this.addObject(e)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(...e){this.anchorGroup&&this.anchorGroup.add(...e)}addDotGroup(){const e=new l;e.name="点位组",this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const i=e.position,{size:o,color:s}=e.font||{},{x:n=0,y:r=0,z:a=0}=i||{},l=Me({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=o?`font-size: ${"string"==typeof o?o:o+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[n,r,a],onClick:t});return l.name=e.name,l.data=e,l._position_={x:n,y:r,z:a},this.dotGroup.add(l),l}addLightGroup(){const e=new l;e.name="灯光组",this.lightGroup=e,this.addObject(e)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}addLight(e,t,i){if(this.lightGroup){t.name=e.name;const{to:o={x:0,y:0,z:0}}=e;if(t.target.position.set(o.x,o.y,o.z),this.lightGroup.add(t),i){const e=new c(t,t.color);this.lightGroup.add(e)}}}addLensflare(){const{position:e=[500,1e3,800],color:t=16777215}=this.options.directionalLight,[o,s,n]=e,r=Le(t,o,s,n);this.addObject(r),this.sun=new a(o,s,n),this.water=(()=>{const e=new p(900,50),t=new b(e,{textureWidth:512,textureHeight:512,waterNormals:(new i).load(Ne+"/oss/textures/waternormals.jpg",(e=>{e.wrapS=e.wrapT=v})),sunDirection:new a,sunColor:15732480,waterColor:92299,distortionScale:3.5});return t.rotation.x=-Math.PI/2,t.rotation.z=.05*Math.PI,t.material.uniforms.size.value=.5,t.position.y=-1,t.position.x=65,t.position.z=230,t})(),this.addObject(this.water)}updateSkyAndSun(){const{water:e,sky:t,sun:i}=this,o=t.material.uniforms,s=10,n=1,r=.005,a=.2,l=4,c=180,h=null;o.turbidity.value=s,o.rayleigh.value=n,o.mieCoefficient.value=r,o.mieDirectionalG.value=a;const u=x.degToRad(90-l),p=x.degToRad(c);i.setFromSphericalCoords(1,u,p),t.material.uniforms.sunPosition.value.copy(i),e.material.uniforms.sunDirection.value.copy(i).normalize();const _=new d(this.renderer);this.scene.environment=_.fromScene(t).texture,this.renderer.toneMappingExposure=h}addCharacter(e,t){const{x:i,y:o,z:s}=t;e.position.set(i,o,s),this.character=e;const n=e.animations,r=new h(e),a={};for(let c=0;c<n.length;c++){const e=n[c],t=r.clipAction(e);a[e.name]=t}a.Dance.play();const l=a.Walking;e.extra={mixer:r,actions:a,runging:l},this.addObject(e)}toggleSight(){if(this.options.cruise.runing)return void this.toggleCruise(!0);const e=this.currentSight==Ie?Fe:Ie;this.currentSight=e;const t=e===Fe;this.controls.maxDistance=t?15:1500,this.controls.screenSpacePanning=!t,this.controls.enablePan=!t,this.controls.maxPolarAngle=Math.PI*(t?.49:.45);const i=this.controls.target,o=this.character.position;if(t){const{x:e,y:t,z:s}=i;this.historyTarget=new a(e,t,s);const{x:n,y:r,z:l}=this.camera.position;this.historyCameraPosition=new a(n,r,l);const{x:c,y:d,z:h}=o;this.camera.lookAt(new a(c,d+3,h))}else{const{x:e,y:t,z:i}=this.historyCameraPosition;this.camera.position.set(e,t,i),this.camera.lookAt(o)}const{x:s,y:n,z:r}=t?o:this.historyTarget;i.set(s,n,r)}characterAccelerate(){this.moveFactor++,this.moveFactor>=10&&(this.moveFactor=10)}setControlTarget(e){const{x:t,y:i,z:o}=e;this.controls.target.set(t,i+3,o),this.camera.lookAt(this.controls.target)}mouseClickGround(e){if(this.currentSight!==Fe)return Promise.reject();const t=this.character;if(!t)return Promise.reject();const{runing:i}=this.options.cruise;if(i)return Promise.reject();const o=e.point,s=this.mouseClickDiffusion,{runging:n}=t.extra;n.play();const{x:r,y:a,z:l}=o;return s.position.set(r,a,l),s.visible=!0,new Promise((e=>{Ee(t,o,(e=>{this.setControlTarget(e)}),(i=>{this.setControlTarget(i),n.stop(),s.visible=!1,e(t)}))}))}addVideoMaterial(){const e=Ue(),t=new u(e),i=new p(10,5),o=new _({map:Be}),s=new m(i,o);s.__video_texture__=t,s.__cover_texture__=Be,s.position.set(-75,2.66,133),s.name="small_video",s.__video__=e,this.addObject(s);const n=new g(new p(20,20),{clipBias:.003,textureWidth:window.innerWidth*window.devicePixelRatio,textureHeight:window.innerHeight*window.devicePixelRatio,color:11908533});n.position.set(-75,.17,160),n.rotateX(-Math.PI/2),this.addObject(n);const r=this.scene.getObjectByName("大屏幕");if(!r)return;const a=Ue(),l=new u(a);r.__video_texture__=l,r.__cover_texture__=Be.clone(),r.material=o.clone(),r.__video__=a}videoPlay(e){const t=this.scene.getObjectByName(e.data.bind);if(t&&t.__video__){const e=t.__video__;e.paused?(t.material.map=t.__video_texture__,null==e||e.play()):(null==e||e.pause(),t.material.map=t.__cover_texture__)}}openTheDoor(e,t){const i=this.scene.getObjectByName(e.data.bind);if(i)if(t)i.__open__=!i.__open__,new y(i.rotation).to({z:i.__open__?.5*Math.PI:0},1500).delay(0).start();else{const e=i.position;if(null==i.__open__){const{x:t,y:o,z:s}=e;i.__position__=new a(t,o,s)}i.__open__=!i.__open__,new y(e).to({x:i.__position__.x+(i.__open__?7:0)},1500).delay(0).start()}}openTheDoubleSlidingDoor(e,t=400,i){const o=this.scene.getObjectByName(e.data.bind);if(!o)return Promise.reject();const s=o.children.find((e=>e.name.indexOf("左")>-1)),n=o.children.find((e=>e.name.indexOf("右")>-1)),r=s.position,l=n.position;if(null==o.__open__){const{x:e,y:t,z:i}=r,{x:o,y:c,z:d}=l;s.__position__=new a(e,t,i),n.__position__=new a(o,c,d)}return o.__open__=void 0!==i?i:!o.__open__,new Promise((e=>{const i=n.__position__.x+(o.__open__?t:0);if(l.x===i)return e(o);new y(r).to({x:s.__position__.x+(o.__open__?-t:0)},1500).delay(0).start(),new y(l).to({x:i},1500).delay(0).start().onComplete((()=>{e(o)}))}))}openTheSlidingDoor(e){const t=this.scene.getObjectByName(e.data.bind);if(!t)return;const i=t.children.find((e=>e.name.indexOf("左")>-1)),o=i.position;if(null==t.__open__){const{x:e,y:t,z:s}=o;i.__position__=new a(e,t,s)}t.__open__=!t.__open__;const s=i.__position__.y+(t.__open__?4.5:0);o.y!==s&&new y(o).to({y:i.__position__.y+(t.__open__?4.5:0)},1500).delay(0).start()}waitLift(e,t){var i;const o="单元1号电梯",s=this.scene.getObjectByName(o),n=null==(i=e.data)?void 0:i.to;if(!s||!n)return;const r=s.position;if(n.y!=r.y){const i=s.__bind_lift__;void 0!==i&&this.openTheDoubleSlidingDoor({data:{bind:i}},200,!1),this.openTheDoubleSlidingDoor({data:{bind:o}},4,!1).then((()=>{new y(r).to({y:n.y},1500).delay(0).start().onUpdate((e=>{t&&(this.character.position.y=e.y,this.camera.position.y=e.y,this.setControlTarget(this.character.position))})).onComplete((()=>{s.__bind_lift__=e.data.bind,this.openLift(e,o)}))}))}else this.openLift(e,o)}openLift(e,t){this.openTheDoubleSlidingDoor(e,200),this.openTheDoubleSlidingDoor({data:{bind:t}},4)}lightSwitch(e){var t;this.lightGroup.getObjectsByProperty("name",null==(t=e.data)?void 0:t.bind).forEach((e=>{e.visible=!e.visible}))}addModelAnimate(e,t=[],i=!0,o=1){if(!t.length)return;const s=new h(e),n=t.reduce(((e,t)=>{const n=t.name||"";return e[n]=s.clipAction(t),i&&e[n].play(),e[n].timeScale=o,e}),{});e.__action__=n,e.__mixer__=s,this.animateModels.push(e)}modelAnimate(){this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.water&&(this.water.material.uniforms.time.value+=1/60),this.mouseClickDiffusion.visible&&Se();let e=this.clock.getDelta();if(this.character){this.character.extra.mixer.update(e),Re(.5*this.moveFactor)}this.restoreAnchorMaterial(),this.animateModels.length&&this.animateModels.forEach((t=>{t.__mixer__.update(e)}))}onDblclick(e){var t;const i=this.container,o=this.options.scale;if(je(e,i,o),this.buildingGroup){ze.setFromCamera(De,this.camera);const e=[this.buildingGroup],i=ze.intersectObjects(e);if(i.length){const e=i[0].object,o=this.findParentGroup(e);if(!o)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(o)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const i=e.timeStamp-this.pointer.tsp<Oe;2==e.button?i&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?i&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,i,o;const s=this.container,n=this.options.scale;je(e,s,n);let r="pointerdown"==e.type||"pointerup"==e.type;const a=this.buildingGroup.children.filter((e=>e.visible&&(r||e.__ground__))).concat(this.anchorGroup.children);ze.setFromCamera(De,this.camera);let l=ze.intersectObjects(a,r);if(r)if(s.style.cursor="auto",l.length){const e=l[0],o=e.object,s="string"==typeof o.name&&(this.extend.groundMeshName||[]).some((e=>o.name.indexOf(e)>-1)),n=this.findParentGroup(o);if(s&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickGround)&&this.extend.onClickGround(n,e),!n)return;"function"==typeof(null==(i=this.extend)?void 0:i.onClickLeft)&&this.extend.onClickLeft(n,e)}else"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(l)}hoverAnchor(e){if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(e[0],Ae),e.length){const t=e[0].object;if(this.container.style.cursor=t._isAnchor_?"pointer":"auto",!t._isAnchor_)return void this.anchorGroup.children.forEach((e=>{e.__change_color__=!1}));const i=t.material;void 0===t.__mat_color__&&(t.__mat_color__=i.color),i.color=new f(16715760),this.anchorGroup.children.forEach((e=>{e.__change_color__=e.uuid===t.uuid}))}else this.container.style.cursor="auto",this.anchorGroup.children.forEach((e=>{e.__change_color__=!1}))}restoreAnchorMaterial(){this.anchorGroup.traverse((e=>{e.isSprite&&!e.__change_color__&&e.__mat_color__&&(e.material.color=e.__mat_color__)}))}findParentGroup(e){const t=e=>{if(e._isBuilding_)return e;let i=e.parent;return i?i&&i._isBuilding_?i:t(i):void 0};return t(e)}getFloor(){return this.buildingGroup.children.filter((e=>e._isFloor_))}hideOmitFloor(e){this.buildingGroup.children.forEach((t=>{t.visible=t._isFloor_||e}))}getAll(){return this.buildingGroup.children.concat(this.dotGroup.children)}getFlowMark(e){return this.getAll().filter((t=>{var i;return(null==(i=t.data)?void 0:i.followMark)===e}))}getAnimTargetPos(e,t,i){const o=t||e.to||{x:-104,y:7,z:58},s=i||e.target||{x:0,y:0,z:0};return this.controls.target.set(s.x,s.y,s.z),o}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}dispose(){this.animateModels=[],this.disposeObj(this.water),this.disposeObj(this.sky),this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.lightGroup),this.disposeObj(this.mouseClickDiffusion),this.clock=null,this.water=null,this.sky=null,this.css2DRender=null,this.buildingGroup=null,this.character=null,this.dotGroup=null,this.anchorGroup=null,this.lightGroup=null,this.mouseClickDiffusion=null,this.extend={},super.dispose()}}const $e=(e,t)=>{const i=40*Math.random();return void 0!==i&&(e.value=i),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:"#"+(16777215+1e6*i).toString(16).substring(0,6)}}},Ke=(e,t)=>{const i=Math.random()>.5?1:0,o=Math.random()>.5?1:0,s=Math.random()>.8?1:0,n=Math.floor(3*Math.random());return{status:s>0?0:i,error:s>0?0:o,remote:1==n?1:0,local:2==n?1:0,disabled:s}},Ve={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},We={class:"scene-operation"},Je=["innerHTML"],Xe=pe(k({__name:"index",setup(e){const t=w({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"223",env:"/oss/textures/hdr/3.hdr",dotKey:"DOT",dotShowStrict:!1,colorMeshName:[],floorModelType:["FLOOR_COMMON"],anchorType:["PARK_CAMERA","PARK_ROOM_INLET",ye,fe,be,ve,xe,ke,we],carType:["car_tanker","car_goods","car_trailer","car_crane"],animationModelType:["building_commercial_2"],colors:{},config:{},cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line2.png",repeat:[.1,1],width:2,segment:100,tension:.1,speed:20,mapSpeed:.01,points:[[-89.57,Ce,179.4],[-52.28,Ce,179.4],[-52.28,Ce,123.05],[-4.43,Ce,123.05],[-4.43,Ce,99.18],[6.26,Ce,99.18],[6.26,Ce,153.83],[92.71,Ce,153.83],[147.75,Ce,148.23],[147.75,Ce,135.93],[144.21,Ce,133.13],[144.21,Ce,126.7],[86.6,Ce,126.7],[86.6,Ce,152.35],[77.55,Ce,152.35],[77.55,Ce,-137.3],[3.34,Ce,-137.3],[3.34,Ce,-52.04],[-89.57,Ce,-52.04]],offset:1.8,animateBack:(e,t,i,o)=>{if(b){(o+=.02)>1&&(o-=1),e=((e,t=0)=>new a(e.x,e.y+t,e.z))(i.getPointAt(o));let s=o+.001;s>1&&(s-=1),t=i.getPointAt(s),b.position.set(e.x,.16,e.z);const n=Math.atan2(-t.z+e.z,t.x-e.x);b.rotation.z=.5*Math.PI+n}}},models:[{key:"SCENE",name:"场景",size:14.7,url:"/场景.glb"},{key:ge,name:"地面",size:4,url:"/地面.glb"},{key:"PARKING_SPACE",name:"停车位",size:.06,url:"/停车位.glb"},{key:"building_1",name:"楼栋1",size:1.2,url:"/楼栋1.glb"},{key:"building_2",name:"楼栋2",size:2,url:"/楼栋2.glb"},{key:"building_3",name:"楼栋3",size:1.6,url:"/楼栋3.glb"},{key:"building_4",name:"楼栋4",size:2.8,url:"/楼栋4.glb"},{key:"building_5",name:"楼栋5",size:1.6,url:"/楼栋5.glb"},{key:"building_warehouse",name:"仓库",size:.7,url:"/仓库.glb"},{key:"building_commercial_1",name:"商业楼1",size:.6,url:"/商业楼1.glb"},{key:"building_commercial_2",name:"商业楼2",size:14.5,url:"/商业楼2.glb"},{key:"building_commercial_3",name:"商业楼3",size:.6,url:"/商业楼3.glb"},{key:"building_commercial_4",name:"电梯房",size:9.6,url:"/电梯房.glb"},{key:"building_commercial_5",name:"现代门窗",size:95,url:"/现代门窗.glb"},{key:"car_tanker",name:"油罐车",size:1,url:"/油罐车.glb"},{key:"car_goods",name:"货车",size:6.4,url:"/货车.glb"},{key:"car_trailer",name:"拖车",size:2,url:"/拖车.glb"},{key:"car_crane",name:"吊车",size:4.4,url:"/吊车.glb"},{key:"car_aodi",name:"奥迪",size:1,url:"/奥迪.glb"},{key:"car_kaidilake",name:"凯迪拉克",size:1.6,url:"/凯迪拉克.glb"},{key:"ARBOR_ONE",name:"小树",size:2,url:"/小树.glb"},{key:"FENCE",name:"围栏",size:.8,url:"/围栏.glb"},{key:"HANDRAIL",name:"栏杆",size:.1,url:"/栏杆.glb"},{key:_e,name:"机器人",size:.3,url:"/机器人.glb"},{key:me,name:"人物",size:2.2,url:"/RobotExpressive.glb"},{key:"PARK_CAMERA",name:"摄像头",type:"sprite",range:{x:18.5,y:38.5},mapUrl:"/sxt.png"},{key:ye,name:"视频播放",type:"sprite",range:{x:1,y:1},mapUrl:"/video.png"},{key:fe,name:"开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:be,name:"半开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:ve,name:"双开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:ke,name:"推拉门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:xe,name:"电梯门",type:"sprite",range:{x:1,y:1},mapUrl:"/lift.png"},{key:"spot_light_reception",type:"spotlight",name:"聚光灯",intensity:8,distance:100,decay:0},{key:we,name:"开关灯",type:"sprite",range:{x:1.2,y:1.2},mapUrl:"/light.png"}].map((e=>(e.url&&(e.url="/oss/model/park"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/park"+e.mapUrl),e)))});const i=w({active:1,show:!1,list:[{name:"一楼",key:1,y:.2},{name:"二楼",key:2,y:13.8},{name:"三楼",key:3,y:19.83},{name:"五楼",key:5,y:31.76}]}),o=w({show:!1,style:{left:0,top:0},msg:""}),s=C(),n=W(Ve,t.colors),{changeBackground:r,backgroundLoad:l}=ie(),{progress:c,loadModels:d,getModel:h,virtualization:u,closeVirtualization:p}=ae({baseUrl:t.baseUrl,colors:n,colorMeshName:t.colorMeshName,indexDB:{cache:!1,dbName:"THREE__PARK__DB",tbName:"TB",version:74}}),_={env:"/oss/textures/hdr/3.hdr",controls:{maxDistance:1500,maxPolarAngle:.45*Math.PI,screenSpacePanning:!0,enablePan:!0},camera:{position:[-85.7,3.6,208.6]},cruise:t.cruise,grid:{visible:!1},axes:{visible:!0},directionalLight:{visible:!0,intensity:3}},m=e=>{var i;const o=e.data;{const e=$e(o,J.buildingGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!t.dotShowStrict;const s=null==(i=e.element)?void 0:i.getElementsByClassName("inner")[0];if(s){const{size:e,color:t}=o.font||{};null!=e&&(s.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(s.style.color=t),s.textContent=`${o.value||0}${o.unit}`}},g=async e=>{if(!e)return;const{type:i,url:o}=e,s=h(i);if(!s)return void(o||i===t.dotKey&&(e=>{m(J.addDot(e,(e=>{})))})(e));const{floorModelType:n=[],anchorType:r=[],carType:a=[],animationModelType:l=[]}=t;let c=ce(s);const{position:d,scale:u,rotation:p}=de(c,e),[_,g,f]=d;return c.scale.set(...u),c.position.set(_,g,f),c.rotation.set(...p),c._isBuilding_=!0,c.data=e,a.includes(i)&&(e=>{const t=e.data,{to:i,position:o}=t;if(!i)return;const s=x.randInt(0,1e4);e.tween1=new y(e.position).to(i,3e4).delay(s).onUpdate((({x:t,y:i,z:o})=>{e.position.x=t,e.position.y=i,e.position.z=o})),e.tween2=new y(o).to(i,3e4).onUpdate((({x:t,y:i,z:o})=>{e.position.x=t,e.position.y=i,e.position.z=o})),e.tween1.chain(e.tween2),e.tween2.chain(e.tween1),e.tween1.start()})(c),l.includes(i)&&J.addModelAnimate(c,s.animations,!0,.1),n.includes(i)&&(c._position_={x:_,y:g,z:f},c._isFloor_=!0),c.__ground__=i===ge,r.includes(i)?(c._isAnchor_=!0,J.addAnchor(c)):c.isSpotLight?J.addLight(e,c,!0):J.addBuilding(c),Promise.resolve()},f=async()=>{c.percentage=100,c.show=!1,J.clearBuilding(),await $(),await(()=>{let e=0,t=v.value.length;return new Promise((i=>{if(0==t)return i(null);const o=async()=>{const s=v.value[e];await g(s),e++,e<t?o():i(e)};o()}))})(),J.setCruisePoint(t.cruise.points);const e=J.getAnimTargetPos(t.config||{});le(J.camera,e,J.controls.target).then((()=>{J.controlSave()}))};let b;const v=C([]),k=()=>{d(t.models,(()=>{he.get(ue.d3.park).then((async e=>{let i={};if(e.ConfigJson instanceof Object)i=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{i=JSON.parse(e.ConfigJson)}catch(o){}v.value=e.JsonList,Object.keys(i).forEach((e=>{t.config&&(t.config[e]=i[e])})),await f(),b=h(_e),b.position.z=.16,b.rotation.z=.5*Math.PI,J.addObject(b),(()=>{const e=h(me);e.traverse((e=>{e.isMesh&&(e.castShadow=!0)})),J.addCharacter(e,{x:-80.6,y:.16,z:193.4})})(),J.addVideoMaterial()}))}))},K=e=>{const i=[];J.getAll().forEach(((e,o)=>{if(!e.data)return;const s=e.data;let r=s.type;if(r===t.dotKey)return void m(e);{const e=Ke();if(!e)return;Object.keys(e).forEach((t=>{s[t]=e[t]}))}i.push(F(s));let{status:a=0,error:l=0,remote:c=0,local:d=0,disabled:h=0}=s;const u=n[l>0?"error":a>0?"runing":"normal"];(e=>{let{el:t,type:i,colorObj:o,color:s,paused:n}=e,r=re(s);s=r[0];const a=t.extra;a&&(a.action&&(a.action.paused=n),null!=s)&&(a.meshs||[]).forEach((e=>{ne(e,s)}))})({type:r,el:e,colorObj:u,color:null!=u[r]?u[r]:u.color,paused:0==a,error:l>0,remote:c>0,local:d>0,disabled:h>0})}))};let J;return G((()=>{_.container=s.value;const e="轿厢-ground";J=new He(_,{groundMeshName:["地面","楼板","mesh_0_4","ground",e],onDblclick:e=>{var t,i,o;"building_commercial_5"===(null==(t=e.data)?void 0:t.type)?u(e,null==(i=J.buildingGroup)?void 0:i.children.filter((e=>!["地面","场景"].includes(e.name))),{wireframe:!0,opacity:.1}):p(null==(o=J.buildingGroup)?void 0:o.children)},onClickLeft(e,t){if(e&&e.data){const t=e.data;switch(null==t?void 0:t.type){case ye:J.videoPlay(e);break;case fe:case be:J.openTheDoor(e,t.type===be);break;case ve:J.openTheDoubleSlidingDoor(e);break;case xe:J.waitLift(e);break;case ke:J.openTheSlidingDoor(e);break;case we:J.lightSwitch(e)}}},onClickGround:(t,o)=>{J.mouseClickGround(o).then((t=>{i.show=o.object.name===e}))},onClickRight:e=>{},onHoverAnchor:(e,t)=>{const i=!!e&&e.object._isAnchor_;if(o.show=i,i){o.style.top=t.top,o.style.left=t.left;const i=e.object.data;o.msg=`\n          <p>${i.name}</p>\n          <p>类型：${i.type}</p>\n          <p>绑定：${i.bind||"无"}</p>\n        `}}}),J.run(),ee(J).resize(),k(),l(J,t.skyCode)})),(e,n)=>{const a=H;return O(),z("div",{class:N(e.$style.page)},[D("div",We,[D("div",{class:"btn",onClick:n[0]||(n[0]=()=>K())},"随机更新"),D("div",{class:"btn",onClick:n[1]||(n[1]=()=>j(J).toggleSight())},"人物视角切换"),D("div",{class:"btn",onClick:n[2]||(n[2]=()=>{var e;return null==(e=j(J))?void 0:e.toggleCruise()})},"定点巡航"),D("div",{class:"btn",onClick:n[3]||(n[3]=()=>{var e;return null==(e=j(J))?void 0:e.getPosition()})},"场景坐标"),D("div",{class:"btn",onClick:n[4]||(n[4]=()=>j(r)(j(J)))},"切换背景"),D("div",{class:"btn",onClick:n[5]||(n[5]=()=>{var e;return null==(e=j(J))?void 0:e.controlReset()})},"控制器重置"),D("div",{class:"btn",onClick:n[6]||(n[6]=()=>{var e;return null==(e=j(J))?void 0:e.characterAccelerate()})},"人物加速"),D("div",{class:"btn",onClick:n[7]||(n[7]=()=>{var e;return null==(e=j(J))?void 0:e.toggleCruiseDepthTest()})},"巡航深度")]),A(D("div",{class:N(e.$style["floor-select"])},[(O(!0),z(M,null,T(j(i).list,(e=>(O(),S(a,{type:"primary",disabled:j(i).active===e.key,onClick:t=>(e=>{i.active=e.key;const t="电梯门"+e.key;J.waitLift({data:{bind:t,to:{y:e.y}}},!0)})(e)},{default:E((()=>[R(L(e.name),1)])),_:2},1032,["disabled","onClick"])))),256))],2),[[P,j(i).show]]),D("div",{class:N(e.$style.container),ref_key:"containerRef",ref:s},null,2),U(V,{modelValue:j(c).show,"onUpdate:modelValue":n[8]||(n[8]=e=>j(c).show=e),"bg-color":j(t).bgColor,progress:j(c).percentage},null,8,["modelValue","bg-color","progress"]),j(o).show?(O(),z("div",{key:0,class:N(e.$style.tip),style:B({left:j(o).style.left+"px",top:j(o).style.top+"px"})},[D("div",{class:N(e.$style.msg),innerHTML:j(o).msg},null,10,Je)],6)):I("",!0)],2)}}}),[["__cssModules",{$style:{page:"_page_1m9si_2",container:"_container_1m9si_10","floor-select":"_floor-select_1m9si_14",tip:"_tip_1m9si_20",msg:"_msg_1m9si_29"}}]]);export{Xe as default};
