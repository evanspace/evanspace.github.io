import{e,co as t,cp as a,o as s,g as o,h as n,n as r,t as i,a9 as l,s as c,B as d,bJ as p,bM as m,c9 as u,ca as b,cq as h,cr as w,cg as y,cs as g,bK as x,bc as f,bO as _,ct as v,Y as z,cu as M,bt as S,cv as B,bu as D,bC as P,bP as k,bV as E,b7 as N,cw as A,cx as T,cy as C,cz as L,cA as O}from"./vendor-8986b6ad.js";import{_ as j}from"./index-c2ca0eee.js";import{d as U,g as I}from"./scene-resize-6ab2e993.js";import{D as q}from"./background-954024da.js";const K=j(e({__name:"index",props:t({bgColor:{},progress:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=a(e,"modelValue");return(e,a)=>t.value?(s(),o("div",{key:0,class:r(["loading",e.$style.loading]),style:l({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:a[0]||(a[0]=c((()=>{}),["stop"]))},[n("div",{class:r(e.$style.progress),style:l({"--percentage":e.progress+"%"})},[n("div",{class:r(e.$style["bar-out"])},[n("div",{class:r(e.$style.bar)},null,2)],2),n("div",{class:r(e.$style.text)},i(e.progress)+"%",3)],6)],38)):d("",!0)}}),[["__cssModules",{$style:{loading:"_loading_109qb_2",progress:"_progress_109qb_17","bar-out":"_bar-out_109qb_21",bar:"_bar_109qb_21","striped-flow":"_striped-flow_109qb_1",text:"_text_109qb_45"}}]]),$=()=>({initCSS2DRender:(e,t)=>{const{width:a,height:s}=e,o=new p;return o.setSize(a,s),o.domElement.style.position="absolute",o.domElement.style.left="0px",o.domElement.style.top="0px",o.domElement.style.pointerEvents="none",t.appendChild(o.domElement),o},createCSS2DDom:e=>{const{name:t,className:a="",onClick:s,position:o}=e,n=document.createElement("div");n.innerHTML=t,n.className=a;const r=new m(n);return n.style.pointerEvents=s?"auto":"none",n.style.position="absolute","function"==typeof s&&n.addEventListener("click",s),o&&r.position.set(...o),r}}),V=(e,t,a=1)=>{const s=e.position,o=e.rotation,n=e.scale,r=t.position||{x:0,y:0,z:0},i=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(i.x)<2?1:180,d=Math.abs(i.y)<2?1:180,p=Math.abs(i.z)<2?1:180;return{position:[s.x+r.x,s.y+r.y,s.z+r.z],rotation:[o.x+Math.PI/c*i.x,o.y+Math.PI/d*i.y,o.z+Math.PI/p*i.z],scale:[n.x*a*l.x,n.y*a*l.y,n.z*a*l.z]}},R=e=>{e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()},H=e=>{let t=e.clone();return(e.isMesh||e.isSprite)&&R(e),t.traverse((e=>{e.isMesh&&R(e)})),t},W=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},X=(e,t)=>{e.traverse((e=>{e.isMesh&&(Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},G=(e,t,a)=>(e.lookAt(a),e._lookAt_=a,new Promise((s=>{new u(e.position).to(t,1e3).easing(b.Quadratic.In).start().onUpdate((()=>{e.lookAt(a),e._lookAt_=a})).onComplete((()=>{s(e)}))}))),J=(e,t,a=1,s=10)=>{let o=[0,s/2,s],n=[...t,t[0],t[1]+a,t[2],...t],r=new h("sprite.position",o,n),i=new w("sprite_up_down",s,[r]);const l=new y(e),c=l.clipAction(i);return c.timeScale=5,c.play(),e.__action__=c,e.__mixer__=l,e},Y=(e,t,a)=>{let s=e.clientWidth/2,o=e.clientHeight/2,n=t.position.clone();const r=t.scale;n.y+=r.x/2;let i=n.project(a);return{left:i.x*s+s,top:-i.y*o+o}},F=(e,t,a="name")=>{let s=[];if(!e||!e.length)return[];return function e(o){o.forEach((o=>{const n=o[a];"string"==typeof n&&t.some((e=>n.indexOf(e)>-1))&&s.push(o),o.children&&e(o.children)}))}(e),s},Q=q.statusOffset,Z=(e,t,a={})=>{const s=t.type,o=Q[e]||{},n=a[s]||o[s]||{};let r=U({x:0,y:0,z:0},n.position||{}),i=U({x:0,y:0,z:0},n.rotation||{});return i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z,{position:r,rotation:i}},ee=(e,t,a=16777215,s)=>{const o=Z("TEXT",e,s);let n=e.font||{},r=new g(e.name||"",{font:t,size:n.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const i=o.rotation;r.rotateX(i.x),r.rotateY(i.y),r.rotateZ(i.z);const l=o.position;r.computeBoundingBox(),r.computeVertexNormals();let c=.5*(r.boundingBox.max.x-r.boundingBox.min.x),d=.5*(r.boundingBox.max.z-r.boundingBox.min.z),p=new x({color:null!=n.color?n.color:a,flatShading:!1}),m=new f(r,p);return m.castShadow=!0,m.position.set((l.x||0)-c,l.y||0,(l.z||0)-d),m.name="text",m._isText_=!0,m},te=(e,t,a,s,o=100,n=1)=>{if(!a)return;const r=Z("WARNING",t,s);let i=new _,l=H(a);l.scale.set(n,n,n);const c=r.position;l.position.set(c.x,c.y,c.z);const d=r.rotation;l.rotation.set(d.x,d.y,d.z),i.add(l);let p=new v(12717056,8,o,0);p.name="灯光",p.position.y=c.y+30,i.add(p),i.name=e;let m=new y(i),u=new h("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),b=new h("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),g=new h("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),x=new w("warning_",1,[u,b,g]),f=m.clipAction(x);return f.paused=!0,f.play(),i.visible=!1,i._isWarning_=!0,{group:i,action:f,mixer:m}},ae=(e,t,a,s)=>{if(!t)return;const o=Z(s?"DISABLED":"STATUS",e,a);let n=H(t);const r=o.position;n.position.set(r.x,r.y,r.z);const i=o.rotation;return n.rotation.set(i.x,i.y,i.z),n.visible=!1,n._isStatus_=!0,n},se=e=>new Promise((t=>{const a=window.indexedDB.deleteDatabase(e);a.onsuccess=e=>{t(!0)},a.onerror=e=>{t(!1)}})),oe=async(e,t="THREE__MODEL_DB",a=1)=>{if(!window.indexedDB)return Promise.resolve(void 0);await((e,t,a)=>new Promise((s=>{window.indexedDB.open(e).onsuccess=o=>{const n=o.target.result,r=n.version;n.close(),r!==t?se(e).then((e=>{s(e?t:r)})):n.objectStoreNames.contains(a)?s(r):se(e).then((e=>{s(e?t:r)}))}})))(t,a,e);let s=window.indexedDB.open(t,a);return new Promise((t=>{s.onupgradeneeded=t=>{const a=t.target.result;a.objectStoreNames.contains(e)||a.createObjectStore(e,{keyPath:"path"})},s.onsuccess=e=>{const a=e.target.result;t(a)},s.onerror=e=>{t(void 0)}}))},ne=(e={})=>{let t;const a=U({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},e),s=z({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),o={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},n=new Map,r=new M;r.setDecoderPath(a.baseUrl+a.dracoPath);const i=new S;i.setDRACOLoader(r);const l=new B;l.setTranscoderPath(a.baseUrl+a.basisPath),i.setKTX2Loader(l),i.setMeshoptDecoder(D);const c=e=>{const t=e.loaded,a=s.total;let o=Number((t+s.loaded)/a*100);o>100&&(o=100),s.percentage=Number(o.toFixed(2))},d=(e,t,s,o)=>{if(!s)return;const{baseUrl:r,colorMeshName:i}=a,{mapUrl:l,key:c,mapMeshName:d,repeat:p=[1,1]}=e;let m;l&&d&&(m=(new P).load(I(l,r)),m.wrapS=k,m.wrapT=k,m.repeat.set(p[0],p[1]));const u=H(s);return u.traverse((e=>{e.isMesh&&m&&e.name.indexOf(d)>-1?e.material=new E({side:N,transparent:!0,opacity:0,map:m.clone()}):((e,t=6776165,a,s)=>{const{type:o,name:n}=e;o.indexOf("Light"),q.mesh.receiveShadowName.some((e=>n.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):a.some((e=>n.indexOf(e)>-1))?X(e,t):e.isMesh&&(s&&(e.material.envMap=s),e.castShadow=!0)})(e,t,i||[])})),l&&d&&(u._mapMeshName_=d),u.animations=o,c&&n.set(c,u),u},p=(e,s=0)=>new Promise((async o=>{var n;a.indexDB.cache||o(null);const r=A.get(e);if(r)r instanceof ArrayBuffer?(c({loaded:r.byteLength}),i.parse(r,"",(t=>{A.add(e,t),o(t)}))):(c({loaded:s*a.modelSizeKB}),setTimeout((()=>{o(r)}),10));else{const s=await((e,t,a)=>{if(!e||!t||!a)return Promise.resolve(null);const s=e.transaction([t],"readonly").objectStore(t).get(a);return new Promise(((e,t)=>{s.onsuccess=t=>{const a=t.target.result;e(a)},s.onerror=e=>{t(e)}}))})(t,(null==(n=a.indexDB)?void 0:n.tbName)||q.indexdb.tbName,e);if(s&&s.data){const e=s.data;"string"==typeof e?(c({loaded:e.length}),A.add(s.path,e),setTimeout((()=>{o(e)}),10)):(c({loaded:e.byteLength}),i.parse(e,"",(e=>{A.add(s.path,e),o(e)})))}else o(null)}})),m=e=>{var s;if(!a.indexDB.cache)return;const o=A.get(e);if(o&&t){const n=(null==(s=a.indexDB)?void 0:s.tbName)||q.indexdb.tbName;t.transaction(n,"readwrite").objectStore(n).add({path:e,data:o})}},u=(e,t)=>{const{key:s,url:o="",size:n=0}=e,{baseUrl:r,colors:l}=a;return new Promise((async(a,u)=>{let b=l.normal[s]||l.normal.color;b=W(b)[0];const h=I(o,r),w=await p(h,n);if(w){const t=w.scene.children[0],s=d(e,b,t,w.animations);return void a(s)}let y=h.split(".").pop().toLowerCase();if("glb"!==y)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+y);i.load(h,(t=>{const s=t.scene.children;let o=new _;s.length>1?o.add(...s):o=s[s.length-1];const n=d(e,b,o,t.animations);m(h),a(n)}),(e=>{c(e),"function"==typeof t&&t(e)}),u)}))};return{progress:s,MODEL_MAP:o,loadModel:u,loadModels:async(e,r,i)=>{var l,d,b;await oe((null==(l=a.indexDB)?void 0:l.tbName)||q.indexdb.tbName,(null==(d=a.indexDB)?void 0:d.dbName)||q.indexdb.dbName,(null==(b=a.indexDB)?void 0:b.version)||q.indexdb.version).then((e=>(e&&(A.enabled=!0,t=e),e)));const h=e.length;if(!(0==h?(s.isEnd=!0,s.show=!1,0):(s.isEnd=!1,s.percentage=0,s.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)s.total+=(e[t].size||0)*a.modelSizeKB})(e);let w=0;const y=async()=>{const t=e[w],{type:l=o.device,size:d=0}=t;switch(l){case o.device:case o.pipe:await u(t,i);break;case o.sprite:(e=>{const{key:t,range:s={x:1,y:1},mapUrl:o=""}=e;let r=(new P).load(a.baseUrl+o),i=new T({map:r}),l=new C(i),c=s.x,d=s.y;l.scale.set(c,d,1),l.name="sprite",n.set(t,l)})(t);break;case o.font:await((e,t)=>{const{url:s="",size:r=0}=e,{baseUrl:i}=a,l=I(s,i),d=new L;return new Promise((async(e,a)=>{const s=await p(l,r);if(s){const t=d.parse(JSON.parse(s));return n.set(o.font,t),void setTimeout((()=>{e(t)}),10)}d.load(l,(t=>{n.set(o.font,t),m(l),e(t)}),(e=>{c(e),"function"==typeof t&&t(e)}),a)}))})(t,i);break;case o.warning:t.key=o.warning,await u(t,i);break;case o.local:t.key=o.local,await u(t,i);break;case o.disabled:t.key=o.disabled,await u(t,i);break;case o.spotlight:(e=>{const{key:t,color:a=16777215,intensity:s=8,distance:o=10,angle:r=.2*Math.PI,penumbra:i=.2,decay:l=0}=e;let c=new O(a,s,o,r,i,l);c.castShadow=!0,c.visible=!1;let d=800;c.shadow.camera.right=d,c.shadow.camera.left=-d,c.shadow.camera.top=d,c.shadow.camera.bottom=-d,n.set(t,c)})(t)}w++,s.loaded+=d*a.modelSizeKB,w>=h?(s.percentage=100,s.isEnd=!0,r()):y()};y()},getModel:e=>n.get(e)}};export{ne as a,W as b,G as c,H as d,V as e,F as f,Y as g,ee as h,te as i,ae as j,J as k,X as s,K as t,$ as u};
