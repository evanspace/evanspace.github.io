var e=Object.defineProperty,t=(t,i,o)=>(((t,i,o)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o})(t,"symbol"!=typeof i?i+"":i,o),o);import{e as i,ej as o,ek as s,o as n,g as a,h as r,t as l,q as c,B as d,c as h,au as u,bp as p,bm as m,bh as g,en as _,bi as v,dL as f,eq as y,d5 as C,er as b,es as A,bj as R,bq as E,c$ as S,Y as k,c5 as x,i as O,f as T,l as M,u as G,F as w,r as L,n as I,a7 as D,a8 as P,m as N,p as j,I as H,a9 as z,ak as U,aa as B}from"./vendor-75d44f4a.js";import{t as F,d as W,A as V,k as $,s as J,_ as Y}from"./index-5784889a.js";import{t as K}from"./index-94d2c6e7.js";import{m as q,l as Z,A as Q,u as X}from"./scene-resize-311d5dd4.js";const ee={key:0,class:"screen-welcom-dialog"},te={class:"wrap"},ie={class:"body"},oe={class:"title"},se={class:"bg"},ne={class:"text"},ae={class:"content"},re=i({__name:"edit-dialog",props:o({title:{},errMessage:{}},{modelValue:{type:Boolean},modelModifiers:{},content:{},contentModifiers:{}}),emits:o(["confirm"],["update:modelValue","update:content"]),setup(e,{emit:t}){const i=e,o=s(e,"modelValue"),p=s(e,"content"),m=t,g=()=>{F(p.value||"")?(o.value=!1,m("confirm",p.value)):h.warning({message:i.errMessage,grouping:!0})};return(e,t)=>{const i=u;return o.value?(n(),a("div",ee,[r("div",{class:"mask",onClick:t[0]||(t[0]=e=>o.value=!o.value)}),r("div",te,[r("div",ie,[r("div",oe,[r("div",se,l(e.title),1),r("div",ne,l(e.title),1)]),r("div",ae,[c(i,{type:"textarea",modelValue:p.value,"onUpdate:modelValue":t[1]||(t[1]=e=>p.value=e),placeholder:"请输入",maxlength:"24","show-word-limit":""},null,8,["modelValue"])]),r("div",{class:"footer"},[r("div",{class:"btn",onClick:g})])])])])):d("",!0)}}}),le="ANCHOR_POS",ce="ANCHOR_TARGET",de="MAIN_SCENE",he="campany_floor",ue="curtain",pe="ROBOT",me="CHARACTER",ge="WAIT_LIFT",_e="LIGHT_SWITCH",ve="LIGHT_MAIN_SWITCH",fe="AIR_SWITCH",ye="GATE_SWITCH",Ce="DOUBLE_HORIZONTAL_SWITCH",be="DOUBLE_ROTATE_SWITCH",Ae="ODD_ROTATE_SWITCH",Re="VIDEO_SWITCH",Ee="SCREEN_EDIT",Se="CURTAIN_SWITCH",ke=.1,xe=[[-120,ke,101],[139,ke,101],[139,ke,-122],[-120,ke,-122]],Oe=["CAMERA:ROAM","CAMERA:CRUISE","CAMERA:RESET","CAMERA:FIRST","CAMERA:THREE","CAMERA:GATE","CAMERA:RECCEPTION","CAMERA:OFFICE","CAMERA:LCR","CAMERA:BOSS","PERSON:ADD","PERSON:SUB","LIGHT:RECCEPTION","LIGHT:AILSE","LIGHT:PM","LIGHT:HOST","LIGHT:LCR","LIGHT:CLOSE","LIGHT:AUTO","CURTAIN:TOGGLE","DOOR:COMPANY","DOOR:LCR","DOOR:BOSS","SCREEN:COMPANY","SCREEN:WELCOM","SCREEN:SCR","SCREEN:LCR","AIR:MAIN","SCENE:POS"];const Te=new class{constructor(){t(this,"listteners",Oe.reduce(((e,t)=>(e[t]=new Set,e)),{}))}on(e,t){this.listteners[e].forEach((i=>{i.toString()===t.toString()&&this.listteners[e].delete(i)})),this.listteners[e].add(t)}emit(e,...t){this.listteners[e].forEach((e=>e(...t)))}},Me=300,Ge=Z,we=Q,{raycaster:Le,pointer:Ie,update:De,style:Pe}=Ge.useRaycaster(),{initCSS2DRender:Ne,createCSS2DDom:je}=Ge.useCSS2D(),{createDiffusion:He,updateDiffusion:ze}=Ge.useDiffusion(),{createMove:Ue,moveAnimate:Be}=Ge.useMoveAnimate(),{createFence:Fe,fenceAnimate:We}=Ge.useFence(),{keyboardPressed:Ve,destroyEvent:$e,insertEvent:Je}=Ge.useKeyboardState(),{checkCollide:Ye}=Ge.useCollide(),{dubleHorizontal:Ke,dubleRotate:qe,oddRotate:Ze}=Ge.useOpenTheDoor(),{createRoam:Qe,executeRoam:Xe,pause:et,play:tt,getStatus:it}=Ge.useRoam(),ot={}.VITE_BEFORE_STATIC_PAT||"",st="FULL",nt="NPC",at=e=>{const t=document.createElement("video");return t.src=ot+(e||"/oss/textures/park/sintel.mp4"),t.loop=!0,t},rt=(new p).load(ot+"/oss/textures/office/cover.jpg"),lt=(new p).load(ot+"/oss/textures/office/wind.png");class ct extends q{constructor(e,i){super(e),t(this,"buildingGroup"),t(this,"anchorGroup"),t(this,"dotGroup"),t(this,"lightGroup"),t(this,"extend"),t(this,"css2DRender"),t(this,"mouseClickDiffusion"),t(this,"character"),t(this,"currentSight"),t(this,"historyTarget"),t(this,"historyCameraPosition"),t(this,"animateModels",[]),t(this,"videoModels",[]),t(this,"canvasTextures",[]),t(this,"moveFactor",1),t(this,"fence"),this.extend=i,this.css2DRender=Ne(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=He(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.createClock(),this.currentSight=st,this.historyTarget=new m,this.historyCameraPosition=new m,this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup()}addBuildingGroup(){const e=new g;e.name="建筑组",this.buildingGroup=e,this.addObject(e)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot()}addBuilding(...e){this.buildingGroup&&this.buildingGroup.add(...e)}addAnchorGroup(){const e=new g;e.name="锚点组",this.anchorGroup=e,this.addObject(e)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(e){this.anchorGroup&&this.anchorGroup.add(e);const{x:t,y:i,z:o}=e.position;we.createSpriteAnimate(e,[t,i,o],.2,8)}addDotGroup(){const e=new g;e.name="点位组",this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){var i;const o=e.position,{size:s,color:n}=e.font||{},{x:a=0,y:r=0,z:l=0}=o||{},c=je({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,r,l],onClick:t});return c.name=e.name,c.data=e,c._position_={x:a,y:r,z:l},null==(i=this.dotGroup)||i.add(c),c}addLightGroup(){const e=new g;e.name="灯光组",this.lightGroup=e,this.addObject(e)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}closeLightGroup(e=!1){var t;null==(t=this.lightGroup)||t.children.forEach((t=>{t.isSpotLight&&(t.visible=e)}))}addLight(e,t,i){if(this.lightGroup){t.name=e.name;const o=e.position||{x:0,y:0,z:0},{to:s={x:o.x,y:o.y-2,z:o.z}}=e;if(t.target.position.set(s.x,s.y,s.z),t.visible=!0,this.lightGroup.add(t),this.lightGroup.add(t.target),i){const e=new _(t,t.color);this.lightGroup.add(e)}}}drawCanvas(e=""){if(!this.extend.canvas)return;const t=this.extend.canvas,i=t.offsetWidth,o=t.offsetHeight;t.width=i,t.height=o;const s=t.getContext("2d");if(!s)return;s.clearRect(0,0,i,o),s.fillStyle="#f00";const n=e.length,a=n>12?Math.ceil(n/2):12;let r=[],l=0;for(;l<n;){const t=l+a;r.push(e.substring(l,t)),l=t}s.font="100 40px 微软雅黑",s.textAlign="center",s.textBaseline="middle";const c=r.length;r.forEach(((e,t)=>{const n=t*c+1;s.fillText(e,i/2,o/c/2*n)})),this.canvasTextures.length&&this.canvasTextures.forEach((e=>{e.needsUpdate=!0}))}addCharacter(e,t){const{x:i,y:o,z:s}=t;e.position.set(i,o,s),this.character=e;const n=e.animations,a=new v(e),r={};for(let d=0;d<n.length;d++){const e=n[d],t=a.clipAction(e);r[e.name]=t}r.Dance.play();const l=r.Walking;e.extra={mixer:a,actions:r,runging:l},this.addObject(e);const c=["W","S"].map((e=>e.toUpperCase().charCodeAt(0)));Je((t=>{e.__runing__||c.includes(t.keyCode)&&l.play()}),(t=>{e.__runing__||c.includes(t.keyCode)&&l.stop()}))}toggleSight(e){if(this.judgeCruise())return;this.judgeAndStopRoam();const t=this.currentSight==st?nt:st;this.currentSight=t;const i=t===nt;if(!this.controls)return;if(this.controls.maxDistance=i?3==e?10:0:800,this.controls.screenSpacePanning=!i,this.controls.enablePan=!i,this.controls.maxPolarAngle=Math.PI*(i?.8:.48),!this.character)return;const o=this.character.position,s=new m(0,2.5,0);if(i){h.success({message:"鼠标点击地面移动，或键盘 W、S 前后移动，A、D调整左右方向！",duration:15e3}),this.historyTarget=this.controls.target.clone(),this.historyCameraPosition=this.camera.position.clone();const e=o.clone().add(s);this.camera.lookAt(e),Math.abs(this.camera.position.y-e.y)>8&&(this.camera.position.y=e.y)}else this.camera.position.copy(this.historyCameraPosition),this.camera.lookAt(o);const n=(i?o:this.historyTarget).clone().add(s);this.controls.target.copy(n)}isPerspectives(){return this.currentSight==nt}characterAccelerate(e=1){this.moveFactor+=e,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),h.success({message:"人物速度："+this.moveFactor,grouping:!0})}setControlTarget(e){this.controls&&(this.controls.target.copy(e.clone().add(new m(0,2.5,0))),this.camera.lookAt(this.controls.target))}waitLift(e,t){var i;const o=e.data.target,s=this.scene.getObjectByName(o),n=null==(i=e.data)?void 0:i.to;if(!s||!n)return;const a=s.position;if(Math.abs(n.y-a.y)>.2){const i=s.__bind_lift__;void 0!==i&&this.dubleHorizontalDoor({data:{bind:i}},2.3,!1),this.dubleHorizontalDoor({data:{bind:o}},2.3,!1).then((()=>{const i=5e3;h.success({message:`${o}移动中，请稍候，5秒后到达!`,duration:i}),new f(a).to({y:n.y},i).delay(0).start().onUpdate((e=>{if(t){if(!this.character)return;this.character.position.y=e.y,this.camera.position.y=e.y,this.setControlTarget(this.character.position)}})).onComplete((()=>{s.__bind_lift__=e.data.bind,this.openLift(e,o)}))}))}else this.openLift(e,o)}openLift(e,t){this.dubleHorizontalDoor(e,2.3),this.dubleHorizontalDoor({data:{bind:t}},2.3)}lightSwitch(e,t,i){var o,s;const n=null==(s=this.lightGroup)?void 0:s.getObjectsByProperty("name",null==(o=e.data)?void 0:o.bind);n&&n.forEach(((e,o)=>{let s=!(null!=i&&i>=0)&&(null!=t?t:!e.visible);null!=i&&i>=0&&o<i&&(s=null==t||t),e.visible=s}))}dubleHorizontalDoor(e,t=400,i){const{bind:o,axle:s="z"}=e.data;return Ke(this.scene,{value:o,axle:s,scale:t,isOpen:i})}oddRotateDoor(e){const{bind:t,axle:i="y",internal:o,autoClose:s=!1}=e.data;return Ze(this.scene,{value:t,axle:i,angle:Math.PI*(o?-.5:.5),autoClose:s})}dubleRotateDoor(e){const{bind:t,axle:i="y",left:o="右",right:s="左",internal:n,autoClose:a=!0}=e.data;return qe(this.scene,{value:t,axle:i,autoClose:a,angle:Math.PI*(n?-.5:.5),leftMatch:o,rightMatch:s})}openGate(e){return this.dubleRotateDoor(e)}toggleCurtain(e){const t=this.animateModels.find((t=>{var i;return t.name===(null==(i=e.data)?void 0:i.bind)}));if(!t)return;t.__open__=!t.__open__;const{__action__:i,__mixer__:o}=t;Object.keys(i).forEach((e=>{t.__open__&&(i[e].loop=y,i[e].clampWhenFinished=!0,i[e].play())})),t.__open__||o.stopAllAction()}addVideoMaterial(e){const t=new C({map:rt});this.videoModels=[];for(let i=0;i<e.length;i++){const o=this.scene.getObjectByName(e[i]);if(!o)continue;const s=at(),n=new b(s);o.__video_texture__=n,o.__cover_texture__=rt.clone(),o.material=t.clone(),o.__video__=s,this.videoModels.push(o)}}addCanvasMaterial(e){var t;if(!this.extend.canvas)return;const i=new C({map:new A(this.extend.canvas),side:R});this.canvasTextures=[];for(let o=0;o<e.length;o++){const s=this.scene.getObjectByName(e[o]);s&&(s.material=i.clone(),s.__cover_texture__=null==(t=i.map)?void 0:t.clone(),this.canvasTextures.push(s.material.map))}}clearVideo(){const e=this.videoModels;for(let t=0;t<e.length;t++){const i=e[t],{__video__:o,__cover_texture__:s,__video_texture__:n}=i;o&&(o.pause(),o.remove(),null==s||s.dispose(),null==n||n.dispose())}}videoPlay(e){const t=this.scene.getObjectByName(e.data.bind);if(t&&t.__video__){const e=t.__video__;e.paused?(t.material.map=t.__video_texture__,null==e||e.play()):(null==e||e.pause(),t.material.map=t.__cover_texture__)}}addAirWindMaterial(e){lt.wrapS=E,lt.repeat.x=3;const t=new C({color:13033215,map:lt,transparent:!0,side:R});for(let i=0;i<e.length;i++){const o=this.scene.getObjectByName(e[i]);if(!o)return;o.traverse((e=>{e.isMesh&&(e.material=t)})),o.visible=!1}}toggleAir(e,t){const i=this.scene.getObjectByName(e.data.bind);i&&(i.__open__=null!=t?t:!i.__open__,i.visible=i.__open__)}mouseClickGround(e,t){if(this.currentSight!==nt)return Promise.reject();const i=this.character;if(!i)return Promise.reject();const{runing:o}=this.options.cruise;if(o)return Promise.reject();const s=e.point,n=this.mouseClickDiffusion,{runging:a}=i.extra;return a.play(),n.position.copy(s),n.visible=!0,i.__runing__=!0,new Promise((o=>{Ue(i,s,((o,s)=>{this.setControlTarget(o),this.checkCharacterCollide(o,t.includes(e.object.name)?2:.3)&&(s(),a.stop(),i.__runing__=!1,n.visible=!1)}),(e=>{this.setControlTarget(e),a.stop(),i.__runing__=!1,n.visible=!1,o(i)}))}))}checkCharacterCollide(e,t=.3){var i;if(!this.character)return;const o=Ye(this.character,e,(null==(i=this.buildingGroup)?void 0:i.children)||[],!0,new m(0,t,0));if(o.length){if(o[0].distance<.3)return h.warning({message:"撞到了！",grouping:!0}),!0}}cameraLookatMoveTo(e){this.controls&&we.cameraLookatAnimate(this.camera,e,this.controls.target)}judgeCruise(){return!!this.options.cruise.runing&&(h.warning({message:"请退出巡航！",grouping:!0}),!0)}addModelAnimate(e,t=[],i=!0,o=1){if(!t.length)return;const s=new v(e),n=t.reduce(((e,t)=>{const n=t.name||"";return e[n]=s.clipAction(t),i&&e[n].play(),e[n].timeScale=o,e}),{});e.__action__=n,e.__mixer__=s,this.animateModels.push(e)}cameraTransition(e){var t;if(this.judgeCruise())return;if(this.mouseClickDiffusion.visible)return void h.warning({message:"人物移动中，不可操作！",grouping:!0});this.judgeAndStopRoam(),this.isPerspectives()&&this.toggleSight();const{to:i,target:o=e.position}=e.data;if(!i)return;!this.isCameraMove(i)&&this.controls&&(this.judgeAndStopRoam(),this.controls.maxDistance=5,we.cameraLinkageControlsAnimate(this.controls,this.camera,i,o));const{bind:s}=e.data;if(!s)return;const n=null==(t=this.buildingGroup)?void 0:t.getObjectByName(s);this.addFence(n)}addFence(e){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),e){const t=Fe(e,5439406);this.fence=t,this.addObject(t)}}controlReset(){this.judgeAndStopRoam(),this.controls&&(this.controls.maxDistance=1500,super.controlReset())}judgeAndStopRoam(){return!!it()&&(this.controls&&(this.controls.maxDistance=1500),et(),!0)}toggleRoam(){if(this.judgeAndStopRoam())return;const e=this.extend.roamPoints||[];0!=e.length&&this.controls&&(this.controls.maxDistance=20,Qe({points:e,segment:6,tension:.2,speed:4,close:!1}),tt())}modelAnimate(){var e,t,i;this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let o=null==(e=this.clock)?void 0:e.getDelta();if(this.animateModels.length&&this.animateModels.forEach((e=>{e.__mixer__&&e.__mixer__.update(o)})),null==(t=this.anchorGroup)||t.children.forEach((e=>{e.__mixer__&&e.__mixer__.update(o)})),this.character){this.character.extra.mixer.update(o),Be(.2*this.moveFactor)}if(this.mouseClickDiffusion.visible&&ze(),We(),this.isPerspectives()&&!(null==(i=this.character)?void 0:i.__runing__)){const e=5*o,t=.2*Math.PI*o,i=this.character;if(!i)return;const s=Ve("S");if(Ve("W")||s){const t=new m;null==i||i.getWorldDirection(t);const o=t.clone().multiplyScalar(s?-e:e),n=(null==i?void 0:i.position.clone().add(o))||new m;this.checkCharacterCollide(n)||(null==i||i.position.copy(n),this.setControlTarget(null==i?void 0:i.position))}Ve("A")?(i.rotation.y+=t,this.keyboardToTotation()):Ve("D")&&(i.rotation.y-=t,this.keyboardToTotation())}Xe(this.camera,this.controls),lt&&(lt.offset.x+=.02)}keyboardToTotation(){var e;const t=this.character,i=new m;null==t||t.getWorldDirection(i);const o=(null==(e=this.controls)?void 0:e.maxDistance)||1,s=i.clone().multiplyScalar(-o),n=(null==t?void 0:t.position.clone().setY(this.camera.position.y).add(s))||new m;this.camera.position.copy(n),this.setControlTarget(null==t?void 0:t.position)}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const i=e.timeStamp-this.pointer.tsp<Me;2==e.button?i&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?i&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,i,o,s,n;const a=this.container,r=this.options.scale;De(e,a,r);let l="pointerdown"==e.type||"pointerup"==e.type;const c=(null==(i=this.buildingGroup)?void 0:i.children.filter((e=>e.visible&&(l||e.__ground__))).concat((null==(t=this.anchorGroup)?void 0:t.children)||[]))||[];Le.setFromCamera(Ie,this.camera);let d=Le.intersectObjects(c,l);if(l)if(a.style.cursor="auto",d.length){const e=d[0],t=e.object,i="string"==typeof t.name&&(this.extend.groundMeshName||[]).some((e=>t.name.indexOf(e)>-1)),n=this.findParentGroup(t);if(i&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickGround)&&this.extend.onClickGround(n,e),!n)return;"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft(n,e)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(d)}hoverAnchor(e){var t,i;if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(e[0],Pe),e.length){const i=e[0].object;if(this.container.style.cursor=i._isAnchor_?"pointer":"auto",!i._isAnchor_)return;const o=i.material;void 0===i.__mat_color__&&(i.__mat_color__=o.color),o.color=new S(16715760),null==(t=this.anchorGroup)||t.children.forEach((e=>{e.__change_color__=e.uuid===i.uuid}))}else this.container.style.cursor="auto",null==(i=this.anchorGroup)||i.children.forEach((e=>{e.__change_color__=!1}))}restoreAnchorMaterial(){var e;null==(e=this.anchorGroup)||e.traverse((e=>{e.isSprite&&!e.__change_color__&&e.__mat_color__&&(e.material.color=e.__mat_color__)}))}findParentGroup(e){const t=e=>{if(e._isBuilding_)return e;let i=e.parent;return i?i&&i._isBuilding_?i:t(i):void 0};return t(e)}getAll(){var e,t;return(null==(t=this.buildingGroup)?void 0:t.children.concat((null==(e=this.dotGroup)?void 0:e.children)||[]))||[]}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}dispose(){$e(),this.animateModels=[],this.clearVideo(),this.videoModels=[],this.canvasTextures=[],this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.fence),this.disposeObj(this.lightGroup),this.disposeObj(this.mouseClickDiffusion),this.clock=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.character=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.lightGroup=void 0,this.fence=void 0,this.mouseClickDiffusion=void 0,this.extend={},super.dispose()}}const dt=(e,t)=>{const i=40*Math.random();return void 0!==i&&(e.value=i),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:"#"+(16777215+1e6*i).toString(16).substring(0,6)}}},ht={class:"scene-operation"},ut=["onClick"],pt=["innerHTML"],mt="welcom.key",gt=Y(i({__name:"index",setup(e){const t=Q,i=Z,o=k((s=(e,t,i,o)=>{if(!ie)return;(o+=.02)>1&&(o-=1),e=((e,t=0)=>new m(e.x,e.y+t,e.z))(i.getPointAt(o));let s=o+.001;s>1&&(s-=1),t=i.getPointAt(s),ie.position.set(e.x,ke,e.z);const n=Math.atan2(-t.z+e.z,t.x-e.x);ie.rotation.z=.5*Math.PI+n},{devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr",config:{},dotKey:"DOT",dotShowStrict:!1,anchorType:[le,ce,ge,_e,ve,fe,ye,Re,Ee,Ce,Ae,be,Se],animationModelType:[he,ue],models:[{key:de,name:"场景",size:18.6,url:"/公司总部.glb"},{key:"floor_low",name:"低层",size:10.7,url:"/低层.glb"},{key:ue,name:"窗帘",size:.2,url:"/窗帘.glb"},{key:"floor_heigh",name:"高层",size:8.3,url:"/高层.glb"},{key:he,name:"公司",size:41,url:"/二十五楼.glb"},{key:le,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/pos.png"},{key:ce,name:"锚点",type:"sprite",mapUrl:"/dw.png"},{key:ge,name:"电梯门",type:"sprite",mapUrl:"/lift.png"},{key:Ce,name:"双横推开关门",type:"sprite",mapUrl:"/lift.png"},{key:be,name:"双旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:Ae,name:"单旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:ye,name:"闸机",type:"sprite",mapUrl:"/gate.png"},{key:Re,name:"视频",type:"sprite",mapUrl:"/video.png"},{key:Ee,name:"编辑",type:"sprite",mapUrl:"/edit.png"},{key:Se,name:"窗帘",type:"sprite",mapUrl:"/curtain.png"},{key:pe,name:"机器人",size:.3,url:"/oss/model/park/机器人.glb"},{key:me,name:"人物",size:2.2,url:"/oss/model/park/RobotExpressive.glb"},{key:"spot_light_floor_1",type:"spotlight",name:"聚光灯",intensity:8,color:6476450,distance:20},{key:"spot_light_floor_2",type:"spotlight",name:"聚光灯",intensity:8,color:57599,distance:10},{key:_e,name:"开关灯",type:"sprite",mapUrl:"/light.png"},{key:ve,name:"开关灯",type:"sprite",mapUrl:"/light.png"},{key:fe,name:"空调",type:"sprite",mapUrl:"/air.png"}].map((e=>(e.url&&e.url.indexOf("oss")<0&&(e.url="/oss/model/office"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/office"+e.mapUrl),e))),cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line18.png",repeat:[1,1],width:2,segment:100,tension:.01,speed:10,mapSpeed:.1,points:xe,close:!0,offset:5.2,animateBack:s},roamPoints:[[1.7,-1.4,51.3],[80.5,72.6,75],[87,160,-72.4],[13.2,186,-72.4],[13.2,186,-61.3],[52,186,-28.2],[52,186,42.7],[-36.4,186,40],[-38.2,186,-26.8]]}));var s;const h=k({active:1,show:!1,targetName:"",list:[{target:"电梯-2",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-2_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_2_grp"}]},{target:"电梯-1",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-1_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_1_grp"}]}]}),u=k({show:!1,style:{left:0,top:0},msg:""}),{changeBackground:p,backgroundLoad:g}=i.useBackground(),{progress:_,loadModels:v,getModel:f}=i.useModelLoader({baseUrl:o.baseUrl,indexDB:{cache:!0,dbName:"THREE__OFFICE__DB",tbName:"TB",version:59}}),y=O(),C=O(),b={env:o.env,cruise:o.cruise,controls:{visible:!0,enableDamping:!0,dampingFactor:.48,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:1500},camera:{near:3},directionalLight:{},axes:{visible:!0,size:1e3}};let A;const R=T((()=>{var e;return(null==(e=h.list.find((e=>e.target===h.targetName)))?void 0:e.items)||[]})),{options:E}=(e=>{const t=k({show:!1,...e});return{options:t,show:x(t.show),filters:k({})}})({title:"编辑欢迎词",content:$(mt)||"",errMessage:"请输入欢迎词！"}),S=e=>{var t;const i=e.data;{const e=dt(i,A.buildingGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{i[t]=e[t]}))}e.visible=i.show||!o.dotShowStrict;const s=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(s){const{size:e,color:t}=i.font||{};null!=e&&(s.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(s.style.color=t),s.textContent=`${i.value||0}${i.unit}`}},F=async e=>{if(!e)return;const{type:i}=e;if(i===le)return;const s=f(i);if(!s)return void(i===o.dotKey&&(e=>{S(A.addDot(e,(t=>{A.cameraLookatMoveTo(e.position)})))})(e));const{anchorType:n=[],animationModelType:a=[]}=o;let r=t.modelDeepClone(s);const{position:l,scale:c,rotation:d}=t.get_P_S_R_param(r,e),[h,u,p]=l;return r.scale.set(...c),r.position.set(h,u,p),r.rotation.set(...d),r._isBuilding_=!0,r.data=e,a.includes(i)&&A.addModelAnimate(r,s.animations,i!==ue,1),n.includes(i)?(r._isAnchor_=!0,A.addAnchor(r)):r.isSpotLight?A.addLight(e,r,!0):A.addBuilding(r),Promise.resolve()},Y=async()=>{_.percentage=100,_.show=!1,A.clearBuilding(),await B(),await(()=>{let e=0,t=q.value.length;return new Promise((i=>{if(0==t)return i(null);const o=async()=>{const s=q.value[e];await F(s),e++,e<t?o():i(e)};o()}))})(),A.setCruisePoint(o.cruise.points);const e=A.getValidTargetPosition(o.config||{});t.cameraInSceneAnimate(A.camera,e,A.controls.target).then((()=>{A.controlSave(),setTimeout((()=>{Te.emit("LIGHT:CLOSE")}),100)}))},q=O([]),ee=T((()=>q.value.filter((e=>e.type===le)))),te=()=>{v(o.models,(()=>{W.get(V.d3.office).then((async e=>{let t={};if(e.ConfigJson instanceof Object)t=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{t=JSON.parse(e.ConfigJson)}catch(i){}q.value=e.JsonList,Object.keys(t).forEach((e=>{o.config&&(o.config[e]=t[e])})),await Y(),oe(),se(),Te.emit("SCREEN:WELCOM",E.content),A.addVideoMaterial(e.JsonList.filter((e=>e.type===Re)).map((e=>e.bind))),A.addCanvasMaterial(e.JsonList.filter((e=>e.type===Ee)).map((e=>e.bind))),A.addAirWindMaterial(e.JsonList.filter((e=>e.type===fe)).map((e=>e.bind)))}))}))};let ie;const oe=()=>{ie=f(pe),ie.position.z=ke,ie.rotation.z=.5*Math.PI,A.addObject(ie)},se=()=>{const e=f(me);e.traverse((e=>{e.isMesh&&(e.castShadow=!0)}));e.scale.setScalar(.75);const t=e.getObjectByName("HandL"),i=e.getObjectByName("HandR");t.visible=!1,i.visible=!1,A.addCharacter(e,{x:18.6,y:184.6,z:37.6})},ne=()=>{te(),g(A,o.skyCode),(e=>{Te.on("CAMERA:ROAM",(()=>null==e?void 0:e.toggleRoam())),Te.on("CAMERA:CRUISE",(()=>null==e?void 0:e.toggleCruise())),Te.on("CAMERA:RESET",(()=>null==e?void 0:e.controlReset())),Te.on("CAMERA:FIRST",(()=>null==e?void 0:e.toggleSight(1))),Te.on("CAMERA:THREE",(()=>null==e?void 0:e.toggleSight(3))),Te.on("CAMERA:GATE",(()=>{null==e||e.cameraTransition({data:{name:"一楼大门",type:"ANCHOR_POS",to:{x:-1.3,y:6.2,z:102.3},target:{x:-1.4,y:5.8,z:97.4}}})})),Te.on("CAMERA:RECCEPTION",(()=>{null==e||e.cameraTransition({data:{name:"公司前台",type:"ANCHOR_POS",to:{x:15.3,y:188,z:33.2},target:{x:15.3,y:188,z:36.3}}})})),Te.on("CAMERA:OFFICE",(()=>{null==e||e.cameraTransition({data:{name:"办公区域",type:"ANCHOR_POS",to:{x:-38,y:188,z:35.3},target:{x:-35.4,y:188,z:36.4}}})})),Te.on("CAMERA:LCR",(()=>{null==e||e.cameraTransition({data:{name:"大会议室",type:"ANCHOR_POS",to:{x:-28.8,y:188,z:52.7},target:{x:-33.7,y:188,z:53.4}}})})),Te.on("CAMERA:BOSS",(()=>{null==e||e.cameraTransition({data:{name:"领导办公",type:"ANCHOR_POS",to:{x:69.4,y:188,z:-.4},target:{x:65,y:188,z:-2.7}}})})),Te.on("PERSON:ADD",(()=>null==e?void 0:e.characterAccelerate())),Te.on("PERSON:SUB",(()=>null==e?void 0:e.characterAccelerate(-1))),Te.on("LIGHT:RECCEPTION",((t,i)=>{null==e||e.lightSwitch({data:{bind:"前台聚光灯"}},t,i)})),Te.on("LIGHT:AILSE",((t,i)=>{null==e||e.lightSwitch({data:{bind:"区域A"}},t,i)})),Te.on("LIGHT:PM",((t,i)=>{null==e||e.lightSwitch({data:{bind:"区域B"}},t,i)})),Te.on("LIGHT:HOST",((t,i)=>{null==e||e.lightSwitch({data:{bind:"主机照明灯"}},t,i)})),Te.on("LIGHT:LCR",((t,i)=>{null==e||e.lightSwitch({data:{bind:"大会议室照明灯"}},t,i)})),Te.on("LIGHT:CLOSE",(t=>null==e?void 0:e.closeLightGroup(t))),Te.on("LIGHT:AUTO",((t,i,o)=>null==e?void 0:e.lightSwitch(t,i,o))),Te.on("CURTAIN:TOGGLE",(()=>{null==e||e.toggleCurtain({data:{bind:"_GROUP_013_grp"}})})),Te.on("DOOR:COMPANY",(()=>{null==e||e.dubleHorizontalDoor({data:{bind:"_公司大门_grp",axle:"x"}},5.4)})),Te.on("DOOR:LCR",(()=>{null==e||e.dubleRotateDoor({data:{bind:"_大会议室-门_grp",axle:"y"}})})),Te.on("DOOR:BOSS",(()=>{null==e||e.dubleRotateDoor({data:{bind:"_老板办公室-门_grp",autoClose:0}})})),Te.on("SCREEN:COMPANY",(()=>{null==e||e.videoPlay({data:{bind:"公司大屏"}})})),Te.on("SCREEN:WELCOM",(t=>null==e?void 0:e.drawCanvas(t))),Te.on("SCREEN:SCR",(()=>{null==e||e.videoPlay({data:{bind:"小会议室大屏"}})})),Te.on("SCREEN:LCR",(()=>{null==e||e.videoPlay({data:{bind:"大会议电视屏幕"}})})),Te.on("AIR:MAIN",(t=>{null==e||e.toggleAir({data:{bind:"_空调风_grp"}},t)})),Te.on("SCENE:POS",(()=>null==e?void 0:e.getPosition()))})(A)},ae=e=>{E.content=e,J(mt,E.content||""),Te.emit("SCREEN:WELCOM",E.content)},Oe=e=>{const t=e.data;switch(null==t?void 0:t.type){case le:A.cameraTransition(e);break;case ge:h.targetName=e.data.target,A.waitLift(e);break;case _e:Te.emit("LIGHT:AUTO",e);break;case ve:e.__close__=!e.__close__,Te.emit("LIGHT:CLOSE",!e.__close__);break;case ye:A.openGate(e);break;case Ce:A.dubleHorizontalDoor(e,5.4);break;case Ae:A.oddRotateDoor(e);break;case be:A.dubleRotateDoor(e);break;case Se:A.toggleCurtain(e);break;case Re:A.videoPlay(e);break;case Ee:E.show=!0;break;case fe:A.toggleAir(e)}};return M((()=>{b.container=y.value;const e=["电梯地板002","电梯地板"];A=new ct(b,{canvas:C.value,groundMeshName:["地面002","立方体306","平面118","立方体475","立方体514","立方体552","地面020","地面","平面391","立方体474","立方体1617","ground",...e],roamPoints:o.roamPoints,onClickLeft:(e,t)=>{e&&e.data&&Oe(e)},onClickGround:(t,i)=>{A.mouseClickGround(i,e).then((t=>{h.show=e.includes(i.object.name)})).catch((()=>{}))},onHoverAnchor:(e,t)=>{const i=!!e&&e.object._isAnchor_;if(u.show=i,i){u.style.top=t.top,u.style.left=t.left;const i=e.object.data;u.msg=`\n          <p>${i.name}</p>\n          <p>类型：${i.type}</p>\n          <p>绑定：${i.bind||"无"}</p>\n        `}}}),A.run(),X(A).resize(),ne()})),(e,t)=>{const i=U;return n(),a("div",{class:I(e.$style.page)},[r("div",ht,[r("div",{class:"btn",onClick:t[0]||(t[0]=()=>{A.getAll().forEach(((e,t)=>{e.data&&(e.data.type!==o.dotKey||S(e))}))})},"随机更新"),r("div",{class:"btn",onClick:t[1]||(t[1]=()=>G(Te).emit("SCENE:POS"))},"场景坐标"),r("div",{class:"btn",onClick:t[2]||(t[2]=()=>G(p)(G(A)))},"切换背景"),r("div",{class:"item",onClick:t[3]||(t[3]=()=>G(Te).emit("CAMERA:ROAM"))},"全景漫游"),(n(!0),a(w,null,L(G(ee),(e=>(n(),a("div",{class:"item",onClick:t=>(e=>{A.cameraTransition({position:e.position,data:e})})(e)},l(e.name),9,ut)))),256)),r("div",{class:"item",onClick:t[4]||(t[4]=()=>G(Te).emit("CAMERA:CRUISE"))},"定点巡航"),r("div",{class:"item",onClick:t[5]||(t[5]=()=>G(Te).emit("CAMERA:RESET"))},"视角重置"),r("div",{class:"item",onClick:t[6]||(t[6]=()=>G(Te).emit("AIR:MAIN",!0))},"空调开"),r("div",{class:"item",onClick:t[7]||(t[7]=()=>G(Te).emit("AIR:MAIN",!1))},"空调关"),r("div",{class:"item",onClick:t[8]||(t[8]=()=>G(Te).emit("AIR:MAIN"))},"空调开关"),r("div",{class:"item",onClick:t[9]||(t[9]=()=>G(Te).emit("LIGHT:RECCEPTION",!0))},"前台灯开"),r("div",{class:"item",onClick:t[10]||(t[10]=()=>G(Te).emit("LIGHT:RECCEPTION",!1))},"前台灯关"),r("div",{class:"item",onClick:t[11]||(t[11]=()=>G(Te).emit("LIGHT:LCR",null,Math.floor(5*Math.random())))}," 大会议室灯 "),r("div",{class:"item",onClick:t[12]||(t[12]=()=>G(Te).emit("CAMERA:FIRST"))},"第一人称"),r("div",{class:"item",onClick:t[13]||(t[13]=()=>G(Te).emit("CAMERA:THREE"))},"第三人称"),r("div",{class:"item",onClick:t[14]||(t[14]=()=>G(Te).emit("PERSON:ADD"))},"人物加速"),r("div",{class:"item",onClick:t[15]||(t[15]=()=>G(Te).emit("PERSON:SUB"))},"人物减速")]),r("div",{class:I(e.$style.container),ref_key:"containerRef",ref:y},null,2),r("canvas",{class:I(e.$style["canvas-texture"]),ref_key:"canvasTextureRef",ref:C},null,2),c(K,{modelValue:G(_).show,"onUpdate:modelValue":t[16]||(t[16]=e=>G(_).show=e),progress:G(_).percentage},null,8,["modelValue","progress"]),D(r("div",{class:I(e.$style["floor-select"])},[(n(!0),a(w,null,L(G(R),(e=>(n(),N(i,{type:"primary",disabled:G(h).active===e.key,onClick:t=>(e=>{h.active=e.key;const t=e.bind;A.waitLift({data:{bind:t,to:{y:e.y},target:h.targetName}},!0)})(e)},{default:j((()=>[H(l(e.name),1)])),_:2},1032,["disabled","onClick"])))),256))],2),[[P,G(h).show]]),G(u).show?(n(),a("div",{key:0,class:I(e.$style.tip),style:z({left:G(u).style.left+"px",top:G(u).style.top+"px"})},[r("div",{class:I(e.$style.msg),innerHTML:G(u).msg},null,10,pt)],6)):d("",!0),c(re,{modelValue:G(E).show,"onUpdate:modelValue":t[17]||(t[17]=e=>G(E).show=e),title:G(E).title,content:G(E).content,"onUpdate:content":t[18]||(t[18]=e=>G(E).content=e),"err-message":G(E).errMessage,onConfirm:ae},null,8,["modelValue","title","content","err-message"])],2)}}}),[["__cssModules",{$style:{page:"_page_1m1de_2",container:"_container_1m1de_10","floor-select":"_floor-select_1m1de_14",tip:"_tip_1m1de_20",msg:"_msg_1m1de_30","canvas-texture":"_canvas-texture_1m1de_38"}}]]);export{gt as default};
