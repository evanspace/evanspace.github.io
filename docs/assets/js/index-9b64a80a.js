import{u as e,a as t,t as o,g as i,s as n,c as s,b as a,d as l,e as r,f as c,h as d,i as u,j as p}from"./model-loader-d2b6f26d.js";import{bH as h,bO as f,e as m,i as g,w as v,l as y,aP as b,o as C,g as k,h as x,u as D,B as G,n as j,q as _,a9 as w,a5 as O,aa as P,cg as M}from"./vendor-8986b6ad.js";import{T as E,d as T}from"./scene-resize-6ab2e993.js";import{u as B,D as S,a as U}from"./background-954024da.js";import{u as A}from"./dialog-4756f779.js";import{_ as L}from"./index-c2ca0eee.js";const{raycaster:z,pointer:K,update:N}=B(),{initCSS2DRender:F,createCSS2DDom:R}=e();class $ extends E{constructor(e,t){super(e),this.findFilterDevice=(e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let i=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{i.includes(e)||i.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!i.includes(o)&&i.push(o),!!o})).length==e.length&&(o=o.concat(i))}else{const i=t.find((t=>t.deviceCode==e));i&&o.push(i)}})),o},this.extend=t,this.css2DRender=F(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.clock=new h,this.addDeviceGroup(),this.addDotGroup(),this.addPipeGroup(),this.bindEvent()}addDeviceGroup(){const e=new f;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot(),this.clearPipe()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const e=new f;e.name="点位组",this.scene.add(e),this.dotGroup=e}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){const o=e.position,{size:i,color:n}=e.font||{},{x:s=0,y:a=0,z:l=0}=o||{},r=R({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=i?`font-size: ${"string"==typeof i?i:i+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[s,a,l],onClick:t});return r.name=e.name,r.data=e,this.dotGroup.add(r),r}addPipeGroup(){const e=new f;e.name="管路组",this.scene.add(e),this.pipeGroup=e}addPipe(...e){this.pipeGroup&&this.pipeGroup.add(...e)}clearPipe(){this.pipeGroup&&this.disposeObj(this.pipeGroup),this.addPipeGroup()}onDblclick(e){var t;const o=this.container,i=this.options.scale;if(N(e,o,i),this.deviceGroup){z.setFromCamera(K,this.camera);const e=[this.deviceGroup,this.pipeGroup],o=z.intersectObjects(e);if(o.length){const e=o[0].object,i=this.findParentGroupGroup(e);if(!i)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(i)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<S.rightClickBackDiffTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o;const i=this.container,n=this.options.scale;N(e,i,n);let s="pointerdown"==e.type||"pointerup"==e.type;const a=this.deviceGroup.children.filter((e=>e.visible&&e._isAnchor_));z.setFromCamera(K,this.camera);let l=z.intersectObjects(a,s);if(i.style.cursor=l.length>0?"pointer":"auto",s)if(l.length){const e=l[0].object;if(!e)return;"function"==typeof(null==(t=this.extend)?void 0:t.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&(o._isDevice_||o._isPipe_)?o:t(o)};return t(e)}modelAnimate(){if(this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.deviceGroup.children.length){let e=this.clock.getDelta();this.deviceGroup.children.forEach((t=>{let o=t.data;if(!o)return;let i=t.extra;i&&((null==o?void 0:o.status)??0)>0&&i.mixer.update(e);const n=t[S.meshKey.warning];n&&((null==o?void 0:o.error)||0)>0&&n.mixer.update(e)}))}this.pipeGroup.children.length&&this.pipeGroup.children.forEach((e=>{const t=e[S.meshKey.pipe];if(t){const o=e.data,i=o.bind||[],n=this.deviceGroup.children.filter((e=>{var t;return e.data&&e.data.deviceCode&&((null==(t=e.data)?void 0:t.status)??0)>0})).map((e=>e.data)),s=this.findFilterDevice(i,n),a=s.length>0;let l=.01;if(o.left&&o.right){const{left:e,right:t}=o,i=this.findFilterDevice(t,s).length>0,n=this.findFilterDevice(e,s).length>0;l=n&&i?0:i?-.01:.01}t.forEach((e=>{a&&(e.material.map.offset.y-=l),e.material.opacity=a?.3:0}))}}))}getAnimTargetPos(e,t,o){const i=t||e.to||{x:-104,y:7,z:58},n=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(n.x,n.y,n.z),i}getAll(){return this.deviceGroup.children.concat(this.dotGroup.children)}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}}const I={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},V={class:"scene-operation"},q=L(m({__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoPath:{},basisPath:{},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},ambientLight:{},directionalLight:{default:()=>({})},models:{},config:{},objects:{},pipes:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},statusOffset:{},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{default:()=>["FM"]},animationModelType:{},textModelType:{},anchorType:{default:()=>[]},textChangeColor:{type:Boolean},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},mainBodyExcludeType:{default:()=>["FM"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:h,emit:m}){const E=e,B=m,L=T(I,E.colors),{changeBackground:z,backgroundLoad:K}=U(),{progress:N,MODEL_MAP:F,loadModel:R,loadModels:q,getModel:H}=t({baseUrl:E.baseUrl,dracoPath:E.dracoPath,basisPath:E.basisPath,colors:L,colorMeshName:E.colorMeshName,indexDB:E.indexDB}),{dialog:W}=A(),X=g(),J={baseUrl:E.baseUrl,bgUrl:E.bgUrl,env:E.env,bgColor:E.bgColor,camera:E.camera,cruise:E.cruise,fog:E.fog,render:E.render,grid:E.grid,controls:E.controls,axes:E.axes,ambientLight:E.ambientLight,directionalLight:E.directionalLight};let Q;v((()=>E.dotShowStrict),(()=>Y())),v((()=>E.scale),(e=>{null==Q||Q.setScale(e||1)})),v((()=>E.cruise.points),(e=>{N.isEnd&&Q.setCruisePoint(e)})),v((()=>E.objects),(()=>{N.isEnd&&oe()}));const Y=()=>{const e=Q.dotGroup.children;for(let t=0;t<e.length;t++){const o=e[t];if(!o.data)continue;o.data.type===E.dotKey&&Z(o)}},Z=e=>{var t;const o=e.data;if("function"==typeof E.dotUpdateObjectCall){const e=E.dotUpdateObjectCall(o,Q.deviceGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}e.visible=o.show||!E.dotShowStrict;const i=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(i){const{size:e,color:t}=o.font||{};null!=e&&(i.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(i.style.color=t),i.textContent=`${o.value||0}${o.unit}`}},ee=async e=>{var t;if(!e)return;const{type:o,url:i}=e,s=H(o);if(!s)return void(i?await(async e=>{const{type:t,url:o="",name:i}=e,n=await R({key:t,url:o,name:i,size:0}),{position:s,scale:a,rotation:l}=r(n,e);return n.scale.set(...a),n.position.set(...s),n.rotation.set(...l),n._isBase_=!0,Q.addDevice(n),Promise.resolve(n)})(e):o===E.dotKey&&(e=>{Z(Q.addDot(e,(t=>{B("click-dot",b(e),t)})))})(e));const h=E.anchorType||[];let m=l(s);const{position:g,scale:v,rotation:y}=r(m,e),[C,k,x]=g;m.scale.set(...v);const D=E.animationModelType||[],G=E.colorMeshName||[],j=E.mainBodyExcludeType||[],_=E.textModelType||[],w=H(F.font);if(_.includes(o)&&w){const o=new f;o.add(m);const i=d(e,w,L.normal.text,null==(t=E.statusOffset)?void 0:t.TEXT);o.add(i),o.name=e.name,m=o}if(D.includes(o)){if("Group"!==m.type){const e=new f;e.add(m),e.name=m.name,m=e}if(((e,t)=>{var o,i,n;const s=H(F.warning);if(s){const i=S.meshKey.warning,{group:n,action:a,mixer:l}=u(i,t,s,null==(o=E.statusOffset)?void 0:o.WARNING);e.add(n),e[i]={action:a,mixer:l}}const a=H(F.local);if(a){const o=S.meshKey.local,n=p(t,a,null==(i=E.statusOffset)?void 0:i.STATUS);e.add(n),e[o]=n}const l=H(F.disabled);if(l){const o=S.meshKey.disabled,i=p(t,l,null==(n=E.statusOffset)?void 0:n.DISABLED,!0);e.add(i),e[o]=i}})(m,e),E.mainBodyChangeColor&&!j.includes(o)){const e=c(m.children,E.mainBodyMeshName),t=L.normal;let o=null!=t.main?t.main:t.color,i=a(o);i.length&&e.forEach(((e,t)=>{n(e,i[t%i.length])})),m[S.meshKey.body]=e}const t=c(m.children,G);let i,l=new M(m);s.animations.length&&(i=l.clipAction(s.animations[0]),i.paused=!0,i.timeScale=1.5,i.play()),m.extra={action:i,mixer:l,meshs:t}}else{const e=[];m.traverse((t=>{"string"==typeof t.name&&G.some((e=>t.name.indexOf(e)>-1))&&e.push(t)})),e.length&&(m[S.meshKey.color]=e)}return m.position.set(C,k,x),m.rotation.set(...y),m._isDevice_=!0,m.data=e,h.includes(o)&&(m._isAnchor_=!0),Q.addDevice(m),Promise.resolve()},te=g([]),oe=async()=>{var e,t;N.percentage=100,N.show=!1,Q.clearDevice(),await P(),(()=>{te.value.length=0;const e=b(E.objects)||[];if("function"!=typeof E.formatObject)te.value=e;else{const t=E.formatObject(e);te.value=t}})(),await(()=>{let e=0,t=te.value.length;return new Promise((o=>{if(0==t)return o(null);const i=async()=>{const n=te.value[e];await ee(n),e++,e<t?i():o(e)};i()}))})(),(()=>{if(!E.pipes||0==E.pipes.length)return;const e=E.pipes;for(let t=0;t<e.length;t++){const o=e[t],{type:i,map:n}=o,s=H(i);if(!s)continue;let a=l(s);const d=s._mapMeshName_,{position:u,scale:p,rotation:h}=r(a,o),[f,m,g]=u,v=c(a.children,[d]);v.length&&(v.forEach((e=>{if(e.material.map=e.material.map.clone(),n){const t=e.material.map.repeat;e.material.map.repeat.set(t.x*(n[0]??1),t.y*(n[1]??1))}})),a[S.meshKey.pipe]=v),a.scale.set(...p),a.position.set(f,m,g),a.rotation.set(...h),a._isPipe_=!0,a.data=o,Q.addPipe(a)}})(),Q.setCruisePoint(E.cruise.points),"function"==typeof(null==(e=E.config)?void 0:e.load)&&(null==(t=E.config)||t.load(Q));const o=Q.getAnimTargetPos(E.config||{});s(Q.camera,o,Q.controls.target).then((()=>{B("loaded"),Q.controlSave()}))},ie=()=>{q(E.models,(()=>{oe()})),E.skyCode&&K(Q,E.skyCode)},ne=e=>{const t=X.value,o=i(t,e,Q.camera);return W.position=o,W.style.left=o.left+"px",W.style.top=o.top+"px",o},se=e=>{const t=[];E.updateObjectCall,Q.getAll().forEach(((o,i)=>{if(!o.data)return;const n=o.data;let s=n.type;if(s===E.dotKey)return void Z(o);if("function"==typeof E.updateObjectCall){const t=E.updateObjectCall(n,e);if(!t)return;Object.keys(t).forEach((e=>{n[e]=t[e]}))}t.push(b(n));let{status:a=0,error:l=0,remote:r=0,local:c=0,disabled:d=0}=n;const u=L[l>0?"error":a>0?"runing":"normal"];let p=null!=u[s]?u[s]:u.color;if("function"==typeof E.getColorCall){const e=E.getColorCall(n);e&&(p=e)}ae({type:s,el:o,colorObj:u,color:p,paused:0==a,error:l>0,remote:r>0,local:c>0,disabled:d>0})})),B("update",t,e)},ae=e=>{let{el:t,type:o,colorObj:i,color:s,paused:l,error:r}=e,c=a(s);s=c[0];const d=S.meshKey;if(E.colorModelType.includes(o)&&null!=s){return void(t[d.color]||[]).forEach((e=>{n(e,s)}))}if(!(E.animationModelType||[]).includes(o))return;if(E.textChangeColor){const e=null!=i.text?i.text:i.color,o=t.getObjectByProperty("_isText_",!0);let s=a(e);n(o,s[0])}const u=t.extra;if(u&&(u.action&&(u.action.paused=l),null!=s)){(u.meshs||[]).forEach((e=>{n(e,s)}))}if(E.mainBodyChangeColor&&t[d.body]){const e=null!=i.main?i.main:i.color;let o=a(e);o.length&&t[d.body].forEach(((e,t)=>{n(e,o[t%o.length])}))}const p=t[d.warning];if(p){const e=t.children.find((e=>e.name==d.warning));e&&(e.visible=r,p.action.paused=!r)}t[d.local]&&(t[d.local].visible=e.local),t[d.disabled]&&(t[d.disabled].visible=e.disabled)};return y((()=>{J.container=X.value,Q=new $(J,{onDblclick(e){const t=e.data;"function"==typeof t.onDblclick?t.onDblclick(b(t),e):B("dblclick",b(t))},onClickLeft(e){if(e){const t=e.data,o=b(t);B("select",o),"function"==typeof t.onClick?(W.show=!1,t.onClick(o)):(W.select=[e],(()=>{const e=W.select[0],t=e.data;W.data=t,W.title=(null==t?void 0:t.name)||"",W.show=!0;const o=ne(e);B("click-dialog-dot",t,o)})())}else W.select=[],W.show=!1},onClickRight(e){var t;"function"==typeof(null==(t=E.config)?void 0:t.back)&&E.config.back(Q)},animateCall:()=>{if(W.show&&W.select.length){const e=W.select[0];ne(e)}}}),Q.run(),B("init",Q),ie()})),h({update:se,exportImage:()=>null==Q?void 0:Q.exportImage()}),(e,t)=>(C(),k("div",{class:j(e.$style["device-scene"])},[x("div",V,[x("div",{class:"btn",onClick:t[0]||(t[0]=()=>se(!0))},"随机更新"),e.cruise.visible?(C(),k("div",{key:0,class:"btn",onClick:t[1]||(t[1]=()=>{var e;return null==(e=D(Q))?void 0:e.toggleCruise()})},"定点巡航")):G("",!0),x("div",{class:"btn",onClick:t[2]||(t[2]=()=>{var e;return null==(e=D(Q))?void 0:e.getPosition()})},"场景坐标"),x("div",{class:"btn",onClick:t[3]||(t[3]=()=>D(z)(D(Q)))},"切换背景"),x("div",{class:"btn",onClick:t[4]||(t[4]=()=>{var e;return null==(e=D(Q))?void 0:e.controlReset()})},"控制器重置"),e.cruise.visible?(C(),k("div",{key:1,class:"btn",onClick:t[5]||(t[5]=()=>{var e;return null==(e=D(Q))?void 0:e.toggleCruiseDepthTest()})},"巡航深度")):G("",!0)]),x("div",{class:j(e.$style.container),ref_key:"containerRef",ref:X},null,2),_(o,{modelValue:D(N).show,"onUpdate:modelValue":t[6]||(t[6]=e=>D(N).show=e),progress:D(N).percentage},null,8,["modelValue","progress"]),D(W).show?(C(),k("div",{key:0,class:j(e.$style.dialog),style:w(D(W).style)},[O(e.$slots,"dialog",{data:D(W).data,title:D(W).title,position:D(W).position})],6)):G("",!0)],2))}}),[["__cssModules",{$style:{"device-scene":"_device-scene_1k662_2",container:"_container_1k662_8",dialog:"_dialog_1k662_12"}}]]);export{q as t};
