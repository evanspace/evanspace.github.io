var e=Object.defineProperty,t=(t,o,i)=>(((t,o,i)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i})(t,"symbol"!=typeof o?o+"":o,i),i);import{t as o}from"./index-6202cc31.js";import{E as i,w as n,i as s}from"./scene-resize-5cdbd2b0.js";import{bi as a,e as l,i as r,w as c,l as d,aP as p,o as u,g as h,h as f,u as m,B as v,n as g,q as y,a9 as b,a5 as C,aa as _,bj as k}from"./vendor-317257ae.js";import{u as x}from"./sky-df762585.js";import{_ as G}from"./index-88d3e5b6.js";const D=300,j={body:"__BODY_",color:"__COLOR_",warning:"__WARNING_",local:"__LOCAL_",disabled:"__DISABLED_",pipe:"__PIPE__"},O=n,{raycaster:P,pointer:w,update:M}=O.useRaycaster(),{initCSS2DRender:E,createCSS2DDom:S}=O.useCSS2D();class B extends i{constructor(e,o){super(e),t(this,"deviceGroup"),t(this,"dotGroup"),t(this,"pipeGroup"),t(this,"css2DRender"),t(this,"extend"),t(this,"findFilterDevice",((e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let i=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{i.includes(e)||i.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!i.includes(o)&&i.push(o),!!o})).length==e.length&&(o=o.concat(i))}else{const i=t.find((t=>t.deviceCode==e));i&&o.push(i)}})),o})),this.extend=o,this.css2DRender=E(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.createClock(),this.addDeviceGroup(),this.addDotGroup(),this.addPipeGroup(),this.bindEvent()}addDeviceGroup(){const e=new a;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup(),this.clearDot(),this.clearPipe()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addDotGroup(){const e=new a;e.name="点位组",this.scene.add(e),this.dotGroup=e}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){var o;const i=e.position,{size:n,color:s}=e.font||{},{x:a=0,y:l=0,z:r=0}=i||{},c=S({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,l,r],onClick:t});return c.name=e.name,c.data=e,null==(o=this.dotGroup)||o.add(c),c}addPipeGroup(){const e=new a;e.name="管路组",this.scene.add(e),this.pipeGroup=e}addPipe(...e){this.pipeGroup&&this.pipeGroup.add(...e)}clearPipe(){this.pipeGroup&&this.disposeObj(this.pipeGroup),this.addPipeGroup()}onDblclick(e){var t;const o=this.container,i=this.options.scale;if(M(e,o,i),this.deviceGroup){P.setFromCamera(w,this.camera);const e=[this.deviceGroup,this.pipeGroup],o=P.intersectObjects(e);if(o.length){const e=o[0].object,i=this.findParentGroupGroup(e);if(!i)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(i)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<D;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o,i;const n=this.container,s=this.options.scale;M(e,n,s);let a="pointerdown"==e.type||"pointerup"==e.type;const l=(null==(t=this.deviceGroup)?void 0:t.children.filter((e=>e.visible&&e._isAnchor_)))||[];P.setFromCamera(w,this.camera);let r=P.intersectObjects(l,a);if(n.style.cursor=r.length>0?"pointer":"auto",a)if(r.length){const e=r[0].object;if(!e)return;"function"==typeof(null==(o=this.extend)?void 0:o.onClickLeft)&&this.extend.onClickLeft(e)}else"function"==typeof(null==(i=this.extend)?void 0:i.onClickLeft)&&this.extend.onClickLeft()}findParentGroupGroup(e){const t=e=>{let o=e.parent;if(o)return o&&(o._isDevice_||o._isPipe_)?o:t(o)};return t(e)}modelAnimate(){var e;if(this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.deviceGroup&&this.deviceGroup.children.length){let t=null==(e=this.clock)?void 0:e.getDelta();this.deviceGroup.children.forEach((e=>{let o=e.data;if(!o)return;let i=e.extra;i&&((null==o?void 0:o.status)??0)>0&&i.mixer.update(t);const n=e[j.warning];n&&((null==o?void 0:o.error)||0)>0&&n.mixer.update(t)}))}this.pipeGroup&&this.pipeGroup.children.length&&this.pipeGroup.children.forEach((e=>{var t;const o=e[j.pipe];if(o){const i=e.data,n=i.bind||[],s=((null==(t=this.deviceGroup)?void 0:t.children)||[]).filter((e=>{var t;return e.data&&e.data.deviceCode&&((null==(t=e.data)?void 0:t.status)??0)>0})).map((e=>e.data)),a=this.findFilterDevice(n,s),l=a.length>0;let r=.01;if(i.left&&i.right){const{left:e,right:t}=i,o=this.findFilterDevice(t,a).length>0,n=this.findFilterDevice(e,a).length>0;r=n&&o?0:o?-.01:.01}o.forEach((e=>{l&&(e.material.map.offset.y-=r),e.material.opacity=l?.3:0}))}}))}getAnimTargetPos(e,t,o){if(!this.controls)return;const i=t||e.to||{x:-104,y:7,z:58},n=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(n.x,n.y,n.z),i}getAll(){var e,t;return(null==(t=this.deviceGroup)?void 0:t.children.concat((null==(e=this.dotGroup)?void 0:e.children)||[]))||[]}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}dispose(){this.disposeObj(this.deviceGroup),this.disposeObj(this.dotGroup),this.disposeObj(this.pipeGroup),this.clock=void 0,this.css2DRender=void 0,this.deviceGroup=void 0,this.dotGroup=void 0,this.pipeGroup=void 0,this.extend={},super.dispose()}}const A={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},T={class:"scene-operation"},L=G(l({name:"device-scene",__name:"index",props:{devEnv:{type:Boolean},baseUrl:{},dracoPath:{},basisPath:{},bgColor:{},skyCode:{},bgUrl:{},env:{},scale:{},colors:{default:()=>({})},indexDB:{default:()=>({cache:!0})},camera:{default:()=>({})},cruise:{default:()=>({})},fog:{default:()=>({})},render:{default:()=>({})},controls:{default:()=>({})},grid:{default:()=>({})},axes:{default:()=>({})},ambientLight:{},directionalLight:{default:()=>({})},models:{},config:{},objects:{},pipes:{},dotKey:{default:"DOT"},dotShowStrict:{type:Boolean,default:!0},statusOffset:{},getColorCall:{},formatObject:{},dotUpdateObjectCall:{},updateObjectCall:{},colorMeshName:{default:()=>[]},colorModelType:{default:()=>["FM"]},animationModelType:{},textModelType:{},anchorType:{default:()=>[]},textChangeColor:{type:Boolean},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},mainBodyExcludeType:{default:()=>["FM"]}},emits:["init","loaded","update","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:t,emit:i}){const l=e,G=i,D=s.deepMerge(A,l.colors),{changeBackground:O,backgroundLoad:P}=n.useBackground(l.baseUrl+"/oss/sky/",x().skys),{progress:w,MODEL_MAP:M,loadModel:E,loadModels:S,getModel:L}=n.useModelLoader({baseUrl:l.baseUrl,dracoPath:l.dracoPath,basisPath:l.basisPath,colors:D,colorMeshName:l.colorMeshName,indexDB:l.indexDB}),{dialog:R}=n.useDialog(),U=r(),N={baseUrl:l.baseUrl,bgUrl:l.bgUrl,env:l.env,bgColor:l.bgColor,camera:l.camera,cruise:l.cruise,fog:l.fog,render:l.render,grid:l.grid,controls:l.controls,axes:l.axes,ambientLight:l.ambientLight,directionalLight:l.directionalLight};let z;c((()=>l.dotShowStrict),(()=>F())),c((()=>l.scale),(e=>{null==z||z.setScale(e||1)})),c((()=>l.cruise.points),(e=>{w.isEnd&&z.setCruisePoint(e||[])})),c((()=>l.objects),(()=>{w.isEnd&&K()}));const F=()=>{var e;const t=(null==(e=z.dotGroup)?void 0:e.children)||[];for(let o=0;o<t.length;o++){const e=t[o];if(!e.data)continue;e.data.type===l.dotKey&&I(e)}},I=e=>{var t;const o=e.data;if(!o||!z.deviceGroup)return;if("function"==typeof l.dotUpdateObjectCall){const e=l.dotUpdateObjectCall(o,z.deviceGroup.children);"object"==typeof e&&Object.keys(e).forEach((t=>{o[t]=e[t]}))}else console.warn(Error("未传人点位更新对象回调方法 dotUpdateObjectCall"));e.visible=o.show||!l.dotShowStrict;const i=null==(t=e.element)?void 0:t.getElementsByClassName("inner")[0];if(i){const{size:e,color:t}=o.font||{};null!=e&&(i.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(i.style.color=t),i.textContent=`${o.value||0}${o.unit}`}},$=async e=>{var t;if(!e)return;const{type:o,url:i}=e,n=L(o);if(!n)return void(i?await(async e=>{const{type:t,url:o="",name:i}=e,n=await E({key:t,url:o,name:i,size:0}),{position:a,scale:l,rotation:r}=s.get_P_S_R_param(n,e);return n.scale.set(...l),n.position.set(...a),n.rotation.set(...r),n._isBase_=!0,z.addDevice(n),Promise.resolve(n)})(e):o===l.dotKey&&(e=>{I(z.addDot(e,(t=>{G("click-dot",p(e),t)})))})(e));const r=l.anchorType||[];let c=s.modelDeepClone(n);const{position:d,scale:u,rotation:h}=s.get_P_S_R_param(c,e),[f,m,v]=d;c.scale.set(...u);const g=l.animationModelType||[],y=l.colorMeshName||[],b=l.mainBodyExcludeType||[],C=l.textModelType||[],_=L(M.font);if(C.includes(o)&&_){const o=new a;o.add(c);const i=s.createText(e,_,D.normal.text,null==(t=l.statusOffset)?void 0:t.TEXT);o.add(i),o.name=e.name,c=o}if(g.includes(o)){if("Group"!==c.type){const e=new a;e.add(c),e.name=c.name,c=e}if(((e,t)=>{var o,i,n;const a=L(M.warning);if(a){const i=j.warning,{group:n,action:r,mixer:c}=s.createWarning(i,t,a,null==(o=l.statusOffset)?void 0:o.WARNING);e.add(n),e[i]={action:r,mixer:c}}const r=L(M.local);if(r){const o=j.local,n=s.createStatusMark(t,r,null==(i=l.statusOffset)?void 0:i.STATUS);e.add(n),e[o]=n}const c=L(M.disabled);if(c){const o=j.disabled,i=s.createStatusMark(t,c,null==(n=l.statusOffset)?void 0:n.DISABLED,!0);e.add(i),e[o]=i}})(c,e),l.mainBodyChangeColor&&!b.includes(o)){const e=s.findObjectsByHasProperty(c.children,l.mainBodyMeshName),t=D.normal;let o=null!=t.main?t.main:t.color,i=s.getColorArr(o);i.length&&e.forEach(((e,t)=>{s.setMaterialColor(e,i[t%i.length])})),c[j.body]=e}const t=s.findObjectsByHasProperty(c.children,y);let i,r=new k(c);n.animations.length&&(i=r.clipAction(n.animations[0]),i.paused=!0,i.timeScale=1.5,i.play()),c.extra={action:i,mixer:r,meshs:t}}else{const e=[];c.traverse((t=>{"string"==typeof t.name&&y.some((e=>t.name.indexOf(e)>-1))&&e.push(t)})),e.length&&(c[j.color]=e)}return c.position.set(f,m,v),c.rotation.set(...h),c._isDevice_=!0,c.data=e,r.includes(o)&&(c._isAnchor_=!0),z.addDevice(c),Promise.resolve()},H=r([]),K=async()=>{var e,t,o;w.percentage=100,w.show=!1,z.clearDevice(),await _(),(()=>{H.value.length=0;const e=p(l.objects)||[];if("function"!=typeof l.formatObject)H.value=e,console.warn(Error("未传入格式化函数 formatObject"));else{const t=l.formatObject(e);H.value=t}})(),await(()=>{let e=0,t=H.value.length;return new Promise((o=>{if(0==t)return o(null);const i=async()=>{const n=H.value[e];await $(n),e++,e<t?i():o(e)};i()}))})(),(()=>{if(!l.pipes||0==l.pipes.length)return;const e=l.pipes;for(let t=0;t<e.length;t++){const o=e[t],{type:i,map:n}=o,a=L(i);if(!a)continue;let l=s.modelDeepClone(a);const r=a._mapMeshName_,{position:c,scale:d,rotation:p}=s.get_P_S_R_param(l,o),[u,h,f]=c,m=s.findObjectsByHasProperty(l.children,[r]);m.length&&(m.forEach((e=>{if(e.material.map=e.material.map.clone(),n){const t=e.material.map.repeat;e.material.map.repeat.set(t.x*(n[0]??1),t.y*(n[1]??1))}})),l[j.pipe]=m),l.scale.set(...d),l.position.set(u,h,f),l.rotation.set(...p),l._isPipe_=!0,l.data=o,z.addPipe(l)}})(),z.setCruisePoint((null==(e=l.cruise)?void 0:e.points)||[]),"function"==typeof(null==(t=l.config)?void 0:t.load)&&(null==(o=l.config)||o.load(z));const i=z.getAnimTargetPos(l.config||{});z.controls&&i&&s.cameraInSceneAnimate(z.camera,i,z.controls.target).then((()=>{G("loaded"),z.controlSave()}))},V=()=>{S(l.models,(()=>{K()})),l.skyCode&&P(z,l.skyCode)},W=e=>{const t=U.value,o=s.getPlanePosition(t,e,z.camera);return R.position=o,R.style&&(R.style.left=o.left+"px",R.style.top=o.top+"px"),o},Y=e=>{const t=[];"function"!=typeof l.updateObjectCall&&console.warn(Error("未传入更新回调函数 updateObjectCall")),z.getAll().forEach(((o,i)=>{if(!o.data)return;const n=o.data;let s=n.type;if(s===l.dotKey)return void I(o);if("function"==typeof l.updateObjectCall){const t=l.updateObjectCall(n,e);if(!t)return;"object"!=typeof t&&console.warn(Error("更新回调函数返回对象不为 Object，当前类型："+typeof t)),Object.keys(t).forEach((e=>{n[e]=t[e]}))}t.push(p(n));let{status:a=0,error:r=0,remote:c=0,local:d=0,disabled:u=0}=n;const h=D[r>0?"error":a>0?"runing":"normal"];let f=null!=h[s]?h[s]:h.color;if("function"==typeof l.getColorCall){const e=l.getColorCall(n);e&&(f=e)}q({type:s,el:o,colorObj:h,color:f,paused:0==a,error:r>0,remote:c>0,local:d>0,disabled:u>0})})),G("update",t,e)},q=e=>{let{el:t,type:o,colorObj:i,color:n,paused:a,error:r}=e,c=s.getColorArr(n);n=c[0];const d=j;if(l.colorModelType.includes(o)&&null!=n){return void(t[d.color]||[]).forEach((e=>{s.setMaterialColor(e,n)}))}if(!(l.animationModelType||[]).includes(o))return;if(l.textChangeColor){const e=null!=i.text?i.text:i.color,o=t.getObjectByProperty("_isText_",!0);let n=s.getColorArr(e);s.setMaterialColor(o,n[0])}const p=t.extra;if(p&&(p.action&&(p.action.paused=a),null!=n)){(p.meshs||[]).forEach((e=>{s.setMaterialColor(e,n)}))}if(l.mainBodyChangeColor&&t[d.body]){const e=null!=i.main?i.main:i.color;let o=s.getColorArr(e);o.length&&t[d.body].forEach(((e,t)=>{s.setMaterialColor(e,o[t%o.length])}))}const u=t[d.warning];if(u){const e=t.children.find((e=>e.name==d.warning));e&&(e.visible=r,u.action.paused=!r)}t[d.local]&&(t[d.local].visible=e.local),t[d.disabled]&&(t[d.disabled].visible=e.disabled)};return d((()=>{N.container=U.value,z=new B(N,{onDblclick(e){const t=e.data;"function"==typeof t.onDblclick?t.onDblclick(p(t),e):G("dblclick",p(t))},onClickLeft(e){if(e){const t=e.data,o=p(t);G("select",o),"function"==typeof t.onClick?(R.show=!1,t.onClick(o)):(R.select=[e],(()=>{if(!R.select||!R.select.length)return;const e=R.select[0],t=e.data;R.data=t,R.title=(null==t?void 0:t.name)||"",R.show=!0;const o=W(e);G("click-dialog-dot",t,o)})())}else R.select=[],R.show=!1},onClickRight(e){var t;console.log(e),"function"==typeof(null==(t=l.config)?void 0:t.back)&&l.config.back(z)},animateCall:()=>{if(R.show&&R.select&&R.select.length){const e=R.select[0];W(e)}}}),z.run(),G("init",z),V()})),t({update:Y,exportImage:()=>null==z?void 0:z.exportImage()}),(e,t)=>(u(),h("div",{class:g(e.$style["device-scene"])},[f("div",T,[f("div",{class:"btn",onClick:t[0]||(t[0]=()=>Y(!0))},"随机更新"),e.cruise.visible?(u(),h("div",{key:0,class:"btn",onClick:t[1]||(t[1]=()=>{var e;return null==(e=m(z))?void 0:e.toggleCruise()})},"定点巡航")):v("",!0),f("div",{class:"btn",onClick:t[2]||(t[2]=()=>{var e;return null==(e=m(z))?void 0:e.getPosition()})},"场景坐标"),f("div",{class:"btn",onClick:t[3]||(t[3]=()=>m(O)(m(z)))},"切换背景"),f("div",{class:"btn",onClick:t[4]||(t[4]=()=>{var e;return null==(e=m(z))?void 0:e.controlReset()})},"控制器重置"),e.cruise.visible?(u(),h("div",{key:1,class:"btn",onClick:t[5]||(t[5]=()=>{var e;return null==(e=m(z))?void 0:e.toggleCruiseDepthTest()})}," 巡航深度 ")):v("",!0)]),f("div",{class:g(e.$style.container),ref_key:"containerRef",ref:U},null,2),y(o,{modelValue:m(w).show,"onUpdate:modelValue":t[6]||(t[6]=e=>m(w).show=e),progress:m(w).percentage},null,8,["modelValue","progress"]),m(R).show?(u(),h("div",{key:0,class:g(e.$style.dialog),style:b(m(R).style)},[C(e.$slots,"dialog",{data:m(R).data,title:m(R).title,position:m(R).position})],6)):v("",!0)],2))}}),[["__cssModules",{$style:{"device-scene":"_device-scene_60g0k_2",container:"_container_60g0k_8",dialog:"_dialog_60g0k_12"}}]]);export{L as t};
