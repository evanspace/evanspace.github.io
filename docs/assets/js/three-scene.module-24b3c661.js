import{bv as e,bw as t,bx as n,by as o,bz as i,bA as a,bB as r,bC as s,bD as l,bE as c,bF as d,bG as u,bH as p,bI as h,bJ as m,bK as f,ba as g,bo as v,bc as w,b7 as y,bL as x,bM as b,b5 as C,b6 as S,bh as L,bN as z,bO as _,bP as M,be as P,bQ as A,bR as k,bS as O,bT as B,bs as T,bU as E,bV as D,i as j,bf as I,bW as U,bX as R,bY as F,bZ as N,b_ as G,b$ as J,bk as X,c0 as Q,c1 as W,c2 as H,c3 as K,c4 as Z,Y,c5 as V,c6 as $,c7 as q,c8 as ee,c9 as te,ca as ne,cb as oe,cc as ie,cd as ae,ce as re,cf as se,bd as le,cg as ce,ch as de,ci as ue,bp as pe,cj as he,ck as me,cl as fe,cm as ge,cn as ve,co as we,cp as ye,cq as xe,cr as be,cs as Ce,ct as Se,bb as Le,cu as ze,cv as _e,cw as Me,cx as Pe,cy as Ae,cz as ke,cA as Oe,cB as Be,cC as Te,cD as Ee}from"./vendor-16889df9.js";function De(e,t,n,o){return new(n||(n=Promise))((function(i,a){function r(e){try{l(o.next(e))}catch(t){a(t)}}function s(e){try{l(o.throw(e))}catch(t){a(t)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const je=e=>new URL(Object.assign({})[`../assets/imgs/texttures/${e}`],self.location).href,Ie=e=>{!e&&(e="");if(!/^([hH][tT]{2}[pP]:\/\/|[hH][tT]{2}[pP][sS]:\/\/)[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}(\/\S*)?$/.test(e)){return/^(https?:\/\/)(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d{1,5})?(?:[/?#]\S*)?$/.test(e)}return!0},Ue=(e,t="")=>Array.isArray(e)?e.map((e=>Ue(e,t))):!Ie(e)&&e.indexOf(t)<0?t+e:e,Re=e=>new Promise((t=>{const n=window.indexedDB.deleteDatabase(e);n.onsuccess=e=>{t(!0)},n.onerror=e=>{t(!1)}})),Fe=(e,t,n)=>new Promise((o=>{window.indexedDB.open(e).onsuccess=i=>{const a=i.target.result,r=a.version;a.close(),r!==t?Re(e).then((e=>{o(e?t:r)})):a.objectStoreNames.contains(n)?o(r):Re(e).then((e=>{o(e?t:r)}))}})),Ne=(e,...t)=>De(void 0,[e,...t],void 0,(function*(e,t="THREE__MODEL_DB",n=1){if(!window.indexedDB)return Promise.resolve(void 0);yield Fe(t,n,e);let o=window.indexedDB.open(t,n);return new Promise((t=>{o.onupgradeneeded=t=>{const n=t.target.result;n.objectStoreNames.contains(e)||n.createObjectStore(e,{keyPath:"path"})},o.onsuccess=e=>{const n=e.target.result;t(n)},o.onerror=e=>{t(void 0)}}))})),Ge=(e,t,n)=>{if(!e||!t||!n)return Promise.resolve(null);const o=e.transaction([t],"readonly").objectStore(t).get(n);return new Promise(((e,t)=>{o.onsuccess=t=>{const n=t.target.result;e(n)},o.onerror=e=>{t(e)}}))},Je={TEXT:"TEXT",JSQ:"JSQ",LDB:"LDB",LQB:"LQB",XBC:"XBC",LXJ:"LXJ",LGJ:"LGJ",LGJ_2:"LGJ_2",LGJ_3:"LGJ_3",LGJ_4:"LGJ_4",LQT:"LQT",GL:"GL",BSHRQ:"BSHRQ",BSHLQ:"BSHLQ",FLRB:"FLRB",FJY_X:"FJY_X",FJZ_X:"FJZ_X",FJY:"FJY",FJZ:"FJZ",FM:"FM",XFM:"XFM"};var Xe={indexdb:{dbName:"THREE__MODEL__DB",tbName:"TB",version:1},mesh:{receiveShadowName:["楼板","地面","底座","底板","基础","基础底座","冷却塔基础","草地","ground","Ground"],animatehName:["动画","螺杆A","螺杆B","螺杆A001","螺杆B001","螺杆A002","螺杆B002","叶轮A","叶轮B","叶轮C","阀门"],transparentName:["透明","透明外壳"]},keys:Je,rightClickBackDiffTime:300,meshKey:{body:"__BODY_",color:"__COLOR_",warning:"__WARNING_",local:"__LOCAL_",disabled:"__DISABLED_",pipe:"__PIPE__"},statusOffset:{TEXT:{[Je.JSQ]:{position:{x:-20,y:10,z:0},rotation:{x:0,y:270,z:0}},[Je.LDB]:{position:{x:-60,y:0,z:0}},[Je.LQB]:{position:{x:0,y:0,z:60},rotation:{x:0,y:270,z:0}},[Je.LXJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[Je.LGJ]:{position:{x:0,y:16,z:50},rotation:{x:-20,y:0,z:0}},[Je.LQT]:{position:{x:-60,y:0,z:0}},[Je.BSHLQ]:{position:{x:0,y:16,z:40}}},WARNING:{[Je.JSQ]:{position:{x:0,y:62,z:0}},[Je.LDB]:{position:{x:-4,y:45,z:0}},[Je.LQB]:{position:{x:0,y:45,z:4},rotation:{x:0,y:270,z:0}},[Je.LXJ]:{position:{x:0,y:78,z:0}},[Je.LGJ]:{position:{x:0,y:78,z:0}},[Je.LQT]:{position:{x:0,y:85,z:0}},[Je.BSHLQ]:{position:{x:0,y:88,z:0}}},STATUS:{[Je.LDB]:{position:{x:9,y:47,z:0}},[Je.LQB]:{position:{x:0,y:47,z:-9},rotation:{x:0,y:270,z:0}},[Je.LXJ]:{position:{x:27,y:67,z:42}},[Je.LGJ]:{position:{x:-47,y:67,z:42}},[Je.LQT]:{position:{x:-35,y:69,z:26}}},DISABLED:{[Je.LDB]:{position:{x:22,y:47,z:0}},[Je.LQB]:{position:{x:0,y:47,z:-22},rotation:{x:0,y:270,z:0}},[Je.LXJ]:{position:{x:40,y:67,z:42}},[Je.LGJ]:{position:{x:-34,y:67,z:42}},[Je.LQT]:{position:{x:-22,y:69,z:26}}}}};const Qe=e=>{e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()},We=e=>{let t=e.clone();return(e.isMesh||e.isSprite)&&Qe(e),t.traverse((e=>{e.isMesh&&Qe(e)})),t},He=(e,t=6776165,n,o)=>{const{type:i,name:a}=e;i.indexOf("Light"),Xe.mesh.receiveShadowName.some((e=>a.indexOf(e)>-1))?e.traverse((e=>{e.isMesh&&(e.receiveShadow=!0)})):n.some((e=>a.indexOf(e)>-1))?Ze(e,t):e.isMesh&&(o&&(e.material.envMap=o),e.castShadow=!0,e.receiveShadow=!0)},Ke=e=>{let t=[];return Array.isArray(e)?t=e:null!=e&&(t=[e]),t},Ze=(e,t)=>{e.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,Array.isArray(e.material)?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t))}))},Ye=Xe.statusOffset,Ve=(e,t,n={})=>{const o=t.type,i=Ye[e]||{},a=n[o]||i[o]||{};let r=nt({x:0,y:0,z:0},a.position||{}),s=nt({x:0,y:0,z:0},a.rotation||{});return s.x=Math.PI/180*s.x,s.y=Math.PI/180*s.y,s.z=Math.PI/180*s.z,{position:r,rotation:s}},$e=(e,t)=>Object.prototype.toString.call(t)===`[object ${e}]`,qe=e=>$e("Object",e),et=e=>e&&("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName),tt=(e,t=new Map)=>{if(null!=e&&qe(e)){let n=t.get(e);if(n)return n;const o=Array.isArray(e);let i=o?[]:{};return n=t.set(e,i),o?e.forEach(((e,t)=>{i[t]=tt(e,n)})):Object.keys(e).forEach((t=>{qe(i[t])?i[t]=tt(e[t],n):i[t]=e[t]})),i}return e},nt=(e,t)=>{e=tt(e);for(let n in t)n in e&&qe(t[n])&&qe(e[n])?e[n]=nt(e[n],t[n]):e[n]=t[n];return e},ot=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;var it=Object.freeze({__proto__:null,getTextturesUrl:je,numConverter:(e=0,t=2)=>{if(Math.abs(e)>=1e8){return 1*(e/1e8).toFixed(t)+"亿"}if(Math.abs(e)>=1e4){return 1*(e/1e4).toFixed(t)+"万"}return 1*e.toFixed(t)},getUrl:Ue,deleteDB:Re,getDBVersion:Fe,createDB:Ne,getDataByKey:Ge,getAllData:(e,t)=>{const n=e.transaction(t,"readonly").objectStore(t).getAll();return new Promise(((e,t)=>{n.onsuccess=t=>{const n=t.target.result;e(n)},n.onerror=e=>{t(e)}}))},get_P_S_R_param:(e,t,n=1)=>{const o=e.position,i=e.rotation,a=e.scale,r=t.position||{x:0,y:0,z:0},s=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(s.x)<2?1:180,d=Math.abs(s.y)<2?1:180,u=Math.abs(s.z)<2?1:180;return{position:[o.x+r.x,o.y+r.y,o.z+r.z],rotation:[i.x+Math.PI/c*s.x,i.y+Math.PI/d*s.y,i.z+Math.PI/u*s.z],scale:[a.x*n*l.x,a.y*n*l.y,a.z*n*l.z]}},modelDeepClone:We,replaceMaterial:He,getColorArr:Ke,setMaterialColor:Ze,cameraInSceneAnimate:(e,t,n=new P)=>(e.lookAt(n),e._lookAt_=n,new Promise((o=>{new _(e.position).to(t,1e3).easing(M.Quadratic.In).start().onUpdate((()=>{e.lookAt(n),e._lookAt_=n})).onComplete((()=>{o(e)}))}))),cameraLookatAnimate:(e,t,n)=>new Promise((o=>{new _(n).to(t,1e3).easing(M.Quadratic.In).start().onUpdate((t=>{e.lookAt(t),e._lookAt_=t})).onComplete((()=>{o(e)}))})),cameraLinkageControlsAnimate:(e,t,n,o)=>new Promise((i=>{new _(t.position).to(n,1e3).easing(M.Quadratic.In).start().onUpdate((()=>{const n=e.target;t.lookAt(n),t._lookAt_=n})),new _(e.target).to(o,1e3).easing(M.Quadratic.In).start().onComplete((()=>{i(t)}))})),createSpriteAnimate:(e,t,n=1,o=10)=>{let i=[0,o/2,o],a=[...t,t[0],t[1]+n,t[2],...t],r=new A("sprite.position",i,a),s=new k("sprite_up_down",o,[r]);const l=new O(e),c=l.clipAction(s);return c.timeScale=5,c.play(),e.__action__=c,e.__mixer__=l,e},getPlanePosition:(e,t,n)=>{let o=e.clientWidth/2,i=e.clientHeight/2,a=t.position.clone();const r=t.scale;a.y+=r.x/2;let s=a.project(n);return{left:s.x*o+o,top:-s.y*i+i}},findObjectsByHasProperty:(e,t,n="name")=>{let o=[];if(!e||!e.length)return[];return function e(i){i.forEach((i=>{const a=i[n];"string"==typeof a&&t.some((e=>a.indexOf(e)>-1))&&o.push(i),i.children&&e(i.children)}))}(e),o},getStatusOffset:Ve,createText:(e,t,n=16777215,o)=>{const i=Ve("TEXT",e,o);let a=e.font||{},r=new B(e.name||"",{font:t,size:a.size||10,depth:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const s=i.rotation;r.rotateX(s.x),r.rotateY(s.y),r.rotateZ(s.z);const l=i.position;r.computeBoundingBox(),r.computeVertexNormals();let c=.5*(r.boundingBox.max.x-r.boundingBox.min.x),d=.5*(r.boundingBox.max.z-r.boundingBox.min.z),u=new v({color:null!=a.color?a.color:n,flatShading:!1}),p=new w(r,u);return p.castShadow=!0,p.position.set((l.x||0)-c,l.y||0,(l.z||0)-d),p.name="text",p._isText_=!0,p},createWarning:(e,t,n,o,i=100,a=1)=>{if(!n)return;const r=Ve("WARNING",t,o);let s=new T,l=We(n);l.scale.set(a,a,a);const c=r.position;l.position.set(c.x,c.y,c.z);const d=r.rotation;l.rotation.set(d.x,d.y,d.z),s.add(l);let u=new E(12717056,8,i,0);u.name="灯光",u.position.y=c.y+30,s.add(u),s.name=e;let p=new O(s),h=new A("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),m=new A("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),f=new A("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),g=new k("warning_",1,[h,m,f]),v=p.clipAction(g);return v.paused=!0,v.play(),s.visible=!1,s._isWarning_=!0,{group:s,action:v,mixer:p}},createStatusMark:(e,t,n,o)=>{if(!t)return;const i=Ve(o?"DISABLED":"STATUS",e,n);let a=We(t);const r=i.position;a.position.set(r.x,r.y,r.z);const s=i.rotation;return a.rotation.set(s.x,s.y,s.z),a.visible=!1,a._isStatus_=!0,a},isType:$e,isObject:qe,isDOM:et,deepClone:tt,deepMerge:nt,checkUrl:Ie,random:ot}),at={container:document.body,width:window.innerWidth,height:window.innerHeight,baseUrl:"",bgColor:null,bgUrl:null,env:null,scale:1,fog:{visible:!1,near:100,far:1e3},render:{antialias:!0,logarithmicDepthBuffer:!0,preserveDrawingBuffer:!1},controls:{visible:!0,autoRotate:!1,autoRotateSpeed:2,enableDamping:!1,dampingFactor:.25,enablePan:!0,enableRotate:!0,enableZoom:!0,maxAzimuthAngle:1/0,minAzimuthAngle:1/0,minDistance:1,maxDistance:2e3,minPolarAngle:0,maxPolarAngle:Math.PI,maxTargetRadius:1/0,rotateSpeed:1,screenSpacePanning:!0},ambientLight:{visible:!0,color:16777215,intensity:1.5},directionalLight:{visible:!0,helper:!1,position:[500,1e3,800],position2:[-500,800,-800],light2:!0,color:16777215,intensity:1.5},camera:{helper:!1,near:1,far:1e4,position:[-350,510,700]},cruise:{visible:!1,enabled:!1,runing:!1,helper:!1,points:[],segment:2,tension:0,baseUrl:"",repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,auto:!1,animateBack:void 0,alway:!1},grid:{visible:!1,opacity:.3,transparent:!0,width:800,divisions:80,centerLineColor:10592673,gridColor:10592673,fork:!1,forkSize:1.4,forkColor:10592673},axes:{visible:!1,size:50}};const rt=()=>({initCSS3DRender:(e,n)=>{const{width:o,height:i}=e,a=new t;return a.setSize(o,i),a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px",a.domElement.style.pointerEvents="none",n.appendChild(a.domElement),a},createCSS3DDom:e=>{const{name:t,className:n="",onClick:o,position:i,sprite:a}=e,r=document.createElement("div");r.innerHTML=t,r.className=n;const s=a?new re(r):new se(r);return r.style.pointerEvents=o?"auto":"none",r.style.position="absolute","function"==typeof o&&r.addEventListener("click",o),i&&s.position.set(...i),s}}),{createCSS3DDom:st}=rt(),lt=()=>({visible:!0,enabled:!1,runing:!1,helper:!1,points:[],segment:2,close:!0,tension:0,baseUrl:"",mapUrl:je("arrow.png"),repeat:[.1,1],width:15,speed:1,mapSpeed:.006,offset:10,factor:1,index:0,auto:!1,tube:!1,color:16777215,radius:1,radialSegments:1,animateBack:void 0,alway:!1}),ct=()=>{let e,t,n,o=lt();const i=(t,i)=>{n=new w(new J(2),new X({color:0,opacity:.8,depthTest:!1,transparent:!0})),t.add(n);const a=(new Q).setFromPoints(i.concat(i[0])),r=new W({color:255,opacity:1,depthTest:!1,transparent:!0}),s=new H(a,r);t.add(s);const l=new K(e,100,o.width/2,3,!0),c=new Z({color:16711935,opacity:.1,depthTest:!1,transparent:!0}),d=new w(l,c),u=new X({color:16715760,opacity:.3,wireframe:!0,depthTest:!1,transparent:!0}),p=new w(l,u);d.add(p),t.add(d)},a=()=>{var e;return 900*(null!==(e=o.segment)&&void 0!==e?e:2)},r=()=>null==e?void 0:e.getPoints(a()),s=(e,t)=>new P(t.x,t.y+e,t.z),l=e=>{if(!o.enabled)return;switch(e.keyCode){case 38:case 87:o.runing?(o.factor*=1.5,o.factor>10&&(o.factor=10)):o.index+=5;break;case 83:case 40:o.runing||(o.index-=5,o.index<0&&(o.index=a()))}},c=e=>{if(!o.enabled)return;o.factor=1;switch(e.keyCode){case 32:o.runing=!o.runing;break;case 38:case 87:o.runing||(o.index+=10);break;case 83:case 40:o.runing||(o.index-=10,o.index<0&&(o.index=a()))}};return{createCruise:(n={},a)=>{o=nt(lt(),n);const{points:s,tension:l,mapUrl:c,baseUrl:d,repeat:u,width:p,helper:h,close:m,tube:f,color:g,radius:y,radialSegments:x}=o,b=[];for(let e=0;e<s.length;e++){const t=s[e];b.push(new P(t[0],t[1],t[2]))}e=new R(b,m,"catmullrom",null!=l?l:0),e=new R(r(),m,"catmullrom",null!=l?l:0);const C=new T;t=(new S).load(Ue(c,d),(e=>{e.wrapS=D,e.repeat.x=u[0],e.repeat.y=u[1],e.anisotropy=a.capabilities.getMaxAnisotropy()}));const L=new v({color:g,map:t,opacity:.9,transparent:!0,depthTest:!0,side:F}),z=new P(0,1,0),_=new be;_.set(r(),y,x,z,!1);const M=f?new N:new G;M.update(_,f?{radius:y,radialSegments:x,progress:1,startRad:0}:{width:p,arrow:!1,progress:1,side:"both"});const A=new w(M,L);return C.add(A),C.name="cruise",h&&i(C,b),C.renderOrder=99,C},updateCruise:(e={})=>{o=nt(o,e)},cruiseAnimate:i=>{if(!i)return;if(!e)return;const{mapSpeed:r,speed:l,factor:c,enabled:d,runing:u,offset:p,helper:h,auto:m,animateBack:f}=o;if(t&&(t.offset.x-=r),!(m||u&&d))return;(m||u&&d)&&(o.index+=c*l);const g=a(),v=o.index%g/g;let w=v+.001;w>1&&(w-=1);const y=e.getPointAt(w);if(h&&n){const e=s(p,y);n.position.copy(e)}const x=s(p,e.getPointAt(v));if(!m||u&&d){i.position.copy(x);const e=s(p,y);i._lookAt_=e,i.lookAt(e)}"function"==typeof f&&f(x,y,e,v)},bindEvent:()=>{window.addEventListener("keydown",l,!1),window.addEventListener("keyup",c,!1)},removeEvent:()=>{window.removeEventListener("keyup",c),window.removeEventListener("keydown",l)}}},dt=()=>({createFork:(e={})=>{const{width:t=800,divisions:n=80,forkSize:o=1.4,forkColor:i=10592673}=e;let a=t/n,r=-t/2;const s=new T;for(let l=0;l<=n;l++)for(let e=0;e<=n;e++){const t=r+l*a,n=r+e*a,c=new g(o,o/5),d=new Z({color:i,transparent:!0,opacity:.9}),u=new w(c,d);u.rotateX(.5*-Math.PI),u.position.set(t,0,n);const p=u.clone();p.rotateZ(.5*Math.PI),s.add(u,p)}return s}});var ut,pt,ht=Object.freeze({__proto__:null,useConvertData:()=>({transformGeoJSON:e=>{let t=e.features;for(let n=0;n<t.length;n++){const e=t[n];"Polygon"===e.geometry.type&&(e.geometry.coordinates=[e.geometry.coordinates])}return e}}),useCountryLine:()=>{const e=(e,t,n="LineLoop")=>{let o;if("Line2"===n){const n=new oe;n.setPositions(e),o=new ie(n,t),o.name="countryLine2",o.computeLineDistances()}else{const i=new Q;i.setFromPoints(e),o=new ae[n](i,t),o.name="countryLine"}return o};return{createCountryFlatLine:(t,n,o="LineLoop")=>{let i={color:65535,linewidth:1,depthTest:!1};i=nt(i,n);let a=new W(i);"Line2"===o&&(a=new ne(i));let r=t.features,s=new T;for(let l=0;l<r.length;l++){const t=r[l].geometry.coordinates;for(let n=0;n<t.length;n++){const i=t[n],r=[];"Line2"===o?i.forEach((e=>{e.forEach((e=>{r.push(e[0],0,-e[1])}))})):i.forEach((e=>{e.forEach((e=>{r.push(new P(e[0],e[1],0))}))}));let l=e(r,a,o);s.add(l)}}return s},getPoints:(e,t=0,n)=>{let o=e.features;const i=[];for(let a=0;a<o.length;a++){const e=o[a].geometry.coordinates;for(let o=0;o<e.length;o++)e[o].forEach((e=>{e.forEach((e=>{n?i.push(new P(e[0],t,-e[1])):i.push(e[0],t,-e[1])}))}))}return i}}},useMapBar:(e={})=>{let t=nt({height:10,size:2,factor:1,color1:1048575,color2:16777215},e);return{createBar:(e={},n={})=>{var o;t=nt(t,n);let{size:i,height:a,factor:r,color1:s,color2:l}=t;i*=r,a*=r,a*=null!==(o=e.heightRatio)&&void 0!==o?o:r;const[c,d,u]=e.position||[0,0,0],p=new T,h=new le(i,i,a),m=new ce({depthTest:!1,transparent:!0,vertexColors:!1,uniforms:{uColor1:{value:new L(s)},uColor2:{value:new L(l)},uOpacity:{value:.6}},vertexShader:"\n        varying vec3 vColor;\n        uniform vec3 uColor1;\n        uniform vec3 uColor2;\n        void main() {\n          float percent = (position.z + 0.0) / 100.0; // 计算当前像素点在立方体高度上的百分比\n          vColor = mix(uColor1.rgb, uColor2.rgb, percent);\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        varying vec3 vColor;\n        uniform float uOpacity;\n        void main() {\n          gl_FragColor = vec4(vColor, uOpacity);\n        }\n      "}),f=new w(h,m);if(p.add(f),p.name="柱状图",p.position.set(c,d,u+a/2),p.renderOrder=99,e.label){const{name:t="",className:n="",onClick:o}=e.label,i=st({name:t,className:n,position:[0,0,a/2],onClick:o});i.rotateX(.5*Math.PI),p.add(i)}return p}}},useOutline:(e={})=>{let t=nt({size:.1,color:16085360,range:500,factor:1,speed:6},e);const n=e=>{const n=e.material,o=n.uniforms.uLength.value;n.uniforms.uIndex.value+=t.speed,n.uniforms.uIndex.value>=o&&(n.uniforms.uIndex.value=0)};return{createOutline:(e,n={})=>{t=nt(t,n);const{size:o,factor:i,range:a,color:r}=t,s=new Float32Array(e),l=new Q;l.setAttribute("position",new de(s,3));const c=new Float32Array(Math.floor(s.length/3)).map(((e,t)=>t));l.setAttribute("aIndex",new de(c,1));const d=new ce({vertexShader:"\n        attribute float aOpacity;\n        uniform float uSize;\n\n        attribute float aIndex;\n        varying vec3 vp;\n        varying float vertexIndex;\n\n        void main(){\n          gl_Position = projectionMatrix*modelViewMatrix*vec4(position,1.0);\n          gl_PointSize = uSize;\n\n          vp = position;\n          vertexIndex = aIndex;\n        }\n      ",fragmentShader:"\n        varying float vertexIndex;\n        uniform vec3 uColor;\n        uniform float uIndex;\n        uniform float uRange;\n\n        float invert(float n){\n          return 1.-n;\n        }\n\n        void main(){\n          float uOpacity = 1.0;\n          if(vertexIndex <= uIndex || vertexIndex >= (uRange + uIndex)){\n              discard;\n          }\n          uOpacity = (vertexIndex - uIndex)/uRange;\n          if ( uOpacity < 0.2) {\n            discard;\n          }\n          vec2 uv=vec2(gl_PointCoord.x,invert(gl_PointCoord.y));\n          vec2 cUv=2.*uv-1.;\n          vec4 color=vec4(1./length(cUv));\n          color*=uOpacity;\n          color.rgb*=uColor;\n          gl_FragColor=color;\n        }\n      ",transparent:!0,depthTest:!1,uniforms:{uSize:{value:o*i},uIndex:{value:0},uLength:{value:c.length},uRange:{value:a},uColor:{value:new L(r)}}}),u=new ue(l,d);return u.name="轮廓",u.scale.setScalar(i),u},update:n,outlineUpdate:n}},useMarkLight:(e={})=>{let t=nt({pointTextureUrl:je("point.png"),circleTextureUrl:je("circle.png"),lightTextureUrl:je("light.png"),factor:1,color:65535},e);const n=new S;return{createMarkLight:(e=[0,0,0],o=10,i={})=>{t=nt(t,i);const a=new T,r=new g(o/6.219,o);r.rotateX(-Math.PI/2),r.translate(0,0,o/2);const s=new X({map:n.load(t.lightTextureUrl),color:t.color,transparent:!0,depthWrite:!1,side:pe});let l=new w(r,s);l.rotateX(Math.PI),l.position.z=o,l.renderOrder=3,l.name="光柱 01";let c=l.clone();c.name="光柱 02",c.rotateZ(Math.PI/2);const d=(()=>{const e=new g(3,3),o=new X({map:n.load(t.pointTextureUrl),color:t.color,side:pe,transparent:!0,depthWrite:!1});let i=new w(e,o);i.renderOrder=1,i.name="底部光点";const a=.3*t.factor;return i.scale.setScalar(a),i})(),u=(()=>{const e=new g(3,3),o=new X({map:n.load(t.circleTextureUrl),color:t.color,side:pe,opacity:0,transparent:!0,depthWrite:!1});let i=new w(e,o);i.renderOrder=2,i.name="createLightHalo";const a=.5*t.factor;i.scale.setScalar(a);const r=ot(0,2e3);return i.tween1=new _({scale:a,opacity:0}).to({scale:1.5*a,opacity:1},1e3).delay(r).onUpdate((e=>{let{scale:t,opacity:n}=e;i.scale.setScalar(t),i.material.opacity=n})),i.tween2=new _({scale:1.5*a,opacity:1}).to({scale:2*a,opacity:0},1e3).onUpdate((e=>{let{scale:t,opacity:n}=e;i.scale.setScalar(t),i.material.opacity=n})),i.tween1.chain(i.tween2),i.tween2.chain(i.tween1),i.tween1.start(),i})();a.add(l,c,d,u);const[p,h,m]=e;return a.position.set(p,h,m),a.rotateX(.5*Math.PI),a.name="光柱标记",a}}},useFence:()=>{const e=[1,.8],t=.2,n=(new S).load(je("fenceMap0.png"),(n=>{n.wrapT=D,n.repeat.x=e[0],n.repeat.y=e[1],n.offset.y=t})),o=(new S).load(je("fenceMap1.png"),(n=>{n.wrapT=D,n.repeat.x=e[0],n.repeat.y=e[1],n.offset.x=t})),i=(new S).load(je("fenceMap2.png"),(e=>{e.wrapS=D,e.wrapT=D})),a=(e,t,a)=>{const r=[];for(let n=0;n<t.length;n++){const o=t[n];r.push(...e[o])}const s=new Q,l=new Float32Array(r);s.setAttribute("position",new de(l,3));const c=t.length,d=new de(new Float32Array(3*c),3);s.setAttribute("normal",d);for(let n=0;n<c;n++)d.setXYZ(n,0,0,0);const u=new de(new Float32Array([1,1,0,1,0,0,0,0,1,0,1,1]),2);s.setAttribute("uv",u);const p=new v({color:a,map:n,transparent:!0,blending:fe,side:pe}),h=new v({color:a,map:o,transparent:!0,blending:fe,side:pe});var m=new v({color:a,map:i,opacity:.5,transparent:!0,side:pe});const f=new w(s,p),g=new T,y=new w(s,h),x=new w(s,m);return g.add(f,y,x),g};return{createFence:(e,t=11009923)=>{const n=new T;var o=new he(e,t);o.update();const i=o.geometry.getAttribute("position").array,r=[];for(let a=0;a<i.length;a+=3){const e=i[a],t=i[a+1],n=i[a+2];r.push([e,t,n])}const s=a(r,[0,1,2,2,3,0],t),l=a(r,[4,5,6,6,7,4],t),c=a(r,[4,0,3,3,7,4],t),d=a(r,[1,5,6,6,2,1],t);return n.add(s,l,c,d),n},fenceAnimate:(e=1)=>{const i=.008*e;if(n){let e=n.offset.y-i;e<0&&(e=t),n.offset.y=e}if(o){let e=o.offset.y-i;e<0&&(e=t),o.offset.y=e}}}},useCorrugatedPlate:(e={})=>{let t=nt({range:100,interval:.8,size:.2,color:47273,light:881527,factor:1},e);const n=(e,t)=>{const n=e.material,o=n.uniforms.uRange.value,i=n.uniforms.uLength.value;n.uniforms.uRadius.value+=t*(o/4),n.uniforms.uRadius.value>=o+i&&(n.uniforms.uRadius.value=0)};return{createCorrugatedPlate:(e={})=>{t=nt(t,e);let{range:n,color:o,light:i,factor:a}=t;n*=a;const r=(()=>{let{range:e,interval:n,size:o,factor:i}=t;e*=i,n*=i,o*=i;const a=[],r=Math.floor(e/n);for(let t=-r;t<=r;t++)for(let e=-r;e<=r;e++){const i=new g(o,o),r=t*n,s=e*n,l=new Me,c=new P(r,-o,s),d=new ke,u=new Pe,p=new P(1,1,1);d.setFromEuler(u),l.compose(c,d,p),i.applyMatrix4(l),a.push(i)}return a})(),s=me(r),l=new ce({uniforms:{uColor:{value:new L(i)},uTcolor:{value:new L(o)},uRadius:{value:1.25},uLength:{value:n/10},uRange:{value:n}},vertexShader:"\n        varying vec3 vp;\n        void main(){\n          vp = position;\n          gl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        varying vec3 vp;\n        uniform vec3 uColor;\n        uniform vec3 uTcolor;\n        uniform float uRadius;\n        uniform float uLength;\n        float getLeng(float x, float y){\n          return  sqrt((x-0.0)*(x-0.0)+(y-0.0)*(y-0.0));\n        }\n        void main(){\n          float uOpacity = 0.8;\n          vec3 vColor = uColor;\n          float length = getLeng(vp.x,vp.z);\n          if ( length <= uRadius && length > uRadius - uLength ) {\n            float op = sin( (uRadius - length) / uLength ) ;\n            uOpacity = op;\n            if ( vp.y < 0.0 ) {\n              vColor = uColor * op;\n            } else {\n              vColor = uTcolor;\n            };\n            vColor = uTcolor;\n          }\n          gl_FragColor = vec4(vColor,uOpacity);\n        }\n      ",transparent:!0,depthWrite:!1,side:pe}),c=new w(s,l);return c.name="波纹板",c},update:n,corrugatedPlateUpdate:n}},useDiffusion:()=>{let e;return{createDiffusion:(t=10,n=16715760,o=5)=>{const i=new g(t,t,1,1),a=["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),r=["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","  float opacity = 1.0;","  if (index >= 1.0 - range) {","    opacity = 1.0 - (index - (1.0 - range)) / range;","  } else if(index <= range) {","    opacity = index / range;","  }","  return opacity;","}","float distanceTo(vec2 src, vec2 dst) {","  float dx = src.x - dst.x;","  float dy = src.y - dst.y;","  float dv = dx * dx + dy * dy;","  return sqrt(dv);","}","void main() {","  float iTime = -time * uSpeed;","  float opacity = 0.0;","  float len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","  float size = 1.0 / uSge;","  vec2 range = vec2(0.65, 0.75);","  float index = mod(iTime + len, size);","  vec2 cRadius = vec2(0.06, 0.12);","  if (index < size && len <= 0.5) {","    float i = sin(index / size * PI);","    if (i >= range.x && i <= range.y){","      float t = (i - range.x) / (range.y - range.x);","      float r = 0.3;","      opacity = drawCircle(t, r);","    }","    opacity *=  1.0 - len / 0.5;","  };","  gl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("");e=new ce({uniforms:{uColor:{value:new L(n)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:o},uRadius:{value:t/2},time:{value:0}},transparent:!0,vertexShader:a,fragmentShader:r,depthTest:!1,blending:fe,side:pe});return new w(i,e)},updateDiffusion:(t=1)=>{if(!e)return;const n=.001*performance.now()*t;e.uniforms.time.value=n}}},useFlywire:(e={})=>{let t,n,o=nt({depth:0,height:4,divisions:1e3,color:16777215,flyColor:16761095,pointColor:16715760,pointWidth:2.5,flyPointWidth:2.4,tubularSegments:256,radius:.5,radialSegments:8,closed:!1,length:100,factor:1,speed:4},e);const i=e=>{const[t,i]=e;let{pointWidth:a,depth:r,factor:s}=o;const l=a*s;r*=s;const c=new g(l,l,1,1),d=new w(c,n);return d.position.set(t,r,-i),d.rotateX(.5*-Math.PI),d},a=(e={})=>{o=nt(o,e),t=new ce({depthTest:!1,uniforms:{uColor:{value:new L(o.flyColor)},uIndex:{value:0},uTotal:{value:o.divisions},uWidth:{value:o.flyPointWidth},uLength:{value:o.length}},vertexShader:["attribute float aIndex;","uniform float uIndex;","uniform float uWidth;","uniform vec3 uColor;","varying float vSize;","uniform float uLength;","void main(){","    vec4 viewPosition = viewMatrix * modelMatrix * vec4(position,1);","    gl_Position = projectionMatrix * viewPosition;","    if(aIndex >= uIndex - uLength && aIndex < uIndex){","      vSize = uWidth * ((aIndex - uIndex + uLength) / uLength);","    }","    gl_PointSize = vSize;","}"].join(""),side:pe,fragmentShader:["varying float vSize;","uniform vec3 uColor;","void main(){","    if(vSize<=0.0){","      gl_FragColor = vec4(1,0,0,0);","    }else{","      gl_FragColor = vec4(uColor,1);","    }","}"].join(""),transparent:!0,vertexColors:!1}),n=new ce({uniforms:{uColor:{value:new L(o.pointColor)},uOpacity:{value:1},uSpeed:{value:.1},uSge:{value:4},uRadius:{value:o.pointWidth*o.factor/2},time:{value:0}},transparent:!0,depthTest:!1,vertexShader:["varying vec2 vUv;","void main() {","  vUv = uv;","  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(""),fragmentShader:["varying vec2 vUv;","uniform vec3 uColor;","uniform float uOpacity;","uniform float uSpeed;","uniform float uSge;","uniform float time;","float PI = 3.14159265;","float drawCircle(float index, float range) {","  float opacity = 1.0;","  if (index >= 1.0 - range) {","    opacity = 1.0 - (index - (1.0 - range)) / range;","  } else if(index <= range) {","    opacity = index / range;","  }","  return opacity;","}","float distanceTo(vec2 src, vec2 dst) {","  float dx = src.x - dst.x;","  float dy = src.y - dst.y;","  float dv = dx * dx + dy * dy;","  return sqrt(dv);","}","void main() {","  float iTime = -time * uSpeed;","  float opacity = 0.0;","  float len = distanceTo(vec2(0.5, 0.5), vec2(vUv.x, vUv.y));","  float size = 1.0 / uSge;","  vec2 range = vec2(0.65, 0.75);","  float index = mod(iTime + len, size);","  vec2 cRadius = vec2(0.06, 0.12);","  if (index < size && len <= 0.5) {","    float i = sin(index / size * PI);","    if (i >= range.x && i <= range.y){","      // 归一","      float t = (i - range.x) / (range.y - range.x);","      // 边缘锯齿范围","      float r = 0.3;","      opacity = drawCircle(t, r);","    }","    // 渐变","    opacity *=  1.0 - len / 0.5;","  };","  gl_FragColor = vec4(uColor, uOpacity * opacity);","}"].join("\n"),side:pe})},r=()=>{const e=t,i=e.uniforms.uTotal.value;e.uniforms.uIndex.value+=o.speed,e.uniforms.uIndex.value>=i&&(e.uniforms.uIndex.value=0);const a=.001*performance.now();n.uniforms.time.value=a};return a(),{createFlywireTexture:a,createFlywire:e=>{const n=new T,a=i(e[0]),r=i(e[1]);n.add(a,r);const s=(e=>{const[t,n]=e[0],[i,a]=e[1];let{depth:r,height:s,factor:l,divisions:c}=o;s=(r+s)*l,r*=l;const d=new P(t,r,-n),u=new P(t+(i-t)/4,s,-(n+(a-n)/4)),p=new P(t+3*(i-t)/4,s,-(n+3*(a-n)/4)),h=new P(i,r,-a);return new Ae(d,u,p,h).getPoints(c)})(e),l=new R(s,!1,"centripetal",.5),c=new K(l,o.tubularSegments,o.radius,o.radialSegments,o.closed),d=new ce({transparent:!0,opacity:1,depthTest:!1,vertexColors:!1,uniforms:{uColor:{value:new L(o.color)},uOpacity:{value:.6}},vertexShader:["varying vec3 vColor;","uniform vec3 uColor;","void main() {","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join(""),fragmentShader:["uniform vec3 uColor;","uniform float uOpacity;","void main() {","  gl_FragColor = vec4(uColor, uOpacity);","}"].join("")}),u=new w(c,d);u.renderOrder=10;const p=(e=>{const n=new Float32Array(e.map(((e,t)=>t))),o=(new Q).setFromPoints(e);return o.setAttribute("aIndex",new de(n,1)),new ue(o,t)})(s);return n.add(u,p),n},update:r,flywireUpdate:r}},useLensflare:(e={})=>{let t=nt({mainTextureUrl:je("lensflare0.png"),minorTextureUrl:je("lensflare3.png")},e);const n=new S,o=n.load(t.mainTextureUrl),i=n.load(t.minorTextureUrl);return{addLensflare:(e,t,n,a)=>{const r=new E(16777215,1,2e3,0);r.color.set(e),r.position.set(t,n,a);const s=new ge;return s.addElement(new ve(o,700,0,r.color)),s.addElement(new ve(i,60,.6)),s.addElement(new ve(i,70,.7)),s.addElement(new ve(i,120,.9)),s.addElement(new ve(i,70,1)),r.add(s),r}}},useFileLoader:()=>{const e=j(0);return{load:t=>{const n=new we;return new Promise(((o,i)=>{n.load(t,(e=>{let t={};try{t=JSON.parse(e)}catch(n){}o(t)}),(t=>{let{loaded:n,total:o}=t;e.value=Number((n/o*100).toFixed(0))}),i)}))},progress:e}},useUpload:e=>{const t=nt({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/"},e);return{uploadModel:(e,n,o)=>{const{baseUrl:i,dracoPath:a,basisPath:r}=t,s=e[0],l=s.name,c=l.split(".").pop().toLowerCase(),d=new FileReader;d.addEventListener("progress",(e=>{const t="("+Math.floor(e.total/1e3)+" KB)",n=Math.floor(e.loaded/e.total*100)+"%";o&&o({progress:n,filename:l,size:t})})),d.addEventListener("load",(e=>De(void 0,void 0,void 0,(function*(){const t=e.target.result;if(["glb","gltf"].includes(c)){const e=new q,o=new $;o.setDecoderPath(`${i}${a}`),e.setDRACOLoader(o);const s=new ee;s.setTranscoderPath(`${i}${r}`),e.setKTX2Loader(s),e.setMeshoptDecoder(te),e.parse(t,"",(t=>{var o,i,a;const r=t.scene.children;let s=new T;r.length>1?s.add(...r):s=r[r.length-1],s.name=(null===(o=s.userData)||void 0===o?void 0:o.name)||l,s.animations.push(...t.animations),n(s),null===(i=e.dracoLoader)||void 0===i||i.dispose(),null===(a=e.ktx2Loader)||void 0===a||a.dispose()}))}else if("fbx"==c){const e=(new ye).parse(t,"");n(e)}})))),d.readAsArrayBuffer(s)}}},useCollide:()=>{const e=new I,t=new P(0,2,0);return{checkCollide:(n,o,i,a=!0,r=t)=>{const s=o.clone().add(r),l=new P;n.getWorldDirection(l),l.normalize(),e.ray.origin.copy(s),e.ray.direction.copy(l);return e.intersectObjects(i,a)}}},useCoord:()=>({getBoundingBox:e=>{var t=new xe;t.expandByObject(e);var n=new P;t.getSize(n);var o=new P;return t.getCenter(o),{box3:t,center:o,size:n}}}),useRaycaster:()=>{const e=new I,t=new U,n={left:0,top:0};return{raycaster:e,pointer:t,style:n,update:(e,o,i=1)=>{const a=o.getBoundingClientRect()||{left:0,top:0};t.x=(e.clientX-a.left)/(o.clientWidth*i)*2-1,t.y=-(e.clientY-a.top)/(o.clientHeight*i)*2+1;const r=o.clientWidth/2,s=o.clientHeight/2;n.left=t.x*r+r,n.top=-t.y*s+s}}},useCruise:ct,useCSS2D:()=>({initCSS2DRender:(t,n)=>{const{width:o,height:i}=t,a=new e;return a.setSize(o,i),a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px",a.domElement.style.pointerEvents="none",n.appendChild(a.domElement),a},createCSS2DDom:e=>{const{name:t,className:n="",onClick:o,position:i}=e,a=document.createElement("div");a.innerHTML=t,a.className=n;const r=new Ce(a);return a.style.pointerEvents=o?"auto":"none",a.style.position="absolute","function"==typeof o&&a.addEventListener("click",(e=>o(e,r))),i&&r.position.set(...i),r}}),CSS2DRenderer:e,useCSS3D:rt,CSS3DRenderer:t,useFloor:(e={})=>{const t=nt({mode:"BA",margin:50},e),n=(e,t,n,o)=>{0!==t.length&&t.forEach((t=>{var i,a,r,s;const l=t._position_,c="UD"==e?(null!==(i=l.y)&&void 0!==i?i:0)+n:null!==(a=l.y)&&void 0!==a?a:0,d="BA"==e?(null!==(r=l.z)&&void 0!==r?r:0)+o:null!==(s=l.z)&&void 0!==s?s:0;new _(t.position).to({y:c,z:d},500).easing(M.Quadratic.Out).start()}))};return{floorAnimate:(e,o,i)=>{var a,r,s,l,c,d;const u=void 0!==o&&o>-1,{margin:p,mode:h}=t;for(let t=0;t<e.length;t++){const m=e[t],f=m._position_;const g=(t-(u?o:t))*p;let v=(null!==(a=f.y)&&void 0!==a?a:0)+g,w=o==t?(null!==(r=f.z)&&void 0!==r?r:0)+p:null!==(s=f.z)&&void 0!==s?s:0;const y=o===t&&("UD"===h&&v===m.position.y||"BA"===h&&w===m.position.z);if(y&&(v=null!==(l=f.y)&&void 0!==l?l:0,w=null!==(c=f.z)&&void 0!==c?c:0),"UD"===h){if(m.position.y===v)continue}else if("BA"===h&&m.position.z===w)continue;if(null===(d=m.data)||void 0===d?void 0:d.mark){const e=i(m.data.mark);let a=o==t?p:0;y&&(a=0),n(h,e,g,a)}new _(m.position).to({y:"UD"===h?v:m.position.y,z:"BA"===h?w:m.position.z},500).easing(M.Quadratic.Out).start()}}}},useDialog:(e={})=>{const t=Y(nt({show:!1,style:{left:"",top:""},select:[],data:{},title:"",position:{top:0,left:0}},e));return{dialog:t,options:t,show:V(t.show)}},useGrid:dt,useMaterial:()=>{const e=(e,t=.5)=>{const n=e=>{e.material.transparent=!0,e.material.opacity=t};e.isMesh?n(e):e.traverse((e=>{e.isMesh&&n(e)}))},t=e=>({color:e.color,map:e.map,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,emissiveMap:e.emissiveMap,bumpMap:e.bumpMap,normalMap:e.normalMap,displacementMap:e.displacementMap,opacity:e.opacity,transparent:e.transparent,side:e.side}),n=(e,o,i)=>{if(e instanceof Array){let t=e.map((e=>n(e,o,i)));e=t}else o?(e.metalness=.5,e.roughness=0):(e.metalness=.5,e.roughness=1),e=new Le(Object.assign(Object.assign({},t(e)),{metalness:e.metalness,roughness:e.roughness,side:i?pe:F}));return e},o=(e,t)=>{const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),n.href=URL.createObjectURL(e),n.download=t,n.click(),n.remove()};return{materialReplace:(t,o,i,a=1211922)=>{const r=Xe.mesh,s=r.animatehName,l=r.transparentName,{type:c,name:d}=i;if(c.indexOf("Light")>-1){if(!i.shadow)return;let e=800;if(i.castShadow=!0,i.shadow.camera.right=e,i.shadow.camera.left=-e,i.shadow.camera.top=e,i.shadow.camera.bottom=-e,"SpotLight"===c){let e=new Se(i,i.color);t.add(e)}}else if(o.transformMaterial&&i.isMesh)if(o.opacitySkin&&l.find((e=>d.indexOf(e)>-1))&&e(i,o.opacity),r.receiveShadowName.find((e=>d.indexOf(e)>-1))){i.receiveShadow=!0;const e=o.groundReflection;i.material=n(i.material,e,o.side)}else if(s.find((e=>d.indexOf(e)>-1))){let e=new Le({color:a,metalness:.6,roughness:.6});i.material=e}else i.isMesh&&(i.castShadow=!0,i.material=n(i.material,o.glisten,o.side))},changeTransparent:e,exportGlb:(e,t,n,i=!0)=>{if(!e)return;const a={binary:i,animations:t};(new ze).parse(e,(e=>{if(e instanceof ArrayBuffer)t=n+".glb",o(new Blob([e],{type:"application/octet-stream"}),t);else{((e,t)=>{o(new Blob([e],{type:"text/plain"}),t)})(JSON.stringify(e,null,2),n+".gltf")}var t}),(e=>{}),a)},getAnimations:e=>{const t=[];e.traverse((e=>{t.push(...e.animations)}));const n=[];for(const o of t)n.push(o.clone().optimize());return n},setMetalnessMaterial:(e={color:16777215},n,o)=>new Le(Object.assign(Object.assign({},t(e)),{metalness:n,roughness:o})),setGlassMaterial:(e={color:16777215},{metalness:n=0,roughness:o=0,envMapIntensity:i=0,transmission:a=0,ior:r=0})=>new _e(Object.assign(Object.assign({},t(e)),{metalness:n,roughness:o,envMapIntensity:i,transmission:a,ior:r})),centerBoxHelper:(e,t=16711680)=>{var n=new he(e,t);n.update();return{helper:n,center:(new xe).setFromObject(e).getCenter(new P)}}}},useMoveAnimate:()=>{let e;const t={index:0,length:0,runing:!1,model:void 0,speed:1,endCallback:void 0,rungingCall:void 0},n=t=>null==e?void 0:e.getPoints(t),o=(n=!0)=>{if(t.runing=!1,n){const n=t.index-1;t.model.position.copy((n=>{let o=n/t.length;return o>1?o=1:o<0&&(o=0),e.getPointAt(o)})(n))}};return{createMove:(o,i,a,r)=>{const s=o.position,l=Math.atan2(-i.z+s.z,i.x-s.x);o.rotation.y=.5*Math.PI+l;const c=s.distanceTo(i);let d=Math.floor(c/t.speed);d<2&&(d=2);e=new R([s,i],!1,"catmullrom",0),e=new R(n(d),!1,"catmullrom",0),t.model=o,t.index=0,t.length=d,t.rungingCall=a,t.endCallback=r,t.runing=!0},moveAnimate:(n=1)=>{if(!t.runing)return;t.index+=n;let i=t.index/t.length;i>1&&(i=1);const a=e.getPointAt(i);t.model.position.copy(a),i>=1?(t.runing=!1,"function"==typeof t.endCallback&&t.endCallback(a)):"function"==typeof t.rungingCall&&t.rungingCall(a,o)}}},useRoam:()=>{let e,t={runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0};const n=(n={})=>{if(e)return;t=nt({runing:!1,segment:2,close:!0,tension:0,offset:0,points:[],factor:1,speed:1,index:0,animateBack:void 0},n);const{points:i,tension:a,close:r}=t,s=[];for(let e=0;e<i.length;e++){const t=i[e];s.push(new P(t[0],t[1],t[2]))}e=new R(s,r,"catmullrom",null!=a?a:0),e=new R(o(),r,"catmullrom",null!=a?a:0)},o=()=>null==e?void 0:e.getPoints(i()),i=()=>{var e;return 1e3*(null!==(e=t.segment)&&void 0!==e?e:2)},a=(e,t)=>new P(t.x,t.y+e,t.z);return{createRoam:n,updateRoam:(e={})=>{t=nt(t,e)},executeRoam:(n,o)=>{if(!n||!o)return;if(!e)return;const{runing:r,offset:s,factor:l,speed:c,animateBack:d}=t;if(!r)return;t.index+=l*c;const u=i(),p=t.index%u/u;let h=p+.01;h>1&&(h-=1);const m=e.getPointAt(h),f=a(s,e.getPointAt(p)),g=a(s,m);o.target=g,n._lookAt_=g,n.lookAt(o.target),"function"==typeof d&&d(f,m,e,p)},pause:()=>{t.runing=!1},play:()=>{t.runing=!0},reset:t=>{e=void 0,n(t)},getStatus:()=>t.runing}},useKeyboardState:()=>{const e=["shift","ctrl","alt","meta"],t={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9},n={},o={};let i,a;const r=(e,t)=>{var i=e.keyCode;n[i]=t,o.shift=e.shiftKey,o.ctrl=e.ctrlKey,o.alt=e.altKey,o.meta=e.metaKey},s=e=>{r(e,!0),"function"==typeof i&&i(e)},l=e=>{r(e,!1),"function"==typeof a&&a(e)};document.addEventListener("keydown",s,!1),document.addEventListener("keyup",l,!1);const c=i=>{for(var a=i.split("+"),r=0;r<a.length;r++){var s=a[r];if(!(-1!==e.indexOf(s)?o[s]:-1!=Object.keys(t).indexOf(s)?n[t[s]]:n[s.toUpperCase().charCodeAt(0)]))return!1}return!0};return{keyboardPressed:e=>Array.isArray(e)?e.findIndex(c)>-1:c(e),insertEvent:(e,t)=>{i=e,a=t},destroyEvent:()=>{document.removeEventListener("keydown",s,!1),document.removeEventListener("keyup",l,!1)}}},useBackground:(e="")=>{const t=["216","217","218","219","220","221","222","223","224","225","226"],n=t.findIndex((t=>t==e)),o=j(n<0?0:n),i=e=>{const n=t[o.value];n&&(r(e,n),o.value++,o.value>=t.length&&(o.value=0))},a=e=>["posX.jpeg","negX.jpeg","posY.jpeg","negY.jpeg","posZ.jpeg","negZ.jpeg"].map((t=>((e,t)=>new URL(Object.assign({})[`../assets/imgs/sky/${e}/${t}`],self.location).href)(e,t))),r=(e={},t)=>{const n=a(t);if("function"==typeof e.setBgTexture)e.setBgTexture(n);else if(Array.isArray(n)){const t=(new C).load(n);e.background=t}else e.background=(new S).load(n)};return{skys:t,index:o,change:i,changeBackground:i,load:r,getBgGroup:a,backgroundLoad:r}},useModelLoader:(e={})=>{let t;const n=nt({baseUrl:"",dracoPath:"/three/draco/gltf/",basisPath:"/three/basis/",modelSizeKB:1048576,colors:{normal:{color:8954293},runing:{color:3045368},error:{color:12717056}},loadCache:!0,colorMeshName:[],indexDB:{cache:!0}},e),o=Y({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),i={base:"base",device:"device",font:"font",sprite:"sprite",pipe:"pipe",warning:"warning",remote:"remote",local:"local",disabled:"disabled",spotlight:"spotlight"},a=new Map,r=new $;r.setDecoderPath(n.baseUrl+n.dracoPath);const s=new q;s.setDRACOLoader(r);const l=new ee;l.setTranscoderPath(n.baseUrl+n.basisPath),s.setKTX2Loader(l),s.setMeshoptDecoder(te);const c=e=>{const t=e.loaded,n=o.total;let i=Number((t+o.loaded)/n*100);i>100&&(i=100),o.percentage=Number(i.toFixed(2))},d=(e,t,o,i)=>{if(!o)return;const{baseUrl:r,colorMeshName:s}=n,{mapUrl:l,key:c,mapMeshName:d,repeat:u=[1,1]}=e;let p;l&&d&&(p=(new S).load(Ue(l,r)),p.wrapS=D,p.wrapT=D,p.repeat.set(u[0],u[1]));const h=We(o);return h.traverse((e=>{e.isMesh&&p&&e.name.indexOf(d)>-1?e.material=new Z({side:pe,transparent:!0,opacity:0,map:p.clone()}):He(e,t,s||[])})),l&&d&&(h._mapMeshName_=d),h.animations=i,c&&a.set(c,h),h},u=(e,o=0)=>new Promise((i=>De(void 0,void 0,void 0,(function*(){var a;n.indexDB.cache||i(null);const r=z.get(e);if(r)r instanceof ArrayBuffer?(c({loaded:r.byteLength}),s.parse(r,"",(t=>{z.add(e,t),i(t)}))):(c({loaded:o*n.modelSizeKB}),setTimeout((()=>{i(r)}),10));else{const o=yield Ge(t,(null===(a=n.indexDB)||void 0===a?void 0:a.tbName)||Xe.indexdb.tbName,e);if(o&&o.data){const e=o.data;"string"==typeof e?(c({loaded:e.length}),z.add(o.path,e),setTimeout((()=>{i(e)}),10)):(c({loaded:e.byteLength}),s.parse(e,"",(e=>{z.add(o.path,e),i(e)})))}else i(null)}})))),p=e=>{var o;if(!n.indexDB.cache)return;const i=z.get(e);if(i&&t){const a=(null===(o=n.indexDB)||void 0===o?void 0:o.tbName)||Xe.indexdb.tbName;t.transaction(a,"readwrite").objectStore(a).add({path:e,data:i})}},h=(e,t)=>{const{key:o,url:i="",size:a=0}=e,{baseUrl:r,colors:l}=n;return new Promise(((n,h)=>De(void 0,void 0,void 0,(function*(){let m=l.normal[o]||l.normal.color;m=Ke(m)[0];const f=Ue(i,r),g=yield u(f,a);if(g){const t=g.scene.children[0],o=d(e,m,t,g.animations);return void n(o)}let v=(f.split(".").pop()||"").toLowerCase();if("glb"!==v)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+v);s.load(f,(t=>{const o=t.scene.children;let i=new T;o.length>1?i.add(...o):i=o[o.length-1];const a=d(e,m,i,t.animations);p(f),n(a)}),(e=>{c(e),"function"==typeof t&&t(e)}),h)}))))},m=(e,t={})=>{t=nt({color:57599,wireframe:!0,opacity:.5,filter:[],filterMatch:[]},t),e.traverse((e=>{var n;(null===(n=t.filter)||void 0===n?void 0:n.includes(e.name))||f(e.name,t.filterMatch)||e.isMesh&&(e.__material__||(e.__material__=e.material),e.material=new X({color:t.color,wireframe:t.wireframe,transparent:!0,opacity:t.opacity}))}))},f=(e="",t=[])=>t.filter((t=>e.indexOf(t)>-1)).length>0;return{progress:o,MODEL_MAP:i,loadModel:h,loadModels:(e,r,s)=>De(void 0,void 0,void 0,(function*(){var l,d,m;yield Ne((null===(l=n.indexDB)||void 0===l?void 0:l.tbName)||Xe.indexdb.tbName,(null===(d=n.indexDB)||void 0===d?void 0:d.dbName)||Xe.indexdb.dbName,(null===(m=n.indexDB)||void 0===m?void 0:m.version)||Xe.indexdb.version).then((e=>(e&&(z.enabled=!0,t=e),e)));const f=e.length;if(!(0==f?(o.isEnd=!0,o.show=!1,0):(o.isEnd=!1,o.percentage=0,o.show=!0,1)))return;(e=>{for(let t=0;t<e.length;t++)o.total+=(e[t].size||0)*n.modelSizeKB})(e);let g=0;const v=()=>De(void 0,void 0,void 0,(function*(){const t=e[g],{type:l=i.device,size:d=0}=t;switch(l){case i.device:case i.pipe:yield h(t,s);break;case i.sprite:(e=>{const{key:t,range:o={x:1,y:1},mapUrl:i=""}=e;let r=(new S).load(n.baseUrl+i),s=new Oe({map:r}),l=new Be(s),c=o.x,d=o.y;l.scale.set(c,d,1),l.name="sprite",a.set(t,l)})(t);break;case i.font:yield((e,t)=>{const{url:o="",size:r=0}=e,{baseUrl:s}=n,l=Ue(o,s),d=new Te;return new Promise(((e,n)=>De(void 0,void 0,void 0,(function*(){const o=yield u(l,r);if(o){const t=d.parse(JSON.parse(o));return a.set(i.font,t),void setTimeout((()=>{e(t)}),10)}d.load(l,(t=>{a.set(i.font,t),p(l),e(t)}),(e=>{c(e),"function"==typeof t&&t(e)}),n)}))))})(t,s);break;case i.warning:t.key=i.warning,yield h(t,s);break;case i.local:t.key=i.local,yield h(t,s);break;case i.disabled:t.key=i.disabled,yield h(t,s);break;case i.spotlight:(e=>{const{key:t,color:n=16777215,intensity:o=8,distance:i=10,angle:r=.2*Math.PI,penumbra:s=.2,decay:l=0}=e;let c=new Ee(n,o,i,r,s,l);c.castShadow=!0,c.visible=!1,a.set(t,c)})(t)}g++,o.loaded+=d*n.modelSizeKB,g>=f?(o.percentage=100,o.isEnd=!0,r()):v()}));v()})),getModel:e=>a.get(e),virtualization:(e=[],t,n={})=>{const o=n.filter||[],i=n.filterMatch||[];if(e.length)for(let a=0;a<e.length;a++){const r=e[a];t.uuid===r.uuid||o.includes(r.name)||f(r.name,i)||m(r,n)}else m(t,n)},closeVirtualization:e=>{if(Array.isArray(e))for(let t=0;t<e.length;t++)e[t].traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}));else e.traverse((e=>{e.isMesh&&e.__material__&&(e.material=e.__material__)}))}}}});const{createCruise:mt,cruiseAnimate:ft,updateCruise:gt,bindEvent:vt,removeEvent:wt}=ct(),{createFork:yt}=dt();class xt{constructor(e={}){ut.add(this);const t=at;this.options=nt(t,e),xt.total++,this.pointer={tsp:0,isClick:!1},et(this.options.container)?this.container=this.options.container:this.container=document.querySelector(this.options.container),this.options.width=this.container.offsetWidth,this.options.height=this.container.offsetHeight,this.scene=new n,this.renderer=this.initRenderer(),this.baseCamera=this.initCamera(),this.controls=this.initControls(),this.init(),this.initCruise()}get camera(){const{visible:e,runing:t,auto:n}=this.options.cruise;return e&&this.cruiseCamera&&t?this.cruiseCamera:this.baseCamera}init(){this.initLight(),this.initGrid(),this.initAxes(),this.initModel()}run(){this.loop()}loop(){this.animationId=window.requestAnimationFrame((()=>{this.loop()})),this.animate(),this.modelAnimate()}animate(){var e;this.renderer&&this.renderer.render(this.scene,this.camera),this.options.controls.visible&&(null===(e=this.controls)||void 0===e||e.update()),ft(this.cruiseCamera),o()}initModel(){}modelAnimate(){}initRenderer(){const{width:e,height:t,bgColor:n,bgUrl:o,env:s}=this.options,l=new i(this.options.render);if(s&&this.setEnvironment(s),o?this.setBgTexture(o):this.setBgColor(n),this.options.fog.visible){const{color:e,near:t,far:n}=this.options.fog;this.scene.fog=new a(null!=e?e:this.scene.background,t,n)}return l.sortObjects=!0,l.shadowMap.enabled=!0,l.shadowMap.type=r,l.setSize(e,t),l.setPixelRatio(window.devicePixelRatio),this.container.appendChild(l.domElement),l}initLight(){const{ambientLight:e,directionalLight:t}=this.options;if(e.visible){const t=new s(e.color,e.intensity);this.addObject(t)}if(t.visible){const e=this.createDirectionalLight(),[n=0,o=0,i=0]=t.position;if(e.position.set(n,o,i),this.addObject(e),t.helper){const t=new l(e,1);this.addObject(t)}if(t.light2){const e=this.createDirectionalLight(!1),[n=0,o=0,i=0]=t.position2;if(e.position.set(n,o,i),this.addObject(e),t.helper){const t=new l(e,1);this.addObject(t)}}}}createDirectionalLight(e=!0,t=2e3,n=4096,o=1,i=2e4){const{color:a,intensity:r}=this.options.directionalLight,s=new c(a,r);if(e){s.shadow.mapSize.setScalar(n),s.shadow.bias=-1e-5,s.shadow.normalBias=.01,s.castShadow=e;const a=s.shadow.camera;a.near=o,a.far=i,a.top=a.right=t,a.left=a.bottom=-t,a.updateProjectionMatrix()}return s}initCamera(){const{width:e,height:t,camera:n}=this.options;let o=new d(36,e/t,n.near,n.far);if(n.orthogonal){let i=e/t,a=260;o=new u(-a*i,a*i,a,-a,n.near,n.far)}if(o.position.set(...n.position),o.lookAt(0,0,0),n.helper){const e=new p(o);this.addObject(e)}return o}initControls(){const e=this.options.controls;if(!e.visible)return;const t=new h(this.camera,this.renderer.domElement);return Object.keys(e).forEach((n=>{t[n]=e[n]})),t.target.set(0,0,0),t.saveState(),t}initCruise(){const{visible:e}=this.options.cruise;e&&(this.cruiseCamera=this.initCamera(),function(e,t,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(e):o?o.value:t.get(e)}(this,ut,"m",pt).call(this))}initGrid(){const e=this.options.grid;if(!e.visible)return;const{width:t,divisions:n,centerLineColor:o,gridColor:i,opacity:a,transparent:r,fork:s}=e,l=new m(t,n,o,i);if(l.material.opacity=a,l.material.transparent=r,this.grid=l,this.addObject(l),s){const t=yt(e);t.name="辅助交叉点",t._isGridFork_=!0,this.addObject(t)}}initAxes(){if(!this.options.axes.visible)return;const e=new f(this.options.axes.size);this.addObject(e)}createGround(e=5e3,t,n=11721691){const o=new g(e,t=void 0===t?e:t),i=new v({color:n,shininess:10}),a=new w(o,i);return a.name="ground",a.rotation.x=1.5*Math.PI,a.receiveShadow=!0,a}createClock(){this.clock=new y}setCruisePoint(e){this.options.cruise.points=e,this.createCruise()}createCruise(){const{visible:e,points:t,alway:n}=this.options.cruise;if(!e)return;if(this.cruiseGroup&&this.disposeObj(this.cruiseGroup),vt(),!t||0==t.length)return;const o=mt(this.options.cruise,this.renderer);this.cruiseGroup=o,o.visible=n,this.addObject(o)}toggleCruise(e){let{visible:t,runing:n,auto:o,alway:i}=this.options.cruise;t&&(n=null!=e?e:n,this.options.cruise.runing=!n,this.options.cruise.enabled=!n,this.controls&&(this.controls.enabled=o||n),this.cruiseGroup&&!i&&(this.cruiseGroup.visible=!n),gt(this.options.cruise))}toggleCruiseDepthTest(e){this.cruiseGroup&&this.cruiseGroup.traverse((t=>{(t.isMesh||t.isLine)&&(t.material.depthTest=null!=e?e:!t.material.depthTest)}))}setScale(e){this.options.scale=e}setEnvironment(e){(new x).load(Ue(e,this.options.baseUrl),(e=>{e.mapping=b,this.scene.environment=e}))}setBgTexture(e){if(Array.isArray(e)){const t=(new C).load(Ue(e,this.options.baseUrl));this.scene.background=t}else this.scene.background=(new S).load(Ue(e))}setBgColor(e){this.scene.background=e?new L(e):null}bindEvent(){const e=this.renderer.domElement;e.addEventListener("dblclick",this.onDblclick.bind(this)),e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this))}onDblclick(e){}onPointerDown(e){this.pointer.isClick=!0,this.pointer.tsp=e.timeStamp}onPointerMove(e){}onPointerUp(e){this.pointer.isClick=!1}exportImage(){const e=document.createElement("a");e.download="render.png",e.href=this.renderer.domElement.toDataURL().replace("image/png","image/octet-stream"),e.click()}getPosition(){var e;return{position:this.camera.position,target:null===(e=this.controls)||void 0===e?void 0:e.target}}isCameraMove(e,t=1){const n=this.camera.position;return Math.abs(n.x-e.x)<t&&Math.abs(n.y-e.y)<t&&Math.abs(n.z-e.z)<t}addObject(...e){this.scene.add(...e)}controlSave(){var e;null===(e=this.controls)||void 0===e||e.saveState()}controlReset(){var e;null===(e=this.controls)||void 0===e||e.reset(),this.toggleCruise(!0)}getValidTargetPosition(e,t,n,o={x:-104,y:7,z:58}){const i=t||e.to||o,a=n||e.target||{x:0,y:0,z:0},r=this.controls;return r&&r.target&&r.target.set(a.x,a.y,a.z),i}resize(){this.options.width=this.container.offsetWidth||window.innerWidth,this.options.height=this.container.offsetHeight||window.innerHeight;const{width:e,height:t,camera:n}=this.options,o=e/t;n.orthogonal||(this.baseCamera.aspect=o),this.baseCamera.updateProjectionMatrix(),this.cruiseCamera&&(n.orthogonal||(this.cruiseCamera.aspect=o),this.cruiseCamera.updateProjectionMatrix()),this.renderer.setSize(e,t)}stopAnimate(){window.cancelAnimationFrame(this.animationId)}clear(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())}disposeObj(e){e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear(),this.scene.remove(e))}dispose(){var e;wt(),this.stopAnimate();try{z.clear(),this.disposeObj(this.scene),this.scene.clear(),this.renderer.dispose(),this.renderer.forceContextLoss();let t=this.renderer.domElement.getContext("webgl");t&&(null===(e=t.getExtension("WEBGL_lose_context"))||void 0===e||e.loseContext()),this.disposeObj(this.cruiseGroup),this.disposeObj(this.grid),this.controls&&this.controls.dispose(),this.scene=void 0,this.renderer=void 0,this.baseCamera=void 0,this.cruiseCamera=void 0,this.controls=void 0,this.grid=void 0,this.cruiseGroup=void 0,this.container.innerHTML=""}catch(t){}}}ut=new WeakSet,pt=function(){const e=this.options.cruise;e.enabled=!1,e.runing=!1,e.baseUrl&&(e.baseUrl=this.options.baseUrl),e.factor=1},xt.total=0;const bt=Object.freeze(Object.defineProperty({__proto__:null,Hook:ht,Scene:xt,Util:it},Symbol.toStringTag,{value:"Module"}));export{xt as S,bt as T};
