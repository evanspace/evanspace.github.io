var e=Object.defineProperty,t=(t,o,s)=>(((t,o,s)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s})(t,"symbol"!=typeof o?o+"":o,s),s);import{t as o}from"./index-9c43578f.js";import{e$ as s,f0 as i,f1 as n,dg as a,eL as r,eM as l,eO as c,ec as d,ds as h,bz as u,f3 as p,f6 as m,c as g,o as _,f as v,g as f,u as y,p as S,m as b,H as C,F as k,r as G,l as M,t as O,R as x,S as A,U as R,n as D,eG as P,eH as T,a8 as w,A as E,ag as N,h as j,z as L,w as I,X as U,f7 as F,a9 as V,aL as $,e as z,k as H}from"./vendor-e4ee7844.js";import{i as B,S as W,a as J,u as X}from"./scene-resize-407aeb45.js";import{d as K,A as Y,_ as q}from"./index-1d839e62.js";import{g as Z}from"./common-a56eaba7.js";import{u as Q}from"./sky-8d6b28da.js";const ee=["camera:roam","camera:cruise","camera:reset","camera:first","camera:three","camera:machineroom","person:add","person:sub","person:action","scene:pos","scene:test","dev:update","tag:status"];const te=new class{constructor(){t(this,"listteners",ee.reduce(((e,t)=>(e[t]=new Set,e)),{}))}on(e,t){this.listteners[e].forEach((o=>{o.toString()===t.toString()&&this.listteners[e].delete(o)})),this.listteners[e].add(t)}emit(e,...t){this.listteners[e].forEach((e=>e(...t)))}},oe="https://ye6.atomgit.net/3d-demo-data",se={baseUrl:oe,dotShowStrict:!0,clickIntervalTime:150,indexDB:{cache:!0,dbName:"THREE__STATION__GPU_DB",tbName:"TB",version:2},skyCode:"104",env:"/textures/hdr/6.hdr",bgSrc:oe+"/imgs/station/bg.jpg",fanceImgs:[oe+"/textures/station/fance.png"],sky:{day:"/textures/hdr/101.hdr",evening:"/textures/hdr/201.hdr",night:"/textures/hdr/301.hdr"},styleTimes:[[8,18],[18,20],[20,8]],moveFactor:1,personSightOffset:{x:0,y:3.5,z:.1},personSightClass:"person-sight",personKeys:[{code:"W",desc:"前进"},{code:"S",desc:"后退"},{code:"A",desc:"向左转向"},{code:"D",desc:"向右转向"},{code:"X",desc:"加速"},{code:"Z",desc:"减速"}],personDefaultAnimateName:"PlayOne-Headnod",personRuningAnimateName:"PlayOne-Walk",personRuningSpeed:5,diffusionImg:oe+"/textures/diffusion/101.png",cameraMaxDistance:{indoor:5,roam:1,threePerson:8},sightToggle:!1,dotVisibleDistance:{max:20,min:7},collisionSpace:1,groundMeshName:["行走地面","平面125","平面126","平面127","平面128","平面129","平面130","楼梯","机房地面","地面002","地面005","地面006","立方体128","立方体780_1","11111","22222"],cameraTransitionList:[{name:"一楼大门",to:{x:-1.3,y:6.2,z:102.3},target:{x:-1.4,y:5.8,z:97.4}}],machineRoomName:"机房"},{initCSS2DRender:ie,createCSS2DDom:ne}=B.useCSS2D(),{raycaster:ae,pointer:re,update:le,style:ce}=B.useRaycaster(),{pass:de,mrt:he,output:ue,emissive:pe,float:me}=p,ge=(e,t,o,a)=>{const r=de(e,t);a?r.setMRT(he({output:ue,emissive:pe})):r.setMRT(he({output:ue,bloomIntensity:me(.01)}));const l=r.getTextureNode();let c;if(a){const e=r.getTextureNode("emissive");c=s(e,2.5,.5)}else{const e=r.getTextureNode("bloomIntensity");c=s(l.mul(e))}o.toneMapping=i;const d=new n(o);return a?d.outputNode=l.add(c):(d.outputColorTransform=!1,d.outputNode=l.add(c).renderOutput()),d},_e=(e,t)=>ie(e,t),ve=(e,t)=>{const o=e.position,{size:s,color:i}=e.font||{},{x:n=0,y:a=0,z:r=0}=o||{},l=ne({name:`\n      <div class="bg"></div>\n      <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=i?`color: ${i}`:""}"></span>\n    `,className:"dot-2D-label",position:[n,a,r],onClick:t});return l.name=e.name+"_2D_Dot",l.userData.data=e,l.userData.position={x:n,y:a,z:r},l},fe=(e,t,o)=>{const s=new a;t.name=e.name;const i=e.position||{x:0,y:0,z:0},{to:n={x:i.x,y:i.y-2,z:i.z}}=e;if(t instanceof r||(t.target.position.set(n.x,n.y,n.z),s.add(t.target)),t.visible=!1,s.add(t),o)if(t instanceof r){const e=new l(t);s.add(e)}else{const e=new c(t,t.color);s.add(e)}return s},ye=(e,t)=>{const o=2*Math.random()-4+26;return void 0!==o&&(e.value=o),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{}}}},Se=(e,t,o)=>{var s;const i=t.data||t.userData.data,n=ye(i,e.dotGroup);"object"==typeof n&&Object.keys(n).forEach((e=>{i[e]=n[e]})),t.visible=i.show||!o;const a=null==(s=t.element)?void 0:s.getElementsByClassName("inner")[0];if(a){const{size:e,color:t}=i.font||{};null!=e&&(a.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(a.style.color=t),a.textContent=`${i.value||0}${i.unit??""}`}},be=(e,t=[],o=!0,s=1)=>{if(!t.length)return;const i=new d(e),n=t.reduce(((e,t)=>{const n=t.name||"";return e[n]=i.clipAction(t),o&&e[n].play(),e[n].timeScale=s,e}),{});e.userData.actions=n,e.userData.mixer=i},Ce=(e,t,o,s)=>{if("function"==typeof s&&s(e[0],ce),e.length){const s=e[0].object;if(t.style.cursor=s._isAnchor_?"pointer":"auto",!s._isAnchor_)return void(null==o||o.children.forEach((e=>{e.__change_color__=!1})));const i=s.material;void 0===s.__mat_color__&&(s.__mat_color__=i.color),i.color=new h(16715760),null==o||o.children.forEach((e=>{e.__change_color__=e.uuid===s.uuid}))}else t.style.cursor="auto",null==o||o.children.forEach((e=>{e.__change_color__=!1}))},ke=e=>{null==e||e.children.forEach((e=>{!e.__change_color__&&e.__mat_color__&&(e.material.color=e.__mat_color__)}))},Ge=(e,t=[])=>{const o=e=>{if(e._isBuilding_||t.includes(e.name))return e;let s=e.parent;return s?s&&s._isBuilding_?s:o(s):void 0};return o(e)},Me=e=>{const t=e.animations,o=new d(e),s={};for(let i=0;i<t.length;i++){const e=t[i],n=o.clipAction(e);s[e.name]=n}return{mixer:o,actions:s}},Oe=(e,t,o)=>{let{position:s,lookAt:i,curve:n,progress:a}=t;a+=.02,a>1&&(a-=1);const r=new u(0,.1,0);s=n.getPointAt(a).clone().add(r);let l=a+.001;if(l>1&&(l-=1),i=n.getPointAt(l),null==o?void 0:o.target){const e=new u(se.personSightOffset.x,se.personSightOffset.y,se.personSightOffset.z);o.target.copy(i.clone().add(e))}e.position.copy(s.clone().add(r));const c=Math.atan2(-i.z+s.z,i.x-s.x);e.rotation.y=.5*Math.PI+c},xe=(e,t,o,s,i,n)=>(le(e,t,o),ae.setFromCamera(re,s),ae.intersectObjects(i,n)),Ae=Object.freeze(Object.defineProperty({__proto__:null,Hooks:B,Scene:W,THREE:m,Utils:J,createCSS2DRender:_e,createDotCSS2DDom:ve,createLightGroup:fe,createModelAnimate:be,createPostProcessing:ge,cruiseTargetMove:Oe,dotUpdateObjectCall:ye,findParentIsBuilding:Ge,getIntersectObjects:xe,getModelAction:Me,hoverAnchor:Ce,restoreAnchorMaterial:ke,updateDotVisible:Se},Symbol.toStringTag,{value:"Module"})),Re={M_MAIN_SCENE:"MAIN_SCENE",M_MACHINE_ROOM:"MACHINE_ROOM",M_PERSON:"CHARACTER",M_FLOOR:"floor_common",M_WATER_PUMP:"WATER_PUMP",S_ANCHOR_POS:"ANCHOR_POS",S_ANCHOR_TARGET:"ANCHOR_TARGET",S_OPEN_DOOR:"OPEN_DOOR",S_LIGHT_SWITCH:"LIGHT_SWITCH",S_TAG_BUILDING:"TAG_BUILDING",S_TAG_CAMERA:"TAG_CAMERA",S_TAG_ROOM:"TAG_ROOM",L_WATTING_TOOM:"waiting_room_spot_light",DOT:"DOT",DOT3:"DOT3"},De={class:"scene-operation"},Pe=g({__name:"oprtation",props:{list:{},scene:{}},emits:["change"],setup(e,{expose:t,emit:o}){const s=e,i=o,n=()=>{var e;null==(e=s.scene)||e.getAll().forEach(((e,t)=>{var o;const i=e.data||(null==(o=e.userData)?void 0:o.data);if(!i||!s.scene)return;return i.type===Re.DOT?(Se(s.scene,e,se.dotShowStrict),void a(i)):void 0}))},a=e=>{var t,o;const{show:i,name:n}=e,a=null==(o=null==(t=s.scene)?void 0:t.deviceGroup)?void 0:o.getObjectByName(n);a&&a.userData.actions&&Object.keys(a.userData.actions).forEach((e=>{const t=a.userData.actions[e];i?(t.isRunning()||t.play(),t.paused=!1):t.paused=!0}))};return t({update:n}),(e,t)=>{const o=x,s=A,a=R;return _(),v("div",De,[f("div",{class:"btn",onClick:t[0]||(t[0]=()=>y(te).emit("scene:test"))},"测试"),f("div",{class:"btn",onClick:t[1]||(t[1]=()=>y(te).emit("scene:pos"))},"场景坐标"),S(a,{class:"btn",placement:"top","hide-on-click":!1},{dropdown:b((()=>[S(s,null,{default:b((()=>[S(o,{onClick:t[3]||(t[3]=()=>y(te).emit("camera:roam"))},{default:b((()=>t[12]||(t[12]=[C("全景漫游")]))),_:1}),S(o,{onClick:t[4]||(t[4]=()=>y(te).emit("camera:cruise"))},{default:b((()=>t[13]||(t[13]=[C("定点巡航")]))),_:1}),S(o,{onClick:t[5]||(t[5]=()=>y(te).emit("camera:first"))},{default:b((()=>t[14]||(t[14]=[C("第一人称")]))),_:1}),S(o,{onClick:t[6]||(t[6]=()=>y(te).emit("camera:three"))},{default:b((()=>t[15]||(t[15]=[C("第三人称")]))),_:1})])),_:1})])),default:b((()=>[f("div",{onClick:t[2]||(t[2]=()=>y(te).emit("camera:reset"))},"视角重置")])),_:1}),f("div",{class:"btn",onClick:t[7]||(t[7]=()=>y(te).emit("camera:machineroom"))},"制冷机房"),f("div",{class:"btn",onClick:t[8]||(t[8]=()=>n())},"设备更新"),S(a,{class:"btn",placement:"top","hide-on-click":!1},{dropdown:b((()=>[S(s,null,{default:b((()=>[(_(!0),v(k,null,G(e.list,(e=>(_(),M(o,{class:"item",onClick:t=>i("change",e)},{default:b((()=>[C(O(e.name),1)])),_:2},1032,["onClick"])))),256))])),_:1})])),default:b((()=>[t[16]||(t[16]=f("div",null,"区域视角",-1))])),_:1}),S(a,{class:"btn",placement:"top","hide-on-click":!1},{dropdown:b((()=>[S(s,null,{default:b((()=>[S(o,{onClick:t[10]||(t[10]=()=>y(te).emit("person:add"))},{default:b((()=>t[17]||(t[17]=[C("人物加速+")]))),_:1}),S(o,{onClick:t[11]||(t[11]=()=>y(te).emit("person:sub"))},{default:b((()=>t[18]||(t[18]=[C("人物减速-")]))),_:1})])),_:1})])),default:b((()=>[f("div",{onClick:t[9]||(t[9]=()=>y(te).emit("person:action"))},"人物动作")])),_:1})])}}}),Te=q(g({__name:"first-person",setup(e){const t=se.personKeys||[];return(e,o)=>(_(),v("div",{class:D([e.$style.page,y(se).personSightClass])},[f("div",{class:D(e.$style.tip)},[(_(!0),v(k,null,G(y(t),(t=>(_(),v("div",{class:D(e.$style.item)},[f("span",null,O(t.code),1),f("span",null,O(t.desc),1)],2)))),256))],2),f("div",{class:D(e.$style.center)},null,2)],2))}}),[["__cssModules",{$style:{page:"_page_13ksh_2",tip:"_tip_13ksh_15",item:"_item_13ksh_22",center:"_center_13ksh_34"}}]]),we=["innerHTML"],Ee=q(g({__name:"tip-msg",props:P({style:{},msg:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=T(e,"modelValue");return(e,o)=>t.value?(_(),v("div",{key:0,class:D(e.$style.page),style:w({left:e.style.left+"px",top:e.style.top+"px"})},[f("div",{class:D(e.$style.msg),innerHTML:e.msg},null,10,we)],6)):E("",!0)}}),[["__cssModules",{$style:{page:"_page_y1ap3_2",msg:"_msg_y1ap3_24"}}]]),Ne=q(g({__name:"dialog",props:P({title:{},list:{default:()=>[]}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=T(e,"modelValue");return(e,o)=>t.value?(_(),v("div",{key:0,class:D(e.$style.dialog)},[f("div",{class:D(e.$style.wrap)},[f("div",null,O(e.title),1),f("div",{class:D(e.$style.content)},[(_(!0),v(k,null,G(e.list,(t=>(_(),v("div",{class:D(e.$style.item)},[f("span",null,O(t.name)+"：",1),f("span",null,O(t.value)+O(t.unit||""),1)],2)))),256))],2)],2)],2)):E("",!0)}}),[["__cssModules",{$style:{dialog:"_dialog_9g6oi_2",wrap:"_wrap_9g6oi_10",title:"_title_9g6oi_32",content:"_content_9g6oi_35",item:"_item_9g6oi_38"}}]]),je=["title","onClick"],Le=q(g({__name:"type",emits:["change"],setup(e,{emit:t}){const o=N("open",!1),s=j([{name:"监控",key:Re.S_TAG_CAMERA,icon:"jiankong",value:1},{name:"站房",key:Re.S_TAG_ROOM,icon:"jifang",value:1},{name:"楼栋",key:Re.S_TAG_BUILDING,icon:"loudong",value:1}]),i=t;return(e,t)=>{const n=L("svg-icon");return _(),v("div",{class:D({[e.$style.page]:!0,[e.$style["is-open"]]:y(o)})},[(_(!0),v(k,null,G(y(s),(t=>(_(),v("div",{class:D({[e.$style.item]:!0,[e.$style["is-active"]]:Boolean(t.value)}),title:t.name,onClick:e=>(e=>{e.value=0==e.value?1:0,te.emit("tag:status",e),i("change",e)})(t)},[f("div",{class:D(e.$style.wrap)},[f("div",{class:D(e.$style.icon)},[S(n,{name:"p-"+t.icon},null,8,["name"])],2)],2)],10,je)))),256))],2)}}}),[["__cssModules",{$style:{page:"_page_1tjf0_2","is-open":"_is-open_1tjf0_11",item:"_item_1tjf0_15","is-active":"_is-active_1tjf0_23",wrap:"_wrap_1tjf0_36",icon:"_icon_1tjf0_44"}}]]),Ie=["onClick"],Ue=q(g({__name:"dialog-room",props:P({id:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=e,o=T(e,"modelValue"),s=j([]);return I(o,(()=>{o.value&&(console.log(t.id),Z("-L01空调冷站").then((e=>{s.value=e.map((e=>({...e,value:Math.random()>.5?1:0})))})))}),{immediate:!0}),(e,t)=>o.value?(_(),v("div",{key:0,class:D(e.$style.page)},[f("div",{class:D(e.$style.wrapper)},[(_(!0),v(k,null,G(y(s),(t=>(_(),v("div",{class:D({[e.$style.item]:!0,[e.$style["is-error"]]:0===t.value}),onClick:e=>(e=>{console.log(e)})(t)},[f("div",{class:D(e.$style.name)},O(t.name),3)],10,Ie)))),256))],2)],2)):E("",!0)}}),[["__cssModules",{$style:{page:"_page_yf8pg_2",wrapper:"_wrapper_yf8pg_8",item:"_item_yf8pg_33","is-error":"_is-error_yf8pg_44",name:"_name_yf8pg_48"}}]]),Fe=["src"],Ve=q(g({__name:"dialog-camera",props:P({id:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:["update:modelValue"],setup(e){const t=e,o=T(e,"modelValue"),s=U({video:"",name:""}),i=F("videoRef"),n=()=>{const e=i.value;if(!e)return;e.muted=!0,e.play();const t=new AudioContext,o="running"===t.state;t.close(),console.log(t),o&&(e.muted=!1)};return I(o,(()=>{o.value&&(console.log(t.id),s.name="地下室入口",s.video="./imgs/project/001.mp4",V((()=>{console.log(i.value),n()})))}),{immediate:!0}),(e,t)=>{const i=L("svg-icon");return o.value?(_(),v("div",{key:0,class:D(e.$style.page)},[f("div",{class:D(e.$style.wrapper)},[f("div",{class:D(e.$style.video)},[f("video",{ref:"videoRef",src:y(s).video,autoplay:"",controls:"",loop:""},null,8,Fe)],2),f("div",{class:D(e.$style.pos)},[f("div",{class:D(e.$style.name)},O(y(s).name),3),S(i,{name:"p-dingwei"})],2)],2)],2)):E("",!0)}}}),[["__cssModules",{$style:{page:"_page_v7ski_2",wrapper:"_wrapper_v7ski_8",video:"_video_v7ski_29",pos:"_pos_v7ski_36",name:"_name_v7ski_44"}}]]),{Utils:$e,Hooks:ze,THREE:He}=Ae,{createRoam:Be,executeRoam:We,pause:Je,play:Xe,getStatus:Ke}=ze.useRoam(),{floorAnimate:Ye}=ze.useFloor(),{keyboardPressed:qe,destroyEvent:Ze,insertEvent:Qe}=ze.useKeyboardState(),{createMove:et,moveAnimate:tt,stop:ot}=ze.useMoveAnimate(),{createDiffusion:st}=ze.useDiffusion2(),{checkCollide:it}=ze.useCollide(),{oddRotate:nt}=ze.useOpenTheDoor(),{virtualization:at,closeVirtualization:rt}=ze.useModelLoader({}),{createFence:lt,fenceAnimate:ct}=ze.useFence({imgs:se.fanceImgs}),dt="SCREEN",ht="PERSON_FIRST",ut="PERSON_THREE";class pt extends W{constructor(e,o){super(e),t(this,"postProcessing"),t(this,"buildingGroup"),t(this,"deviceGroup"),t(this,"anchorGroup"),t(this,"dotGroup"),t(this,"lightGroup"),t(this,"floorGroup"),t(this,"fence"),t(this,"extend"),t(this,"css2DRender"),t(this,"diffusion",new He.Mesh),t(this,"animateModels",[]),t(this,"person"),t(this,"personSightOffset",new He.Vector3(se.personSightOffset.x,se.personSightOffset.y,se.personSightOffset.z)),t(this,"moveFactor",se.moveFactor),t(this,"currentSight",dt),t(this,"controlCache",{target:new He.Vector3,cameraPosition:new He.Vector3,maxDistance:0,personPosition:new He.Vector3}),t(this,"ambientLight",new He.AmbientLight),t(this,"directionalLight",new He.DirectionalLight),t(this,"sky",se.sky),t(this,"style",-1),t(this,"styleTimes",se.styleTimes),t(this,"collisionSpace",se.collisionSpace),this.extend=o,this.postProcessing=ge(this.scene,this.camera,this.renderer),this.pmremGenerator=new He.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader(),this.css2DRender=_e(this.options,this.container),this.addDotGroup(),this.createClock(),this.addBuildingGroup(),this.addDeviceGroup(),this.addFloorGroup(),this.addAnchorGroup(),this.addLightGroup(),this.addDiffusion(),this.findLight(),this.bindEvent()}modelAnimate(){var e,t;let o=null==(e=this.clock)?void 0:e.getDelta();null==(t=this.css2DRender)||t.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.anchorAnimateUpdate(o),this.modelAnimateUpdate(o),We(this.camera,this.controls),this.personAnimate(o),ke(this.anchorGroup),ct()}addDotGroup(){if(!this.css2DRender)return;this.css2DRender.domElement.className="three-scene__dot-wrap";const e=new He.Group;e.name="点位组",e.visible=!1,this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){if(!this.dotGroup)return new He.Mesh;const o=ve(e,t);return this.dotGroup.add(o),o}addBuildingGroup(){const e=new He.Group;e.name="建筑组",this.buildingGroup=e,this.addObject(e)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearDevice(),this.clearAnchor(),this.clearDot(),this.clearFloor()}addBuilding(...e){this.buildingGroup&&this.buildingGroup.add(...e)}addDeviceGroup(){const e=new He.Group;e.name="设备组",this.deviceGroup=e,this.addObject(e)}clearDevice(){this.deviceGroup&&this.disposeObj(this.deviceGroup),this.addDeviceGroup()}addDevice(...e){this.deviceGroup&&this.deviceGroup.add(...e)}addFloorGroup(){const e=new He.Group;e.name="楼层组",this.floorGroup=e,this.addObject(e)}clearFloor(){this.floorGroup&&this.disposeObj(this.floorGroup),this.addFloorGroup()}addFloor(...e){this.floorGroup&&this.floorGroup.add(...e)}addAnchorGroup(){const e=new He.Group;e.name="锚点组",this.anchorGroup=e,this.addObject(e)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(e,t){if(this.anchorGroup&&this.anchorGroup.add(e),!t)return;const{x:o,y:s,z:i}=e.position;$e.createSpriteAnimate(e,[o,s,i],1,8)}anchorAnimateUpdate(e){var t;null==(t=this.anchorGroup)||t.children.forEach((t=>{t.__mixer__&&t.__mixer__.update(e)}))}anchorToggle(e,t){var o;null==(o=this.anchorGroup)||o.children.forEach((o=>{const s=o.data;(null==s?void 0:s.type)===e&&(o.visible=t)}))}addLightGroup(){const e=new He.Group;e.name="灯光组",this.lightGroup=e,this.addObject(e)}addLight(e,t,o){if(!this.lightGroup)return;const s=fe(e,t,o);this.lightGroup.add(s)}lightSwitch(e,t,o){var s,i;const n=null==(i=this.lightGroup)?void 0:i.getObjectsByProperty("name",null==(s=e.data)?void 0:s.bind);n&&n.forEach(((e,s)=>{let i=!(null!=o&&o>=0)&&(null!=t?t:!e.visible);null!=o&&o>=0&&s<o&&(i=null==t||t),e.visible=i}))}closeLightGroup(e=!1){var t;null==(t=this.lightGroup)||t.traverse((t=>{(t.isSpotLight||t.isRectAreaLight)&&(t.visible=e)}))}addPerson(e){this.person=e;const{mixer:t,actions:o}=Me(e),s=o[se.personDefaultAnimateName];s.play();const i=o[se.personRuningAnimateName];e.userData.mixer=t,e.userData.actions=o,e.userData.runging=i,e.userData.defaultAction=s,this.addObject(e),this.addPersonEvent()}personWalk(e=!0){const t=this.person;if(!t)return;const{defaultAction:o,runging:s}=t.userData;e?(s.play(),o.stop()):(o.play(),s.stop())}addPersonEvent(){const e=this.person;if(!e)return;const t=["W","S"].map((e=>e.toUpperCase().charCodeAt(0))).concat([38,40]),{__runing__:o}=e.userData;Qe((e=>{o||this.isCruise()||!this.isPersonSight()||(t.includes(e.keyCode)&&this.personWalk(),this.isPersonSight()&&(qe("X")&&this.personSpeed(1),qe("Z")&&this.personSpeed(-1)))}),(e=>{o||this.isCruise()||!this.isPersonSight()||t.includes(e.keyCode)&&this.personWalk(!1)}))}isPersonSight(){return this.currentSight===ht||this.currentSight===ut}isFirstPersonSight(){return this.currentSight===ht}personSpeed(e=1){this.moveFactor+=e,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),$.success({message:"人物速度："+this.moveFactor,grouping:!0})}clsoePerson(){var e;this.currentSight=dt,(null==(e=this.person)?void 0:e.userData.__runing__)&&(ot(!1),this.person.userData.__runing__=!1,this.diffusion.visible=!1,this.personWalk(!1)),this.person&&(this.person.visible=!0),this.togglePersonView()}togglePersonView(){var e;const t=null==(e=this.container.parentNode)?void 0:e.querySelector("."+se.personSightClass);if(!t)return;const o=this.isPersonSight();t.style.display=o?"block":"none"}togglePersonSight(e){if(!se.sightToggle){if(1==e&&this.currentSight===ht)return;if(3==e&&this.currentSight===ut)return}this.closeCruise(),this.closeRoam(),se.sightToggle?this.currentSight=this.isPersonSight()?dt:1==e?ht:ut:this.currentSight=1==e?ht:ut,this.togglePersonView(),this.cameraChangeByPerson(),this.controlsLimitSet()}cameraChangeByPerson(){if(!this.person||!this.controls)return;const e=this.isPersonSight(),t=this.person.position;let{target:o,to:s}=this.getControlsCache();const i=this.personSightOffset.clone();if(e){$.success({message:`鼠标点击地面移动，或键盘按键 ${se.personKeys.map((e=>`${e.code} ${e.desc}`)).join("、")}，来控制人物！`,grouping:!0}),this.setControlCache();const e=t.clone().add(i);this.isFirstPersonSight()?this.keyboardToTotation(!0):(this.camera.lookAt(e),this.controls.target.copy(t.clone().add(i))),Math.abs(this.camera.position.y-e.y)>8&&(this.camera.position.y=e.y)}else this.camera.position.copy(s),this.camera.lookAt(this.controls.target),this.controls.target.copy(o)}keyboardToTotation(e){const t=this.person;if(!t)return;const o=new He.Vector3;null==t||t.getWorldDirection(o);const s=this.camera.position.clone(),i=s.y,n=s.sub(t.position.clone().setY(i)).length(),a=o.clone().multiplyScalar(-n);this.camera.position.copy(t.position.clone().setY(i).add(a)),e&&this.setControlTarget(null==t?void 0:t.position)}controlsLimitSet(){if(!this.controls)return;const e=this.currentSight,t=e===ht,o=t||e===ut;this.controls.maxDistance=o?t?0:se.cameraMaxDistance.threePerson:this.controlCache.maxDistance,this.controls.screenSpacePanning=!o,this.controls.enablePan=!o,this.person&&(this.person.visible=!t)}personAnimate(e){const t=this.person;if(t){if(t.userData.mixer.update(e),tt(.2*this.moveFactor),this.isPersonSight()&&!t.userData.__runing__){const o=1+this.moveFactor/5,s=se.personRuningSpeed*e*o,i=.2*Math.PI*e*o;this.keyboardToMove(s),qe(["A","left"])?(t.rotation.y+=i,this.keyboardToTotation()):qe(["D","right"])&&(t.rotation.y-=i,this.keyboardToTotation())}}}keyboardToMove(e){const t=this.person;if(!t)return;const o=qe(["S","down"]);if(qe(["W","up"])||o){const s=new He.Vector3;null==t||t.getWorldDirection(s);const i=s.clone().multiplyScalar(o?-e:e),n=(null==t?void 0:t.position.clone().add(i))||new He.Vector3;this.checkCharacterCollide(n)||(null==t||t.position.copy(n),this.setControlTarget(t.position))}}checkCharacterCollide(e,t=.3){var o;if(!this.person)return;const s=it(this.person,e,(null==(o=this.buildingGroup)?void 0:o.children)||[],!0,new He.Vector3(0,t,0));if(s.length){if(s[0].distance<this.collisionSpace)return this.log("撞到了！"),!0}}personMove(e){if(this.judgeCruise())return Promise.reject();if(!this.isPersonSight())return Promise.reject();const t=this.person;if(!t)return Promise.reject();const o=e.point,s=this.diffusion;return this.personWalk(),s.position.copy(o.clone().add(new He.Vector3(0,.05,0))),s.visible=!0,new Promise((e=>{t.userData.__runing__=!0,et(t,o,((e,o)=>{this.setControlTarget(e),this.checkCharacterCollide(e,.3)&&(o(),this.personWalk(!1),t.userData.__runing__=!1,s.visible=!1)}),(o=>{this.setControlTarget(o),this.personWalk(!1),t.userData.__runing__=!1,s.visible=!1,e(t)}))}))}floorExpand(e){const t=e.data;if(!t)return;const o=this.getFloorByGroup(t.group);if(!o.length)return;const s=o.findIndex((t=>e.uuid===t.uuid));Ye(o,s,(e=>this.getFlowMark(e)))}getMachineRoomStatus(e){const t=this.scene.getObjectByName(e);return{isFocus:null==t?void 0:t.__isFocus__,room:t}}toCoolMachineRoom(){var e,t;this.closeRoam(),this.clsoePerson(),this.closeCruise(),this.clsoePerson();const{room:o,isFocus:s}=this.getMachineRoomStatus(se.machineRoomName);if(o){if(o.__isFocus__=!s,s)return rt(null==(e=this.buildingGroup)?void 0:e.children),void this.toggleCoolMachineRoomFocus(!1);this.toggleCoolMachineRoomFocus(!0),at((null==(t=this.buildingGroup)?void 0:t.children)||[],o,{wireframe:!0,hidden:!0,opacity:.1,filter:[]})}else $.warning({message:"未找到机房模块！",grouping:!0})}toggleCoolMachineRoomFocus(e){if(!this.controls)return;let{target:t,to:o,maxDistance:s}=this.getControlsCache();e&&(this.setControlCache(),t=new He.Vector3(-78.4,-33,29.2),o=new He.Vector3(-3.62,-27.53,18.14),s=320),this.controls.maxDistance=s,this.dotGroup&&(this.dotGroup.visible=e),$e.cameraLinkageControlsAnimate(this.controls,this.camera,o,t)}clearCoolMachineRoomFocus(){var e;const{room:t,isFocus:o}=this.getMachineRoomStatus(se.machineRoomName);o&&rt(null==(e=this.buildingGroup)?void 0:e.children),t.__isFocus__=!1,this.dotGroup&&(this.dotGroup.visible=!1)}closeRoom(){const{isFocus:e}=this.getMachineRoomStatus(se.machineRoomName);e&&this.clearCoolMachineRoomFocus()}addDiffusion(){const e=st({textureSrc:se.diffusionImg,bloomIntensity:.2},He);e.position.y=.5,e.visible=!1,this.addObject(e),this.diffusion=e}oddRotateDoor(e){if(!e.data)return;const{bind:t,axle:o="y",internal:s,autoClose:i=!1}=e.data;return nt(this.scene,{value:t,axle:o,angle:Math.PI*(s?-.5:.5),autoClose:i})}cameraLookatMoveTo(e){this.controls&&$e.cameraLookatAnimate(this.camera,e,this.controls.target)}cameraTransition(e){var t;if(!e.data)return;const{to:o,target:s=e.position}=e.data;if(!o)return;if(!this.isCameraMove(o)&&this.controls){this.closeRoam(),this.clsoePerson(),this.closeCruise(),this.clsoePerson(),this.controls.enablePan=!0;const e=new He.Vector3(o.x,o.y,o.z).distanceTo(new He.Vector3(s.x,s.y,s.z));this.controls.maxDistance=e,$e.cameraLinkageControlsAnimate(this.controls,this.camera,o,new He.Vector3(s.x,s.y,s.z))}const{bind:i}=e.data;if(!i)return;const n=null==(t=this.buildingGroup)?void 0:t.getObjectByName(i);n&&this.addFence(n)}addFence(e){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),e){const t=lt(e,5439406,!0,He);this.fence=t,this.addObject(t)}}cameraTransitionByModelname(e){const t=se.cameraTransitionList.find((t=>t.name===e));t&&this.cameraTransition({data:t})}addModelAnimate(e,t=[],o=!0,s=1){be(e,t,o,s),this.animateModels.push(e)}modelAnimateUpdate(e){this.animateModels.length&&this.animateModels.forEach((t=>{t.userData&&t.userData.mixer&&t.userData.mixer.update(e)}))}controlReset(){if(this.closeRoam(),this.clsoePerson(),this.closeRoom(),!this.controls)return;const e=this.options.controls;Object.keys(e).forEach((t=>{this.controls&&(this.controls[t]=e[t])})),super.controlReset()}setControlCache(){if(!this.controls)return;const e=this.controlCache;e.target=e.target.copy(this.controls.target),e.cameraPosition=e.cameraPosition.copy(this.camera.position),e.maxDistance=this.controls.maxDistance}getControlsCache(){const e=this.controlCache;return{target:e.target,to:e.cameraPosition,maxDistance:e.maxDistance}}setControlTarget(e){if(!this.controls)return;const t=this.camera,o=this.controls,s=e.clone().add(this.personSightOffset.clone());t.position.sub(o.target),o.target.copy(s),t.position.add(s)}toggleCruise(e){var t,o;if(!se.sightToggle&&!(e=!1)===this.options.cruise.runing)return;this.clsoePerson(),this.person&&(this.person.visible=!1),this.closeRoam(),this.closeRoom();!(e??this.options.cruise.runing)&&this.person?(this.controlCache.personPosition.copy(null==(t=this.person)?void 0:t.position),this.personWalk()):(null==(o=this.person)||o.position.copy(this.controlCache.personPosition),this.personWalk(!1)),super.toggleCruise(e),setTimeout((()=>{this.person&&(this.person.visible=!0)}),30)}cruiseStatusCall({enabled:e,runing:t}){e&&this.personWalk(t)}cruiseAnimateCall(e){e.enabled&&this.person&&Oe(this.person,e,this.controls)}closeCruise(){var e;const t=this.options.cruise.runing;super.closeCruise(),t&&(null==(e=this.person)||e.position.copy(this.controlCache.personPosition),this.personWalk(!1),this.personWalk(!1))}setCruisePoint(e){super.setCruisePoint(e),this.toggleCruiseBloom(!0,He)}judgeCruise(){return!!this.options.cruise.runing&&($.warning({message:"请退出巡航！",grouping:!0}),!0)}toggleRoam(){if(this.closeCruise(),this.clsoePerson(),this.closeRoom(),this.closeRoam())return;const e=this.extend.roamPoints||[];0!=e.length&&this.controls&&(this.controls.maxDistance=se.cameraMaxDistance.roam,Be({points:e,segment:12,tension:.5,speed:2,close:!0,factor:1}),Xe())}setRoamPoint(e){this.extend.roamPoints=e}closeRoam(){return!!Ke()&&(this.controls&&(this.controls.maxDistance=this.options.controls.maxDistance),Je(),!0)}setDblclickModelName(e){this.extend.dblclickModelName=e}onDblclick(e){var t;if(this.floorGroup&&this.buildingGroup){const o=this.floorGroup.children.concat(this.buildingGroup.children),s=xe(e,this.container,this.options.scale,this.camera,o,!0);if(s.length){const e=s[0].object,o=Ge(e,this.extend.dblclickModelName);if(!o)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(o)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<se.clickIntervalTime;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button&&o&&this.checkIntersectObjects(e)}checkIntersectObjects(e){var t,o,s,i,n;let a="pointerdown"==e.type||"pointerup"==e.type;this.pointer.isClick&&this.person&&this.isFirstPersonSight()&&(this.person.rotation.y-=this.movementXToAngle(e.movementX));const r=(null==(o=this.buildingGroup)?void 0:o.children.filter((e=>e.visible&&(a||e.__ground__))).concat((null==(t=this.anchorGroup)?void 0:t.children)||[]))||[],l=xe(e,this.container,this.options.scale,this.camera,r,a);if(a||Ce(l,this.container,this.anchorGroup,this.extend.onHoverCall),a)if(l.length){const e=l[0],t=e.object;this._isTest&&console.log(e);const o=Ge(t);if("string"==typeof t.name&&se.groundMeshName.some((e=>t.name.indexOf(e)>-1))&&"function"==typeof(null==(s=this.extend)?void 0:s.onClickGround)&&this.extend.onClickGround(o,e),!o)return;"function"==typeof(null==(i=this.extend)?void 0:i.onClickLeft)&&this.extend.onClickLeft(o,e)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft()}getAll(){var e,t,o,s;return(null==(s=this.buildingGroup)?void 0:s.children.concat((null==(e=this.dotGroup)?void 0:e.children)||[]).concat((null==(t=this.floorGroup)?void 0:t.children)||[]).concat((null==(o=this.anchorGroup)?void 0:o.children)||[]))||[]}getFloorByGroup(e){var t;return null==(t=this.floorGroup)?void 0:t.children.filter((t=>t.data.group===e))}getFlowMark(e){return this.getAll().filter((t=>{var o;return(null==(o=t.data)?void 0:o.followMark)===e}))}createRender(){return new He.WebGPURenderer(this.options.render)}createScene(){return new He.Scene}createDirectionalLight(e,t){return new He.DirectionalLight(e,t)}createAmbientLight(e,t){return new He.AmbientLight(e,t)}render(){var e;null==(e=this.postProcessing)||e.renderAsync()}run(){return this.renderer.setAnimationLoop((()=>{this.animate(),this.modelAnimate()})),this}resize(){var e;super.resize();const{width:t,height:o}=this.options;null==(e=this.css2DRender)||e.setSize(t,o)}findLight(){const e=this.scene.getObjectByProperty("isAmbientLight",!0);this.ambientLight=e;const t=this.scene.getObjectByProperty("isDirectionalLight",!0);this.directionalLight=t}toByday(e=1){this.style=e;const{ambientLight:t,directionalLight:o}=this.options;this.setStyleOptions(t.intensity,o.intensity,this.sky.day)}toEvening(e=2){this.style=e,this.setStyleOptions(.01,.5,this.sky.evening)}toNight(e=3){this.style=e,this.setStyleOptions(.01,.3,this.sky.night,!0)}setEnv(e){const t=this.convertPmremTexture(e);this.scene.environment=t,e.dispose()}setStyleOptions(e,t,o,s=!1){this.ambientLight.intensity=e,this.directionalLight.intensity=t,this.loadEnvTexture(o)}autoChangeStyle(){const e=this.styleTimes,t=(new Date).getHours(),o=e.findIndex(((o,s)=>s==e.length-1?t>=o[0]||t<o[1]:t>=o[0]&&t<o[1]));this.style!=o+1&&(0==o?this.toByday():1==o?this.toEvening():2==o&&this.toNight())}dispose(){Ze(),this.animateModels=[],this.disposeObj(this.buildingGroup),this.disposeObj(this.person),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.fence),this.disposeObj(this.diffusion),this.disposeObj(this.floorGroup),this.disposeObj(this.lightGroup),this.clock=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.person=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.fence=void 0,this.diffusion=void 0,this.floorGroup=void 0,this.lightGroup=void 0,this.extend={},super.dispose()}}const mt=[{key:Re.M_MAIN_SCENE,name:"场景",size:78.8,url:"/深圳北站.glb"},{key:Re.M_MACHINE_ROOM,name:"机房",size:4.4,url:"/机房.glb"},{key:Re.M_WATER_PUMP,name:"水泵",size:.1,url:"/水泵.glb"},{key:Re.M_FLOOR,name:"楼层",size:6.3,url:"/楼层.glb"},{key:Re.M_PERSON,name:"人物",size:1.8,url:"/models/common/人物.glb"},{key:Re.S_ANCHOR_POS,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/dw.png"},{key:Re.S_ANCHOR_TARGET,name:"锚点",type:"sprite",range:{x:4,y:4},mapUrl:"/dw.png"},{key:Re.S_OPEN_DOOR,name:"开门",type:"sprite",range:{x:2,y:2},mapUrl:"/pos.png"},{key:Re.S_TAG_BUILDING,name:"建筑楼栋标签",type:"sprite",range:{x:22.7,y:9.2},mapUrl:"/tag-business.png"},{key:Re.S_TAG_CAMERA,name:"监控标签",type:"sprite",range:{x:9.6,y:10.4},mapUrl:"/tag-camera.png",mapUrl2:"/tag-camera-2.png"},{key:Re.S_TAG_ROOM,name:"站房标签",type:"sprite",range:{x:9.6,y:10.4},mapUrl:"/tag-room.png",mapUrl2:"/tag-room-2.png"},{key:Re.L_WATTING_TOOM,type:"spotlight",name:"聚光灯",intensity:2,color:16775378,penumbra:.5,castShadow:!1,angle:.4*Math.PI,distance:40},{key:Re.S_LIGHT_SWITCH,name:"开关灯",type:"sprite",mapUrl:"/light.png",range:{x:2,y:2}}].map((e=>(e.url&&e.url.indexOf("models")<0&&(e.url="/models/station"+e.url),e.mapUrl&&2==e.mapUrl.split("/").length&&(e.mapUrl="/textures/station"+e.mapUrl),e.mapUrl2&&2==e.mapUrl2.split("/").length&&(e.mapUrl2="/textures/station"+e.mapUrl2),e.range||(e.range={x:.5,y:.5}),e))),gt=q(g({__name:"index",setup(e){const{Hooks:t,Utils:s,THREE:i}=Ae,n=F("containerRef"),a=F("operationRef"),r=U({anchorType:[Re.S_ANCHOR_POS,Re.S_ANCHOR_TARGET,Re.S_OPEN_DOOR,Re.S_LIGHT_SWITCH,Re.S_TAG_CAMERA,Re.S_TAG_ROOM,Re.S_TAG_BUILDING],animationModelType:[Re.M_MAIN_SCENE,Re.M_MACHINE_ROOM,Re.M_WATER_PUMP],floorModelType:[Re.M_FLOOR],config:{},models:mt,cruise:{color:2090220,visible:!0,auto:!1,alway:!1,repeat:[.1,1],width:1.2,segment:100,tension:.01,speed:20,mapSpeed:.02,points:[],close:!0,bloomIntensity:.2,cameraAutoMove:!1,maxDistance:5},roamPoints:[]}),l=U({show:!1,style:{left:0,top:0},msg:""}),c={baseUrl:se.baseUrl,cruise:r.cruise,env:se.env,render:{alpha:!0},controls:{enableDamping:!0,dampingFactor:.48,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:800},camera:{near:1e-10,fov:52,position:[0,87,429]},ambientLight:{intensity:2},directionalLight:{intensity:1.5,position:[0,7e3,2e3],position2:[0,7e3,-2e3],shadow:{mapSize:2048},shadowCamera:{boundary:7e3}}};let d;const{skys:h}=Q(),{backgroundLoad:u}=t.useBackground(se.baseUrl+"/sky/",h),{progress:p,loadModels:m,getModel:g,initModels:b}=t.useModelLoader({baseUrl:"https://ye6.atomgit.net/3d-demo-data",indexDB:se.indexDB}),{options:C}=t.useDialog({extend:{id:"",roomShow:!1,cameraShow:!1}}),k=j([]),G=z((()=>k.value.filter((e=>e.type===Re.S_ANCHOR_POS)))),M=()=>{m(r.models,(()=>{K.get(Y.d3.station).then((e=>{let t={};if(e.ConfigJson instanceof Object)t=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{t=JSON.parse(e.ConfigJson)}catch(s){}k.value=e.JsonList,r.cruise.points=t.cruise||[],r.roamPoints=t.roamPoints||[];const o=G.value.filter((e=>e.bind)).map((e=>e.bind||""));null==d||d.setDblclickModelName(o),Object.keys(t).forEach((e=>{r.config&&(r.config[e]=t[e])})),setTimeout((()=>{O()}),100)}))}))},O=async()=>{var e;await A(),x(),null==(e=a.value)||e.update()},x=()=>{const e=g(Re.M_PERSON);e.traverse((e=>{e.isMesh&&(e.castShadow=!0)}));const{x:t,y:o,z:s}={x:-65.8,y:-34.8,z:22.3};e.position.set(t,o,s),e.rotateY(1*Math.PI),e.scale.setScalar(3),d.addPerson(e)},A=async()=>{d.clearBuilding(),await V(),await b(k.value,R),d.setRoamPoint(r.roamPoints),d.setCruisePoint(r.cruise.points||[]);const e=d.getValidTargetPosition(r.config||{});d.camera.position.set(e.x,e.y,e.z),p.percentage=100,p.show=!1,d.controlSave()},R=async e=>{if(!e)return;const{type:t}=e;if(t===Re.S_ANCHOR_POS)return;const o=g(t);if(!o)return void(t===Re.DOT&&(e=>{Se(d,d.addDot(e,((t,o)=>{C.select=[o],N();const{x:s=0,y:n=0,z:a=0}=e.position||{};d.cameraLookatMoveTo(new i.Vector3(s,n,a))})),se.dotShowStrict)})(e));const{anchorType:n=[],animationModelType:a=[],floorModelType:l=[]}=r;let c=s.modelDeepClone(o);const{position:h,scale:u,rotation:p}=s.get_P_S_R_param(c,e),[m,_,v]=h;return c.scale.set(...u),c.position.set(m,_,v),c.rotation.set(...p),c._isBuilding_=!0,c.data=e,a.includes(t)&&d.addModelAnimate(c,o.animations,t!==Re.M_WATER_PUMP,1),(e.followMark||e.mark)&&(c._position_={x:m,y:_,z:v}),n.includes(t)?(c._isAnchor_=!0,d.addAnchor(c,!1)):c.isSpotLight?d.addLight(e,c,!0):l.includes(t)?(c._position_={x:m,y:_,z:v},c._isFloor_=!0,d.addFloor(c)):t===Re.M_WATER_PUMP?(c._isDevice_=!0,c.name=e.name,d.addDevice(c)):d.addBuilding(c),Promise.resolve()},P=e=>{const{x:t=0,y:o=0,z:s=0}=e.position||{};d.cameraTransition({position:new i.Vector3(t,o,s),data:e})},T=()=>{M(),u(d,se.skyCode),(e=>{te.on("camera:roam",(()=>null==e?void 0:e.toggleRoam())),te.on("camera:cruise",(()=>null==e?void 0:e.toggleCruise())),te.on("camera:reset",(()=>null==e?void 0:e.controlReset())),te.on("camera:first",(()=>null==e?void 0:e.togglePersonSight(1))),te.on("camera:three",(()=>null==e?void 0:e.togglePersonSight(3))),te.on("camera:machineroom",(()=>null==e?void 0:e.toCoolMachineRoom())),te.on("person:add",(()=>null==e?void 0:e.personSpeed())),te.on("person:sub",(()=>null==e?void 0:e.personSpeed(-1))),te.on("scene:pos",(()=>null==e?void 0:e.getPosition())),te.on("scene:test",(()=>null==e?void 0:e.openTest())),te.on("tag:status",(t=>{null==e||e.anchorToggle(t.key,1==t.value)}))})(d)},E=e=>{const t=!!e&&e.object._isAnchor_;if(l.show=t,t){const t=n.value,o=e.object,a=s.getPlanePosition(t,o,d.camera,new i.Vector3(0,-o.scale.y/2,0));l.style.top=a.top,l.style.left=a.left;const r=e.object.data;l.msg=`\n      <div>${r.name}</div>\n      <div><span>类型：</span>${r.type}</div>\n      <div><span>绑定：</span>${r.bind||"无"}</div>\n    `}},N=()=>{var e;if(!C.select)return;const t=C.select[0],o=t.data||(null==(e=t.userData)?void 0:e.data);C.data=o,C.title=(null==o?void 0:o.name)||"";const{x:s,y:i,z:n}=(null==o?void 0:o.position)||{};C.list=[{name:"坐标",value:`${s},${i},${n}`},{name:"Hz"===(null==o?void 0:o.unit)?"频率":"用电",value:null==o?void 0:o.value,unit:null==o?void 0:o.unit}],C.show=!0};return H((()=>{c.container=n.value,d=new pt(c,{onHoverCall:E,onClickLeft:(e,t)=>{C.select=[],C.show=!1,C.extend.roomShow=!1,C.extend.cameraShow=!1,e&&e.data&&(e=>{var t,o;const s=e.data;switch(null==s?void 0:s.type){case Re.S_ANCHOR_POS:d.cameraTransition({position:e.position,data:e.data});break;case Re.S_ANCHOR_TARGET:case Re.S_TAG_BUILDING:C.select=[e],N();break;case Re.S_TAG_ROOM:C.select=[e],C.extend.roomShow=!0,C.extend.id=null==(t=e.data)?void 0:t.id;break;case Re.S_TAG_CAMERA:C.select=[e],C.extend.cameraShow=!0,C.extend.id=null==(o=e.data)?void 0:o.id;break;case Re.S_OPEN_DOOR:d.oddRotateDoor(e);break;case Re.S_LIGHT_SWITCH:d.lightSwitch(e)}})(e)},onDblclick:e=>{if(e&&e._isFloor_)d.floorExpand(e);else{const t=d.extend.dblclickModelName||[],o=e.name;if(t.includes(o)){const e=G.value.find((e=>e.bind===o));e&&P(e)}}},animateCall:()=>{if(C.select&&C.select.length){(e=>{const t=n.value,o=s.getPlanePosition(t,e,d.camera,new i.Vector3(0,e.scale.y/2+.01,0));C.position=o,C.style&&(C.style.left=o.left+"px",C.style.top=o.top+"px")})(C.select[0])}},onClickGround:(e,t)=>{d.personMove(t)}}).run(),X(d).resize(),T()})),(e,t)=>(_(),v("div",{class:D(e.$style.page)},[S(Pe,{ref_key:"operationRef",ref:a,list:y(G),scene:y(d),onChange:P},null,8,["list","scene"]),S(Le),f("div",{class:D(e.$style.container),ref:"containerRef"},null,2),S(o,{modelValue:y(p).show,"onUpdate:modelValue":t[0]||(t[0]=e=>y(p).show=e),progress:y(p).percentage,"bg-src":y(se).bgSrc,zindex:1},null,8,["modelValue","progress","bg-src"]),S(Te),S(Ee,{modelValue:y(l).show,"onUpdate:modelValue":t[1]||(t[1]=e=>y(l).show=e),style:w(y(l).style),msg:y(l).msg},null,8,["modelValue","style","msg"]),S(Ne,{modelValue:y(C).show,"onUpdate:modelValue":t[2]||(t[2]=e=>y(C).show=e),title:y(C).title,style:w(y(C).style),list:y(C).list},null,8,["modelValue","title","style","list"]),S(Ue,{modelValue:y(C).extend.roomShow,"onUpdate:modelValue":t[3]||(t[3]=e=>y(C).extend.roomShow=e),id:y(C).extend.id,style:w(y(C).style)},null,8,["modelValue","id","style"]),S(Ve,{modelValue:y(C).extend.cameraShow,"onUpdate:modelValue":t[4]||(t[4]=e=>y(C).extend.cameraShow=e),id:y(C).extend.id,style:w(y(C).style)},null,8,["modelValue","id","style"])],2))}}),[["__cssModules",{$style:{page:"_page_95emn_2"}}]]);export{gt as default};
