var t=Object.defineProperty,e=(e,i,o)=>(((e,i,o)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o})(e,"symbol"!=typeof i?i+"":i,o),o);import{b6 as i,be as o,bs as s,ec as n,dL as a,c as r,dv as l,ef as c,bo as h,eg as d,bh as u,e as p,Y as m,i as g,f as _,l as f,o as y,g as v,h as b,u as k,F as C,r as x,t as G,n as A,q as D,a7 as w,a8 as S,m as T,p as j,I as M,a9 as O,B as P,ak as z,aa as L}from"./vendor-d4e4f071.js";import{t as R}from"./index-307d549a.js";import{m as E,l as I,A as B,u as H}from"./scene-resize-9f897d05.js";import{e as U,A as N,_ as F}from"./index-7dfe8b5b.js";const W="ANCHOR_POS",$="ANCHOR_TARGET",V="MAIN_SCENE",J="campany_floor",K="curtain",Y="ROBOT",q="CHARACTER",Z="WAIT_LIFT",Q="LIGHT_SWITCH",X="LIGHT_MAIN_SWITCH",tt="GATE_SWITCH",et="DUBLE_HORIZONTAL_SWITCH",it="DUBLE_ROTATE_SWITCH",ot="ODD_ROTATE_SWITCH",st="VIDEO_SWITCH",nt="CURTAIN_SWITCH",at=.1,rt=[[-120,at,101],[139,at,101],[139,at,-122],[-120,at,-122]],lt=300,ct=I,ht=B,{raycaster:dt,pointer:ut,update:pt,style:mt}=ct.useRaycaster(),{initCSS2DRender:gt,createCSS2DDom:_t}=ct.useCSS2D(),{createDiffusion:ft,updateDiffusion:yt}=ct.useDiffusion(),{createMove:vt,moveAnimate:bt}=ct.useMoveAnimate(),{createFence:kt,fenceAnimate:Ct}=ct.useFence(),{keyboardPressed:xt,destroyEvent:Gt,insertEvent:At}=ct.useKeyboardState(),{checkCollide:Dt}=ct.useCollide(),{dubleHorizontal:wt,dubleRotate:St,oddRotate:Tt}=ct.useOpenTheDoor(),{createRoam:jt,executeRoam:Mt,pause:Ot,play:Pt,getStatus:zt}=ct.useRoam(),Lt={}.VITE_BEFORE_STATIC_PAT||"",Rt="FULL",Et="NPC",It=t=>{const e=document.createElement("video");return e.src=Lt+(t||"/oss/textures/park/sintel.mp4"),e.loop=!0,e},Bt=(new i).load(Lt+"/oss/textures/office/cover.jpg");class Ht extends E{constructor(t,i){super(t),e(this,"buildingGroup"),e(this,"anchorGroup"),e(this,"dotGroup"),e(this,"lightGroup"),e(this,"extend"),e(this,"css2DRender"),e(this,"mouseClickDiffusion"),e(this,"character"),e(this,"currentSight"),e(this,"historyTarget"),e(this,"historyCameraPosition"),e(this,"animateModels",[]),e(this,"videoModels",[]),e(this,"moveFactor",1),e(this,"fence"),this.extend=i,this.css2DRender=gt(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=ft(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.createClock(),this.currentSight=Rt,this.historyTarget=new o,this.historyCameraPosition=new o,this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup()}addBuildingGroup(){const t=new s;t.name="建筑组",this.buildingGroup=t,this.addObject(t)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot()}addBuilding(...t){this.buildingGroup&&this.buildingGroup.add(...t)}addAnchorGroup(){const t=new s;t.name="锚点组",this.anchorGroup=t,this.addObject(t)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(t){this.anchorGroup&&this.anchorGroup.add(t);const{x:e,y:i,z:o}=t.position;ht.createSpriteAnimate(t,[e,i,o],.2,8)}addDotGroup(){const t=new s;t.name="点位组",this.dotGroup=t,this.scene.add(t)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(t,e){var i;const o=t.position,{size:s,color:n}=t.font||{},{x:a=0,y:r=0,z:l=0}=o||{},c=_t({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=s?`font-size: ${"string"==typeof s?s:s+"px"};`:""} ${null!=n?`color: ${n}`:""}"></span>\n      `,className:"dot-2D-label",position:[a,r,l],onClick:e});return c.name=t.name,c.data=t,c._position_={x:a,y:r,z:l},null==(i=this.dotGroup)||i.add(c),c}addLightGroup(){const t=new s;t.name="灯光组",this.lightGroup=t,this.addObject(t)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}closeLightGroup(t=!1){var e;null==(e=this.lightGroup)||e.children.forEach((e=>{e.isSpotLight&&(e.visible=t)}))}addLight(t,e,i){if(this.lightGroup){e.name=t.name;const o=t.position||{x:0,y:0,z:0},{to:s={x:o.x,y:o.y-2,z:o.z}}=t;if(e.target.position.set(s.x,s.y,s.z),e.visible=!0,this.lightGroup.add(e),this.lightGroup.add(e.target),i){const t=new n(e,e.color);this.lightGroup.add(t)}}}addCharacter(t,e){const{x:i,y:o,z:s}=e;t.position.set(i,o,s),this.character=t;const n=t.animations,r=new a(t),l={};for(let a=0;a<n.length;a++){const t=n[a],e=r.clipAction(t);l[t.name]=e}l.Dance.play();const c=l.Walking;t.extra={mixer:r,actions:l,runging:c},this.addObject(t);const h=["W","S"].map((t=>t.toUpperCase().charCodeAt(0)));At((e=>{t.__runing__||h.includes(e.keyCode)&&c.play()}),(e=>{t.__runing__||h.includes(e.keyCode)&&c.stop()}))}toggleSight(t){if(this.judgeCruise())return;const e=this.currentSight==Rt?Et:Rt;this.currentSight=e;const i=e===Et;if(!this.controls)return;if(this.controls.maxDistance=i?3==t?10:0:800,this.controls.screenSpacePanning=!i,this.controls.enablePan=!i,this.controls.maxPolarAngle=Math.PI*(i?.8:.48),!this.character)return;const s=this.character.position,n=new o(0,2.5,0);if(i){r.success({message:"鼠标点击地面移动，或键盘 W、S 前后移动，A、D调整左右方向！",duration:15e3}),this.historyTarget=this.controls.target.clone(),this.historyCameraPosition=this.camera.position.clone();const t=s.clone().add(n);this.camera.lookAt(t),Math.abs(this.camera.position.y-t.y)>8&&(this.camera.position.y=t.y)}else this.camera.position.copy(this.historyCameraPosition),this.camera.lookAt(s);const a=(i?s:this.historyTarget).clone().add(n);this.controls.target.copy(a)}isPerspectives(){return this.currentSight==Et}characterAccelerate(t=1){this.moveFactor+=t,this.moveFactor>=10?this.moveFactor=10:this.moveFactor<=1&&(this.moveFactor=1),r.success({message:"人物速度："+this.moveFactor,grouping:!0})}setControlTarget(t){this.controls&&(this.controls.target.copy(t.clone().add(new o(0,2.5,0))),this.camera.lookAt(this.controls.target))}waitLift(t,e){var i;const o=t.data.target,s=this.scene.getObjectByName(o),n=null==(i=t.data)?void 0:i.to;if(!s||!n)return;const a=s.position;if(Math.abs(n.y-a.y)>.2){const i=s.__bind_lift__;void 0!==i&&this.dubleHorizontalDoor({data:{bind:i}},2.3,!1),this.dubleHorizontalDoor({data:{bind:o}},2.3,!1).then((()=>{const i=5e3;r.success({message:`${o}移动中，请稍候，5秒后到达!`,duration:i}),new l(a).to({y:n.y},i).delay(0).start().onUpdate((t=>{if(e){if(!this.character)return;this.character.position.y=t.y,this.camera.position.y=t.y,this.setControlTarget(this.character.position)}})).onComplete((()=>{s.__bind_lift__=t.data.bind,this.openLift(t,o)}))}))}else this.openLift(t,o)}openLift(t,e){this.dubleHorizontalDoor(t,2.3),this.dubleHorizontalDoor({data:{bind:e}},2.3)}lightSwitch(t){var e,i;const o=null==(i=this.lightGroup)?void 0:i.getObjectsByProperty("name",null==(e=t.data)?void 0:e.bind);o&&o.forEach((t=>{t.visible=!t.visible}))}dubleHorizontalDoor(t,e=400,i){const{bind:o,axle:s="z"}=t.data;return wt(this.scene,{value:o,axle:s,scale:e,isOpen:i})}oddRotateDoor(t){const{bind:e,axle:i="y",internal:o,autoClose:s=!1}=t.data;return Tt(this.scene,{value:e,axle:i,angle:Math.PI*(o?-.5:.5),autoClose:s})}dubleRotateDoor(t){const{bind:e,axle:i="y",left:o="右",right:s="左",internal:n,autoClose:a=!0}=t.data;return St(this.scene,{value:e,axle:i,autoClose:a,angle:Math.PI*(n?-.5:.5),leftMatch:o,rightMatch:s})}openGate(t){return this.dubleRotateDoor(t)}toggleCurtain(t){const e=this.animateModels.find((e=>{var i;return e.name===(null==(i=t.data)?void 0:i.bind)}));if(!e)return;e.__open__=!e.__open__;const{__action__:i,__mixer__:o}=e;Object.keys(i).forEach((t=>{e.__open__&&(i[t].loop=c,i[t].clampWhenFinished=!0,i[t].play())})),e.__open__||o.stopAllAction()}addVideoMaterial(t){const e=new h({map:Bt});this.videoModels=[];for(let i=0;i<t.length;i++){const o=this.scene.getObjectByName(t[i]);if(!o)continue;const s=It(),n=new d(s);o.__video_texture__=n,o.__cover_texture__=Bt.clone(),o.material=e.clone(),o.__video__=s,this.videoModels.push(o)}}clearVideo(){const t=this.videoModels;for(let e=0;e<t.length;e++){const i=t[e],{__video__:o,__cover_texture__:s,__video_texture__:n}=i;o&&(o.pause(),o.remove(),null==s||s.dispose(),null==n||n.dispose())}}videoPlay(t){const e=this.scene.getObjectByName(t.data.bind);if(e&&e.__video__){const t=e.__video__;t.paused?(e.material.map=e.__video_texture__,null==t||t.play()):(null==t||t.pause(),e.material.map=e.__cover_texture__)}}mouseClickGround(t,e){if(this.currentSight!==Et)return Promise.reject();const i=this.character;if(!i)return Promise.reject();const{runing:o}=this.options.cruise;if(o)return Promise.reject();const s=t.point,n=this.mouseClickDiffusion,{runging:a}=i.extra;return a.play(),n.position.copy(s),n.visible=!0,i.__runing__=!0,new Promise((o=>{vt(i,s,((o,s)=>{this.setControlTarget(o),this.checkCharacterCollide(o,e.includes(t.object.name)?2:.3)&&(s(),a.stop(),i.__runing__=!1,n.visible=!1)}),(t=>{this.setControlTarget(t),a.stop(),i.__runing__=!1,n.visible=!1,o(i)}))}))}checkCharacterCollide(t,e=.3){var i;if(!this.character)return;const s=Dt(this.character,t,(null==(i=this.buildingGroup)?void 0:i.children)||[],!0,new o(0,e,0));if(s.length){if(s[0].distance<.3)return r.warning({message:"撞到了！",grouping:!0}),!0}}cameraLookatMoveTo(t){this.controls&&ht.cameraLookatAnimate(this.camera,t,this.controls.target)}judgeCruise(){return!!this.options.cruise.runing&&(r.warning({message:"请退出巡航！",grouping:!0}),!0)}addModelAnimate(t,e=[],i=!0,o=1){if(!e.length)return;const s=new a(t),n=e.reduce(((t,e)=>{const n=e.name||"";return t[n]=s.clipAction(e),i&&t[n].play(),t[n].timeScale=o,t}),{});t.__action__=n,t.__mixer__=s,this.animateModels.push(t)}cameraTransition(t){var e;if(this.judgeCruise())return;if(this.mouseClickDiffusion.visible)return void r.warning({message:"人物移动中，不可操作！",grouping:!0});this.judgeAndStopRoam(),this.isPerspectives()&&this.toggleSight();const{to:i,target:o=t.position}=t.data;if(!i)return;!this.isCameraMove(i)&&this.controls&&(this.controls.maxDistance=5,ht.cameraLinkageControlsAnimate(this.controls,this.camera,i,o));const{bind:s}=t.data;if(!s)return;const n=null==(e=this.buildingGroup)?void 0:e.getObjectByName(s);this.addFence(n)}addFence(t){if(this.fence&&(this.disposeObj(this.fence),this.fence=void 0),t){const e=kt(t,5439406);this.fence=e,this.addObject(e)}}judgeAndStopRoam(){return!!zt()&&(this.controls&&(this.controls.maxDistance=1500),Ot(),!0)}toggleRoam(){if(this.judgeAndStopRoam())return;const t=this.extend.roamPoints||[];0!=t.length&&this.controls&&(this.controls.maxDistance=20,jt({points:t,segment:6,tension:.2,speed:4,close:!1}),Pt())}modelAnimate(){var t,e,i;this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.restoreAnchorMaterial();let s=null==(t=this.clock)?void 0:t.getDelta();if(this.animateModels.length&&this.animateModels.forEach((t=>{t.__mixer__&&t.__mixer__.update(s)})),null==(e=this.anchorGroup)||e.children.forEach((t=>{t.__mixer__&&t.__mixer__.update(s)})),this.character){this.character.extra.mixer.update(s),bt(.2*this.moveFactor)}if(this.mouseClickDiffusion.visible&&yt(),Ct(),this.isPerspectives()&&!(null==(i=this.character)?void 0:i.__runing__)){const t=5*s,e=.4*Math.PI*s,i=this.character;if(!i)return;const n=xt("S");if(xt("W")||n){const e=new o;null==i||i.getWorldDirection(e);const s=e.clone().multiplyScalar(n?-t:t),a=(null==i?void 0:i.position.clone().add(s))||new o;this.checkCharacterCollide(a)||(null==i||i.position.copy(a),this.setControlTarget(null==i?void 0:i.position))}xt("A")?(i.rotation.y+=e,this.keyboardToTotation()):xt("D")&&(i.rotation.y-=e,this.keyboardToTotation())}Mt(this.camera,this.controls)}keyboardToTotation(){var t;const e=this.character,i=new o;null==e||e.getWorldDirection(i);const s=(null==(t=this.controls)?void 0:t.maxDistance)||1,n=i.clone().multiplyScalar(-s),a=(null==e?void 0:e.position.clone().setY(this.camera.position.y).add(n))||new o;this.camera.position.copy(a),this.setControlTarget(null==e?void 0:e.position)}onPointerMove(t){this.checkIntersectObjects(t)}onPointerUp(t){var e;super.onPointerUp(t);const i=t.timeStamp-this.pointer.tsp<lt;2==t.button?i&&"function"==typeof(null==(e=this.extend)?void 0:e.onClickRight)&&this.extend.onClickRight(t):0==t.button?i&&this.checkIntersectObjects(t):t.button}checkIntersectObjects(t){var e,i,o,s,n;const a=this.container,r=this.options.scale;pt(t,a,r);let l="pointerdown"==t.type||"pointerup"==t.type;const c=(null==(i=this.buildingGroup)?void 0:i.children.filter((t=>t.visible&&(l||t.__ground__))).concat((null==(e=this.anchorGroup)?void 0:e.children)||[]))||[];dt.setFromCamera(ut,this.camera);let h=dt.intersectObjects(c,l);if(l)if(a.style.cursor="auto",h.length){const t=h[0],e=t.object,i="string"==typeof e.name&&(this.extend.groundMeshName||[]).some((t=>e.name.indexOf(t)>-1)),n=this.findParentGroup(e);if(i&&"function"==typeof(null==(o=this.extend)?void 0:o.onClickGround)&&this.extend.onClickGround(n,t),!n)return;"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft(n,t)}else"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(h)}hoverAnchor(t){var e,i;if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(t[0],mt),t.length){const i=t[0].object;if(this.container.style.cursor=i._isAnchor_?"pointer":"auto",!i._isAnchor_)return;const o=i.material;void 0===i.__mat_color__&&(i.__mat_color__=o.color),o.color=new u(16715760),null==(e=this.anchorGroup)||e.children.forEach((t=>{t.__change_color__=t.uuid===i.uuid}))}else this.container.style.cursor="auto",null==(i=this.anchorGroup)||i.children.forEach((t=>{t.__change_color__=!1}))}restoreAnchorMaterial(){var t;null==(t=this.anchorGroup)||t.traverse((t=>{t.isSprite&&!t.__change_color__&&t.__mat_color__&&(t.material.color=t.__mat_color__)}))}findParentGroup(t){const e=t=>{if(t._isBuilding_)return t;let i=t.parent;return i?i&&i._isBuilding_?i:e(i):void 0};return e(t)}getAll(){var t,e;return(null==(e=this.buildingGroup)?void 0:e.children.concat((null==(t=this.dotGroup)?void 0:t.children)||[]))||[]}resize(){super.resize();const{width:t,height:e}=this.options;this.css2DRender.setSize(t,e)}dispose(){Gt(),this.animateModels=[],this.clearVideo(),this.videoModels=[],this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.fence),this.disposeObj(this.lightGroup),this.disposeObj(this.mouseClickDiffusion),this.clock=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.character=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.lightGroup=void 0,this.fence=void 0,this.mouseClickDiffusion=void 0,this.extend={},super.dispose()}}const Ut=(t,e)=>{const i=40*Math.random();return void 0!==i&&(t.value=i),t.show=Math.random()>.5,t.value=Number(Number(t.value||0).toFixed(2)),{value:t.value,show:t.show,font:{...t.font||{},color:"#"+(16777215+1e6*i).toString(16).substring(0,6)}}},Nt={class:"scene-operation"},Ft=["onClick"],Wt=["innerHTML"],$t=F(p({__name:"index",setup(t){const e=B,i=I,s=m((n=(t,e,i,s)=>{if(!gt)return;(s+=.005)>1&&(s-=1),t=((t,e=0)=>new o(t.x,t.y+e,t.z))(i.getPointAt(s));let n=s+.001;n>1&&(n-=1),e=i.getPointAt(n),gt.position.set(t.x,at,t.z);const a=Math.atan2(-e.z+t.z,e.x-t.x);gt.rotation.z=.5*Math.PI+a},{devEnv:!0,baseUrl:"",bgColor:"",skyCode:"221",env:"/oss/textures/hdr/6.hdr",config:{},dotKey:"DOT",dotShowStrict:!1,anchorType:[W,$,Z,Q,X,tt,st,et,ot,it,nt],animationModelType:[J,K],models:[{key:V,name:"场景",size:18.6,url:"/公司总部.glb"},{key:"floor_low",name:"低层",size:10.7,url:"/低层.glb"},{key:K,name:"窗帘",size:.2,url:"/窗帘.glb"},{key:"floor_heigh",name:"高层",size:8.3,url:"/高层.glb"},{key:J,name:"公司",size:35.1,url:"/二十五楼.glb"},{key:W,name:"定位",type:"sprite",range:{x:4,y:4},mapUrl:"/pos.png"},{key:$,name:"锚点",type:"sprite",mapUrl:"/dw.png"},{key:Z,name:"电梯门",type:"sprite",mapUrl:"/lift.png"},{key:et,name:"双横推开关门",type:"sprite",mapUrl:"/lift.png"},{key:it,name:"双旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:ot,name:"单旋转开关门",type:"sprite",mapUrl:"/lift.png"},{key:tt,name:"闸机",type:"sprite",mapUrl:"/gate.png"},{key:st,name:"视频",type:"sprite",mapUrl:"/video.png"},{key:nt,name:"窗帘",type:"sprite",mapUrl:"/curtain.png"},{key:Y,name:"机器人",size:.3,url:"/oss/model/park/机器人.glb"},{key:q,name:"人物",size:2.2,url:"/oss/model/park/RobotExpressive.glb"},{key:"spot_light_floor_1",type:"spotlight",name:"聚光灯",intensity:8,color:6476450,distance:20},{key:"spot_light_floor_2",type:"spotlight",name:"聚光灯",intensity:8,color:57599,distance:10},{key:Q,name:"开关灯",type:"sprite",mapUrl:"/light.png"},{key:X,name:"开关灯",type:"sprite",mapUrl:"/light.png"}].map((t=>(t.url&&t.url.indexOf("oss")<0&&(t.url="/oss/model/office"+t.url),t.mapUrl&&(t.mapUrl="/oss/textures/office"+t.mapUrl),t))),cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line18.png",repeat:[1,1],width:2,segment:100,tension:.01,speed:10,mapSpeed:.1,points:rt,close:!0,offset:5.2,animateBack:n},roamPoints:[[1.7,-1.4,51.3],[80.5,72.6,75],[87,160,-72.4],[13.2,186,-72.4],[13.2,186,-61.3],[52,186,-28.2],[52,186,42.7],[-36.4,186,40],[-38.2,186,-26.8]]}));var n;const a=m({active:1,show:!1,targetName:"",list:[{target:"电梯-2",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-2_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_2_grp"}]},{target:"电梯-1",items:[{name:"一楼",key:1,y:.1,bind:"_一楼电梯门-1_grp"},{name:"公司",key:2,y:184.7,bind:"_电梯外门_1_grp"}]}]}),r=m({show:!1,style:{left:0,top:0},msg:""}),{changeBackground:l,backgroundLoad:c}=i.useBackground(),{progress:h,loadModels:d,getModel:u}=i.useModelLoader({baseUrl:s.baseUrl,indexDB:{cache:!0,dbName:"THREE__OFFICE__DB",tbName:"TB",version:40}}),p=g(),E={env:s.env,cruise:s.cruise,controls:{visible:!0,enableDamping:!0,dampingFactor:.48,maxPolarAngle:.48*Math.PI,screenSpacePanning:!1,maxDistance:1500},camera:{near:3},directionalLight:{},axes:{visible:!0,size:1e3}};let F;const lt=_((()=>{var t;return(null==(t=a.list.find((t=>t.target===a.targetName)))?void 0:t.items)||[]})),ct=t=>{var e;const i=t.data;{const t=Ut(i,F.buildingGroup);"object"==typeof t&&Object.keys(t).forEach((e=>{i[e]=t[e]}))}t.visible=i.show||!s.dotShowStrict;const o=null==(e=t.element)?void 0:e.getElementsByClassName("inner")[0];if(o){const{size:t,color:e}=i.font||{};null!=t&&(o.style.fontSize="string"==typeof t?t:t+"px"),null!=e&&(o.style.color=e),o.textContent=`${i.value||0}${i.unit}`}},ht=async t=>{if(!t)return;const{type:i}=t,o=u(i);if(!o)return void(i===s.dotKey&&(t=>{ct(F.addDot(t,(e=>{F.cameraLookatMoveTo(t.position)})))})(t));const{anchorType:n=[],animationModelType:a=[]}=s;let r=e.modelDeepClone(o);const{position:l,scale:c,rotation:h}=e.get_P_S_R_param(r,t),[d,p,m]=l;return r.scale.set(...c),r.position.set(d,p,m),r.rotation.set(...h),r._isBuilding_=!0,r.data=t,a.includes(i)&&F.addModelAnimate(r,o.animations,i!==K,1),n.includes(i)?(r._isAnchor_=!0,F.addAnchor(r)):r.isSpotLight?F.addLight(t,r,!0):F.addBuilding(r),Promise.resolve()},dt=async()=>{h.percentage=100,h.show=!1,F.clearBuilding(),await L(),await(()=>{let t=0,e=ut.value.length;return new Promise((i=>{if(0==e)return i(null);const o=async()=>{const s=ut.value[t];await ht(s),t++,t<e?o():i(t)};o()}))})(),F.setCruisePoint(s.cruise.points);const t=F.getValidTargetPosition(s.config||{});e.cameraInSceneAnimate(F.camera,t,F.controls.target).then((()=>{F.controlSave(),setTimeout((()=>{F.closeLightGroup()}),100)}))},ut=g([]),pt=_((()=>ut.value.filter((t=>t.type===W)))),mt=()=>{d(s.models,(()=>{U.get(N.d3.office).then((async t=>{let e={};if(t.ConfigJson instanceof Object)e=t.ConfigJson;else if("string"==typeof t.ConfigJson)try{e=JSON.parse(t.ConfigJson)}catch(i){}ut.value=t.JsonList,Object.keys(e).forEach((t=>{s.config&&(s.config[t]=e[t])})),await dt(),_t(),ft(),F.addVideoMaterial(t.JsonList.filter((t=>t.type===st)).map((t=>t.bind)))}))}))};let gt;const _t=()=>{gt=u(Y),gt.position.z=at,gt.rotation.z=.5*Math.PI,F.addObject(gt)},ft=()=>{const t=u(q);t.traverse((t=>{t.isMesh&&(t.castShadow=!0)}));const e={x:-69.4,y:0,z:127.3};e.x=33.7,e.z=25.3,t.scale.setScalar(.75),F.addCharacter(t,e)};return f((()=>{E.container=p.value;const t=["电梯地板002","电梯地板"];F=new Ht(E,{groundMeshName:["地面002","立方体306","平面118","立方体475","立方体514","立方体552","地面020","地面","平面391","立方体474","立方体1617","ground",...t],roamPoints:s.roamPoints,onClickLeft:(t,e)=>{if(t&&t.data){const e=t.data;switch(null==e?void 0:e.type){case W:F.cameraTransition(t);break;case Z:a.targetName=t.data.target,F.waitLift(t);break;case Q:F.lightSwitch(t);break;case X:t.__close__=!t.__close__,F.closeLightGroup(!t.__close__);break;case tt:F.openGate(t);break;case et:F.dubleHorizontalDoor(t,5.4);break;case ot:F.oddRotateDoor(t);break;case it:F.dubleRotateDoor(t);break;case nt:F.toggleCurtain(t);break;case st:F.videoPlay(t)}}},onClickGround:(e,i)=>{F.mouseClickGround(i,t).then((e=>{a.show=t.includes(i.object.name)})).catch((()=>{}))},onHoverAnchor:(t,e)=>{const i=!!t&&t.object._isAnchor_;if(r.show=i,i){r.style.top=e.top,r.style.left=e.left;const i=t.object.data;r.msg=`\n          <p>${i.name}</p>\n          <p>类型：${i.type}</p>\n          <p>绑定：${i.bind||"无"}</p>\n        `}}}),F.run(),H(F).resize(),mt(),c(F,s.skyCode)})),(t,e)=>{const i=z;return y(),v("div",{class:A(t.$style.page)},[b("div",Nt,[b("div",{class:"btn",onClick:e[0]||(e[0]=()=>{F.getAll().forEach(((t,e)=>{t.data&&(t.data.type!==s.dotKey||ct(t))}))})},"随机更新"),b("div",{class:"btn",onClick:e[1]||(e[1]=()=>{var t;return null==(t=k(F))?void 0:t.getPosition()})},"场景坐标"),b("div",{class:"btn",onClick:e[2]||(e[2]=()=>k(l)(k(F)))},"切换背景"),b("div",{class:"item",onClick:e[3]||(e[3]=()=>{var t;return null==(t=k(F))?void 0:t.toggleRoam()})},"全景漫游"),(y(!0),v(C,null,x(k(pt),(t=>(y(),v("div",{class:"item",onClick:e=>(t=>{F.cameraTransition({position:t.position,data:t})})(t)},G(t.name),9,Ft)))),256)),b("div",{class:"item",onClick:e[4]||(e[4]=()=>{var t;return null==(t=k(F))?void 0:t.toggleCruise()})},"定点巡航"),b("div",{class:"item",onClick:e[5]||(e[5]=()=>{var t;return null==(t=k(F))?void 0:t.controlReset()})},"视角重置"),b("div",{class:"item",onClick:e[6]||(e[6]=()=>k(F).toggleSight(1))},"第一人称"),b("div",{class:"item",onClick:e[7]||(e[7]=()=>k(F).toggleSight(3))},"第三人称"),b("div",{class:"item",onClick:e[8]||(e[8]=()=>k(F).characterAccelerate())},"人物加速"),b("div",{class:"item",onClick:e[9]||(e[9]=()=>k(F).characterAccelerate(-1))},"人物减速")]),b("div",{class:A(t.$style.container),ref_key:"containerRef",ref:p},null,2),D(R,{modelValue:k(h).show,"onUpdate:modelValue":e[10]||(e[10]=t=>k(h).show=t),progress:k(h).percentage},null,8,["modelValue","progress"]),w(b("div",{class:A(t.$style["floor-select"])},[(y(!0),v(C,null,x(k(lt),(t=>(y(),T(i,{type:"primary",disabled:k(a).active===t.key,onClick:e=>(t=>{a.active=t.key;const e=t.bind;F.waitLift({data:{bind:e,to:{y:t.y},target:a.targetName}},!0)})(t)},{default:j((()=>[M(G(t.name),1)])),_:2},1032,["disabled","onClick"])))),256))],2),[[S,k(a).show]]),k(r).show?(y(),v("div",{key:0,class:A(t.$style.tip),style:O({left:k(r).style.left+"px",top:k(r).style.top+"px"})},[b("div",{class:A(t.$style.msg),innerHTML:k(r).msg},null,10,Wt)],6)):P("",!0)],2)}}}),[["__cssModules",{$style:{page:"_page_1thly_2",container:"_container_1thly_10","floor-select":"_floor-select_1thly_14",tip:"_tip_1thly_20",msg:"_msg_1thly_30"}}]]);export{$t as default};
