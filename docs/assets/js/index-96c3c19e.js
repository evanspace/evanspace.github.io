var e=Object.defineProperty,t=(t,o,i)=>(((t,o,i)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i})(t,"symbol"!=typeof o?o+"":o,i),i);import{bq as o,bn as i,bi as n,er as s,dq as r,dY as a,bj as l,eB as c,be as d,dc as h,bg as u,eD as p,dE as _,ex as m,d6 as g,bp as y,br as b,e as f,Y as v,i as k,l as x,o as w,g as C,h as G,u as O,a7 as D,a8 as z,F as j,r as M,m as A,p as P,I as S,t as T,n as E,q as R,a9 as L,B as N,aP as B,ak as F,aa as I}from"./vendor-01fc5bd0.js";import{t as U}from"./index-02078237.js";import{E as H,w as $,i as K,u as V}from"./scene-resize-9435930a.js";import{d as J,A as W,_ as q}from"./index-8ac7069f.js";import{u as Y}from"./sky-9e5954b5.js";const X="ROBOT",Q="CHARACTER",Z="GROUND",ee="PARK_VIDEO",te="OPEN_THE_DOOR",oe="HALF_OPEN_THE_DOOR",ie="DOUBLE_OPEN_THE_DOOR",ne="WAIT_LIFT",se="SLIDING_DOOR",re="LIGHT_SWITCH",ae=.2,le=300,ce=$,de=K,{raycaster:he,pointer:ue,update:pe,style:_e}=ce.useRaycaster(),{initCSS2DRender:me,createCSS2DDom:ge}=ce.useCSS2D(),{createDiffusion:ye,updateDiffusion:be}=ce.useDiffusion(),{createMove:fe,moveAnimate:ve}=ce.useMoveAnimate(),{addLensflare:ke}=ce.useLensflare(),xe={}.VITE_BEFORE_STATIC_PAT||"",we=e=>{const t=document.createElement("video");return t.src=xe+(e||"/oss/textures/park/sintel.mp4"),t.loop=!0,t},Ce=(new o).load(xe+"/oss/textures/park/cover.jpeg"),Ge="FULL",Oe="NPC";class De extends H{constructor(e,o){super(e),t(this,"water"),t(this,"sky"),t(this,"sun"),t(this,"buildingGroup"),t(this,"anchorGroup"),t(this,"dotGroup"),t(this,"lightGroup"),t(this,"extend"),t(this,"css2DRender"),t(this,"mouseClickDiffusion"),t(this,"character"),t(this,"currentSight"),t(this,"historyTarget"),t(this,"historyCameraPosition"),t(this,"animateModels"),t(this,"moveFactor",1),this.extend=o,this.css2DRender=me(this.options,this.container),this.css2DRender.domElement.className="three-scene__dot-wrap",this.mouseClickDiffusion=ye(4,void 0,6),this.mouseClickDiffusion.rotation.x=.5*-Math.PI,this.mouseClickDiffusion.position.y=.5,this.mouseClickDiffusion.visible=!1,this.addObject(this.mouseClickDiffusion),this.createClock(),this.currentSight=Ge,this.historyTarget=new i,this.historyCameraPosition=new i,this.animateModels=[],this.bindEvent(),this.addBuildingGroup(),this.addAnchorGroup(),this.addDotGroup(),this.addLightGroup(),this.addLensflare()}addBuildingGroup(){const e=new n;e.name="建筑组",this.buildingGroup=e,this.addObject(e)}clearBuilding(){this.buildingGroup&&this.disposeObj(this.buildingGroup),this.animateModels=[],this.addBuildingGroup(),this.clearAnchor(),this.clearDot(),this.clearLightGroup()}addBuilding(...e){this.buildingGroup&&this.buildingGroup.add(...e)}addAnchorGroup(){const e=new n;e.name="锚点组",this.anchorGroup=e,this.addObject(e)}clearAnchor(){this.anchorGroup&&this.disposeObj(this.anchorGroup),this.addAnchorGroup()}addAnchor(...e){this.anchorGroup&&this.anchorGroup.add(...e)}addDotGroup(){const e=new n;e.name="点位组",this.dotGroup=e,this.scene.add(e)}clearDot(){this.dotGroup&&this.disposeObj(this.dotGroup),this.addDotGroup()}addDot(e,t){var o;const i=e.position,{size:n,color:s}=e.font||{},{x:r=0,y:a=0,z:l=0}=i||{},c=ge({name:`\n        <div class="bg"></div>\n        <span class="inner" style="${null!=n?`font-size: ${"string"==typeof n?n:n+"px"};`:""} ${null!=s?`color: ${s}`:""}"></span>\n      `,className:"dot-2D-label",position:[r,a,l],onClick:t});return c.name=e.name,c.data=e,c._position_={x:r,y:a,z:l},null==(o=this.dotGroup)||o.add(c),c}addLightGroup(){const e=new n;e.name="灯光组",this.lightGroup=e,this.addObject(e)}clearLightGroup(){this.lightGroup&&this.disposeObj(this.lightGroup),this.addLightGroup()}addLight(e,t,o){if(this.lightGroup){t.name=e.name;const{to:i={x:0,y:0,z:0}}=e;if(t.target.position.set(i.x,i.y,i.z),this.lightGroup.add(t),o){const e=new s(t,t.color);this.lightGroup.add(e)}}}addLensflare(){const{position:e=[500,1e3,800],color:t=16777215}=this.options.directionalLight,[n,s,r]=e,a=ke(t,n,s,r);this.addObject(a),this.sun=new i(n,s,r),this.water=(()=>{const e=new d(900,50),t=new y(e,{textureWidth:512,textureHeight:512,waterNormals:(new o).load(xe+"/oss/textures/waternormals.jpg",(e=>{e.wrapS=e.wrapT=b})),sunDirection:new i,sunColor:15732480,waterColor:92299,distortionScale:3.5});return t.rotation.x=-Math.PI/2,t.rotation.z=.05*Math.PI,t.material.uniforms.size.value=.5,t.position.y=-1,t.position.x=65,t.position.z=230,t})(),this.addObject(this.water)}updateSkyAndSun(){const{water:e,sky:t,sun:o}=this,i=null==t?void 0:t.material.uniforms;if(!i)return;const n=10,s=1,l=.005,c=.2,d=4,h=180,u=1;i.turbidity.value=n,i.rayleigh.value=s,i.mieCoefficient.value=l,i.mieDirectionalG.value=c;const p=r.degToRad(90-d),_=r.degToRad(h);if(!o)return;if(o.setFromSphericalCoords(1,p,_),t.material.uniforms.sunPosition.value.copy(o),!e)return;e.material.uniforms.sunDirection.value.copy(o).normalize();const m=new a(this.renderer);this.scene.environment=m.fromScene(t).texture,this.renderer.toneMappingExposure=u}addCharacter(e,t){const{x:o,y:i,z:n}=t;e.position.set(o,i,n),this.character=e;const s=e.animations,r=new l(e),a={};for(let l=0;l<s.length;l++){const e=s[l],t=r.clipAction(e);a[e.name]=t}a.Dance.play();const c=a.Walking;e.extra={mixer:r,actions:a,runging:c},this.addObject(e)}toggleSight(){if(this.options.cruise.runing)return void this.toggleCruise(!0);if(!this.controls||!this.character)return;const e=this.currentSight==Ge?Oe:Ge;this.currentSight=e;const t=e===Oe;this.controls.maxDistance=t?15:1500,this.controls.screenSpacePanning=!t,this.controls.enablePan=!t,this.controls.maxPolarAngle=Math.PI*(t?.49:.45);const o=this.controls.target,n=this.character.position;if(t){const{x:e,y:t,z:s}=o;this.historyTarget=new i(e,t,s);const{x:r,y:a,z:l}=this.camera.position;this.historyCameraPosition=new i(r,a,l);const{x:c,y:d,z:h}=n;this.camera.lookAt(new i(c,d+3,h))}else{const{x:e,y:t,z:o}=this.historyCameraPosition;this.camera.position.set(e,t,o),this.camera.lookAt(n)}const{x:s,y:r,z:a}=t?n:this.historyTarget;o.set(s,r,a)}characterAccelerate(){this.moveFactor++,this.moveFactor>=10&&(this.moveFactor=10),console.log("当前人物速度系数："+this.moveFactor)}setControlTarget(e){if(!this.controls)return;const{x:t,y:o,z:i}=e;this.controls.target.set(t,o+3,i),this.camera.lookAt(this.controls.target)}mouseClickGround(e){if(this.currentSight!==Oe)return Promise.reject();const t=this.character;if(!t)return Promise.reject();const{runing:o}=this.options.cruise;if(o)return Promise.reject();const i=e.point,n=this.mouseClickDiffusion,{runging:s}=t.extra;s.play();const{x:r,y:a,z:l}=i;return n.position.set(r,a,l),n.visible=!0,new Promise((e=>{fe(t,i,(e=>{this.setControlTarget(e)}),(o=>{this.setControlTarget(o),s.stop(),n.visible=!1,e(t)}))}))}addVideoMaterial(){const e=we(),t=new c(e),o=new d(10,5),i=new h({map:Ce}),n=new u(o,i);n.__video_texture__=t,n.__cover_texture__=Ce,n.position.set(-75,2.66,133),n.name="small_video",n.__video__=e,this.addObject(n);const s=new p(new d(20,20),{clipBias:.003,textureWidth:window.innerWidth*window.devicePixelRatio,textureHeight:window.innerHeight*window.devicePixelRatio,color:11908533});s.position.set(-75,.17,160),s.rotateX(-Math.PI/2),this.addObject(s);const r=this.scene.getObjectByName("大屏幕");if(!r)return;const a=we(),l=new c(a);r.__video_texture__=l,r.__cover_texture__=Ce.clone(),r.material=i.clone(),r.__video__=a}videoPlay(e){const t=this.scene.getObjectByName(e.data.bind);if(t&&t.__video__){const e=t.__video__;e.paused?(t.material.map=t.__video_texture__,null==e||e.play()):(null==e||e.pause(),t.material.map=t.__cover_texture__)}}openTheDoor(e,t){const o=this.scene.getObjectByName(e.data.bind);if(o)if(t)o.__open__=!o.__open__,new _(o.rotation).to({z:o.__open__?.5*Math.PI:0},1500).delay(0).start();else{const e=o.position;if(null==o.__open__){const{x:t,y:n,z:s}=e;o.__position__=new i(t,n,s)}o.__open__=!o.__open__,new _(e).to({x:o.__position__.x+(o.__open__?7:0)},1500).delay(0).start()}}openTheDoubleSlidingDoor(e,t=400,o){const n=this.scene.getObjectByName(e.data.bind);if(!n)return Promise.reject();const s=n.children.find((e=>e.name.indexOf("左")>-1)),r=n.children.find((e=>e.name.indexOf("右")>-1)),a=s.position,l=r.position;if(null==n.__open__){const{x:e,y:t,z:o}=a,{x:n,y:c,z:d}=l;s.__position__=new i(e,t,o),r.__position__=new i(n,c,d)}return n.__open__=void 0!==o?o:!n.__open__,new Promise((e=>{const o=r.__position__.x+(n.__open__?t:0);if(l.x===o)return e(n);new _(a).to({x:s.__position__.x+(n.__open__?-t:0)},1500).delay(0).start(),new _(l).to({x:o},1500).delay(0).start().onComplete((()=>{e(n)}))}))}openTheSlidingDoor(e){const t=this.scene.getObjectByName(e.data.bind);if(console.log(e),!t)return;console.log(t);const o=t.children.find((e=>e.name.indexOf("左")>-1)),n=o.position;if(null==t.__open__){const{x:e,y:t,z:s}=n;o.__position__=new i(e,t,s)}t.__open__=!t.__open__;const s=o.__position__.y+(t.__open__?4.5:0);n.y!==s&&new _(n).to({y:o.__position__.y+(t.__open__?4.5:0)},1500).delay(0).start()}waitLift(e,t){var o;const i="单元1号电梯",n=this.scene.getObjectByName(i);console.log(n);const s=null==(o=e.data)?void 0:o.to;if(!n||!s)return;const r=n.position;if(s.y!=r.y){const o=n.__bind_lift__;void 0!==o&&this.openTheDoubleSlidingDoor({data:{bind:o}},200,!1),this.openTheDoubleSlidingDoor({data:{bind:i}},4,!1).then((()=>{new _(r).to({y:s.y},1500).delay(0).start().onUpdate((e=>{if(t){if(!this.character)return;this.character.position.y=e.y,this.camera.position.y=e.y,this.setControlTarget(this.character.position)}})).onComplete((()=>{console.log("电梯到了！"),n.__bind_lift__=e.data.bind,this.openLift(e,i)}))}))}else this.openLift(e,i)}openLift(e,t){console.log(e),this.openTheDoubleSlidingDoor(e,200),this.openTheDoubleSlidingDoor({data:{bind:t}},4)}lightSwitch(e){var t,o;console.log(e);const i=null==(o=this.lightGroup)?void 0:o.getObjectsByProperty("name",null==(t=e.data)?void 0:t.bind);i.forEach((e=>{e.visible=!e.visible})),console.log(i)}addModelAnimate(e,t=[],o=!0,i=1){if(!t.length)return;const n=new l(e),s=t.reduce(((e,t)=>{const s=t.name||"";return e[s]=n.clipAction(t),o&&e[s].play(),e[s].timeScale=i,e}),{});e.__action__=s,e.__mixer__=n,this.animateModels.push(e)}modelAnimate(){var e;this.css2DRender.render(this.scene,this.camera),"function"==typeof this.extend.animateCall&&this.extend.animateCall(),this.water&&(this.water.material.uniforms.time.value+=1/60),this.mouseClickDiffusion.visible&&be();let t=null==(e=this.clock)?void 0:e.getDelta();if(this.character){this.character.extra.mixer.update(t),ve(.5*this.moveFactor)}this.restoreAnchorMaterial(),this.animateModels.length&&this.animateModels.forEach((e=>{e.__mixer__.update(t)})),m()}onDblclick(e){var t;const o=this.container,i=this.options.scale;if(pe(e,o,i),this.buildingGroup){he.setFromCamera(ue,this.camera);const e=[this.buildingGroup],o=he.intersectObjects(e);if(o.length){const e=o[0].object,i=this.findParentGroup(e);if(!i)return;"function"==typeof(null==(t=this.extend)?void 0:t.onDblclick)&&this.extend.onDblclick(i)}}}onPointerMove(e){this.checkIntersectObjects(e)}onPointerUp(e){var t;super.onPointerUp(e);const o=e.timeStamp-this.pointer.tsp<le;2==e.button?o&&"function"==typeof(null==(t=this.extend)?void 0:t.onClickRight)&&this.extend.onClickRight(e):0==e.button?o&&this.checkIntersectObjects(e):e.button}checkIntersectObjects(e){var t,o,i,n,s;const r=this.container,a=this.options.scale;pe(e,r,a);let l="pointerdown"==e.type||"pointerup"==e.type;const c=(null==(o=this.buildingGroup)?void 0:o.children.filter((e=>e.visible&&(l||e.__ground__))).concat((null==(t=this.anchorGroup)?void 0:t.children)||[]))||[];he.setFromCamera(ue,this.camera);let d=he.intersectObjects(c,l);if(l)if(r.style.cursor="auto",d.length){const e=d[0],t=e.object;console.log(e);const o="string"==typeof t.name&&(this.extend.groundMeshName||[]).some((e=>t.name.indexOf(e)>-1)),s=this.findParentGroup(t);if(o&&"function"==typeof(null==(i=this.extend)?void 0:i.onClickGround)&&this.extend.onClickGround(s,e),!s)return;"function"==typeof(null==(n=this.extend)?void 0:n.onClickLeft)&&this.extend.onClickLeft(s,e)}else"function"==typeof(null==(s=this.extend)?void 0:s.onClickLeft)&&this.extend.onClickLeft();else this.hoverAnchor(d)}hoverAnchor(e){var t,o,i;if("function"==typeof this.extend.onHoverAnchor&&this.extend.onHoverAnchor(e[0],_e),e.length){const i=e[0].object;if(this.container.style.cursor=i._isAnchor_?"pointer":"auto",!i._isAnchor_)return void(null==(t=this.anchorGroup)||t.children.forEach((e=>{e.__change_color__=!1})));const n=i.material;void 0===i.__mat_color__&&(i.__mat_color__=n.color),n.color=new g(16715760),null==(o=this.anchorGroup)||o.children.forEach((e=>{e.__change_color__=e.uuid===i.uuid}))}else this.container.style.cursor="auto",null==(i=this.anchorGroup)||i.children.forEach((e=>{e.__change_color__=!1}))}restoreAnchorMaterial(){var e;null==(e=this.anchorGroup)||e.traverse((e=>{e.isSprite&&!e.__change_color__&&e.__mat_color__&&(e.material.color=e.__mat_color__)}))}findParentGroup(e){const t=e=>{if(e._isBuilding_)return e;let o=e.parent;return o?o&&o._isBuilding_?o:t(o):void 0};return t(e)}getFloor(){var e;return null==(e=this.buildingGroup)?void 0:e.children.filter((e=>e._isFloor_))}hideOmitFloor(e){var t;null==(t=this.buildingGroup)||t.children.forEach((t=>{t.visible=t._isFloor_||e}))}getAll(){var e,t;return(null==(t=this.buildingGroup)?void 0:t.children.concat((null==(e=this.dotGroup)?void 0:e.children)||[]))||[]}getFlowMark(e){return this.getAll().filter((t=>{var o;return(null==(o=t.data)?void 0:o.followMark)===e}))}getAnimTargetPos(e,t,o){if(!this.controls)return;const i=t||e.to||{x:-104,y:7,z:58},n=o||e.target||{x:0,y:0,z:0};return this.controls.target.set(n.x,n.y,n.z),i}resize(){super.resize();const{width:e,height:t}=this.options;this.css2DRender.setSize(e,t)}dispose(){this.animateModels=[],this.disposeObj(this.water),this.disposeObj(this.sky),this.disposeObj(this.buildingGroup),this.disposeObj(this.character),this.disposeObj(this.dotGroup),this.disposeObj(this.anchorGroup),this.disposeObj(this.lightGroup),this.disposeObj(this.mouseClickDiffusion),this.clock=void 0,this.water=void 0,this.sky=void 0,this.css2DRender=void 0,this.buildingGroup=void 0,this.character=void 0,this.dotGroup=void 0,this.anchorGroup=void 0,this.lightGroup=void 0,this.mouseClickDiffusion=void 0,this.extend={},super.dispose()}}const ze=(e,t)=>{const o=40*Math.random();return void 0!==o&&(e.value=o),e.show=Math.random()>.5,e.value=Number(Number(e.value||0).toFixed(2)),{value:e.value,show:e.show,font:{...e.font||{},color:"#"+(16777215+1e6*o).toString(16).substring(0,6)}}},je=(e,t)=>{console.log(t);const o=Math.random()>.5?1:0,i=Math.random()>.5?1:0,n=Math.random()>.8?1:0,s=Math.floor(3*Math.random());return{status:n>0?0:o,error:n>0?0:i,remote:1==s?1:0,local:2==s?1:0,disabled:n}},Me={normal:{color:8954293,main:[8954293,2698801],text:12180479,FM:6319220},runing:{color:3045368,main:3045368,FM:422935},error:{color:12717056,main:11879461,FM:15215899}},Ae={class:"scene-operation"},Pe=["innerHTML"],Se=q(f({__name:"index",setup(e){const t=v({devEnv:!0,baseUrl:"",bgColor:"",skyCode:"104",env:"/oss/textures/hdr/3.hdr",bgSrc:"/oss/img/park/bg.jpg",dotKey:"DOT",dotShowStrict:!1,colorMeshName:[],floorModelType:["FLOOR_COMMON"],anchorType:["PARK_CAMERA","PARK_ROOM_INLET",ee,te,oe,ie,ne,se,re],carType:["car_tanker","car_goods","car_trailer","car_crane"],animationModelType:["building_commercial_2"],colors:{},config:{},cruise:{visible:!0,auto:!0,mapUrl:"/oss/textures/cruise/line2.png",repeat:[.1,1],width:2,segment:100,tension:.1,speed:20,mapSpeed:.01,points:[[-89.57,ae,179.4],[-52.28,ae,179.4],[-52.28,ae,123.05],[-4.43,ae,123.05],[-4.43,ae,99.18],[6.26,ae,99.18],[6.26,ae,153.83],[92.71,ae,153.83],[147.75,ae,148.23],[147.75,ae,135.93],[144.21,ae,133.13],[144.21,ae,126.7],[86.6,ae,126.7],[86.6,ae,152.35],[77.55,ae,152.35],[77.55,ae,-137.3],[3.34,ae,-137.3],[3.34,ae,-52.04],[-89.57,ae,-52.04]],offset:1.8,animateBack:(e,t,o,n)=>{if(q){(n+=.02)>1&&(n-=1),e=((e,t=0)=>new i(e.x,e.y+t,e.z))(o.getPointAt(n));let s=n+.001;s>1&&(s-=1),t=o.getPointAt(s),q.position.set(e.x,.16,e.z);const r=Math.atan2(-t.z+e.z,t.x-e.x);q.rotation.z=.5*Math.PI+r}}},models:[{key:"SCENE",name:"场景",size:14.7,url:"/场景.glb"},{key:Z,name:"地面",size:4,url:"/地面.glb"},{key:"PARKING_SPACE",name:"停车位",size:.06,url:"/停车位.glb"},{key:"building_1",name:"楼栋1",size:1.2,url:"/楼栋1.glb"},{key:"building_2",name:"楼栋2",size:2,url:"/楼栋2.glb"},{key:"building_3",name:"楼栋3",size:1.6,url:"/楼栋3.glb"},{key:"building_4",name:"楼栋4",size:2.8,url:"/楼栋4.glb"},{key:"building_5",name:"楼栋5",size:1.6,url:"/楼栋5.glb"},{key:"building_warehouse",name:"仓库",size:.7,url:"/仓库.glb"},{key:"building_commercial_1",name:"商业楼1",size:3.6,url:"/商业楼1.glb"},{key:"building_commercial_2",name:"商业楼2",size:14.5,url:"/商业楼2.glb"},{key:"building_commercial_3",name:"商业楼3",size:.6,url:"/商业楼3.glb"},{key:"building_commercial_4",name:"电梯房",size:9.6,url:"/电梯房.glb"},{key:"car_tanker",name:"油罐车",size:1,url:"/油罐车.glb"},{key:"car_goods",name:"货车",size:6.4,url:"/货车.glb"},{key:"car_trailer",name:"拖车",size:2,url:"/拖车.glb"},{key:"car_crane",name:"吊车",size:4.4,url:"/吊车.glb"},{key:"car_aodi",name:"奥迪",size:1,url:"/奥迪.glb"},{key:"car_kaidilake",name:"凯迪拉克",size:1.6,url:"/凯迪拉克.glb"},{key:"ARBOR_ONE",name:"小树",size:2,url:"/小树.glb"},{key:"FENCE",name:"围栏",size:.8,url:"/围栏.glb"},{key:"HANDRAIL",name:"栏杆",size:.1,url:"/栏杆.glb"},{key:X,name:"机器人",size:.3,url:"/oss/model/common/机器人.glb"},{key:Q,name:"人物",size:.3,url:"/oss/model/common/RootNode.glb"},{key:"PARK_CAMERA",name:"摄像头",type:"sprite",range:{x:18.5,y:38.5},mapUrl:"/sxt.png"},{key:ee,name:"视频播放",type:"sprite",range:{x:1,y:1},mapUrl:"/video.png"},{key:te,name:"开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:oe,name:"半开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:ie,name:"双开门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:se,name:"推拉门",type:"sprite",range:{x:1,y:1},mapUrl:"/open.png"},{key:ne,name:"电梯门",type:"sprite",range:{x:1,y:1},mapUrl:"/lift.png"},{key:"spot_light_reception",type:"spotlight",name:"聚光灯",intensity:8,distance:100,decay:0},{key:re,name:"开关灯",type:"sprite",range:{x:1.2,y:1.2},mapUrl:"/light.png"}].map((e=>(e.url&&e.url.indexOf("oss")<0&&(e.url="/oss/model/park"+e.url),e.mapUrl&&(e.mapUrl="/oss/textures/park"+e.mapUrl),e)))});const o=v({active:1,show:!1,list:[{name:"一楼",key:1,y:.2},{name:"二楼",key:2,y:13.8},{name:"三楼",key:3,y:19.83},{name:"五楼",key:5,y:31.76}]}),n=v({show:!1,style:{left:0,top:0},msg:""}),s=k(),a=K.deepMerge(Me,t.colors),{skys:l}=Y(),{changeBackground:c,backgroundLoad:d}=$.useBackground(t.baseUrl+"/oss/sky/",l),{progress:h,loadModels:u,getModel:p,virtualization:m,closeVirtualization:g}=$.useModelLoader({baseUrl:t.baseUrl,colors:a,colorMeshName:t.colorMeshName,indexDB:{cache:!1,dbName:"THREE__PARK__DB",tbName:"TB",version:75}}),y={env:"/oss/textures/hdr/3.hdr",controls:{maxDistance:1500,screenSpacePanning:!0,enablePan:!0},camera:{position:[-118.4,3,220.4]},cruise:t.cruise,grid:{visible:!1},render:{alpha:!0,preserveDrawingBuffer:!0},axes:{visible:!0},directionalLight:{visible:!0,intensity:3}},b=e=>{var o;const i=e.data;{const e=ze(i,ue.buildingGroup);"object"==typeof e&&Object.keys(e).forEach((t=>{i[t]=e[t]}))}e.visible=i.show||!t.dotShowStrict;const n=null==(o=e.element)?void 0:o.getElementsByClassName("inner")[0];if(n){const{size:e,color:t}=i.font||{};null!=e&&(n.style.fontSize="string"==typeof e?e:e+"px"),null!=t&&(n.style.color=t),n.textContent=`${i.value||0}${i.unit}`}},f=async e=>{if(!e)return;const{type:o,url:i}=e,n=p(o);if(!n)return void(i||o===t.dotKey&&(e=>{b(ue.addDot(e,(e=>{console.log(e)})))})(e));const{floorModelType:s=[],anchorType:a=[],carType:l=[],animationModelType:c=[]}=t;let d=K.modelDeepClone(n);const{position:h,scale:u,rotation:m}=K.get_P_S_R_param(d,e),[g,y,f]=h;return d.scale.set(...u),d.position.set(g,y,f),d.rotation.set(...m),d._isBuilding_=!0,d.data=e,l.includes(o)&&(e=>{const t=e.data,{to:o,position:i}=t;if(!o)return;const n=r.randInt(0,1e4);e.tween1=new _(e.position).to(o,3e4).delay(n).onUpdate((({x:t,y:o,z:i})=>{e.position.x=t,e.position.y=o,e.position.z=i})),e.tween2=new _(i).to(o,3e4).onUpdate((({x:t,y:o,z:i})=>{e.position.x=t,e.position.y=o,e.position.z=i})),e.tween1.chain(e.tween2),e.tween2.chain(e.tween1),e.tween1.start()})(d),c.includes(o)&&ue.addModelAnimate(d,n.animations,!0,.1),s.includes(o)&&(d._position_={x:g,y:y,z:f},d._isFloor_=!0),d.__ground__=o===Z,a.includes(o)?(d._isAnchor_=!0,ue.addAnchor(d)):d.isSpotLight?ue.addLight(e,d,!0):ue.addBuilding(d),Promise.resolve()},H=async()=>{ue.clearBuilding(),await I(),await(()=>{let e=0,t=le.value.length;return new Promise((o=>{if(0==t)return o(null);const i=async()=>{const n=le.value[e];await f(n),e++,e<t?i():o(e)};i()}))})(),ue.setCruisePoint(t.cruise.points);const e=ue.getValidTargetPosition(t.config||{});ue.camera.position.set(e.x,e.y,e.z),ue.controlSave(),h.percentage=100,h.show=!1};let q;const le=k([]),ce=()=>{u(t.models,(()=>{J.get(W.d3.park).then((async e=>{let o={};if(e.ConfigJson instanceof Object)o=e.ConfigJson;else if("string"==typeof e.ConfigJson)try{o=JSON.parse(e.ConfigJson)}catch(i){}le.value=e.JsonList,Object.keys(o).forEach((e=>{t.config&&(t.config[e]=o[e])})),await H(),q=p(X),q.position.z=.16,q.rotation.z=.5*Math.PI,ue.addObject(q),(()=>{const e=p(Q);e.traverse((e=>{e.isMesh&&(e.castShadow=!0)})),ue.addCharacter(e,{x:-80.6,y:.16,z:193.4})})(),ue.addVideoMaterial()}))}))},he=e=>{const o=[];ue.getAll().forEach(((i,n)=>{if(!i.data)return;const s=i.data;let r=s.type;if(r===t.dotKey)return void b(i);{const t=je(0,e);if(!t)return;"object"!=typeof t&&console.warn(Error("更新回调函数返回对象不为 Object，当前类型："+typeof t)),Object.keys(t).forEach((e=>{s[e]=t[e]}))}o.push(B(s));let{status:l=0,error:c=0,remote:d=0,local:h=0,disabled:u=0}=s;const p=a[c>0?"error":l>0?"runing":"normal"];(e=>{let{el:t,type:o,colorObj:i,color:n,paused:s}=e,r=de.getColorArr(n);n=r[0];const a=t.extra;a&&(a.action&&(a.action.paused=s),null!=n)&&(a.meshs||[]).forEach((e=>{de.setMaterialColor(e,n)}))})({type:r,el:i,colorObj:p,color:null!=p[r]?p[r]:p.color,paused:0==l,error:c>0,remote:d>0,local:h>0,disabled:u>0})}))};let ue;return x((()=>{y.container=s.value;const e="轿厢-ground";ue=new De(y,{groundMeshName:["地面","楼板","mesh_0_4","ground",e],onDblclick:e=>{var t,o,i;"building_commercial_5"===(null==(t=e.data)?void 0:t.type)?m((null==(o=ue.buildingGroup)?void 0:o.children.filter((e=>!["地面","场景"].includes(e.name))))||[],e,{wireframe:!0,opacity:.1}):g(null==(i=ue.buildingGroup)?void 0:i.children)},onClickLeft(e,t){if(e&&e.data){const t=e.data;switch(null==t?void 0:t.type){case ee:ue.videoPlay(e);break;case te:case oe:ue.openTheDoor(e,t.type===oe);break;case ie:ue.openTheDoubleSlidingDoor(e);break;case ne:ue.waitLift(e);break;case se:ue.openTheSlidingDoor(e);break;case re:ue.lightSwitch(e)}}},onClickGround:(t,i)=>{ue.mouseClickGround(i).then((t=>{o.show=i.object.name===e}))},onClickRight:e=>{console.log(e)},onHoverAnchor:(e,t)=>{const o=!!e&&e.object._isAnchor_;if(n.show=o,o){n.style.top=t.top,n.style.left=t.left;const o=e.object.data;n.msg=`\n          <p>${o.name}</p>\n          <p>类型：${o.type}</p>\n          <p>绑定：${o.bind||"无"}</p>\n        `}}}),ue.run(),V(ue).resize(),ce(),d(ue,t.skyCode)})),(e,i)=>{const r=F;return w(),C("div",{class:E(e.$style.page)},[G("div",Ae,[G("div",{class:"btn",onClick:i[0]||(i[0]=()=>he(!0))},"随机更新"),G("div",{class:"btn",onClick:i[1]||(i[1]=e=>O(ue).exportImage())},"截图"),G("div",{class:"btn",onClick:i[2]||(i[2]=()=>{var e;return null==(e=O(ue))?void 0:e.toggleSight()})},"人物视角切换"),G("div",{class:"btn",onClick:i[3]||(i[3]=()=>{var e;return null==(e=O(ue))?void 0:e.toggleCruise()})},"定点巡航"),G("div",{class:"btn",onClick:i[4]||(i[4]=()=>{var e;return null==(e=O(ue))?void 0:e.getPosition()})},"场景坐标"),G("div",{class:"btn",onClick:i[5]||(i[5]=()=>O(c)(O(ue)))},"切换背景"),G("div",{class:"btn",onClick:i[6]||(i[6]=()=>{var e;return null==(e=O(ue))?void 0:e.controlReset()})},"控制器重置"),G("div",{class:"btn",onClick:i[7]||(i[7]=()=>{var e;return null==(e=O(ue))?void 0:e.characterAccelerate()})},"人物加速"),G("div",{class:"btn",onClick:i[8]||(i[8]=()=>{var e;return null==(e=O(ue))?void 0:e.toggleCruiseDepthTest()})},"巡航深度")]),D(G("div",{class:E(e.$style["floor-select"])},[(w(!0),C(j,null,M(O(o).list,(e=>(w(),A(r,{type:"primary",disabled:O(o).active===e.key,onClick:t=>(e=>{o.active=e.key;const t="电梯门"+e.key;ue.waitLift({data:{bind:t,to:{y:e.y}}},!0)})(e)},{default:P((()=>[S(T(e.name),1)])),_:2},1032,["disabled","onClick"])))),256))],2),[[z,O(o).show]]),G("div",{class:E(e.$style.container),ref_key:"containerRef",ref:s},null,2),R(U,{modelValue:O(h).show,"onUpdate:modelValue":i[9]||(i[9]=e=>O(h).show=e),"bg-color":O(t).bgColor,progress:O(h).percentage,"bg-src":O(t).bgSrc},null,8,["modelValue","bg-color","progress","bg-src"]),O(n).show?(w(),C("div",{key:0,class:E(e.$style.tip),style:L({left:O(n).style.left+"px",top:O(n).style.top+"px"})},[G("div",{class:E(e.$style.msg),innerHTML:O(n).msg},null,10,Pe)],6)):N("",!0)],2)}}}),[["__cssModules",{$style:{page:"_page_1r6hr_2",container:"_container_1r6hr_10","floor-select":"_floor-select_1r6hr_14",tip:"_tip_1r6hr_20",msg:"_msg_1r6hr_29"}}]]);export{Se as default};
