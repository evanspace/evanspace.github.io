{"version":3,"file":"index-f0b16c8a.js","sources":["../../../code/src/pages/webgl/controls/drag/methods.ts","../../../code/src/pages/webgl/controls/drag/index.vue"],"sourcesContent":["import * as THREE from 'three'\n\nimport * as ThreeScene from 'three-scene'\n\nimport { DragControls } from 'three/examples/jsm/controls/DragControls'\n\nconst Hooks = ThreeScene.Hooks\nconst { insertEvent, destroyEvent } = Hooks.useKeyboardState()\nconst { pointer, update, raycaster } = Hooks.useRaycaster()\n\nexport class DragScene extends ThreeScene.Scene {\n  enableSelection = false\n  select = new THREE.Group()\n  objects: any[] = []\n  constructor(options: ConstructorParameters<typeof ThreeScene.Scene>[0]) {\n    super(options)\n\n    this.addObject(this.select)\n    this.addModel()\n    this.container.addEventListener('click', this.onClick.bind(this))\n  }\n\n  addModel() {\n    this.objects = []\n    const geometry = new THREE.BoxGeometry()\n\n    for (let i = 0; i < 200; i++) {\n      const object = new THREE.Mesh(\n        geometry,\n        new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff })\n      )\n      object.position.set(\n        Math.random() * 300 - 150,\n        Math.random() * 150 - 75,\n        Math.random() * 200 - 100\n      )\n      object.rotation.set(\n        Math.random() * 2 * Math.PI,\n        Math.random() * 2 * Math.PI,\n        Math.random() * 2 * Math.PI\n      )\n\n      object.scale.set(Math.random() * 20 + 10, Math.random() * 20 + 10, Math.random() * 20 + 10)\n      object.castShadow = true\n      object.receiveShadow = true\n\n      this.objects.push(object)\n      this.addObject(object)\n    }\n\n    if (!this.controls) return\n    ;(this.controls as any).objects = [...this.objects]\n  }\n\n  createConstrols() {\n    const ctrl = new DragControls([], this.camera, this.renderer.domElement)\n\n    // 拖拽开始\n    ctrl.addEventListener('dragstart', _el => {\n      // 设置发光色\n      // @ts-ignore\n      // _el.object.material.emissive.set(0xaaaaaa)\n    })\n    // 拖拽结束\n    ctrl.addEventListener('dragend', _el => {\n      // @ts-ignore\n      // _el.object.material.emissive.set(0x000000)\n    })\n\n    // 悬浮\n    ctrl.addEventListener('hoveron', _el => {\n      // console.log(_el)\n    })\n    // 悬浮离开\n    ctrl.addEventListener('hoveroff', _el => {\n      // console.log(_el)\n    })\n\n    insertEvent(\n      e => {\n        // shift 按键\n        this.enableSelection = e.keyCode === 16\n\n        // M 按键\n        if (e.keyCode === 77) {\n          if (!this.controls) return\n          // 转换 拖拽或旋转\n          this.controls.touches.ONE =\n            this.controls?.touches.ONE === THREE.TOUCH.PAN ? THREE.TOUCH.ROTATE : THREE.TOUCH.PAN\n        }\n      },\n      () => {\n        this.enableSelection = false\n      }\n    )\n\n    return ctrl as any\n  }\n\n  onClick(e) {\n    if (this.enableSelection) {\n      // 清空控制对象列表\n      // if (this.controls) {\n      //   // @ts-ignore\n      //   this.controls.objects = []\n      // }\n      // @ts-ignore\n      const draggableObjects = this.controls?.objects\n      draggableObjects.length = 0\n\n      update(e, this.container)\n      raycaster.setFromCamera(pointer, this.camera)\n\n      const objects = this.objects\n      const intersections = raycaster.intersectObjects(objects, true)\n      if (intersections.length > 0) {\n        const object = intersections[0].object\n        console.log(object)\n        if (this.select.children.includes(object)) {\n          // 发光色\n          // @ts-ignore\n          object.material.emissive.set(0x000000)\n          // 此处不可用 add 会继承父对象的变换属性\n          // attach 不受父对象变换影响\n          this.scene.attach(object)\n        } else {\n          // @ts-ignore\n          object.material.emissive.set(0xaaaaaa)\n          this.select.attach(object)\n        }\n\n        console.log(this.select)\n\n        // @ts-ignore\n        this.controls.transformGroup = true\n        // 添加控制对象\n        draggableObjects.push(this.select)\n      }\n\n      if (this.select.children.length === 0) {\n        // @ts-ignore\n        this.controls.transformGroup = false\n        draggableObjects.push(...objects)\n      }\n    }\n  }\n\n  dispose(): void {\n    destroyEvent()\n    super.dispose()\n  }\n}\n","<template>\n  <div class=\"three-page\">\n    <div class=\"h-100\" ref=\"containerRef\"></div>\n\n    <div :class=\"$style.tip\">\n      使用“Shift+Click”向组添加对象或从组中删除对象<br />\n\n      使用“M”在旋转和平移模式之间切换（仅限触摸）<br />\n\n      分组对象可以转换为联合。\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport { DragScene } from './methods'\nimport { useResize } from '@/hooks/scene-resize'\n\nconst containerRef = ref()\nconst options: ConstructorParameters<typeof DragScene>[0] = {\n  axes: {\n    visible: true\n  },\n  camera: {\n    position: [0, 0, 400]\n  }\n}\nlet scene: InstanceType<typeof DragScene>\n\nonMounted(() => {\n  options.container = containerRef.value\n  scene = new DragScene(options).run()\n\n  useResize(scene).resize()\n})\n</script>\n\n<style lang=\"scss\" module>\n.tip {\n  top: 10px;\n  left: 10px;\n  z-index: 2;\n  font-size: 16px;\n  position: absolute;\n  line-height: 1.5;\n  pointer-events: none;\n}\n</style>\n"],"names":["Hooks","ThreeScene.Hooks","insertEvent","destroyEvent","useKeyboardState","pointer","update","raycaster","useRaycaster","DragScene","ThreeScene.Scene","constructor","options","super","__publicField","this","THREE.Group","addObject","select","addModel","container","addEventListener","onClick","bind","objects","geometry","THREE.BoxGeometry","i","object","THREE.Mesh","THREE.MeshLambertMaterial","color","Math","random","position","set","rotation","PI","scale","castShadow","receiveShadow","push","controls","createConstrols","ctrl","DragControls","camera","renderer","domElement","_el","e","enableSelection","keyCode","touches","ONE","_a","THREE.TOUCH","PAN","ROTATE","draggableObjects","length","setFromCamera","intersections","intersectObjects","console","log","children","includes","material","emissive","scene","attach","transformGroup","dispose","containerRef","ref","axes","visible","onMounted","value","run","useResize","resize"],"mappings":"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"}