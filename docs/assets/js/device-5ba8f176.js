import{g as e,aT as t,aU as o,aV as a,aW as n,aY as s,bh as i,bi as l,aX as r,bl as c,b7 as d,b9 as p,bm as u,bn as m,bo as y,bp as f,bq as g,d as h,L as b,r as w,aZ as v,a_ as _,I as k,o as x,z as E,c as C,b as L,j as P,k as z,h as T,w as M,u as S,n as B,t as D,l as G,ac as I,F as A,e as j,b0 as H,bf as $,b1 as J,aJ as O,a as R,i as N,b2 as Q,br as F,aO as U,bs as X,bt as Y,b4 as W,b3 as K,b8 as Z,bu as V,bv as q,ae as ee,bw as te,be as oe,b6 as ae,bx as ne,by as se,bz as ie,bA as le,bB as re,bC as ce,a$ as de,bD as pe,bE as ue,bF as me,bG as ye,bH as fe,bI as ge,bJ as he,bK as be,bL as we,M as ve}from"./vendor-59c65e9f.js";import{u as _e,b as ke,c as xe,A as Ee,d as Ce,a as Le}from"./common-24a0b7a6.js";import{_ as Pe}from"./api-4fe51afc.js";import{l as ze}from"./data-07702360.js";const Te={title:"device",order:40},Me={colors:{normal:{color:16777215,main:16316664,text:5280767},runing:{color:1211922,main:10485239},error:{color:12717056,main:16616554}},isCruise:!1,modelSizeKB:1048576,loadPart:{},devices:[]},Se={shakeTime:500,tsp:Date.now()},Be={list:[]},De=e({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),Ge=e({show:!1,style:{left:"0px",top:"0px"},select:[],title:"",data:{},pos:{}}),Ie=(e,t=.1,a=1e4)=>{const n=e.clientWidth,s=e.clientHeight,i=new o(36,n/s,t,a);return i.position.set(-350,510,700),i},Ae=(e,t,o="",a)=>{let n=(new s).load([`${t}${o}/${a}/posX.jpeg`,`${t}${o}/${a}/negX.jpeg`,`${t}${o}/${a}/posY.jpeg`,`${t}${o}/${a}/negY.jpeg`,`${t}${o}/${a}/posZ.jpeg`,`${t}${o}/${a}/negZ.jpeg`]);e.background=n},je=(e,t,o)=>(e.lookAt(o),new Promise((a=>{new i(e.position).to(t,1e3).easing(l.Quadratic.In).start().onUpdate((()=>{e.lookAt(o)})).onComplete((()=>{a(e)}))}))),He=(e,t,o=1)=>{const a=e.position,n=e.rotation,s=e.scale,i=t.position||{x:0,y:0,z:0},l=t.rotation||{x:0,y:0,z:0},r=t.scale||{x:1,y:1,z:1},c=Math.abs(l.x)<2?1:180,d=Math.abs(l.y)<2?1:180,p=Math.abs(l.z)<2?1:180;return{position:[a.x+i.x,a.y+i.y,a.z+i.z],rotation:[n.x+Math.PI/c*l.x,n.y+Math.PI/d*l.y,n.z+Math.PI/p*l.z],scale:[s.x*o*r.x,s.y*o*r.y,s.z*o*r.z]}},$e=e=>e.map((e=>(e.children&&e.children.length>0?e.children=$e(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),Je=e=>{let t=e.clone();return t.children=$e(t.children),t},Oe=(e,t=16777215)=>{const o=e.type;let a=5,n=t,s={x:0,y:0,z:0},i={x:0,y:0,z:0},l=0;switch(o){case"TEXT":break;case"JSQ":a=8,s.y=10,s.z=20,l=62;break;case"SB":case"LDB":case"LQB":a=8,s.z=55,l=45;break;case"XBC":case"LXJ":case"LGJ":case"STLGJ":case"TTLGJ":case"FTLGJ":a=8,s.y=16,s.z=40,l=78;break;case"LQT":a=8,s.x=-75,l=112;break;case"GL":a=8,s.x=83,s.y=2,l=125;break;case"BSHRQ":a=12,s.y=8,s.z=33,l=105;break;case"BSHLQ":a=8,s.y=16,s.z=40,l=88;break;case"FLRB":a=8,s.x=50,s.y=2,l=123;break;case"FJY_X":case"FJZ_X":a=6,l=80,s.y=80,s.z=30;break;case"FJY":case"FJZ":a=6,l=110,s.y=103}let r=e.font||{},c=r.position||{};c&&Object.keys(c).forEach((e=>{s[e]=c[e]}));let d=r.rotation||{};return d&&(Object.keys(d).forEach((e=>{i[e]=d[e]})),i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z),r.size&&(a=r.size),r.color&&(n=r.color),{size:a,color:n,txPos:s,txRot:i,sy:l}},Re=(e,t)=>{e.data&&e.data.type?t(e):e.isScene?t(null):Re(e.parent,t)},Ne=(e,t,o)=>{let a=e.clientWidth/2,n=e.clientHeight/2,s=t.position.clone();const i=t.scale;s.y+=i.x/2;let l=s.project(o);return{left:l.x*a+a,top:-l.y*n+n}},Qe=e=>{e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())},Fe=e=>new Promise((t=>{const o=window.indexedDB.deleteDatabase(e);o.onsuccess=e=>{t(!0)},o.onerror=e=>{t(!1)}})),Ue=async(e,t="THREE__MODEL_DB",o=1)=>{if(!window.indexedDB)return Promise.resolve(null);await((e,t,o)=>new Promise((a=>{window.indexedDB.open(e).onsuccess=n=>{const s=n.target.result,i=s.version;s.close(),i!==t?Fe(e).then((e=>{a(e?t:i)})):s.objectStoreNames.contains(o)?a(i):Fe(e).then((e=>{a(e?t:i)}))}})))(t,o,e);let a=window.indexedDB.open(t,o);return new Promise((t=>{a.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e)||o.createObjectStore(e,{keyPath:"path"})},a.onsuccess=e=>{const o=e.target.result;t(o)},a.onerror=e=>{t(null)}}))},Xe={dbName:"THREE__MODEL__CTL_DB",tbName:"CTL_TB",version:1},Ye=["onClick"],We=Pe(h({name:"three-scene",__name:"index",props:{id:{},bgColor:{type:[String,Boolean],default:void 0},skyCode:{default:"217"},skyCodes:{default:()=>["216","217","218","219","220","221","222","223","224","225"]},skyPath:{default:"/img/sky"},hdr:{},grid:{type:Boolean},baseUrl:{},models:{},config:{},objects:{},lightHelper:{type:Boolean},axesHelper:{type:Boolean},scale:{default:1},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},initModelItemCall:{},getColorCall:{},animationModelType:{},pipeMeshName:{},pipeModelType:{},colorMeshName:{},colorModelType:{default:()=>["FM","XFM"]},textModelType:{},dotTypes:{default:()=>[]},floorModelType:{},cruisePoints:{},cruiseSegment:{},cruiseSpeed:{},cruiseTubeShow:{type:Boolean},pathBg:{},pathWidth:{},pathMap:{},pathTension:{},pathMapSpeed:{},cruisePathOffset:{}},emits:["loaded","select","dblclick","click-dot","click-dialog-dot"],setup(o,{expose:s,emit:h}){const ve=o,Ee=_e(),Ce=ke();b((()=>ve.objects),(e=>{De.isEnd&&oo()})),b((()=>Ee.sidebar.opened),(()=>{clearTimeout(Me.sideToggleTimer),Me.sideToggleTimer=setTimeout(nt,300)})),b((()=>Ce.dataMark),(()=>Le()));const Le=()=>{const e=Date.now();e-Se.tsp<Se.shakeTime&&clearTimeout(Se.timer),Se.tsp=e,Se.timer=setTimeout(yo,Se.shakeTime)},Pe=w(),ze=new v;let Te,$e,Fe,We,Ke,Ze,Ve;ze.background=new _("#fff");const qe=Symbol("_WARNING_MODEL_"),et=Symbol("_CHANGECOLORMATERIALKEY_"),tt=Symbol("_PIPETEXTUREKEY_"),ot=Symbol("_MAINBODYMESHKEY_"),at=()=>{if(Ke=new Q(16777215,1.5),ze.add(Ke),Ze=((e=16777215,t=1,o=800,a=2048,n=1,s=2e3)=>{const i=new r(e,t);return i.position.set(500,800,800),i.castShadow=!0,i.shadow.camera.near=n,i.shadow.camera.far=s,i.shadow.camera.right=o,i.shadow.camera.left=-o,i.shadow.camera.top=o,i.shadow.camera.bottom=-o,i.shadow.mapSize.set(a,a),i})(16777215,1.5),ze.add(Ze),Ve=new r(16777215,1.5),Ve.position.set(-500,800,-800),ze.add(Ve),ve.lightHelper){const e=new F(Ze,1);ze.add(e);const t=new F(Ve,1);ze.add(t)}},nt=()=>{const e=Pe.value;if(!Te)return;const t=(null==e?void 0:e.clientWidth)??0,o=(null==e?void 0:e.clientHeight)??0,a=t/o;Te.aspect=a,Te.updateProjectionMatrix(),_t&&(_t.aspect=a,_t.updateProjectionMatrix()),$e.setSize(t,o)};let st;const it=()=>{st=requestAnimationFrame(it),ct(),Gt(),$e.render(ze,Me.isCruise?_t:Te)},lt=k((()=>(io.value.filter((e=>"DOT"==e.type))||[]).map((e=>{const t=e.deviceCode||"";e.value=Ce.getKeyValue(t).value;const o=t.split("_")[0]||"";return Ce.getRunStatus(o)>0||["SYS","CSC"].includes(o)?e.show=!0:e.show=!1,e.value=Number(Number(e.value||0).toFixed(2)),e})))),rt=(e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let a=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{a.includes(e)||a.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!a.includes(o)&&a.push(o),!!o})).length==e.length&&(o=o.concat(a))}else{const a=t.find((t=>t.deviceCode==e));a&&o.push(a)}})),o},ct=()=>{H(),Fe.update();let e=yt.getDelta();if(Me.devices.length&&Me.devices.forEach((t=>{let o=t.data,a=t.extra,n=t[qe],s=t[tt];if(a&&(null==o?void 0:o.status)>0&&a.mixer.update(e),n&&(null==o?void 0:o.error)>0&&n.mixer.update(e),s){const e=o.bind||[],t=io.value.filter((e=>"DOT"!==e.type&&!(ve.pipeModelType||[]).includes(e.type)&&e.deviceCode&&((null==e?void 0:e.status)??0)>0)),a=rt(e,t),n=a.length>0;let i=.01;if(o.left&&o.right){const{left:e,right:t}=o,n=rt(t,a).length>0;i=rt(e,a).length>0&&n?0:n?-.01:.01}n&&(s.material.map.offset.y-=i),s.material.opacity=n?.3:0}})),Ge.show&&Ge.select.length){const e=Pe.value,t=Ne(e,Ge.select[0],Me.isCruise?_t:Te);Ge.pos=t,Ge.style.left=t.left+"px",Ge.style.top=t.top+"px"}dt()},dt=()=>{const e=Pe.value;let t=e.clientWidth/2,o=e.clientHeight/2;io.value.forEach(((e,a)=>{if("DOT"!=e.type)return;let n=e.position,s=new $(null==n?void 0:n.x,null==n?void 0:n.y,null==n?void 0:n.z).project(Me.isCruise?_t:Te),i=s.x*t+t,l=-s.y*o+o;io.value[a].style.left=i+"px",io.value[a].style.top=l+"px"}))};b((()=>ve.bgColor),(e=>{ze.background=new _(e)})),b((()=>ve.skyCode),(e=>{ve.bgColor||(Ae(ze,ve.baseUrl,ve.skyPath,e),pt.value=e)}));const pt=w(ve.skyCode),ut=()=>{const e=ve.skyCodes||[];let t=e.findIndex((e=>e==pt.value))+1;t>=e.length&&(t=0),pt.value=e[t],Ae(ze,ve.baseUrl,ve.skyPath,pt.value)},mt=h;let yt,ft,gt,ht;const bt=Xe.tbName;b((()=>ve.cruisePoints),(async()=>{await ee(),wt(),vt(),St()}));const wt=()=>{kt&&(Qe(kt),ze.remove(kt),kt=void 0)},vt=()=>{Me.isCruise=!1,Fe.enabled=!Me.isCruise,Pt=Me.isCruise};let _t,kt,xt,Et,Ct,Lt,Pt=!1,zt=0,Tt=1,Mt=0;const St=()=>{const e=Date.now();if(e-Mt<300)return;Mt=e,zt=0;let t=[];const o=ve.cruisePoints||[];if(0!=o.length){for(let e=0;e<o.length;e++){const a=o[e];t.push(new $(a[0],a[1],a[2]))}if(_t=Ie(Pe.value,1,1e6),_t.lookAt(Fe.target),Ct=new te(t,!0,"catmullrom",ve.pathTension??0),kt=new oe,ze.add(kt),ve.cruiseTubeShow){xt=new p(new ae(2),new ne({color:0,opacity:.8,transparent:!0})),kt.add(xt),Et=(new se).setFromPoints(t);const e=new ie({color:255,opacity:1,transparent:!0}),o=new le(Et,e);kt.add(o);const a=new re(Ct,100,2,3,!0),n=new ce({color:16711935,opacity:.1,transparent:!0}),s=new p(a,n),i=new ne({color:16715760,opacity:.3,wireframe:!0,transparent:!0}),l=new p(a,i);s.add(l),kt.add(s)}Bt()}else Ct=void 0},Bt=async()=>{const e=ve.pathBg||ve.baseUrl+"/model/pipe/arrow.png",t=ve.pathMap||[.1,1],o=await(new de).loadAsync(e);if(!kt)return;o.wrapS=pe,o.repeat.x=t[0],o.repeat.y=t[1],o.anisotropy=$e.capabilities.getMaxAnisotropy(),Lt=o;const a=new d({map:o,opacity:.5,transparent:!0,depthWrite:!1}),n=new $(0,1,0),s=new me;s.set(Ct.getPoints(1e3),5,1,n,!1);const i=new ue;i.update(s,{width:ve.pathWidth??15,arrow:!1});const l=new p(i,a);l.name="path",kt.add(l)},Dt=()=>1e3*(ve.cruiseSegment??2),Gt=()=>{if(!Ct)return;Lt&&(Lt.offset.x-=ve.pathMapSpeed??.006),Pt&&(zt+=Tt*(ve.cruiseSpeed??1));const e=Dt(),t=zt%e/e,o=Ct.getPointAt(t),a=ve.cruisePathOffset??3;if(ve.cruiseTubeShow&&xt){const e=It(a,o);xt.position.copy(e)}if(!Me.isCruise)return;const n=.03;let s=t-n;t<n&&(s=t+.97);const i=It(a,Ct.getPointAt(s));_t.position.copy(i),_t.lookAt(It(a,o))},It=(e,t)=>new $(t.x,t.y+e,t.z),At=e({click:!1,tsp:0}),jt=e=>{Nt(e,ft),gt.setFromCamera(ft,Me.isCruise?_t:Te);const t=Me.devices;let o=gt.intersectObjects(t,!0);if(o.length){const e=o[0].object;Re(e,(t=>{if(!t)return;mt("dblclick",t);const o=t.data,a=Be.list.findIndex((e=>t.uuid===e.uuid));"function"==typeof o.onDblclick&&o.onDblclick(U(o),e,t,a),a>-1&&Ht(a)}))}},Ht=e=>{var t,o,a,n;if(0===Be.list.length)return;const s=void 0!==e&&e>-1;if((null==(t=ve.config)?void 0:t.floorExpandHiddenOther)&&Me.devices.forEach((e=>{var t;e.visible=(t=e,Be.list.findIndex((e=>t.uuid===e.uuid))>-1||!s)})),Be.list.forEach(((t,o)=>{var a,n,r;const c=t._pos;let d=o-(s?e:o);const p=(null==(a=ve.config)?void 0:a.floorExpandMargin)||200,u=(null==(n=ve.config)?void 0:n.floorExpandMode)||"UD",m=d*p,y=((null==c?void 0:c.y)??0)+m,f=e==o?((null==c?void 0:c.z)??0)+p:(null==c?void 0:c.z)??0;if("UD"===u){if(t.position.y===y)return}else if("BA"===u&&t.position.z===f)return;if(null==(r=t.data)?void 0:r.mark){const a=t.data.mark,n=Me.devices.filter((e=>{var t;return(null==(t=e.data)?void 0:t.followMark)===a}));$t(u,n,m,e==o?p:0)}new i(t.position).to({y:"UD"===u?y:t.position.y,z:"BA"===u?f:t.position.z},500).easing(l.Quadratic.Out).start()})),!(null==(o=ve.config)?void 0:o.floorExpandChangeViewAngle))return;let r,c;if(s){const t=Be.list[e]||{};r=null==(a=t.data)?void 0:a.to,r&&(c=(null==(n=t.data)?void 0:n.target)||t._pos)}r=ao(r,c),(e=>{const t=Te.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1})(r)||je(Te,r,Fe.target)},$t=(e,t,o,a)=>{0!==t.length&&t.forEach((t=>{const n=t._pos,s="UD"==e?((null==n?void 0:n.y)??0)+o:(null==n?void 0:n.y)??0,r="BA"==e?((null==n?void 0:n.z)??0)+a:(null==n?void 0:n.z)??0;new i(t.position).to({y:s,z:r},500).easing(l.Quadratic.Out).start()}))},Jt=e=>{At.click=!0,At.tsp=e.timeStamp},Ot=e=>{Qt(e),At.click},Rt=e=>{var t,o;At.click=!1;const a=e.timeStamp-At.tsp<300;2==e.button?a&&"function"==typeof(null==(t=ve.config)?void 0:t.back)&&(null==(o=ve.config)||o.back(screen)):0==e.button?a&&Qt(e):e.button},Nt=(e,t)=>{if(!e||!t)return;const o=Pe.value;let a=(null==o?void 0:o.getBoundingClientRect())??{left:0,top:0};t.x=(e.clientX-a.left)/(1*o.clientWidth)*2-1,t.y=-(e.clientY-a.top)/(1*o.clientHeight)*2+1},Qt=e=>{const t=Pe.value;Nt(e,ft),gt.setFromCamera(ft,Me.isCruise?_t:Te);let o="pointerdown"==e.type||"pointerup"==e.type;const a=ze.children.filter((e=>e.visible&&!!e.data&&ve.dotTypes.includes(e.data.type)));let n=gt.intersectObjects(a,o);if(t.style.cursor=n.length>0?"pointer":"auto",o)if(n.length){const e=n[0].object;Re(e,(e=>{if(!e)return;const t=e.data;if(!t.type)return void(Ge.show=!1);const o=U(t);mt("select",o),"function"==typeof t.onClick?t.onClick(o):(Ge.select=[e],Ge.show=!0,Ft())}))}else Ge.select.length=0,Ge.show=!1},Ft=()=>{const e=Pe.value,t=Ge.select[0],o=t.data;Ge.data=o,Ge.title=(null==o?void 0:o.name)||"";const a=Ne(e,t,Me.isCruise?_t:Te);Ge.pos=a,Ge.style.left=a.left+"px",Ge.style.top=a.top+"px",mt("click-dialog-dot",o,a)};let Ut;const Xt=()=>{const e=ve.models,t=e.length;let o=0;if(0==t)return De.isEnd=!0,void(De.show=!1);De.isEnd=!1,De.percentage=0;const a=async()=>{const n=e[o],{key:s,name:i,map:l,url:r,size:c,range:d,font:p,warning:u}=n;if(De.list.push({name:`${i} Model`,pro:0}),l){let e=(new de).load(ve.baseUrl+l),t=new ye({map:e}),o=new fe(t),a=c,n=c;d&&(a=d.x,n=d.y),o.scale.set(a,n,1),o.name="sprite",Me.loadPart[s]=o}else p?await Wt(p,c):u?Ut=await Kt(s||qe,u,c):await Kt(s,r,c,n);o++,De.loaded+=c*Me.modelSizeKB,o==t?(De.isEnd=!0,oo()):a()};De.show=!0,a()};let Yt;const Wt=(e,t=0)=>{const o=new ge;return!xe(e)&&e.indexOf(ve.baseUrl)<0&&(e=ve.baseUrl+e),new Promise((async a=>{const n=await Zt(e,t);if(n)return Yt=o.parse(JSON.parse(n)),void setTimeout((()=>{a(Yt)}),10);o.load(e,(t=>{Yt=t,qt(e),a(t)}))}))},Kt=(e,t,o=0,a)=>{const n=new he;n.setDecoderPath("draco/gltf/");const s=new be;return s.setDRACOLoader(n),new Promise((async n=>{const i=Me.colors.normal[e]||Me.colors.normal.color;!xe(t)&&t.indexOf(ve.baseUrl)<0&&(t=ve.baseUrl+t);const l=await Zt(t,o);if(l){const t=l.scene.children[0],o=Vt(e,i,t,l.animations,a);return void n(o)}let r=t.split(".").pop().toLowerCase();if("glb"!==r)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+r);s.load(t,(o=>{let s=o.scene.children[0];const l=Vt(e,i,s,o.animations,a);qt(t),n(l)}),to)}))},Zt=(e,t=0)=>{const o=new be;return new Promise((async a=>{const n=q.get(e);if(n)n instanceof ArrayBuffer?(to({loaded:n.byteLength}),o.parse(n,"",(t=>{q.add(e,t),a(t)}))):(to({loaded:t*Me.modelSizeKB}),setTimeout((()=>{a(n)}),10));else{const t=await((e,t,o)=>{if(!e||!t||!o)return Promise.resolve(null);const a=e.transaction([t],"readonly").objectStore(t).get(o);return new Promise(((e,t)=>{a.onsuccess=t=>{const o=t.target.result;e(o)},a.onerror=e=>{t(e)}}))})(ht,bt,e);if(t&&t.data){const e=t.data;"string"==typeof e?(to({loaded:e.length}),q.add(t.path,e),setTimeout((()=>{a(e)}),10)):(to({loaded:e.byteLength}),o.parse(e,"",(e=>{q.add(t.path,e),a(e)})))}else a(null)}}))},Vt=(e,t,o,a,n)=>{var s;if(!o)return;let i;if((null==(s=ve.pipeModelType)?void 0:s.includes(e))&&n){const{pipeMap:e,repeat:t=[1,1]}=n;i=(new de).load(ve.baseUrl+e),i.wrapS=pe,i.wrapT=pe,i.repeat.set(t[0]??1,t[1]??1)}const l=Je(o);return l.traverse((e=>{var o;i&&(null==(o=ve.pipeMeshName)?void 0:o.includes(e.name))?e.material=new ce({side:we,transparent:!0,opacity:0,map:i.clone()}):((e,t=6776165,o,a)=>{const{type:n,name:s}=e;if(n.indexOf("Light"),["地面","底座","基础","基础底座","冷却塔基础"].includes(s))e.receiveShadow=!0;else if(o.includes(s)){if(!e.material)return;e.material instanceof Array?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t)}else e.isMesh&&(a&&(e.material.envMap=a),e.castShadow=!0)})(e,t,ve.colorMeshName||[])})),l.animations=a,Me.loadPart[e]=l,l},qt=e=>{const t=q.get(e);if(t&&ht){ht.transaction(bt,"readwrite").objectStore(bt).add({path:e,data:t})}},eo=async(e,t)=>{const o="_BASE_";if(!e){const e=Me.loadPart[o];if(e){const t=ze.children.find((t=>t.uuid===e.uuid));ze.remove(t),Qe(e),Me.loadPart[o]=null}return}const a=await Kt(o,e),{position:n,scale:s,rotation:i}=He(a,t);return a.scale.set(...s),a.position.set(...n),a.rotation.set(...i),ze.add(a),Promise.resolve(a)},to=e=>{const{loaded:t}=e,o=De.total;let a=Number((t+De.loaded)/o*100);a>100&&(a=100),De.percentage=Number(a.toFixed(2))},oo=async()=>{var e,t,o;De.percentage=100,De.show=!1,Ge.show=!1,Me.devices.forEach((e=>{const t=ze.children.find((t=>{var o,a;return(null==(o=t.data)?void 0:o.id)==(null==(a=e.data)?void 0:a.id)}));Qe(e),Qe(t),ze.remove(t)})),Me.devices.length=0,Be.list.length=0,await ee(),eo(),lo(),await so(),"function"==typeof(null==(e=ve.config)?void 0:e.load)&&(null==(t=ve.config)||t.load(ze));const a=(null==(o=ve.config)?void 0:o.floorExpandIndex)||-1;if(a>-1&&Be.list.length)Ht(a),mt("loaded");else{const e=ao();je(Te,e,Fe.target).then((()=>{mt("loaded")}))}},ao=(e,t)=>{const o=ve.config||{},a=e||o.to||{x:-104,y:7,z:58},n=t||o.target||{x:0,y:0,z:0};return Fe.target.set(n.x,n.y,n.z),a},no=async e=>{var t,o;if(!e)return;const a=e.type;let n=Me.loadPart[a];if(!n)return void(e.url&&await eo(e.url,e));const s=ve.colorMeshName||[],i=ve.animationModelType||[],l=ve.floorModelType||[],r=ve.textModelType||[];let h=Je(n);const{position:b,scale:w,rotation:v}=He(h,e),[_,k,x]=b;if(h.scale.set(...w),r.includes(a)&&Yt){const t=new u;t.add(h);let o=((e,t,o)=>{if(!t)return;const a=Oe(e,o);let n=new c(e.name||"",{font:t,size:a.size||5,height:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const s=a.txRot;n.rotateX(s.x),n.rotateY(s.y),n.rotateZ(s.z);const i=a.txPos;n.computeBoundingBox(),n.computeVertexNormals();let l=.5*(n.boundingBox.max.x-n.boundingBox.min.x),r=.5*(n.boundingBox.max.z-n.boundingBox.min.z),u=new d({color:a.color||16777215,flatShading:!1}),m=new p(n,u);return m.castShadow=!0,m.position.set((i.x||0)-l,i.y||0,(i.z||0)-r),m})(e,Yt,Me.colors.normal.text);t.add(o),t.name=e.name,h=t}if(i.includes(a)&&Ut){if("Group"!==h.type){const e=new u;e.add(h),h=e}const{group:t,action:o,mixer:a}=((e,t,o,a=100,n=1)=>{if(!o)return;const s=Oe(t);let i=new u,l=Je(o);l.scale.set(n,n,n),l.position.y=s.sy,i.add(l);let r=new m(12717056,8,a,0);r.name="灯光",r.position.y=s.sy+30,i.add(r),i.name=e;let c=new y(i),d=new f("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),p=new f("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),h=new f("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),b=new g("warning_",1,[d,p,h]),w=c.clipAction(b);return w.paused=!0,w.play(),i.visible=!1,{group:i,action:w,mixer:c}})(qe,e,Ut);h.add(t),h[qe]={action:o,mixer:a}}h.position.set(_,k,x),h.rotation.set(...v),h.data=e;const E=h.children.filter((e=>s.includes(e.name)));if(h[et]=E,null==(t=ve.pipeModelType)?void 0:t.includes(a)){const t=h.children.find((e=>{var t;return null==(t=ve.pipeMeshName)?void 0:t.includes(e.name)}));if(t){t.material.map=t.material.map.clone();const o=e.map;if(o){const e=t.material.map.repeat;t.material.map.repeat.set(e.x*(o[0]??1),e.y*(o[1]??1))}h[tt]=t}}if(ve.mainBodyChangeColor){const e=((null==(o=h.children[0])?void 0:o.children)||[]).filter((e=>(ve.mainBodyMeshName||[]).includes(e.name)));h[ot]=e}if(ze.add(h),(e.followMark||e.mark)&&(h._pos={x:_,y:k,z:x}),Me.devices.push(h),l.includes(a)&&(h._pos={x:_,y:k,z:x},Be.list.push(h)),i.includes(a)){const e=((e,t)=>{let o=[];return e&&e.length?(function e(a){a.forEach((a=>{t.includes(a.name)&&o.push(a),a.children&&e(a.children)}))}(e),o):[]})(h.children,s);let t,o=new y(h);n.animations.length&&(t=o.clipAction(n.animations[0]),t.paused=!0,t.timeScale=1.5,t.play()),h.extra={action:t,mixer:o,meshs:e}}return Promise.resolve()},so=()=>{let e=0,t=io.value.length;return new Promise((o=>{if(0==t)return;const a=async()=>{const n=io.value[e];await no(n),e++,e<t?a():o(e)};a()}))},io=w([]),lo=()=>{io.value.length=0;const e=U(ve.objects)||[],t=Ce.formatData(e,ve.initModelItemCall);io.value=t},ro=()=>{},co=e=>{Tt=1;const t=e.keyCode;if(Me.isCruise)switch(t){case 32:Pt=!Pt;break;case 38:case 87:Pt||(zt+=10);break;case 83:case 40:Pt||(zt-=10,zt<0&&(zt=Dt()))}},po=e=>{const t=e.keyCode;if(Me.isCruise&&e.repeat)switch(t){case 38:case 87:Pt?(Tt*=1.5,Tt>10&&(Tt=10)):zt+=5;break;case 83:case 40:Pt||(zt-=5,zt<0&&(zt=Dt()))}};window.addEventListener("keydown",po,!1),window.addEventListener("keyup",co,!1);const uo=()=>{(ve.cruisePoints||[]).length&&(Me.isCruise=!Me.isCruise,Fe.enabled=!Me.isCruise,Pt=Me.isCruise)},mo=()=>{Me.devices.forEach(((e,t)=>{if(!e.data)return;const{type:o}=e.data,a=e.data;if(!a.deviceCode)return;const n=Math.random()>.5?1:0,s=Math.random()>.5?1:0;a.status=n,a.error=s;const i=s>0?"error":n>0?"runing":"normal",l=Me.colors[i];let r=l[o]||l.color;if("function"==typeof ve.getColorCall){const e=ve.getColorCall(a);e&&(r=e)}fo(o,e,l,r,0==n,s>0)}))},yo=()=>{const e=ve.animationModelType||[],t=ve.colorModelType||[],o=ve.pipeModelType||[],a=e.concat(t);Me.devices.forEach(((e,t)=>{let n=e.data;if(!n)return;let s=n.type;if(!a.includes(s)||o.includes(s)||"DOT"==s)return;const i=n.deviceCode;if(!i)return;const l=Ce.getRunStatus(i),r=Ce.getErrorStatus(i);n.status=l,n.error=r;const c=r>0?"error":l>0?"runing":"normal",d=Me.colors[c];let p=d[s]||d.color;if("function"==typeof ve.getColorCall){const e=ve.getColorCall(n);e&&(p=e)}fo(s,e,d,p,0==l,r>0)}))},fo=(e,t,o,a,n,s)=>{if(ve.colorModelType.includes(e)){return void(t[et]||[]).forEach((e=>{e.material.color.set(a)}))}const i=t.extra;if(i&&"DOT"!=e){i.action&&(i.action.paused=n);(i.meshs||[]).forEach((e=>{"Group"==e.type?e.children.forEach((e=>{e.material.color.set(a)})):e.material.color.set(a)}))}const l=t[qe];if(l){const e=t.children.find((e=>e.name==qe));e&&(e.visible=s,l.action.paused=!s)}if(ve.mainBodyChangeColor&&t[ot]){const e=o.main;e&&t[ot].forEach((t=>{t.material.color.set(e)}))}},go=()=>{ve.models.forEach((e=>{const t=e.size*Me.modelSizeKB;De.total+=t}));const e=Pe.value;if($e=(e=>{const o=e.clientWidth,a=e.clientHeight,n=new t({antialias:!0,alpha:!0});return n.outputEncoding=void 0,n.setSize(o,a),n.setPixelRatio(window.devicePixelRatio),e.appendChild(n.domElement),n})(e),Te=Ie(e,1,1e6),at(),Fe=((e,t)=>{const o=new a(e,t.domElement);return o.minDistance=1,o.maxPolarAngle=.45*Math.PI,o.target.set(0,0,0),o})(Te,$e),Fe.maxPolarAngle=.46*Math.PI,Fe.screenSpacePanning=!1,ve.grid&&(We=(()=>{let e=new n(800,80,10592673,10592673);return e.material.opacity=.3,e.material.transparent=!0,e})(),ze.add(We)),ve.axesHelper){let e=new J(50);ze.add(e)}Me.isCruise=!1,Tt=1,ve.hdr?(new X).load(ve.baseUrl+ve.hdr,(e=>{e.mapping=Y,ze.background=e,ze.environment=e})):null!=ve.bgColor?ze.background=ve.bgColor?new _(ve.bgColor):null:Ae(ze,ve.baseUrl,ve.skyPath,ve.skyCode),$e.shadowMap.enabled=!0,$e.shadowMap.type=W,yt=new K,ft=new Z,gt=new V,Ue(bt,Xe.dbName,Xe.version).then((e=>{e?(q.enabled=!0,ht=e,Xt()):Xt()})),$e.domElement.addEventListener("dblclick",jt),$e.domElement.addEventListener("pointerdown",Jt),$e.domElement.addEventListener("pointermove",Ot),$e.domElement.addEventListener("pointerup",Rt)};return x((()=>{if(!ve.models||0==ve.models.length)throw new Error("模型数据不可为空");go(),it(),window.addEventListener("resize",nt,!1)})),E((()=>{clearTimeout(Se.timer),Ce.wsClose(),clearInterval(Me.timer),clearTimeout(Me.sideToggleTimer),window.removeEventListener("resize",nt),window.removeEventListener("keyup",co),window.removeEventListener("keydown",po),cancelAnimationFrame(st);try{ze.clear(),$e.dispose(),$e.forceContextLoss(),$e.content=null;let e=$e.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext()}catch(e){}})),s({floorAnimate:Ht,setControls:e=>{"object"==typeof e&&Object.keys(e).forEach((t=>{Fe[t]=e[t]}))},resize:nt}),(e,t)=>{const o=O;return R(),C("div",{class:T(e.$style["three-scene"])},[L("div",{class:T([e.$style.operation,"operation"]),onDblclick:t[0]||(t[0]=M((()=>{}),["stop"]))},[(R(),P(o,{key:0,onClick:mo,type:"success"},{default:z((()=>[N("随机更新")])),_:1})),(R(),P(o,{key:1,onClick:uo,type:"warning"},{default:z((()=>[N("巡航")])),_:1})),(R(),P(o,{key:2,onClick:ro,type:"success"},{default:z((()=>[N("场景坐标")])),_:1})),(R(),P(o,{key:3,onClick:ut,type:"warning"},{default:z((()=>[N("切换背景")])),_:1}))],34),L("div",{ref_key:"containerRef",ref:Pe,class:T(e.$style.container),onKeyup:co},null,34),S(De).show?(R(),C("div",{key:0,class:T(e.$style.loading),style:B({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[1]||(t[1]=M((()=>{}),["stop"]))},[L("div",{class:T(e.$style.progress),style:B({"--percentage":S(De).percentage+"%"})},[L("div",{class:T(e.$style["bar-out"])},[L("div",{class:T(e.$style.bar)},null,2)],2),L("div",{class:T(e.$style.text)},D(S(De).percentage)+"%",3)],6)],38)):G("",!0),S(Ge).show?(R(),C("div",{key:1,class:T(e.$style.dialog),style:B(S(Ge).style)},[I(e.$slots,"dialog",{data:S(Ge).data,title:S(Ge).title,pos:S(Ge).pos})],6)):G("",!0),L("div",{class:T(e.$style["dot-wrap"])},[(R(!0),C(A,null,j(S(lt),((t,o)=>(R(),C(A,null,[t.show?(R(),C("div",{class:T(e.$style.dot),key:o,style:B(t.style),onClick:e=>(e=>{mt("click-dot",U(e))})(t)},[L("div",{class:T(e.$style.bg)},null,2),L("span",{class:T(e.$style.inner)},D(t.value)+D(t.unit),3)],14,Ye)):G("",!0)],64)))),256))],2)],2)}}}),[["__cssModules",{$style:{"three-scene":"_three-scene_16vpt_2",container:"_container_16vpt_11",operation:"_operation_16vpt_15",loading:"_loading_16vpt_22",progress:"_progress_16vpt_36","bar-out":"_bar-out_16vpt_40",bar:"_bar_16vpt_40","striped-flow":"_striped-flow_16vpt_1",text:"_text_16vpt_56",dialog:"_dialog_16vpt_72","dot-wrap":"_dot-wrap_16vpt_77",dot:"_dot_16vpt_77",bg:"_bg_16vpt_93",inner:"_inner_16vpt_101"}}]]),Ke=[{key:"JSQ",name:"分集水器",size:.3,url:"/分集水器.glb"},{key:"LXJ",name:"离心机",size:.65,url:"/离心机.glb"},{key:"LGJ",name:"螺杆机",size:3.6,url:"/螺杆机.glb"},{key:"LGJ_2",name:"双机头螺杆机",size:6.43,url:"/螺杆机-双机头.glb"},{key:"LGJ_3",name:"三机头螺杆机",size:9.34,url:"/螺杆机-三机头.glb"},{key:"LGJ_4",name:"四机头螺杆机",size:12.34,url:"/螺杆机-四机头.glb"},{key:"LQT",name:"冷却塔",size:1.57,url:"/冷却塔.glb"},{key:"SB",name:"水泵",size:1.24,url:"/水泵.glb"},{key:"LDB",name:"冷冻泵",size:1.25,url:"/冷冻泵.glb"},{key:"LQB",name:"冷却泵",size:1.25,url:"/冷却泵.glb"},{key:"BSHLQ",name:"板式换热器-制冷",size:.87,url:"/板式换热器-制冷.glb"},{key:"XBC",name:"蓄冰槽",size:5.4,url:"/蓄冰槽.glb"},{key:"FM",name:"阀门",size:.16,url:"/阀门.glb"},{key:"XFM",name:"阀门-新",size:.47,url:"/阀门-新.glb"},{key:"LDH_PIPE_ERECT",name:"冷冻回水",size:.01,url:"/pipe/冷冻回.glb",pipeMap:"/model/pipe/002.png"},{key:"LDH_PIPE_RIGHT_ANGLE",name:"冷冻回-弯头",size:.12,url:"/pipe/冷冻回-弯头.glb",repeat:[1,.25],pipeMap:"/model/pipe/002.png"},{key:"LDG_PIPE_ERECT",name:"冷冻供水",size:.01,url:"/pipe/冷冻供.glb",pipeMap:"/model/pipe/002.png"},{key:"LDG_PIPE_RIGHT_ANGLE",name:"冷冻供-弯头",size:.12,url:"/pipe/冷冻供-弯头.glb",repeat:[1,.25],pipeMap:"/model/pipe/002.png"},{key:"LQG_PIPE_ERECT",name:"冷却供水",size:.01,url:"/pipe/冷却供.glb",pipeMap:"/model/pipe/002.png"},{key:"LQG_PIPE_RIGHT_ANGLE",name:"冷却供-弯头",size:.12,repeat:[1,.25],url:"/pipe/冷却供-弯头.glb",pipeMap:"/model/pipe/002.png"},{key:"LQH_PIPE_ERECT",name:"冷却回水",size:.01,url:"/pipe/冷却回.glb",pipeMap:"/model/pipe/002.png"},{key:"LQH_PIPE_RIGHT_ANGLE",name:"冷却回-弯头",size:.12,url:"/pipe/冷却回-弯头.glb",repeat:[1,.25],pipeMap:"/model/pipe/002.png"},{key:"JGBS",name:"警告标识",size:.2,warning:"/model/cool/警告标识.glb"},{key:"FONT_WRYH",name:"微软雅黑字体",size:26.35,font:"/font/YaHei_Regular.json"}].map((e=>{if(e.url){if(e.url.indexOf("test")>-1)return e;const t=e.url.indexOf("/pipe")>-1;e.url="/model"+(t?"":"/cool")+e.url}return e})),Ze=["电动阀门","叶轮","螺杆A","螺杆B","螺杆C","螺杆D","螺杆E","螺杆F","螺杆G","螺杆H"],Ve=["贴图"],qe=["LDH_PIPE_ERECT","LDH_PIPE_RIGHT_ANGLE","LDG_PIPE_ERECT","LDG_PIPE_RIGHT_ANGLE","LQG_PIPE_ERECT","LQG_PIPE_RIGHT_ANGLE","LQH_PIPE_ERECT","LQH_PIPE_RIGHT_ANGLE"],et=["LDB","LQB","JSQ","SB","LXJ","LGJ","LGJ_2","LGJ_3","LGJ_4","LQT","BSHLQ","XBC"],tt=["LDB","LQB","SB","LXJ","LGJ","LGJ_2","LGJ_3","LGJ_4","LQT"],ot=Pe(h({__name:"index",setup(t){const o=Le(),a=w(),n=w([]),s=w([]),i=e({to:{x:0,y:1300,z:0}}),l=e=>{},r=e=>{},c=()=>{};var d,p;return(p={id:"123456",type:0},Ee.get(Ce.monitor.get_config,p,!1).then((e=>{const t=ze.find((t=>t.id==e.id));if(t&&Object.keys(t).forEach((o=>{e[o]=t[o]})),"string"==typeof e.configJson)try{e.configJson=JSON.parse(e.configJson)}catch(o){e.configJson={}}return e}))).then((e=>{let t=e.pipConfig||[];t=t.concat(e.jsonList);const a=e.modelUrl;t.unshift({name:e.name,type:"",style:{},url:a?`${o.oss}${a}`:""}),n.value=t;let l=e.configJson;Object.keys(l).forEach((e=>{i[e]=l[e]})),s.value=l.cruise||[]})),null==(d=a.value)||d.setControls({screenSpacePanning:!0,minDistance:100,maxDistance:2e3}),(e,t)=>{const d=We;return R(),C("div",{class:T(e.$style.wrapper)},[ve(d,{ref_key:"threeSceneRef",ref:a,"sky-code":"223","base-url":S(o).oss,models:S(Ke),objects:S(n),config:S(i),"pipe-mesh-name":S(Ve),"pipe-model-type":S(qe),"color-mesh-name":S(Ze),"text-model-type":S(et),"animation-model-type":S(tt),"main-body-change-color":!0,"cruise-points":S(s),"cruise-tube-show":!1,"cruise-path-offset":15,"path-tension":0,onClickDot:l,onDblclick:r,onLoaded:c},null,8,["base-url","models","objects","config","pipe-mesh-name","pipe-model-type","color-mesh-name","text-model-type","animation-model-type","cruise-points"])],2)}}}),[["__cssModules",{$style:{wrapper:"_wrapper_uey3r_2"}}]]),at=Object.freeze(Object.defineProperty({__proto__:null,default:ot},Symbol.toStringTag,{value:"Module"}));export{Te as _,We as a,at as i};
