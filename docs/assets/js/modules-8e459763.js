import{bg as e,am as t}from"./vendor-ebf5717c.js";import{c as s,a as i,r as a}from"./router-b01c2f88.js";import{g as o,s as n,A as r,a as c,b as h,c as d,d as l,r as u,e as w}from"./common-f34ee3bc.js";import{A as p,D as m,a as g,K as V}from"./config-b995786f.js";import{i as f}from"./locales-c8bf54b5.js";const O="production",v="",C=o("SITE_SKIN")||"light";"dark"==C&&document.documentElement.classList.add("dark");const b=f.global.locale.value,k="XXX_SIDEBAR_STATUS",j={i18n:!0,language:b,isEn:"en"==b,ISPROD:"production"==O,isAutoJump:!1,logo:{custom:!1,normal:"",small:""},skin:C,toggleSkin:!0,tag:{show:!0},navbar:{show:!0,hasBreadcrumb:!0},sidebar:{hasToggleBtn:!0,opened:"1"==o(k),withoutAnimation:!1},module:{show:!1,current:"",active:"",list:[]},staticPath:v,areaList:[],oss:""},L=e({id:"app",state:()=>j,getters:{},actions:{updateLogo(e){e.normal&&(this.logo.normal=e.normal),e.small&&(this.logo.small=e.small);let t=Boolean(e.normal||e.small);this.logo.custom=t},updateSkin(e){this.skin=e,"dark"==e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),n("SITE_SKIN",e)},updateTagsStatus(e){this.tag.show=e},toggleSideBar(){const e=this.sidebar;e.opened=!e.opened,e.withoutAnimation=!1,e.opened?n(k,"1"):n(k,"0")},updateLangeuage(e){f.global.locale.value=e,n("LANGUAGE",e),this.$patch({isEn:"en"==e,language:e})},updatSidebarStatus(e){this.navbar.show=e},updateModules(e){this.module.list=e},updateModuleStatus(e){this.module.active=e},area(e=0){return r.get(p.area.tree,{ParentCode:e},!1).then((t=>{if(t=t.map((t=>(0==e&&this.area(t.AreaCode),{...t,label:t.Name,value:t.AreaCode}))),0==e)this.areaList=t;else{let s=this.areaList.findIndex((t=>t.value==e));this.areaList[s].children=t}}))}}});function _(e,t){const s=[];return e.forEach((e=>{const i={...e};(function(e,t){if(t.meta&&t.meta.sn)return e.includes(t.meta.sn);return!0})(t,i)&&(i.children?(i.children=_(i.children,t),i.children.length&&s.push(i)):s.push(i))})),s}function S(e){return e.forEach((e=>{e.children&&(e.children=S(e.children))})),e.sort(((e,t)=>(e.meta.order||0)-(t.meta.order||0)))}const A=[],D=[],I=e({id:"auth",state:()=>({routes:A,addRoutes:D}),actions:{generateRoutes(e){let t=[];return t=e.includes("ALL_SN")?i||[]:_(i,e),this.$patch({addRoutes:S(t),routes:[...s,...t]}),t}}}),E=[],P=[],R=e({id:"tags",state:()=>({visitedViews:E,cachedViews:P}),actions:{addView(e){this.addVisitedView(e),this.addCachedView(e)},addVisitedView(e){this.visitedViews.some((t=>t.path===e.path))||this.visitedViews.push(Object.assign({},e,{title:e.meta.title||"no-name"}))},addCachedView(e){this.cachedViews.includes(e.name)||e.meta.cache&&this.cachedViews.push(e.name)},delView(e){return this.delVisitedView(e),this.delCachedView(e),{visitedViews:[...this.visitedViews],cachedViews:[...this.cachedViews]}},delVisitedView(e){for(const[t,s]of this.visitedViews.entries())if(s.path===e.path){this.visitedViews.splice(t,1);break}},delCachedView(e){for(const t in this.cachedViews)if(t===e.name){let e=this.cachedViews.indexOf(t);this.cachedViews.splice(e,1);break}},delOthersViews(e){return this.delOthersVisitedViews(e),this.delOthersCachedViews(e),{visitedViews:[...this.visitedViews],cachedViews:[...this.cachedViews]}},delOthersVisitedViews(e){this.visitedViews=this.visitedViews.filter((t=>t.meta.affix||t.path===e.path))},delOthersCachedViews(e){for(const t in this.cachedViews)if(t===e.name){let e=this.cachedViews.indexOf(t);this.cachedViews=this.cachedViews.slice(e,e+1);break}},delAllViews(){return this.delAllVisitedViews(),this.delAllCachedViews(),{visitedViews:[...this.visitedViews],cachedViews:[...this.cachedViews]}},delAllVisitedViews(){this.visitedViews=this.visitedViews.filter((e=>e.meta.affix))},delAllCachedViews(){this.cachedViews=[]},updateVisitedView(e){for(let t of this.visitedViews)if(t.path===e.path){t=Object.assign(t,e);break}}}}),T="ws.ip",$="/oss",y={staticPath:"",wsIp:c(T)||"",oss:$,origin:"",bucket:$},W=e({id:"assets",state:()=>y,actions:{updateWsIp(e){this.wsIp=e,h(T,e)},getDeviceSrc(e){const{error:t=0,status:s=0}=e;let i=t>0?"error":s>0?"run":"normal",a=e.type;return[m.LDB,m.LQB].includes(a)?a="LDB":[m.LXJ,m.BSHLQ].includes(a)?a="LXJ":[m.LDFM,m.LQFM].includes(a)&&(a="FM"),`${y.oss}/img/device/${i}/${a}.png`}}}),N="APP_ACCESS_TOKEN",M=d(),x=l(),F={token:M.TOKEN||x[N]||c(N),showAvatar:!0,showProject:!1,changePassword:!1,userInfo:{id:"",name:"",account:"",avatar:""},powers:[],config:{},projects:[],projectId:""},H=e({id:"user",state:()=>F,actions:{login(e,t){return r.post(p.user.login,e,t).then((e=>{const{access_token:t}=e,s=t;return this.token=s,W().updateWsIp("192.168.1.111"),h(N,s),e}))},changePwd:e=>r.post(p.user.changePwd,e),async getUserInfo(){const e=await r.get(p.user.getUserInfo,{});let t=e.Logo,s=e.LogoSmall;L().updateLogo({normal:t,small:s});const{sysUser:i,permissions:a}=e;return this.$patch({powers:0==a.length?["NO_SN"]:a,userInfo:{id:i.mid,name:i.name,account:i.account,avatar:i.avatar}}),e},updateProjectId(e){h("xxx.current.projId",e),this.projectId=e},logout(){return r.get(p.user.logout).then((e=>(this.$patch({token:void 0,powers:[]}),u(N),a(),R().delAllViews(),e)))},jumpLoginPage(){},resetToken(e){return new Promise((t=>{this.$patch({token:void 0,powers:[]}),w(N,"",-1),u(N),a(),e||this.jumpLoginPage(),t()}))}}}),B={lockReconnect:!1,reconnectTime:5e3,reconnectTimes:10,times:0,deviceWs:"",allUrl:"",ws:null,tt:null,time:3e4,timer:null,dataMark:0,data:[],dataObj:{},otherData:[],groupCode:""},U=e({id:"wx",state:()=>B,actions:{initSocket(e){const{projectCode:t,isRefresh:s,groupCode:i,path:a="ws"}=e,o=H(),n=W(),{protocol:r}=window.location;let c=`${"https:"===r?"wss":"ws"}://${n.wsIp}:8998/${a}?projectCode=${t}&access_token=${o.token}&groupCode=${i}`;this.groupCode=i,this.allUrl=c,this.resetOpts(),s||this.wsCreate(c)},extend(e){this.otherData=e},resetOpts(){this.ws&&this.ws.close(),clearInterval(this.timer),this.$patch({lockReconnect:!1,times:0,ws:void 0,dataObj:{}})},wsCreate(e){let s=window.WebSocket;try{this.ws=new s(e),this.ws.__ID__=(new Date).getTime(),this.wsEvent()}catch(i){t({type:"error",message:"Ws 初始化失败！"}),this.wsReconnect()}},wsEvent(){this.ws.onopen=e=>{this.wsOnOpen(e)},this.ws.onmessage=e=>{this.wsOnMessage(e)},this.ws.onclose=e=>{this.wsOnClose(e)},this.ws.onerror=e=>{this.wsOnError(e)}},wsOnOpen(e){this.times=0,this.wsHeartCheck()},wsHeartCheck(){},wsOnMessage(e){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(a){t={}}if("string"==typeof t.Data)try{t.Data=JSON.parse(t.Data)}catch(a){t.Data={}}const{data:s,type:i}=t;this.flatData(s,i)},flatData(e,t){if(0==e.length)return;const s=e.reduce(((e,t)=>(e[t.pointCode]=t,e)),{});!t||t.includes("全量")?this.dataObj=s:Object.keys(s).forEach((e=>{this.dataObj[e]=s[e]})),this.dataMark=Date.now()},formatData:(e,t)=>e.map(((e,s)=>{const i=e.style||{left:"0",top:"0"};if(e.font){const{size:t,color:s}=e.font;t&&(i.fontSize=t+"em"),s&&(i.color=s)}const a={id:s,...e,style:i,status:0,error:0};if("function"==typeof t){const e=t(a);e&&Object.assign(a,e)}return a})),getObj(e,t,s){return e[`${this.groupCode}_${t}${s?"_"+s:""}`]||{value:0}},getKeyValue(e,t){return!t&&(t=this.dataObj),this.getObj(t,e,"")},getRunStatus(e,t){const s=e.replace(/[^a-zA-Z]/g,"");let i=0;switch(!t&&(t=this.dataObj),s){case g.CHL:i=this.getObj(t,e,V.RUN_MODE).value;break;case g.CWP:case g.CHWP:case g.COT:i=this.getObj(t,e,V.ON_OFF).value||this.getObj(t,e,V.VFD_ON_OFF).value?1:0;break;case g.CWV:case g.CHWV:i=this.getObj(t,e,V.FO).value;break;case g.WV:i=1}return i},getErrorStatus(e,t){const s=e.replace(/[^a-zA-Z]/g,"");let i=0;switch(!t&&(t=this.dataObj),s){case g.CHL:case g.CWV:case g.CHWV:i=this.getObj(t,e,V.ALM).value;break;case g.CWP:case g.CHWP:case g.COT:i=this.getObj(t,e,V.PWR_ALM).value||this.getObj(t,e,V.VFD_ALM).value?1:0}return i},wsOnClose(e){if(this.ws){e.target.__ID__==this.ws.__ID__&&this.wsReconnect()}},wsClose(){this.lockReconnect=!0,clearInterval(this.timer),this.wsClear(),this.ws&&this.ws.close(),this.ws=null},wsClear(){this.data.length=0,this.otherData.length=0},wsOnError(e){this.wsReconnect()},wsReconnect(){this.lockReconnect||this.times>=this.reconnectTimes||(this.lockReconnect=!0,this.times++,this.tt&&clearTimeout(this.tt),this.tt=setTimeout((()=>{this.lockReconnect=!1,this.wsCreate(this.allUrl)}),this.reconnectTime))}}});export{L as a,R as b,W as c,I as d,U as e,H as u};
