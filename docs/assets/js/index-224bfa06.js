var e=Object.defineProperty,t=(t,o,s)=>(((t,o,s)=>{o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s})(t,"symbol"!=typeof o?o+"":o,s),s);import{m as o,u as s}from"./scene-resize-ca30cc7f.js";import{be as i,bf as n,b8 as a,bg as r,ba as c,bh as l,bi as h,bj as d,bk as m,bc as u,bl as p,bm as b,bn as w,bo as y,bp as v,bq as g,br as f,bs as k,bt as M,bd as x,af as A,e as S,i as L,l as j,o as E,g as z,h as K,n as _,I as H}from"./vendor-43c1f6dd.js";import{_ as B}from"./index-67768ca8.js";class I extends o{constructor(e){super(e),t(this,"gui"),t(this,"operate",{moveForward:!1,moveLeft:!1,moveBackward:!1,moveRight:!1,canJump:!1}),t(this,"velocity",new i),t(this,"direction",new i),t(this,"prevTime",performance.now()),t(this,"raycaster",new n(new i,new i(0,-1,0),0,10)),t(this,"objects",[]),t(this,"simulate"),t(this,"skeleton"),t(this,"time",0),this.addControls(),this.initModel(),this.gui=new a,this.addGui()}init(){this.initLight(),this.initGrid(),this.initAxes()}addControls(){const e=this.camera;e.lookAt(0,10,0);const t=new r(e,this.container);this.controls=t,this.addObject(t.object)}initModel(){this.addModel(),this.createSimulate(),this.createObject(),this.bindOperateEvent()}addModel(){let e=new c(2e3,2e3,100,100);e.rotateX(.5*-Math.PI);const t=new i,o=new l;let s=e.attributes.position;for(let i=0;i<s.count;i++)t.fromBufferAttribute(s,i),t.x+=20*Math.random()-10,t.y+=2*Math.random(),t.z+=20*Math.random()-10,s.setXYZ(i,t.x,t.y,t.z);e=e.toNonIndexed(),s=e.attributes.position;const n=[];for(let i=0;i<s.count;i++)o.setHSL(.3*Math.random()+.5,.75,.25*Math.random()+.6,h),n.push(o.r,o.g,o.b);e.setAttribute("color",new d(n,3));const a=new m({vertexColors:!0}),r=new u(e,a);this.addObject(r)}createSimulate(){const e={segmentHeight:20,segmentCount:3,height:60,halfHeight:30},t=this.createSimulateGeometry(e),o=this.createSimulateBones(e),s=this.createSimulateMesh(t,o,e);s.position.set(0,0,-50),s.rotation.y=.5*Math.PI,s.scale.multiplyScalar(.1),this.simulate=s,this.addObject(s)}createSimulateGeometry(e){const t=new p(8,5,e.height,80,3*e.segmentCount,!1),o=t.attributes.position,s=new i,n=[],a=[];for(let i=0;i<o.count;i++){s.fromBufferAttribute(o,i);let t=s.y+e.halfHeight,r=Math.floor(t/e.segmentHeight),c=t%e.segmentHeight/e.segmentHeight;n.push(r,r+1,0,0),a.push(1-c,c,0,0)}return t.setAttribute("skinIndex",new b(n,4)),t.setAttribute("skinWeight",new d(a,4)),t}createSimulateBones(e){const t=[];let o=new w;t.push(o),o.position.y=e.halfHeight;for(let s=0;s<e.segmentCount;s++){const s=new w;s.position.y=e.segmentHeight,t.push(s),o.add(s),o=s}return t}createSimulateMesh(e,t,o){const s=new y({color:1401481,emissive:468276,side:v,flatShading:!0});let i=new g(e,s),n=new f(t);i.add(t[0]),i.bind(n),i.position.set(0,o.height/2,0);const a=new k;let r=new M(i);return a.add(i,r),this.skeleton=n,a}createObject(){const e=new x(20,20,20).toNonIndexed(),t=e.attributes.position,o=[],s=new l;for(let i=0,n=t.count;i<n;i++)s.setHSL(.3*Math.random()+.5,.75,.25*Math.random()+.75,h),o.push(s.r,s.g,s.b);e.setAttribute("color",new d(o,3));for(let i=0;i<500;i++){const t=new y({specular:16777215,flatShading:!0,vertexColors:!0});t.color.setHSL(.2*Math.random()+.5,.75,.25*Math.random()+.75,h);const o=new u(e,t);o.position.x=20*Math.floor(20*Math.random()-10),o.position.y=20*Math.floor(20*Math.random())+10,o.position.z=20*Math.floor(20*Math.random()-10),this.addObject(o),this.objects.push(o)}}bindOperateEvent(){const e=this.controls;if(!e)return;const t=document.getElementById("blocker"),o=document.getElementById("instructions");o&&o.addEventListener("click",(function(){e.lock()})),e.addEventListener("lock",(function(){t&&(t.style.display="none")})),e.addEventListener("unlock",(function(){t&&(t.style.display="block")})),window.addEventListener("keydown",this.onKeydown.bind(this)),window.addEventListener("keyup",this.onKeyup.bind(this)),A((()=>{window.removeEventListener("keydown",this.onKeydown.bind(this)),window.removeEventListener("keyup",this.onKeyup.bind(this))}))}addGui(){var e;const t=this.gui,o=this.controls;o&&(t.add(o,"minPolarAngle",0,Math.PI).name("垂直角度下限"),t.add(o,"maxPolarAngle",0,Math.PI).name("垂直角度上限"),t.add(o,"pointerSpeed",.01,1).name("旋转速度"),t.domElement.style.position="absolute",t.domElement.style.top="opx",t.domElement.style.right="opx",null==(e=this.container.parentNode)||e.appendChild(t.domElement))}onKeydown(e){switch(e.code){case"ArrowUp":case"KeyW":this.operate.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.operate.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.operate.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.operate.moveRight=!0;break;case"Space":!0===this.operate.canJump&&(this.velocity.y+=350),this.operate.canJump=!1}}onKeyup(e){switch(e.code){case"ArrowUp":case"KeyW":this.operate.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.operate.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.operate.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.operate.moveRight=!1}}modelAnimate(){const e=performance.now(),t=this.controls;if(t&&!0===t.isLocked){const{raycaster:o,prevTime:s,velocity:n,operate:a,direction:r,objects:c}=this,l=t.object;o.ray.origin.copy(l.position),o.ray.origin.y-=10;const h=o.intersectObjects(c,!1).length>0,d=(e-s)/1e3;n.x-=10*n.x*d,n.z-=10*n.z*d,n.y-=9.8*100*d;const{moveForward:m,moveBackward:u,moveRight:p,moveLeft:b}=a;if(r.z=Number(m)-Number(u),r.x=Number(p)-Number(b),r.normalize(),(m||u)&&(n.z-=400*r.z*d),(b||p)&&(n.x-=400*r.x*d),!0===h&&(n.y=Math.max(0,n.y),this.operate.canJump=!0),null==t||t.moveRight(-n.x*d),null==t||t.moveForward(-n.z*d),l.position.y+=n.y*d,l.position.y<10&&(n.y=0,l.position.y=10,this.operate.canJump=!0),this.simulate){const e=new i;l.getWorldDirection(e);const t=e.clone().multiplyScalar(30),o=l.position.clone().clone().add(t);this.simulate.position.x=o.x,this.simulate.position.z=o.z;const s=l.rotation.clone();this.simulate.rotation.setFromVector3(s)}}this.prevTime=e}}const O={class:"three-page"},C=B(S({__name:"index",setup(e){const t=L(),o={axes:{visible:!0},grid:{visible:!0},camera:{position:[0,10,0]},controls:{visible:!1}};let i;return j((()=>{o.container=t.value,i=new I(o),i.run(),s(i).resize()})),(e,o)=>(E(),z("div",O,[K("div",{class:"h-100",ref_key:"containerRef",ref:t},null,512),K("div",{class:_(e.$style.blocker),id:"blocker"},[K("div",{class:_(e.$style.instructions),id:"instructions"},o[0]||(o[0]=[K("div",null,"点击开始",-1),K("p",null,[H(" 移动: W、A、S、D"),K("br"),H(" 跳跃: 空格"),K("br"),H(" 视角: 鼠标移动 ")],-1)]),2)],2)]))}}),[["__cssModules",{$style:{blocker:"_blocker_ewsl7_2",instructions:"_instructions_ewsl7_11"}}]]);export{C as default};
