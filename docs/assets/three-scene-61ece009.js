import{k as e,b9 as t,ba as o,bb as a,bc as n,bd as s,b0 as i,b1 as l,aN as r,by as c,aS as d,aU as p,bz as u,bA as m,bB as h,bC as f,bD as y,d as g,P as w,r as v,aH as b,aI as x,c as k,i as C,L as _,a as E,b as M,q as T,s as z,l as P,w as S,u as B,n as L,t as D,e as $,Q as A,F as j,j as O,aK as N,a_ as I,aL as U,ak as H,o as R,m as F,aM as J,bE as G,ar as W,bF as X,bG as Y,aP as K,aO as Q,aT as Z,bH as V,bI as q,bh as ee,bJ as te,aZ as oe,aR as ae,bK as ne,bL as se,bM as ie,bN as le,bO as re,bP as ce,aJ as de,bQ as pe,bR as ue,bS as me,bT as he,bU as fe,bV as ye,bW as ge,bX as we,bY as ve}from"./vendor-6db95a6f.js";import{k as be}from"./common-04bb9be1.js";import{a as xe,e as ke}from"./modules-49818129.js";import{_ as Ce}from"./_plugin-vue_export-helper-1b428a4d.js";const _e={colors:{normal:{color:16777215,main:16316664,text:5280767},runing:{color:1211922,main:10485239},error:{color:12717056,main:16616554}},isCruise:!1,modelSizeKB:1048576,loadPart:{},devices:[]},Ee={shakeTime:500,tsp:Date.now()},Me={list:[]},Te=e({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),ze=e({show:!1,style:{left:"0px",top:"0px"},select:[],title:"",data:{},pos:{}}),Pe=(e,t=.1,a=1e4)=>{const n=e.clientWidth,s=e.clientHeight,i=new o(36,n/s,t,a);return i.position.set(-350,510,700),i},Se=(e,t,o="",a)=>{let n=(new s).load([`${t}${o}/${a}/posX.jpeg`,`${t}${o}/${a}/negX.jpeg`,`${t}${o}/${a}/posY.jpeg`,`${t}${o}/${a}/negY.jpeg`,`${t}${o}/${a}/posZ.jpeg`,`${t}${o}/${a}/negZ.jpeg`]);e.background=n},Be=(e,t,o)=>(e.lookAt(o),new Promise((a=>{new i(e.position).to(t,1e3).easing(l.Quadratic.In).start().onUpdate((()=>{e.lookAt(o)})).onComplete((()=>{a(e)}))}))),Le=(e,t,o=1)=>{const a=e.position,n=e.rotation,s=e.scale,i=t.position||{x:0,y:0,z:0},l=t.rotation||{x:0,y:0,z:0},r=t.scale||{x:1,y:1,z:1},c=Math.abs(l.x)<2?1:180,d=Math.abs(l.y)<2?1:180,p=Math.abs(l.z)<2?1:180;return{position:[a.x+i.x,a.y+i.y,a.z+i.z],rotation:[n.x+Math.PI/c*l.x,n.y+Math.PI/d*l.y,n.z+Math.PI/p*l.z],scale:[s.x*o*r.x,s.y*o*r.y,s.z*o*r.z]}},De=e=>e.map((e=>(e.children&&e.children.length>0?e.children=De(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),$e=e=>{let t=e.clone();return t.children=De(t.children),t},Ae=(e,t=16777215)=>{const o=e.type;let a=5,n=t,s={x:0,y:0,z:0},i={x:0,y:0,z:0},l=0;switch(o){case"TEXT":break;case"JSQ":a=8,s.y=10,s.z=20,l=62;break;case"SB":case"LDB":case"LQB":a=8,s.z=55,l=45;break;case"XBC":case"LXJ":case"LGJ":case"STLGJ":case"TTLGJ":case"FTLGJ":a=8,s.y=16,s.z=40,l=78;break;case"LQT":a=8,s.x=-75,l=112;break;case"GL":a=8,s.x=83,s.y=2,l=125;break;case"BSHRQ":a=12,s.y=8,s.z=33,l=105;break;case"BSHLQ":a=8,s.y=16,s.z=40,l=88;break;case"FLRB":a=8,s.x=50,s.y=2,l=123;break;case"FJY_X":case"FJZ_X":a=6,l=80,s.y=80,s.z=30;break;case"FJY":case"FJZ":a=6,l=110,s.y=103}let r=e.font||{},c=r.position||{};c&&Object.keys(c).forEach((e=>{s[e]=c[e]}));let d=r.rotation||{};return d&&(Object.keys(d).forEach((e=>{i[e]=d[e]})),i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z),r.size&&(a=r.size),r.color&&(n=r.color),{size:a,color:n,txPos:s,txRot:i,sy:l}},je=(e,t)=>{e.data&&e.data.type?t(e):e.isScene?t(null):je(e.parent,t)},Oe=(e,t,o)=>{let a=e.clientWidth/2,n=e.clientHeight/2,s=t.position.clone();const i=t.scale;s.y+=i.x/2;let l=s.project(o);return{left:l.x*a+a,top:-l.y*n+n}},Ne=e=>{e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())},Ie=e=>new Promise((t=>{const o=window.indexedDB.deleteDatabase(e);o.onsuccess=e=>{t(!0)},o.onerror=e=>{t(!1)}})),Ue=async(e,t="THREE__MODEL_DB",o=1)=>{if(!window.indexedDB)return Promise.resolve(null);await((e,t,o)=>new Promise((a=>{window.indexedDB.open(e).onsuccess=n=>{const s=n.target.result,i=s.version;s.close(),i!==t?Ie(e).then((e=>{a(e?t:i)})):s.objectStoreNames.contains(o)?a(i):Ie(e).then((e=>{a(e?t:i)}))}})))(t,o,e);let a=window.indexedDB.open(t,o);return new Promise((t=>{a.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e)||o.createObjectStore(e,{keyPath:"path"})},a.onsuccess=e=>{const o=e.target.result;t(o)},a.onerror=e=>{t(null)}}))},He={dbName:"THREE__MODEL__CTL_DB",tbName:"CTL_TB",version:1},Re=["onClick"],Fe=Ce(g({name:"three-scene",__name:"index",props:{id:{},bgColor:{type:[String,Boolean],default:void 0},skyCode:{default:"217"},skyCodes:{default:()=>["216","217","218","219","220","221","222","223","224","225"]},skyPath:{default:"/img/sky"},hdr:{},grid:{type:Boolean},baseUrl:{},models:{},config:{},objects:{},lightHelper:{type:Boolean},axesHelper:{type:Boolean},scale:{default:1},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},initModelItemCall:{},getColorCall:{},animationModelType:{},pipeMeshName:{},pipeModelType:{},colorMeshName:{},colorModelType:{default:()=>["FM","XFM"]},textModelType:{},dotTypes:{default:()=>[]},floorModelType:{},cruisePoints:{},cruiseSegment:{},cruiseSpeed:{},cruiseTubeShow:{type:Boolean},pathBg:{},pathWidth:{},pathMap:{},pathTension:{},pathMapSpeed:{},cruisePathOffset:{}},emits:["loaded","select","dblclick","click-dot","click-dialog-dot"],setup(o,{expose:s,emit:g}){const Ce=o,De=xe(),Ie=ke();w((()=>Ce.objects),(e=>{Te.isEnd&&oo()})),w((()=>De.sidebar.opened),(()=>{clearTimeout(_e.sideToggleTimer),_e.sideToggleTimer=setTimeout(nt,300)})),w((()=>Ie.dataMark),(()=>Fe()));const Fe=()=>{const e=Date.now();e-Ee.tsp<Ee.shakeTime&&clearTimeout(Ee.timer),Ee.tsp=e,Ee.timer=setTimeout(ho,Ee.shakeTime)},Je=v(),Ge=new b;let We,Xe,Ye,Ke,Qe,Ze,Ve;Ge.background=new x("#fff");const qe=Symbol("_WARNING_MODEL_"),et=Symbol("_CHANGECOLORMATERIALKEY_"),tt=Symbol("_PIPETEXTUREKEY_"),ot=Symbol("_MAINBODYMESHKEY_"),at=()=>{if(Qe=new J(16777215,1.5),Ge.add(Qe),Ze=((e=16777215,t=1,o=800,a=2048,n=1,s=2e3)=>{const i=new r(e,t);return i.position.set(500,800,800),i.castShadow=!0,i.shadow.camera.near=n,i.shadow.camera.far=s,i.shadow.camera.right=o,i.shadow.camera.left=-o,i.shadow.camera.top=o,i.shadow.camera.bottom=-o,i.shadow.mapSize.set(a,a),i})(16777215,1.5),Ge.add(Ze),Ve=new r(16777215,1.5),Ve.position.set(-500,800,-800),Ge.add(Ve),Ce.lightHelper){const e=new G(Ze,1);Ge.add(e);const t=new G(Ve,1);Ge.add(t)}},nt=()=>{const e=Je.value;if(!We)return;const t=(null==e?void 0:e.clientWidth)??0,o=(null==e?void 0:e.clientHeight)??0,a=t/o;We.aspect=a,We.updateProjectionMatrix(),xt&&(xt.aspect=a,xt.updateProjectionMatrix()),Xe.setSize(t,o)};let st;const it=()=>{st=requestAnimationFrame(it),ct(),$t(),Xe.render(Ge,_e.isCruise?xt:We)},lt=k((()=>(io.value.filter((e=>"DOT"==e.type))||[]).map((e=>{const t=e.deviceCode||"";e.value=Ie.getKeyValue(t).value;const o=t.split("_")[0]||"";return Ie.getRunStatus(o)>0||["SYS","CSC"].includes(o)?e.show=!0:e.show=!1,e.value=Number(Number(e.value||0).toFixed(2)),e})))),rt=(e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let a=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{a.includes(e)||a.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!a.includes(o)&&a.push(o),!!o})).length==e.length&&(o=o.concat(a))}else{const a=t.find((t=>t.deviceCode==e));a&&o.push(a)}})),o},ct=()=>{N(),Ye.update();let e=ht.getDelta();if(_e.devices.length&&_e.devices.forEach((t=>{let o=t.data,a=t.extra,n=t[qe],s=t[tt];if(a&&(null==o?void 0:o.status)>0&&a.mixer.update(e),n&&(null==o?void 0:o.error)>0&&n.mixer.update(e),s){const e=o.bind||[],t=io.value.filter((e=>"DOT"!==e.type&&!(Ce.pipeModelType||[]).includes(e.type)&&e.deviceCode&&((null==e?void 0:e.status)??0)>0)),a=rt(e,t),n=a.length>0;let i=.01;if(o.left&&o.right){const{left:e,right:t}=o,n=rt(t,a).length>0;i=rt(e,a).length>0&&n?0:n?-.01:.01}n&&(s.material.map.offset.y-=i),s.material.opacity=n?.3:0}})),ze.show&&ze.select.length){const e=Je.value,t=Oe(e,ze.select[0],_e.isCruise?xt:We);ze.pos=t,ze.style.left=t.left+"px",ze.style.top=t.top+"px"}dt()},dt=()=>{const e=Je.value;let t=e.clientWidth/2,o=e.clientHeight/2;io.value.forEach(((e,a)=>{if("DOT"!=e.type)return;let n=e.position,s=new I(null==n?void 0:n.x,null==n?void 0:n.y,null==n?void 0:n.z).project(_e.isCruise?xt:We),i=s.x*t+t,l=-s.y*o+o;io.value[a].style.left=i+"px",io.value[a].style.top=l+"px"}))};w((()=>Ce.bgColor),(e=>{Ge.background=new x(e)})),w((()=>Ce.skyCode),(e=>{Ce.bgColor||(Se(Ge,Ce.baseUrl,Ce.skyPath,e),pt.value=e)}));const pt=v(Ce.skyCode),ut=()=>{const e=Ce.skyCodes||[];let t=e.findIndex((e=>e==pt.value))+1;t>=e.length&&(t=0),pt.value=e[t],Se(Ge,Ce.baseUrl,Ce.skyPath,pt.value)},mt=g;let ht,ft,yt,gt;const wt=He.tbName;w((()=>Ce.cruisePoints),(async()=>{await ee(),vt(),bt(),Bt()}));const vt=()=>{kt&&(Ne(kt),Ge.remove(kt),kt=void 0)},bt=()=>{_e.isCruise=!1,Ye.enabled=!_e.isCruise,Tt=_e.isCruise};let xt,kt,Ct,_t,Et,Mt,Tt=!1,zt=0,Pt=1,St=0;const Bt=()=>{const e=Date.now();if(e-St<300)return;St=e,zt=0;let t=[];const o=Ce.cruisePoints||[];if(0!=o.length){for(let e=0;e<o.length;e++){const a=o[e];t.push(new I(a[0],a[1],a[2]))}if(xt=Pe(Je.value,1,1e6),xt.lookAt(Ye.target),Et=new te(t,!0,"catmullrom",Ce.pathTension??0),kt=new oe,Ge.add(kt),Ce.cruiseTubeShow){Ct=new p(new ae(2),new ne({color:0,opacity:.8,transparent:!0})),kt.add(Ct),_t=(new se).setFromPoints(t);const e=new ie({color:255,opacity:1,transparent:!0}),o=new le(_t,e);kt.add(o);const a=new re(Et,100,2,3,!0),n=new ce({color:16711935,opacity:.1,transparent:!0}),s=new p(a,n),i=new ne({color:16715760,opacity:.3,wireframe:!0,transparent:!0}),l=new p(a,i);s.add(l),kt.add(s)}Lt()}else Et=void 0},Lt=async()=>{const e=Ce.pathBg||Ce.baseUrl+"/model/pipe/arrow.png",t=Ce.pathMap||[.1,1],o=await(new de).loadAsync(e);if(!kt)return;o.wrapS=pe,o.repeat.x=t[0],o.repeat.y=t[1],o.anisotropy=Xe.capabilities.getMaxAnisotropy(),Mt=o;const a=new d({map:o,opacity:.5,transparent:!0,depthWrite:!1}),n=new I(0,1,0),s=new me;s.set(Et.getPoints(1e3),5,1,n,!1);const i=new ue;i.update(s,{width:Ce.pathWidth??15,arrow:!1});const l=new p(i,a);l.name="path",kt.add(l)},Dt=()=>1e3*(Ce.cruiseSegment??2),$t=()=>{if(!Et)return;Mt&&(Mt.offset.x-=Ce.pathMapSpeed??.006),Tt&&(zt+=Pt*(Ce.cruiseSpeed??1));const e=Dt(),t=zt%e/e,o=Et.getPointAt(t),a=Ce.cruisePathOffset??3;if(Ce.cruiseTubeShow&&Ct){const e=At(a,o);Ct.position.copy(e)}if(!_e.isCruise)return;const n=.03;let s=t-n;t<n&&(s=t+.97);const i=At(a,Et.getPointAt(s));xt.position.copy(i),xt.lookAt(At(a,o))},At=(e,t)=>new I(t.x,t.y+e,t.z),jt=e({click:!1,tsp:0}),Ot=e=>{Ft(e,ft),yt.setFromCamera(ft,_e.isCruise?xt:We);const t=_e.devices;let o=yt.intersectObjects(t,!0);if(o.length){const e=o[0].object;je(e,(t=>{if(!t)return;mt("dblclick",t);const o=t.data,a=Me.list.findIndex((e=>t.uuid===e.uuid));"function"==typeof o.onDblclick&&o.onDblclick(W(o),e,t,a),a>-1&&Nt(a)}))}},Nt=e=>{var t,o,a,n;if(0===Me.list.length)return;const s=void 0!==e&&e>-1;if((null==(t=Ce.config)?void 0:t.floorExpandHiddenOther)&&_e.devices.forEach((e=>{var t;e.visible=(t=e,Me.list.findIndex((e=>t.uuid===e.uuid))>-1||!s)})),Me.list.forEach(((t,o)=>{var a,n,r;const c=t._pos;let d=o-(s?e:o);const p=(null==(a=Ce.config)?void 0:a.floorExpandMargin)||200,u=(null==(n=Ce.config)?void 0:n.floorExpandMode)||"UD",m=d*p,h=((null==c?void 0:c.y)??0)+m,f=e==o?((null==c?void 0:c.z)??0)+p:(null==c?void 0:c.z)??0;if("UD"===u){if(t.position.y===h)return}else if("BA"===u&&t.position.z===f)return;if(null==(r=t.data)?void 0:r.mark){const a=t.data.mark,n=_e.devices.filter((e=>{var t;return(null==(t=e.data)?void 0:t.followMark)===a}));It(u,n,m,e==o?p:0)}new i(t.position).to({y:"UD"===u?h:t.position.y,z:"BA"===u?f:t.position.z},500).easing(l.Quadratic.Out).start()})),!(null==(o=Ce.config)?void 0:o.floorExpandChangeViewAngle))return;let r,c;if(s){const t=Me.list[e]||{};r=null==(a=t.data)?void 0:a.to,r&&(c=(null==(n=t.data)?void 0:n.target)||t._pos)}r=ao(r,c),(e=>{const t=We.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1})(r)||Be(We,r,Ye.target)},It=(e,t,o,a)=>{0!==t.length&&t.forEach((t=>{const n=t._pos,s="UD"==e?((null==n?void 0:n.y)??0)+o:(null==n?void 0:n.y)??0,r="BA"==e?((null==n?void 0:n.z)??0)+a:(null==n?void 0:n.z)??0;new i(t.position).to({y:s,z:r},500).easing(l.Quadratic.Out).start()}))},Ut=e=>{jt.click=!0,jt.tsp=e.timeStamp},Ht=e=>{Jt(e),jt.click},Rt=e=>{var t,o;jt.click=!1;const a=e.timeStamp-jt.tsp<300;2==e.button?a&&"function"==typeof(null==(t=Ce.config)?void 0:t.back)&&(null==(o=Ce.config)||o.back(screen)):0==e.button?a&&Jt(e):e.button},Ft=(e,t)=>{if(!e||!t)return;const o=Je.value;let a=(null==o?void 0:o.getBoundingClientRect())??{left:0,top:0};t.x=(e.clientX-a.left)/(1*o.clientWidth)*2-1,t.y=-(e.clientY-a.top)/(1*o.clientHeight)*2+1},Jt=e=>{const t=Je.value;Ft(e,ft),yt.setFromCamera(ft,_e.isCruise?xt:We);let o="pointerdown"==e.type||"pointerup"==e.type;const a=Ge.children.filter((e=>e.visible&&!!e.data&&Ce.dotTypes.includes(e.data.type)));let n=yt.intersectObjects(a,o);if(t.style.cursor=n.length>0?"pointer":"auto",o)if(n.length){const e=n[0].object;je(e,(e=>{if(!e)return;const t=e.data;if(!t.type)return void(ze.show=!1);const o=W(t);mt("select",o),"function"==typeof t.onClick?t.onClick(o):(ze.select=[e],ze.show=!0,Gt())}))}else ze.select.length=0,ze.show=!1},Gt=()=>{const e=Je.value,t=ze.select[0],o=t.data;ze.data=o,ze.title=(null==o?void 0:o.name)||"";const a=Oe(e,t,_e.isCruise?xt:We);ze.pos=a,ze.style.left=a.left+"px",ze.style.top=a.top+"px",mt("click-dialog-dot",o,a)};let Wt;const Xt=()=>{const e=Ce.models,t=e.length;let o=0;if(0==t)return Te.isEnd=!0,void(Te.show=!1);Te.isEnd=!1,Te.percentage=0;const a=async()=>{const n=e[o],{key:s,name:i,map:l,url:r,size:c,range:d,font:p,warning:u}=n;if(Te.list.push({name:`${i} Model`,pro:0}),l){let e=(new de).load(Ce.baseUrl+l),t=new he({map:e}),o=new fe(t),a=c,n=c;d&&(a=d.x,n=d.y),o.scale.set(a,n,1),o.name="sprite",_e.loadPart[s]=o}else p?await Kt(p,c):u?Wt=await Qt(s||qe,u,c):await Qt(s,r,c,n);o++,Te.loaded+=c*_e.modelSizeKB,o==t?(Te.isEnd=!0,oo()):a()};Te.show=!0,a()};let Yt;const Kt=(e,t=0)=>{const o=new ye;return!be(e)&&e.indexOf(Ce.baseUrl)<0&&(e=Ce.baseUrl+e),new Promise((async a=>{const n=await Zt(e,t);if(n)return Yt=o.parse(JSON.parse(n)),void setTimeout((()=>{a(Yt)}),10);o.load(e,(t=>{Yt=t,qt(e),a(t)}))}))},Qt=(e,t,o=0,a)=>{const n=new ge;n.setDecoderPath("draco/gltf/");const s=new we;return s.setDRACOLoader(n),new Promise((async n=>{const i=_e.colors.normal[e]||_e.colors.normal.color;!be(t)&&t.indexOf(Ce.baseUrl)<0&&(t=Ce.baseUrl+t);const l=await Zt(t,o);if(l){const t=l.scene.children[0],o=Vt(e,i,t,l.animations,a);return void n(o)}let r=t.split(".").pop().toLowerCase();if("glb"!==r)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+r);s.load(t,(o=>{let s=o.scene.children[0];const l=Vt(e,i,s,o.animations,a);qt(t),n(l)}),to)}))},Zt=(e,t=0)=>{const o=new we;return new Promise((async a=>{const n=q.get(e);if(n)n instanceof ArrayBuffer?(to({loaded:n.byteLength}),o.parse(n,"",(t=>{q.add(e,t),a(t)}))):(to({loaded:t*_e.modelSizeKB}),setTimeout((()=>{a(n)}),10));else{const t=await((e,t,o)=>{if(!e||!t||!o)return Promise.resolve(null);const a=e.transaction([t],"readonly").objectStore(t).get(o);return new Promise(((e,t)=>{a.onsuccess=t=>{const o=t.target.result;e(o)},a.onerror=e=>{t(e)}}))})(gt,wt,e);if(t&&t.data){const e=t.data;"string"==typeof e?(to({loaded:e.length}),q.add(t.path,e),setTimeout((()=>{a(e)}),10)):(to({loaded:e.byteLength}),o.parse(e,"",(e=>{q.add(t.path,e),a(e)})))}else a(null)}}))},Vt=(e,t,o,a,n)=>{var s;if(!o)return;let i;if((null==(s=Ce.pipeModelType)?void 0:s.includes(e))&&n){const{pipeMap:e,repeat:t=[1,1]}=n;i=(new de).load(Ce.baseUrl+e),i.wrapS=pe,i.wrapT=pe,i.repeat.set(t[0]??1,t[1]??1)}const l=$e(o);return l.traverse((e=>{var o;i&&(null==(o=Ce.pipeMeshName)?void 0:o.includes(e.name))?e.material=new ce({side:ve,transparent:!0,opacity:0,map:i.clone()}):((e,t=6776165,o,a)=>{const{type:n,name:s}=e;if(n.indexOf("Light"),["地面","底座","基础","基础底座","冷却塔基础"].includes(s))e.receiveShadow=!0;else if(o.includes(s)){if(!e.material)return;e.material instanceof Array?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t)}else e.isMesh&&(a&&(e.material.envMap=a),e.castShadow=!0)})(e,t,Ce.colorMeshName||[])})),l.animations=a,_e.loadPart[e]=l,l},qt=e=>{const t=q.get(e);if(t&&gt){gt.transaction(wt,"readwrite").objectStore(wt).add({path:e,data:t})}},eo=async(e,t)=>{const o="_BASE_";if(!e){const e=_e.loadPart[o];if(e){const t=Ge.children.find((t=>t.uuid===e.uuid));Ge.remove(t),Ne(e),_e.loadPart[o]=null}return}const a=await Qt(o,e),{position:n,scale:s,rotation:i}=Le(a,t);return a.scale.set(...s),a.position.set(...n),a.rotation.set(...i),Ge.add(a),Promise.resolve(a)},to=e=>{const{loaded:t}=e,o=Te.total;let a=Number((t+Te.loaded)/o*100);a>100&&(a=100),Te.percentage=Number(a.toFixed(2))},oo=async()=>{var e,t,o;Te.percentage=100,Te.show=!1,ze.show=!1,_e.devices.forEach((e=>{const t=Ge.children.find((t=>{var o,a;return(null==(o=t.data)?void 0:o.id)==(null==(a=e.data)?void 0:a.id)}));Ne(e),Ne(t),Ge.remove(t)})),_e.devices.length=0,Me.list.length=0,await ee(),eo(),lo(),await so(),"function"==typeof(null==(e=Ce.config)?void 0:e.load)&&(null==(t=Ce.config)||t.load(Ge));const a=(null==(o=Ce.config)?void 0:o.floorExpandIndex)||-1;if(a>-1&&Me.list.length)Nt(a),mt("loaded");else{const e=ao();Be(We,e,Ye.target).then((()=>{mt("loaded")}))}},ao=(e,t)=>{const o=Ce.config||{},a=e||o.to||{x:-104,y:7,z:58},n=t||o.target||{x:0,y:0,z:0};return Ye.target.set(n.x,n.y,n.z),a},no=async e=>{var t,o;if(!e)return;const a=e.type;let n=_e.loadPart[a];if(!n)return void(e.url&&await eo(e.url,e));const s=Ce.colorMeshName||[],i=Ce.animationModelType||[],l=Ce.floorModelType||[],r=Ce.textModelType||[];let g=$e(n);const{position:w,scale:v,rotation:b}=Le(g,e),[x,k,C]=w;if(g.scale.set(...v),r.includes(a)&&Yt){const t=new u;t.add(g);let o=((e,t,o)=>{if(!t)return;const a=Ae(e,o);let n=new c(e.name||"",{font:t,size:a.size||5,height:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const s=a.txRot;n.rotateX(s.x),n.rotateY(s.y),n.rotateZ(s.z);const i=a.txPos;n.computeBoundingBox(),n.computeVertexNormals();let l=.5*(n.boundingBox.max.x-n.boundingBox.min.x),r=.5*(n.boundingBox.max.z-n.boundingBox.min.z),u=new d({color:a.color||16777215,flatShading:!1}),m=new p(n,u);return m.castShadow=!0,m.position.set((i.x||0)-l,i.y||0,(i.z||0)-r),m})(e,Yt,_e.colors.normal.text);t.add(o),t.name=e.name,g=t}if(i.includes(a)&&Wt){if("Group"!==g.type){const e=new u;e.add(g),g=e}const{group:t,action:o,mixer:a}=((e,t,o,a=100,n=1)=>{if(!o)return;const s=Ae(t);let i=new u,l=$e(o);l.scale.set(n,n,n),l.position.y=s.sy,i.add(l);let r=new m(12717056,8,a,0);r.name="灯光",r.position.y=s.sy+30,i.add(r),i.name=e;let c=new h(i),d=new f("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),p=new f("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),g=new f("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),w=new y("warning_",1,[d,p,g]),v=c.clipAction(w);return v.paused=!0,v.play(),i.visible=!1,{group:i,action:v,mixer:c}})(qe,e,Wt);g.add(t),g[qe]={action:o,mixer:a}}g.position.set(x,k,C),g.rotation.set(...b),g.data=e;const _=g.children.filter((e=>s.includes(e.name)));if(g[et]=_,null==(t=Ce.pipeModelType)?void 0:t.includes(a)){const t=g.children.find((e=>{var t;return null==(t=Ce.pipeMeshName)?void 0:t.includes(e.name)}));if(t){t.material.map=t.material.map.clone();const o=e.map;if(o){const e=t.material.map.repeat;t.material.map.repeat.set(e.x*(o[0]??1),e.y*(o[1]??1))}g[tt]=t}}if(Ce.mainBodyChangeColor){const e=((null==(o=g.children[0])?void 0:o.children)||[]).filter((e=>(Ce.mainBodyMeshName||[]).includes(e.name)));g[ot]=e}if(Ge.add(g),(e.followMark||e.mark)&&(g._pos={x:x,y:k,z:C}),_e.devices.push(g),l.includes(a)&&(g._pos={x:x,y:k,z:C},Me.list.push(g)),i.includes(a)){const e=((e,t)=>{let o=[];return e&&e.length?(function e(a){a.forEach((a=>{t.includes(a.name)&&o.push(a),a.children&&e(a.children)}))}(e),o):[]})(g.children,s);let t,o=new h(g);n.animations.length&&(t=o.clipAction(n.animations[0]),t.paused=!0,t.timeScale=1.5,t.play()),g.extra={action:t,mixer:o,meshs:e}}return Promise.resolve()},so=()=>{let e=0,t=io.value.length;return new Promise((o=>{if(0==t)return;const a=async()=>{const n=io.value[e];await no(n),e++,e<t?a():o(e)};a()}))},io=v([]),lo=()=>{io.value.length=0;const e=W(Ce.objects)||[],t=Ie.formatData(e,Ce.initModelItemCall);io.value=t},ro=()=>{},co=e=>{Pt=1;const t=e.keyCode;if(_e.isCruise)switch(t){case 32:Tt=!Tt;break;case 38:case 87:Tt||(zt+=10);break;case 83:case 40:Tt||(zt-=10,zt<0&&(zt=Dt()))}},po=e=>{const t=e.keyCode;if(_e.isCruise&&e.repeat)switch(t){case 38:case 87:Tt?(Pt*=1.5,Pt>10&&(Pt=10)):zt+=5;break;case 83:case 40:Tt||(zt-=5,zt<0&&(zt=Dt()))}};window.addEventListener("keydown",po,!1),window.addEventListener("keyup",co,!1);const uo=()=>{(Ce.cruisePoints||[]).length&&(_e.isCruise=!_e.isCruise,Ye.enabled=!_e.isCruise,Tt=_e.isCruise)},mo=()=>{_e.devices.forEach(((e,t)=>{if(!e.data)return;const{type:o}=e.data,a=e.data;if(!a.deviceCode)return;const n=Math.random()>.5?1:0,s=Math.random()>.5?1:0;a.status=n,a.error=s;const i=s>0?"error":n>0?"runing":"normal",l=_e.colors[i];let r=l[o]||l.color;if("function"==typeof Ce.getColorCall){const e=Ce.getColorCall(a);e&&(r=e)}fo(o,e,l,r,0==n,s>0)}))},ho=()=>{const e=Ce.animationModelType||[],t=Ce.colorModelType||[],o=Ce.pipeModelType||[],a=e.concat(t);_e.devices.forEach(((e,t)=>{let n=e.data;if(!n)return;let s=n.type;if(!a.includes(s)||o.includes(s)||"DOT"==s)return;const i=n.deviceCode;if(!i)return;const l=Ie.getRunStatus(i),r=Ie.getErrorStatus(i);n.status=l,n.error=r;const c=r>0?"error":l>0?"runing":"normal",d=_e.colors[c];let p=d[s]||d.color;if("function"==typeof Ce.getColorCall){const e=Ce.getColorCall(n);e&&(p=e)}fo(s,e,d,p,0==l,r>0)}))},fo=(e,t,o,a,n,s)=>{if(Ce.colorModelType.includes(e)){return void(t[et]||[]).forEach((e=>{e.material.color.set(a)}))}const i=t.extra;if(i&&"DOT"!=e){i.action&&(i.action.paused=n);(i.meshs||[]).forEach((e=>{"Group"==e.type?e.children.forEach((e=>{e.material.color.set(a)})):e.material.color.set(a)}))}const l=t[qe];if(l){const e=t.children.find((e=>e.name==qe));e&&(e.visible=s,l.action.paused=!s)}if(Ce.mainBodyChangeColor&&t[ot]){const e=o.main;e&&t[ot].forEach((t=>{t.material.color.set(e)}))}},yo=()=>{Ce.models.forEach((e=>{const t=e.size*_e.modelSizeKB;Te.total+=t}));const e=Je.value;if(Xe=(e=>{const o=e.clientWidth,a=e.clientHeight,n=new t({antialias:!0,alpha:!0});return n.outputEncoding=void 0,n.setSize(o,a),n.setPixelRatio(window.devicePixelRatio),e.appendChild(n.domElement),n})(e),We=Pe(e,1,1e6),at(),Ye=((e,t)=>{const o=new a(e,t.domElement);return o.minDistance=1,o.maxPolarAngle=.45*Math.PI,o.target.set(0,0,0),o})(We,Xe),Ye.maxPolarAngle=.46*Math.PI,Ye.screenSpacePanning=!1,Ce.grid&&(Ke=(()=>{let e=new n(800,80,10592673,10592673);return e.material.opacity=.3,e.material.transparent=!0,e})(),Ge.add(Ke)),Ce.axesHelper){let e=new U(50);Ge.add(e)}_e.isCruise=!1,Pt=1,Ce.hdr?(new X).load(Ce.baseUrl+Ce.hdr,(e=>{e.mapping=Y,Ge.background=e,Ge.environment=e})):null!=Ce.bgColor?Ge.background=Ce.bgColor?new x(Ce.bgColor):null:Se(Ge,Ce.baseUrl,Ce.skyPath,Ce.skyCode),Xe.shadowMap.enabled=!0,Xe.shadowMap.type=K,ht=new Q,ft=new Z,yt=new V,Ue(wt,He.dbName,He.version).then((e=>{e?(q.enabled=!0,gt=e,Xt()):Xt()})),Xe.domElement.addEventListener("dblclick",Ot),Xe.domElement.addEventListener("pointerdown",Ut),Xe.domElement.addEventListener("pointermove",Ht),Xe.domElement.addEventListener("pointerup",Rt)};return C((()=>{if(!Ce.models||0==Ce.models.length)throw new Error("模型数据不可为空");yo(),it(),window.addEventListener("resize",nt,!1)})),_((()=>{clearTimeout(Ee.timer),Ie.wsClose(),clearInterval(_e.timer),clearTimeout(_e.sideToggleTimer),window.removeEventListener("resize",nt),window.removeEventListener("keyup",co),window.removeEventListener("keydown",po),cancelAnimationFrame(st);try{Ge.clear(),Xe.dispose(),Xe.forceContextLoss(),Xe.content=null;let e=Xe.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext()}catch(e){}})),s({floorAnimate:Nt,setControls:e=>{"object"==typeof e&&Object.keys(e).forEach((t=>{Ye[t]=e[t]}))},resize:nt}),(e,t)=>{const o=H;return R(),E("div",{class:P(e.$style["three-scene"])},[M("div",{class:P([e.$style.operation,"operation"]),onDblclick:t[0]||(t[0]=S((()=>{}),["stop"]))},[(R(),T(o,{key:0,onClick:mo,type:"success"},{default:z((()=>[F("随机更新")])),_:1})),(R(),T(o,{key:1,onClick:uo,type:"warning"},{default:z((()=>[F("巡航")])),_:1})),(R(),T(o,{key:2,onClick:ro,type:"success"},{default:z((()=>[F("场景坐标")])),_:1})),(R(),T(o,{key:3,onClick:ut,type:"warning"},{default:z((()=>[F("切换背景")])),_:1}))],34),M("div",{ref_key:"containerRef",ref:Je,class:P(e.$style.container),onKeyup:co},null,34),B(Te).show?(R(),E("div",{key:0,class:P(e.$style.loading),style:L({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[1]||(t[1]=S((()=>{}),["stop"]))},[M("div",{class:P(e.$style.progress),style:L({"--percentage":B(Te).percentage+"%"})},[M("div",{class:P(e.$style["bar-out"])},[M("div",{class:P(e.$style.bar)},null,2)],2),M("div",{class:P(e.$style.text)},D(B(Te).percentage)+"%",3)],6)],38)):$("",!0),B(ze).show?(R(),E("div",{key:1,class:P(e.$style.dialog),style:L(B(ze).style)},[A(e.$slots,"dialog",{data:B(ze).data,title:B(ze).title,pos:B(ze).pos})],6)):$("",!0),M("div",{class:P(e.$style["dot-wrap"])},[(R(!0),E(j,null,O(B(lt),((t,o)=>(R(),E(j,null,[t.show?(R(),E("div",{class:P(e.$style.dot),key:o,style:L(t.style),onClick:e=>(e=>{mt("click-dot",W(e))})(t)},[M("div",{class:P(e.$style.bg)},null,2),M("span",{class:P(e.$style.inner)},D(t.value)+D(t.unit),3)],14,Re)):$("",!0)],64)))),256))],2)],2)}}}),[["__cssModules",{$style:{"three-scene":"_three-scene_16vpt_2",container:"_container_16vpt_11",operation:"_operation_16vpt_15",loading:"_loading_16vpt_22",progress:"_progress_16vpt_36","bar-out":"_bar-out_16vpt_40",bar:"_bar_16vpt_40","striped-flow":"_striped-flow_16vpt_1",text:"_text_16vpt_56",dialog:"_dialog_16vpt_72","dot-wrap":"_dot-wrap_16vpt_77",dot:"_dot_16vpt_77",bg:"_bg_16vpt_93",inner:"_inner_16vpt_101"}}]]);export{Fe as _};
