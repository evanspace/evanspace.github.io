import{e,aT as t,aU as o,f as n,m as a,af as s,_ as i,q as r,s as l,u as c,C as d,aV as u,o as p,x as m,aW as y,aX as h,aY as f,aZ as g,a_ as v,a$ as w,b0 as b,b1 as k,b2 as x,b3 as C,b4 as _,b5 as E,b6 as M,b7 as T,b8 as z,b9 as P,w as S,j as B,ba as L,bb as $,g as D,h as A,n as j,y as N,ab as O,t as I,D as R,a7 as F,F as U,r as H,bc as J,bd as W,be as X,aJ as G,K,bf as Y,bg as Q,aO as q,bh as V,bi as Z,bj as ee,bk as te,bl as oe,bm as ne,bn as ae,ac as se,bo as ie,bp as re,bq as le,br as ce,bs as de,bt as ue,bu as pe,bv as me,bw as ye,bx as he,by as fe,bz as ge,bA as ve,bB as we,bC as be,bD as ke,bE as xe,bF as Ce,bG as _e,a9 as Ee,aa as Me,N as Te,bH as ze,bI as Pe,bJ as Se,bK as Be}from"./vendor-4dfda034.js";import{u as Le,d as $e,a as De,b as Ae,c as je,_ as Ne,e as Oe,D as Ie,i as Re,s as Fe,f as Ue,r as He,g as Je,h as We,j as Xe,k as Ge}from"./common-f5f782ee.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const Ke=e({__name:"App",setup(e){const y=Le(),h={zhCN:{...t,...$e},en:{...o,...De}},f=n((()=>y.language)),g=(e,t="href")=>{const o=e.dataset[t];return e.removeAttribute("data-"+t),""+o};(()=>{const e=document.querySelector('link[rel="icon"]');e.href=g(e);const t=document.querySelector('link[rel="manifest"]');t.href=g(t)})(),a((()=>{v(),window.addEventListener("resize",v,!1)})),s((()=>{window.removeEventListener("resize",v)}));const v=()=>{y.sidebar.opened&&document.body.clientWidth,b()},w=i({width:1920,size:14}),b=()=>{let e=(document.getElementById("app").clientWidth||w.width)*(w.size/w.width);document.documentElement.style.fontSize=e+"px"};return(e,t)=>{const o=d("router-view"),n=u;return p(),r(n,{locale:h[c(f)],namespace:"el"},{default:l((()=>[m(o)])),_:1},8,["locale"])}}}),Ye={colors:{normal:{color:16777215,main:16316664,text:5280767},runing:{color:1211922,main:10485239},error:{color:12717056,main:16616554}},isCruise:!1,modelSizeKB:1048576,loadPart:{},devices:[]},Qe={shakeTime:500,tsp:Date.now()},qe={list:[]},Ve=i({percentage:0,show:!1,isEnd:!1,list:[],total:0,loaded:0}),Ze=i({show:!1,style:{left:"0px",top:"0px"},select:[],title:"",data:{},pos:{}}),et=(e,t=.1,o=1e4)=>{const n=e.clientWidth,a=e.clientHeight,s=new h(36,n/a,t,o);return s.position.set(-350,510,700),s},tt=(e,t,o="",n)=>{let a=(new v).load([`${t}${o}/${n}/posX.jpeg`,`${t}${o}/${n}/negX.jpeg`,`${t}${o}/${n}/posY.jpeg`,`${t}${o}/${n}/negY.jpeg`,`${t}${o}/${n}/posZ.jpeg`,`${t}${o}/${n}/negZ.jpeg`]);e.background=a},ot=(e,t,o)=>(e.lookAt(o),new Promise((n=>{new w(e.position).to(t,1e3).easing(b.Quadratic.In).start().onUpdate((()=>{e.lookAt(o)})).onComplete((()=>{n(e)}))}))),nt=(e,t,o=1)=>{const n=e.position,a=e.rotation,s=e.scale,i=t.position||{x:0,y:0,z:0},r=t.rotation||{x:0,y:0,z:0},l=t.scale||{x:1,y:1,z:1},c=Math.abs(r.x)<2?1:180,d=Math.abs(r.y)<2?1:180,u=Math.abs(r.z)<2?1:180;return{position:[n.x+i.x,n.y+i.y,n.z+i.z],rotation:[a.x+Math.PI/c*r.x,a.y+Math.PI/d*r.y,a.z+Math.PI/u*r.z],scale:[s.x*o*l.x,s.y*o*l.y,s.z*o*l.z]}},at=e=>e.map((e=>(e.children&&e.children.length>0?e.children=at(e.children):e.material&&(e.material instanceof Array?e.material=e.material.map((e=>e.clone())):e.material=e.material.clone()),e))),st=e=>{let t=e.clone();return t.children=at(t.children),t},it=(e,t=16777215)=>{const o=e.type;let n=5,a=t,s={x:0,y:0,z:0},i={x:0,y:0,z:0},r=0;switch(o){case"TEXT":break;case"JSQ":n=8,s.y=10,s.z=20,r=62;break;case"SB":case"LDB":case"LQB":n=8,s.z=55,r=45;break;case"XBC":case"LXJ":case"LGJ":case"STLGJ":case"TTLGJ":case"FTLGJ":n=8,s.y=16,s.z=40,r=78;break;case"LQT":n=8,s.x=-75,r=112;break;case"GL":n=8,s.x=83,s.y=2,r=125;break;case"BSHRQ":n=12,s.y=8,s.z=33,r=105;break;case"BSHLQ":n=8,s.y=16,s.z=40,r=88;break;case"FLRB":n=8,s.x=50,s.y=2,r=123;break;case"FJY_X":case"FJZ_X":n=6,r=80,s.y=80,s.z=30;break;case"FJY":case"FJZ":n=6,r=110,s.y=103}let l=e.font||{},c=l.position||{};c&&Object.keys(c).forEach((e=>{s[e]=c[e]}));let d=l.rotation||{};return d&&(Object.keys(d).forEach((e=>{i[e]=d[e]})),i.x=Math.PI/180*i.x,i.y=Math.PI/180*i.y,i.z=Math.PI/180*i.z),l.size&&(n=l.size),l.color&&(a=l.color),{size:n,color:a,txPos:s,txRot:i,sy:r}},rt=(e,t)=>{e.data&&e.data.type?t(e):e.isScene?t(null):rt(e.parent,t)},lt=(e,t,o)=>{let n=e.clientWidth/2,a=e.clientHeight/2,s=t.position.clone();const i=t.scale;s.y+=i.x/2;let r=s.project(o);return{left:r.x*n+n,top:-r.y*a+a}},ct=e=>{e&&e.traverse&&(e.traverse((e=>{e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose(),null==e||e.clear()})),null==e||e.clear())},dt=e=>new Promise((t=>{const o=window.indexedDB.deleteDatabase(e);o.onsuccess=e=>{t(!0)},o.onerror=e=>{t(!1)}})),ut=async(e,t="THREE__MODEL_DB",o=1)=>{if(!window.indexedDB)return Promise.resolve(null);await((e,t,o)=>new Promise((n=>{window.indexedDB.open(e).onsuccess=a=>{const s=a.target.result,i=s.version;s.close(),i!==t?dt(e).then((e=>{n(e?t:i)})):s.objectStoreNames.contains(o)?n(i):dt(e).then((e=>{n(e?t:i)}))}})))(t,o,e);let n=window.indexedDB.open(t,o);return new Promise((t=>{n.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains(e)||o.createObjectStore(e,{keyPath:"path"})},n.onsuccess=e=>{const o=e.target.result;t(o)},n.onerror=e=>{t(null)}}))},pt={dbName:"THREE__MODEL__CTL_DB",tbName:"CTL_TB",version:1},mt=["onClick"],yt=Ne(e({name:"three-scene",__name:"index",props:{id:{},bgColor:{type:[String,Boolean],default:void 0},skyCode:{default:"217"},skyCodes:{default:()=>["216","217","218","219","220","221","222","223","224","225"]},skyPath:{default:"/img/sky"},hdr:{},grid:{type:Boolean},baseUrl:{},models:{},config:{},objects:{},lightHelper:{type:Boolean},axesHelper:{type:Boolean},scale:{default:1},mainBodyChangeColor:{type:Boolean},mainBodyMeshName:{default:()=>["主体"]},initModelItemCall:{},getColorCall:{},animationModelType:{},pipeMeshName:{},pipeModelType:{},colorMeshName:{},colorModelType:{default:()=>["FM","XFM"]},textModelType:{},dotTypes:{default:()=>[]},floorModelType:{},cruisePoints:{},cruiseSegment:{},cruiseSpeed:{},cruiseTubeShow:{type:Boolean},pathBg:{},pathWidth:{},pathMap:{},pathTension:{},pathMapSpeed:{},cruisePathOffset:{}},emits:["loaded","select","dblclick","click-dot","click-dialog-dot"],setup(e,{expose:t,emit:o}){const d=e,u=Le(),m=Ae();S((()=>d.objects),(e=>{Ve.isEnd&&oo()})),S((()=>u.sidebar.opened),(()=>{clearTimeout(Ye.sideToggleTimer),Ye.sideToggleTimer=setTimeout(Fe,300)})),S((()=>m.dataMark),(()=>h()));const h=()=>{const e=Date.now();e-Qe.tsp<Qe.shakeTime&&clearTimeout(Qe.timer),Qe.tsp=e,Qe.timer=setTimeout(yo,Qe.shakeTime)},v=B(),Ee=new L;let Me,Te,ze,Pe,Se,Be,$e;Ee.background=new $("#fff");const De=Symbol("_WARNING_MODEL_"),Ne=Symbol("_CHANGECOLORMATERIALKEY_"),Oe=Symbol("_PIPETEXTUREKEY_"),Ie=Symbol("_MAINBODYMESHKEY_"),Re=()=>{if(Se=new Y(16777215,1.5),Ee.add(Se),Be=((e=16777215,t=1,o=800,n=2048,a=1,s=2e3)=>{const i=new k(e,t);return i.position.set(500,800,800),i.castShadow=!0,i.shadow.camera.near=a,i.shadow.camera.far=s,i.shadow.camera.right=o,i.shadow.camera.left=-o,i.shadow.camera.top=o,i.shadow.camera.bottom=-o,i.shadow.mapSize.set(n,n),i})(16777215,1.5),Ee.add(Be),$e=new k(16777215,1.5),$e.position.set(-500,800,-800),Ee.add($e),d.lightHelper){const e=new Q(Be,1);Ee.add(e);const t=new Q($e,1);Ee.add(t)}},Fe=()=>{const e=v.value;if(!Me)return;const t=(null==e?void 0:e.clientWidth)??0,o=(null==e?void 0:e.clientHeight)??0,n=t/o;Me.aspect=n,Me.updateProjectionMatrix(),kt&&(kt.aspect=n,kt.updateProjectionMatrix()),Te.setSize(t,o)};let Ue;const He=()=>{Ue=requestAnimationFrame(He),Xe(),Dt(),Te.render(Ee,Ye.isCruise?kt:Me)},Je=n((()=>(io.value.filter((e=>"DOT"==e.type))||[]).map((e=>{const t=e.deviceCode||"";e.value=m.getKeyValue(t).value;const o=t.split("_")[0]||"";return m.getRunStatus(o)>0||["SYS","CSC"].includes(o)?e.show=!0:e.show=!1,e.value=Number(Number(e.value||0).toFixed(2)),e})))),We=(e,t)=>{if(0==e.length||0==t.length)return[];let o=[];return e.forEach((e=>{if(e instanceof Array){let n=[];e.filter((e=>{if(e instanceof Array){const o=t.filter((t=>e.includes(t.deviceCode)));return o.length&&o.forEach((e=>{n.includes(e)||n.push(e)})),o.length>0}const o=t.find((t=>t.deviceCode==e));return o&&!n.includes(o)&&n.push(o),!!o})).length==e.length&&(o=o.concat(n))}else{const n=t.find((t=>t.deviceCode==e));n&&o.push(n)}})),o},Xe=()=>{J(),ze.update();let e=yt.getDelta();if(Ye.devices.length&&Ye.devices.forEach((t=>{let o=t.data,n=t.extra,a=t[De],s=t[Oe];if(n&&(null==o?void 0:o.status)>0&&n.mixer.update(e),a&&(null==o?void 0:o.error)>0&&a.mixer.update(e),s){const e=o.bind||[],t=io.value.filter((e=>"DOT"!==e.type&&!(d.pipeModelType||[]).includes(e.type)&&e.deviceCode&&((null==e?void 0:e.status)??0)>0)),n=We(e,t),a=n.length>0;let i=.01;if(o.left&&o.right){const{left:e,right:t}=o,a=We(t,n).length>0;i=We(e,n).length>0&&a?0:a?-.01:.01}a&&(s.material.map.offset.y-=i),s.material.opacity=a?.3:0}})),Ze.show&&Ze.select.length){const e=v.value,t=lt(e,Ze.select[0],Ye.isCruise?kt:Me);Ze.pos=t,Ze.style.left=t.left+"px",Ze.style.top=t.top+"px"}Ge()},Ge=()=>{const e=v.value;let t=e.clientWidth/2,o=e.clientHeight/2;io.value.forEach(((e,n)=>{if("DOT"!=e.type)return;let a=e.position,s=new W(null==a?void 0:a.x,null==a?void 0:a.y,null==a?void 0:a.z).project(Ye.isCruise?kt:Me),i=s.x*t+t,r=-s.y*o+o;io.value[n].style.left=i+"px",io.value[n].style.top=r+"px"}))};S((()=>d.bgColor),(e=>{Ee.background=new $(e)})),S((()=>d.skyCode),(e=>{d.bgColor||(tt(Ee,d.baseUrl,d.skyPath,e),Ke.value=e)}));const Ke=B(d.skyCode),at=()=>{const e=d.skyCodes||[];let t=e.findIndex((e=>e==Ke.value))+1;t>=e.length&&(t=0),Ke.value=e[t],tt(Ee,d.baseUrl,d.skyPath,Ke.value)},dt=o;let yt,ht,ft,gt;const vt=pt.tbName;S((()=>d.cruisePoints),(async()=>{await se(),wt(),bt(),Bt()}));const wt=()=>{xt&&(ct(xt),Ee.remove(xt),xt=void 0)},bt=()=>{Ye.isCruise=!1,ze.enabled=!Ye.isCruise,Tt=Ye.isCruise};let kt,xt,Ct,_t,Et,Mt,Tt=!1,zt=0,Pt=1,St=0;const Bt=()=>{const e=Date.now();if(e-St<300)return;St=e,zt=0;let t=[];const o=d.cruisePoints||[];if(0!=o.length){for(let e=0;e<o.length;e++){const n=o[e];t.push(new W(n[0],n[1],n[2]))}if(kt=et(v.value,1,1e6),kt.lookAt(ze.target),Et=new ie(t,!0,"catmullrom",d.pathTension??0),xt=new re,Ee.add(xt),d.cruiseTubeShow){Ct=new _(new le(2),new ce({color:0,opacity:.8,transparent:!0})),xt.add(Ct),_t=(new de).setFromPoints(t);const e=new ue({color:255,opacity:1,transparent:!0}),o=new pe(_t,e);xt.add(o);const n=new me(Et,100,2,3,!0),a=new ye({color:16711935,opacity:.1,transparent:!0}),s=new _(n,a),i=new ce({color:16715760,opacity:.3,wireframe:!0,transparent:!0}),r=new _(n,i);s.add(r),xt.add(s)}Lt()}else Et=void 0},Lt=async()=>{const e=d.pathBg||d.baseUrl+"/model/pipe/arrow.png",t=d.pathMap||[.1,1],o=await(new he).loadAsync(e);if(!xt)return;o.wrapS=fe,o.repeat.x=t[0],o.repeat.y=t[1],o.anisotropy=Te.capabilities.getMaxAnisotropy(),Mt=o;const n=new C({map:o,opacity:.5,transparent:!0,depthWrite:!1}),a=new W(0,1,0),s=new ve;s.set(Et.getPoints(1e3),5,1,a,!1);const i=new ge;i.update(s,{width:d.pathWidth??15,arrow:!1});const r=new _(i,n);r.name="path",xt.add(r)},$t=()=>1e3*(d.cruiseSegment??2),Dt=()=>{if(!Et)return;Mt&&(Mt.offset.x-=d.pathMapSpeed??.006),Tt&&(zt+=Pt*(d.cruiseSpeed??1));const e=$t(),t=zt%e/e,o=Et.getPointAt(t),n=d.cruisePathOffset??3;if(d.cruiseTubeShow&&Ct){const e=At(n,o);Ct.position.copy(e)}if(!Ye.isCruise)return;const a=.03;let s=t-a;t<a&&(s=t+.97);const i=At(n,Et.getPointAt(s));kt.position.copy(i),kt.lookAt(At(n,o))},At=(e,t)=>new W(t.x,t.y+e,t.z),jt=i({click:!1,tsp:0}),Nt=e=>{Ht(e,ht),ft.setFromCamera(ht,Ye.isCruise?kt:Me);const t=Ye.devices;let o=ft.intersectObjects(t,!0);if(o.length){const e=o[0].object;rt(e,(t=>{if(!t)return;dt("dblclick",t);const o=t.data,n=qe.list.findIndex((e=>t.uuid===e.uuid));"function"==typeof o.onDblclick&&o.onDblclick(q(o),e,t,n),n>-1&&Ot(n)}))}},Ot=e=>{var t,o,n,a;if(0===qe.list.length)return;const s=void 0!==e&&e>-1;if((null==(t=d.config)?void 0:t.floorExpandHiddenOther)&&Ye.devices.forEach((e=>{var t;e.visible=(t=e,qe.list.findIndex((e=>t.uuid===e.uuid))>-1||!s)})),qe.list.forEach(((t,o)=>{var n,a,i;const r=t._pos;let l=o-(s?e:o);const c=(null==(n=d.config)?void 0:n.floorExpandMargin)||200,u=(null==(a=d.config)?void 0:a.floorExpandMode)||"UD",p=l*c,m=((null==r?void 0:r.y)??0)+p,y=e==o?((null==r?void 0:r.z)??0)+c:(null==r?void 0:r.z)??0;if("UD"===u){if(t.position.y===m)return}else if("BA"===u&&t.position.z===y)return;if(null==(i=t.data)?void 0:i.mark){const n=t.data.mark,a=Ye.devices.filter((e=>{var t;return(null==(t=e.data)?void 0:t.followMark)===n}));It(u,a,p,e==o?c:0)}new w(t.position).to({y:"UD"===u?m:t.position.y,z:"BA"===u?y:t.position.z},500).easing(b.Quadratic.Out).start()})),!(null==(o=d.config)?void 0:o.floorExpandChangeViewAngle))return;let i,r;if(s){const t=qe.list[e]||{};i=null==(n=t.data)?void 0:n.to,i&&(r=(null==(a=t.data)?void 0:a.target)||t._pos)}i=no(i,r),(e=>{const t=Me.position;return Math.abs(t.x-e.x)<1&&Math.abs(t.y-e.y)<1&&Math.abs(t.z-e.z)<1})(i)||ot(Me,i,ze.target)},It=(e,t,o,n)=>{0!==t.length&&t.forEach((t=>{const a=t._pos,s="UD"==e?((null==a?void 0:a.y)??0)+o:(null==a?void 0:a.y)??0,i="BA"==e?((null==a?void 0:a.z)??0)+n:(null==a?void 0:a.z)??0;new w(t.position).to({y:s,z:i},500).easing(b.Quadratic.Out).start()}))},Rt=e=>{jt.click=!0,jt.tsp=e.timeStamp},Ft=e=>{Jt(e),jt.click},Ut=e=>{var t,o;jt.click=!1;const n=e.timeStamp-jt.tsp<300;2==e.button?n&&"function"==typeof(null==(t=d.config)?void 0:t.back)&&(null==(o=d.config)||o.back(screen)):0==e.button?n&&Jt(e):e.button},Ht=(e,t)=>{if(!e||!t)return;const o=v.value;let n=(null==o?void 0:o.getBoundingClientRect())??{left:0,top:0};t.x=(e.clientX-n.left)/(1*o.clientWidth)*2-1,t.y=-(e.clientY-n.top)/(1*o.clientHeight)*2+1},Jt=e=>{const t=v.value;Ht(e,ht),ft.setFromCamera(ht,Ye.isCruise?kt:Me);let o="pointerdown"==e.type||"pointerup"==e.type;const n=Ee.children.filter((e=>e.visible&&!!e.data&&d.dotTypes.includes(e.data.type)));let a=ft.intersectObjects(n,o);if(t.style.cursor=a.length>0?"pointer":"auto",o)if(a.length){const e=a[0].object;rt(e,(e=>{if(!e)return;const t=e.data;if(!t.type)return void(Ze.show=!1);const o=q(t);dt("select",o),"function"==typeof t.onClick?t.onClick(o):(Ze.select=[e],Ze.show=!0,Wt())}))}else Ze.select.length=0,Ze.show=!1},Wt=()=>{const e=v.value,t=Ze.select[0],o=t.data;Ze.data=o,Ze.title=(null==o?void 0:o.name)||"";const n=lt(e,t,Ye.isCruise?kt:Me);Ze.pos=n,Ze.style.left=n.left+"px",Ze.style.top=n.top+"px",dt("click-dialog-dot",o,n)};let Xt;const Gt=()=>{const e=d.models,t=e.length;let o=0;if(0==t)return Ve.isEnd=!0,void(Ve.show=!1);Ve.isEnd=!1,Ve.percentage=0;const n=async()=>{const a=e[o],{key:s,name:i,map:r,url:l,size:c,range:u,font:p,warning:m}=a;if(Ve.list.push({name:`${i} Model`,pro:0}),r){let e=(new he).load(d.baseUrl+r),t=new we({map:e}),o=new be(t),n=c,a=c;u&&(n=u.x,a=u.y),o.scale.set(n,a,1),o.name="sprite",Ye.loadPart[s]=o}else p?await Yt(p,c):m?Xt=await Qt(s||De,m,c):await Qt(s,l,c,a);o++,Ve.loaded+=c*Ye.modelSizeKB,o==t?(Ve.isEnd=!0,oo()):n()};Ve.show=!0,n()};let Kt;const Yt=(e,t=0)=>{const o=new ke;return!je(e)&&e.indexOf(d.baseUrl)<0&&(e=d.baseUrl+e),new Promise((async n=>{const a=await qt(e,t);if(a)return Kt=o.parse(JSON.parse(a)),void setTimeout((()=>{n(Kt)}),10);o.load(e,(t=>{Kt=t,Zt(e),n(t)}))}))},Qt=(e,t,o=0,n)=>{const a=new xe;a.setDecoderPath("draco/gltf/");const s=new Ce;return s.setDRACOLoader(a),new Promise((async a=>{const i=Ye.colors.normal[e]||Ye.colors.normal.color;!je(t)&&t.indexOf(d.baseUrl)<0&&(t=d.baseUrl+t);const r=await qt(t,o);if(r){const t=r.scene.children[0],o=Vt(e,i,t,r.animations,n);return void a(o)}let l=t.split(".").pop().toLowerCase();if("glb"!==l)throw new Error("模型类型错误,必须为 GLB 格式，当前格式："+l);s.load(t,(o=>{let s=o.scene.children[0];const r=Vt(e,i,s,o.animations,n);Zt(t),a(r)}),to)}))},qt=(e,t=0)=>{const o=new Ce;return new Promise((async n=>{const a=ae.get(e);if(a)a instanceof ArrayBuffer?(to({loaded:a.byteLength}),o.parse(a,"",(t=>{ae.add(e,t),n(t)}))):(to({loaded:t*Ye.modelSizeKB}),setTimeout((()=>{n(a)}),10));else{const t=await((e,t,o)=>{if(!e||!t||!o)return Promise.resolve(null);const n=e.transaction([t],"readonly").objectStore(t).get(o);return new Promise(((e,t)=>{n.onsuccess=t=>{const o=t.target.result;e(o)},n.onerror=e=>{t(e)}}))})(gt,vt,e);if(t&&t.data){const e=t.data;"string"==typeof e?(to({loaded:e.length}),ae.add(t.path,e),setTimeout((()=>{n(e)}),10)):(to({loaded:e.byteLength}),o.parse(e,"",(e=>{ae.add(t.path,e),n(e)})))}else n(null)}}))},Vt=(e,t,o,n,a)=>{var s;if(!o)return;let i;if((null==(s=d.pipeModelType)?void 0:s.includes(e))&&a){const{pipeMap:e,repeat:t=[1,1]}=a;i=(new he).load(d.baseUrl+e),i.wrapS=fe,i.wrapT=fe,i.repeat.set(t[0]??1,t[1]??1)}const r=st(o);return r.traverse((e=>{var o;i&&(null==(o=d.pipeMeshName)?void 0:o.includes(e.name))?e.material=new ye({side:_e,transparent:!0,opacity:0,map:i.clone()}):((e,t=6776165,o,n)=>{const{type:a,name:s}=e;if(a.indexOf("Light"),["地面","底座","基础","基础底座","冷却塔基础"].includes(s))e.receiveShadow=!0;else if(o.includes(s)){if(!e.material)return;e.material instanceof Array?e.material.forEach((e=>{e.color.set(t)})):e.material.color.set(t)}else e.isMesh&&(n&&(e.material.envMap=n),e.castShadow=!0)})(e,t,d.colorMeshName||[])})),r.animations=n,Ye.loadPart[e]=r,r},Zt=e=>{const t=ae.get(e);if(t&&gt){gt.transaction(vt,"readwrite").objectStore(vt).add({path:e,data:t})}},eo=async(e,t)=>{const o="_BASE_";if(!e){const e=Ye.loadPart[o];if(e){const t=Ee.children.find((t=>t.uuid===e.uuid));Ee.remove(t),ct(e),Ye.loadPart[o]=null}return}const n=await Qt(o,e),{position:a,scale:s,rotation:i}=nt(n,t);return n.scale.set(...s),n.position.set(...a),n.rotation.set(...i),Ee.add(n),Promise.resolve(n)},to=e=>{const{loaded:t}=e,o=Ve.total;let n=Number((t+Ve.loaded)/o*100);n>100&&(n=100),Ve.percentage=Number(n.toFixed(2))},oo=async()=>{var e,t,o;Ve.percentage=100,Ve.show=!1,Ze.show=!1,Ye.devices.forEach((e=>{const t=Ee.children.find((t=>{var o,n;return(null==(o=t.data)?void 0:o.id)==(null==(n=e.data)?void 0:n.id)}));ct(e),ct(t),Ee.remove(t)})),Ye.devices.length=0,qe.list.length=0,await se(),eo(),ro(),await so(),"function"==typeof(null==(e=d.config)?void 0:e.load)&&(null==(t=d.config)||t.load(Ee));const n=(null==(o=d.config)?void 0:o.floorExpandIndex)||-1;if(n>-1&&qe.list.length)Ot(n),dt("loaded");else{const e=no();ot(Me,e,ze.target).then((()=>{dt("loaded")}))}},no=(e,t)=>{const o=d.config||{},n=e||o.to||{x:-104,y:7,z:58},a=t||o.target||{x:0,y:0,z:0};return ze.target.set(a.x,a.y,a.z),n},ao=async e=>{var t,o;if(!e)return;const n=e.type;let a=Ye.loadPart[n];if(!a)return void(e.url&&await eo(e.url,e));const s=d.colorMeshName||[],i=d.animationModelType||[],r=d.floorModelType||[],l=d.textModelType||[];let c=st(a);const{position:u,scale:p,rotation:m}=nt(c,e),[y,h,f]=u;if(c.scale.set(...p),l.includes(n)&&Kt){const t=new E;t.add(c);let o=((e,t,o)=>{if(!t)return;const n=it(e,o);let a=new x(e.name||"",{font:t,size:n.size||5,height:0,curveSegments:12,bevelThickness:1,bevelSize:.1,bevelEnabled:!0});const s=n.txRot;a.rotateX(s.x),a.rotateY(s.y),a.rotateZ(s.z);const i=n.txPos;a.computeBoundingBox(),a.computeVertexNormals();let r=.5*(a.boundingBox.max.x-a.boundingBox.min.x),l=.5*(a.boundingBox.max.z-a.boundingBox.min.z),c=new C({color:n.color||16777215,flatShading:!1}),d=new _(a,c);return d.castShadow=!0,d.position.set((i.x||0)-r,i.y||0,(i.z||0)-l),d})(e,Kt,Ye.colors.normal.text);t.add(o),t.name=e.name,c=t}if(i.includes(n)&&Xt){if("Group"!==c.type){const e=new E;e.add(c),c=e}const{group:t,action:o,mixer:n}=((e,t,o,n=100,a=1)=>{if(!o)return;const s=it(t);let i=new E,r=st(o);r.scale.set(a,a,a),r.position.y=s.sy,i.add(r);let l=new M(12717056,8,n,0);l.name="灯光",l.position.y=s.sy+30,i.add(l),i.name=e;let c=new T(i),d=new z("红色.material.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),u=new z("灯光.color",[0,.25,.75],[1,0,0,1,1,0,1,0,0]),p=new z("警告标识.scale",[0,.5,1],[1,1,1,1.2,1.2,2,1,1,1]),m=new P("warning_",1,[d,u,p]),y=c.clipAction(m);return y.paused=!0,y.play(),i.visible=!1,{group:i,action:y,mixer:c}})(De,e,Xt);c.add(t),c[De]={action:o,mixer:n}}c.position.set(y,h,f),c.rotation.set(...m),c.data=e;const g=c.children.filter((e=>s.includes(e.name)));if(c[Ne]=g,null==(t=d.pipeModelType)?void 0:t.includes(n)){const t=c.children.find((e=>{var t;return null==(t=d.pipeMeshName)?void 0:t.includes(e.name)}));if(t){t.material.map=t.material.map.clone();const o=e.map;if(o){const e=t.material.map.repeat;t.material.map.repeat.set(e.x*(o[0]??1),e.y*(o[1]??1))}c[Oe]=t}}if(d.mainBodyChangeColor){const e=((null==(o=c.children[0])?void 0:o.children)||[]).filter((e=>(d.mainBodyMeshName||[]).includes(e.name)));c[Ie]=e}if(Ee.add(c),(e.followMark||e.mark)&&(c._pos={x:y,y:h,z:f}),Ye.devices.push(c),r.includes(n)&&(c._pos={x:y,y:h,z:f},qe.list.push(c)),i.includes(n)){const e=((e,t)=>{let o=[];return e&&e.length?(function e(n){n.forEach((n=>{t.includes(n.name)&&o.push(n),n.children&&e(n.children)}))}(e),o):[]})(c.children,s);let t,o=new T(c);a.animations.length&&(t=o.clipAction(a.animations[0]),t.paused=!0,t.timeScale=1.5,t.play()),c.extra={action:t,mixer:o,meshs:e}}return Promise.resolve()},so=()=>{let e=0,t=io.value.length;return new Promise((o=>{if(0==t)return;const n=async()=>{const a=io.value[e];await ao(a),e++,e<t?n():o(e)};n()}))},io=B([]),ro=()=>{io.value.length=0;const e=q(d.objects)||[],t=m.formatData(e,d.initModelItemCall);io.value=t},lo=()=>{},co=e=>{Pt=1;const t=e.keyCode;if(Ye.isCruise)switch(t){case 32:Tt=!Tt;break;case 38:case 87:Tt||(zt+=10);break;case 83:case 40:Tt||(zt-=10,zt<0&&(zt=$t()))}},uo=e=>{const t=e.keyCode;if(Ye.isCruise&&e.repeat)switch(t){case 38:case 87:Tt?(Pt*=1.5,Pt>10&&(Pt=10)):zt+=5;break;case 83:case 40:Tt||(zt-=5,zt<0&&(zt=$t()))}};window.addEventListener("keydown",uo,!1),window.addEventListener("keyup",co,!1);const po=()=>{(d.cruisePoints||[]).length&&(Ye.isCruise=!Ye.isCruise,ze.enabled=!Ye.isCruise,Tt=Ye.isCruise)},mo=()=>{Ye.devices.forEach(((e,t)=>{if(!e.data)return;const{type:o}=e.data,n=e.data;if(!n.deviceCode)return;const a=Math.random()>.5?1:0,s=Math.random()>.5?1:0;n.status=a,n.error=s;const i=s>0?"error":a>0?"runing":"normal",r=Ye.colors[i];let l=r[o]||r.color;if("function"==typeof d.getColorCall){const e=d.getColorCall(n);e&&(l=e)}ho(o,e,r,l,0==a,s>0)}))},yo=()=>{const e=d.animationModelType||[],t=d.colorModelType||[],o=d.pipeModelType||[],n=e.concat(t);Ye.devices.forEach(((e,t)=>{let a=e.data;if(!a)return;let s=a.type;if(!n.includes(s)||o.includes(s)||"DOT"==s)return;const i=a.deviceCode;if(!i)return;const r=m.getRunStatus(i),l=m.getErrorStatus(i);a.status=r,a.error=l;const c=l>0?"error":r>0?"runing":"normal",u=Ye.colors[c];let p=u[s]||u.color;if("function"==typeof d.getColorCall){const e=d.getColorCall(a);e&&(p=e)}ho(s,e,u,p,0==r,l>0)}))},ho=(e,t,o,n,a,s)=>{if(d.colorModelType.includes(e)){return void(t[Ne]||[]).forEach((e=>{e.material.color.set(n)}))}const i=t.extra;if(i&&"DOT"!=e){i.action&&(i.action.paused=a);(i.meshs||[]).forEach((e=>{"Group"==e.type?e.children.forEach((e=>{e.material.color.set(n)})):e.material.color.set(n)}))}const r=t[De];if(r){const e=t.children.find((e=>e.name==De));e&&(e.visible=s,r.action.paused=!s)}if(d.mainBodyChangeColor&&t[Ie]){const e=o.main;e&&t[Ie].forEach((t=>{t.material.color.set(e)}))}},fo=()=>{d.models.forEach((e=>{const t=e.size*Ye.modelSizeKB;Ve.total+=t}));const e=v.value;if(Te=(e=>{const t=e.clientWidth,o=e.clientHeight,n=new y({antialias:!0,alpha:!0});return n.outputEncoding=void 0,n.setSize(t,o),n.setPixelRatio(window.devicePixelRatio),e.appendChild(n.domElement),n})(e),Me=et(e,1,1e6),Re(),ze=((e,t)=>{const o=new f(e,t.domElement);return o.minDistance=1,o.maxPolarAngle=.45*Math.PI,o.target.set(0,0,0),o})(Me,Te),ze.maxPolarAngle=.46*Math.PI,ze.screenSpacePanning=!1,d.grid&&(Pe=(()=>{let e=new g(800,80,10592673,10592673);return e.material.opacity=.3,e.material.transparent=!0,e})(),Ee.add(Pe)),d.axesHelper){let e=new X(50);Ee.add(e)}Ye.isCruise=!1,Pt=1,d.hdr?(new V).load(d.baseUrl+d.hdr,(e=>{e.mapping=Z,Ee.background=e,Ee.environment=e})):null!=d.bgColor?Ee.background=d.bgColor?new $(d.bgColor):null:tt(Ee,d.baseUrl,d.skyPath,d.skyCode),Te.shadowMap.enabled=!0,Te.shadowMap.type=ee,yt=new te,ht=new oe,ft=new ne,ut(vt,pt.dbName,pt.version).then((e=>{e?(ae.enabled=!0,gt=e,Gt()):Gt()})),Te.domElement.addEventListener("dblclick",Nt),Te.domElement.addEventListener("pointerdown",Rt),Te.domElement.addEventListener("pointermove",Ft),Te.domElement.addEventListener("pointerup",Ut)};return a((()=>{if(!d.models||0==d.models.length)throw new Error("模型数据不可为空");fo(),He(),window.addEventListener("resize",Fe,!1)})),s((()=>{clearTimeout(Qe.timer),m.wsClose(),clearInterval(Ye.timer),clearTimeout(Ye.sideToggleTimer),window.removeEventListener("resize",Fe),window.removeEventListener("keyup",co),window.removeEventListener("keydown",uo),cancelAnimationFrame(Ue);try{Ee.clear(),Te.dispose(),Te.forceContextLoss(),Te.content=null;let e=Te.domElement.getContext("webgl");e&&e.getExtension("WEBGL_lose_context").loseContext()}catch(e){}})),t({floorAnimate:Ot,setControls:e=>{"object"==typeof e&&Object.keys(e).forEach((t=>{ze[t]=e[t]}))},resize:Fe}),(e,t)=>{const o=G;return p(),D("div",{class:j(e.$style["three-scene"])},[A("div",{class:j([e.$style.operation,"operation"]),onDblclick:t[0]||(t[0]=N((()=>{}),["stop"]))},[(p(),r(o,{key:0,onClick:mo,type:"success"},{default:l((()=>[K("随机更新")])),_:1})),(p(),r(o,{key:1,onClick:po,type:"warning"},{default:l((()=>[K("巡航")])),_:1})),(p(),r(o,{key:2,onClick:lo,type:"success"},{default:l((()=>[K("场景坐标")])),_:1})),(p(),r(o,{key:3,onClick:at,type:"warning"},{default:l((()=>[K("切换背景")])),_:1}))],34),A("div",{ref_key:"containerRef",ref:v,class:j(e.$style.container),onKeyup:co},null,34),c(Ve).show?(p(),D("div",{key:0,class:j(e.$style.loading),style:O({"--bg-color":e.bgColor?String(e.bgColor):""}),onDblclick:t[1]||(t[1]=N((()=>{}),["stop"]))},[A("div",{class:j(e.$style.progress),style:O({"--percentage":c(Ve).percentage+"%"})},[A("div",{class:j(e.$style["bar-out"])},[A("div",{class:j(e.$style.bar)},null,2)],2),A("div",{class:j(e.$style.text)},I(c(Ve).percentage)+"%",3)],6)],38)):R("",!0),c(Ze).show?(p(),D("div",{key:1,class:j(e.$style.dialog),style:O(c(Ze).style)},[F(e.$slots,"dialog",{data:c(Ze).data,title:c(Ze).title,pos:c(Ze).pos})],6)):R("",!0),A("div",{class:j(e.$style["dot-wrap"])},[(p(!0),D(U,null,H(c(Je),((t,o)=>(p(),D(U,null,[t.show?(p(),D("div",{class:j(e.$style.dot),key:o,style:O(t.style),onClick:e=>(e=>{dt("click-dot",q(e))})(t)},[A("div",{class:j(e.$style.bg)},null,2),A("span",{class:j(e.$style.inner)},I(t.value)+I(t.unit),3)],14,mt)):R("",!0)],64)))),256))],2)],2)}}}),[["__cssModules",{$style:{"three-scene":"_three-scene_16vpt_2",container:"_container_16vpt_11",operation:"_operation_16vpt_15",loading:"_loading_16vpt_22",progress:"_progress_16vpt_36","bar-out":"_bar-out_16vpt_40",bar:"_bar_16vpt_40","striped-flow":"_striped-flow_16vpt_1",text:"_text_16vpt_56",dialog:"_dialog_16vpt_72","dot-wrap":"_dot-wrap_16vpt_77",dot:"_dot_16vpt_77",bg:"_bg_16vpt_93",inner:"_inner_16vpt_101"}}]]),ht={class:"plane-device__content"},ft=["onClick","onMousedown"],gt={class:"device-item__wrap"},vt=["src"],wt={class:"device-item--mark"},bt={class:"device-item--text"},kt={key:2,class:"device-item--name"},xt=e({name:"plane-device",__name:"index",props:{list:{},active:{},type:{},locked:{type:Boolean},display:{type:Boolean},showName:{type:Boolean},hideType:{}},emits:["click","mousedown","mouseup"],setup(e,{emit:t}){const o=Oe(),n=e,a=e=>{var t;return!n.display||!(null==(t=n.hideType)?void 0:t.includes(e.type))},s=t,i=e=>{const{error:t=0,status:n=0}=e;let a=t>0?"error":n>0?"run":"normal",s=e.type;return[Ie.LDB,Ie.LQB].includes(s)?s="LDB":[Ie.LXJ,Ie.BSHLQ].includes(s)?s="LXJ":[Ie.LDFM,Ie.LQFM].includes(s)&&(s="FM"),`${o.oss}/img/device/${a}/${s}.png`},r=(e="")=>"℃"==e?"T":"kPa"==e?"AP":"m³/h"==e?"F":"";return(e,t)=>(p(),D("div",{class:j(["plane-device",{"is-locked":e.locked}])},[A("div",ht,[(p(!0),D(U,null,H(e.list,((o,n)=>Ee((p(),D("div",{key:n,class:j(["device-item",{[o.type]:!0,"is-active":e.active==n}]),style:O({left:`${o.style.x}px`,top:`${o.style.y}px`,color:o.color,marginTop:`${o.my}px`,marginLeft:`${o.mx}px`,zIndex:o.zIndex}),onClick:t=>s("click",n,o,e.type),onMousedown:N((t=>s("mousedown",t,n,o,e.type)),["stop"]),onMouseup:t[0]||(t[0]=e=>s("mouseup",e))},[A("div",gt,[o.type!=c(Ie).DOT?(p(),D("img",{key:0,src:i(o),style:O({transform:`rotate(${o.rotate}deg)`})},null,12,vt)):(p(),D(U,{key:1},[A("div",wt,I(r(o.unit)),1),A("div",bt,I(o.value??0)+I(o.unit),1)],64)),e.showName?(p(),D("div",kt,I(o.name)+I(o.deviceCode?`(${o.deviceCode})`:""),1)):R("",!0)])],46,ft)),[[Me,a(o)]]))),128))])],2))}}),Ct=[yt,xt];Te.configure({showSpinner:!1});const{t:_t}=Re.global;Fe.interceptors.request.use((e=>{let t=Ue().token;return t&&(e.headers.Authorization=t),e}),(e=>Promise.reject(e))),Fe.interceptors.response.use((e=>{var t;return 20010090===(null==(t=e.data)?void 0:t.code)&&Ue().resetToken().then((()=>{window.location.reload()})),e}),(e=>Promise.reject(e))),He.beforeEach((async(e,t,o)=>{Te.start();const n=document,a=e.meta.title;Le().i18n?n.title=a?_t(`route.${a}`).toUpperCase():"loading...":n.title=a;const s=Ue(),i=s.token,r=`${Je}/login`;if(i)if(e.path==r)o({path:`${Je}/`}),Te.done();else{if(e.path==`${Je}/index`)return o({path:`${Je}/`}),void Te.done();if(s.powers&&s.powers.length>0)o();else try{const{permissions:t}=await s.getUserInfo(),n=We();(await n.generateRoutes(t)).forEach((e=>{He.hasRoute(e.name)||He.addRoute(e)})),o({...e,replace:!0})}catch(l){await s.resetToken(),o(`${r}?redirect=${e.path}`),Te.done()}}else e.path==r?o():(o(`${r}?redirect=${e.path}`),Te.done())})),He.afterEach((()=>{Te.done()}));const Et=(e,t,o)=>{let n={};return"string"==typeof e||e instanceof Array?n=e:(null!=t&&(n.msg=t),null!=o&&(n.code=o),"object"==typeof e&&Object.keys(e).forEach((t=>{n[t]=e[t]}))),n},Mt=Et,Tt=[{url:"/user/login",method:"post",response:()=>Mt({token_type:"bearer",access_token:ze.mock("@guid")})},{url:"/user/logout",method:"get",response:()=>Mt({},"退出登录")},{url:"/user/changePwd",method:"post",response:()=>Mt({},"密码修改成功")},{url:"/user/getUserInfo",method:"get",response:()=>Mt({sysUser:{id:ze.mock("@id"),name:ze.mock("@cname"),account:ze.mock("@first"),avatar:ze.Random.image("50x50",ze.mock("@hex"),"E")},permissions:["ALL_SN"]})}];ze.Random.extend({phone:function(){return this.pick(["132","135","188","158","178"])+ze.mock(/\d{8}/)},family:function(){return this.pick(["汉族","满族","彝族","藏族","傣族"])}});const zt=Et,Pt=[...Tt,...[{url:"/test/list",method:"get",response:()=>zt(ze.mock({"Total|20-100":100,"Data|10":[{Name:"@cname",Phone:"@phone",Email:"@email",Family:"@family",Id:"@id","Age|10-40":100,"Income|3000-40000":100,Birthday:"@datetime(yyyy-MM-dd)",Region:"@region",Province:"@province",City:"@city",County:"@county",Remark:"@csentence",hasChildren:"@boolean","childrens|2":[{Name:"@cname",Phone:"@phone",Email:"@email",Family:"@family",Id:"@id","Age|10-40":100,"Income|3000-40000":100,Birthday:"@datetime(yyyy-MM-dd)",Region:"@region",Province:"@province",City:"@city",County:"@county",Remark:"@csentence"}]}]}))},{url:"/test/add",method:"post",response:()=>zt({},"添加成功")},{url:"/test/update",method:"put",response:()=>zt({},"更新成功")},{url:"/test/get",method:"get",response:()=>zt(ze.mock({name:"@cname",phone:"@phone",email:"@email",family:"@family",id:"@id","age|10-40":100,"income|3000-40000":100,birthday:"@datetime(yyyy-MM-dd)",region:"@region",province:"@province",city:"@city",county:"@county",remark:"@csentence"}))},{url:"/test/del",method:"delete",response:()=>zt({},"删除成功")},{url:"/test/items",method:"get",response:()=>zt(ze.mock({"Data|3-10":[{"label|1-5":"★","value|+1":1,"disabled|1-3":!0}]}))},{url:"/test/group",method:"get",response:()=>zt(ze.mock({"Data|1-3":[{"label|1":["Vue","Vite","Typescript","Pinia"],"value|+1":1,"disabled|1-3":!0,"children|3-8":[{"label|1-5":"★","value|+1":1,"disabled|1-3":!0}]}]}))}],...[...[{url:"/monitor/get_config",method:"get",response:e=>{const{id:t}=e.query||{};if("123456"==t)return Et({id:1,name:"制冷站监测系统"})}}]]].map((e=>(e.url="/mock"+e.url,e)));const St=Se(Ke);St.directive("focus",{mounted(e){e.focus()}}),St.use(Be()).use(He).use(Re).use(Xe).use((function(e){Ct.forEach((t=>{e.component(t.name,t)}))})).use(Ge).mount("#app"),Pe([...Pt]);export{yt as _,xt as a};
